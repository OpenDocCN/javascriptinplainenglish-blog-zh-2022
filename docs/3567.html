<html>
<head>
<title>Avoid Losing All Data in mergeMap RXJS Operator When Some Multiple Inner Observables Fail</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">当多个内部观察失败时，避免在mergeMap RXJS运算符中丢失所有数据</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/angular-avoid-losing-all-data-in-mergemap-rxjs-operator-when-few-of-the-multiple-inner-observables-448251b6e8e1?source=collection_archive---------4-----------------------#2022-09-08">https://javascript.plainenglish.io/angular-avoid-losing-all-data-in-mergemap-rxjs-operator-when-few-of-the-multiple-inner-observables-448251b6e8e1?source=collection_archive---------4-----------------------#2022-09-08</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><div class=""><h2 id="0026" class="pw-subtitle-paragraph jk im in bd b jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb dk translated">Angular RXJS操作符:<strong class="ak"> mergeMap </strong>和<strong class="ak"> forkJoin </strong>在你想并行执行任务的时候非常有用。</h2></div><p id="fbb4" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">RXJS操作符:<strong class="ke io"> mergeMap </strong>和<strong class="ke io"> forkJoin </strong>在你想并行执行任务时非常有用，也就是说，这里最重要的是得到输出，任务的执行顺序在这里并不重要。</p><p id="1a17" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">考虑这个场景:</p><ol class=""><li id="21c4" class="ky kz in ke b kf kg ki kj kl la kp lb kt lc kx ld le lf lg bi translated">我使用<strong class="ke io"> mergeMap </strong>操作符并行获取5个用户的数据:A、B、C、D和E。获取每个用户数据的API调用将对应于一个内部可观察订阅。</li><li id="5af4" class="ky kz in ke b kf lh ki li kl lj kp lk kt ll kx ld le lf lg bi translated">假设，3个用户<strong class="ke io"> B，C，D </strong>不存在。因此，对应于这3个用户的API调用将失败，并出现HTTP 404。这意味着3个可观测量将会出错，并且对应于其他2个用户<strong class="ke io"> A和E </strong>的API调用可能有成功的机会，如果它们仍在进行中，也将被取消。</li><li id="8d80" class="ky kz in ke b kf lh ki li kl lj kp lk kt ll kx ld le lf lg bi translated">我不想因为3个用户<strong class="ke io"> B，C，D </strong>的API调用失败，就丢失剩下的2个用户:<strong class="ke io"> A，D </strong>的数据。</li><li id="0efc" class="ky kz in ke b kf lh ki li kl lj kp lk kt ll kx ld le lf lg bi translated">我还想显示与3个用户<strong class="ke io"> B、C和D </strong>相关的错误。</li></ol><p id="fdd5" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">下面是我想实现的东西的截图。这是一个小角度的应用。我试图获取5个用户的数据，其中3个不存在。但是我没有丢失另外两个用户的数据。</p><figure class="ln lo lp lq gt lr gh gi paragraph-image"><div role="button" tabindex="0" class="ls lt di lu bf lv"><div class="gh gi lm"><img src="../Images/2c62b97be2a64e5e874c921ba69dc0bf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*llbNUNYAlpHjvuL6zSbgQA.png"/></div></div></figure><p id="c0aa" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">我们显示了与3个用户相对应的错误消息，还显示了用户的ID和名称，我们可以获取他们的数据。</p><p id="e6fe" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">组件模板:这正是我们在截图中看到的。</p><figure class="ln lo lp lq gt lr"><div class="bz fp l di"><div class="ly lz l"/></div></figure><p id="3d94" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">按钮<strong class="ke io">获取用户数据</strong>将调用<strong class="ke io"> task1()，</strong>，我们试图获取5个用户的数据。</p><p id="d268" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">我们已经订阅了2个observable<strong class="ke io">error observable $</strong>和<strong class="ke io"> task1$ </strong>来分别显示错误和用户数据。</p><p id="4c59" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><strong class="ke io">组件类别:</strong></p><figure class="ln lo lp lq gt lr"><div class="bz fp l di"><div class="ly lz l"/></div></figure><pre class="ln lo lp lq gt ma mb mc md aw me bi"><span id="9177" class="mf mg in mb b gy mh mi l mj mk">public list = [50, 1, 60, 9, 30];</span></pre><p id="a721" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">列表数组包含一个用户id数组，我们要获取其数据。不存在的用户具有id<strong class="ke io">50、60和30 </strong>。</p><p id="3271" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">移动到<strong class="ke io">任务1(): </strong></p><ol class=""><li id="fea3" class="ky kz in ke b kf kg ki kj kl la kp lb kt lc kx ld le lf lg bi translated">我们已经使用来自操作符的<strong class="ke io">将数组<strong class="ke io">列表</strong>转换为冷可观察值。</strong></li><li id="2d88" class="ky kz in ke b kf lh ki li kl lj kp lk kt ll kx ld le lf lg bi translated"><strong class="ke io"> mergeMap </strong>操作符将把cold可观察对象发出的userId映射到<strong class="ke io">数据服务</strong>中的<strong class="ke io"> getUser() </strong>返回的内部可观察对象中。</li></ol><p id="0f54" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><strong class="ke io"> getUser() </strong>调用API获取userId对应的数据。</p><pre class="ln lo lp lq gt ma mb mc md aw me bi"><span id="8d62" class="mf mg in mb b gy mh mi l mj mk"><strong class="mb io">getUser(id: number): Observable&lt;any&gt; {</strong><br/>return this.http<br/>.get(`https://jsonplaceholder.typicode.com/users/${id}`)<br/>.pipe(<strong class="mb io">catchError((err) =&gt; throwError(err))</strong>);<br/>}</span></pre><p id="e2b6" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">3.如果API调用成功，在<strong class="ke io">映射操作符</strong>中，我们将用户数据推入一个本地变量<strong class="ke io"> userData。</strong>这是我们在模板中订阅<strong class="ke io"> task1$ observable </strong>时可用的数据。</p><pre class="ln lo lp lq gt ma mb mc md aw me bi"><span id="2015" class="mf mg in mb b gy mh mi l mj mk">map((result) =&gt; {<br/><strong class="mb io">userData.push(result);<br/>return userData;</strong><br/>}),</span></pre><p id="580f" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">4.如果API调用失败，在<strong class="ke io"> catchError操作符</strong>中，我们首先将Error对象推入一个局部变量<strong class="ke io"> errorList </strong>，然后将<strong class="ke io"> errorList </strong>传递给<strong class="ke io"> error$ subject。</strong>我们订阅了模板中的这个主题来显示错误。</p><pre class="ln lo lp lq gt ma mb mc md aw me bi"><span id="3873" class="mf mg in mb b gy mh mi l mj mk">catchError((err) =&gt; {<br/><strong class="mb io">errorList.push(err);<br/>this.error$.next(errorList);<br/>return EMPTY;</strong><br/>})</span></pre><p id="a203" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">完整的工作示例如下:</p><div class="ml mm gp gr mn mo"><a href="https://stackblitz.com/edit/angular-tazfza?file=src/app/merge-map/merge-map.component.ts" rel="noopener  ugc nofollow" target="_blank"><div class="mp ab fo"><div class="mq ab mr cl cj ms"><h2 class="bd io gy z fp mt fr fs mu fu fw im bi translated">角形(叉形)堆叠</h2><div class="mv l"><h3 class="bd b gy z fp mt fr fs mu fu fw dk translated">一个基于rxjs，tslib，core-js，zone.js，@angular/core，@angular/forms，@angular/common的angular-cli项目…</h3></div><div class="mw l"><p class="bd b dl z fp mt fr fs mu fu fw dk translated">stackblitz.com</p></div></div><div class="mx l"><div class="my l mz na nb mx nc lw mo"/></div></div></a></div><p id="d35d" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">如果您认为在<strong class="ke io"> task1() </strong>中使用局部变量<strong class="ke io"> userData </strong>和<strong class="ke io"> errorList </strong>是不必要的，并且可以有更好的方法将用户数据或错误数据连接到一个数组中，那么请看下面的例子。这里我们使用了<strong class="ke io"> RXJS扫描操作符</strong>来实现将用户/错误对象连接成一个数组。</p><div class="ml mm gp gr mn mo"><a href="https://stackblitz.com/edit/angular-fbhhfa?file=src/app/merge-map/merge-map.component.ts" rel="noopener  ugc nofollow" target="_blank"><div class="mp ab fo"><div class="mq ab mr cl cj ms"><h2 class="bd io gy z fp mt fr fs mu fu fw im bi translated">角形(叉形)堆叠</h2><div class="mv l"><h3 class="bd b gy z fp mt fr fs mu fu fw dk translated">一个基于rxjs，tslib，core-js，zone.js，@angular/core，@angular/forms，@angular/common的angular-cli项目…</h3></div><div class="mw l"><p class="bd b dl z fp mt fr fs mu fu fw dk translated">stackblitz.com</p></div></div><div class="mx l"><div class="nd l mz na nb mx nc lw mo"/></div></div></a></div></div><div class="ab cl ne nf hr ng" role="separator"><span class="nh bw bk ni nj nk"/><span class="nh bw bk ni nj nk"/><span class="nh bw bk ni nj"/></div><div class="ig ih ii ij ik"><p id="51bc" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><em class="nl">更多内容看</em> <a class="ae nm" href="https://plainenglish.io/" rel="noopener ugc nofollow" target="_blank"> <strong class="ke io"> <em class="nl">说白了就是</em> </strong> </a> <em class="nl">。报名参加我们的</em> <a class="ae nm" href="http://newsletter.plainenglish.io/" rel="noopener ugc nofollow" target="_blank"> <strong class="ke io"> <em class="nl">免费每周简讯</em> </strong> </a> <em class="nl">。关注我们关于</em> <a class="ae nm" href="https://twitter.com/inPlainEngHQ" rel="noopener ugc nofollow" target="_blank"> <strong class="ke io"> <em class="nl">推特</em> </strong> </a>，<a class="ae nm" href="https://www.linkedin.com/company/inplainenglish/" rel="noopener ugc nofollow" target="_blank"><strong class="ke io"><em class="nl">LinkedIn</em></strong></a><em class="nl">，</em><a class="ae nm" href="https://www.youtube.com/channel/UCtipWUghju290NWcn8jhyAw" rel="noopener ugc nofollow" target="_blank"><strong class="ke io"><em class="nl">YouTube</em></strong></a><em class="nl"/><a class="ae nm" href="https://discord.gg/GtDtUAvyhW" rel="noopener ugc nofollow" target="_blank"><strong class="ke io"><em class="nl">不和</em> </strong> </a> <em class="nl">。对增长黑客感兴趣？检查出</em> <a class="ae nm" href="https://circuit.ooo/" rel="noopener ugc nofollow" target="_blank"> <strong class="ke io"> <em class="nl">电路</em> </strong> </a> <em class="nl">。</em></p></div></div>    
</body>
</html>