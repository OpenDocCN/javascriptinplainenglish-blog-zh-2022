<html>
<head>
<title>Track Page View of Next.js with Google Analytics &amp; Google Tag Manager</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用谷歌分析和谷歌标签管理器跟踪Next.js的页面视图</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/track-page-view-of-next-js-with-google-analytic-and-google-tag-manager-a8e1e9d04651?source=collection_archive---------2-----------------------#2022-05-29">https://javascript.plainenglish.io/track-page-view-of-next-js-with-google-analytic-and-google-tag-manager-a8e1e9d04651?source=collection_archive---------2-----------------------#2022-05-29</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="c88c" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">关于如何设置Next.js，Google Analytics &amp; Google Tag Manager的教程。</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi kf"><img src="../Images/d5c4d9e9b38378961781de6da5c3976b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1108/format:webp/1*yHK3_o--Bin250Cz74dRlg.png"/></div><figcaption class="kn ko gj gh gi kp kq bd b be z dk">The combination of GA and GTM simplifies Next.js page view tracking</figcaption></figure><p id="595f" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">为了提高网站速度和逻辑，谷歌分析(GA)已经使用了很长时间。然而，由于单页面应用程序(SPA)在初始加载时只发送一个请求，GA无法正确跟踪页面浏览量。为了正确跟踪所有的页面视图，我们需要一个额外的设置，这很耗时…</p><p id="8cb4" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">但是，有了Next.js、GA、Google Tag Manager (GTM)，只有我们需要做正常的设置。所以这篇文章解释了如何设置Next.js和GA以及GTM。</p><h1 id="9cca" class="ln lo iq bd lp lq lr ls lt lu lv lw lx jw ly jx lz jz ma ka mb kc mc kd md me bi translated">谷歌分析和谷歌标签管理器</h1><p id="daff" class="pw-post-body-paragraph kr ks iq kt b ku mf jr kw kx mg ju kz la mh lc ld le mi lg lh li mj lk ll lm ij bi translated">首先，让我们澄清GA和GTM。</p><ul class=""><li id="0433" class="mk ml iq kt b ku kv kx ky la mm le mn li mo lm mp mq mr ms bi translated">GA是一个创建页面活动报告的分析工具。例如，GA跟踪页面浏览量，以及用户在页面上停留的时间。为了跟踪数据，我们需要在网站上嵌入标签。它向GA发送请求并创建报告。意思是定制GA就是定制tag而已。</li><li id="4b94" class="mk ml iq kt b ku mt kx mu la mv le mw li mx lm mp mq mr ms bi translated">GTM是一个标签管理器。我们唯一要做的就是定义标签在GTM控制台上触发的规则。有了GTM，我们不需要改变实际代码来嵌入标签。</li></ul><p id="a3ee" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">有些人可能意识到为什么需要GTM来正确跟踪页面。因为SPA页面转换是通过浏览器上的历史更改完成的，而无需向服务器发送请求，所以我们可以定义一个规则，让标签在历史更改时触发！</p><h1 id="362c" class="ln lo iq bd lp lq lr ls lt lu lv lw lx jw ly jx lz jz ma ka mb kc mc kd md me bi translated">设置</h1><p id="d32e" class="pw-post-body-paragraph kr ks iq kt b ku mf jr kw kx mg ju kz la mh lc ld le mi lg lh li mj lk ll lm ij bi translated">到目前为止，我们已经理解了跟踪页面浏览量的逻辑。我们来实施吧。</p><ol class=""><li id="b61c" class="mk ml iq kt b ku kv kx ky la mm le mn li mo lm my mq mr ms bi translated">创建GA帐户</li><li id="acbf" class="mk ml iq kt b ku mt kx mu la mv le mw li mx lm my mq mr ms bi translated">创建GTM帐户和规则</li><li id="aac3" class="mk ml iq kt b ku mt kx mu la mv le mw li mx lm my mq mr ms bi translated">用代码片段安装GTM</li></ol><h2 id="fa18" class="mz lo iq bd lp na nb dn lt nc nd dp lx la ne nf lz le ng nh mb li ni nj md nk bi translated">创建GA帐户</h2><p id="b36f" class="pw-post-body-paragraph kr ks iq kt b ku mf jr kw kx mg ju kz la mh lc ld le mi lg lh li mj lk ll lm ij bi translated">要建立GTM，我们需要GA <code class="fe nl nm nn no b">MEASUREMENT ID</code>。所以要先设置GA。要设置GA，<a class="ae np" href="https://support.google.com/analytics/answer/9304153?hl=en&amp;ref_topic=9303319#zippy=%2Cweb" rel="noopener ugc nofollow" target="_blank"> Google官方文档</a>是最好的选择。所以请跟着做，弄个<code class="fe nl nm nn no b">MEASUREMENT ID</code>。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="nr ns di nt bf nu"><div class="gh gi nq"><img src="../Images/3c0bbf9516c1b148dc491846dd290143.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7Ny0CcFpFvByYMwPbo1xYw.png"/></div></div><figcaption class="kn ko gj gh gi kp kq bd b be z dk">GA measurement id</figcaption></figure><p id="1414" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated"><code class="fe nl nm nn no b">https://ham-media-app.net</code>是我这边的项目域。请用您的域名替换它。</p><h2 id="ddfd" class="mz lo iq bd lp na nb dn lt nc nd dp lx la ne nf lz le ng nh mb li ni nj md nk bi translated">创建GTM帐户和规则</h2><p id="5b0a" class="pw-post-body-paragraph kr ks iq kt b ku mf jr kw kx mg ju kz la mh lc ld le mi lg lh li mj lk ll lm ij bi translated">请到<a class="ae np" href="https://tagmanager.google.com/#/home" rel="noopener ugc nofollow" target="_blank"> GTM控制台</a>创建一个GTM账户，如下所示:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi nv"><img src="../Images/274b42540750c43cd03816db7e92dc25.png" data-original-src="https://miro.medium.com/v2/resize:fit:1370/format:webp/1*EQKJwjWI8h8cK7i79ecLJw.png"/></div><figcaption class="kn ko gj gh gi kp kq bd b be z dk">GTM account setup</figcaption></figure><p id="6bf0" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated"><code class="fe nl nm nn no b">Account Name</code>可能是任何事情。对于<code class="fe nl nm nn no b">Container name</code>，我们应该指定主机地址。好了，我们现在已经在GTM中创建了一个帐户。🎉</p><p id="b87b" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">从这里开始，让我们创建一个规则，在发生页面转换时跟踪页面视图。转到<code class="fe nl nm nn no b">Tags</code>并按下<code class="fe nl nm nn no b">New</code>。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="nr ns di nt bf nu"><div class="gh gi nw"><img src="../Images/4180e3323fa415ed01bcc64d66a8751b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1246/format:webp/1*W9c9AeOled1zvtAWEbtz4A.png"/></div></div></figure><p id="85c8" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">为了跟踪页面浏览量，我们需要一个GA。所以，<code class="fe nl nm nn no b">Tag Configuration</code>应该在下面。对于<code class="fe nl nm nn no b">Measurement ID</code>，请填写您在GA设置中获得的<code class="fe nl nm nn no b">MEASUREMENT ID</code>。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi nx"><img src="../Images/74b8d6e9d76ee8d47064e7bc38e4ffba.png" data-original-src="https://miro.medium.com/v2/resize:fit:1252/format:webp/1*h2_Io1oJHVuIYiX_RD5_wg.png"/></div></figure><p id="f879" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">而<code class="fe nl nm nn no b">Triggering</code>就是<code class="fe nl nm nn no b">All Pages</code>。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi ny"><img src="../Images/e0eacc112a7eb88128345c8b8c0f363f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1224/format:webp/1*5ZwLJt8iKR9H4yMXyGd9QQ.png"/></div></figure><p id="38c3" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">我们可以在GTM中创建第一个规则！别忘了按下GTM控制台右上方的<code class="fe nl nm nn no b">Submit</code>来发布。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi nz"><img src="../Images/5787914c8497542280e5b3ab3086e898.png" data-original-src="https://miro.medium.com/v2/resize:fit:660/format:webp/1*nOwTtzjqCVKAACsgZkvzfQ.png"/></div></figure><h2 id="5634" class="mz lo iq bd lp na nb dn lt nc nd dp lx la ne nf lz le ng nh mb li ni nj md nk bi translated">用代码片段安装GTM</h2><p id="627b" class="pw-post-body-paragraph kr ks iq kt b ku mf jr kw kx mg ju kz la mh lc ld le mi lg lh li mj lk ll lm ij bi translated">正如<a class="ae np" href="https://support.google.com/tagmanager/answer/6103696?hl=en" rel="noopener ugc nofollow" target="_blank"> GTM的官方文档</a>所说，我们应该放置2种类型的代码片段。</p><ol class=""><li id="26f6" class="mk ml iq kt b ku kv kx ky la mm le mn li mo lm my mq mr ms bi translated"><code class="fe nl nm nn no b">&lt;script&gt;</code>标签在<code class="fe nl nm nn no b">&lt;head&gt;</code></li><li id="2fb5" class="mk ml iq kt b ku mt kx mu la mv le mw li mx lm my mq mr ms bi translated"><code class="fe nl nm nn no b">&lt;noscript&gt;</code>标签在<code class="fe nl nm nn no b">&lt;body&gt;</code>上面</li></ol><p id="3463" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">代码片段可以在GTM控制台中找到。请打开<code class="fe nl nm nn no b">Admin</code>标签和<code class="fe nl nm nn no b">install Google Tag Manager</code>。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="nr ns di nt bf nu"><div class="gh gi oa"><img src="../Images/8ed792ad1162f2ae16bdf94657901158.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PXyUbEA1T9Z2uCvr4vBIug.png"/></div></div></figure><p id="dcb8" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">因为<code class="fe nl nm nn no b">&lt;script&gt;</code> snippet有一个GTM的初始化脚本，所以必须在浏览器中执行。此外，它必须包含在所有网页上。因此<code class="fe nl nm nn no b">&lt;script&gt;</code>片段应该放在<code class="fe nl nm nn no b">_app.tsx</code>中，如下所示:</p><pre class="kg kh ki kj gt ob no oc od aw oe bi"><span id="bb80" class="mz lo iq no b gy of og l oh oi">// pages/_app.tsx<br/>import GoogleTagManger from "../components/GoogleTagManager";<br/>import { GOOGLE_TAG_MANAGER_ID } from "../libs/googleTagManager";</span><span id="eb0f" class="mz lo iq no b gy oj og l oh oi">const App: FC = ({ Component, pageProps }) =&gt; <br/>  &lt;&gt;<br/>    &lt;GoogleTagManger /&gt;<br/>    &lt;Component {...pageProps} /&gt;<br/>  &lt;/&gt;</span><span id="a1d4" class="mz lo iq no b gy oj og l oh oi">// components/GoogleTagManager.tsx<br/>import Script from 'next/script';</span><span id="bc83" class="mz lo iq no b gy oj og l oh oi">type Props = {<br/>  containerId?: string;<br/>};</span><span id="45cd" class="mz lo iq no b gy oj og l oh oi">const GoogleTagManager: FC&lt;Props&gt; = ({ containerId }) =&gt;<br/>  containerId ? (<br/>   &lt;Script<br/>    id="googleTagManager"<br/>    strategy="afterInteractive"<br/>    dangerouslySetInnerHTML={{<br/>      __html: `<br/>      (function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':<br/>      new Date().getTime(),event:'gtm.js'});var<br/>      f=d.getElementsByTagName(s)[0],<br/>      j=d.createElement(s),dl=l!='dataLayer'?'&amp;l='+l:'';j.async=true;j.src=<br/>      'https://www.googletagmanager.com/gtm.js<br/>      id='+i+dl;f.parentNode.insertBefore(j,f);<br/>      })(window,document,'script','dataLayer', '${containerId}');<br/>      `,<br/>    }}<br/>  /&gt;) : null;</span><span id="5c50" class="mz lo iq no b gy oj og l oh oi">export { GoogleTagManager };</span><span id="6c99" class="mz lo iq no b gy oj og l oh oi">// libs/googleTagManager.ts<br/>export const GOOGLE_TAG_MANAGER_ID = process.env["NEXT_PUBLIC_GOOGLE_TAG_MANAGER_ID"];</span></pre><p id="5c04" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">第二个代码段必须紧接在所有页面的<code class="fe nl nm nn no b">&lt;Body&gt;</code>标签之后。所以我们可以像下面这样使用Next.js的<a class="ae np" href="https://nextjs.org/docs/advanced-features/custom-document" rel="noopener ugc nofollow" target="_blank">自定义文档</a>功能:</p><pre class="kg kh ki kj gt ob no oc od aw oe bi"><span id="dd0c" class="mz lo iq no b gy of og l oh oi">// pages/_document.tsx<br/>import { Html, Head, Main, NextScript } from 'next/document';<br/>import { GOOGLE_TAG_MANAGER_ID } from "../libs/googleTagManager";</span><span id="31fd" class="mz lo iq no b gy oj og l oh oi">const Document = () =&gt; (<br/>  &lt;Html&gt;<br/>    &lt;Head /&gt;<br/>    &lt;body&gt;<br/>      &lt;noscript&gt;<br/>        &lt;iframe<br/>          src={`https://www.googletagmanager.com/ns.html?id=${GOOGLE_TAG_MANAGER_ID}`}<br/>          height="0"<br/>          width="0"<br/>          title="googleTagManagerNoScript"<br/>          style={{<br/>            display: 'none',<br/>            visibility: 'hidden',<br/>          }}<br/>        /&gt;<br/>      &lt;/noscript&gt;<br/>      &lt;Main /&gt;<br/>      &lt;NextScript /&gt;<br/>    &lt;/body&gt;<br/>  &lt;/Html&gt;<br/>);</span><span id="dbc9" class="mz lo iq no b gy oj og l oh oi">export default Document;</span></pre><p id="8386" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">如果设置正确，让我们检查一下！实际上，我的网站既有静态生成页面(面向最终用户)，也有客户端渲染页面(面向内部管理)。并且两种类型页面的浏览量都被成功跟踪如下:🎉</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="nr ns di nt bf nu"><div class="gh gi ok"><img src="../Images/2acc0eea07cb29c39585bcbefebd5dab.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*43r0EnwPeZ54Y6gPV46Gog.png"/></div></div></figure></div><div class="ab cl ol om hu on" role="separator"><span class="oo bw bk op oq or"/><span class="oo bw bk op oq or"/><span class="oo bw bk op oq"/></div><div class="ij ik il im in"><p id="15a9" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">本文解释了如何使用GA和GTM跟踪Next.js应用程序的页面视图。因为GTM可以设置历史变化触发器，所以无需任何定制就可以跟踪页面视图！</p><h1 id="d164" class="ln lo iq bd lp lq lr ls lt lu lv lw lx jw ly jx lz jz ma ka mb kc mc kd md me bi translated">参考</h1><ul class=""><li id="463c" class="mk ml iq kt b ku mf kx mg la os le ot li ou lm mp mq mr ms bi translated"><a class="ae np" href="https://nextjs.org/" rel="noopener ugc nofollow" target="_blank"> Next.js </a></li><li id="fe5e" class="mk ml iq kt b ku mt kx mu la mv le mw li mx lm mp mq mr ms bi translated"><a class="ae np" href="https://marketingplatform.google.com/about/tag-manager/" rel="noopener ugc nofollow" target="_blank">谷歌标签管理器</a></li><li id="8b5d" class="mk ml iq kt b ku mt kx mu la mv le mw li mx lm mp mq mr ms bi translated"><a class="ae np" href="https://marketingplatform.google.com/about/analytics/" rel="noopener ugc nofollow" target="_blank">谷歌分析</a></li></ul><p id="afaf" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated"><em class="ov">更多内容请看</em><a class="ae np" href="https://plainenglish.io/" rel="noopener ugc nofollow" target="_blank"><strong class="kt ir"><em class="ov">plain English . io</em></strong></a><em class="ov">。报名参加我们的</em> <a class="ae np" href="http://newsletter.plainenglish.io/" rel="noopener ugc nofollow" target="_blank"> <strong class="kt ir"> <em class="ov">免费周报</em> </strong> </a> <em class="ov">。关注我们关于</em><a class="ae np" href="https://twitter.com/inPlainEngHQ" rel="noopener ugc nofollow" target="_blank"><strong class="kt ir"><em class="ov">Twitter</em></strong></a><em class="ov">和</em><a class="ae np" href="https://www.linkedin.com/company/inplainenglish/" rel="noopener ugc nofollow" target="_blank"><strong class="kt ir"><em class="ov">LinkedIn</em></strong></a><em class="ov">。查看我们的</em> <a class="ae np" href="https://discord.gg/GtDtUAvyhW" rel="noopener ugc nofollow" target="_blank"> <strong class="kt ir"> <em class="ov">社区不和谐</em> </strong> </a> <em class="ov">加入我们的</em> <a class="ae np" href="https://inplainenglish.pallet.com/talent/welcome" rel="noopener ugc nofollow" target="_blank"> <strong class="kt ir"> <em class="ov">人才集体</em> </strong> </a> <em class="ov">。</em></p></div></div>    
</body>
</html>