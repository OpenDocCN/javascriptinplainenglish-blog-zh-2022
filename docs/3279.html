<html>
<head>
<title>Let’s Understand Chrome V8: How Does V8 Implement a JavaScript Object?</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">我们来了解一下Chrome V8:V8是如何实现一个JavaScript对象的？</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/lets-understand-chrome-v8-how-does-v8-implement-a-javascript-object-ddde32120bb5?source=collection_archive---------7-----------------------#2022-08-15">https://javascript.plainenglish.io/lets-understand-chrome-v8-how-does-v8-implement-a-javascript-object-ddde32120bb5?source=collection_archive---------7-----------------------#2022-08-15</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><div class=""><h2 id="20d2" class="pw-subtitle-paragraph jk im in bd b jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb dk translated">《让我们了解Chrome V8: JavaScript对象内存布局和新方法》第17章。</h2></div><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi kc"><img src="../Images/2229cb027639f57877eb360bf75cd927.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yCFNVeb4ds9hl7WF-NP-kw.png"/></div></div></figure><p id="6566" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated"><em class="lk">欢迎阅读</em> <a class="ae ll" href="https://medium.com/@huidou" rel="noopener"> <em class="lk">其他章节让我们来了解一下Chrome V8 </em> </a></p><p id="ad7c" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">我们知道JavaScript对象是一组属性和元素。出于性能和内存的原因，V8设计了几种不同的属性表示，如in-object、slow property和self-dict。在本章中，让我们更深入地研究JavaScript对象。</p><h1 id="1c89" class="lm ln in bd lo lp lq lr ls lt lu lv lw jt lx ju ly jw lz jx ma jz mb ka mc md bi translated"><strong class="ak"> 1。JavaScript对象布局</strong></h1><p id="44d4" class="pw-post-body-paragraph ko kp in kq b kr me jo kt ku mf jr kw kx mg kz la lb mh ld le lf mi lh li lj ig bi translated">下图1显示了一个基本的JavaScript对象在内存中的样子。</p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi mj"><img src="../Images/dd98ebe6130cffadffd0c27a68774dbd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DGEf4YgrekWjEzGtp4YUyw.png"/></div></div></figure><p id="e041" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">元素和属性存储在两个独立的数据结构中，这使得对于不同的使用模式，添加和访问属性或元素更加有效。</p><p id="12c6" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">元素主要用于各种<em class="lk"> Array.prototype </em>方法，比如pop或者slice。考虑到这些函数在连续的范围内访问属性，V8也在内部将它们表示为简单的数组——大多数时候。</p><p id="12a9" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">命名属性以类似的方式存储在单独的数组中。然而，与元素不同，我们不能简单地使用键来推断它们在属性数组中的位置；我们需要一些额外的元数据。在V8中，每个JavaScript对象都有一个关联的HiddenClass。HiddenClass存储关于对象形状的信息，以及从属性名到属性索引的映射，更多细节在第14章中。</p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi mk"><img src="../Images/ea30ada92d7971fc6885d84b3184c60e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Sx5LUzUxYh4oT80qJ0VphQ.png"/></div></div></figure><p id="e516" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">在图2中，有元素、属性和对象内属性。与元素或属性不同，对象内属性存储在对象本身中，这意味着您可以直接访问它们而无需map。在创建JavaScript对象时分配对象内的数量。(不同V8版本中的数量可能不同)</p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi ml"><img src="../Images/557227bdcf1a3725fb48091a41229c03.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lLhMIYEnJPGUbQXJRHVcbQ.png"/></div></div></figure><p id="b567" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">在图3中，有三种不同的命名属性类型:对象内、快速和慢速/字典。</p><p id="4610" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated"><strong class="kq io"> (1) </strong>对象内属性直接存储在对象本身，并提供最快的访问。</p><p id="1c61" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated"><strong class="kq io"> (2) </strong>快速属性存在于属性存储中，所有元信息存储在HiddenClass上的描述符数组中。</p><p id="6bb7" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated"><strong class="kq io"> (3) </strong>慢速属性存在于一个自包含的属性字典中，元信息不再通过HiddenClass共享。</p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi mm"><img src="../Images/7c349678786bb9dad72212d674c65212.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*svgz7gsoIy5VumsW-L79gg.png"/></div></div></figure><p id="2ce4" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">图4显示了JavaScript对象内存布局。</p><p id="5005" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">所有V8托管堆对象必须有一个存储在第一个地址的映射指针。当然，也有元素和属性。描述符是地图的重要成员，负责描述一个物体的属性，这个我们以后会讲到。</p><p id="aaa1" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">在下面的例子中，sayname是一个等于console.log的函数。</p><p id="2153" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">我们来思考另一个问题:一个对象的函数存储在哪里？也就是说，sayname在哪里？</p><figure class="kd ke kf kg gt kh"><div class="bz fp l di"><div class="mn mo l"/></div></figure><p id="6c6b" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">第一部分是JavaScript代码，最后是相应的字节码。</p><p id="ae64" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">第19–21行使用person对象构造一个名为worker的实例。</p><p id="a71b" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">第23行加载名称为sayname的属性。</p><p id="6ec1" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">你明白第23行吗？它告诉我们，sayname只是一个属性，与它的类型无关。如果再深入一点，您会发现控制台和日志也是属性。</p><p id="5616" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">因此，在JavaScript对象中，所有函数都被视为属性。</p><h1 id="459f" class="lm ln in bd lo lp lq lr ls lt lu lv lw jt lx ju ly jw lz jx ma jz mb ka mc md bi translated"><strong class="ak"> 2。新的JavaScript对象</strong></h1><p id="3044" class="pw-post-body-paragraph ko kp in kq b kr me jo kt ku mf jr kw kx mg kz la lb mh ld le lf mi lh li lj ig bi translated">为了调试上述情况，我们将单步执行以下代码:</p><figure class="kd ke kf kg gt kh"><div class="bz fp l di"><div class="mn mo l"/></div></figure><p id="f370" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">RUNTIME _ FUNCTION(RUNTIME _ new object)是我们在上一章提到的一个宏。它调用JSObject::New()来创建一个新对象。JSObject::New()调用JSFunction::GetDerivedMap()来分配新的映射。</p><p id="3140" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">在JSFunction::GetDerivedMap()中，将调用以下函数。</p><figure class="kd ke kf kg gt kh"><div class="bz fp l di"><div class="mn mo l"/></div></figure><p id="ba28" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">第7行返回构造函数期望的属性数量。</p><p id="82e0" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">第26到30行生成原型，关键字function是一个构造函数。在我们的例子中，函数是person，原型为null，因为person是第一次执行，所以执行第29行。</p><p id="feeb" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">生成的原型被绑定到构造函数，并由所有实例共享，这就是V8实现的原型原则。</p><p id="436a" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">下面是第7行调用的CalculateExpectedNofProperties。</p><figure class="kd ke kf kg gt kh"><div class="bz fp l di"><div class="mn mo l"/></div></figure><p id="25ad" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">第28行，MaxInObject是对象内的最大数量，超出的属性存储在属性列表中。图5显示了调用栈。</p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi mp"><img src="../Images/c58de10ba4acd7afae641e8bfb41242a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ili-tgXcffbEsCW-Fg8unA.png"/></div></div></figure><h1 id="2ae6" class="lm ln in bd lo lp lq lr ls lt lu lv lw jt lx ju ly jw lz jx ma jz mb ka mc md bi translated"><strong class="ak">参考文献</strong></h1><p id="5ff2" class="pw-post-body-paragraph ko kp in kq b kr me jo kt ku mf jr kw kx mg kz la lb mh ld le lf mi lh li lj ig bi translated"><a class="ae ll" href="https://v8.dev/blog/fast-properties" rel="noopener ugc nofollow" target="_blank">V8中的快速属性</a></p><p id="492c" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated"><em class="lk">好了，这部分就到此为止了。下次再见，保重！</em></p><p id="82ae" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">我的博客是cncyclops.com。如果你有任何问题，请联系我。</p><p id="8ded" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated"><strong class="kq io">微信</strong> : qq9123013 <strong class="kq io">邮箱</strong>:v8blink@outlook.com</p></div><div class="ab cl mq mr hr ms" role="separator"><span class="mt bw bk mu mv mw"/><span class="mt bw bk mu mv mw"/><span class="mt bw bk mu mv"/></div><div class="ig ih ii ij ik"><p id="4c38" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated"><em class="lk">更多内容请看</em><a class="ae ll" href="https://plainenglish.io/" rel="noopener ugc nofollow" target="_blank"><strong class="kq io"><em class="lk">plain English . io</em></strong></a><em class="lk">。报名参加我们的</em> <a class="ae ll" href="http://newsletter.plainenglish.io/" rel="noopener ugc nofollow" target="_blank"> <strong class="kq io"> <em class="lk">免费周报</em> </strong> </a> <em class="lk">。关注我们关于</em><a class="ae ll" href="https://twitter.com/inPlainEngHQ" rel="noopener ugc nofollow" target="_blank"><strong class="kq io"><em class="lk">Twitter</em></strong></a><a class="ae ll" href="https://www.linkedin.com/company/inplainenglish/" rel="noopener ugc nofollow" target="_blank"><strong class="kq io"><em class="lk">LinkedIn</em></strong></a><em class="lk">，以及</em> <a class="ae ll" href="https://discord.gg/GtDtUAvyhW" rel="noopener ugc nofollow" target="_blank"> <strong class="kq io"> <em class="lk">不和</em> </strong> </a> <em class="lk">。</em></p></div></div>    
</body>
</html>