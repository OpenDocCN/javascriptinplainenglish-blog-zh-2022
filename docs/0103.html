<html>
<head>
<title>There is a BUG in JavaScript Since Day One — ‘typeof null’</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">JavaScript从第一天起就有一个BUG“空类型”</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/there-is-a-bug-in-javascript-since-day-one-typeof-null-9b18da349cc6?source=collection_archive---------8-----------------------#2022-01-07">https://javascript.plainenglish.io/there-is-a-bug-in-javascript-since-day-one-typeof-null-9b18da349cc6?source=collection_archive---------8-----------------------#2022-01-07</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><div class=""><h2 id="2f93" class="pw-subtitle-paragraph jk im in bd b jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb dk translated">而且好像总会有。</h2></div><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi kc"><img src="../Images/27bef0aa131527d896eb699f7843206d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jelZ1SKxCOVOCs9qOeV9qw.png"/></div></div></figure><p id="4744" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">众所周知，JavaScript中的所有值要么是原语，要么是对象。</p><p id="9dfa" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">有7种原始数据类型:</p><p id="986a" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">-字符串</p><p id="99fd" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">-号码</p><p id="e1c9" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">-bigint</p><p id="6dcb" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">-布尔值</p><p id="4dd1" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">-未定义</p><p id="2319" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">-符号</p><p id="827f" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">-空</p><p id="bdf6" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">让我们用typeof运算符检查它们的类型:</p><pre class="kd ke kf kg gt lk ll lm ln aw lo bi"><span id="099b" class="lp lq in ll b gy lr ls l lt lu">console.log(typeof "some text");   // string</span><span id="2839" class="lp lq in ll b gy lv ls l lt lu">console.log(typeof 1234);    // number</span><span id="89ce" class="lp lq in ll b gy lv ls l lt lu">console.log(typeof 9007199254740991n);  // bigint</span><span id="c717" class="lp lq in ll b gy lv ls l lt lu">console.log(typeof true);   // boolean</span><span id="00c4" class="lp lq in ll b gy lv ls l lt lu">console.log(typeof undefined);    // undefined</span><span id="085c" class="lp lq in ll b gy lv ls l lt lu">console.log(typeof Symbol('some text'));  // symbol</span><span id="06ca" class="lp lq in ll b gy lv ls l lt lu"><strong class="ll io">console.log(typeof null);    // object</strong></span></pre><p id="d708" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">等等！什么？</p><p id="7010" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">为什么<code class="fe lw lx ly ll b">typeof null</code>是一个物体？</p><p id="9936" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">这是一个无法解决的错误，因为它会导致当前代码中断。</p><p id="0900" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">让我们深潜。</p><h2 id="934a" class="lp lq in bd lz ma mb dn mc md me dp mf kx mg mh mi lb mj mk ml lf mm mn mo mp bi translated">对象和原语之间的区别是什么:</h2><p id="d52d" class="pw-post-body-paragraph ko kp in kq b kr mq jo kt ku mr jr kw kx ms kz la lb mt ld le lf mu lh li lj ig bi translated">原语是不可变的，您不能向它们添加属性:</p><pre class="kd ke kf kg gt lk ll lm ln aw lo bi"><span id="cb7f" class="lp lq in ll b gy lr ls l lt lu">let myString = "abc";</span><span id="cc63" class="lp lq in ll b gy lv ls l lt lu">// try to add property "figure" </span><span id="dcce" class="lp lq in ll b gy lv ls l lt lu">myString.figure = 4; </span><span id="18ec" class="lp lq in ll b gy lv ls l lt lu">console.log(myString.figure) // undefined </span></pre><p id="fcf4" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">并且原语通过值进行比较<em class="mv">，如果它们具有相同的内容，则它们被认为是相等的:</em></p><pre class="kd ke kf kg gt lk ll lm ln aw lo bi"><span id="36a4" class="lp lq in ll b gy lr ls l lt lu">console.log("abc" === "abc") // true</span></pre><p id="9533" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated"><strong class="kq io">物体。</strong>一切非本原的价值都是对象。对象是可变的:</p><pre class="kd ke kf kg gt lk ll lm ln aw lo bi"><span id="1334" class="lp lq in ll b gy lr ls l lt lu">let myObject = {};</span><span id="8274" class="lp lq in ll b gy lv ls l lt lu">// try to add property "figure"</span><span id="3ded" class="lp lq in ll b gy lv ls l lt lu">myObject.figure = 123;  <br/><br/>console.log(myObject.figure);  // 123<br/></span></pre><p id="1c2e" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">并且通过引用来比较对象<em class="mv">。每个对象都有自己的身份，只有当两个对象实际上是同一个对象时，它们才被认为是相等的:</em></p><pre class="kd ke kf kg gt lk ll lm ln aw lo bi"><span id="6ae1" class="lp lq in ll b gy lr ls l lt lu">console.log({} === {})    // false<br/><br/>let myObject = {};</span><span id="2860" class="lp lq in ll b gy lv ls l lt lu">console.log(myObject === myObject)    // true</span></pre><p id="fee4" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated"><strong class="kq io">包装对象类型。</strong>基本类型布尔、数字和字符串具有相应的包装对象类型布尔、数字和字符串。后者的实例是对象，不同于它们所包装的原语:</p><pre class="kd ke kf kg gt lk ll lm ln aw lo bi"><span id="5768" class="lp lq in ll b gy lr ls l lt lu">console.log(typeof new String("abc") )    // object</span><span id="1264" class="lp lq in ll b gy lv ls l lt lu">console.log(typeof abc)    // string<br/><br/>console.log(new String("abc") === "abc")  // false<br/>  </span></pre><p id="e900" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated"><strong class="kq io"> typeof是一个对图元进行分类的操作符，有助于将它们与对象区分开来</strong></p><p id="a944" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">“空类型”问题是JavaScript原始版本的遗留问题。</p><p id="4e50" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">在这个版本中，值以32位为单位，包括一个短类型标记(1-3位)和值的实际数据。类型标签保存在单元的低位。</p><p id="58ac" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">类型标签(1–3位)+值(29–31位)=总共32位</p><p id="49a0" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">共有五种类型标签:</p><ul class=""><li id="f445" class="mw mx in kq b kr ks ku kv kx my lb mz lf na lj nb nc nd ne bi translated"><strong class="kq io"> 000 </strong>:对象。数据是对对象的引用。</li><li id="7d9d" class="mw mx in kq b kr nf ku ng kx nh lb ni lf nj lj nb nc nd ne bi translated"><strong class="kq io"> 1 </strong> : int。数据是31位有符号整数。</li><li id="fdf3" class="mw mx in kq b kr nf ku ng kx nh lb ni lf nj lj nb nc nd ne bi translated"><strong class="kq io"> 010 </strong>:双。该数据是对双浮点数的引用。</li><li id="7783" class="mw mx in kq b kr nf ku ng kx nh lb ni lf nj lj nb nc nd ne bi translated"><strong class="kq io"> 100 </strong>:字符串。数据是对字符串的引用。</li><li id="042a" class="mw mx in kq b kr nf ku ng kx nh lb ni lf nj lj nb nc nd ne bi translated"><strong class="kq io"> 110 </strong>:布尔型。数据是布尔值。</li></ul><p id="8027" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">有两个特殊值:</p><ul class=""><li id="6516" class="mw mx in kq b kr ks ku kv kx my lb mz lf na lj nb nc nd ne bi translated"><strong class="kq io">未定义</strong> (JSVAL_VOID)是整数2 ⁰(整数范围之外的数字)。</li><li id="1796" class="mw mx in kq b kr nf ku ng kx nh lb ni lf nj lj nb nc nd ne bi translated"><strong class="kq io"> null </strong> (JSVAL_NULL)是机器代码空指针。或者:一个对象类型标签加上一个为零的引用。</li></ul><p id="1aac" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">因为是以<strong class="kq io"> 000 </strong>(也就是对象类型标签)开头，所以的类型认为是对象。</p><p id="e85a" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">类型的引擎代码:</p><pre class="kd ke kf kg gt lk ll lm ln aw lo bi"><span id="1805" class="lp lq in ll b gy lr ls l lt lu">JS_PUBLIC_API(JSType)<br/>    JS_TypeOfValue(JSContext *cx, jsval v)<br/>    {<br/>        JSType type = JSTYPE_VOID;<br/>        JSObject *obj;<br/>        JSObjectOps *ops;<br/>        JSClass *clasp;<br/><br/>        CHECK_REQUEST(cx);<br/>        if (JSVAL_IS_VOID(v)) {  // (1)<br/>            type = JSTYPE_VOID;<br/>        } else if (JSVAL_IS_OBJECT(v)) {  // (2)<br/>            obj = JSVAL_TO_OBJECT(v);<br/>            if (obj &amp;&amp;<br/>                (ops = obj-&gt;map-&gt;ops,<br/>                 ops == &amp;js_ObjectOps<br/>                 ? (clasp = OBJ_GET_CLASS(cx, obj),<br/>                    clasp-&gt;call || clasp == &amp;js_FunctionClass) // (3,4)<br/>                 : ops-&gt;call != 0)) {  // (3)<br/>                type = JSTYPE_FUNCTION;<br/>            } else {<br/>                type = JSTYPE_OBJECT;<br/>            }<br/>        } else if (JSVAL_IS_NUMBER(v)) {<br/>            type = JSTYPE_NUMBER;<br/>        } else if (JSVAL_IS_STRING(v)) {<br/>            type = JSTYPE_STRING;<br/>        } else if (JSVAL_IS_BOOLEAN(v)) {<br/>            type = JSTYPE_BOOLEAN;<br/>        }<br/>        return type;<br/>    }</span></pre><p id="0084" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">它从检查值v在语句中是否未定义(VOID)开始:</p><p id="2e9a" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">if (JSVAL_IS_VOID(v))</p><p id="8a18" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">然后它检查值是否是object。检查是否有以000开始的类型标签。</p><p id="31e8" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">如果它不是一个对象，它将检查它是一个数字、字符串还是布尔值。</p><p id="fb61" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">没有任何针对NULL的检查。</p><p id="ed4b" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">这是一个很容易被发现的错误，但是由于它没有被及时修复，以后要修复它就变得更加困难了。</p><p id="1dc5" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">就连JavaScript的创始人Brendan Eich也在博客上对此发表评论，称这确实是一个bug。</p></div><div class="ab cl nk nl hr nm" role="separator"><span class="nn bw bk no np nq"/><span class="nn bw bk no np nq"/><span class="nn bw bk no np"/></div><div class="ig ih ii ij ik"><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div class="gh gi nr"><img src="../Images/01fa0364ce69316ddd1b3d9a0d581e8b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1280/format:webp/1*vz1faP-uCwmz7XbvRUQOLg.png"/></div></figure><p id="b8d5" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">Brendan Eich曾经考虑过修正of类型的需要，但是拒绝了这个提议，他说:“我认为修正of类型已经太晚了。为null的类型建议的更改将破坏现有代码。</p><p id="6d96" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">在另一次讨论中，他写道:“总的来说，typeof看起来像一团乱麻，很难进行明智的改革。我们有理由相信typeof null = = = " object " *是一个bug*，它可能会从我们的网络蜘蛛中咬出真正的内容。最好的办法可能是完全不去管typeof，弃之不用，但我仍然支持null bug-fix*</p><p id="a0cf" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated"><em class="mv">更多内容看</em> <a class="ae ns" href="http://plainenglish.io/" rel="noopener ugc nofollow" target="_blank"> <em class="mv">说白了。报名参加我们的</em> </a><a class="ae ns" href="http://newsletter.plainenglish.io/" rel="noopener ugc nofollow" target="_blank"> <em class="mv">免费每周简讯</em> </a> <em class="mv">。在我们的</em> <a class="ae ns" href="https://discord.gg/GtDtUAvyhW" rel="noopener ugc nofollow" target="_blank"> <em class="mv">社区</em> </a> <em class="mv">获得独家写作机会和建议。</em></p></div></div>    
</body>
</html>