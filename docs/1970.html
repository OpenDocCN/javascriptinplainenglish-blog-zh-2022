<html>
<head>
<title>How the Lack of Internal State Makes Your Classes Easier to Test and Refactor</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">缺少内部状态如何使您的类更容易测试和重构</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/how-the-lack-of-internal-state-makes-your-classes-easier-to-test-and-refactor-c2c609fad9f?source=collection_archive---------17-----------------------#2022-05-03">https://javascript.plainenglish.io/how-the-lack-of-internal-state-makes-your-classes-easier-to-test-and-refactor-c2c609fad9f?source=collection_archive---------17-----------------------#2022-05-03</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/5f3c3399930262519c8335101da86ea2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*frU8_I029tgOkaDWmEZGGw.jpeg"/></div></div></figure><p id="3a0c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">你可能经常听说测试驱动开发(TDD)或者仅仅是编写测试就能让你的代码变得更好。很难说这是不是真的，除非你以前见过编写单元测试对代码的影响。让我们用一个简单的例子来看看这种影响:将一个类的内部状态移动到一个依赖项。</p><h1 id="e9f5" class="kw kx iq bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated">缺乏内部状态和可测试性</h1><p id="ac7d" class="pw-post-body-paragraph jy jz iq ka b kb lu kd ke kf lv kh ki kj lw kl km kn lx kp kq kr ly kt ku kv ij bi translated">保持状态最直接的方法是添加一个私有变量，并把需要的值放在一边以备后用。这将完成工作，但它使测试更加困难。对于完整的测试覆盖，您需要:</p><ol class=""><li id="283d" class="lz ma iq ka b kb kc kf kg kj mb kn mc kr md kv me mf mg mh bi translated">将实例置于您想要测试的状态</li><li id="b8e3" class="lz ma iq ka b kb mi kf mj kj mk kn ml kr mm kv me mf mg mh bi translated">检查它的行为</li></ol><p id="1c31" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">随着您添加更多的内部变量，实现预期的状态变得更加复杂:除了简单的状态，您还需要包含它们之间的组合。如果一切都按预期运行，可能会有无法实现的无效组合——但是您可能会对测试代码在达到这种不可能的条件时是否优雅地降级感兴趣。</p><p id="3d22" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">还有一种从测试中访问类的私有变量的诱惑，但是这种方法感觉是错误的。它依赖于知道类的实现，它忽略了我们为类型定义的接口。</p><h1 id="1e52" class="kw kx iq bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated">把这个州搬出去</h1><p id="8421" class="pw-post-body-paragraph jy jz iq ka b kb lu kd ke kf lv kh ki kj lw kl km kn lx kp kq kr ly kt ku kv ij bi translated">为了使代码更易测试，我们可以定义一个单独的类来保存状态。这个新类引入了一个具有新界面的层，我们可以用它来描述对象之间的关系。您可以模仿用于设置和检索状态更改的方法，从而使测试更加容易。</p><h1 id="6542" class="kw kx iq bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated">低测试性示例</h1><p id="8dce" class="pw-post-body-paragraph jy jz iq ka b kb lu kd ke kf lv kh ki kj lw kl km kn lx kp kq kr ly kt ku kv ij bi translated">作为一个低可测试性的例子，我们将有一个闹钟类:</p><figure class="mn mo mp mq gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/68733699422c0256bf305901dd141136.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*H706p-wp6ArdpmDG"/></div></div></figure><p id="7630" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们可以期待这个时钟的某些行为:</p><ul class=""><li id="063b" class="lz ma iq ka b kb kc kf kg kj mb kn mc kr md kv mr mf mg mh bi translated">当当前时间与设定的闹钟时间一致时，闹钟就会响</li><li id="c558" class="lz ma iq ka b kb mi kf mj kj mk kn ml kr mm kv mr mf mg mh bi translated">用户可以设置闹钟时间</li></ul><p id="6386" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果您想测试这种行为，您需要两种方法之一:</p><ol class=""><li id="c512" class="lz ma iq ka b kb kc kf kg kj mb kn mc kr md kv me mf mg mh bi translated">等到硬编码的闹铃时间到来，看看闹铃是否响起</li><li id="9d8e" class="lz ma iq ka b kb mi kf mj kj mk kn ml kr mm kv me mf mg mh bi translated">将时间设置为离闹钟时间只有几分钟，看看它是否按预期响起</li></ol><p id="11c9" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">方法1是错误的；这可能需要几个小时的等待。</p><p id="4e0a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">方法2也有缺点，只是更加微妙。这将要求您的测试读取当前时间，并增加等待结果的秒数。设置等待时间将是在稳定测试和等待太长时间减慢测试之间的权衡，在稳定测试中，我们等待足够长的时间以避免错过慢机器上的点。</p><h1 id="2cbc" class="kw kx iq bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated">更多可测试的例子</h1><p id="0d68" class="pw-post-body-paragraph jy jz iq ka b kb lu kd ke kf lv kh ki kj lw kl km kn lx kp kq kr ly kt ku kv ij bi translated">我们可以通过将状态移至外部来提高代码的可测试性:</p><figure class="mn mo mp mq gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/b4e9cf1a45909553dcb5e1036ba11904.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*i5_uhvQLyB6VpmpM"/></div></div></figure><p id="cafc" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">因此，在这种情况下，引入一个依赖项-AlarmTimeStore-它将值集保持在AlarmClock类之外。</p><h1 id="99cf" class="kw kx iq bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated">这如何使测试更容易</h1><p id="25bb" class="pw-post-body-paragraph jy jz iq ka b kb lu kd ke kf lv kh ki kj lw kl km kn lx kp kq kr ly kt ku kv ij bi translated">当我们将状态移出时，我们引入了一个依赖项来促进测试。当我们在测试中运行这个类时，我们用模拟替换了实际的依赖关系。模拟是对其他实例的替代，这些实例提供了相同的接口，但允许设置期望值。您可以提供一个函数调用将返回的值。</p><p id="f4cf" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">Mocking允许您独立于其他代码运行类或函数——因此您可以控制将什么值返回到您的单元，并检查它是否按预期运行。</p><figure class="mn mo mp mq gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/1902e77dc841fd98ffb2994183193341.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Jgqdg6N0DBuwbzHh"/></div></div></figure><h1 id="3d0c" class="kw kx iq bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated">这如何让代码变得更好</h1><p id="c2ea" class="pw-post-body-paragraph jy jz iq ka b kb lu kd ke kf lv kh ki kj lw kl km kn lx kp kq kr ly kt ku kv ij bi translated">通过将状态移出，我们在这两个类之间定义了一个清晰的分离。随着持久层有了一个明确定义的接口，将来更容易:</p><ul class=""><li id="543e" class="lz ma iq ka b kb kc kf kg kj mb kn mc kr md kv mr mf mg mh bi translated">使它更高级:例如，不将值存储在运行时内存中，而是将其保存到浏览器或文件中，或者</li><li id="e561" class="lz ma iq ka b kb mi kf mj kj mk kn ml kr mm kv mr mf mg mh bi translated">在应用程序的其他部分重用它:随着应用程序变得越来越复杂，我们可以通过概括我们在这里构建的解决方案来找到不同的用例。</li></ul><h1 id="8402" class="kw kx iq bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated">常见的评论:如此多的抽象层</h1><p id="d6b5" class="pw-post-body-paragraph jy jz iq ka b kb lu kd ke kf lv kh ki kj lw kl km kn lx kp kq kr ly kt ku kv ij bi translated">一些人批评这种方法引入了太多的抽象层来实现特性。当我试图保持代码的可测试性时，我得到了这样的反馈。最有可能的是，这是一个关于单元测试的个人品味和信念的问题:我喜欢我的代码被测试所覆盖，并且我乐于对代码设计进行细微的改变以确保它易于测试。如果有人不关心测试，我不确定是否有强有力的论据证明这种方法在客观上比其他方法更好。我上面列出的灵活性的价值取决于我们在某个时候实际需要它们的可能性。如果你很可能不需要它们，你可以说这是为我们可能永远不需要的用例做准备的不成熟的行为。</p><h1 id="6bc3" class="kw kx iq bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated">想多读点？</h1><p id="0a24" class="pw-post-body-paragraph jy jz iq ka b kb lu kd ke kf lv kh ki kj lw kl km kn lx kp kq kr ly kt ku kv ij bi translated">如果你觉得这篇文章有帮助，你可以在这里继续阅读关于测试的文章。</p></div><div class="ab cl mt mu hu mv" role="separator"><span class="mw bw bk mx my mz"/><span class="mw bw bk mx my mz"/><span class="mw bw bk mx my"/></div><div class="ij ik il im in"><p id="d28b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><em class="na">最初发布于</em><a class="ae ms" href="https://how-to.dev/how-the-lack-of-internal-state-makes-your-classes-easier-to-test-and-refactor" rel="noopener ugc nofollow" target="_blank"><em class="na">https://how-to . dev</em></a><em class="na">。</em></p><p id="e492" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><em class="na">更多内容请看</em><a class="ae ms" href="https://plainenglish.io/" rel="noopener ugc nofollow" target="_blank"><strong class="ka ir"><em class="na">plain English . io</em></strong></a><em class="na">。报名参加我们的</em> <a class="ae ms" href="http://newsletter.plainenglish.io/" rel="noopener ugc nofollow" target="_blank"> <strong class="ka ir"> <em class="na">免费周报</em> </strong> </a> <em class="na">。关注我们关于</em><a class="ae ms" href="https://twitter.com/inPlainEngHQ" rel="noopener ugc nofollow" target="_blank"><strong class="ka ir"><em class="na">Twitter</em></strong></a><em class="na">和</em><a class="ae ms" href="https://www.linkedin.com/company/inplainenglish/" rel="noopener ugc nofollow" target="_blank"><strong class="ka ir"><em class="na">LinkedIn</em></strong></a><em class="na">。加入我们的</em> <a class="ae ms" href="https://discord.gg/GtDtUAvyhW" rel="noopener ugc nofollow" target="_blank"> <strong class="ka ir"> <em class="na">社区不和谐</em> </strong> </a> <em class="na">。</em></p></div></div>    
</body>
</html>