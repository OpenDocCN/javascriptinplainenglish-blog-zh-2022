<html>
<head>
<title>A Brief Introduction to WebSocket</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">WebSocket简介</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/a-brief-introduction-to-websocket-eada28567057?source=collection_archive---------5-----------------------#2022-11-24">https://javascript.plainenglish.io/a-brief-introduction-to-websocket-eada28567057?source=collection_archive---------5-----------------------#2022-11-24</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><div class=""><h2 id="4542" class="pw-subtitle-paragraph jk im in bd b jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb dk translated">如何使用websocket，websocket.io</h2></div><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi kc"><img src="../Images/ddc6560685dbb104fc58e6b4cc5842da.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4ymdKZpdOQLge_Q7KOaSTw.png"/></div></div></figure><p id="1cde" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">近年来，许多H5 API和技术开始蓬勃发展，今天我们将讨论其中一个更有趣的API，WebSocket。</p><h2 id="fa9c" class="lk ll in bd lm ln lo dn lp lq lr dp ls kx lt lu lv lb lw lx ly lf lz ma mb mc bi translated">超文本传送协议</h2><p id="09f0" class="pw-post-body-paragraph ko kp in kq b kr md jo kt ku me jr kw kx mf kz la lb mg ld le lf mh lh li lj ig bi translated">HTTP是客户端/服务器模型中用于请求-响应的协议，在这种模型中，浏览器向服务器提交HTTP请求，服务器用请求的资源进行响应。</p><blockquote class="mi mj mk"><p id="46f2" class="ko kp ml kq b kr ks jo kt ku kv jr kw mm ky kz la mn lc ld le mo lg lh li lj ig bi translated">言下之意，你可以把这个模型想象成一个对讲机，一个人说话，另一个人听</p></blockquote><p id="1c5d" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated"><strong class="kq io"> HTTP是半双工通信</strong></p><p id="44d3" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">这种半双工通信的特征如下。</p><ul class=""><li id="335a" class="mp mq in kq b kr ks ku kv kx mr lb ms lf mt lj mu mv mw mx bi translated">数据在同一时刻向一个方向流动，客户端向服务器请求数据-&gt;单向，服务器向客户端返回数据-&gt;单向</li><li id="63b3" class="mp mq in kq b kr my ku mz kx na lb nb lf nc lj mu mv mw mx bi translated">服务器无法主动将数据推送到客户端</li></ul><p id="c012" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">以上是对HTTP协议的简要概述，所以下面直接进入今天的话题。</p><p id="6de9" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated"><strong class="kq io">双工通信</strong></p><p id="7e88" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">在H5出现websocket之前，实现这种推送技术最常见的三种方式是:轮询、长轮询和iframe流，但这三种方式都或多或少存在相同的缺点。</p><p id="3ed3" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">所以，websocket，一个好的API，来完善一个更好的双工通信的实现。</p><h2 id="26f5" class="lk ll in bd lm ln lo dn lp lq lr dp ls kx lt lu lv lb lw lx ly lf lz ma mb mc bi translated">WebSocket</h2><p id="3a23" class="pw-post-body-paragraph ko kp in kq b kr md jo kt ku me jr kw kx mf kz la lb mg ld le lf mh lh li lj ig bi translated">WebSocket的实现是为了在客户端和服务器之间建立一个持久的连接，双方可以随意发送数据。</p><p id="31cd" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">当然，如果你了解的比较多，应该知道它属于应用层协议，基于TCP传输协议，复用了HTTP的握手通道。</p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div class="gh gi nd"><img src="../Images/ac192c35ed9e3576bc18ff02317d15c8.png" data-original-src="https://miro.medium.com/v2/resize:fit:910/format:webp/1*AI6yMC27oFO7YOzIxG1iYA.png"/></div></figure><p id="c564" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">让我们实现前端页面的WebSocket，看看基本用法:</p><pre class="kd ke kf kg gt ne nf ng bn nh ni bi"><span id="632e" class="nj ll in nf b be nk nl l nm nn">// Create index.html<br/><br/>let ws = new WebSocket('ws://localhost:9999');<br/><br/>// onopen is triggered when the client establishes a connection with the server<br/>ws.onopen = function() {<br/>    ws.send('Hello,Maxwell');<br/>};<br/><br/>// onmessage is triggered when the server sends a message to the client<br/>ws.onmessage = function(res) {<br/>    console.log(res);   // MessageEvent object<br/>    // The real message data is res.data<br/>    console.log(res.data);<br/>};</span></pre><p id="515d" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">让我们编写websocket的后端部分来接收和发送消息。</p><p id="a8fe" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">这里我们用node的express简单的搭建一个后端服务，目录结构也很简单，如下:</p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div class="gh gi no"><img src="../Images/f44146ca33f8f7185157c027f050df35.png" data-original-src="https://miro.medium.com/v2/resize:fit:380/format:webp/1*SPFTEqDRdsKs8PFGA3q3pQ.png"/></div></figure><p id="a8e5" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">server.js</p><pre class="kd ke kf kg gt ne nf ng bn nh ni bi"><span id="8278" class="nj ll in nf b be nk nl l nm nn">const express = require('express');<br/>const app = express();<br/>// Setting up static folders<br/>app.use(express.static(__dirname));<br/>// Listening to port 3000<br/>app.listen(3000);<br/>// =============================================<br/>// Start creating a websocket service<br/>const Server = require('ws').Server;<br/>// Here is to set the port number of the server, and the above port 3000 do not have to be consistent<br/>const ws = new Server({ port: 9999 });<br/><br/>// Listen to the connection between the server and the client<br/>ws.on('connection', function(socket) {<br/>    // Listening to messages from the client<br/>    socket.on('message', function(msg) {<br/>        console.log(msg);   // This is the message from the client<br/>        // The server can also send messages to the client<br/>        socket.send(`server say： ${msg}`);<br/>    });<br/>});</span></pre><p id="6f58" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">这将建立一个后端服务，浏览<code class="fe np nq nr nf b">localhost:3000</code>然后你可以在控制台看到消息。</p><p id="66ee" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">这还没有结束，因为websocket是来自H5标准的东西，旧的浏览器当然不能很好地支持它，这就是前端必须处理该死的兼容性问题的时候。这就是为什么有一个更好的库，著名的socket.io</p><h2 id="4da7" class="lk ll in bd lm ln lo dn lp lq lr dp ls kx lt lu lv lb lw lx ly lf lz ma mb mc bi translated">socket.io</h2><div class="ns nt gp gr nu nv"><a href="https://socket.io/" rel="noopener  ugc nofollow" target="_blank"><div class="nw ab fo"><div class="nx ab ny cl cj nz"><h2 class="bd io gy z fp oa fr fs ob fu fw im bi translated">插座。超正析象管(Image Orthicon)</h2><div class="oc l"><h3 class="bd b gy z fp oa fr fs ob fu fw dk translated">放心！在WebSocket连接不可行的情况下，它将回退到HTTP长轮询。如果…</h3></div><div class="od l"><p class="bd b dl z fp oa fr fs ob fu fw dk translated">socket.io</p></div></div><div class="oe l"><div class="of l og oh oi oe oj km nv"/></div></div></a></div><p id="38d4" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated"><strong class="kq io">socket . io的特性</strong></p><ul class=""><li id="a8e0" class="mp mq in kq b kr ks ku kv kx mr lb ms lf mt lj mu mv mw mx bi translated">易用性:封装了服务器端和客户端，易于使用</li><li id="a197" class="mp mq in kq b kr my ku mz kx na lb nb lf nc lj mu mv mw mx bi translated">跨平台:支持跨平台，可以选择在服务器端或客户端开发实时应用</li><li id="7f5f" class="mp mq in kq b kr my ku mz kx na lb nb lf nc lj mu mv mw mx bi translated">自适应:将使用WebSocket、Ajax长轮询或Iframe流来根据浏览器选择最佳方式，甚至支持IE5.5</li></ul><p id="237c" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated"><strong class="kq io">安装</strong></p><pre class="kd ke kf kg gt ne nf ng bn nh ni bi"><span id="794a" class="nj ll in nf b be nk nl l nm nn">npm i socket.io -S</span></pre><p id="dc77" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">使用express framework in node构建一个服务，代码如下:</p><pre class="kd ke kf kg gt ne nf ng bn nh ni bi"><span id="a262" class="nj ll in nf b be nk nl l nm nn">// server.js<br/>const express = require('express');<br/>const app = express();<br/>// Setting up static folders<br/>app.use(express.static(__dirname));<br/>// Create a server service via node's http module<br/>const server = require('http').createServer(app);<br/>// WebSocket is dependent on the HTTP protocol for handshaking<br/>const io = require('socket.io')(server);<br/>// Listen to the connection between the client and the server<br/>io.on('connection', function(socket) {<br/>    // send a message to the client<br/>    socket.send('Hi,I am server');<br/>    // Listening to the client for successful message reception<br/>    socket.on('message', function(msg) {<br/>        console.log(msg);  // Message from the client<br/>        socket.send('Hello, I am client' );<br/>    });<br/>});<br/>// Listening to port 3000<br/>server.listen(3000);</span></pre><p id="81a4" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">服务器端代码已经写好了，接下来开始写前端部分。</p><p id="6cb9" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">一旦服务器运行，客户端将需要引用一个动态生成的文件路径，该路径通过直接引用(/socket.io/socket.io.js)来固定</p><pre class="kd ke kf kg gt ne nf ng bn nh ni bi"><span id="8eea" class="nj ll in nf b be nk nl l nm nn">// index.html<br/>// Reference to socket.io js file<br/>&lt;script src="/socket.io/socket.io.js"&gt;&lt;/script&gt;<br/>&lt;script&gt;<br/>    const socket = io('/');<br/>    // Listening for successful connection events with the server<br/>    socket.on('connect', () =&gt; {<br/>        console.log('Connection successful');<br/>        socket.send('HELLO I AM MAXWELL');<br/>    });<br/>    // Listening for messages from the server<br/>    socket.on('message', msg =&gt; {<br/>        console.log(`Messages received by the client： ${msg}`);  <br/>    });<br/>    // Listening for disconnection events with the server<br/>    socket.on('disconnect', () =&gt; {<br/>        console.log('Connection disconnected successfully');<br/>    });<br/>&lt;/script&gt;</span></pre><p id="0c80" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">这里有一个提示:io在创建套接字时可以接受一个url参数。</p><ul class=""><li id="0685" class="mp mq in kq b kr ks ku kv kx mr lb ms lf mt lj mu mv mw mx bi translated">url可以是套接字服务的完整http地址，例如:<strong class="kq io">io(' http://localhost:3000 ')</strong></li><li id="9fcb" class="mp mq in kq b kr my ku mz kx na lb nb lf nc lj mu mv mw mx bi translated">也可以是相对路径，比如:<strong class="kq io"> io('/') </strong></li><li id="63e2" class="mp mq in kq b kr my ku mz kx na lb nb lf nc lj mu mv mw mx bi translated">如果不填，表示当前路径默认连通，如:<strong class="kq io"> io() </strong></li></ul><p id="ca7b" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">这是基本用法，还有其他划分命名空间、添加房间和广播的方法会在后续文章中继续介绍。如果你对我的文章感兴趣，可以关注我。</p><p id="e77b" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated"><em class="ml">更多内容看</em> <a class="ae ok" href="https://plainenglish.io/" rel="noopener ugc nofollow" target="_blank"> <strong class="kq io"> <em class="ml">说白了就是io </em> </strong> </a> <em class="ml">。报名参加我们的</em> <a class="ae ok" href="http://newsletter.plainenglish.io/" rel="noopener ugc nofollow" target="_blank"> <strong class="kq io"> <em class="ml">免费周报</em> </strong> </a> <em class="ml">。关注我们关于</em> <a class="ae ok" href="https://twitter.com/inPlainEngHQ" rel="noopener ugc nofollow" target="_blank"> <strong class="kq io"> <em class="ml">推特</em> </strong> </a>，<a class="ae ok" href="https://www.linkedin.com/company/inplainenglish/" rel="noopener ugc nofollow" target="_blank"> <strong class="kq io"> <em class="ml">领英</em> </strong> </a> <em class="ml">，</em><a class="ae ok" href="https://www.youtube.com/channel/UCtipWUghju290NWcn8jhyAw" rel="noopener ugc nofollow" target="_blank"><strong class="kq io"><em class="ml">YouTube</em></strong></a><em class="ml"/><a class="ae ok" href="https://discord.gg/GtDtUAvyhW" rel="noopener ugc nofollow" target="_blank"><strong class="kq io"><em class="ml">不和</em> </strong> </a> <em class="ml">。对增长黑客感兴趣？检查</em> <a class="ae ok" href="https://circuit.ooo/" rel="noopener ugc nofollow" target="_blank"> <strong class="kq io"> <em class="ml">电路</em> </strong> </a> <em class="ml">。</em></p></div></div>    
</body>
</html>