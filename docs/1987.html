<html>
<head>
<title>JavaScript Refactoring Gotchas: 5 Ways Converting to Optional Chaining Can Break Your Code</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">JavaScript重构陷阱:转换为可选链接的5种方式会破坏代码</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/javascript-refactoring-gotchas-5-ways-converting-to-optional-chaining-can-break-your-code-bde3135a3346?source=collection_archive---------16-----------------------#2022-05-04">https://javascript.plainenglish.io/javascript-refactoring-gotchas-5-ways-converting-to-optional-chaining-can-break-your-code-bde3135a3346?source=collection_archive---------16-----------------------#2022-05-04</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><figure class="gl gn jl jm jn jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi jk"><img src="../Images/614d5b434f6beacd4ff9c25f1feb42c0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*F1qXLTdkRMgEERMzjffqxQ.jpeg"/></div></div></figure><p id="2ea9" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><strong class="jx io"/><a class="ae kt" href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/Optional_chaining" rel="noopener ugc nofollow" target="_blank"><strong class="jx io">可选链接</strong> </a> <strong class="jx io">运算符</strong> <code class="fe ku kv kw kx b"><strong class="jx io">.?</strong></code> <strong class="jx io">在对象可用时返回对象属性的值，否则返回</strong> <code class="fe ku kv kw kx b"><strong class="jx io">undefined</strong></code> <strong class="jx io">。</strong>它类似于标准的<code class="fe ku kv kw kx b">.</code>链接操作符，增加了检查对象是否被定义(即不是<a class="ae kt" href="https://developer.mozilla.org/en-US/docs/Glossary/Nullish" rel="noopener ugc nofollow" target="_blank"> nullish </a>)。</p><p id="a4d4" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">可选的链接操作符让你<strong class="jx io">编写简洁安全的连接对象链</strong>，当这些对象中的一些可以是<code class="fe ku kv kw kx b">null</code>或<code class="fe ku kv kw kx b">undefined</code>时。在ES2020中引入可选链接之前，<code class="fe ku kv kw kx b">&amp;&amp;</code>操作符通常用于检查对象是否可用(<code class="fe ku kv kw kx b">obj &amp;&amp; obj.value</code>)。</p><p id="6ce1" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">您通常可以使用可选的链接模式来简化现有检查:</p><ul class=""><li id="83cc" class="ky kz in jx b jy jz kc kd kg la kk lb ko lc ks ld le lf lg bi translated"><code class="fe ku kv kw kx b">obj &amp;&amp; obj.property</code>变成了<code class="fe ku kv kw kx b">obj?.property</code></li><li id="cf82" class="ky kz in jx b jy lh kc li kg lj kk lk ko ll ks ld le lf lg bi translated"><code class="fe ku kv kw kx b">obj != null &amp;&amp; obj.property</code>变成了<code class="fe ku kv kw kx b">obj?.property</code></li><li id="3e1f" class="ky kz in jx b jy lh kc li kg lj kk lk ko ll ks ld le lf lg bi translated"><code class="fe ku kv kw kx b">obj != null ? obj.property : undefined</code>变为<code class="fe ku kv kw kx b">obj?.property</code></li><li id="db7b" class="ky kz in jx b jy lh kc li kg lj kk lk ko ll ks ld le lf lg bi translated"><code class="fe ku kv kw kx b">arr &amp;&amp; arr[i]</code>变为<code class="fe ku kv kw kx b">arr?.[i]</code></li><li id="b6cf" class="ky kz in jx b jy lh kc li kg lj kk lk ko ll ks ld le lf lg bi translated"><code class="fe ku kv kw kx b">f &amp;&amp; f()</code>变为<code class="fe ku kv kw kx b">f?.()</code></li><li id="b42f" class="ky kz in jx b jy lh kc li kg lj kk lk ko ll ks ld le lf lg bi translated">等等。</li></ul><p id="e421" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">但是，在某些情况下，重构为可选链接会导致错误:</p><h1 id="588f" class="lm ln in bd lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj bi translated">空值的可选链接短路，但不包括其他假值</h1><p id="3a73" class="pw-post-body-paragraph jv jw in jx b jy mk ka kb kc ml ke kf kg mm ki kj kk mn km kn ko mo kq kr ks ig bi translated">当<code class="fe ku kv kw kx b">a &amp;&amp; a.b</code>替换为<code class="fe ku kv kw kx b">a?.b</code>时，可以有<a class="ae kt" href="https://developer.mozilla.org/en-US/docs/Glossary/Falsy" rel="noopener ugc nofollow" target="_blank"> falsy </a>值的类型的执行被改变。这意味着表达式的结果值和类型可以随可选链接而不同。</p><p id="8a73" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">以下代码片段显示了一些示例:</p><pre class="mp mq mr ms gt mt kx mu mv aw mw bi"><span id="239b" class="mx ln in kx b gy my mz l na nb">function test(value) {<br/>    console.log(`${value &amp;&amp; value.length}, ${value?.length}`);<br/>}</span><span id="a70c" class="mx ln in kx b gy nc mz l na nb">test(undefined);       // undefined, undefined<br/>test(null);            // null, undefined<br/>test(true);            // undefined, undefined<br/>test(false);           // false, undefined<br/>test(1);               // undefined, undefined<br/>test(0);               // 0, undefined<br/>test({});              // undefined, undefined<br/>test([]);              // 0, 0<br/>test({ length: "a" }); // a, a<br/>test('');              // , 0<br/>test(NaN);             // NaN, undefined</span></pre><p id="126f" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">空字符串是falsy，但不是<a class="ae kt" href="https://developer.mozilla.org/en-US/docs/Glossary/Nullish" rel="noopener ugc nofollow" target="_blank"> nullish </a>，可能会特别成问题。下面是一个引入可选链接会导致问题的示例:</p><pre class="mp mq mr ms gt mt kx mu mv aw mw bi"><span id="22d3" class="mx ln in kx b gy my mz l na nb">// without optional chaining<br/>if (s &amp;&amp; s.length === 0) {<br/>  // not called for the empty string <br/>  // (e.g., legacy code that works this way)<br/>}</span><span id="0c78" class="mx ln in kx b gy nc mz l na nb">// with optional chaining<br/>if (s?.length === 0) {<br/>  // called for the empty string <br/>  // (potentially introducing undesired behavior)<br/>}</span></pre><h1 id="c72c" class="lm ln in bd lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj bi translated">可选链接将null的结果更改为undefined</h1><p id="9ba9" class="pw-post-body-paragraph jv jw in jx b jy mk ka kb kc ml ke kf kg mm ki kj kk mn km kn ko mo kq kr ks ig bi translated">用null调用<code class="fe ku kv kw kx b">a?.b</code>时，结果是<code class="fe ku kv kw kx b">undefined</code>。但是，用<code class="fe ku kv kw kx b">a &amp;&amp; a.b</code>，结果是<code class="fe ku kv kw kx b">null</code>。</p><h1 id="e750" class="lm ln in bd lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj bi translated">可选链接会影响调用的数量，并产生副作用</h1><p id="86c4" class="pw-post-body-paragraph jv jw in jx b jy mk ka kb kc ml ke kf kg mm ki kj kk mn km kn ko mo kq kr ks ig bi translated">例如，考虑改变</p><pre class="mp mq mr ms gt mt kx mu mv aw mw bi"><span id="73b4" class="mx ln in kx b gy my mz l na nb">f() &amp;&amp; f().a;</span></pre><p id="b61c" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">到…里面</p><pre class="mp mq mr ms gt mt kx mu mv aw mw bi"><span id="b08d" class="mx ln in kx b gy my mz l na nb">f()?.a;</span></pre><p id="6ccc" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">同<code class="fe ku kv kw kx b">&amp;&amp;</code>，<code class="fe ku kv kw kx b">f</code>叫一两遍。然而，可选链接<code class="fe ku kv kw kx b">f</code>只被调用一次。如果<code class="fe ku kv kw kx b">f</code>有副作用，这个副作用会被调用不同的次数，潜在地改变行为。这种行为不仅适用于函数和方法调用，也适用于可能有副作用的getters。</p><h1 id="fd63" class="lm ln in bd lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj bi translated">TypeScript不支持“void”类型的可选链接</h1><p id="0046" class="pw-post-body-paragraph jv jw in jx b jy mk ka kb kc ml ke kf kg mm ki kj kk mn km kn ko mo kq kr ks ig bi translated"><a class="ae kt" href="https://github.com/microsoft/TypeScript/issues/35850" rel="noopener ugc nofollow" target="_blank"> TypeScript不支持</a> <code class="fe ku kv kw kx b"><a class="ae kt" href="https://github.com/microsoft/TypeScript/issues/35850" rel="noopener ugc nofollow" target="_blank">void</a></code>事件的可选链接，尽管相应的JavaScript代码可以工作。</p><pre class="mp mq mr ms gt mt kx mu mv aw mw bi"><span id="cfc6" class="mx ln in kx b gy my mz l na nb">type Input = void | {<br/>    property: string<br/>};</span><span id="d703" class="mx ln in kx b gy nc mz l na nb">function f(input: Input) {<br/>    // this works:<br/>    console.log(input &amp;&amp; input.property);<br/>    // this breaks because void is not undefined in TypeScript:<br/>    console.log(input?.property);<br/>}</span></pre><h1 id="fbb9" class="lm ln in bd lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj bi translated">旧的浏览器和JavaScript引擎不支持可选链接</h1><p id="fd62" class="pw-post-body-paragraph jv jw in jx b jy mk ka kb kc ml ke kf kg mm ki kj kk mn km kn ko mo kq kr ks ig bi translated">可选链接是ES2020的一项功能。它在所有现代浏览器和Node 14+上都受支持，但对于较旧的浏览器和Node版本，可能需要transpilation】兼容性)。</p><p id="a9b7" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><em class="nd">更多内容请看</em><a class="ae kt" href="https://plainenglish.io/" rel="noopener ugc nofollow" target="_blank"><strong class="jx io"><em class="nd">plain English . io</em></strong></a><em class="nd">。报名参加我们的</em> <a class="ae kt" href="http://newsletter.plainenglish.io/" rel="noopener ugc nofollow" target="_blank"> <strong class="jx io"> <em class="nd">免费周报</em> </strong> </a> <em class="nd">。关注我们关于</em><a class="ae kt" href="https://twitter.com/inPlainEngHQ" rel="noopener ugc nofollow" target="_blank"><strong class="jx io"><em class="nd">Twitter</em></strong></a><em class="nd">和</em><a class="ae kt" href="https://www.linkedin.com/company/inplainenglish/" rel="noopener ugc nofollow" target="_blank"><strong class="jx io"><em class="nd">LinkedIn</em></strong></a><em class="nd">。加入我们的</em> <a class="ae kt" href="https://discord.gg/GtDtUAvyhW" rel="noopener ugc nofollow" target="_blank"> <strong class="jx io"> <em class="nd">社区不和谐</em> </strong> </a> <em class="nd">。</em></p></div></div>    
</body>
</html>