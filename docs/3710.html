<html>
<head>
<title>Implementation Principle of Redux</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Redux的实现原理</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/implementation-principle-of-redux-7fe49a912960?source=collection_archive---------13-----------------------#2022-09-19">https://javascript.plainenglish.io/implementation-principle-of-redux-7fe49a912960?source=collection_archive---------13-----------------------#2022-09-19</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="4a01" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">我们为什么需要<code class="fe kf kg kh ki b">Redux</code>，<code class="fe kf kg kh ki b">Redux</code>为我们解决了什么问题？</h2></div><figure class="kk kl km kn gt ko gh gi paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gh gi kj"><img src="../Images/537f3a86aa8a0300bb6abd3938668c9e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*nHuyLTlDUNF4tRln"/></div></div><figcaption class="kv kw gj gh gi kx ky bd b be z dk">Photo by <a class="ae kz" href="https://unsplash.com/@castillcc?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Cristian Castillo</a> on <a class="ae kz" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="2410" class="pw-post-body-paragraph la lb iq lc b ld le jr lf lg lh ju li lj lk ll lm ln lo lp lq lr ls lt lu lv ij bi translated">在一切开始之前，我们首先要回答一个问题:我们为什么需要<code class="fe kf kg kh ki b">redux</code>,<code class="fe kf kg kh ki b">redux</code>为我们解决了什么问题？只有回答了这个问题，才能把握<code class="fe kf kg kh ki b">redux</code>的设计思路。</p><p id="1c02" class="pw-post-body-paragraph la lb iq lc b ld le jr lf lg lh ju li lj lk ll lm ln lo lp lq lr ls lt lu lv ij bi translated">作为一个基于组件的开发框架，组件之间有大量的通信。有时这些通信跨越多个组件，或者在多个组件之间共享一组数据。简单的父子组件值传递无法满足我们的需求。自然，我们需要一个地方来访问和操纵这个公共状态。而<code class="fe kf kg kh ki b">redux</code>为我们提供了管理公共状态的解决方案，我们后续的设计和实现也将围绕这一需求。</p><p id="afe0" class="pw-post-body-paragraph la lb iq lc b ld le jr lf lg lh ju li lj lk ll lm ln lo lp lq lr ls lt lu lv ij bi translated">我们来思考一下如何管理公共状态:既然是公共状态，那么我们可以直接提取公共状态。我们创建一个<code class="fe kf kg kh ki b">store.js</code>文件，然后将公共状态直接存储在其中。其他组件只要导入该存储，就可以访问共享状态。</p><pre class="kk kl km kn gt lw ki lx ly aw lz bi"><span id="ebd3" class="ma mb iq ki b gy mc md l me mf">const state = {    <br/>    count: 0<br/>}</span></pre><p id="ba7a" class="pw-post-body-paragraph la lb iq lc b ld le jr lf lg lh ju li lj lk ll lm ln lo lp lq lr ls lt lu lv ij bi translated">我们在存储中存储一个公共状态计数，组件可以在导入存储后操作这个计数。这是最直接的商店。当然，我们的店一定不能这么设计。有两个主要原因:</p><ul class=""><li id="f3c7" class="mg mh iq lc b ld le lg lh lj mi ln mj lr mk lv ml mm mn mo bi translated"><strong class="lc ir">很容易误用。</strong>比如有人不小心把<code class="fe kf kg kh ki b">{}</code>的值赋给了商店，清空了商店，或者误修改了其他组件的数据，都是不安全的，而且很难排查错误，所以我们需要有条件直接操作商店，防止用户直接修改商店的数据。</li><li id="731e" class="mg mh iq lc b ld mp lg mq lj mr ln ms lr mt lv ml mm mn mo bi translated"><strong class="lc ir">可读性差JS是一种非常依赖语义的语言。</strong>试想一下，如果不加注释直接在代码中修改公共状态，以后其他人维护代码会更加迷茫。为了理解修改状态的含义，还必须从上下文中进行推断，所以我们最好给每个操作取一个名字。</li></ul><p id="20a5" class="pw-post-body-paragraph la lb iq lc b ld le jr lf lg lh ju li lj lk ll lm ln lo lp lq lr ls lt lu lv ij bi translated">让我们重新思考如何设计这个公共状态管理器。根据我们上面的分析，我们希望公共状态可以全局访问，私有状态不能直接修改。想想这个闭包是不是正好适合这个。有两个要求，所以我们将公共状态设计为闭包(理解闭包有困难的同学也可以跳过闭包，不影响后续理解)。</p><p id="9313" class="pw-post-body-paragraph la lb iq lc b ld le jr lf lg lh ju li lj lk ll lm ln lo lp lq lr ls lt lu lv ij bi translated">因为我们想要访问状态，所以必须有getters和setters，当状态改变时，我们必须广播通知组件状态已经改变。这不就对应了<code class="fe kf kg kh ki b">redux</code> : <code class="fe kf kg kh ki b">getState, dispatch, and subscribe</code>三个API吗？我们用几行代码勾勒出商店的大致形状:</p><figure class="kk kl km kn gt ko"><div class="bz fp l di"><div class="mu mv l"/></div></figure><h1 id="e5d9" class="mw mb iq bd mx my mz na nb nc nd ne nf jw ng jx nh jz ni ka nj kc nk kd nl nm bi translated">1.getState()实现</h1><p id="93a1" class="pw-post-body-paragraph la lb iq lc b ld nn jr lf lg no ju li lj np ll lm ln nq lp lq lr nr lt lu lv ij bi translated"><code class="fe kf kg kh ki b">getState()</code>的实现很简单，只需返回当前状态:</p><figure class="kk kl km kn gt ko"><div class="bz fp l di"><div class="mu mv l"/></div></figure><h1 id="9ad1" class="mw mb iq bd mx my mz na nb nc nd ne nf jw ng jx nh jz ni ka nj kc nk kd nl nm bi translated">2.dispatch()实现</h1><p id="7c95" class="pw-post-body-paragraph la lb iq lc b ld nn jr lf lg no ju li lj np ll lm ln nq lp lq lr nr lt lu lv ij bi translated">我们必须考虑<code class="fe kf kg kh ki b">dispatch()</code>的实施。经过上面的分析，我们的目标是有条件地修改门店数据，那么我们如何实现这两点呢？我们已经知道，在使用dispatch时，我们会向<code class="fe kf kg kh ki b">dispatch()</code>传递一个action对象，这个对象包含了我们要修改的状态和操作的名称(actionType)。根据不同的类型，商店将修改相应的状态。我们在这里也使用这种设计:</p><figure class="kk kl km kn gt ko"><div class="bz fp l di"><div class="mu mv l"/></div></figure><p id="7d0f" class="pw-post-body-paragraph la lb iq lc b ld le jr lf lg lh ju li lj lk ll lm ln lo lp lq lr ls lt lu lv ij bi translated">我们在dispatch里面写了<code class="fe kf kg kh ki b">actionType</code>的判断，非常臃肿笨拙，于是想到把修改状态的这部分规则提取出来放在外面，也就是我们熟悉的reducer。让我们修改代码，让减速器从外部传入:</p><figure class="kk kl km kn gt ko"><div class="bz fp l di"><div class="mu mv l"/></div></figure><p id="d515" class="pw-post-body-paragraph la lb iq lc b ld le jr lf lg lh ju li lj lk ll lm ln lo lp lq lr ls lt lu lv ij bi translated">然后我们创建一个<code class="fe kf kg kh ki b">reducer.js</code>文件并编写我们的reducer:</p><figure class="kk kl km kn gt ko"><div class="bz fp l di"><div class="mu mv l"/></div></figure><p id="9257" class="pw-post-body-paragraph la lb iq lc b ld le jr lf lg lh ju li lj lk ll lm ln lo lp lq lr ls lt lu lv ij bi translated">代码写到这里，我们可以验证<code class="fe kf kg kh ki b">getState</code>和<code class="fe kf kg kh ki b">dispatch</code>:</p><figure class="kk kl km kn gt ko"><div class="bz fp l di"><div class="mu mv l"/></div></figure><p id="f595" class="pw-post-body-paragraph la lb iq lc b ld le jr lf lg lh ju li lj lk ll lm ln lo lp lq lr ls lt lu lv ij bi translated">运行代码，我们会发现打印的状态是:<code class="fe kf kg kh ki b">{ count: NaN }</code>，这是因为存储中的初始数据是空的，<code class="fe kf kg kh ki b">state.count + 1</code>实际上是<code class="fe kf kg kh ki b">underfind+1</code>，而<code class="fe kf kg kh ki b">NaN</code>是输出，所以我们要先做存储数据初始化，我们在执行<code class="fe kf kg kh ki b">dispatch ({ type: ‘plus’ })</code>之前执行一个初始化的调度，这个调度的<code class="fe kf kg kh ki b">actionType</code>可以随意填充，只要它不重复现有的类型，这样reducer中的开关就可以默认地去初始化存储:</p><figure class="kk kl km kn gt ko"><div class="bz fp l di"><div class="mu mv l"/></div></figure><h1 id="fe8e" class="mw mb iq bd mx my mz na nb nc nd ne nf jw ng jx nh jz ni ka nj kc nk kd nl nm bi translated">3.subscribe()实现</h1><p id="50d0" class="pw-post-body-paragraph la lb iq lc b ld nn jr lf lg no ju li lj np ll lm ln nq lp lq lr nr lt lu lv ij bi translated">虽然我们已经能够访问公共状态，但是存储的改变不会直接引起视图的更新。我们需要监控商店的变化。这里我们应用了一个设计模式——观察者模式。观察者模式广泛用于监控事件。实现(有些地方写的是发布订阅模式，但我觉得这里叫观察者模式更准确。关于观察者和发布订阅的区别有很多讨论，读者可以搜索)。</p><p id="8898" class="pw-post-body-paragraph la lb iq lc b ld le jr lf lg lh ju li lj lk ll lm ln lo lp lq lr ls lt lu lv ij bi translated">所谓观察者模式，概念也很简单:观察者监听观察到的变化，当观察到变化时通知所有观察者。那么，我们如何实现这个监控-通知功能呢？为了照顾到不熟悉观察者模式实现的同学，我们跳出<code class="fe kf kg kh ki b">redux</code>来写一个简单的观察者模式实现代码:</p><figure class="kk kl km kn gt ko"><div class="bz fp l di"><div class="mu mv l"/></div></figure><p id="9c19" class="pw-post-body-paragraph la lb iq lc b ld le jr lf lg lh ju li lj lk ll lm ln lo lp lq lr ls lt lu lv ij bi translated">解释一下上面的代码:observer对象有一个update方法(收到通知后要执行的方法)，我们想在observer发送通知后执行这个方法；观察者有<code class="fe kf kg kh ki b">addObserver</code>和【notify】方法，<code class="fe kf kg kh ki b">addObserver</code>用来收集观察者，它是将观察者的更新方法加入到一个队列中，当执行notify时，所有观察者的更新方法都从队列中取出来执行，从而实现通知的功能。我们的<code class="fe kf kg kh ki b">redux</code>监控通知功能也将按照这个实现思路实现<code class="fe kf kg kh ki b">subscribe</code>:</p><p id="c5d5" class="pw-post-body-paragraph la lb iq lc b ld le jr lf lg lh ju li lj lk ll lm ln lo lp lq lr ls lt lu lv ij bi translated">有了上面观察者模式的例子，<code class="fe kf kg kh ki b">subscribe</code>的实现就应该很好理解了。在这里，dispatch和notify被合并。每次调度时，我们都广播通知组件库状态已经改变。</p><figure class="kk kl km kn gt ko"><div class="bz fp l di"><div class="mu mv l"/></div></figure><p id="7330" class="pw-post-body-paragraph la lb iq lc b ld le jr lf lg lh ju li lj lk ll lm ln lo lp lq lr ls lt lu lv ij bi translated">我们试试这个<code class="fe kf kg kh ki b">subscribe</code>(不需要创建一个组件然后把商店介绍给<code class="fe kf kg kh ki b">subscribe</code>，直接在<code class="fe kf kg kh ki b">store.js</code>中模拟两个组件使用<code class="fe kf kg kh ki b">subscribe</code>订阅商店变化):</p><figure class="kk kl km kn gt ko"><div class="bz fp l di"><div class="mu mv l"/></div></figure><p id="2931" class="pw-post-body-paragraph la lb iq lc b ld le jr lf lg lh ju li lj lk ll lm ln lo lp lq lr ls lt lu lv ij bi translated">至此，一个简单的<code class="fe kf kg kh ki b">redux</code>已经完成，参数验证等细节也加入到了<code class="fe kf kg kh ki b">redux</code>的真实源代码中，但大致思路同上。</p><h1 id="10e7" class="mw mb iq bd mx my mz na nb nc nd ne nf jw ng jx nh jz ni ka nj kc nk kd nl nm bi translated">最后</h1><p id="12c4" class="pw-post-body-paragraph la lb iq lc b ld nn jr lf lg no ju li lj np ll lm ln nq lp lq lr nr lt lu lv ij bi translated"><strong class="lc ir">感谢阅读</strong>。期待您的关注，阅读更多高质量的文章。</p><div class="ns nt gp gr nu"><div role="button" tabindex="0" class="ab bv gv cb fp nv nw bn nx kt ex"><div class="ny l"><div class="ab q"><div class="l di"><img alt="omgzui" class="l de bw nz oa fe" src="../Images/113db82933227743d0067a68e250ac93.png" width="20" height="20" loading="lazy" data-original-src="https://miro.medium.com/v2/resize:fill:40:40/1*AmBIV4haXTWPO--EhE0Q1A.jpeg"/><div class="fb bw l nz oa fc n aw fd"/></div><div class="hh l fo"><p class="bd b dl z fp fq fr fs ft fu fv fw dk translated"><a class="ae af ag ah ai aj ak al am an ao ap aq ar as" href="https://medium.com/@omgzui?source=post_page-----7fe49a912960--------------------------------" rel="noopener follow" target="_top"> omgzui </a></p></div></div><div class="od oe gw l"><h2 class="bd ir tu mg fp tv fr fs tw fu fw ip bi translated">更好的编程</h2></div><div class="ab q"><div class="l fo"><a class="bd b be z bi tx au ty tz ua qf ub an eh ei uc ud ue el em eo de bk ep" href="https://medium.com/@omgzui/list/better-programing-9b4c9bb174aa?source=post_page-----7fe49a912960--------------------------------" rel="noopener follow" target="_top">View list</a></div><div class="uf l fo"><span class="bd b dl z dk">109 stories</span></div></div></div><div class="oq dh or fp ab os fo di"><div class="di oi bv oj ok"><div class="dh l"><img alt="" class="dh" src="../Images/64fcf15e27c514ec49d62966b68dbc15.png" width="194" height="194" loading="lazy" role="presentation" data-original-src="https://miro.medium.com/v2/resize:fill:388:388/0*DbDdSUf5SchniJuq"/></div></div><div class="di oi bv ol om on"><div class="dh l"><img alt="" class="dh" src="../Images/3e6ce891363c151131c5993ca0dcc526.png" width="194" height="194" loading="lazy" role="presentation" data-original-src="https://miro.medium.com/v2/resize:fill:388:388/0*7cAp-WibSblfO7hT"/></div></div><div class="di bv oo op on"><div class="dh l"><img alt="" class="dh" src="../Images/a7dd413de22f319a3c4729c9e737feb8.png" width="194" height="194" loading="lazy" role="presentation" data-original-src="https://miro.medium.com/v2/resize:fill:388:388/0*FcmHdVfoUOhlJlsG"/></div></div></div></div></div><div class="ns nt gp gr nu"><div role="button" tabindex="0" class="ab bv gv cb fp nv nw bn nx kt ex"><div class="ny l"><div class="ab q"><div class="l di"><img alt="omgzui" class="l de bw nz oa fe" src="../Images/113db82933227743d0067a68e250ac93.png" width="20" height="20" loading="lazy" data-original-src="https://miro.medium.com/v2/resize:fill:40:40/1*AmBIV4haXTWPO--EhE0Q1A.jpeg"/><div class="fb bw l nz oa fc n aw fd"/></div><div class="hh l fo"><p class="bd b dl z fp fq fr fs ft fu fv fw dk translated"><a class="ae af ag ah ai aj ak al am an ao ap aq ar as" href="https://medium.com/@omgzui?source=post_page-----7fe49a912960--------------------------------" rel="noopener follow" target="_top"> omgzui </a></p></div></div><div class="od oe gw l"><h2 class="bd ir tu mg fp tv fr fs tw fu fw ip bi translated">Java Script语言</h2></div><div class="ab q"><div class="l fo"><a class="bd b be z bi tx au ty tz ua qf ub an eh ei uc ud ue el em eo de bk ep" href="https://medium.com/@omgzui/list/javascript-48bfc7b5f93c?source=post_page-----7fe49a912960--------------------------------" rel="noopener follow" target="_top">View list</a></div><div class="uf l fo"><span class="bd b dl z dk">57 stories</span></div></div></div><div class="oq dh or fp ab os fo di"><div class="di oi bv oj ok"><div class="dh l"><img alt="" class="dh" src="../Images/64fcf15e27c514ec49d62966b68dbc15.png" width="194" height="194" loading="lazy" role="presentation" data-original-src="https://miro.medium.com/v2/resize:fill:388:388/0*DbDdSUf5SchniJuq"/></div></div><div class="di oi bv ol om on"><div class="dh l"><img alt="" class="dh" src="../Images/3e6ce891363c151131c5993ca0dcc526.png" width="194" height="194" loading="lazy" role="presentation" data-original-src="https://miro.medium.com/v2/resize:fill:388:388/0*7cAp-WibSblfO7hT"/></div></div><div class="di bv oo op on"><div class="dh l"><img alt="" class="dh" src="../Images/a7dd413de22f319a3c4729c9e737feb8.png" width="194" height="194" loading="lazy" role="presentation" data-original-src="https://miro.medium.com/v2/resize:fill:388:388/0*FcmHdVfoUOhlJlsG"/></div></div></div></div></div><div class="ns nt gp gr nu"><div role="button" tabindex="0" class="ab bv gv cb fp nv nw bn nx kt ex"><div class="ny l"><div class="ab q"><div class="l di"><img alt="omgzui" class="l de bw nz oa fe" src="../Images/113db82933227743d0067a68e250ac93.png" width="20" height="20" loading="lazy" data-original-src="https://miro.medium.com/v2/resize:fill:40:40/1*AmBIV4haXTWPO--EhE0Q1A.jpeg"/><div class="fb bw l nz oa fc n aw fd"/></div><div class="hh l fo"><p class="bd b dl z fp fq fr fs ft fu fv fw dk translated"><a class="ae af ag ah ai aj ak al am an ao ap aq ar as" href="https://medium.com/@omgzui?source=post_page-----7fe49a912960--------------------------------" rel="noopener follow" target="_top"> omgzui </a></p></div></div><div class="od oe gw l"><h2 class="bd ir tu mg fp tv fr fs tw fu fw ip bi translated">新闻</h2></div><div class="ab q"><div class="l fo"><a class="bd b be z bi tx au ty tz ua qf ub an eh ei uc ud ue el em eo de bk ep" href="https://medium.com/@omgzui/list/news-67ec0a972660?source=post_page-----7fe49a912960--------------------------------" rel="noopener follow" target="_top">View list</a></div><div class="uf l fo"><span class="bd b dl z dk">23 stories</span></div></div></div><div class="oq dh or fp ab os fo di"><div class="di oi bv oj ok"><div class="dh l"><img alt="" class="dh" src="../Images/c3f36b36bf050f98fd5a8e3c89103cad.png" width="194" height="194" loading="lazy" role="presentation" data-original-src="https://miro.medium.com/v2/resize:fill:388:388/0*LISEmTdz19k7BAHY"/></div></div><div class="di oi bv ol om on"><div class="dh l"><img alt="" class="dh" src="../Images/8459df5aae62dc00f04377e09544be88.png" width="194" height="194" loading="lazy" role="presentation" data-original-src="https://miro.medium.com/v2/resize:fill:388:388/0*RvBGLw3V9JZfn_HO"/></div></div><div class="di bv oo op on"><div class="dh l"><img alt="" class="dh" src="../Images/2864058bcedc8c1cd6492624ba9671c6.png" width="194" height="194" loading="lazy" role="presentation" data-original-src="https://miro.medium.com/v2/resize:fill:388:388/0*IUWVb3zTn1_HKV9P"/></div></div></div></div></div></div><div class="ab cl ow ox hu oy" role="separator"><span class="oz bw bk pa pb pc"/><span class="oz bw bk pa pb pc"/><span class="oz bw bk pa pb"/></div><div class="ij ik il im in"><p id="8f53" class="pw-post-body-paragraph la lb iq lc b ld le jr lf lg lh ju li lj lk ll lm ln lo lp lq lr ls lt lu lv ij bi translated"><em class="pd">更多内容请看</em><a class="ae kz" href="https://plainenglish.io/" rel="noopener ugc nofollow" target="_blank"><strong class="lc ir"><em class="pd">plain English . io</em></strong></a><em class="pd">。报名参加我们的</em> <a class="ae kz" href="http://newsletter.plainenglish.io/" rel="noopener ugc nofollow" target="_blank"> <strong class="lc ir"> <em class="pd">免费周报</em> </strong> </a> <em class="pd">。关注我们关于</em><a class="ae kz" href="https://twitter.com/inPlainEngHQ" rel="noopener ugc nofollow" target="_blank"><strong class="lc ir"><em class="pd">Twitter</em></strong></a><a class="ae kz" href="https://www.linkedin.com/company/inplainenglish/" rel="noopener ugc nofollow" target="_blank"><strong class="lc ir"><em class="pd">LinkedIn</em></strong></a><em class="pd"/><a class="ae kz" href="https://www.youtube.com/channel/UCtipWUghju290NWcn8jhyAw" rel="noopener ugc nofollow" target="_blank"><strong class="lc ir"><em class="pd">YouTube</em></strong></a><em class="pd"/><a class="ae kz" href="https://discord.gg/GtDtUAvyhW" rel="noopener ugc nofollow" target="_blank"><strong class="lc ir"><em class="pd">不和</em> </strong> </a> <em class="pd">。对增长黑客感兴趣？检查</em> <a class="ae kz" href="https://circuit.ooo/" rel="noopener ugc nofollow" target="_blank"> <strong class="lc ir"> <em class="pd">电路</em> </strong> </a> <em class="pd">。</em></p></div></div>    
</body>
</html>