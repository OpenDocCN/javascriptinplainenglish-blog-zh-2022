<html>
<head>
<title>Let’s Understand Chrome V8: Compiler Workflow, Parser</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">让我们来理解Chrome V8:编译器工作流，解析器</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/lets-understand-chrome-v8-compiler-workflow-parser-36941d0ff204?source=collection_archive---------10-----------------------#2022-09-02">https://javascript.plainenglish.io/lets-understand-chrome-v8-compiler-workflow-parser-36941d0ff204?source=collection_archive---------10-----------------------#2022-09-02</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><div class=""><h2 id="58e4" class="pw-subtitle-paragraph jk im in bd b jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb dk translated">第20章:解析器基础和关键数据结构</h2></div><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi kc"><img src="../Images/2229cb027639f57877eb360bf75cd927.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yCFNVeb4ds9hl7WF-NP-kw.png"/></div></div></figure><p id="910b" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated"><em class="lk">欢迎阅读</em> <a class="ae ll" href="https://medium.com/@huidou" rel="noopener"> <em class="lk">其他章节让我们来了解一下Chrome V8 </em> </a></p><p id="7d59" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">在过去的文章中，我们讨论了很多关于V8的JavaScript编译器。我们涵盖了解析器、扫描器和字节码，以及它们的基础知识、内核代码和密钥结构。</p><p id="9f7d" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">在接下来的文章中，我们将遍历编译器工作流，并观察V8如何一步一步地将JavaScript代码转换成字节码。</p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi lm"><img src="../Images/1e0fa2d6190a61cb503ef73939e85e95.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-9URlbhVpR1122Fe55Sk3g.png"/></div></div></figure><p id="8ea6" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">图1显示了工作流程，它从您编写的JavaScript代码开始，经过扫描器和解析器，最后生成字节码。</p><p id="4c55" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated"><strong class="kq io">注意:</strong>在本文中，我使用d8.exe而不是v8.exe，因为d8.exe可以直接在终端上打印，而且d8比v8更轻便。</p><h1 id="8d54" class="ln lo in bd lp lq lr ls lt lu lv lw lx jt ly ju lz jw ma jx mb jz mc ka md me bi translated"><strong class="ak"> 1。读取JavaScript代码</strong></h1><p id="df62" class="pw-post-body-paragraph ko kp in kq b kr mf jo kt ku mg jr kw kx mh kz la lb mi ld le lf mj lh li lj ig bi translated">下面是我们的测试案例:</p><figure class="kd ke kf kg gt kh"><div class="bz fp l di"><div class="mk ml l"/></div></figure><p id="0c98" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">下面是负责执行JavaScript代码的Execute()。很简单，它首先从文件中读取JavaScript代码，然后编译并执行代码。</p><figure class="kd ke kf kg gt kh"><div class="bz fp l di"><div class="mk ml l"/></div></figure><p id="eeeb" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">在第5行中，NewFromUtf8获取文件名，这是我们的例子。在第8行，ReadFile获取文件内容，这实际上是我们的例子。</p><figure class="kd ke kf kg gt kh"><div class="bz fp l di"><div class="mk ml l"/></div></figure><p id="0476" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">第8行和第10行根据类型是ExternalOneByte还是UTF8返回JavaScript代码。这里我们的案例是UTF8，关于String::ExternalOneByteStringResource，以后再讲。</p><p id="de57" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">回到SourceGroup::Execute()，并在第14行单步执行Shell::ExecuteString，其源代码如下所示:</p><figure class="kd ke kf kg gt kh"><div class="bz fp l di"><div class="mk ml l"/></div></figure><p id="c629" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">在第13行，我们的JavaScript被包装到一个变量script_source中，该变量包含行和列的偏移量。因为V8只编译正在执行的JavaScript函数，而不是完整的JavaScript代码，所以变量script_source帮助编译器记录编译信息。</p><p id="af57" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">在第14行，开始编译JavaScript。</p><h1 id="963c" class="ln lo in bd lp lq lr ls lt lu lv lw lx jt ly ju lz jw ma jx mb jz mc ka md me bi translated"><strong class="ak"> 2。解析器初始化</strong></h1><p id="dcff" class="pw-post-body-paragraph ko kp in kq b kr mf jo kt ku mg jr kw kx mh kz la lb mi ld le lf mj lh li lj ig bi translated">在工作流中，第一部分是扫描器，第二部分是解析器。实际上，扫描器是被动的，而解析器是主动的，这意味着解析器主动从编译缓存中取出一个令牌，一旦缓存未命中，扫描器就被解析器唤醒，生成令牌并填充缓存。</p><p id="7c79" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">下面是由ScriptCompiler::Compile在第14行上面调用的CompileUnboundInternal()。</p><figure class="kd ke kf kg gt kh"><div class="bz fp l di"><div class="mk ml l"/></div></figure><p id="4425" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">上面的函数生成了UnboundInternal的东西，第11行告诉我们这个东西实际上只是一个Sharedfunction。但是，绑定是什么？Sharedfunction不能直接执行，V8需要将上下文与Sharedfunction匹配，“匹配”就是bing。</p><p id="59b6" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">让我们步入GetSharedFunctionInfoForScript。</p><figure class="kd ke kf kg gt kh"><div class="bz fp l di"><div class="mk ml l"/></div></figure><p id="f8f2" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">第7行查找我在上一篇文章中提到的编译缓存。</p><p id="2c77" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">第13行，parse_info是Parser的包装器，就像前面提到的变量script_source一样。</p><p id="5856" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">第15行，Parser_info初始化，代码如下所示:</p><figure class="kd ke kf kg gt kh"><div class="bz fp l di"><div class="mk ml l"/></div></figure><p id="554c" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">从第6行到第12行，将JavaScript代码(我们的例子)包装到变量脚本中，然后初始化line_offset和column_offset。它就像我说的那样。</p><p id="9e42" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">返回编译器::GetSharedFunctionInfoForScript()，并单步执行第23行的CompileToplevel()。</p><figure class="kd ke kf kg gt kh"><div class="bz fp l di"><div class="mk ml l"/></div></figure><p id="b023" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">第5行，literal()返回抽象语法树(AST)，V8启动编译器生成AST，如果是nullptr。</p><p id="edfe" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">第一次，AST为空，并进入ParseProgram。</p><figure class="kd ke kf kg gt kh"><div class="bz fp l di"><div class="mk ml l"/></div></figure><p id="4362" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">在第5行，创建解析器，即解析器初始化。</p><figure class="kd ke kf kg gt kh"><div class="bz fp l di"><div class="mk ml l"/></div></figure><p id="73b2" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">从第8行到第18行，取出编译信息，例如扫描仪和编译模式。</p><p id="2013" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">从第9行到第23行，重要的东西是can _ compile _ lazily。</p><p id="a750" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">第25行启用以%开头的本地命令。</p><h1 id="9325" class="ln lo in bd lp lq lr ls lt lu lv lw lx jt ly ju lz jw ma jx mb jz mc ka md me bi translated"><strong class="ak">总结</strong></h1><ul class=""><li id="5bdf" class="mm mn in kq b kr mf ku mg kx mo lb mp lf mq lj mr ms mt mu bi translated">V8使用UTF16编码JavaScript源代码；</li><li id="2a97" class="mm mn in kq b kr mv ku mw kx mx lb my lf mz lj mr ms mt mu bi translated">V8使用v8::internal::source来管理我们的JavaScript代码；</li><li id="825c" class="mm mn in kq b kr mv ku mw kx mx lb my lf mz lj mr ms mt mu bi translated">首先，查找编译缓存，如果缓存未命中，则启动编译器；</li><li id="c493" class="mm mn in kq b kr mv ku mw kx mx lb my lf mz lj mr ms mt mu bi translated">扫描器是被动的，解析器是主动的。</li></ul><p id="c5d0" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated"><em class="lk">好了，这部分就到此为止了。下次再见，保重！</em></p><p id="fc95" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">如果你有任何问题，请联系我。v8blink@outlook.com:<a class="ae ll" href="mailto:v8blink@outlook.com" rel="noopener ugc nofollow" target="_blank">微信 : qq9123013 <strong class="kq io">邮箱</strong></a></p></div><div class="ab cl na nb hr nc" role="separator"><span class="nd bw bk ne nf ng"/><span class="nd bw bk ne nf ng"/><span class="nd bw bk ne nf"/></div><div class="ig ih ii ij ik"><p id="a1f1" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated"><em class="lk">更多内容看</em> <a class="ae ll" href="https://plainenglish.io/" rel="noopener ugc nofollow" target="_blank"> <strong class="kq io"> <em class="lk">说白了。报名参加我们的</em> <a class="ae ll" href="http://newsletter.plainenglish.io/" rel="noopener ugc nofollow" target="_blank"> <strong class="kq io"> <em class="lk">免费周报</em> </strong> </a> <em class="lk">。关注我们关于</em> <a class="ae ll" href="https://twitter.com/inPlainEngHQ" rel="noopener ugc nofollow" target="_blank"> <strong class="kq io"> <em class="lk">推特</em> </strong> </a>，<a class="ae ll" href="https://www.linkedin.com/company/inplainenglish/" rel="noopener ugc nofollow" target="_blank"><strong class="kq io"><em class="lk">LinkedIn</em></strong></a><em class="lk">，</em><a class="ae ll" href="https://www.youtube.com/channel/UCtipWUghju290NWcn8jhyAw" rel="noopener ugc nofollow" target="_blank"><strong class="kq io"><em class="lk">YouTube</em></strong></a><em class="lk">，以及</em> <a class="ae ll" href="https://discord.gg/GtDtUAvyhW" rel="noopener ugc nofollow" target="_blank"> <strong class="kq io"> <em class="lk">不和</em> </strong> </a> <em class="lk">。</em></strong></a></p></div></div>    
</body>
</html>