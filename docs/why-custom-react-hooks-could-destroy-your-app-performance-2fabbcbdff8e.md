# ä¸ºä»€ä¹ˆè‡ªå®šä¹‰çš„ React é’©å­ä¼šç ´åä½ çš„åº”ç”¨ç¨‹åºçš„æ€§èƒ½

> åŸæ–‡ï¼š<https://javascript.plainenglish.io/why-custom-react-hooks-could-destroy-your-app-performance-2fabbcbdff8e?source=collection_archive---------2----------------------->

## æ¢ç©¶ä¸ºä»€ä¹ˆ react è‡ªå®šä¹‰æŒ‚é’©ä¼šå¯¹ React æ€§èƒ½äº§ç”Ÿä¸åˆ©å½±å“ï¼Œä»¥åŠå¦‚ä½•åº”å¯¹ã€‚

![](img/7298c94e45c58fd06c0e851c605ce689.png)

å“äººçš„æ ‡é¢˜ï¼Œä¸æ˜¯å—ï¼Ÿå¯æ‚²çš„æ˜¯ï¼Œè¿™æ˜¯çœŸçš„:å¯¹äºæ€§èƒ½æ•æ„Ÿçš„åº”ç”¨ç¨‹åºï¼Œå¦‚æœä¸å°å¿ƒç¼–å†™å’Œä½¿ç”¨ï¼Œè‡ªå®šä¹‰çš„ React é’©å­å¾ˆå®¹æ˜“å˜æˆæœ€å¤§çš„æ€§èƒ½æ€æ‰‹ã€‚

æˆ‘ä¸æ‰“ç®—åœ¨è¿™é‡Œè§£é‡Šå¦‚ä½•æ„å»ºå’Œä½¿ç”¨é’©å­ï¼Œå¦‚æœä½ ä»¥å‰ä»æœªæ„å»ºè¿‡é’©å­ï¼ŒReact æ–‡æ¡£æœ‰ä¸€ä¸ª[å¾ˆå¥½çš„ä»‹ç»](https://reactjs.org/docs/hooks-custom.html)ã€‚ä»Šå¤©æˆ‘æƒ³é‡ç‚¹è®¨è®ºçš„æ˜¯å®ƒä»¬å¯¹å¤æ‚åº”ç”¨ç¨‹åºçš„æ€§èƒ½å½±å“ã€‚

# è®©æˆ‘ä»¬åœ¨è‡ªå®šä¹‰é’©å­ä¸Šæ„å»ºä¸€ä¸ªæ¨¡æ€å¯¹è¯æ¡†

æœ¬è´¨ä¸Šï¼Œé’©å­åªæ˜¯ä¸€äº›é«˜çº§åŠŸèƒ½ï¼Œå…è®¸å¼€å‘äººå‘˜ä½¿ç”¨çŠ¶æ€å’Œä¸Šä¸‹æ–‡ä¹‹ç±»çš„ä¸œè¥¿ï¼Œè€Œæ— éœ€åˆ›å»ºæ–°çš„ç»„ä»¶ã€‚å½“æ‚¨éœ€è¦åœ¨åº”ç”¨ç¨‹åºçš„ä¸åŒéƒ¨åˆ†ä¹‹é—´å…±äº«éœ€è¦çŠ¶æ€çš„ç›¸åŒé€»è¾‘æ—¶ï¼Œå®ƒä»¬éå¸¸æœ‰ç”¨ã€‚éšç€é’©å­çš„å‡ºç°ï¼ŒReact å¼€å‘è¿›å…¥äº†ä¸€ä¸ªæ–°æ—¶ä»£:æˆ‘ä»¬çš„ç»„ä»¶ä»æ¥æ²¡æœ‰åƒé’©å­ä¸€æ ·çº¤ç»†æ•´æ´ï¼Œä¸åŒå…³æ³¨ç‚¹çš„åˆ†ç¦»ä¹Ÿåƒé’©å­ä¸€æ ·å®¹æ˜“å®ç°ã€‚

ä¾‹å¦‚ï¼Œè®©æˆ‘ä»¬å®ç°ä¸€ä¸ªæ¨¡æ€å¯¹è¯æ¡†ã€‚ä½¿ç”¨å®šåˆ¶æŒ‚é’©ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨è¿™é‡Œæ‰“é€ å‡ºä¸€ä»¶ç¾ä¸½çš„ä½œå“ã€‚

é¦–å…ˆï¼Œè®©æˆ‘ä»¬å®ç°ä¸€ä¸ªâ€œåŸºç¡€â€ç»„ä»¶ï¼Œå®ƒæ²¡æœ‰ä»»ä½•çŠ¶æ€ï¼Œåªæ˜¯åœ¨æä¾›äº†`isOpen` prop æ—¶å‘ˆç°å¯¹è¯æ¡†ï¼Œå¹¶åœ¨å•å‡»å¯¹è¯æ¡†ä¸‹é¢çš„æ¯¯å­æ—¶è§¦å‘`onClose`å›è°ƒã€‚

```
*type ModalProps = {
  isOpen: boolean;
  onClosed: () => void;
};

export const ModalBase = ({ isOpen, onClosed }: ModalProps) => {
  return isOpen ? (
    <>
      <div css={modalBlanketCss} onClick={onClosed} />
      <div css={modalBodyCss}>Modal dialog content</div>
    </>
  ) : null;
};*
```

ç°åœ¨è½¬åˆ°çŠ¶æ€ç®¡ç†ï¼Œå³â€œæ‰“å¼€å¯¹è¯/å…³é—­å¯¹è¯â€é€»è¾‘ã€‚åœ¨â€œæ—§â€çš„æ–¹å¼ä¸­ï¼Œæˆ‘ä»¬é€šå¸¸ä¼šå®ç°å®ƒçš„â€œæ™ºèƒ½â€ç‰ˆæœ¬ï¼Œå®ƒå¤„ç†çŠ¶æ€ç®¡ç†å¹¶æ¥å—ä¸€ä¸ªç»„ä»¶ï¼Œè¯¥ç»„ä»¶åº”è¯¥ä½œä¸ºé“å…·è§¦å‘å¯¹è¯æ¡†çš„æ‰“å¼€ã€‚å¤§æ¦‚æ˜¯è¿™æ ·çš„:

```
*export const ModalDialog = ({ trigger }) => {
  const [isOpen, setIsOpen] = useState(false);

  return (
    <>
      <div onClick={() => setIsOpen(true)}>{trigger}</div>
      <ModalBase isOpen={isOpen} onClosed={() => setIsOpen(false)} />
    </>
  );
};*
```

å®ƒä¼šè¢«è¿™æ ·ä½¿ç”¨:

```
*<ModalDialog trigger={<button>Click me</button>} />*
```

è¿™ä¸æ˜¯ä¸€ä¸ªç‰¹åˆ«å¥½çš„è§£å†³æ–¹æ¡ˆï¼Œæˆ‘ä»¬å°†è§¦å‘å™¨ç»„ä»¶åŒ…è£…åœ¨ä¸€ä¸ª div ä¸­ï¼Œä»è€Œæ‰“ä¹±äº†å®ƒåœ¨æ¨¡æ€å¯¹è¯æ¡†ä¸­çš„ä½ç½®å’Œå¯è®¿é—®æ€§ã€‚æ›´ä¸ç”¨è¯´è¿™ä¸ªä¸å¿…è¦çš„ div ä¼šå¯¼è‡´ DOM å˜å¾—æ›´å¤§æ›´ä¹±ã€‚

ç°åœ¨çœ‹é­”æœ¯ã€‚å¦‚æœæˆ‘ä»¬å°†â€œæ‰“å¼€/å…³é—­â€é€»è¾‘æå–åˆ°ä¸€ä¸ªå®šåˆ¶çš„é’©å­ä¸­ï¼Œå°†è¿™ä¸ªç»„ä»¶**å‘ˆç°åœ¨é’©å­**ä¸­ï¼Œå¹¶å…¬å¼€ API æ¥æ§åˆ¶å®ƒä½œä¸ºé’©å­çš„è¿”å›å€¼ï¼Œæˆ‘ä»¬å°±å¯ä»¥ä¸¤å…¨å…¶ç¾äº†ã€‚åœ¨é’©å­ä¸­ï¼Œæˆ‘ä»¬å°†æœ‰ä¸€ä¸ªâ€œæ™ºèƒ½â€å¯¹è¯æ¡†æ¥å¤„ç†å®ƒè‡ªå·±çš„çŠ¶æ€ï¼Œä½†ä¸ä¼šå¹²æ‰°è§¦å‘å™¨ï¼Œä¹Ÿä¸éœ€è¦è§¦å‘å™¨:

```
*const [isOpen, setIsOpen] = useState(false);

  const open = () => setIsOpen(true);
  const close = () => setIsOpen(false);
  const Dialog = () => <ModalBase onClosed={close} isOpen={isOpen} />;

  return { isOpen, Dialog, open, close };
};*
```

åœ¨æ¶ˆè´¹è€…æ–¹é¢ï¼Œæˆ‘ä»¬å°†æ‹¥æœ‰æœ€å°‘çš„ä»£ç ï¼ŒåŒæ—¶å®Œå…¨æ§åˆ¶è§¦å‘å¯¹è¯çš„å†…å®¹:

```
*const ConsumerComponent = () => {
  const { Dialog, open } = useModal();

  return (
    <>
      <button onClick={open}>Click me</button>
      <Dialog />
    </>
  );
};*
```

å¦‚æœè¿™è¿˜ä¸æ˜¯å®Œç¾ï¼Œæˆ‘ä¸çŸ¥é“ä»€ä¹ˆæ˜¯å®Œç¾ï¼ğŸ˜[åœ¨ codesandbox](https://codesandbox.io/s/modal-dialog-example1-9ds2c?file=/src/App.tsx) çœ‹åˆ°è¿™ä¸ªç¾å¥³ã€‚åªæ˜¯ä¸è¦æ€¥ç€é©¬ä¸Šåœ¨ä½ çš„åº”ç”¨ä¸­ä½¿ç”¨å®ƒï¼Œç›´åˆ°ä½ è¯»åˆ°å®ƒçš„é˜´æš—é¢ğŸ˜…

# æ€§èƒ½å½±å“

åœ¨[ä¸Šä¸€ç¯‡æ–‡ç« ](https://www.developerway.com/posts/how-to-write-performant-react-code)ä¸­ï¼Œæˆ‘è¯¦ç»†ä»‹ç»äº†å¯¼è‡´æ€§èƒ½ä¸ä½³çš„å„ç§æ¨¡å¼ï¼Œæˆ‘å®ç°äº†ä¸€ä¸ªâ€œæ…¢â€åº”ç”¨ç¨‹åº:é¡µé¢ä¸Šå‘ˆç°äº†ä¸€ä¸ªç®€å•çš„ã€æœªç»ä¼˜åŒ–çš„å¤§çº¦ 250 ä¸ªå›½å®¶çš„åˆ—è¡¨ã€‚ä½†æ˜¯æ¯ä¸€æ¬¡äº¤äº’éƒ½ä¼šå¯¼è‡´æ•´ä¸ªé¡µé¢è¢«é‡æ–°æ¸²æŸ“ï¼Œè¿™å¯èƒ½æ˜¯æœ€æ…¢çš„ç®€å•åˆ—è¡¨ã€‚[è¿™é‡Œæ˜¯ codesandbox](https://codesandbox.io/s/re-renders-final-bad-4znwe) ï¼Œç‚¹å‡»åˆ—è¡¨ä¸­ä¸åŒçš„å›½å®¶æ¥æ˜ç™½æˆ‘çš„æ„æ€(å¦‚æœä½ åœ¨æœ€æ–°çš„ Mac ä¸Šç¨å¾®è°ƒèŠ‚ä¸€ä¸‹ä½ çš„ CPU æ¥è·å¾—æ›´å¥½çš„å°è±¡)ã€‚

> **å¦‚ä½•èŠ‚æµ CPU** :åœ¨ Chrome å¼€å‘è€…å·¥å…·ä¸­æ‰“å¼€â€œæ€§èƒ½â€æ ‡ç­¾ï¼Œç‚¹å‡»å³ä¸Šè§’çš„â€œé½¿è½®â€å›¾æ ‡â€”â€”ä¼šæ‰“å¼€ä¸€ä¸ªé™„åŠ çš„å°é¢æ¿ï¼Œé‡Œé¢æœ‰èŠ‚æµé€‰é¡¹ã€‚

æˆ‘å°†åœ¨é‚£é‡Œä½¿ç”¨æˆ‘ä»¬æ–°çš„å®Œç¾æ¨¡æ€å¯¹è¯æ¡†ï¼Œçœ‹çœ‹ä¼šå‘ç”Ÿä»€ä¹ˆã€‚ä¸»`Page`ç»„ä»¶çš„ä»£ç ç›¸å¯¹ç®€å•ï¼Œå¦‚ä¸‹æ‰€ç¤º:

```
*export const Page = ({ countries }: { countries: Country[] }) => {
  const [selectedCountry, setSelectedCountry] = useState<Country>(countries[0]);
  const [savedCountry, setSavedCountry] = useState<Country>(countries[0]);
  const [mode, setMode] = useState<Mode>('light');

  return (
    <ThemeProvider value={{ mode }}>
      <h1>Country settings</h1>
      <button onClick={() => setMode(mode === 'light' ? 'dark' : 'light')}>Toggle theme</button>
      <div className="content">
        <CountriesList countries={countries} onCountryChanged={(c) => setSelectedCountry(c)} savedCountry={savedCountry} />
        <SelectedCountry country={selectedCountry} onCountrySaved={() => setSavedCountry(selectedCountry)} />
      </div>
    </ThemeProvider>
  );
};*
```

ç°åœ¨ï¼Œæˆ‘éœ€è¦ä¸€ä¸ªé è¿‘â€œåˆ‡æ¢ä¸»é¢˜â€æŒ‰é’®çš„æŒ‰é’®ï¼Œè¯¥æŒ‰é’®å°†æ‰“å¼€ä¸€ä¸ªæ¨¡å¼å¯¹è¯æ¡†ï¼Œå…¶ä¸­åŒ…å«è¯¥é¡µé¢çš„ä¸€äº›æœªæ¥é™„åŠ è®¾ç½®ã€‚å¹¸è¿çš„æ˜¯ï¼Œç°åœ¨å·²ç»ç®€å•å¾—ä¸èƒ½å†ç®€å•äº†:åœ¨é¡¶éƒ¨æ·»åŠ `useModal`é’©å­ï¼Œåœ¨éœ€è¦çš„åœ°æ–¹æ·»åŠ æŒ‰é’®ï¼Œå¹¶å°†`open`å›è°ƒä¼ é€’ç»™æŒ‰é’®ã€‚`Page`ç»„ä»¶å‡ ä¹æ²¡æœ‰å˜åŒ–ï¼Œä»ç„¶éå¸¸ç®€å•:

![](img/fe5d6d80e3b6d949849f3b54f9ec2074.png)

ä½ å¯èƒ½å·²ç»çŒœåˆ°äº†ç»“æœğŸ™‚æœ‰å²ä»¥æ¥æœ€æ…¢çš„ä¸¤ä¸ªç©º div å‡ºç°ğŸ˜±ã€‚[å‚è§ codesandboxã€‚](https://codesandbox.io/s/re-renders-bad-with-dialog-6egnq?file=/src/country-settings/page.tsx)

ä½ çœ‹ï¼Œè¿™é‡Œæ‰€å‘ç”Ÿçš„ï¼Œå°±æ˜¯æˆ‘ä»¬çš„`useModal`é’©ä½¿ç”¨çŠ¶æ€ã€‚æ­£å¦‚æˆ‘ä»¬æ‰€çŸ¥ï¼ŒçŠ¶æ€å˜åŒ–æ˜¯ç»„ä»¶é‡æ–°å‘ˆç°è‡ªèº«çš„åŸå› ä¹‹ä¸€ã€‚è¿™ä¹Ÿé€‚ç”¨äºé’©å­â€”â€”å¦‚æœé’©å­çš„çŠ¶æ€æ”¹å˜,â€œä¸»æœºâ€ç»„ä»¶å°†é‡æ–°å‘ˆç°ã€‚è¿™å®Œå…¨è¯´å¾—é€šã€‚å¦‚æœæˆ‘ä»¬ä»”ç»†è§‚å¯Ÿ`useModal`é’©å­å†…éƒ¨ï¼Œæˆ‘ä»¬ä¼šå‘ç°å®ƒåªæ˜¯å›´ç»•`setState`çš„ä¸€ä¸ªå¾ˆå¥½çš„æŠ½è±¡ï¼Œå®ƒå­˜åœ¨äº`Dialog`ç»„ä»¶çš„ä¹‹å¤–çš„**ã€‚æœ¬è´¨ä¸Šï¼Œè¿™ä¸ç›´æ¥è°ƒç”¨`Page`ç»„ä»¶ä¸­çš„`setState`æ²¡æœ‰ä»€ä¹ˆä¸åŒã€‚**

è¿™å°±æ˜¯é’©å­çš„æœ€å¤§å±é™©:æ˜¯çš„ï¼Œå®ƒä»¬å¸®åŠ©æˆ‘ä»¬ä½¿ API å˜å¾—éå¸¸å¥½ã€‚ä½†æ˜¯æˆ‘ä»¬æ‰€åšçš„ç»“æœæ˜¯ï¼Œé’©å­çš„æ–¹å¼éå¸¸é¼“åŠ±å®ƒï¼Œæœ¬è´¨ä¸Šæ˜¯ä»å®ƒåº”è¯¥åœ¨çš„åœ°æ–¹**æå‡çŠ¶æ€ã€‚é™¤éä½ æ·±å…¥åˆ°`useModal`å®ç°å†…éƒ¨ï¼Œæˆ–è€…å¯¹é’©å­å’Œé‡æ–°æ¸²æŸ“æœ‰ä¸°å¯Œçš„ç»éªŒï¼Œå¦åˆ™è¿™æ˜¯å®Œå…¨ä¸æ˜æ˜¾çš„ã€‚æˆ‘ç”šè‡³æ²¡æœ‰åœ¨`Page`ç»„ä»¶ä¸­ç›´æ¥ä½¿ç”¨çŠ¶æ€ï¼Œä»å®ƒçš„è§’åº¦æ¥çœ‹ï¼Œæˆ‘æ‰€åšçš„åªæ˜¯æ¸²æŸ“ä¸€ä¸ª`Dialog`ç»„ä»¶ï¼Œå¹¶è°ƒç”¨ä¸€ä¸ªå‘½ä»¤å¼ API æ¥æ‰“å¼€å®ƒã€‚**

åœ¨â€œæ—§ä¸–ç•Œâ€ä¸­ï¼ŒçŠ¶æ€ä¼šè¢«å°è£…åœ¨å¸¦æœ‰`trigger`é“å…·çš„ç•¥æ˜¾ä¸‘é™‹çš„`Modal`å¯¹è¯æ¡†ä¸­ï¼Œå½“æŒ‰é’®è¢«ç‚¹å‡»æ—¶`Page`ç»„ä»¶ä¼šä¿æŒå®Œæ•´ã€‚ç°åœ¨ç‚¹å‡»æŒ‰é’®æ”¹å˜äº†æ•´ä¸ªé¡µé¢ç»„ä»¶**çš„çŠ¶æ€**ï¼Œå¯¼è‡´å…¶é‡æ–°æ¸²æŸ“(è¿™å¯¹äºè¿™ä¸ªåº”ç”¨ç¨‹åºæ¥è¯´è¶…çº§æ…¢)ã€‚åªæœ‰åœ¨ React å®Œæˆäº†æ‰€æœ‰é‡æ–°æ¸²æŸ“åï¼Œå¯¹è¯æ¡†æ‰ä¼šå‡ºç°ï¼Œå› æ­¤ä¼šæœ‰å¾ˆå¤§çš„å»¶è¿Ÿã€‚

![](img/7f411a1ea86d5194fe6a381545734ae1.png)

é‚£ä¹ˆï¼Œæˆ‘ä»¬èƒ½åšäº›ä»€ä¹ˆå‘¢ï¼Ÿæˆ‘ä»¬å¯èƒ½æ²¡æœ‰æ—¶é—´å’Œèµ„æºæ¥ä¿®å¤`Page`ç»„ä»¶çš„åº•å±‚æ€§èƒ½ï¼Œå› ä¸ºè¿™é€šå¸¸ä¼šå‘ç”Ÿåœ¨â€œçœŸæ­£çš„â€åº”ç”¨ç¨‹åºä¸Šã€‚ä½†è‡³å°‘æˆ‘ä»¬å¯ä»¥ç¡®ä¿è¿™ä¸ªæ–°ç‰¹æ€§ä¸ä¼šå¢åŠ æ€§èƒ½é—®é¢˜ï¼Œè€Œä¸”å®ƒæœ¬èº«å¾ˆå¿«ã€‚è¿™é‡Œæˆ‘ä»¬éœ€è¦åšçš„åªæ˜¯å°†æ¨¡æ€çŠ¶æ€â€œä¸‹ç§»â€ï¼Œè¿œç¦»ç¼“æ…¢çš„`Page`ç»„ä»¶:

```
*const SettingsButton = () => {
  const { Dialog, open } = useModal();

  return (
    <>
      <button onClick={open}>Open settings</button>
      <Dialog />
    </>
  );
};*
```

è€Œåœ¨`Page`ä¸­åªæ˜¯æ¸²æŸ“äº†`SettingsButton`:

```
*export const Page = ({ countries }: { countries: Country[] }) => {
  // same as original page state
  return (
    <ThemeProvider value={{ mode }}>
      // stays the same
      <SettingsButton />
      // stays the same
    </ThemeProvider>
  );
};*
```

ç°åœ¨ï¼Œå½“ç‚¹å‡»æŒ‰é’®æ—¶ï¼Œåªæœ‰`SettingsButton`ç»„ä»¶ä¼šé‡æ–°æ¸²æŸ“ï¼Œæ…¢é€Ÿçš„`Page`ç»„ä»¶ä¸å—å½±å“ã€‚æœ¬è´¨ä¸Šï¼Œæˆ‘ä»¬åœ¨æ¨¡ä»¿çŠ¶æ€æ¨¡å‹ï¼Œå°±åƒå®ƒåœ¨â€œæ—§â€ä¸–ç•Œä¸­ä¸€æ ·ï¼ŒåŒæ—¶ä¿ç•™äº†åŸºäºé’©å­çš„ APIã€‚å‚è§ [codesandbox](https://codesandbox.io/s/re-renders-bad-with-dialog-fixed-rrfey?file=/src/country-settings/page.tsx) ä¸­çš„è§£å†³æ–¹æ¡ˆã€‚

![](img/f2d16bc7e334ecf773e8020322848ca4.png)

# ä¸º`useModal`æŒ‚é’©å¢åŠ æ›´å¤šåŠŸèƒ½

è®©æˆ‘ä»¬çš„é’©å­æ€§èƒ½å¯¹è¯ç¨å¾®æš—ä¸€ç‚¹ğŸ™‚ã€‚ä¾‹å¦‚ï¼Œå‡è®¾æ‚¨éœ€è¦è·Ÿè¸ªæ¨¡å¼å†…å®¹ä¸­çš„æ»šåŠ¨äº‹ä»¶ã€‚ä¹Ÿè®¸ä½ æƒ³åœ¨ç”¨æˆ·æ»šåŠ¨æ–‡æœ¬æ—¶å‘é€ä¸€äº›åˆ†æäº‹ä»¶æ¥è·Ÿè¸ªé˜…è¯»ã€‚å¦‚æœæˆ‘ä¸æƒ³åœ¨`BaseModal`ä¸­å¼•å…¥â€œæ™ºèƒ½â€åŠŸèƒ½ï¼Œè€Œæ˜¯åœ¨`useModal`é’©å­ä¸­å®ç°ï¼Œä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ

ç›¸å¯¹å®¹æ˜“å®ç°ã€‚æˆ‘ä»¬å¯ä»¥åœ¨é‚£é‡Œå¼•å…¥ä¸€ä¸ªæ–°çš„çŠ¶æ€æ¥è·Ÿè¸ªæ»šåŠ¨ä½ç½®ï¼Œåœ¨`useEffect`é’©å­ä¸­æ·»åŠ äº‹ä»¶ä¾¦å¬å™¨ï¼Œå¹¶å°† ref ä¼ é€’ç»™`BaseModal`ä»¥è·å–å†…å®¹å…ƒç´ æ¥é™„åŠ ä¾¦å¬å™¨ã€‚å¤§æ¦‚æ˜¯è¿™æ ·çš„:

```
*export const ModalBase = React.forwardRef(({ isOpen, onClosed }: ModalProps, ref: RefObject<any>) => {
  return isOpen ? (
    <>
      <div css={modalBlanketCss} onClick={onClosed} />
      <div css={modalBodyCss} ref={ref}>
        // add a lot of content here
      </div>
    </>
  ) : null;
});

export const useModal = () => {
  const [isOpen, setIsOpen] = useState(false);
  const ref = useRef<HTMLElement>(null);
  const [scroll, setScroll] = useState(0);

  // same as before

  useEffect(() => {
    const element = ref.current;
    if (!element) return;

    const handleScroll = () => {
      setScroll(element?.scrollTop || 0);
    };

    element.addEventListener('scroll', handleScroll);
    return () => {
      element.removeEventListener('scroll', handleScroll);
    };
  });

  const Dialog = () => <ModalBase onClosed={close} isOpen={isOpen} ref={ref} />;

  return {
    isOpen,
    Dialog,
    open,
    close,
  };
};*
```

ç°åœ¨æˆ‘ä»¬å¯ä»¥å¯¹è¿™ä¸ªçŠ¶æ€åšä»»ä½•äº‹æƒ…ã€‚ç°åœ¨è®©æˆ‘ä»¬å‡è®¾å‰é¢çš„æ€§èƒ½é—®é¢˜ä¸æ˜¯ä»€ä¹ˆå¤§é—®é¢˜ï¼Œå¹¶å†æ¬¡åœ¨æ…¢é€Ÿé¡µé¢ç»„ä»¶ä¸­ç›´æ¥ä½¿ç”¨è¿™ä¸ªé’©å­ã€‚[å‚è§ codesandbox](https://codesandbox.io/s/re-renders-bad-with-dialog-with-scroll-p9wi8?file=/src/country-settings/page.tsx) ã€‚

æ»šåŠ¨ç”šè‡³ä¸èƒ½æ­£å¸¸å·¥ä½œï¼ğŸ˜±æ¯æ¬¡æˆ‘è¯•å›¾æ»šåŠ¨å¯¹è¯æ¡†å†…å®¹æ—¶ï¼Œå®ƒéƒ½ä¼šé‡ç½®åˆ°é¡¶éƒ¨ï¼

å¥½å§ï¼Œæˆ‘ä»¬æ¥é€»è¾‘æ€è€ƒä¸€ä¸‹ã€‚[æˆ‘ä»¬å·²ç»çŸ¥é“](https://www.developerway.com/posts/how-to-write-performant-react-code)ï¼Œåœ¨æ¸²æŸ“å‡½æ•°ä¸­åˆ›å»ºç»„ä»¶æ˜¯é‚ªæ¶çš„ï¼Œå› ä¸º React ä¼šåœ¨æ¯æ¬¡é‡æ–°æ¸²æŸ“æ—¶é‡æ–°åˆ›å»ºå’ŒæŒ‚è½½å®ƒä»¬ã€‚æˆ‘ä»¬çŸ¥é“é’©å­ä¼šéšç€çŠ¶æ€çš„æ”¹å˜è€Œæ”¹å˜ã€‚è¿™æ„å‘³ç€ç°åœ¨ï¼Œå½“æˆ‘ä»¬å¼•å…¥æ»šåŠ¨çŠ¶æ€æ—¶ï¼Œæ¯æ¬¡æ»šåŠ¨æ”¹å˜æˆ‘ä»¬éƒ½åœ¨æ”¹å˜çŠ¶æ€ï¼Œè¿™å¯¼è‡´é’©å­é‡æ–°å‘ˆç°ï¼Œè¿™å¯¼è‡´`Dialog`ç»„ä»¶é‡æ–°åˆ›å»ºè‡ªå·±ã€‚å®Œå…¨ç›¸åŒçš„é—®é¢˜ï¼Œå°±åƒåœ¨æ¸²æŸ“å‡½æ•°ä¸­åˆ›å»ºç»„ä»¶ä¸€æ ·ï¼Œæœ‰å®Œå…¨ç›¸åŒçš„è§£å†³æ–¹æ³•:æˆ‘ä»¬éœ€è¦å°†è¿™ä¸ªç»„ä»¶æå–åˆ°é’©å­ä¹‹å¤–ï¼Œæˆ–è€…åªæ˜¯å°†å®ƒå±è”½æ‰ã€‚

```
*const Dialog = useMemo(() => {
  return () => <ModalBase onClosed={close} isOpen={isOpen} ref={ref} />;
}, [isOpen]);*
```

ç„¦ç‚¹è¡Œä¸ºæ˜¯å›ºå®šçš„ï¼Œä½†è¿™é‡Œæœ‰å¦ä¸€ä¸ªé—®é¢˜:ç¼“æ…¢çš„`Page`ç»„ä»¶åœ¨æ¯æ¬¡æ»šåŠ¨æ—¶é‡æ–°æ¸²æŸ“ï¼è¿™ä¸€ç‚¹å¾ˆéš¾æ³¨æ„åˆ°ï¼Œå› ä¸ºå¯¹è¯å†…å®¹åªæ˜¯æ–‡æœ¬ã€‚ä¾‹å¦‚ï¼Œå°è¯•å°† CPU é™ä½ 6 å€ï¼Œæ»šåŠ¨ï¼Œç„¶åç«‹å³é«˜äº®æ˜¾ç¤ºå¯¹è¯æ¡†ä¸­çš„æ–‡æœ¬ã€‚æµè§ˆå™¨ç”šè‡³ä¸å…è®¸è¿™æ ·åšï¼Œå› ä¸ºå®ƒå¿™äºé‡æ–°æ¸²æŸ“ä¸‹é¢çš„`Page`ç»„ä»¶ï¼[å‚è§ codesandboxã€‚](https://codesandbox.io/s/re-renders-bad-with-dialog-with-scroll-fixed-scroll-0s5g3?file=/src/country-settings/page.tsx)æ»šåŠ¨å‡ ä¸‹åï¼Œä½ çš„ç¬”è®°æœ¬ç”µè„‘å¯èƒ½ä¼šå› ä¸º 100%çš„ CPU è´Ÿè½½è€Œè¯•å›¾é£å‘æœˆçƒğŸ˜…

æ˜¯çš„ï¼Œæˆ‘ä»¬è‚¯å®šéœ€è¦åœ¨å‘å¸ƒåˆ°ç”Ÿäº§ä¹‹å‰è§£å†³è¿™ä¸ªé—®é¢˜ã€‚è®©æˆ‘ä»¬å†æ¥çœ‹çœ‹æˆ‘ä»¬çš„ç»„ä»¶ï¼Œå°¤å…¶æ˜¯è¿™ä¸€éƒ¨åˆ†:

```
*return {
  isOpen,
  Dialog,
  open,
  close,
};*
```

æˆ‘ä»¬åœ¨æ¯æ¬¡é‡æ–°æ¸²æŸ“æ—¶éƒ½è¿”å›ä¸€ä¸ªæ–°çš„å¯¹è±¡ï¼Œå› ä¸ºæˆ‘ä»¬ç°åœ¨åœ¨æ¯æ¬¡æ»šåŠ¨æ—¶éƒ½é‡æ–°æ¸²æŸ“æˆ‘ä»¬çš„é’©å­ï¼Œè¿™æ„å‘³ç€å¯¹è±¡åœ¨æ¯æ¬¡æ»šåŠ¨æ—¶éƒ½ä¼šæ”¹å˜ã€‚ä½†æ˜¯æˆ‘ä»¬åœ¨è¿™é‡Œæ²¡æœ‰ä½¿ç”¨æ»šåŠ¨çŠ¶æ€ï¼Œå®ƒå®Œå…¨æ˜¯åœ¨`useModal`é’©å­å†…éƒ¨ä½¿ç”¨çš„ã€‚éš¾é“ä»…ä»…è®°ä½é‚£ä¸ªç‰©ä½“å°±èƒ½è§£å†³é—®é¢˜å—ï¼Ÿ

```
*return useMemo(
  () => ({
    isOpen,
    Dialog,
    open,
    close,
  }),
  [isOpen, Dialog],
);*
```

ä½ çŸ¥é“è¿™æœ€ç²¾å½©(æˆ–æœ€ææ€–)çš„éƒ¨åˆ†å—ï¼Ÿå®ƒæ²¡æœ‰ï¼ğŸ˜±[å‚è§ codesandbox](https://codesandbox.io/s/re-renders-bad-with-dialog-with-scroll-fixed-scroll-and-memo-35lqx?file=/src/country-settings/modal-dialog.tsx) ã€‚

è¿™æ˜¯å¦ä¸€ä¸ªä¸é’©å­æœ‰å…³çš„å·¨å¤§çš„æ€§èƒ½é—®é¢˜ã€‚äº‹å®è¯æ˜ï¼Œé’©å­ä¸­çš„çŠ¶æ€å˜åŒ–æ˜¯ä¸æ˜¯â€œå†…éƒ¨çš„â€å¹¶ä¸é‡è¦ã€‚**é’©å­çš„æ¯ä¸€æ¬¡çŠ¶æ€å˜åŒ–ï¼Œæ— è®ºæ˜¯å¦å½±å“å…¶è¿”å›å€¼ï¼Œéƒ½ä¼šå¯¼è‡´â€œå®¿ä¸»â€ç»„ä»¶é‡æ–°æ¸²æŸ“ã€‚**

å½“ç„¶ï¼Œé“¾æ¥é’©å­çš„æƒ…å†µå®Œå…¨ç›¸åŒ:å¦‚æœé’©å­çš„çŠ¶æ€å‘ç”Ÿå˜åŒ–ï¼Œå®ƒå°†å¯¼è‡´å®ƒçš„â€œä¸»æœºâ€é’©å­ä¹Ÿå‘ç”Ÿå˜åŒ–ï¼Œè¿™å°†é€šè¿‡æ•´ä¸ªé’©å­é“¾å‘ä¸Šä¼ æ’­ï¼Œç›´åˆ°å®ƒåˆ°è¾¾â€œä¸»æœºâ€ç»„ä»¶å¹¶é‡æ–°æ¸²æŸ“å®ƒ(è¿™å°†å¯¼è‡´é‡æ–°æ¸²æŸ“çš„å¦ä¸€ä¸ªè¿é”ååº”ï¼Œç°åœ¨åªåœ¨ä¸‹æ¸¸)ï¼Œ**è€Œä¸ç®¡ä¸­é—´åº”ç”¨çš„ä»»ä½•è®°å¿†**ã€‚

å°†â€œæ»šåŠ¨â€åŠŸèƒ½æå–åˆ°ä¸€ä¸ªé’©å­ä¸­ç»å¯¹æ²¡æœ‰ä»»ä½•åŒºåˆ«ï¼Œç¼“æ…¢çš„é¡µé¢ç»„ä»¶å°†é‡æ–°å‘ˆç°ğŸ˜”ã€‚

```
*const useScroll = (ref: RefObject) => {
  const [scroll, setScroll] = useState(0);

  useEffect(() => {
    const element = ref.current;
    if (!element) return;

    const handleScroll = () => {
      setScroll(element?.scrollTop || 0);
    };

    element.addEventListener('scroll', handleScroll);
    return () => {
      element.removeEventListener('scroll', handleScroll);
    };
  });

  return scroll;
};

export const useModal = () => {
  const [isOpen, setIsOpen] = useState(false);
  const ref = useRef<HTMLElement>(null);
  const scroll = useScroll(ref);

  const open = useCallback(() => {
    setIsOpen(true);
  }, []);

  const close = useCallback(() => {
    setIsOpen(false);
  }, []);

  const Dialog = useMemo(() => {
    return () => <ModalBase onClosed={close} isOpen={isOpen} ref={ref} />;
  }, [isOpen, close]);

  return useMemo(
    () => ({
      isOpen,
      Dialog,
      open,
      close,
    }),
    [isOpen, Dialog, open, close],
  );
};*
```

[å‚è§ codesandbox](https://codesandbox.io/s/re-renders-bad-with-dialog-with-scroll-extracted-woeer?file=/src/country-settings/modal-dialog.tsx) ã€‚

æ€ä¹ˆä¿®ï¼Ÿå¥½å§ï¼Œè¿™é‡Œå”¯ä¸€è¦åšçš„å°±æ˜¯å°†æ»šåŠ¨è·Ÿè¸ªé’©å­ç§»åˆ°`useModal`é’©å­ä¹‹å¤–ï¼Œå¹¶åœ¨ä¸ä¼šå¯¼è‡´é‡æ¸²æŸ“é“¾çš„åœ°æ–¹ä½¿ç”¨å®ƒã€‚å¯ä»¥ä»‹ç»`ModalBaseWithAnalytics`ç»„ä»¶ä¸ºä¾‹:

```
*const ModalBaseWithAnalytics = (props: ModalProps) => {
  const ref = useRef<HTMLElement>(null);
  const scroll = useScroll(ref);

  console.log(scroll);

  return <ModalBase {...props} ref={ref} />;
};*
```

ç„¶åç”¨åœ¨`useModal`é’©ä¸Šä»£æ›¿`ModalBase`:

```
*export const useModal = () => {
  // the rest is the same as in the original useModal hook

  const Dialog = useMemo(() => {
    return () => <ModalBaseWithAnalytics onClosed={close} isOpen={isOpen} ref={ref} />;
  }, [isOpen, close]);

  return useMemo(
    () => ({
      isOpen,
      Dialog,
      open,
      close,
    }),
    [isOpen, Dialog, open, close],
  );
};*
```

ç°åœ¨ï¼Œæ»šåŠ¨å¯¼è‡´çš„çŠ¶æ€å˜åŒ–å°†å±€é™äº`ModalBaseWithAnalytics`ç»„ä»¶ï¼Œä¸ä¼šå½±å“æ…¢é€Ÿçš„`Page`ç»„ä»¶ã€‚[å‚è§ codesandboxã€‚](https://codesandbox.io/s/re-renders-bad-with-dialog-scroll-fixed-for-good-v6ohp?file=/src/country-settings/modal-dialog.tsx)

ä»Šå¤©åˆ°æ­¤ä¸ºæ­¢ï¼å¸Œæœ›è¿™ç¯‡æ–‡ç« è¶³å¤Ÿè®©ä½ å®³æ€•ï¼Œå¸®åŠ©ä½ æ›´å¥½åœ°ç†è§£å®šåˆ¶é’©å­ï¼Œä»¥åŠå¦‚ä½•åœ¨ä¸å½±å“åº”ç”¨ç¨‹åºæ€§èƒ½çš„æƒ…å†µä¸‹ç¼–å†™å’Œä½¿ç”¨å®ƒä»¬ã€‚åœ¨ç¦»å¼€ä¹‹å‰ï¼Œè®©æˆ‘ä»¬å›é¡¾ä¸€ä¸‹æ€§èƒ½æŒ‚é’©çš„è§„åˆ™:

*   é’©å­ä¸­çš„æ¯ä¸€ä¸ªçŠ¶æ€å˜åŒ–éƒ½ä¼šå¯¼è‡´å®ƒçš„â€œä¸»æœºâ€ç»„ä»¶é‡æ–°å‘ˆç°ï¼Œä¸ç®¡è¿™ä¸ªçŠ¶æ€æ˜¯å¦åœ¨é’©å­å€¼ä¸­è¿”å›ï¼Œæ˜¯å¦è¢« memoised
*   ä¸é“¾å¼æŒ‚é’©ç›¸åŒï¼ŒæŒ‚é’©ä¸­çš„æ¯ä¸ªçŠ¶æ€å˜åŒ–éƒ½ä¼šå¯¼è‡´æ‰€æœ‰â€œçˆ¶â€æŒ‚é’©å‘ç”Ÿå˜åŒ–ï¼Œç›´åˆ°å®ƒåˆ°è¾¾â€œä¸»æœºâ€ç»„ä»¶ï¼Œè¿™å°†å†æ¬¡è§¦å‘é‡æ–°æ¸²æŸ“

ä»¥åŠåœ¨ç¼–å†™æˆ–ä½¿ç”¨å®šåˆ¶é’©å­æ—¶éœ€è¦æ³¨æ„çš„äº‹é¡¹:

*   å½“ä½¿ç”¨ä¸€ä¸ªå®šåˆ¶é’©å­æ—¶ï¼Œç¡®ä¿è¿™ä¸ªé’©å­å°è£…çš„çŠ¶æ€æ²¡æœ‰åœ¨ç»„ä»¶æ–¹æ³•ä¸­æ²¡æœ‰ä½¿ç”¨çš„çº§åˆ«ä¸Šä½¿ç”¨ã€‚å¦‚æœ‰å¿…è¦ï¼Œå°†å…¶â€œå‘ä¸‹â€ç§»åŠ¨åˆ°ä¸€ä¸ªè¾ƒå°çš„ç»„ä»¶
*   æ°¸è¿œä¸è¦åœ¨é’©å­ä¸­å®ç°â€œç‹¬ç«‹â€çŠ¶æ€ï¼Œä¹Ÿä¸è¦åœ¨ç‹¬ç«‹çŠ¶æ€ä¸‹ä½¿ç”¨é’©å­
*   å½“ä½¿ç”¨è‡ªå®šä¹‰é’©å­æ—¶ï¼Œç¡®ä¿å®ƒä¸ä¼šæ‰§è¡Œä¸€äº›ç‹¬ç«‹çš„çŠ¶æ€æ“ä½œï¼Œè¿™äº›æ“ä½œä¸ä¼šåœ¨å…¶è¿”å›å€¼ä¸­å…¬å¼€
*   å½“ä½¿ç”¨ä¸€ä¸ªè‡ªå®šä¹‰é’©å­æ—¶ï¼Œç¡®ä¿å®ƒä½¿ç”¨çš„æ‰€æœ‰é’©å­éƒ½éµå¾ªä¸Šé¢çš„è§„åˆ™

ä¿æŒå®‰å…¨ï¼Œå¹¶å¸Œæœ›æ‚¨çš„åº”ç”¨ç¨‹åºä»ç°åœ¨å¼€å§‹å¿«é€Ÿè¿è¡Œï¼âœŒğŸ¼

*æœ€åˆå‘è¡¨äº*[*ã€https://www.developerway.comã€‘*](https://www.developerway.com)*ã€‚ç½‘ç«™ä¸Šæœ‰æ›´å¤šè¿™æ ·çš„æ–‡ç« *ğŸ˜‰

[*è®¢é˜…ç®€è®¯*](https://www.developerway.com/) ã€[*åœ¨ LinkedIn*](https://www.linkedin.com/in/adevnadia/) *æˆ–* [*ä¸Šå…³æ³¨ Twitter*](https://twitter.com/adevnadia) *ä»¥ä¾¿åœ¨ä¸‹ä¸€ç¯‡æ–‡ç« å‡ºæ¥æ—¶ç«‹å³è·å¾—é€šçŸ¥ã€‚*

*æ›´å¤šå†…å®¹è¯·çœ‹*[***plain English . io***](http://plainenglish.io/)*ã€‚æŠ¥åå‚åŠ æˆ‘ä»¬çš„* [***å…è´¹å‘¨æŠ¥***](http://newsletter.plainenglish.io/) *ã€‚åœ¨æˆ‘ä»¬çš„* [***ç¤¾åŒºä¸å’Œè°***](https://discord.gg/GtDtUAvyhW) *è·å–ç‹¬å®¶å†™ä½œæœºä¼šå’Œå»ºè®®ã€‚*