<html>
<head>
<title>Next.js Middleware: How it Works and 5 Real Use Cases</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Next.js中间件:工作原理和5个真实用例</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/next-js-middleware-how-it-works-and-5-real-use-cases-cfacbeb810c9?source=collection_archive---------1-----------------------#2022-09-05">https://javascript.plainenglish.io/next-js-middleware-how-it-works-and-5-real-use-cases-cfacbeb810c9?source=collection_archive---------1-----------------------#2022-09-05</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/630ca4cfbe4fda061e44c30abf2c2213.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0HEqKJNQO9vztIUWe5FJYQ.jpeg"/></div></div></figure><h1 id="d10f" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">Next.js中的中间件是什么？</h1><p id="e849" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">从v . 12 . 0 . 0(12 . 2 . 0起稳定)开始，Next.js增加了中间件。中间件(和许多其他框架一样)是一种在用户请求到达实际页面之前拦截用户请求的方法。简单地说，它是位于服务器和前端之间的一段代码。中间件在用户发出每个请求之前运行(但它可以被过滤以在特定页面上工作)，可以从用户请求中读取数据，执行函数管道并返回给客户端。</p><h1 id="8fd4" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">中间件如何在Next.js中工作</h1><p id="1638" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">将一个<code class="fe lu lv lw lx b"><strong class="ky ir">middleware.ts</strong></code>文件(它将导出一个名为function的中间件)放在你的项目的每个页面的根目录下，你的站点的API将在到达页面之前执行中间件管道。下面是最基本的中间件，它简单地记录用户请求(因此您可以看到请求是由什么组成的)，不做任何其他事情，并返回页面(使用<code class="fe lu lv lw lx b"><strong class="ky ir">NextResponse.next()</strong></code>):</p><figure class="ly lz ma mb gt jr"><div class="bz fp l di"><div class="mc md l"/></div></figure><p id="2a3a" class="pw-post-body-paragraph kw kx iq ky b kz me lb lc ld mf lf lg lh mg lj lk ll mh ln lo lp mi lr ls lt ij bi translated">除了使用<code class="fe lu lv lw lx b"><strong class="ky ir">next()</strong></code>返回页面，NextResponse还可以设置和获取cookies，设置标题，并将请求重定向或重写到另一个URL。</p><p id="b051" class="pw-post-body-paragraph kw kx iq ky b kz me lb lc ld mf lf lg lh mg lj lk ll mh ln lo lp mi lr ls lt ij bi translated">此外，基于在请求<br/>中找到的<em class="mj">路径名</em>使用匹配器或条件语句，中间件只能在特定页面上运行。由于中间件在将页面发送给用户之前运行，它不会影响页面的呈现方式，因此它可以与CSR、SSR、SSG、ISR一起工作。</p><p id="27a1" class="pw-post-body-paragraph kw kx iq ky b kz me lb lc ld mf lf lg lh mg lj lk ll mh ln lo lp mi lr ls lt ij bi translated">通过中间件利用请求将允许我们在没有页面中的服务器端代码的情况下操作响应。</p><blockquote class="mk ml mm"><p id="7fc6" class="kw kx mj ky b kz me lb lc ld mf lf lg mn mg lj lk mo mh ln lo mp mi lr ls lt ij bi translated">如果你想学习更多关于中间件的知识，你可以阅读Next.js文档</p></blockquote><div class="mq mr gp gr ms mt"><a href="https://nextjs.org/docs/advanced-features/middleware" rel="noopener  ugc nofollow" target="_blank"><div class="mu ab fo"><div class="mv ab mw cl cj mx"><h2 class="bd ir gy z fp my fr fs mz fu fw ip bi translated">高级特性:中间件| Next.js</h2><div class="na l"><h3 class="bd b gy z fp my fr fs mz fu fw dk translated">中间件允许您在请求完成之前运行代码，然后基于传入的请求，您可以修改…</h3></div><div class="nb l"><p class="bd b dl z fp my fr fs mz fu fw dk translated">nextjs.org</p></div></div><div class="nc l"><div class="nd l ne nf ng nc nh jw mt"/></div></div></a></div><h1 id="2ea7" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">重定向和重写</h1><p id="2993" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">有时候你改变了一个页面的URL或者(甚至更糟)一个网站部分的完整结构，但是你不想失去你获得的SEO分数。大多数指南会告诉你，你需要重定向你的旧网址到新的。通过将所有匹配模式重定向到其他地方，您可以很容易地用中间件实现它。例如，您可能想从像<code class="fe lu lv lw lx b"><strong class="ky ir">/blog/date/post</strong></code>这样的结构转移到像<code class="fe lu lv lw lx b"><strong class="ky ir">/content/post</strong></code>这样的结构。新结构就绪后，使用中间件执行重定向:</p><figure class="ly lz ma mb gt jr"><div class="bz fp l di"><div class="mc md l"/></div></figure><p id="1243" class="pw-post-body-paragraph kw kx iq ky b kz me lb lc ld mf lf lg lh mg lj lk ll mh ln lo lp mi lr ls lt ij bi translated">另一种情况是重写内容(保留URL，但显示不同的页面)。例如，您有一个餐馆网站，其中有一个页面(姑且称之为/about)显示开业日期和时间。在很短的一段时间内，你的时间表发生了变化，你不想编辑你的“关于”页面，但你也不想更改它的地址。使用临时数据创建一个新页面/about-temp，并使用中间件将/about页面重写为/about-temp:</p><figure class="ly lz ma mb gt jr"><div class="bz fp l di"><div class="mc md l"/></div></figure><blockquote class="mk ml mm"><p id="8690" class="kw kx mj ky b kz me lb lc ld mf lf lg mn mg lj lk mo mh ln lo mp mi lr ls lt ij bi translated">我们使用<code class="fe lu lv lw lx b">clone()</code>来保持querystring和其他url部分不变</p></blockquote><h1 id="4b94" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">证明</h1><p id="00ce" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">从基本用户/密码，以这种方式使用401状态:</p><figure class="ly lz ma mb gt jr"><div class="bz fp l di"><div class="mc md l"/></div></figure><p id="ea3b" class="pw-post-body-paragraph kw kx iq ky b kz me lb lc ld mf lf lg lh mg lj lk ll mh ln lo lp mi lr ls lt ij bi translated">到更复杂的授权/认证模式。因为您可以从请求中读取头和cookies，所以您可以使用它们进行身份验证。在下面的示例中，我们正在读取一个载体认证令牌，如果用户被授权，我们将显示页面，否则，我们将客户端重定向到一个登录页面:</p><figure class="ly lz ma mb gt jr"><div class="bz fp l di"><div class="mc md l"/></div></figure><h1 id="aaba" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">脚手架</h1><p id="d128" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">在开发一个网站时，你可能想向用户展示一个“正在建设中”的页面，但同时，你需要向你的客户展示网站的进展。您可以将一个密钥放在URL的末尾，让中间件在第一次访问时检查密钥是否存在，并设置一个会话cookie。如果密钥存在，所有其他请求都将检查cookie。如果cookie不存在，用户将被重定向(或重写)到“正在构建”页面:</p><figure class="ly lz ma mb gt jr"><div class="bz fp l di"><div class="mc md l"/></div></figure><h1 id="f817" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">个性化</h1><p id="47c8" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">基于cookies(或其他请求参数)，您可以将用户重定向到不同的页面。让我们假设你有一个电子商务，并把你的客户分成四组。您可以使用不同的优惠和CTA创建4个不同的主页，并根据用户的分组向他们展示:</p><figure class="ly lz ma mb gt jr"><div class="bz fp l di"><div class="mc md l"/></div></figure><h1 id="da15" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">僵尸阻断</h1><p id="b2ad" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">因为您可以读取用户代理，所以您可以将机器人和收割机重定向到404页面:</p><figure class="ly lz ma mb gt jr"><div class="bz fp l di"><div class="mc md l"/></div></figure><h1 id="32af" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">更多用途</h1><p id="b4a5" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">因为您可以访问客户端请求(包括标题、cookies、地理位置和更多数据)，所以在向用户显示页面之前，您可以执行许多操作。你真的可以根据语言、cookies、位置、页面请求本身进行深度个性化。您可以记录统计和调试请求，计算页面访问次数，等等。一旦部署到Vercel，中间件功能非常快，因为它们部署在Edge上。这比在页面级别拥有相同的代码要快得多，不考虑是在上面一个级别，它们可以访问更多的请求数据，并且它们不需要为每个页面复制。</p></div><div class="ab cl ni nj hu nk" role="separator"><span class="nl bw bk nm nn no"/><span class="nl bw bk nm nn no"/><span class="nl bw bk nm nn"/></div><div class="ij ik il im in"><h2 id="d564" class="np jz iq bd ka nq nr dn ke ns nt dp ki lh nu nv km ll nw nx kq lp ny nz ku oa bi translated">进一步阅读</h2><div class="mq mr gp gr ms mt"><a rel="noopener  ugc nofollow" target="_blank" href="/data-fetching-with-next-js-13s-bleeding-edge-features-a-primer-a60ddd3f7570"><div class="mu ab fo"><div class="mv ab mw cl cj mx"><h2 class="bd ir gy z fp my fr fs mz fu fw ip bi translated">使用Next.js 13的前沿特性获取数据——入门</h2><div class="na l"><h3 class="bd b gy z fp my fr fs mz fu fw dk translated">NextJS 13中的数据获取使用了应用程序目录、流、暂挂以及混合服务器和客户端组件。</h3></div><div class="nb l"><p class="bd b dl z fp my fr fs mz fu fw dk translated">javascript.plainenglish.io</p></div></div><div class="nc l"><div class="ob l ne nf ng nc nh jw mt"/></div></div></a></div><p id="1945" class="pw-post-body-paragraph kw kx iq ky b kz me lb lc ld mf lf lg lh mg lj lk ll mh ln lo lp mi lr ls lt ij bi translated"><em class="mj">更多内容请看</em><a class="ae oc" href="https://plainenglish.io/" rel="noopener ugc nofollow" target="_blank"><strong class="ky ir"><em class="mj">plain English . io</em></strong></a><em class="mj">。报名参加我们的</em> <a class="ae oc" href="http://newsletter.plainenglish.io/" rel="noopener ugc nofollow" target="_blank"> <strong class="ky ir"> <em class="mj">免费周报</em> </strong> </a> <em class="mj">。关注我们关于</em><a class="ae oc" href="https://twitter.com/inPlainEngHQ" rel="noopener ugc nofollow" target="_blank"><strong class="ky ir"><em class="mj">Twitter</em></strong></a><a class="ae oc" href="https://www.linkedin.com/company/inplainenglish/" rel="noopener ugc nofollow" target="_blank"><strong class="ky ir"><em class="mj">LinkedIn</em></strong></a><em class="mj"/><a class="ae oc" href="https://www.youtube.com/channel/UCtipWUghju290NWcn8jhyAw" rel="noopener ugc nofollow" target="_blank"><strong class="ky ir"><em class="mj">YouTube</em></strong></a><em class="mj"/><a class="ae oc" href="https://discord.gg/GtDtUAvyhW" rel="noopener ugc nofollow" target="_blank"><strong class="ky ir"><em class="mj">不和</em> </strong> </a> <em class="mj">。</em></p></div></div>    
</body>
</html>