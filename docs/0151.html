<html>
<head>
<title>What the Heck is Middleware in Node.js?</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Node.js中的中间件到底是什么？</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/what-the-heck-is-middleware-in-node-js-626107ca44d0?source=collection_archive---------10-----------------------#2022-01-10">https://javascript.plainenglish.io/what-the-heck-is-middleware-in-node-js-626107ca44d0?source=collection_archive---------10-----------------------#2022-01-10</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><div class=""><h2 id="1062" class="pw-subtitle-paragraph jk im in bd b jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb dk translated">Node.js中间件如何工作，它是什么。</h2></div><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi kc"><img src="../Images/5841d4adbccbb78695847576eb39ad70.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Su_uqZVJh8_DufNEo8wVTA.jpeg"/></div></div><figcaption class="ko kp gj gh gi kq kr bd b be z dk">Photo by <a class="ae ks" href="https://unsplash.com/@glenncarstenspeters?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">Glenn Carstens-Peters</a> on <a class="ae ks" href="https://unsplash.com/s/photos/computer?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="cb85" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">中间件可以被定义为在请求和响应之间执行的功能。它还可以访问请求和响应对象。</p><p id="0f69" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">让我们使用一个用Node.js编写的简单程序来理解这个概念。</p><figure class="kd ke kf kg gt kh"><div class="bz fp l di"><div class="lp lq l"/></div></figure><p id="1ea6" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">这有两条路线。如你所见，有一个函数被定义为中间件，带有参数<strong class="kv io"> req </strong>，<strong class="kv io"> res </strong>，以及<strong class="kv io"> next </strong>。并且已经通过了顶部的app.use()。因此，这是一个全局定义的中间件，将在我们发送的每个请求中运行。</p><p id="c216" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">一旦程序运行，如果我们尝试访问<a class="ae ks" href="http://localhost:3000/" rel="noopener ugc nofollow" target="_blank"> http://localhost:3000 </a>，您可以看到下面的输出。</p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div class="gh gi lr"><img src="../Images/fda5a22aec3746ce7cc0de85b2f8a9d2.png" data-original-src="https://miro.medium.com/v2/resize:fit:804/format:webp/1*l-LeOzn6DLOKdy96IrSUDg.png"/></div></figure><p id="5878" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">“这是一个中间件”的日志已经打印出来之前，“你好！”。这就是它的工作原理。这个全局中间件将在执行每个请求的函数体之前执行。所以这种类型的中间件可以在我们需要为每个请求做些事情的时候使用。</p><p id="cb29" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">注意，这个中间件调用了代码的顶部。这是因为中间件按照我们定义的顺序运行。</p><p id="2c9e" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">还有另一种使用中间件的方法。</p><figure class="kd ke kf kg gt kh"><div class="bz fp l di"><div class="lp lq l"/></div></figure><p id="094b" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">想象一下，您的应用程序由两种类型的用户使用，即管理员和公共用户。并且您需要验证只允许管理的路由的用户。这可以使用中间件来实现。为了解释这个概念，我使用了<strong class="kv io"> verifyUser() </strong>函数。为了简单起见，这里我只使用了一个字符串变量。但这是您可以添加逻辑来验证用户的地方。</p><p id="8c77" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">如果用户是admin，我们接下来调用，这允许继续请求-响应循环。否则，我们终止该功能继续运行。</p><p id="00b1" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">我们如何将这个中间件用于我们需要发送的请求？我们可以这样做。</p><pre class="kd ke kf kg gt ls lt lu lv aw lw bi"><span id="6b02" class="lx ly in lt b gy lz ma l mb mc">app.get('/admin', <strong class="lt io">verifyUser</strong>, (req, res) =&gt; {<br/>   console.log('Admin route');<br/>   res.send("Admin");<br/>});</span></pre><p id="47d8" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">使用<strong class="kv io"> verifyUser </strong>以及我们需要发送的请求。</p><p id="6fed" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">让我们运行代码，看看验证输出。</p><p id="5cde" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">尝试在您的浏览器中放置<a class="ae ks" href="http://localhost:3000/admin" rel="noopener ugc nofollow" target="_blank">http://localhost:3000/admin</a>。</p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div class="gh gi md"><img src="../Images/61ac88f84e04e1cb14e012fa9012315e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1038/format:webp/1*1ccP2zr02Ss0t4HKfZzYPg.png"/></div></figure><p id="c6e8" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">我们可以看到响应“Admin”。</p><p id="1995" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">我们在候机厅被跟踪了。</p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div class="gh gi me"><img src="../Images/0ac44cec81f717fcdadf440f655891a8.png" data-original-src="https://miro.medium.com/v2/resize:fit:950/format:webp/1*g-eEq2aoSpwjj2WULy2zGw.png"/></div></figure><p id="ad62" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">如果我们将verifyUser()中间件的<strong class="kv io"> userRole </strong>变量的当前值(admin)更改为其他值，会发生什么情况？在这里。</p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div class="gh gi mf"><img src="../Images/0f9f6b8e9a3ef2c7fc678ecdb332e44a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1220/format:webp/1*Yb-vXvj7GrGqOl3DkISx0Q.png"/></div></figure><p id="57db" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">这是终端输出。</p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div class="gh gi mg"><img src="../Images/ac1bb923c621cf37dfae775eb5bbafbc.png" data-original-src="https://miro.medium.com/v2/resize:fit:972/format:webp/1*E243DOfUs8OcxaIjJaeIcA.png"/></div></figure><p id="74bc" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">正如我们所看到的，它没有执行管理路由的函数体。</p><p id="2c74" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">这种类型的中间件可以用于JWT验证。如果用户被授权，我们可以继续其余的事情，否则没有。</p><p id="3d9e" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">最后需要提到的是，我们可以访问中间件内部的req和res对象。</p><p id="c39a" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">让我们在verifyUser中间件中添加一个简单的console.log(req.query)语句。</p><figure class="kd ke kf kg gt kh"><div class="bz fp l di"><div class="lp lq l"/></div></figure><p id="3a16" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">而如果我们把网址<a class="ae ks" href="http://localhost:3000/admin?name=john" rel="noopener ugc nofollow" target="_blank"> http://localhost:3000/admin？在浏览器中，它会在终端中显示以下输出。</a></p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div class="gh gi mh"><img src="../Images/d16bb60169c46b5cfee4ff3ec33674cf.png" data-original-src="https://miro.medium.com/v2/resize:fit:956/format:webp/1*z8IDo2ZOconNyAufi0r3uA.png"/></div></figure><p id="8091" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">它打印我们提供的查询参数。</p><p id="bb15" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">希望这对您有所帮助。</p><p id="2b56" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">编码快乐！</p><p id="27da" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated"><em class="mi">更多内容看</em> <a class="ae ks" href="http://plainenglish.io/" rel="noopener ugc nofollow" target="_blank"> <em class="mi">说白了。报名参加我们的</em> </a><a class="ae ks" href="http://newsletter.plainenglish.io/" rel="noopener ugc nofollow" target="_blank"> <em class="mi">免费每周简讯</em> </a> <em class="mi">。在我们的</em> <a class="ae ks" href="https://discord.gg/GtDtUAvyhW" rel="noopener ugc nofollow" target="_blank"> <em class="mi">社区</em> </a> <em class="mi">获得独家写作机会和建议。</em></p></div></div>    
</body>
</html>