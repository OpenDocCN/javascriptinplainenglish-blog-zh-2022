# å¦‚ä½•ä½¿ç”¨ Redis å®ç°æ¯æ—¥æ´»è·ƒç”¨æˆ·æŒ‡æ ‡

> åŸæ–‡ï¼š<https://javascript.plainenglish.io/how-to-implement-daily-active-users-metric-using-redis-4a7d7c4aca8f?source=collection_archive---------3----------------------->

![](img/ff4e2bb196093622da704373cfbf674d.png)

ä½¿ç”¨ Redis å¯ä»¥åšå¾ˆå¤šäº‹æƒ…ï¼Œä½†æ˜¯ä½•æ—¶ä½•åœ°ä½¿ç”¨å®ƒå¯¹ä¸€äº›äººæ¥è¯´å¯èƒ½æœ‰ç‚¹å›°æƒ‘ã€‚è¿œç¨‹è¯å…¸æœåŠ¡å™¨(æ˜¯çš„ï¼Œæ²¡é”™ï¼Œè¿™å°±æ˜¯ Redis è¿™ä¸ªè¯çš„æ„æ€ğŸ˜‰)å°†ä¼šä»¤äººéš¾ä»¥ç½®ä¿¡åœ°æé«˜ä½ çš„åº”ç”¨ç¨‹åºçš„æ€§èƒ½ï¼Œé€šè¿‡æ¯ç§’æ•°ç™¾ä¸‡æ¬¡çš„æ“ä½œï¼Œå°†ä½ çš„åº”ç”¨ç¨‹åºçš„è¯»å†™æ“ä½œçš„å»¶è¿Ÿå‡å°‘åˆ°ä¸åˆ°ä¸€æ¯«ç§’â€”â€”æ˜¯çš„ï¼Œè¿™ä¸æ˜¯ä¸€ä¸ªæ‰“å­—é”™è¯¯ã€‚

Redis æœ‰å¤§é‡æ‚¨ç†Ÿæ‚‰çš„æ•°æ®ç»“æ„æ¥æ»¡è¶³æ‚¨çš„åº”ç”¨ç¨‹åºéœ€æ±‚ã€‚å®ƒå…è®¸ä½ å°†åº”ç”¨ç¨‹åºçš„æ•°æ®å­˜å‚¨ä¸ºå­—ç¬¦ä¸²ã€åˆ—è¡¨ã€æ•£åˆ—ã€é›†åˆã€JSONâ€¦ç­‰ç­‰ã€‚ä½ çŒœæ€ä¹ˆç€ï¼ŸRedis è¶…çº§å¥½ç”¨ã€‚ä½¿ç”¨ Redisï¼Œæ‚¨å¯ä»¥ç¼–å†™æ›´å°‘çš„ä»£ç æ¥åœ¨åº”ç”¨ç¨‹åºä¸­å­˜å‚¨ã€è®¿é—®å’Œä½¿ç”¨æ•°æ®ã€‚æ­¤å¤–ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ Redis APIï¼Œè€Œä¸å¿…æ‹…å¿ƒç®¡ç†å•ç‹¬çš„ç¼“å­˜ã€æ•°æ®åº“æˆ–åº•å±‚åŸºç¡€è®¾æ–½ã€‚

ä½†æ˜¯å˜¿ï¼Redis å¦‚ä½•ä½¿æˆ‘çš„åº”ç”¨ç¨‹åºå—ç›Šå·²ç»è¯´å¾—å¤Ÿå¤šäº†ã€‚æˆ‘å·²ç»æ‹çˆ±äº†ã€‚è¯·å‘Šè¯‰æˆ‘ï¼ŒRedis åˆ°åº•æ˜¯ä»€ä¹ˆï¼Ÿæ”¾æ¾â€¦ğŸ˜‰

æ ¹æ®å®˜æ–¹æ–‡æ¡£ï¼ŒRedis æ˜¯ä¸€ä¸ªå¼€æºçš„ã€å†…å­˜ä¸­çš„[é”®-å€¼]æ•°æ®ç»“æ„å­˜å‚¨ï¼Œç”¨ä½œæ•°æ®åº“ã€ç¼“å­˜ã€æ¶ˆæ¯ä»£ç†å’Œæµå¼•æ“ã€‚æ‚¨å¯ä»¥ä½¿ç”¨å¤§å¤šæ•°ç¼–ç¨‹è¯­è¨€çš„ Redisï¼Œå¦‚ JavaScriptã€Javaã€Pythonã€C++ã€C#ã€Swiftã€PHP ç­‰ã€‚

> *Psst:è¿™åªæ˜¯ Redis çš„ä¸€ä¸ªé«˜çº§æ¦‚è¿°ã€‚æ¬²äº†è§£æ›´å¤šï¼Œè¯·è®¿é—®* [*å®˜æ–¹ç½‘ç«™*](https://redis.io/docs/) *ã€‚*

å¥½äº†ï¼Œç°åœ¨è¯·å‘Šè¯‰æˆ‘ï¼Œæˆ‘èƒ½ä¸ºé›·è¿ªæ–¯Â·ğŸ¥º.åšäº›ä»€ä¹ˆå½“ç„¶ï¼Œæ²¡é—®é¢˜ï¼âœŒï¸Redis ç”¨ä¾‹å¦‚ä¸‹:

*   ç¼“å­˜å¯ä»¥å‡å°‘æ•°æ®è®¿é—®å»¶è¿Ÿï¼Œå¢åŠ ååé‡ï¼Œå‡è½»å…³ç³»æˆ– NoSQL æ•°æ®åº“å’Œåº”ç”¨ç¨‹åºçš„è´Ÿæ‹…ã€‚
*   èŠå¤©ã€æ¶ˆæ¯ä¼ é€’å’Œé˜Ÿåˆ—ï¼Œåˆ©ç”¨å„ç§æ•°æ®ç»“æ„ï¼Œå¦‚åˆ—è¡¨ã€æ’åºé›†å’Œæ•£åˆ—ã€‚
*   ä¼šè¯å­˜å‚¨ç”¨äºç®¡ç†ä¼šè¯æ•°æ®ï¼Œå¦‚ç”¨æˆ·é…ç½®æ–‡ä»¶ã€å‡­æ®ã€ä¼šè¯çŠ¶æ€å’Œç‰¹å®šäºç”¨æˆ·çš„ä¸ªæ€§åŒ–è®¾ç½®ã€‚
*   é€šè¿‡åˆ©ç”¨ Redis æ’åºé›†æ•°æ®ç»“æ„çš„æ¸¸æˆæ’è¡Œæ¦œã€‚
*   ä½¿ç”¨ GEOADDã€GEODISTã€GEORADIUS å’Œ GEORADIUSBYMEMBER ç­‰å‘½ä»¤ç®¡ç†å®æ—¶åœ°ç†ç©ºé—´æ•°æ®ï¼Œä»¥å®æ—¶å­˜å‚¨ã€å¤„ç†å’Œåˆ†æåœ°ç†ç©ºé—´æ•°æ®ã€‚
*   å¿«é€Ÿå†…å­˜æ•°æ®å­˜å‚¨æ”¯æŒå®æ—¶æµåª’ä½“ã€‚
*   å¿«é€Ÿå†…å­˜æ•°æ®å­˜å‚¨ï¼Œç”¨äºå¿«é€Ÿæ„å»ºã€è®­ç»ƒå’Œéƒ¨ç½²æœºå™¨å­¦ä¹ æ¨¡å‹ã€‚
*   ç¤¾äº¤åª’ä½“åˆ†æã€å¹¿å‘Šå®šä½ã€ä¸ªæ€§åŒ–å’Œç‰©è”ç½‘ç­‰å®æ—¶åˆ†æç”¨ä¾‹ã€‚

è¿˜æœ‰æ›´å¤šï¼

# å¦‚ä½•åˆ©ç”¨ Redis ç¼“å­˜ç‰¹æ€§çš„å¼ºå¤§åŠŸèƒ½ï¼Œä» Prometheus æŒ‡æ ‡ä¸­è·å–æ¯æ—¥æ´»è·ƒç”¨æˆ·

ç°åœ¨ï¼Œè®©æˆ‘å‘æ‚¨å±•ç¤ºå¦‚ä½•æœ€å¤§åŒ– Redis ç¼“å­˜ç‰¹æ€§ï¼Œä»¥è§£å†³ä»ç°å®åº”ç”¨ç¨‹åºä¸­å®æ—¶è·å–å”¯ä¸€æ´»è·ƒç”¨æˆ·çš„ä¸šåŠ¡é—®é¢˜ã€‚è¿™å¯èƒ½å°±æ˜¯ä½ åœ¨è¿™é‡Œçš„åŸå› ï¼Œä¸æ˜¯å—ï¼Ÿ

# é—®é¢˜æ˜¯

è®©æˆ‘ä»¬å†æ¬¡å¼ºè°ƒè¿™ä¸ªé—®é¢˜ã€‚æ‚¨éœ€è¦ä»é›†æˆåˆ° Node.js åº”ç”¨ç¨‹åºä¸­çš„ Prometheus å®¢æˆ·ç«¯è·å–ä¸€ä¸ªæŒ‡æ ‡ã€‚è¿™ä¸ªæŒ‡æ ‡æ˜¯æ¯æ—¥æ´»è·ƒç”¨æˆ·çš„è®¡æ•°ï¼Œå³æ¯å¤©è‡³å°‘æµè§ˆæ‚¨çš„ç½‘ç«™ä¸€æ¬¡çš„æ¯ä¸ªç”¨æˆ·ã€‚æ‰€ä»¥ï¼Œæ— è®ºç”¨æˆ·ä¸€å¤©æ‰“å¼€ä½ çš„ç½‘ç«™ 100 ä¸‡æ¬¡è¿˜æ˜¯ 100 ä¸‡æ¬¡ï¼Œä»–åœ¨ç½‘ç«™ä¸Šçš„æ´»åŠ¨å½“å¤©éƒ½è®°å½•ä¸º 1ã€‚

# è¿™ä¸ªè®¡åˆ’

æˆ‘ä»¬å°†åˆ›é€ ä¸€ä¸ªæ™®ç½—ç±³ä¿®æ–¯è®¡æ•°å™¨ã€‚å¦‚æœå”¯ä¸€ç”¨æˆ·æ‰“å¼€ç½‘ç«™å¹¶ä½¿ç”¨å—ä¿æŠ¤çš„è·¯ç”±ï¼Œè®¡æ•°å™¨å°†ç´¯è®¡ 1ã€‚è¯¥å¢é‡å°†ä¿æŒä¸å˜ï¼Œå¹¶ä¸”åœ¨é‚£å¤©ç»“æŸä¹‹å‰ä¸ä¼šå› åŒä¸€ç”¨æˆ·è€Œæ”¹å˜ã€‚è¿™ç§æœºåˆ¶å°†é€‚ç”¨äºå½“å¤©æ‰“å¼€ç½‘ç«™çš„æ¯ä¸ªå”¯ä¸€ç”¨æˆ·ã€‚å› æ­¤ï¼Œè®¡æ•°å™¨åœ¨ä¸€å¤©ä¸­ä¸ºæ¯ä¸ªä¸åŒçš„ç”¨æˆ·ä¸æ–­å¢åŠ ã€‚ç„¶åï¼Œåœ¨ç¬¬äºŒå¤©ï¼Œå¯¹äºæ¯ä¸ªç›¸åŒçš„å”¯ä¸€ç”¨æˆ·ï¼Œè®¡æ•°å™¨å°†å¢åŠ  1ï¼Œå¹¶ä¸€ç›´ä¿æŒåˆ°å½“å¤©ç»“æŸã€‚ç®€è€Œè¨€ä¹‹ï¼Œç”¨æˆ·è®¿é—®ç½‘ç«™çš„æ¯ä¸€å¤©ï¼Œè®¡æ•°å™¨å°†ä¸ºæ¯ä¸ªç‹¬ç«‹ç”¨æˆ·å¢åŠ  1ã€‚

# é˜»æŒ¡è€…

ä¸ºäº†è¯†åˆ«ç”¨æˆ·å·²ç»åœ¨ä¸€å¤©ä¸­è‡³å°‘æ‰“å¼€è¿‡ä¸€æ¬¡ç«™ç‚¹ï¼Œå¹¶ä¸”å› æ­¤ä¸ä¼šåœ¨ä»–åœ¨åŒä¸€å¤©è¿Ÿæ—©æ‰“å¼€å¦ä¸€ä¸ªå—ä¿æŠ¤çš„è·¯ç”±æ—¶å¢åŠ è®¡æ•°å™¨ï¼Œæˆ‘ä»¬å¿…é¡»å­˜å‚¨ç”¨æˆ·çš„ä¿¡æ¯ï¼Œä¸‹æ¬¡æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºæ¥æ”¶åˆ°å¦ä¸€ä¸ªå¯¹å—ä¿æŠ¤çš„è·¯ç”±çš„è¯·æ±‚æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨è¿™äº›ä¿¡æ¯æ¥éªŒè¯ã€‚æˆ‘ä»¬ä¸æƒ³å°†è¿™äº›ä¿¡æ¯å­˜å‚¨åœ¨æˆ‘ä»¬çš„æ•°æ®åº“ä¸­ã€‚ä¸ä¼šå§ï¼ğŸ™…â€â™‚ï¸:æˆ‘ä»¬éœ€è¦çš„æ˜¯ä¸€ä¸ªç¼“å­˜ç³»ç»Ÿã€‚ğŸ‘

# Redis æ¥æ•‘æ´äº†ï¼

Redis æ˜¯å®Œç¾çš„è§£å†³æ–¹æ¡ˆã€‚ä½¿ç”¨ Redis ç¼“å­˜ï¼Œæˆ‘ä»¬å°†åœ¨å—ä¿æŠ¤çš„è·¯ç”±ä¸Šæ‰§è¡Œä»¥ä¸‹æ“ä½œ:

*   ä½¿ç”¨ç”¨æˆ·çš„ ID ä½œä¸ºå¯†é’¥ã€‚
*   æ£€æŸ¥æ˜¯å¦æœ‰åŸºäºé”®çš„ç¼“å­˜æ•°æ®ã€‚
*   å¦‚æœæ²¡æœ‰æ•°æ®ï¼Œé‚£ä¸€å®šæ˜¯ç”¨æˆ·å½“å¤©ç¬¬ä¸€æ¬¡æ‰“å¼€ç½‘ç«™ã€‚å› æ­¤ï¼Œå°†ç”¨æˆ·çš„ ID ä¸â€¦çš„ç»“æœä¸€èµ·å­˜å‚¨
*   ä»¥ç§’ä¸ºå•ä½è®¡ç®—ä»ä»–æ‰“å¼€ç«™ç‚¹åˆ°ä¸€å¤©ç»“æŸè¿˜å‰©å¤šå°‘æ—¶é—´ï¼Œå¹¶å°†å…¶ç”¨ä½œ Redis çš„åˆ°æœŸæ—¶é—´ã€‚
*   ç„¶åï¼Œå°†æ¯æ—¥æ´»è·ƒç”¨æˆ·è®¡æ•°å™¨å¢åŠ  1

# å…ˆå†³æ¡ä»¶

*   æ™®ç½—ç±³ä¿®æ–¯:å› ä¸ºè¿™æ˜¯å…³äºé›·è¿ªæ–¯çš„ï¼Œæˆ‘å‡è®¾ä½ è‡³å°‘å·²ç»çŸ¥é“äº†æ™®ç½—ç±³ä¿®æ–¯çš„åŸºæœ¬çŸ¥è¯†ã€‚å¦‚æœä½ æ²¡æœ‰ï¼Œæˆ‘å»ºè®®ä½ å…ˆå‚åŠ ä¸€ä¸ªé€Ÿæˆç­ã€‚
*   Grafana:å¯¹ Grafana ç•¥çŸ¥ä¸€äºŒæ˜¯ç†æƒ³çš„ã€‚ä½†æ˜¯å¦‚æœä½ ä¸çŸ¥é“ Grafanaï¼Œçœ‹çœ‹ä»–ä»¬çš„[æ–‡æ¡£](https://grafana.com/docs/)ã€‚è¿™å¾ˆç®€å•ã€‚
*   Redis:ä½ åº”è¯¥çŸ¥é“ Redis çš„ä¸€äº›åŸºæœ¬æ¦‚å¿µã€‚ä½†è¿™ä¸æ˜¯é—®é¢˜â€”â€”æˆ‘å·²ç»åœ¨ä¸€å¼€å§‹å°±å‘ä½ ä»‹ç»äº†å…¶ä¸­çš„ä¸€äº›ã€‚æ­¤å¤–ï¼Œæˆ‘å°†ç”¨ [redis-cli](https://redis.io/docs/manual/cli/) å¸¦æ‚¨å®Œæˆå®‰è£…å’Œä¸€äº›åŸºæœ¬çš„ Redis å‘½ä»¤ã€‚
*   ç°æœ‰ Node.js é¡¹ç›®:åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘å°†åªåˆ†äº« Redisã€Prometheus å’Œ Grafana å®ç°çš„ä»£ç ç‰‡æ®µå’Œæˆªå›¾ï¼Œä»¥å®ç°ä¸»é¢˜ç›®æ ‡ï¼Œå³è·å–æ—¥å¸¸æ´»è·ƒç”¨æˆ·ã€‚

å¥½äº†ï¼Œæˆ‘ä»¬å¼€å§‹å§ï¼âœŒï¸

# å®‰è£… Redis

å¦‚ä½•å®‰è£… Redis å–å†³äºæ‚¨çš„æ“ä½œç³»ç»Ÿã€‚ç‚¹å‡»æ­¤å¤„æŸ¥çœ‹æœ€ç¬¦åˆæ‚¨éœ€æ±‚çš„æŒ‡å—[ã€‚](https://redis.io/docs/getting-started/)

# è®©æˆ‘ä»¬ç”¨ CLI æ¥æ¢ç´¢ Redis

æˆåŠŸå®‰è£… Redis åï¼Œæ‰“å¼€æ‚¨çš„ç»ˆç«¯å¹¶æ‰§è¡Œä»¥ä¸‹å‘½ä»¤æ¥å¯åŠ¨ Redis æœåŠ¡å™¨ã€‚

```
â¯ redis-server
```

è¿™åº”è¯¥ä¼šäº§ç”Ÿå¦‚ä¸‹æ‰€ç¤ºçš„è¾“å‡º:

![](img/1aff0ea508eb224c5c16837488319567.png)

å¦‚æœæ‚¨å¾—åˆ°ä¸€ä¸ªé”™è¯¯ï¼Œé‚£ä¹ˆæ‚¨å¯èƒ½æ²¡æœ‰å®‰è£… Redisï¼Œæˆ–è€…å¯¹äº Windows ç”¨æˆ·ï¼Œæ‚¨ä¸æ˜¯åœ¨ WSL ç»ˆç«¯ä¸Šã€‚ç¡®ä¿æŒ‰ç…§æ­¤å¤„çš„å®‰è£…æŒ‡å—[å®‰è£… Redisã€‚å¦‚æœæ‚¨ä½¿ç”¨çš„æ˜¯ Windowsï¼Œè¯·ç¡®ä¿æ‰“å¼€ WSL ç»ˆç«¯ã€‚ç„¶åï¼Œå†æ¬¡å°è¯•è¯¥å‘½ä»¤ã€‚](https://redis.io/docs/getting-started/)

è¯·æ³¨æ„ï¼Œæ‚¨çš„ç»ˆç«¯ä¸Šæ‰“å°çš„éƒ¨åˆ†ä¿¡æ¯è¡¨æ˜ Redis æ­£åœ¨æ‚¨çš„æœ¬åœ°æœºå™¨ä¸Šçš„ç«¯å£ 6379 ä¸Šè¿è¡Œã€‚è¿™æ˜¯ Redis æœåŠ¡å™¨çš„é»˜è®¤ç«¯å£å·ã€‚

ç°åœ¨ï¼Œå½“ Redis æœåŠ¡å™¨æ­£åœ¨è¿è¡Œæ—¶ï¼Œæ‰“å¼€ä¸€ä¸ªæ–°çš„ç»ˆç«¯å¹¶æ‰§è¡Œä»¥ä¸‹å‘½ä»¤æ¥å¯åŠ¨ CLI å¹¶è®¿é—® Redisã€‚

```
â¯ redis-cli
```

è¿™å°†æ‰“å¼€ä¸€ä¸ªæŒ‡å‘`127.0.0.1:6379`çš„å‘½ä»¤æç¤ºç¬¦ã€‚

![](img/57fdac93e6a601f175a6aa7a522b533b.png)

ç°åœ¨ï¼Œè®©æˆ‘ä»¬ä½¿ç”¨ä¸€äº› Redis å‘½ä»¤ã€‚é”®å…¥å¹¶æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼Œè·å–ä¸æŸä¸ªæ¨¡å¼åŒ¹é…çš„æ‰€æœ‰é”®ã€‚

```
127.0.0.1:6379 â¯ KEYS *
```

Redis åœ¨å­˜å‚¨ç‚¹å°†æ•°æ®æ˜ å°„åˆ°æ‚¨æŒ‡å®šçš„é”®ã€‚å°†é”®è§†ä¸ºæ•°æ®çš„ idã€‚è¦æ£€ç´¢å­˜å‚¨çš„æ•°æ®ï¼Œå¿…é¡»é€šè¿‡ä¸€ä¸ª`key`ã€‚åœ¨ä¸Šé¢çš„å‘½ä»¤ä¸­ï¼Œå¦‚æœåœ¨`KEYS`å…³é”®å­—åæŒ‡å®šçš„æ¨¡å¼åŒ¹é…ä¸€ä¸ªé”®ï¼Œå¦‚æœæ¨¡å¼æ˜¯`*`ï¼Œè¡¨ç¤ºâ€œæ‰€æœ‰é”®â€ï¼Œåˆ™è¿”å›ä¸€ä¸ªæˆ–å¤šä¸ªé”®ã€‚

ä¸Šé¢çš„å‘½ä»¤åº”è¯¥ä¼šè¿”å›ä¸€æ¡`empty list or set`æ¶ˆæ¯â€¦é™¤éä½ å·²ç»å­˜å‚¨äº†ä¸€äº›è¿‡å»çš„æ•°æ®ã€‚æ‰€ä»¥ï¼Œè®©æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªæ–°çš„ã€‚æ‰§è¡Œä»¥ä¸‹å‘½ä»¤:

```
127.0.0.1:6379 â¯ SET name Kenneth
```

`SET`æ˜¯è®¾ç½®æ–°æ•°æ®çš„å…³é”®å­—ã€‚å®ƒéœ€è¦ä¸€ä¸ªé”®`name`å’Œå€¼`Kenneth`ã€‚æ³¨æ„ï¼Œåƒè¿™æ ·å­˜å‚¨çš„æ•°æ®æ˜¯ä½œä¸ºå­—ç¬¦ä¸²å­˜å‚¨çš„ã€‚ç°åœ¨æ£€æŸ¥æ‚¨çš„å¯†é’¥`name`æ˜¯å¦å­˜åœ¨ã€‚

```
127.0.0.1:6379 â¯ KEYS name
```

æ‚¨åº”è¯¥ä¼šçœ‹åˆ°åŒ…æ‹¬æ‚¨çš„æ–°å¯†é’¥`name`åœ¨å†…çš„å¯†é’¥åˆ—è¡¨ã€‚ä½†æ˜¯ï¼Œå¦‚æœæˆ‘å¯¹`value`æ„Ÿå…´è¶£å‘¢ï¼Ÿæˆ‘æƒ³çœ‹çœ‹ç”¨é”®å­˜å‚¨çš„å€¼ã€‚å¯¹æ­¤çš„å‘½ä»¤æ˜¯:

```
127.0.0.1:6379 â¯ GET name
```

`GET`æ˜¯è·å–æ•°æ®çš„å…³é”®å­—ã€‚å®ƒéœ€è¦ä¸€ä¸ªé”®ï¼Œåœ¨æœ¬ä¾‹ä¸­æ˜¯`name`ã€‚è¿™å°†è¾“å‡ºè¯¥é”®å­˜å‚¨çš„å€¼ã€‚æ‰€ä»¥ï¼Œä½ åº”è¯¥çœ‹çœ‹`Kenneth`ã€‚

æˆ‘ä»¬çš„å¯†é’¥(å’Œå€¼)å°†è¢«æ°¸ä¹…å­˜å‚¨ï¼Œå› ä¸ºæˆ‘ä»¬åœ¨åˆ›å»ºæ—¶æ²¡æœ‰æŒ‡å®šè¿‡æœŸæ—¶é—´ã€‚ä½†æ˜¯ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤åˆ é™¤å®ƒ:

```
127.0.0.1:6379 â¯ DEL name
```

è¿™å°†è¿”å›`(integer) 1`,è¡¨ç¤ºå®ƒè¢«æˆåŠŸåˆ é™¤ã€‚ä½†æ˜¯ï¼Œå¦‚æœæˆ‘ä»¬æƒ³åœ¨åˆ›å»ºæ—¶ä¸ºæ–°æ•°æ®è®¾ç½®ä¸€ä¸ªåˆ°æœŸæ—¶é—´å‘¢ï¼Ÿå…¶è¯­æ³•æ˜¯:

```
127.0.0.1:6379 â¯ SETEX name 15 Kenneth
```

`SETEX`è®¾ç½®ä¸€ä¸ªæ–°çš„å¯†é’¥å’Œå€¼ï¼Œå¹¶åœ¨è¯¥å€¼ä¹‹å‰ä½¿ç”¨è¿‡æœŸæ—¶é—´ä½œä¸ºå‚æ•°ã€‚åˆ°æœŸæ—¶é—´å¿…é¡»ä»¥ç§’ä¸ºå•ä½ã€‚å› æ­¤ï¼Œä¸Šé¢çš„å‘½ä»¤å°†è®¾ç½®ä¸€ä¸ªåä¸º`name`çš„æ–°é”®ï¼Œå¹¶ä¸ºå…¶åˆ†é…ä¸€ä¸ªåä¸º`Kenneth`çš„å€¼ï¼Œå¹¶å¯åŠ¨ä¸€ä¸ª 15 ç§’çš„è®¡æ—¶å™¨ã€‚è¦è·å¾—å…³äºè¿˜å‰©å¤šå°‘æ—¶é—´è¿‡æœŸçš„ä¿¡æ¯ï¼Œè¯­æ³•æ˜¯:

```
127.0.0.1:6379 â¯ TTL name
```

`TTL`ä»£è¡¨â€œç”Ÿå­˜æ—¶é—´â€ã€‚å®ƒéœ€è¦å¯†é’¥çš„åç§°ï¼Œå®ƒåº”è¯¥ç¡®å®šå®ƒçš„ç”Ÿå­˜æ—¶é—´ã€‚åå¤æ‰§è¡Œä¸Šé¢çš„ä»£ç å°†ä¼šäº§ç”Ÿä¸åŒçš„è¾“å‡ºï¼Œå› ä¸ºé”®(åç§°)çš„ç”Ÿå­˜æ—¶é—´æ­£åœ¨å€’è®¡æ—¶ã€‚ä¸€æ—¦åˆ°äº†-2ï¼Œå°±è¯´æ˜é’¥åŒ™æ²¡äº†ã€‚

#æ™®ç½—ç±³ä¿®æ–¯

å¦‚å‰æ‰€è¿°ï¼Œæˆ‘å°†åªå…³æ³¨ Prometheus ä»£ç ä¸­å®ç°åº¦é‡é€»è¾‘çš„éƒ¨åˆ†ã€‚åœ¨å®ç° Prometheus æ—¶ï¼Œæˆ‘é€šå¸¸ä¼šåˆ›å»ºä¸€ä¸ª`metrics.js`æ–‡ä»¶æ¥å®šä¹‰æˆ‘çš„åº¦é‡ã€‚å°†ä»¥ä¸‹ä»£ç ç‰‡æ®µå¤åˆ¶å¹¶ç²˜è´´åˆ°æ‚¨çš„æŒ‡æ ‡æ–‡ä»¶ä¸­:

```
import client from 'prom-client'; export const dailyActiveUsersGauge = new client.Gauge({
  name: 'my_daily_active_users',
  help: 'Active users metrics on a daily basis.',
  labelNames: ['user_id', 'year', 'month', 'day'],
 });
```

é€šå¸¸ï¼Œæ‚¨ä¼šæœ‰ä¸€ä¸ªéªŒè¯è¯·æ±‚`jwt`ä»¤ç‰Œçš„ä¸­é—´ä»¶ã€‚ä¸ºæ­¤ï¼Œæˆ‘å°†åˆ›å»ºä¸€ä¸ª`protect.js`ä¸­é—´ä»¶æ–‡ä»¶ã€‚å®ƒå°†åŒ…å«æˆ‘çš„`jwt`éªŒè¯é€»è¾‘ã€‚å¦‚æœéªŒè¯é€šè¿‡ï¼Œæˆ‘å°†ä»è§£ç çš„ä»¤ç‰Œä¸­è·å¾—ç”¨æˆ·çš„`id`(å®ƒå°†è¢«ç”¨ä½œå‘å¸ƒ`jwt`ä»¤ç‰Œæ—¶æ‰€éœ€çš„ id)ã€‚ç„¶åï¼Œæˆ‘ä¼šæ‰¾åˆ°å…¶`id`ä¸è§£ç çš„ä»¤ç‰Œ`id`åŒ¹é…çš„ç”¨æˆ·ï¼Œå¹¶å°†ç”¨æˆ·çš„è¯¦ç»†ä¿¡æ¯é™„åŠ åˆ°è¯·æ±‚å¯¹è±¡ä¸Šåä¸º`user`çš„æ–°å±æ€§ä¸­(å› æ­¤ï¼Œ`req.user`)ã€‚æœ€åè°ƒç”¨æ ˆä¸­çš„`next()`ä¸­é—´ä»¶ã€‚

å¥½å§ï¼Œè¿™åªæ˜¯æˆ‘çš„çœ‹æ³•ã€‚ä½†æ˜¯ï¼Œæ— è®ºæ‚¨å¦‚ä½•è®¾è®¡æ‚¨çš„èº«ä»½éªŒè¯é€»è¾‘ï¼Œåªè¦æ‚¨å¯ä»¥ä»è¯·æ±‚å¯¹è±¡ä¸­è·å¾—ç”¨æˆ·çš„`id`,å°±å¯ä»¥æŒ‚è½½ä¸‹é¢çš„ä»£ç ç‰‡æ®µ:

```
import { dailyActiveUsersGauge } from 'path/to/metrics.js';

 dailyActiveUsersGauge.inc(
    {
       user_id: currentUser.uid,
       year,
       month,
       day,
    },
    1,
 );
```

è¿™å°†åˆ›å»ºä¸€ä¸ªåä¸º`my_daily_active_users`å’Œä¸€äº›æ ‡ç­¾(`year`ã€`month`å’Œ`day`)çš„æ–°åº¦é‡æŒ‡æ ‡ï¼Œç´¯ç§¯æ ·æœ¬å€¼ä¸º 1ã€‚

##Redis

å¦‚æœæ²¡æœ‰ Redis çš„å¸®åŠ©ï¼Œæˆ‘ä»¬ä¸èƒ½ä¾èµ–äºæˆ‘ä»¬å½“å‰çš„å®ç°ï¼Œå› ä¸ºæ¯æ¬¡ç›¸åŒçš„ç”¨æˆ·ä½¿ç”¨å—ä¿æŠ¤çš„è·¯ç”±å’Œè°ƒç”¨`dailyActiveUsersGauge`åº¦é‡æ—¶ï¼Œæ ·æœ¬å€¼éƒ½ä¼šä¸æ–­å¢åŠ ã€‚è¿™å°†åœ¨ä¸€å¤©ç»“æŸæ—¶äº§ç”Ÿä¸å‡†ç¡®çš„ç»“æœã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬ç”¨ Redis æ¥ç¼“å­˜ç”¨æˆ·çš„`id`ã€‚

è®©æˆ‘ä»¬å®‰è£…`redis npm`åŒ…

```
â¯ npm i redis
```

åœ¨é¡¹ç›®æ–‡ä»¶å¤¹ä¸­åˆ›å»ºä¸€ä¸ªæ–‡ä»¶(æˆ‘ç§°ä¹‹ä¸º redisCacheHandler.js ),å¹¶å°†ä»¥ä¸‹ä»£ç ç²˜è´´åˆ°å…¶ä¸­:

```
import { createClient } from 'redis';

 let client;

 if (process.env.NODE_ENV === 'production') {
  client = createClient({
    url: `redis://${process.env.REDIS_USER}:${process.env.REDIS_PASSWORD}@${process.env.REDIS_HOSTNAME}:${process.env.REDIS_PORT}`,
   });
 } else {
  // You should install redis and run the service command ----> redis-server
   client = createClient();
 }

 client.on('error', (err) => console.log('Redis Client Error', err));

 async function connectRedis() {
   await client.connect();
 }

 connectRedis();

 const defaultExpirationTime = 60 * 10; // 60 seconds times 10 -> 10 minutes

 const getOrSetCache = (cb) => cb();

 export const getCache = (key) =>
   new Promise((resolve, reject) => {
     try {
       getOrSetCache(async () => {
        const data = await client.get(key);
        if (data) {
          console.log('SENDING CACHE...ğŸ«');
        }
        resolve(JSON.parse(data));
      });
    } catch (error) {
      reject(error);
    }
 });

 export const setCache = (key, data, expTime) => {
  if (typeof expTime === 'undefined') {
    expTime = defaultExpirationTime;
 }

  return new Promise((resolve, reject) => {
    try {
      getOrSetCache(async () => {
        const isOk = await client.set(key, JSON.stringify(data), {
          EX: expTime,
        });
        if (isOk) {
          console.log('CACHED! âœ…');
        }
        resolve();
      });
    } catch (error) {
      reject(error);
    }
  });
 };
```

ç®€è¦è§£é‡Šä»£ç :

*   å¯¼å…¥ redis åº“ã€‚
*   æ£€æŸ¥åº”ç”¨ç¨‹åºè¿è¡Œçš„ç¯å¢ƒã€‚å¦‚æœåœ¨å¼€å‘ä¸­ï¼Œä½¿ç”¨æœ¬åœ° redis æœåŠ¡å™¨(ç¡®ä¿å®ƒæ­£åœ¨è¿è¡Œ)ã€‚å¦‚æœåœ¨ç”Ÿäº§ä¸­ï¼Œè¿æ¥åˆ° [Redis äº‘](https://redis.info/3NBGJRT)ã€‚
*   å¯¼å‡ºä¸¤ä¸ªå‡½æ•°:
*   `getCache`:é€šè¿‡ç»™å®šçš„é”®æ£€æŸ¥å­˜å‚¨çš„æ•°æ®ã€‚è¿”å›æ•°æ®çš„æ‰¿è¯º(å¯èƒ½æœªå®šä¹‰)ã€‚
*   `setCache`:è®¾ç½®æ–°çš„é”®å€¼æ•°æ®ï¼Œè¿”å›æ‰¿è¯ºã€‚éœ€è¦å¯†é’¥ã€æ•°æ®å’Œä»¥ç§’ä¸ºå•ä½çš„è¿‡æœŸæ—¶é—´å‚æ•°ã€‚å¦‚æœæœªæä¾›åˆ°æœŸæ—¶é—´ï¼Œåˆ™ä½¿ç”¨é»˜è®¤çš„åˆ°æœŸæ—¶é—´ 10 åˆ†é’Ÿã€‚

ç°åœ¨ï¼Œå›åˆ°æˆ‘ä»¬å®ç°`dailyActiveUsersGauge`å‡½æ•°çš„åœ°æ–¹ï¼Œä¿®æ”¹æ‚¨çš„ä»£ç å¦‚ä¸‹:

```
import { dailyActiveUsersGauge } from 'path/to/metrics.js';
import { getCache, setCache } from 'path/to/redisCacheHandler.js';

// .. ..
  const cacheKey = currentUser.uid;
    const date = new Date();

    const year = date.getFullYear();
    const month = date.getMonth();
    const day = date.getDate();

    const now = Date.now();
    const endOfDay = date.setUTCHours(23, 59, 59, 999);

    const secondsLeftTillEndOfDay = Math.floor((endOfDay - now) / 1000);

    const cachedData = await getCache(cacheKey);

    if (!cachedData) {
      dailyActiveUsersGauge.inc(
        {
          user_id: currentUser.uid,
          year,
          month,
          day,
        },
        1,
      );

      // cache
      await setCache(cacheKey, '_', secondsLeftTillEndOfDay);
   }

// .. ..
```

ç®€è¦è§£é‡Šä»£ç :

*   å¯¼å…¥æˆ‘ä»¬çš„è‡ªå®šä¹‰ redis æ¨¡å—ã€‚è·å–æ—¥ã€æœˆå’Œå¹´ï¼Œå¹¶å°†å®ƒä»¬ä¼ é€’ç»™ dailyActiveUsersGauge å‡½æ•°ã€‚æˆ‘ä»¬å°†éœ€è¦è¿™äº›ä¿¡æ¯ï¼Œå°¤å…¶æ˜¯â€œæ—¥æœŸâ€,ä»¥ä¾¿ä¸ Prometheus ä¸€èµ·å¯¹æˆ‘ä»¬çš„æŒ‡æ ‡è¿›è¡Œåˆ†ç»„ã€‚è¿™æ­£æ˜¯æˆ‘ä»¬æœ€ç»ˆæƒ³è¦è·å¾—æ¯æ—¥è®¡æ•°çš„æ–¹å¼ã€‚
*   ä½¿ç”¨ç”¨æˆ·çš„ ID ä½œä¸ºå¯†é’¥
*   æ£€æŸ¥æ˜¯å¦æœ‰åŸºäºé”®çš„ç¼“å­˜æ•°æ®
*   å¦‚æœæ²¡æœ‰æ•°æ®ï¼Œé‚£ä¸€å®šæ˜¯ç”¨æˆ·å½“å¤©ç¬¬ä¸€æ¬¡æ‰“å¼€ç½‘ç«™ã€‚å› æ­¤ï¼Œå°†ç”¨æˆ·çš„ ID ä¸â€¦çš„ç»“æœä¸€èµ·å­˜å‚¨
*   ä»¥ç§’ä¸ºå•ä½è®¡ç®—ä»ä»–æ‰“å¼€ç«™ç‚¹çš„æ—¶é—´åˆ°ä¸€å¤©ç»“æŸè¿˜å‰©å¤šå°‘æ—¶é—´ä½œä¸ºåˆ°æœŸæ—¶é—´
*   ç„¶åï¼Œå°†æ¯æ—¥æ´»è·ƒç”¨æˆ·é‡å¢åŠ  1

ä¸Šè¿°å®ç°å°†ç¡®ä¿æˆ‘ä»¬æœ‰ä¸€ä¸ªå‡†ç¡®çš„æ¯æ—¥ç”¨æˆ·è®¡æ•°ï¼Œå› ä¸ºåªæœ‰åœ¨ Redis ä¸‹æœ‰æ–°ç”¨æˆ·æˆ–æ–°å¯†é’¥æ—¶ï¼Œè®¡æ•°å™¨æ‰ä¼šå¢åŠ ã€‚

# æ ¼æ‹‰å¤«çº³

åœ¨ Grafana ä»ªè¡¨æ¿ä¸Šï¼Œåˆ›å»ºä¸€ä¸ªæ–°é¢æ¿ï¼Œå¹¶æŒ‰å¦‚ä¸‹æ–¹å¼æ„å»º Prometheus metrics æµè§ˆå™¨:

![](img/6129a65361525efee3b559eeac00d6a3.png)

# ç»“è®º

Redis æ˜¯ä¸€ä¸ªå¼ºå¤§çš„å·¥å…·ï¼Œå‡ ä¹å¯ä»¥åœ¨ web åº”ç”¨ç¨‹åºçš„ä»»ä½•åœ°æ–¹ä½¿ç”¨ã€‚å¸Œæœ›è¿™ç¯‡æ–‡ç« æ˜¯æœ‰å¸®åŠ©çš„ï¼Œæ›´é‡è¦çš„æ˜¯å¯¹ Redis çš„åŠ›é‡å¤§å¼€çœ¼ç•Œã€‚

è¿™ç¯‡æ–‡ç« æ˜¯ä¸ Redis åˆä½œçš„ã€‚

è¦äº†è§£æ›´å¤šä¿¡æ¯ï¼Œè¯·æµè§ˆä»¥ä¸‹å‚è€ƒé“¾æ¥:

*   [å…è´¹è¯•ç”¨ Redis äº‘](https://redis.info/3NBGJRT)
*   [è§‚çœ‹æ­¤è§†é¢‘ï¼Œäº†è§£ Redis äº‘ç›¸å¯¹äºå…¶ä»– Redis æä¾›å•†çš„ä¼˜åŠ¿](https://redis.info/3Ga9YII)
*   [Redis å¼€å‘è€…ä¸­å¿ƒâ€”å·¥å…·](https://redis.info/3LC4GqB)
*   [RedisInsight æ¡Œé¢ GUI](https://redis.info/3wMR7PR)

*æ›´å¤šå†…å®¹çœ‹* [***è¯´ç™½äº†ã€‚æŠ¥åå‚åŠ æˆ‘ä»¬çš„***](https://plainenglish.io/) **[***å…è´¹å‘¨æŠ¥***](http://newsletter.plainenglish.io/) *ã€‚å…³æ³¨æˆ‘ä»¬å…³äº*[***Twitter***](https://twitter.com/inPlainEngHQ)*å’Œ*[***LinkedIn***](https://www.linkedin.com/company/inplainenglish/)*ã€‚æŸ¥çœ‹æˆ‘ä»¬çš„* [***ç¤¾åŒºä¸å’Œè°***](https://discord.gg/GtDtUAvyhW) *åŠ å…¥æˆ‘ä»¬çš„* [***äººæ‰é›†ä½“***](https://inplainenglish.pallet.com/talent/welcome) *ã€‚***