<html>
<head>
<title>A Comprehensive Guide to Next.js Authentication with Auth0</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Auth0进行Next.js身份验证的综合指南</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/a-comprehensive-guide-to-next-js-authentication-with-auth0-c5af1e472fdb?source=collection_archive---------5-----------------------#2022-02-08">https://javascript.plainenglish.io/a-comprehensive-guide-to-next-js-authentication-with-auth0-c5af1e472fdb?source=collection_archive---------5-----------------------#2022-02-08</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><figure class="gl gn jl jm jn jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi jk"><img src="../Images/ad3d77b9ec423d11afd7d8496b8d3980.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Ki3vW8lTxkphSIjFgoqs0w.png"/></div></div></figure><p id="a1aa" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><em class="kt">你好，我的名字是Igor，如果你碰巧喜欢我写的东西，你可能也喜欢我在</em> <a class="ae ku" href="https://www.twitter.com/igorasilveira" rel="noopener ugc nofollow" target="_blank"> <em class="kt">我的Twitter个人资料</em> </a> <em class="kt">上说的话，来打个招呼吧！👋。</em></p><p id="b770" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">在本文中，我将向您展示如何使用<a class="ae ku" href="https://auth0.com/" rel="noopener ugc nofollow" target="_blank"> Auth0 </a>来保护您的<a class="ae ku" href="https://nextjs.org/" rel="noopener ugc nofollow" target="_blank"> Next.js </a> web应用程序(包括社交登录)。</p><blockquote class="kv kw kx"><p id="d78b" class="jv jw kt jx b jy jz ka kb kc kd ke kf ky kh ki kj kz kl km kn la kp kq kr ks ig bi translated"><em class="in">💡你可以在这里</em>  <em class="in">找到资源库</em> <a class="ae ku" href="https://github.com/igorasilveira/blog-examples/tree/main/auth0-app" rel="noopener ugc nofollow" target="_blank"> <em class="in">。</em></a></p></blockquote><h1 id="a98f" class="lb lc in bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">先决条件:</h1><ul class=""><li id="6f9a" class="lz ma in jx b jy mb kc mc kg md kk me ko mf ks mg mh mi mj bi translated">节点≥ 12</li><li id="de89" class="lz ma in jx b jy mk kc ml kg mm kk mn ko mo ks mg mh mi mj bi translated">基础Next.js知识</li><li id="a229" class="lz ma in jx b jy mk kc ml kg mm kk mn ko mo ks mg mh mi mj bi translated">反应和反应挂钩基础知识</li></ul><h1 id="cd24" class="lb lc in bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">什么是认证？</h1><p id="c251" class="pw-post-body-paragraph jv jw in jx b jy mb ka kb kc mc ke kf kg mp ki kj kk mq km kn ko mr kq kr ks ig bi translated"><em class="kt">认证</em>在全球的所有系统中，在保护任何种类的应用程序方面扮演着重要的角色。</p><p id="da79" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">保护一些资源或一组资源(物理的或数字的)通常由两步过程组成，<strong class="jx io">认证</strong>和<strong class="jx io">授权</strong>系统的一些用户(人或机器)。</p><p id="df49" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><strong class="jx io">认证</strong> —验证系统中的某人是谁。</p><p id="1a79" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><strong class="jx io">授权</strong> —检查用户拥有哪些权限来访问给定的资源以及对其拥有哪些权限(读取、更新、删除)。</p><p id="c1c0" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">在本文中，我们将只关注将<em class="kt">认证</em>合并到我们的Next.js应用程序中，而将<em class="kt">授权</em>留待以后的文章讨论。</p><h1 id="c5d1" class="lb lc in bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">创建Next.js项目</h1><p id="fa53" class="pw-post-body-paragraph jv jw in jx b jy mb ka kb kc mc ke kf kg mp ki kj kk mq km kn ko mr kq kr ks ig bi translated">要创建一个新的Next.js项目，请转到命令行，将<em class="kt"> cd </em>放入您希望项目所在的文件夹。Next.js将在您当前选择的目录下的一个新文件夹中创建项目，因此您不需要创建实际的项目文件夹，只需要创建一个您想要保存它的父目录。</p><p id="a00e" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">运行以下命令创建Next.js应用程序，并完成创建向导:</p><pre class="ms mt mu mv gt mw mx my mz aw na bi"><span id="f9ec" class="nb lc in mx b gy nc nd l ne nf">npx create-next-app@latest</span></pre><p id="1375" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">一旦向导完成，将<em class="kt"> cd </em>放入您为项目新创建的文件夹中，并启动开发环境。</p><pre class="ms mt mu mv gt mw mx my mz aw na bi"><span id="5114" class="nb lc in mx b gy nc nd l ne nf">cd auth0-app &amp;&amp; npm run dev</span></pre><p id="8abd" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">如果一切顺利，你访问<a class="ae ku" href="http://localhost:3000/" rel="noopener ugc nofollow" target="_blank"><em class="kt">http://localhost:3000</em></a>的时候应该能看到下面这个页面。</p><figure class="ms mt mu mv gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi ng"><img src="../Images/7da66de5382c04f9727786f04618040f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*b-5EOcAAbCnWzdTq"/></div></div></figure><h2 id="bc68" class="nb lc in bd ld nh ni dn lh nj nk dp ll kg nl nm lp kk nn no lt ko np nq lx nr bi translated">创建新页面</h2><p id="e3e7" class="pw-post-body-paragraph jv jw in jx b jy mb ka kb kc mc ke kf kg mp ki kj kk mq km kn ko mr kq kr ks ig bi translated">目前，我们的应用程序中只有一个页面，即<code class="fe ns nt nu mx b">index</code>。我们将添加一个新的<strong class="jx io">受保护的</strong>页面，只有登录的用户才能看到，但目前任何人都可以看到，因为我们还没有在我们的应用程序中实现认证。</p><p id="7890" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">因此，在您的<code class="fe ns nt nu mx b">/pages</code>文件夹中，创建一个新文件<code class="fe ns nt nu mx b">protected.js</code>并粘贴以下代码(为了本教程的简单起见，我们将重用主页样式表)。</p><figure class="ms mt mu mv gt jo"><div class="bz fp l di"><div class="nv nw l"/></div></figure><p id="b117" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">现在如果你转到<a class="ae ku" href="http://localhost:3000/protected" rel="noopener ugc nofollow" target="_blank"><em class="kt">http://localhost:3000/protected</em></a>你会看到我们刚刚创建的新页面，这个页面目前还没有得到很好的保护。</p><figure class="ms mt mu mv gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi nx"><img src="../Images/235205cd6ea9a32dfd985561c8b06853.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*-VqkCh9PhreYiW5j"/></div></div></figure><h2 id="61ac" class="nb lc in bd ld nh ni dn lh nj nk dp ll kg nl nm lp kk nn no lt ko np nq lx nr bi translated">创建导航栏组件</h2><p id="9951" class="pw-post-body-paragraph jv jw in jx b jy mb ka kb kc mc ke kf kg mp ki kj kk mq km kn ko mr kq kr ks ig bi translated">为了简化应用程序的登录和注销过程，并保持页面间的一致性，我们将创建一个<em class="kt"> Navbar </em>组件，然后我们将在页面间重用它。</p><p id="cff9" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">让我们首先在项目中创建一个新文件夹来存储应用程序的所有可重用组件。所以在你的项目的根目录下，创建一个新的文件夹<code class="fe ns nt nu mx b">/components</code>。在其中，我们将创建一个新文件<code class="fe ns nt nu mx b">Navbar.js</code>，并添加以下代码:</p><figure class="ms mt mu mv gt jo"><div class="bz fp l di"><div class="nv nw l"/></div></figure><p id="54cf" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">我们还为<code class="fe ns nt nu mx b">/styles/Navbar.module.css</code>下的导航栏创建了一个新的样式表，内容如下:</p><figure class="ms mt mu mv gt jo"><div class="bz fp l di"><div class="nv nw l"/></div></figure><p id="e3ad" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">然后，我们将新组件添加到两个页面中，就在每个React组件的<code class="fe ns nt nu mx b">&lt;Head&gt;</code>标签下:</p><pre class="ms mt mu mv gt mw mx my mz aw na bi"><span id="3bdb" class="nb lc in mx b gy nc nd l ne nf">&lt;Navbar /&gt; // &lt;-- Inserted this below the &lt;Head&gt; closing tag</span></pre><p id="c51f" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">现在，如果我们访问任何页面，我们可以在顶部看到新创建的组件。</p><figure class="ms mt mu mv gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi ny"><img src="../Images/1e7ca60e3340e088b21194aacad9792a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*bEmBfXT_npwu-U0D"/></div></div></figure><h1 id="f070" class="lb lc in bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">OAuth和Auth0</h1><h2 id="03a6" class="nb lc in bd ld nh ni dn lh nj nk dp ll kg nl nm lp kk nn no lt ko np nq lx nr bi translated">什么是OAuth</h2><p id="3973" class="pw-post-body-paragraph jv jw in jx b jy mb ka kb kc mc ke kf kg mp ki kj kk mq km kn ko mr kq kr ks ig bi translated">OAuth代表“开放授权”,它是一个开放的授权标准，任何人都可以实现。它<em class="kt">不是</em>一个API或服务，而是一组完善的规则，这些规则定义了一个协议，用访问令牌而不是凭证来授权设备、API、服务器和应用程序，从而为客户端应用程序提供“安全的委托访问”。</p><p id="4c02" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">这允许网站、服务和应用代表用户通过<strong class="jx io">访问令牌</strong>授予访问权限来访问由其他服务托管的资源，该访问令牌稍后可单独用于识别服务或应用并授予权限。</p><p id="2b85" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">下面的图表从较高的层面解释了这一流程。关于OAuth的深入解释，请参考Matt Raible的这篇博文—<a class="ae ku" href="https://developer.okta.com/blog/2017/06/21/what-the-heck-is-oauth" rel="noopener ugc nofollow" target="_blank">https://developer . okta . com/blog/2017/06/21/what-the-heck-is-OAuth</a></p><figure class="ms mt mu mv gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi nz"><img src="../Images/ca55649e8dcc0094fa33897fa06ec878.png" data-original-src="https://miro.medium.com/v2/resize:fit:1200/0*e1NYU1CIfi2JYFHx"/></div></div></figure><h2 id="7dfa" class="nb lc in bd ld nh ni dn lh nj nk dp ll kg nl nm lp kk nn no lt ko np nq lx nr bi translated">什么是Auth0</h2><figure class="ms mt mu mv gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi oa"><img src="../Images/8ddc3201ec2d4c9f0eca8bf47c279b17.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*kM1Hv-0E79754qEV"/></div></div></figure><p id="f004" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><a class="ae ku" href="https://auth0.com/" rel="noopener ugc nofollow" target="_blank"> Auth0 </a>(读作“Auth Zero”)是一家公司提供的服务，该公司通过控制用户访问、角色和社交提供商登录的简单即插即用的大量功能来确保认证和授权功能。</p><p id="6b51" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">正如我们上面讨论的那样，它基于OAuth 2.0标准工作，因此它使用令牌来管理应用程序中的身份验证和授权流。</p><p id="3566" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">最棒的是，它面向开发人员，让我们开发人员可以用最少的代码在我们的应用程序中轻松实现任何身份验证流程。</p><h2 id="7997" class="nb lc in bd ld nh ni dn lh nj nk dp ll kg nl nm lp kk nn no lt ko np nq lx nr bi translated">Auth0的优势</h2><p id="a3d2" class="pw-post-body-paragraph jv jw in jx b jy mb ka kb kc mc ke kf kg mp ki kj kk mq km kn ko mr kq kr ks ig bi translated">除了使用Auth0作为认证服务的所有这些美妙的好处之外，还有更多。</p><ol class=""><li id="5d5b" class="lz ma in jx b jy jz kc kd kg ob kk oc ko od ks oe mh mi mj bi translated"><strong class="jx io">安全性</strong> — Auth0主要关注提供任何身份认证服务提供商所需的安全性和可靠性，因此投入了大量时间和资源来创建最安全的数据基础架构，以保护Auth0中的所有客户数据。</li><li id="6285" class="lz ma in jx b jy mk kc ml kg mm kk mn ko mo ks oe mh mi mj bi translated"><strong class="jx io">可扩展性</strong> — Auth0通过为开发人员提供现代工具来扩展基础服务，从而实现可在Auth0市场中共享的第三方应用，从而实现轻松的可扩展性。</li><li id="533e" class="lz ma in jx b jy mk kc ml kg mm kk mn ko mo ks oe mh mi mj bi translated"><strong class="jx io">额外的身份认证安全性</strong> —除了我们已经讨论过的所有内容，Auth0使在其服务中启用多因素身份认证(MFA)变得更加容易，从而消除了自己实现这种服务的需要。</li><li id="0a8c" class="lz ma in jx b jy mk kc ml kg mm kk mn ko mo ks oe mh mi mj bi translated"><strong class="jx io">分析</strong> — Auth0带有内置分析功能，可跟踪您的网站或应用程序的使用情况，如新用户数量、登录次数、使用的提供商等。</li><li id="bfe2" class="lz ma in jx b jy mk kc ml kg mm kk mn ko mo ks oe mh mi mj bi translated"><strong class="jx io">面向开发人员的</strong> —为开发人员特别制作的无限量资源和教程。强大的文档和特定于技术的库可以让您在几分钟内使用您选择的语言启动并运行Auth0。</li></ol><h1 id="3f8a" class="lb lc in bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">在我们的应用中实现Auth0</h1><p id="27f4" class="pw-post-body-paragraph jv jw in jx b jy mb ka kb kc mc ke kf kg mp ki kj kk mq km kn ko mr kq kr ks ig bi translated">现在有趣的部分来了！我们将向Auth0注册一个新帐户，并创建一个项目，我们可以为该项目生成一个API密钥，我们将在代码中使用该密钥来标识它。然后，我们将在Next.js应用程序中创建必要的页面和链接，使它们无缝地协同工作。</p><h2 id="15ea" class="nb lc in bd ld nh ni dn lh nj nk dp ll kg nl nm lp kk nn no lt ko np nq lx nr bi translated">创建Auth0帐户和应用程序</h2><p id="473f" class="pw-post-body-paragraph jv jw in jx b jy mb ka kb kc mc ke kf kg mp ki kj kk mq km kn ko mr kq kr ks ig bi translated">顾名思义，这是一个非常简单的步骤。前往https://auth0.com/<a class="ae ku" href="https://auth0.com/" rel="noopener ugc nofollow" target="_blank">创建一个新账户。</a></p><p id="3d21" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">登录后，您将被重定向到您的仪表板。</p><p id="f691" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">在侧边菜单上，您可以找到您的Auth0帐户的注册应用程序。您会发现已经为您创建了一个默认的，您可以自定义它。让我们点击它来打开它。</p><figure class="ms mt mu mv gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi of"><img src="../Images/079086bfbb1861a7470e6ffeeb5575ef.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*4No_Dc5AUJqPf_78"/></div></div></figure><h2 id="1f56" class="nb lc in bd ld nh ni dn lh nj nk dp ll kg nl nm lp kk nn no lt ko np nq lx nr bi translated">我们的Auth0应用程序设置</h2><p id="58c3" class="pw-post-body-paragraph jv jw in jx b jy mb ka kb kc mc ke kf kg mp ki kj kk mq km kn ko mr kq kr ks ig bi translated">在此屏幕中，您可以更改所有的应用程序设置，进行使用设置并扩展其功能。</p><p id="83a1" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">这里要采取的重要步骤是获取应用程序的<strong class="jx io">域</strong>、<strong class="jx io">客户端ID </strong>和<strong class="jx io">客户端秘密</strong>。我们还需要更新<em class="kt">应用程序URIs </em>选项卡上的信息，以便Auth0了解如何处理请求和重定向。</p><figure class="ms mt mu mv gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi og"><img src="../Images/b6b827ebf86cc331de872f3a37cebe50.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*kbPFeHLx3-yzRcbk"/></div></div></figure><h2 id="4535" class="nb lc in bd ld nh ni dn lh nj nk dp ll kg nl nm lp kk nn no lt ko np nq lx nr bi translated">更新我们的应用程序URIs</h2><p id="2c47" class="pw-post-body-paragraph jv jw in jx b jy mb ka kb kc mc ke kf kg mp ki kj kk mq km kn ko mr kq kr ks ig bi translated">在设置页面的<em class="kt">应用程序URIs </em>部分，我们为<strong class="jx io">回调</strong>和<strong class="jx io">注销</strong>定义了<em class="kt">允许的URL</em>，因为这些是Auth0 Next.js包在与Auth0的服务通信时正常工作所必需的。确保您的字段如下图所示填写。</p><p id="18b0" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><strong class="jx io">注意:其他字段是可选的，但建议使用，以进一步保护您的应用程序。</strong></p><figure class="ms mt mu mv gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi oh"><img src="../Images/4a81bd52915cbcda99a304da4c57e44c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*8Wv4aF6T1TNvM12-"/></div></div></figure><h1 id="b88e" class="lb lc in bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">准备我们的Next.js项目</h1><p id="0817" class="pw-post-body-paragraph jv jw in jx b jy mb ka kb kc mc ke kf kg mp ki kj kk mq km kn ko mr kq kr ks ig bi translated">现在我们已经设置好了Auth0项目，是时候准备Next.js应用程序来处理身份验证请求，并根据Auth0的服务对自己进行授权了。</p><h2 id="d4f2" class="nb lc in bd ld nh ni dn lh nj nk dp ll kg nl nm lp kk nn no lt ko np nq lx nr bi translated">正在安装Auth0的Next.js SDK</h2><p id="62c9" class="pw-post-body-paragraph jv jw in jx b jy mb ka kb kc mc ke kf kg mp ki kj kk mq km kn ko mr kq kr ks ig bi translated">在项目目录中，运行以下命令安装Auth0 Next.js SDK:</p><pre class="ms mt mu mv gt mw mx my mz aw na bi"><span id="b823" class="nb lc in mx b gy nc nd l ne nf">npm install @auth0/nextjs-auth0</span></pre><p id="1ac5" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">该SDK将公开方法和变量，使您能够轻松地将Auth0集成到Next.js应用程序中，并使用其所有功能。</p><h2 id="ef0b" class="nb lc in bd ld nh ni dn lh nj nk dp ll kg nl nm lp kk nn no lt ko np nq lx nr bi translated">添加我们的环境变量</h2><p id="47f3" class="pw-post-body-paragraph jv jw in jx b jy mb ka kb kc mc ke kf kg mp ki kj kk mq km kn ko mr kq kr ks ig bi translated">在您的项目中，创建一个新的<code class="fe ns nt nu mx b">.env.local</code>文件，该文件将用于存储我们的<em class="kt">环境变量</em>。在其中，添加以下内容，用应用程序设置屏幕上生成的变量替换所需的变量。</p><figure class="ms mt mu mv gt jo"><div class="bz fp l di"><div class="nv nw l"/></div></figure><ul class=""><li id="cc92" class="lz ma in jx b jy jz kc kd kg ob kk oc ko od ks mg mh mi mj bi translated"><code class="fe ns nt nu mx b">AUTH0_SECRET</code>:用于加密会话cookie的长密值。您可以在命令行上使用<code class="fe ns nt nu mx b">openssl rand -hex 32</code>生成一个合适的字符串。</li><li id="0eb8" class="lz ma in jx b jy mk kc ml kg mm kk mn ko mo ks mg mh mi mj bi translated"><code class="fe ns nt nu mx b">AUTH0_BASE_URL</code>:你的应用程序的基础URL，在我们的例子中是<a class="ae ku" href="http://localhost:3000/" rel="noopener ugc nofollow" target="_blank"><em class="kt">http://localhost:3000</em></a>。</li><li id="6d48" class="lz ma in jx b jy mk kc ml kg mm kk mn ko mo ks mg mh mi mj bi translated"><code class="fe ns nt nu mx b">AUTH0_ISSUER_BASE_URL</code>:您的Auth0租户域的URL。如果您正在使用带有Auth0  的<a class="ae ku" href="https://auth0.com/docs/custom-domains" rel="noopener ugc nofollow" target="_blank"> <strong class="jx io">自定义域，请将其设置为您的自定义域的值，而不是“设置”选项卡中反映的值。</strong></a></li><li id="245d" class="lz ma in jx b jy mk kc ml kg mm kk mn ko mo ks mg mh mi mj bi translated"><code class="fe ns nt nu mx b">AUTH0_CLIENT_ID</code>:您的Auth0应用的客户端ID。</li><li id="29ea" class="lz ma in jx b jy mk kc ml kg mm kk mn ko mo ks mg mh mi mj bi translated"><code class="fe ns nt nu mx b">AUTH0_CLIENT_SECRET</code>:你的Auth0应用的客户端机密。</li></ul><p id="f9ff" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">此时，我们的Auth0 Next.js SDK已经完全配置好，可以在我们的应用程序中使用了。</p><p id="a7c1" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><strong class="jx io">注意:这个新文件不应该被你的版本控制软件版本化。</strong></p><h2 id="a981" class="nb lc in bd ld nh ni dn lh nj nk dp ll kg nl nm lp kk nn no lt ko np nq lx nr bi translated">添加动态API路由</h2><p id="2bc7" class="pw-post-body-paragraph jv jw in jx b jy mb ka kb kc mc ke kf kg mp ki kj kk mq km kn ko mr kq kr ks ig bi translated">下一步是在我们的项目中添加一个动态API路由，自动创建一系列路由，这些路由将被映射到处理每个单独操作的特定SDK方法。</p><p id="175f" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">在<code class="fe ns nt nu mx b">pages/api</code>目录中，创建一个新的<code class="fe ns nt nu mx b">auth</code>目录，并在其中创建一个<code class="fe ns nt nu mx b">[...auth0].js</code>文件。在文件中导入来自SDK的<code class="fe ns nt nu mx b">handleAuth</code>方法，并导出调用它的结果。</p><figure class="ms mt mu mv gt jo"><div class="bz fp l di"><div class="nv nw l"/></div></figure><p id="0ca8" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">这将创建以下路线:</p><ul class=""><li id="8326" class="lz ma in jx b jy jz kc kd kg ob kk oc ko od ks mg mh mi mj bi translated"><code class="fe ns nt nu mx b">/api/auth/login</code>:使用Auth0进行登录的路径。</li><li id="dd39" class="lz ma in jx b jy mk kc ml kg mm kk mn ko mo ks mg mh mi mj bi translated"><code class="fe ns nt nu mx b">/api/auth/logout</code>:用户退出的路径。</li><li id="7c1e" class="lz ma in jx b jy mk kc ml kg mm kk mn ko mo ks mg mh mi mj bi translated"><code class="fe ns nt nu mx b">/api/auth/callback</code>:成功登录后，路由Auth0会将用户重定向到。</li><li id="402b" class="lz ma in jx b jy mk kc ml kg mm kk mn ko mo ks mg mh mi mj bi translated"><code class="fe ns nt nu mx b">/api/auth/me</code>:获取用户配置文件的路径。</li></ul><h2 id="eb22" class="nb lc in bd ld nh ni dn lh nj nk dp ll kg nl nm lp kk nn no lt ko np nq lx nr bi translated">添加UserProvider组件</h2><p id="b285" class="pw-post-body-paragraph jv jw in jx b jy mb ka kb kc mc ke kf kg mp ki kj kk mq km kn ko mr kq kr ks ig bi translated">在前端，SDK将使用<em class="kt"> React Context </em>来管理用户的认证状态。为了让所有页面都可以使用这个状态，我们覆盖了基础的<em class="kt"> App </em>组件，并用一个<code class="fe ns nt nu mx b">UserProvider</code>包装它的内部组件。这样，应用程序中的所有组件都可以访问身份验证<em class="kt">上下文</em>，并提供<em class="kt">挂钩</em>，这在以后会很方便。</p><p id="1481" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">您的<code class="fe ns nt nu mx b">/pages/_app.js</code>现在应该是这样的:</p><figure class="ms mt mu mv gt jo"><div class="bz fp l di"><div class="nv nw l"/></div></figure><h1 id="aec9" class="lb lc in bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">使用Auth0 Next.js SDK</h1><p id="329c" class="pw-post-body-paragraph jv jw in jx b jy mb ka kb kc mc ke kf kg mp ki kj kk mq km kn ko mr kq kr ks ig bi translated">现在我们已经完成了Auth0项目及其Next.js特定SDK的设置，剩下要做的就是使用它了！现在，让我们来看看如何做到这一点。</p><h2 id="21e4" class="nb lc in bd ld nh ni dn lh nj nk dp ll kg nl nm lp kk nn no lt ko np nq lx nr bi translated">登录用户</h2><p id="b822" class="pw-post-body-paragraph jv jw in jx b jy mb ka kb kc mc ke kf kg mp ki kj kk mq km kn ko mr kq kr ks ig bi translated">用户现在可以通过访问SDK提供的<code class="fe ns nt nu mx b">/api/auth/login</code>路径登录到您的应用程序。在我们的<code class="fe ns nt nu mx b">Navbar</code>组件中，让我们使用锚标记添加一个链接到您的登录路径。</p><figure class="ms mt mu mv gt jo"><div class="bz fp l di"><div class="nv nw l"/></div></figure><p id="ded2" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">现在，如果用户点击<code class="fe ns nt nu mx b">Navbar</code>上的<strong class="jx io"> <em class="kt">登录</em> </strong>按钮，他或她将被重定向到我们应用的Auth0登录屏幕，这有多神奇？！</p><p id="76e1" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">在用户注册或使用用户名和密码使用现有帐户或任何提供和启用的社交提供者进行身份验证后，Auth0将重定向回您的应用程序。</p><figure class="ms mt mu mv gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi oi"><img src="../Images/92a95b75fc6ad1094a086be981eecefa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*zzH_-gw3UR7aFtmm"/></div></div></figure><h2 id="50f8" class="nb lc in bd ld nh ni dn lh nj nk dp ll kg nl nm lp kk nn no lt ko np nq lx nr bi translated">注销用户</h2><p id="ef7f" class="pw-post-body-paragraph jv jw in jx b jy mb ka kb kc mc ke kf kg mp ki kj kk mq km kn ko mr kq kr ks ig bi translated">现在我们知道了如何登录用户，让我们看看如何注销他们。</p><p id="d77a" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">要做到这一点，首先，我们需要知道是否有用户通过了身份验证，以便知道我们显示的是<em class="kt">登录</em>按钮还是<em class="kt">注销</em>按钮。</p><p id="ab51" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">使用由Auth0 Next.js SDK管理的<em class="kt">用户上下文</em>,我们可以通过SDK提供的<code class="fe ns nt nu mx b">useUser</code>钩子轻松获得这些信息。这个钩子提供了关于<em class="kt">用户上下文</em>当前状态的不同信息，但是，对于这个场景，我们只需要知道上下文中是否有一个<code class="fe ns nt nu mx b">user</code>，如果有，显示一个<em class="kt">注销</em>按钮。</p><p id="e520" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">如下更新您的<code class="fe ns nt nu mx b">Navbar</code>组件。</p><figure class="ms mt mu mv gt jo"><div class="bz fp l di"><div class="nv nw l"/></div></figure><p id="01ac" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">现在，如果用户出现在应用程序<em class="kt">用户上下文</em>中，我们将显示一个<em class="kt">注销</em>按钮，该按钮将用户重定向到<code class="fe ns nt nu mx b">/api/auth/logout</code>路由，该路由由SDK处理，并将自动采取所有必要的措施来删除用户的活动会话。</p><h2 id="71a1" class="nb lc in bd ld nh ni dn lh nj nk dp ll kg nl nm lp kk nn no lt ko np nq lx nr bi translated">访问用户配置文件信息</h2><p id="451d" class="pw-post-body-paragraph jv jw in jx b jy mb ka kb kc mc ke kf kg mp ki kj kk mq km kn ko mr kq kr ks ig bi translated">因为我们已经知道，为了验证当前是否有登录的用户，我们可以检查SDK提供的<code class="fe ns nt nu mx b">useUser</code>钩子中的<code class="fe ns nt nu mx b">user</code>属性的存在，我们已经拥有了访问用户本身所需的所有信息，因为所有可用的用户信息都包含在该属性中。</p><p id="3b78" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">除了<code class="fe ns nt nu mx b">user</code>属性，<code class="fe ns nt nu mx b">useUser</code>钩子还导出了其他属性，比如<code class="fe ns nt nu mx b">error</code>和<code class="fe ns nt nu mx b">isLoading</code>，这样我们就可以更好地控制上下文的当前状态。</p><p id="edd9" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">让我们创建一个简单的页面，在这里我们可以检查当前用户的可用信息。姑且称之为<code class="fe ns nt nu mx b">Profile</code>。</p><p id="7a3a" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">在<code class="fe ns nt nu mx b">/pages</code>文件夹中新建一个<code class="fe ns nt nu mx b">profile.js</code>文件，粘贴以下内容。</p><figure class="ms mt mu mv gt jo"><div class="bz fp l di"><div class="nv nw l"/></div></figure><p id="0795" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">现在让我们在<code class="fe ns nt nu mx b">Navbar</code>中添加一个新按钮，这样我们就可以很容易地进入这个页面。<em class="kt">该按钮仅在有登录用户时显示。</em></p><p id="e7c2" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">用以下内容更新<code class="fe ns nt nu mx b">Navbar</code>组件:</p><figure class="ms mt mu mv gt jo"><div class="bz fp l di"><div class="nv nw l"/></div></figure><p id="abc9" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">现在，如果用户登录，他或她将能够在Auth0服务中访问他们自己的个人资料以及他们所有的注册信息！</p><figure class="ms mt mu mv gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi oj"><img src="../Images/6aaf9b170db647da4949df2a414c3c21.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*MYSkEqVttIOCrQCB"/></div></div></figure><h2 id="dc73" class="nb lc in bd ld nh ni dn lh nj nk dp ll kg nl nm lp kk nn no lt ko np nq lx nr bi translated">保护页面</h2><p id="e498" class="pw-post-body-paragraph jv jw in jx b jy mb ka kb kc mc ke kf kg mp ki kj kk mq km kn ko mr kq kr ks ig bi translated">为了保护页面不被未登录的用户访问，Auth0 Next.js SDK页面还提供了一些功能来为您处理这些问题。因此，让我们保护我们的<em class="kt">个人资料</em>页面，因为如果没有用户显示个人资料，它应该是不可访问的。</p><p id="4d72" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">我们需要应用的主要变化是，我们的页面组件现在应该由SDK方法<code class="fe ns nt nu mx b">withPageAuthRequired</code>导出的<em class="kt">高阶组件(HOC) </em>返回。</p><p id="da94" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">这也将为我们的页面组件提供作为<em class="kt">道具</em>的<em class="kt">用户上下文</em>的状态。所以我们可以通过<em class="kt">属性</em>直接访问<code class="fe ns nt nu mx b">user</code>、<code class="fe ns nt nu mx b">error</code>和<code class="fe ns nt nu mx b">isLoading</code>属性，但是我们仍然可以从组件内部访问上下文，所以如果我们愿意，我们也可以使用<code class="fe ns nt nu mx b">useUser</code>钩子。</p><p id="72bf" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">您的<code class="fe ns nt nu mx b">Profile</code>组件现在应该看起来像这样:</p><figure class="ms mt mu mv gt jo"><div class="bz fp l di"><div class="nv nw l"/></div></figure><p id="63a2" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><strong class="jx io">注意:SSR页面和CSR页面的主要区别在于，在SSR页面上，</strong> <code class="fe ns nt nu mx b"><strong class="jx io">getServerSideProps</strong></code> <strong class="jx io">方法应该返回HOC本身。</strong></p><pre class="ms mt mu mv gt mw mx my mz aw na bi"><span id="fad5" class="nb lc in mx b gy nc nd l ne nf">export const getServerSideProps = withPageAuthRequired();</span></pre><h1 id="e5ed" class="lb lc in bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">恭喜你！</h1><p id="fe2b" class="pw-post-body-paragraph jv jw in jx b jy mb ka kb kc mc ke kf kg mp ki kj kk mq km kn ko mr kq kr ks ig bi translated">如果您已经做到了这一步，那么您应该已经有了一个功能正常的Next.js应用程序，它只需要几行代码就可以实现一个安全可靠的身份验证系统。</p><p id="16e2" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">如果你遇到任何麻烦，请随时通过我的推特个人资料联系我，我很乐意帮忙。</p></div></div>    
</body>
</html>