<html>
<head>
<title>Add Segment &amp; Google Analytics to your TypeScript Next.js App</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">将Segment &amp; Google Analytics添加到您的TypeScript Next.js应用程序</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/add-segment-google-analytics-to-your-typescript-next-js-app-af9fc7cd83a9?source=collection_archive---------1-----------------------#2022-04-14">https://javascript.plainenglish.io/add-segment-google-analytics-to-your-typescript-next-js-app-af9fc7cd83a9?source=collection_archive---------1-----------------------#2022-04-14</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><div class=""><h2 id="afad" class="pw-subtitle-paragraph jk im in bd b jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb dk translated">第1部分:将Segment和Google Analytics与您的TypeScript Next.js应用程序集成的教程。</h2></div><p id="5c83" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">没有关于使用Segment和Google Analytics创建TypeScript Next.js站点的教程或示例，所以我破解了它并编写了一个分步教程。这种实现可能效率低下或者大错特错— <em class="ky">但它确实有效</em>。</p><figure class="la lb lc ld gt le gh gi paragraph-image"><div role="button" tabindex="0" class="lf lg di lh bf li"><div class="gh gi kz"><img src="../Images/05ff8c5fa13fb42666ceff3724a2aec8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BqHFTxRV9zPGqfFxK6J2gQ.png"/></div></div></figure><h1 id="621f" class="ll lm in bd ln lo lp lq lr ls lt lu lv jt lw ju lx jw ly jx lz jz ma ka mb mc bi translated">在开始之前</h1><p id="44f8" class="pw-post-body-paragraph kc kd in ke b kf md jo kh ki me jr kk kl mf kn ko kp mg kr ks kt mh kv kw kx ig bi translated">首先，如果你像我一样是数据收集新手，请阅读<a class="ae mi" href="https://segment.com/academy/" rel="noopener ugc nofollow" target="_blank">分部学院文档</a>。</p><p id="312b" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">我们将使用Segment的<a class="ae mi" href="https://segment.com/docs/connections/sources/catalog/libraries/website/javascript/" rel="noopener ugc nofollow" target="_blank"> Analytics.js 2.0 source </a> —一个javascript库，为javascript网站提供基本的跟踪方法。(移动应用和服务器端跟踪有不同的库)。</p><p id="8266" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">您可以查看<a class="ae mi" href="https://segment.com/docs/connections/spec/" rel="noopener ugc nofollow" target="_blank">跟踪规范</a>了解每种跟踪方法的详细描述。</p><p id="41b1" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">您将需要一组标准的事件&amp;您想要发送给它们的属性。如果你的营销团队为你制定了一个活动跟踪计划——很好，如果没有的话——没问题，你可以想出来。</p><blockquote class="mj mk ml"><p id="0c84" class="kc kd ky ke b kf kg jo kh ki kj jr kk mm km kn ko mn kq kr ks mo ku kv kw kx ig bi translated">创建事件跟踪计划:</p><p id="6be3" class="kc kd ky ke b kf kg jo kh ki kj jr kk mm km kn ko mn kq kr ks mo ku kv kw kx ig bi translated">1.你的商业目标是什么？KPI？(例如，用户对x感到兴奋)</p><p id="0c33" class="kc kd ky ke b kf kg jo kh ki kj jr kk mm km kn ko mn kq kr ks mo ku kv kw kx ig bi translated">2.什么样的用户流将表明每个目标的成功或失败？(例如，用户访问页面，然后用户加入电子邮件列表)</p><p id="c212" class="kc kd ky ke b kf kg jo kh ki kj jr kk mm km kn ko mn kq kr ks mo ku kv kw kx ig bi translated">3.什么样的奇异事件构成了这些流动？(例如page_view:“登录页面”，event_name:“用户订阅”)</p></blockquote><figure class="la lb lc ld gt le gh gi paragraph-image"><div role="button" tabindex="0" class="lf lg di lh bf li"><div class="gh gi mp"><img src="../Images/efade7374e0870aa52308171d2ead2b3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*C6JjgoxcjK67tgBkh6J9kw.png"/></div></div><figcaption class="mq mr gj gh gi ms mt bd b be z dk">Example of a simple Event Tracking Plan</figcaption></figure><h1 id="e386" class="ll lm in bd ln lo lp lq lr ls lt lu lv jt lw ju lx jw ly jx lz jz ma ka mb mc bi translated">设置细分市场</h1><p id="362f" class="pw-post-body-paragraph kc kd in ke b kf md jo kh ki me jr kk kl mf kn ko kp mg kr ks kt mh kv kw kx ig bi translated">进入您的细分工作区，创建一个新的Javascript网站源。</p><figure class="la lb lc ld gt le gh gi paragraph-image"><div role="button" tabindex="0" class="lf lg di lh bf li"><div class="gh gi mu"><img src="../Images/997e51a8795d74491ea0ec4ef79578cb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HK_0k3884xY7OJDy4uQIgA.png"/></div></div><figcaption class="mq mr gj gh gi ms mt bd b be z dk">Example of a newly created Javascript Website Source</figcaption></figure><p id="e6cb" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">您可以使用提供的脚本段来呈现analytics.js片段，或者安装这个将使您的代码更干净的包。</p><pre class="la lb lc ld gt mv mw mx my aw mz bi"><span id="a394" class="na lm in mw b gy nb nc l nd ne">yarn add @segment/snippet</span></pre><p id="5221" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">将您的段写键存储在您的env文件中——确保您的env变量名带有NEXT_PUBLIC前缀，以便我们可以在我们的客户端页面和组件中访问它。</p><pre class="la lb lc ld gt mv mw mx my aw mz bi"><span id="e2e2" class="na lm in mw b gy nb nc l nd ne">// @ .env or .env.local</span><span id="d433" class="na lm in mw b gy nf nc l nd ne">NEXT_PUBLIC_SEGMENT_WRITE_KEY=&lt;your write key here&gt;</span></pre><p id="c225" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">在custom _app.tsx文件中初始化您的脚本—这将在您的浏览器窗口中创建一个全局分析对象。</p><figure class="la lb lc ld gt le"><div class="bz fp l di"><div class="ng nh l"/></div></figure><p id="6b73" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><strong class="ke io">注意:</strong>我将page设置为false，因为我想自己手动调用page()(您将在本文后面的useEffect()中看到)。如果需要，将页面保留为默认页面。</p><h1 id="85f1" class="ll lm in bd ln lo lp lq lr ls lt lu lv jt lw ju lx jw ly jx lz jz ma ka mb mc bi translated">跟踪页面浏览量和事件</h1><p id="f6c1" class="pw-post-body-paragraph kc kd in ke b kf md jo kh ki me jr kk kl mf kn ko kp mg kr ks kt mh kv kw kx ig bi translated">你需要<a class="ae mi" href="https://segment.com/academy/collecting-data/naming-conventions-for-clean-data/" rel="noopener ugc nofollow" target="_blank">标准化的事件名称</a>来确保你的分析保持干净和准确。如果没有人给你一个事件跟踪计划，你可以创建自己的事件列表。</p><p id="5f60" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><strong class="ke io">跟踪页面浏览量</strong></p><p id="22c3" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">您可以向每个页面添加一个page({})调用，也可以在your _app.tsx中添加一次，Typescript会抓狂，因为浏览器窗口类型不包含analytics对象，所以我们会忽略它。</p><pre class="la lb lc ld gt mv mw mx my aw mz bi"><span id="3618" class="na lm in mw b gy nb nc l nd ne">// @ _app.tsx</span><span id="2958" class="na lm in mw b gy nf nc l nd ne">useEffect(() <em class="ky">=&gt;</em> {<br/> // @ts-ignore<br/> window?.analytics?.page(Component.displayName)<br/>}, [])</span></pre><p id="c058" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">注意:要使用Component.displayName，您必须向每个导出的页面组件添加一个displayName。</p><pre class="la lb lc ld gt mv mw mx my aw mz bi"><span id="a4a1" class="na lm in mw b gy nb nc l nd ne">export default <em class="ky">function</em> SamplePage() {...}</span><span id="c664" class="na lm in mw b gy nf nc l nd ne">SamplePage.displayName = "Sample Page"</span></pre><p id="59c5" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><strong class="ke io">声明您的事件名称常量</strong></p><p id="97e9" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">创建事件跟踪计划后，我将事件名称转换成一个单独文件中的常量字典。这是为了避免我的组件中的错别字。我还对页面名、对象名以及我希望在数据收集中保持一致的任何其他内容进行了同样的处理。</p><pre class="la lb lc ld gt mv mw mx my aw mz bi"><span id="0e56" class="na lm in mw b gy nb nc l nd ne">// @ eventNames.ts</span><span id="f1e9" class="na lm in mw b gy nf nc l nd ne">export <em class="ky">const</em> EVENT_NAMES = {<br/> NEWSLETTER_SUBSCRIBED: "Newsletter Subscribed",<br/> USER_LOGGED_IN: "User Logged In",<br/> USER_LOGGED_OUT: "User Logged Out",<br/> USER_SIGNED_UP: "User Signed Up",<br/>};</span></pre><p id="8a5c" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><strong class="ke io">追踪事件</strong></p><p id="a48b" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">我在一个不同的文件中声明了我的跟踪事件——主要是为了把我的ts忽略放在一个地方。</p><figure class="la lb lc ld gt le"><div class="bz fp l di"><div class="ng nh l"/></div></figure><p id="7fd9" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">在任何地方添加你的跟踪事件函数，比如点击按钮，表单提交，回调函数等等。</p><pre class="la lb lc ld gt mv mw mx my aw mz bi"><span id="d89d" class="na lm in mw b gy nb nc l nd ne">// example code</span><span id="89e5" class="na lm in mw b gy nf nc l nd ne">const handleSubmit = (email: string) =&gt; {<br/> axios.post(&lt;endpoint&gt;, { email: email })<br/>  .then((res: AxiosResponse) =&gt; <br/>    trackNewsletterSubscribed({email: email})<br/>  ).catch((err: AxiosError | any) =&gt;<br/>    setShowError(true)<br/>  )<br/>}</span></pre><p id="ef2a" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><strong class="ke io">跟踪识别</strong></p><p id="cf15" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">我不打算详细介绍，但我会在用户登录或创建帐户后跟踪这个事件。</p><h1 id="15f7" class="ll lm in bd ln lo lp lq lr ls lt lu lv jt lw ju lx jw ly jx lz jz ma ka mb mc bi translated">检查它是否工作</h1><p id="f35f" class="pw-post-body-paragraph kc kd in ke b kf md jo kh ki me jr kk kl mf kn ko kp mg kr ks kt mh kv kw kx ig bi translated">转到<strong class="ke io">调试器</strong>选项卡，查看您站点的实时输出。您可以在调试器页面的右侧看到事件、属性、上下文、IP地址、设备信息等等。</p><figure class="la lb lc ld gt le gh gi paragraph-image"><div role="button" tabindex="0" class="lf lg di lh bf li"><div class="gh gi ni"><img src="../Images/310e302ddb5d7980a7834ba682bc6ca7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vgfsylUeOuupzF94hY1DOw.png"/></div></div><figcaption class="mq mr gj gh gi ms mt bd b be z dk">Example of the Debugger Tab</figcaption></figure><p id="5263" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">一个警告是，你可能会注意到“referrer”不会填充SPAs，因此无论何时你使用Next Link(而不是<a> </a>)或Next Router，referrer都不会被填充。</p><h1 id="0cee" class="ll lm in bd ln lo lp lq lr ls lt lu lv jt lw ju lx jw ly jx lz jz ma ka mb mc bi translated"><strong class="ak">感谢阅读！</strong></h1><p id="ba7c" class="pw-post-body-paragraph kc kd in ke b kf md jo kh ki me jr kk kl mf kn ko kp mg kr ks kt mh kv kw kx ig bi translated">本文的Google分析教程(第2部分)将很快上线——请关注我的更新，或者稍后再回来查看。</p><p id="f19d" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">请随时留下关于如何改进这些步骤或代码的评论。</p><p id="4080" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><em class="ky">更多内容看</em> <a class="ae mi" href="https://plainenglish.io/" rel="noopener ugc nofollow" target="_blank"> <strong class="ke io"> <em class="ky">说白了。报名参加我们的</em> <a class="ae mi" href="http://newsletter.plainenglish.io/" rel="noopener ugc nofollow" target="_blank"> <strong class="ke io"> <em class="ky">免费周报</em> </strong> </a> <em class="ky">。关注我们</em><a class="ae mi" href="https://twitter.com/inPlainEngHQ" rel="noopener ugc nofollow" target="_blank"><strong class="ke io"><em class="ky">Twitter</em></strong></a><em class="ky">和</em><a class="ae mi" href="https://www.linkedin.com/company/inplainenglish/" rel="noopener ugc nofollow" target="_blank"><strong class="ke io"><em class="ky">LinkedIn</em></strong></a><em class="ky">。加入我们的</em> <a class="ae mi" href="https://discord.gg/GtDtUAvyhW" rel="noopener ugc nofollow" target="_blank"> <strong class="ke io"> <em class="ky">社区</em> </strong> </a> <em class="ky">。</em></strong></a></p></div></div>    
</body>
</html>