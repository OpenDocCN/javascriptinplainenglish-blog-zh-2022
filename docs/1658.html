<html>
<head>
<title>How to Encrypt Fields with Mongoose Methods and Plugins</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何用Mongoose方法和插件加密字段</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/encrypt-fields-with-mongoose-method-and-plugin-7c2452263e2d?source=collection_archive---------3-----------------------#2022-04-09">https://javascript.plainenglish.io/encrypt-fields-with-mongoose-method-and-plugin-7c2452263e2d?source=collection_archive---------3-----------------------#2022-04-09</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><div class=""><h2 id="a855" class="pw-subtitle-paragraph jk im in bd b jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb dk translated">关于我们如何使用mongoose方法来管理需要加密或解密的密码或类似密码的字段的指南。</h2></div><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi kc"><img src="../Images/d947e805269fbb3da6c3463b101f88ea.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*fgobtslk87-T8d6Y"/></div></div><figcaption class="ko kp gj gh gi kq kr bd b be z dk">Photo by <a class="ae ks" href="https://unsplash.com/@markusspiske?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Markus Spiske</a> on <a class="ae ks" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><h1 id="a823" class="kt ku in bd kv kw kx ky kz la lb lc ld jt le ju lf jw lg jx lh jz li ka lj lk bi translated">用猫鼬管理密码</h1><p id="3720" class="pw-post-body-paragraph ll lm in ln b lo lp jo lq lr ls jr lt lu lv lw lx ly lz ma mb mc md me mf mg ig bi translated">在本文中，我们将关注如何使用mongoose方法来管理需要根据需要加密或解密的密码或类似密码的字段。</p><p id="d3f2" class="pw-post-body-paragraph ll lm in ln b lo mh jo lq lr mi jr lt lu mj lw lx ly mk ma mb mc ml me mf mg ig bi translated">用例的总体思路是创建一个mongoose方法来比较密码，并在我们保存密码时使用一个钩子来加密密码。</p><h2 id="504f" class="mm ku in bd kv mn mo dn kz mp mq dp ld lu mr ms lf ly mt mu lh mc mv mw lj mx bi translated">开始</h2><p id="6bcd" class="pw-post-body-paragraph ll lm in ln b lo lp jo lq lr ls jr lt lu lv lw lx ly lz ma mb mc md me mf mg ig bi translated">让我们创建一个身份验证模式，它将包含两个具有理想属性的字段电子邮件和密码</p><p id="332d" class="pw-post-body-paragraph ll lm in ln b lo mh jo lq lr mi jr lt lu mj lw lx ly mk ma mb mc ml me mf mg ig bi translated"><strong class="ln io">导入必要的模块:</strong></p><pre class="kd ke kf kg gt my mz na nb aw nc bi"><span id="e675" class="mm ku in mz b gy nd ne l nf ng">const mongoose = require("mongoose");</span><span id="c756" class="mm ku in mz b gy nh ne l nf ng">const bcrypt = require("bcrypt");</span><span id="a848" class="mm ku in mz b gy nh ne l nf ng">const { Schema } = mongoose;</span><span id="7f96" class="mm ku in mz b gy nh ne l nf ng">const SALT_WORK_FACTOR = 10;</span></pre><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div class="gh gi ni"><img src="../Images/05a89d16e681bd32518b149aa3508c64.png" data-original-src="https://miro.medium.com/v2/resize:fit:944/format:webp/1*ueKeiiAdOjA1u78aws6gTA.png"/></div><figcaption class="ko kp gj gh gi kq kr bd b be z dk">Auth.js</figcaption></figure><p id="a949" class="pw-post-body-paragraph ll lm in ln b lo mh jo lq lr mi jr lt lu mj lw lx ly mk ma mb mc ml me mf mg ig bi translated"><strong class="ln io">创建一个钩子</strong></p><p id="dd08" class="pw-post-body-paragraph ll lm in ln b lo mh jo lq lr mi jr lt lu mj lw lx ly mk ma mb mc ml me mf mg ig bi translated">现在，让我们创建一个钩子在保存密码的同时加密密码。在预保存挂钩中，只有一个参数，即基于条件逻辑触发的下一个回调。<code class="fe nj nk nl mz b">next</code>是第一个错误回调，其中第一个参数是一个错误。在数据的情况下，数据可以作为setter直接附加到这个实例上，因此根据模型的思想，每个字段都有自己的getter和setter。</p><p id="99eb" class="pw-post-body-paragraph ll lm in ln b lo mh jo lq lr mi jr lt lu mj lw lx ly mk ma mb mc ml me mf mg ig bi translated">在这里，如果密码字段未被修改，我们将让用户通过，但如果被修改，我们将为此创建一个哈希，并通过每次生成一个新的salt，将其附加到保存在用户变量中的这个实例。</p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div class="gh gi nm"><img src="../Images/b93ff95256acd3d70d59f41564d7a538.png" data-original-src="https://miro.medium.com/v2/resize:fit:1394/format:webp/1*WCXaB4J0qUif4t8SB-8vFA.png"/></div><figcaption class="ko kp gj gh gi kq kr bd b be z dk">pre-save hook</figcaption></figure><p id="e3de" class="pw-post-body-paragraph ll lm in ln b lo mh jo lq lr mi jr lt lu mj lw lx ly mk ma mb mc ml me mf mg ig bi translated"><strong class="ln io">创建一个方法</strong></p><p id="46f8" class="pw-post-body-paragraph ll lm in ln b lo mh jo lq lr mi jr lt lu mj lw lx ly mk ma mb mc ml me mf mg ig bi translated">将会有一个用例，您可能想要获取解密的数据或比较输入是否与加密版本相同，然后我们可以创建一个mongoose方法，通过向它添加自定义逻辑来实现这个目的。</p><p id="e731" class="pw-post-body-paragraph ll lm in ln b lo mh jo lq lr mi jr lt lu mj lw lx ly mk ma mb mc ml me mf mg ig bi translated">要创建一个方法，我们可以将已经可用的方法对象用于所有模式，并将自定义方法附加到它上面。用ES5语法保留方法的未命名函数，否则它将无法在这个实例中持久化。</p><p id="056e" class="pw-post-body-paragraph ll lm in ln b lo mh jo lq lr mi jr lt lu mj lw lx ly mk ma mb mc ml me mf mg ig bi translated">不要使用arrow方法，因为它不会持久化<code class="fe nj nk nl mz b">this</code>实例。</p><p id="d0a8" class="pw-post-body-paragraph ll lm in ln b lo mh jo lq lr mi jr lt lu mj lw lx ly mk ma mb mc ml me mf mg ig bi translated">在下面的函数中，我们获取参数，并使用bcrypt将它与存储在数据库中的参数进行比较，然后返回基于匹配状态的布尔值。</p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi nn"><img src="../Images/455c58d7c1f46dd93271b5373adde940.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*s6tgQil_XepyOsDNPCSBNA.png"/></div></div><figcaption class="ko kp gj gh gi kq kr bd b be z dk">custom mongoose method to compare</figcaption></figure><h2 id="76ff" class="mm ku in bd kv mn mo dn kz mp mq dp ld lu mr ms lf ly mt mu lh mc mv mw lj mx bi translated">测试</h2><p id="3ef9" class="pw-post-body-paragraph ll lm in ln b lo lp jo lq lr ls jr lt lu lv lw lx ly lz ma mb mc md me mf mg ig bi translated">为了测试我们构建的版本，我们可以创建任何小应用程序或在任何可用的应用程序中进行测试。</p><p id="b897" class="pw-post-body-paragraph ll lm in ln b lo mh jo lq lr mi jr lt lu mj lw lx ly mk ma mb mc ml me mf mg ig bi translated">在本例中，我们传递密码字段，但不对其进行哈希处理，但是在保存该字段时，我们的预保存钩子将被触发，它会将该字段的哈希存储在数据库中。</p><p id="8c8a" class="pw-post-body-paragraph ll lm in ln b lo mh jo lq lr mi jr lt lu mj lw lx ly mk ma mb mc ml me mf mg ig bi translated">在下一行中，我们使用刚刚创建的自定义方法来比较输入密码是否与存储的密码相同。</p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi no"><img src="../Images/854995b63749f7fff5c785c14fc58904.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lpR3kJGbRUwvsD7DcZt5jQ.png"/></div></div><figcaption class="ko kp gj gh gi kq kr bd b be z dk">test case for the above scenarios</figcaption></figure><pre class="kd ke kf kg gt my mz na nb aw nc bi"><span id="fb1f" class="mm ku in mz b gy nd ne l nf ng">Output<br/>- false<br/>- true</span></pre><p id="85f3" class="pw-post-body-paragraph ll lm in ln b lo mh jo lq lr mi jr lt lu mj lw lx ly mk ma mb mc ml me mf mg ig bi translated">由于我们在第一次检查时传递了错误的密码，下面方法的输出将是false，然后是true。</p><h2 id="83a1" class="mm ku in bd kv mn mo dn kz mp mq dp ld lu mr ms lf ly mt mu lh mc mv mw lj mx bi translated">如何让这个全球化</h2><p id="d810" class="pw-post-body-paragraph ll lm in ln b lo lp jo lq lr ls jr lt lu lv lw lx ly lz ma mb mc md me mf mg ig bi translated">为了使一个方法是全局的，并且能够访问所有的模式，我们需要使用<a class="ae ks" href="https://mongoosejs.com/docs/plugins.html" rel="noopener ugc nofollow" target="_blank">mongose插件</a>。</p><p id="e7ac" class="pw-post-body-paragraph ll lm in ln b lo mh jo lq lr mi jr lt lu mj lw lx ly mk ma mb mc ml me mf mg ig bi translated"><strong class="ln io">创建一个插件</strong></p><p id="66ea" class="pw-post-body-paragraph ll lm in ln b lo mh jo lq lr mi jr lt lu mj lw lx ly mk ma mb mc ml me mf mg ig bi translated">要创建一个插件，我们可以创建一个包含以下内容的文件。在这里，我们首先必须用模式作为输入来定义对象实例。相同的模式将从子模式传递到插件。一旦我们有了模式，我们就可以放置我们用于密码散列的相同方法逻辑</p><p id="cd1f" class="pw-post-body-paragraph ll lm in ln b lo mh jo lq lr mi jr lt lu mj lw lx ly mk ma mb mc ml me mf mg ig bi translated">为了实现相同的功能，我们将其提取到self中，然后使用self作为对文档的引用来更新和获取字段。因为我们有了文档实例，所以我们也可以使用所有其他方法，比如<code class="fe nj nk nl mz b">save</code>来保存文档</p><p id="7222" class="pw-post-body-paragraph ll lm in ln b lo mh jo lq lr mi jr lt lu mj lw lx ly mk ma mb mc ml me mf mg ig bi translated">插件是独立于钩子的，可以用它们来定制。</p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi np"><img src="../Images/1b0449f71c79f8949b6da924ef680ff4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*SKLw6shWZN123M-iEQNgng.png"/></div></div><figcaption class="ko kp gj gh gi kq kr bd b be z dk">custom mongoose plugin</figcaption></figure><p id="842a" class="pw-post-body-paragraph ll lm in ln b lo mh jo lq lr mi jr lt lu mj lw lx ly mk ma mb mc ml me mf mg ig bi translated"><strong class="ln io">初始化一个插件</strong></p><p id="fb74" class="pw-post-body-paragraph ll lm in ln b lo mh jo lq lr mi jr lt lu mj lw lx ly mk ma mb mc ml me mf mg ig bi translated">要初始化插件，我们需要首先将它添加到模式中。</p><pre class="kd ke kf kg gt my mz na nb aw nc bi"><span id="482a" class="mm ku in mz b gy nd ne l nf ng">const hash = require("../plugin/hash");</span><span id="0274" class="mm ku in mz b gy nh ne l nf ng">/.../<br/>AuthSchema.plugin(hash);</span><span id="eea3" class="mm ku in mz b gy nh ne l nf ng">/../</span></pre><p id="b737" class="pw-post-body-paragraph ll lm in ln b lo mh jo lq lr mi jr lt lu mj lw lx ly mk ma mb mc ml me mf mg ig bi translated">为此，Auth collection中的所有文档都可以访问我们刚刚创建的自定义插件，我们可以按如下方式使用它:</p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div class="gh gi nq"><img src="../Images/2d7681fb6506263245fc66c51a5fb9da.png" data-original-src="https://miro.medium.com/v2/resize:fit:622/format:webp/1*rGDs3Xg_-CeZ9GmRpxS_Lg.png"/></div><figcaption class="ko kp gj gh gi kq kr bd b be z dk">hash fields</figcaption></figure><h2 id="cedc" class="mm ku in bd kv mn mo dn kz mp mq dp ld lu mr ms lf ly mt mu lh mc mv mw lj mx bi translated">结论</h2><p id="624a" class="pw-post-body-paragraph ll lm in ln b lo lp jo lq lr ls jr lt lu lv lw lx ly lz ma mb mc md me mf mg ig bi translated">希望现在您能理解如何在模式和全局级别上创建自定义方法，以便以更好的方式管理您的操作。</p><p id="4c39" class="pw-post-body-paragraph ll lm in ln b lo mh jo lq lr mi jr lt lu mj lw lx ly mk ma mb mc ml me mf mg ig bi translated">您可以在这里找到本文的源代码:</p><div class="nr ns gp gr nt nu"><a href="https://github.com/Piyush-Use-Personal/mongoose-plugin" rel="noopener  ugc nofollow" target="_blank"><div class="nv ab fo"><div class="nw ab nx cl cj ny"><h2 class="bd io gy z fp nz fr fs oa fu fw im bi translated">GitHub-Piyush-使用-个人/猫鼬-插件</h2><div class="ob l"><h3 class="bd b gy z fp nz fr fs oa fu fw dk translated">此时您不能执行该操作。您已使用另一个标签页或窗口登录。您已在另一个选项卡中注销，或者…</h3></div><div class="oc l"><p class="bd b dl z fp nz fr fs oa fu fw dk translated">github.com</p></div></div><div class="od l"><div class="oe l of og oh od oi km nu"/></div></div></a></div><p id="0a2c" class="pw-post-body-paragraph ll lm in ln b lo mh jo lq lr mi jr lt lu mj lw lx ly mk ma mb mc ml me mf mg ig bi translated">谢谢大家！</p><p id="eb35" class="pw-post-body-paragraph ll lm in ln b lo mh jo lq lr mi jr lt lu mj lw lx ly mk ma mb mc ml me mf mg ig bi translated"><em class="oj">更多内容看</em> <a class="ae ks" href="https://plainenglish.io/" rel="noopener ugc nofollow" target="_blank"> <strong class="ln io"> <em class="oj">说白了就是io </em> </strong> </a> <em class="oj">。报名参加我们的</em> <a class="ae ks" href="http://newsletter.plainenglish.io/" rel="noopener ugc nofollow" target="_blank"> <strong class="ln io"> <em class="oj">免费周报</em> </strong> </a> <em class="oj">。关注我们关于</em><a class="ae ks" href="https://twitter.com/inPlainEngHQ" rel="noopener ugc nofollow" target="_blank"><strong class="ln io"><em class="oj">Twitter</em></strong></a><em class="oj">和</em><strong class="ln io"><em class="oj"/></strong><a class="ae ks" href="https://www.linkedin.com/company/inplainenglish/" rel="noopener ugc nofollow" target="_blank"><strong class="ln io"><em class="oj">LinkedIn</em></strong></a><em class="oj">。加入我们的</em> <a class="ae ks" href="https://discord.gg/GtDtUAvyhW" rel="noopener ugc nofollow" target="_blank"> <strong class="ln io"> <em class="oj">社区</em> </strong> </a> <em class="oj">。</em></p></div></div>    
</body>
</html>