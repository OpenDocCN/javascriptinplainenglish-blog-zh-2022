<html>
<head>
<title>Create Custom Schema Field Types</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">创建自定义架构字段类型</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/create-custom-schema-field-types-4e432fce4b99?source=collection_archive---------21-----------------------#2022-01-12">https://javascript.plainenglish.io/create-custom-schema-field-types-4e432fce4b99?source=collection_archive---------21-----------------------#2022-01-12</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><div class=""><h2 id="a0ae" class="pw-subtitle-paragraph jk im in bd b jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb dk translated">关于如何在撇号3中创建自定义模式字段类型的指南。</h2></div><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi kc"><img src="../Images/616722ff3b8888ceab8b1fd271399dd3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*RQB-uViPwi3QxvNI.png"/></div></div></figure><p id="0a40" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">撇号的<a class="ae lk" href="https://v3.docs.apostrophecms.org/guide/content-schema.html" rel="noopener ugc nofollow" target="_blank">模式字段类型</a>涵盖了许多情况，但是我们可能希望添加一个新的。</p><p id="8921" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">架构字段有两个部分:服务器端部分和浏览器端部分。服务器端部分负责净化从浏览器接收的输入，而浏览器端部分负责提供管理UI。</p><h1 id="18b6" class="ll lm in bd ln lo lp lq lr ls lt lu lv jt lw ju lx jw ly jx lz jz ma ka mb mc bi translated">实现服务器端部分</h1><p id="badb" class="pw-post-body-paragraph ko kp in kq b kr md jo kt ku me jr kw kx mf kz la lb mg ld le lf mh lh li lj ig bi translated">任何模块都可以在服务器端注册一个模式字段类型，就像这样，它允许编辑设置1到5颗星的“星级”，这在电影和餐馆评论中很常见。</p><p id="8820" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">请注意，此代码可以在任何模块中。这里我们选择只为这个新的字段类型创建一个模块，因为它可能会在几个模块中使用。</p><pre class="kd ke kf kg gt mi mj mk ml aw mm bi"><span id="ed27" class="mn lm in mj b gy mo mp l mq mr">module.exports = {<br/>  <strong class="mj io">init</strong>(self) {<br/>    self.addStarRatingFieldType();<br/>  },<br/>  <strong class="mj io">methods</strong>(self) {<br/>    <strong class="mj io">return</strong> {<br/>      <strong class="mj io">addStarRatingFieldType</strong>() {<br/>        self.apos.schema.addFieldType({<br/>          name: 'starRating',<br/>          convert: self.convertInput,<br/>          vueComponent: 'InputStarRating'<br/>        });<br/>      },<br/>      <strong class="mj io">async</strong> <strong class="mj io">convertInput</strong>(req, field, data, object) {<br/>        <strong class="mj io">const</strong> input = data[field.name];<br/>        <strong class="mj io">if</strong> ((data[field.name] == null) || (data[field.name] === '')) {<br/>          <strong class="mj io">if</strong> (field.required) {<br/>            <strong class="mj io">throw</strong> self.apos.error('notfound');<br/>          }<br/>        }<br/>        object[field.name] = self.apos.launder.integer(input, field.def, 1, 5);<br/>      }<br/>    }<br/>  }<br/>}</span></pre><p id="1563" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">在模块初始化时运行的<code class="fe ms mt mu mj b">init</code>中，我们调用我们的<code class="fe ms mt mu mj b">addStarRatingFieldType</code>方法。<code class="fe ms mt mu mj b">init</code>是调用撇号进程启动时应该运行的代码的正确位置。</p><p id="1f85" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">在<code class="fe ms mt mu mj b">addStarRatingFieldType</code>中，我们调用<code class="fe ms mt mu mj b">self.apos.schema.addFieldType</code>在服务器端添加我们的自定义字段类型。我们提供:</p><ul class=""><li id="82b6" class="mv mw in kq b kr ks ku kv kx mx lb my lf mz lj na nb nc nd bi translated"><code class="fe ms mt mu mj b">name</code>，在将字段添加到模式时，可用作<code class="fe ms mt mu mj b">type</code>设置。</li><li id="7d88" class="mv mw in kq b kr ne ku nf kx ng lb nh lf ni lj na nb nc nd bi translated"><code class="fe ms mt mu mj b">convert</code>，用于净化输入并将其复制到目的地的函数。我们通过我们的<code class="fe ms mt mu mj b">convertInput</code>方法来达到这个目的。我们模块的方法可以作为<code class="fe ms mt mu mj b">self</code>的属性使用。</li><li id="ae73" class="mv mw in kq b kr ne ku nf kx ng lb nh lf ni lj na nb nc nd bi translated"><code class="fe ms mt mu mj b">component</code>，编辑字段时显示的Vue.js组件的名称。</li></ul><p id="f64b" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">在<code class="fe ms mt mu mj b">convertInput</code>中，我们整理输入并将其从<code class="fe ms mt mu mj b">data[field.name]</code>复制到<code class="fe ms mt mu mj b">object[field.name]</code>。由于我们不能信任浏览器，我们小心翼翼地用<a class="ae lk" href="https://npmjs.com/package/launder" rel="noopener ugc nofollow" target="_blank"/><code class="fe ms mt mu mj b"><a class="ae lk" href="https://npmjs.com/package/launder" rel="noopener ugc nofollow" target="_blank">launder</a></code><a class="ae lk" href="https://npmjs.com/package/launder" rel="noopener ugc nofollow" target="_blank">模块</a>来净化它，该模块总是作为<code class="fe ms mt mu mj b">apos.launder</code>可用。但是我们可以用任何我们喜欢的方式来验证输入，只要我们从不相信输入。</p><h1 id="6dc4" class="ll lm in bd ln lo lp lq lr ls lt lu lv jt lw ju lx jw ly jx lz jz ma ka mb mc bi translated">实现浏览器端部分</h1><p id="0a39" class="pw-post-body-paragraph ko kp in kq b kr md jo kt ku me jr kw kx mf kz la lb mg ld le lf mh lh li lj ig bi translated">在浏览器端，我们需要一个定制的Vue.js组件。撇号提供了一个Vue.js mixin，<code class="fe ms mt mu mj b">AposInputMixin</code>，它为我们做了很多工作。</p><pre class="kd ke kf kg gt mi mj mk ml aw mm bi"><span id="d85c" class="mn lm in mj b gy mo mp l mq mr">&lt;template&gt;<br/>  &lt;AposInputWrapper<br/>    :modifiers="modifiers" :field="field"<br/>    :error="effectiveError" :uid="uid"<br/>    :display-options="displayOptions"<br/>  &gt;<br/>    &lt;template #body&gt;<br/>      &lt;div class="apos-input-wrapper"&gt;<br/>        &lt;button v-for="index in 5" :key="index" @click="setValue(index)" class="rating"&gt;{{ isActive(index) ? '☆' : '★' }}&lt;/button&gt;<br/>        &lt;button class="clear" @click="clear"&gt;Clear&lt;/button&gt;<br/>      &lt;/div&gt;<br/>    &lt;/template&gt;<br/>  &lt;/AposInputWrapper&gt;<br/>&lt;/template&gt;</span><span id="ba45" class="mn lm in mj b gy nj mp l mq mr">&lt;script&gt;<br/><strong class="mj io">import</strong> AposInputMixin <strong class="mj io">from</strong> 'Modules/@apostrophecms/schema/mixins/AposInputMixin';</span><span id="8fc7" class="mn lm in mj b gy nj mp l mq mr"><strong class="mj io">export</strong> <strong class="mj io">default</strong> {<br/>  name: 'InputStarRating',<br/>  mixins: [ AposInputMixin ],<br/>  methods: {<br/>    <strong class="mj io">validate</strong>(value) {<br/>      <strong class="mj io">if</strong> (this.field.required) {<br/>        <strong class="mj io">if</strong> (!value) {<br/>          <strong class="mj io">return</strong> 'required';<br/>        }<br/>      }<br/>      <strong class="mj io">return</strong> false;<br/>    },<br/>    <strong class="mj io">setValue</strong>(index) {<br/>      this.next = index;<br/>    },<br/>    <strong class="mj io">clear</strong>() {<br/>      this.next = null;<br/>    },<br/>    <strong class="mj io">isActive</strong>(index) {<br/>      <strong class="mj io">return</strong> index &lt;= this.next;<br/>    }<br/>  }<br/>};<br/>&lt;/script&gt;</span><span id="06c2" class="mn lm in mj b gy nj mp l mq mr">&lt;style lang="scss" scoped&gt;<br/>  .rating {<br/>    border: none;<br/>    background-color: inherit;<br/>    color: inherit;<br/>    font-size: inherit;<br/>  }<br/>&lt;/style&gt;</span></pre><p id="2960" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">在我们的模板元素中，<code class="fe ms mt mu mj b">AposInputWrapper</code>负责用标签、错误消息等来修饰我们的字段。我们所要做的就是传递一些提供给我们的标准道具。除此之外，我们的责任是向用户显示当前的<code class="fe ms mt mu mj b">value</code>。我们还添加了事件处理程序来处理用户输入，如下所述。</p><p id="d452" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">在我们的脚本元素中，我们只有两项工作:每当值发生变化时，就给<code class="fe ms mt mu mj b">this.next</code>分配一个新值，并验证用户的输入。<code class="fe ms mt mu mj b">AposInputMixin</code>为我们做剩下的工作。</p><p id="de2f" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">为了更新<code class="fe ms mt mu mj b">this.next</code>，我们实现了响应点击事件的方法，如本例中的<code class="fe ms mt mu mj b">setValue</code>和<code class="fe ms mt mu mj b">clear</code>方法。为了验证用户的输入，我们实现了一个<code class="fe ms mt mu mj b">validate</code>方法，它接受当前值并检查约束，如字段的<code class="fe ms mt mu mj b">required</code>属性。如果有问题，我们返回一个错误代码如<code class="fe ms mt mu mj b">required</code>、<code class="fe ms mt mu mj b">min</code>或<code class="fe ms mt mu mj b">max</code>，否则，我们返回<code class="fe ms mt mu mj b">false</code>。现场配置可作为<code class="fe ms mt mu mj b">this.field</code>提供给我们。</p><p id="c6ec" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">元素负责这个组件的CSS。注意，SCSS语法是可用的。为了避免冲突，建议使用<code class="fe ms mt mu mj b">scoped</code>属性。</p><h1 id="662f" class="ll lm in bd ln lo lp lq lr ls lt lu lv jt lw ju lx jw ly jx lz jz ma ka mb mc bi translated">警告</h1><p id="a864" class="pw-post-body-paragraph ko kp in kq b kr md jo kt ku me jr kw kx mf kz la lb mg ld le lf mh lh li lj ig bi translated"><em class="nk">如果一开始似乎不起作用，请确保使用前面解释的</em> <code class="fe ms mt mu mj b"><em class="nk">APOS_DEV=1</em></code> <em class="nk">环境变量设置启动了</em> <code class="fe ms mt mu mj b"><em class="nk">npm run dev</em></code> <em class="nk">。这确保了撇号管理UI在每次代码更改时都会重新构建。当您更改完管理UI代码后，您可以停止使用它。</em></p><h1 id="365d" class="ll lm in bd ln lo lp lq lr ls lt lu lv jt lw ju lx jw ly jx lz jz ma ka mb mc bi translated">将新的模式字段类型投入使用</h1><p id="40c6" class="pw-post-body-paragraph ko kp in kq b kr md jo kt ku me jr kw kx mf kz la lb mg ld le lf mh lh li lj ig bi translated">现在，我们可以在任何片段或小部件中使用新的模式字段类型，就像我们使用<code class="fe ms mt mu mj b">integer</code>字段一样:</p><pre class="kd ke kf kg gt mi mj mk ml aw mm bi"><span id="8c0f" class="mn lm in mj b gy mo mp l mq mr">fields: {<br/>  add: {<br/>    rating: {<br/>      type: 'starRating',<br/>      label: 'Star Rating',<br/>      required: true<br/>    }<br/>  }<br/>}</span></pre><p id="2bf5" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">然后得到的值作为小部件的<code class="fe ms mt mu mj b">stars</code>属性，是一个在<code class="fe ms mt mu mj b">1</code>和<code class="fe ms mt mu mj b">5</code>之间的整数值。</p><p id="6e34" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated"><em class="nk">更多内容请看</em><a class="ae lk" href="http://plainenglish.io/" rel="noopener ugc nofollow" target="_blank"><strong class="kq io"><em class="nk">plain English . io</em></strong></a><em class="nk">。报名参加我们的</em> <a class="ae lk" href="http://newsletter.plainenglish.io/" rel="noopener ugc nofollow" target="_blank"> <strong class="kq io"> <em class="nk">免费周报</em> </strong> </a> <em class="nk">。在我们的</em> <a class="ae lk" href="https://discord.gg/GtDtUAvyhW" rel="noopener ugc nofollow" target="_blank"> <strong class="kq io"> <em class="nk">社区</em> </strong> </a> <em class="nk">获得独家获得写作机会和建议。</em></p></div></div>    
</body>
</html>