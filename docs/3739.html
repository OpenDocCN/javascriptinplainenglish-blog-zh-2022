<html>
<head>
<title>Let’s Understand Chrome V8:
What Is the Builtin at Play Here?</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">让我们来理解Chrome V8:这里的内置是什么？</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/lets-understand-chrome-v8-what-is-the-builtin-at-play-here-35ccb791702d?source=collection_archive---------8-----------------------#2022-09-21">https://javascript.plainenglish.io/lets-understand-chrome-v8-what-is-the-builtin-at-play-here-35ccb791702d?source=collection_archive---------8-----------------------#2022-09-21</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><div class=""><h2 id="0c15" class="pw-subtitle-paragraph jk im in bd b jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb dk translated">第25章:内置的基本原理</h2></div><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi kc"><img src="../Images/2229cb027639f57877eb360bf75cd927.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yCFNVeb4ds9hl7WF-NP-kw.png"/></div></div></figure><p id="e497" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated"><em class="lk">欢迎阅读</em> <a class="ae ll" href="https://medium.com/@huidou" rel="noopener"> <em class="lk">其他章节让我们来了解一下Chrome V8 </em> </a></p><p id="2e64" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">在第9章中，我谈到了内置功能，并展示了一些关于它们如何工作的细节。今天，没有更多的细节，我继续高层次的概念，什么是内置的，它在这里起什么作用。</p><p id="5410" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">在V8中，builtin的全名是内置函数，它们负责实现大多数东西，如ECMAScript API、运行时、点火等等。你知道大部分代码是用CPP编写的，少量对性能敏感的代码是用ASM编写的，那么builtin和CPP有什么区别呢？</p><p id="8d4b" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">在我的理解中，我更喜欢称内置为语法糖，它使得开发V8更方便。内置有其不同于CPP或ASM的模式和习惯用法，但遗憾的是，关于v8.dev的描述文档非常少。关于builtin写代码，具体来说，用CodeStubAssembler或者Torque写代码不在本章讨论范围内，有兴趣的可以给我发邮件。</p><h1 id="a65d" class="lm ln in bd lo lp lq lr ls lt lu lv lw jt lx ju ly jw lz jx ma jz mb ka mc md bi translated"><strong class="ak"> 1。简介</strong></h1><p id="8adc" class="pw-post-body-paragraph ko kp in kq b kr me jo kt ku mf jr kw kx mg kz la lb mh ld le lf mi lh li lj ig bi translated">内置功能使用五种不同的方法实现，每种方法针对不同的权衡进行调整:</p><p id="afc4" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated"><strong class="kq io"> (1) </strong> JavaScript:简洁可读的代码，可以访问快速的内部函数，但频繁使用慢速运行时调用，通过类型污染受到不可预测的性能影响，以及围绕(复杂且不明显)JS语义的微妙问题。Javascript内建程序已被弃用，不应再添加。</p><p id="be19" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated"><strong class="kq io"> (2) </strong> C++:风格与运行时函数非常相似，可以访问V8强大的运行时功能，但通常不适合性能敏感的领域。</p><p id="fe51" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated"><strong class="kq io"> (3) </strong> V8 Torque:是一种V8特有的领域特定语言，翻译成CodeStubAssembler。因此，它在CodeStubAssembler的基础上进行扩展，提供静态类型以及可读性和表达性的语法。</p><p id="aa77" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated"><strong class="kq io"> (4) </strong> CodeStubAssembler:提供高效的低级功能，非常接近汇编语言，同时保持平台无关性和可读性。</p><p id="4fc8" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated"><strong class="kq io"> (5) </strong>依赖平台的汇编语言:可以很高效，但是需要手动移植到所有平台，维护起来比较困难。</p><p id="d267" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">Torque是V8引入的最后一个新模式，用来取代CSA来设计内置，因为Torque的平台无关特性使内置实现比CSA更容易，同时具有与CAS相同的性能。</p><p id="b4fb" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">从1到5，越来越难用但性能越来越高。</p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi mj"><img src="../Images/74fe585f608b64c5230014e7d098f5de.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JE-1WLkPO9sC9lti9L-V1Q.png"/></div></div></figure><p id="847d" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">图1显示了扭矩构建过程。简言之，Torque编译器翻译源代码文件(后缀是。tq)到XX.cc和XX.h，然后将XX.cc编译成可执行代码，写入snapshot.bin</p><h1 id="30c3" class="lm ln in bd lo lp lq lr ls lt lu lv lw jt lx ju ly jw lz jx ma jz mb ka mc md bi translated"><strong class="ak"> 2。内置设置</strong></h1><p id="45cb" class="pw-post-body-paragraph ko kp in kq b kr me jo kt ku mf jr kw kx mg kz la lb mh ld le lf mi lh li lj ig bi translated">我认为C++内置、CSA和Torque是最重要的，因为它们实现了大多数功能，例如，点火是使用CSA实现的，所有运行时都使用C++内置，大多数ECMAScript APIs都使用Torque。让我们再多看看这三种类型的内置。</p><figure class="kd ke kf kg gt kh"><div class="bz fp l di"><div class="mk ml l"/></div></figure><p id="5fea" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">在上面的代码中，第8行，setupbuildins()从snapshot.bin加载内置代码。建议多关注SetupBuiltinsInternal，看看评论。以下是我总结的关于SetupBuiltinsInternal的重要内容。</p><ul class=""><li id="ca88" class="mm mn in kq b kr ks ku kv kx mo lb mp lf mq lj mr ms mt mu bi translated">建造TFJ，建造TFC，建造TFS，建造TFH，建造BCH和建造美国</li></ul><figure class="kd ke kf kg gt kh"><div class="bz fp l di"><div class="mk ml l"/></div></figure><ul class=""><li id="0bcd" class="mm mn in kq b kr ks ku kv kx mo lb mp lf mq lj mr ms mt mu bi translated">宏BUILTIN_LIST定义了所有内置:</li></ul><figure class="kd ke kf kg gt kh"><div class="bz fp l di"><div class="mk ml l"/></div></figure><p id="c631" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">展开BUILTIN_LIST和BUILTIN_LIST_FROM_TORQUE，您将获得所有内置的全名。例如，我们可以通过展开第9–31行来获得与string相关的ECMAScript APIs。</p><ul class=""><li id="8ee3" class="mm mn in kq b kr ks ku kv kx mo lb mp lf mq lj mr ms mt mu bi translated">BUILD_CPP、BUITLD_TFJ等，这七个宏模板完成了完整的内置初始化。</li></ul><figure class="kd ke kf kg gt kh"><div class="bz fp l di"><div class="mk ml l"/></div></figure><p id="0554" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">在上面的代码中，代码是一个HeapOjbect指针，临时保存BuildAdaptor(代码如下)构建的内置地址。第5行，AddBuiltin将内置地址的代码添加到内置数组中。</p><figure class="kd ke kf kg gt kh"><div class="bz fp l di"><div class="mk ml l"/></div></figure><p id="246c" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">在上面的代码中，Generate_Adaptor和CodeBuilder一起创建内建程序。现在，内置设置完成。</p><p id="c03a" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">图2显示了内置的设置调用堆栈。</p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi mv"><img src="../Images/818256322308ee4f3bf3b799885fba05.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JaF0WSHUqr6Vb5pf6wqBYw.png"/></div></div></figure><p id="4ce5" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">如何调试内置设置？我的方法是扩展宏BUILTIN_LIST以获得我感兴趣的索引号，并设置一个如图3所示的条件断点。</p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi mw"><img src="../Images/604692549cf7e57b5dd2a394395742b4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*l11QLiWk-ujOGep5pP6xHw.png"/></div></div></figure><p id="cf94" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">当然，如果您知道要调试的代码在哪里，您可以立即在那里设置一个断点，如图4所示。我敢打赌，大多数时候你不知道它在哪里，因为在V8中有很多很多的文件。我认为我的方法比漫无目的地寻找相对容易。</p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi mx"><img src="../Images/528650c7014df9c043553ed89e3bebaf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-OU-WXj7QuAZADXfUoBIxg.png"/></div></div></figure><p id="0214" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated"><em class="lk">好了，这部分就到此为止了。下次再见，保重！</em></p><p id="7fe8" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">如果你有任何问题，请联系我。v8blink@outlook.com:<a class="ae ll" href="mailto:v8blink@outlook.com" rel="noopener ugc nofollow" target="_blank">微信 : qq9123013 <strong class="kq io">邮箱</strong></a></p></div><div class="ab cl my mz hr na" role="separator"><span class="nb bw bk nc nd ne"/><span class="nb bw bk nc nd ne"/><span class="nb bw bk nc nd"/></div><div class="ig ih ii ij ik"><p id="b0d8" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated"><em class="lk">更多内容请看</em><a class="ae ll" href="https://plainenglish.io/" rel="noopener ugc nofollow" target="_blank"><strong class="kq io"><em class="lk">plain English . io</em></strong></a><em class="lk">。报名参加我们的</em> <a class="ae ll" href="http://newsletter.plainenglish.io/" rel="noopener ugc nofollow" target="_blank"> <strong class="kq io"> <em class="lk">免费周报</em> </strong> </a> <em class="lk">。关注我们关于</em><a class="ae ll" href="https://twitter.com/inPlainEngHQ" rel="noopener ugc nofollow" target="_blank"><strong class="kq io"><em class="lk">Twitter</em></strong></a><a class="ae ll" href="https://www.linkedin.com/company/inplainenglish/" rel="noopener ugc nofollow" target="_blank"><strong class="kq io"><em class="lk">LinkedIn</em></strong></a><em class="lk"/><a class="ae ll" href="https://www.youtube.com/channel/UCtipWUghju290NWcn8jhyAw" rel="noopener ugc nofollow" target="_blank"><strong class="kq io"><em class="lk">YouTube</em></strong></a><em class="lk"/><a class="ae ll" href="https://discord.gg/GtDtUAvyhW" rel="noopener ugc nofollow" target="_blank"><strong class="kq io"><em class="lk">不和</em> </strong> </a> <em class="lk">。对增长黑客感兴趣？检查</em> <a class="ae ll" href="https://circuit.ooo/" rel="noopener ugc nofollow" target="_blank"> <strong class="kq io"> <em class="lk">电路</em> </strong> </a> <em class="lk">。</em></p></div></div>    
</body>
</html>