<html>
<head>
<title>Optimize a Full-Text Search Engine</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">优化全文搜索引擎</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/improve-your-full-text-search-ec1138c201d3?source=collection_archive---------20-----------------------#2022-02-03">https://javascript.plainenglish.io/improve-your-full-text-search-ec1138c201d3?source=collection_archive---------20-----------------------#2022-02-03</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><div class=""><h2 id="bdf9" class="pw-subtitle-paragraph jk im in bd b jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb dk translated">如何根据真实用户反馈调整全文搜索引擎</h2></div><p id="6f37" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">在设计全文搜索及其搜索查询的过程中，我们经常假设客户将如何使用我们的搜索引擎。这只会出错。</p><figure class="kz la lb lc gt ld gh gi paragraph-image"><div role="button" tabindex="0" class="le lf di lg bf lh"><div class="gh gi ky"><img src="../Images/6b8752c7dcade40fea078cefb099b92b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NNRtymYBbpk9bABdF1GeNw.jpeg"/></div></div><figcaption class="lk ll gj gh gi lm ln bd b be z dk">Photo by <a class="ae lo" href="https://unsplash.com/@xtchris?utm_source=ghost&amp;utm_medium=referral&amp;utm_campaign=api-credit" rel="noopener ugc nofollow" target="_blank">Christian Rucinski</a> / <a class="ae lo" href="https://unsplash.com/?utm_source=ghost&amp;utm_medium=referral&amp;utm_campaign=api-credit" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="1a54" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">在这篇博文中，我将向您展示我们如何利用真实世界的用户数据，基于定量分析来调整搜索引擎。我将回答以下问题:</p><ul class=""><li id="65ea" class="lp lq in ke b kf kg ki kj kl lr kp ls kt lt kx lu lv lw lx bi translated">全文搜索中用于信息检索的关键指标是什么？</li><li id="f4f1" class="lp lq in ke b kf ly ki lz kl ma kp mb kt mc kx lu lv lw lx bi translated">我们如何利用真实世界的用户数据来改进我们的全文搜索？</li><li id="27e9" class="lp lq in ke b kf ly ki lz kl ma kp mb kt mc kx lu lv lw lx bi translated">如何对我们的全文搜索引擎进行定量分析？</li><li id="88f2" class="lp lq in ke b kf ly ki lz kl ma kp mb kt mc kx lu lv lw lx bi translated">我们如何确保更改Elasticsearch查询不会对全文搜索引擎的整体质量产生负面影响？</li><li id="e7c7" class="lp lq in ke b kf ly ki lz kl ma kp mb kt mc kx lu lv lw lx bi translated">我们如何持续地提高全文搜索引擎的质量？</li></ul><p id="738b" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">我将深入定义关键指标，收集真实世界的用户数据，对全文搜索进行定量分析，最后迭代改进我们的关键指标。</p><figure class="kz la lb lc gt ld gh gi paragraph-image"><div class="ab gu cl md"><img src="../Images/8f1b0ffca76ebc4f6616dbacb32b13a7.png" data-original-src="https://miro.medium.com/v2/format:webp/1*IsGfCIS1SaYpZYFJPwVaBA.png"/></div></figure><h2 id="4887" class="me mf in bd mg mh mi dn mj mk ml dp mm kl mn mo mp kp mq mr ms kt mt mu mv mw bi translated">TL；速度三角形定位法(dead reckoning)</h2><ul class=""><li id="f021" class="lp lq in ke b kf mx ki my kl mz kp na kt nb kx lu lv lw lx bi translated">定义搜索引擎的目标并选择匹配的KPI</li><li id="b3c9" class="lp lq in ke b kf ly ki lz kl ma kp mb kt mc kx lu lv lw lx bi translated">记录用户的搜索词及其结果点击。认为日志是基本事实，相信用户找到了想要的结果</li><li id="cc86" class="lp lq in ke b kf ly ki lz kl ma kp mb kt mc kx lu lv lw lx bi translated">使用该日志根据用户的查询来计算我们的搜索引擎的KPI。我们的KPI将是我们搜索引擎成功的一个衡量标准。</li><li id="6421" class="lp lq in ke b kf ly ki lz kl ma kp mb kt mc kx lu lv lw lx bi translated">在没有重新评估我们的KPI之前，永远不要更改Elasticsearch查询、索引模式或数据。</li></ul><h1 id="4221" class="nc mf in bd mg nd ne nf mj ng nh ni mm jt nj ju mp jw nk jx ms jz nl ka mv nm bi translated">定义关键指标</h1><p id="660a" class="pw-post-body-paragraph kc kd in ke b kf mx jo kh ki my jr kk kl nn kn ko kp no kr ks kt np kv kw kx ig bi translated">在我们开始优化之前，我们必须非常清楚我们希望我们的搜索引擎实现的目标。我们的搜索引擎应该覆盖什么样的信息需求？谁使用搜索引擎？</p><p id="3b56" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">我们的客户对单一结果感兴趣吗(例如，我接下来应该看哪部电影？我应该买哪双运动鞋？)或一个可能结果的列表，以获得一个概览(例如，我在哪些电子邮件中写了关于即将到来的夏季派对的内容？哪些文档是关于客户X的？).</p><p id="d8a3" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">根据用例，我们可以定义关键性能指标(KPI)来衡量搜索引擎的成功。信息检索常用的KPI大致可以分为两类:敏感性和特异性。</p><p id="c9d1" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><em class="nq">敏感度<br/> </em>衡量在第一批结果中找到相关匹配的成功程度。</p><p id="0c9f" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><em class="nq">特异性<br/> </em>衡量在第一个结果中找到所有相关记录的成功程度。</p><p id="b27e" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">根据用例及上下文选择相关的KPI。</p><h1 id="93a8" class="nc mf in bd mg nd ne nf mj ng nh ni mm jt nj ju mp jw nk jx ms jz nl ka mv nm bi translated">敏感度KPI</h1><p id="4890" class="pw-post-body-paragraph kc kd in ke b kf mx jo kh ki my jr kk kl nn kn ko kp no kr ks kt np kv kw kx ig bi translated">我们希望在搜索结果的顶部向客户展示最佳匹配的结果。在大多数情况下，如果想要的结果不在搜索页面的前X个结果中，或者不在搜索结果的第一页，客户就会离开。</p><p id="ac37" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><strong class="ke io"> Hit-Rate@K <br/> </strong>客户请求命中的查询在前K个结果中的百分比。越高越好。如果我们的数据库中只有一个相关结果，这与Recall@K(见下文)相同。</p><p id="313d" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><strong class="ke io"> MRR <br/> </strong> <a class="ae lo" href="https://en.wikipedia.org/wiki/Mean_reciprocal_rank" rel="noopener ugc nofollow" target="_blank">平均倒数排名</a>计算客户请求点击的平均点击位置。越高越好。</p><h1 id="90a9" class="nc mf in bd mg nd ne nf mj ng nh ni mm jt nj ju mp jw nk jx ms jz nl ka mv nm bi translated">特异性KPI</h1><p id="813f" class="pw-post-body-paragraph kc kd in ke b kf mx jo kh ki my jr kk kl nn kn ko kp no kr ks kt np kv kw kx ig bi translated">我们希望为客户提供一个可能匹配的列表，按照匹配的降序排列。排名不是那么重要，但是必须列出所有相关的结果。</p><p id="08aa" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><strong class="ke io">回忆@K <br/> </strong>前K个结果中列出了多少个想要的结果？越高越好。0.6的Recall@10表示在前10个结果中检索到5个期望结果中的3个。</p><p id="3c8a" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><strong class="ke io"> DCG <br/>如果一个高度相关的结果被列在搜索结果的底部，就会受到惩罚。</strong></p><h2 id="01af" class="me mf in bd mg mh mi dn mj mk ml dp mm kl mn mo mp kp mq mr ms kt mt mu mv mw bi translated">更多KPI</h2><p id="b63b" class="pw-post-body-paragraph kc kd in ke b kf mx jo kh ki my jr kk kl nn kn ko kp no kr ks kt np kv kw kx ig bi translated">这只是可能的KPI的一个选择。查看这篇维基百科文章，了解更多文档和更多评估方法:</p><div class="nr ns gp gr nt nu"><a href="https://en.wikipedia.org/wiki/Evaluation_measures_%28information_retrieval%29" rel="noopener  ugc nofollow" target="_blank"><div class="nv ab fo"><div class="nw ab nx cl cj ny"><h2 class="bd io gy z fp nz fr fs oa fu fw im bi translated">评估措施(信息检索)-维基百科</h2><div class="ob l"><h3 class="bd b gy z fp nz fr fs oa fu fw dk translated">信息检索系统的评价标准是用来评估检索结果满足用户需求的程度</h3></div><div class="oc l"><p class="bd b dl z fp nz fr fs oa fu fw dk translated">en.wikipedia.org</p></div></div></div></a></div><h1 id="5aea" class="nc mf in bd mg nd ne nf mj ng nh ni mm jt nj ju mp jw nk jx ms jz nl ka mv nm bi translated">措施</h1><p id="d3e8" class="pw-post-body-paragraph kc kd in ke b kf mx jo kh ki my jr kk kl nn kn ko kp no kr ks kt np kv kw kx ig bi translated">在我们定义了我们的关键指标之后，我们现在可以测量和评估我们当前的搜索引擎实现。</p><p id="3634" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">为了能够进行测量，我们首先需要一些数据。有两种选择:定性分析和定量分析。</p><figure class="kz la lb lc gt ld gh gi paragraph-image"><div class="ab gu cl md"><img src="../Images/629824ce4fe2945d69573cdb8353e81d.png" data-original-src="https://miro.medium.com/v2/format:webp/1*yR0hmiUosXrAd06lnl6f6A.png"/></div></figure><p id="89aa" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">当我们进行定性分析时，我们将我们的评估集中在单个用例上，并尽可能地努力生成测试数据的基本事实。这意味着我们为一组给定的查询字符串手动定义所有匹配的文档。这通常是乏味的工作，并且只涵盖了我们搜索引擎用例的很小一部分。因此，我们将仅对一组选定的非常重要的用例进行定性分析。</p><p id="4ecc" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">另一方面是定量分析:我们拥有的数据越多越好。它不一定总是100%准确。对于定量分析，我们可以使用来自搜索引擎用户的日志数据。</p><h1 id="61b1" class="nc mf in bd mg nd ne nf mj ng nh ni mm jt nj ju mp jw nk jx ms jz nl ka mv nm bi translated">收集数据</h1><p id="a5dc" class="pw-post-body-paragraph kc kd in ke b kf mx jo kh ki my jr kk kl nn kn ko kp no kr ks kt np kv kw kx ig bi translated">收集运行中的搜索引擎的日志数据。记录客户搜索的内容以及他点击的结果。</p><p id="8234" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">如果我们假设点击的结果是给定搜索查询的最佳匹配，那么我们可以使用日志数据来评估我们的搜索引擎。虽然这是一个假设，可能不是100%准确，但我们比依赖我们的直觉或只为经理优化要好得多，他说最贵的运动鞋应该列在顶部。</p><p id="3150" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">为了收集日志数据，我们需要在搜索结果页面上实现一些跟踪。一旦用户点击搜索结果，我们就跟踪用户的搜索词以及被点击的搜索结果的ID。对于进一步的长期分析，记录被点击的搜索结果的排名通常是有用的(它是第一个显示的结果还是在第24位？).但是对于我们的用例，我们目前只需要搜索词以及点击的结果。这应该会得到如下日志列表:</p><figure class="kz la lb lc gt ld gh gi paragraph-image"><div class="ab gu cl md"><img src="../Images/5372b206c02a83cef870d9ff4a511eee.png" data-original-src="https://miro.medium.com/v2/format:webp/1*l9XSwX2WonGVpRBNK3hMxA.png"/></div></figure><p id="9883" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">确保收集足够的日志数据。大约有100，000个搜索词，结果点击对应该没问题。如果适用，还要考虑搜索行为的季节性差异。日志数据应该提供我们的用户搜索行为的全面图片。</p><h1 id="9fc2" class="nc mf in bd mg nd ne nf mj ng nh ni mm jt nj ju mp jw nk jx ms jz nl ka mv nm bi translated">评价</h1><p id="e587" class="pw-post-body-paragraph kc kd in ke b kf mx jo kh ki my jr kk kl nn kn ko kp no kr ks kt np kv kw kx ig bi translated">现在，我们可以将这些数据输入到我们的搜索引擎中，并计算每个搜索词的关键指标——结果点击对。</p><p id="89ab" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">把它带到我们的搜索查询中。假设我们在文档的<em class="nq">标题</em>字段上使用一个<a class="ae lo" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-match-query.html" rel="noopener ugc nofollow" target="_blank">简单匹配查询</a>:</p><pre class="kz la lb lc gt od oe of og aw oh bi"><span id="9cd2" class="me mf in oe b gy oi oj l ok ol">GET /_search<br/>{<br/>  "query": {<br/>    "match": {<br/>      "title": "banana"<br/>    }<br/>  }<br/>}</span></pre><p id="a3bd" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">为了计算Recall@10 KPI分数，我们可以自己执行查询并计算分数，或者使用<a class="ae lo" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/search-rank-eval.html" rel="noopener ugc nofollow" target="_blank">排名评估API </a>。为此，我们将数据日志的每个条目添加到排名评估API请求的requests数组中。用户的搜索词进入<em class="nq">requests[]request . query . match</em>查询，点击的文档ID作为文档列在<em class="nq"> requests[]中。评级</em>数组:</p><pre class="kz la lb lc gt od oe of og aw oh bi"><span id="856e" class="me mf in oe b gy oi oj l ok ol">POST /my-index/_rank_eval<br/>{<br/>  "requests": [<br/>    {<br/>      "id": "test_query_1",                                  <br/>      "request": {                                              <br/>          "query": { "match": { "title": "banana" } }<br/>      },<br/>      "ratings": [                                              <br/>        { "_index": "my-index", "_id": "bananabread-recipe-123", "rating": 1 }<br/>      ]<br/>    },<br/>    {<br/>      "id": "test_query_2",<br/>      "request": {<br/>        "query": { "match": { "title": "apple" } }<br/>      },<br/>      "ratings": [<br/>        { "_index": "my-index", "_id": "apple-pie-531", "rating": 1 }<br/>      ]<br/>    }<br/>  ],<br/>  "metric": {<br/>    "recall": {<br/>      "k": 10,<br/>      "relevant_rating_threshold": 1<br/>    }<br/>  }<br/>}</span></pre><p id="7485" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">这将提供我们的最终KPI指标分数:</p><pre class="kz la lb lc gt od oe of og aw oh bi"><span id="40d2" class="me mf in oe b gy oi oj l ok ol">{<br/>  "rank_eval": {<br/>    "metric_score": 0.4,<br/>    "details": { ... }<br/>  }<br/>}</span></pre><p id="b202" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">使用集成的排名评估API，您可以轻松地<a class="ae lo" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/search-rank-eval.html#_mean_reciprocal_rank" rel="noopener ugc nofollow" target="_blank">将指标更改为MRR(<em class="nq">mean _ reciprocal _ rank</em>)</a>。</p><p id="cfb2" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">现在你已经准备好了！<em class="nq"> metric_score </em>是对我们搜索引擎的第一次评价。这将是我们的KPI，我们现在将努力改进它。</p><h1 id="69bc" class="nc mf in bd mg nd ne nf mj ng nh ni mm jt nj ju mp jw nk jx ms jz nl ka mv nm bi translated">改进和适应</h1><p id="9128" class="pw-post-body-paragraph kc kd in ke b kf mx jo kh ki my jr kk kl nn kn ko kp no kr ks kt np kv kw kx ig bi translated">随着我们的搜索引擎的第一次评估，我们有一个我们的现状质量的概述。我们可能已经看到一些查询或搜索组合表现不佳。</p><p id="aa46" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">现在是时候分析我们的结果了。我们能改进我们的搜索查询吗？也许我们需要改变我们的索引模式？也许我们需要改进或增强我们的数据？我们是否仍然有正确的绩效指标来衡量满足客户信息需求的质量？</p><p id="5830" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">所以我们有四种不同的方法来改进我们的搜索引擎:</p><ul class=""><li id="8739" class="lp lq in ke b kf kg ki kj kl lr kp ls kt lt kx lu lv lw lx bi translated">弹性搜索查询</li><li id="31b8" class="lp lq in ke b kf ly ki lz kl ma kp mb kt mc kx lu lv lw lx bi translated">索引模式</li><li id="7987" class="lp lq in ke b kf ly ki lz kl ma kp mb kt mc kx lu lv lw lx bi translated">索引数据</li><li id="f5e1" class="lp lq in ke b kf ly ki lz kl ma kp mb kt mc kx lu lv lw lx bi translated">KPI指标</li></ul><p id="f95d" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">根据结果调整搜索引擎，并确保在每次更改后重新运行评估。通过坚持明确定义的性能指标，您可以避免意外优化超过目标和无意中降低搜索引擎。</p><h1 id="487e" class="nc mf in bd mg nd ne nf mj ng nh ni mm jt nj ju mp jw nk jx ms jz nl ka mv nm bi translated">结论</h1><p id="bce0" class="pw-post-body-paragraph kc kd in ke b kf mx jo kh ki my jr kk kl nn kn ko kp no kr ks kt np kv kw kx ig bi translated">使用用户的搜索数据来衡量我们搜索引擎的成功。尝试通过迭代过度优化和测量来优化搜索引擎。更改搜索查询、索引架构或增强文档数据。每次更改后，一定要重新计算搜索引擎的KPI，以避免意外优化超过目标，无意中降低搜索引擎的性能。</p><p id="4b8e" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">你还想知道什么？在评论中告诉我们或者<a class="ae lo" href="https://smartive.ch/" rel="noopener ugc nofollow" target="_blank">联系</a>！</p><p id="7d11" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><em class="nq">更多内容看</em> <a class="ae lo" href="https://plainenglish.io/" rel="noopener ugc nofollow" target="_blank"> <strong class="ke io"> <em class="nq">说白了。报名参加我们的</em> <a class="ae lo" href="http://newsletter.plainenglish.io/" rel="noopener ugc nofollow" target="_blank"> <strong class="ke io"> <em class="nq">免费周报</em> </strong> </a> <em class="nq">。关注我们关于</em> <a class="ae lo" href="https://twitter.com/inPlainEngHQ" rel="noopener ugc nofollow" target="_blank"> <strong class="ke io"> <em class="nq">推特</em></strong></a><a class="ae lo" href="https://www.linkedin.com/company/inplainenglish/" rel="noopener ugc nofollow" target="_blank"><strong class="ke io"><em class="nq">领英</em></strong></a><strong class="ke io"><em class="nq"/></strong><em class="nq">和</em> <a class="ae lo" href="https://discord.gg/GtDtUAvyhW" rel="noopener ugc nofollow" target="_blank"> <strong class="ke io"> <em class="nq">不和</em> </strong> </a> <strong class="ke io"> <em class="nq">。</em>T47】</strong></strong></a></p></div></div>    
</body>
</html>