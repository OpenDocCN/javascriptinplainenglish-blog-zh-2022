<html>
<head>
<title>Retrying HTTP Requests a Fixed Number of Times With a Delay in Angular</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">重试HTTP请求的次数是固定的，有一个角度延迟</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/rxjs-angular-retrying-sequential-or-parallel-http-requests-a-fixed-number-of-times-and-also-with-a-b445e1560f88?source=collection_archive---------0-----------------------#2022-06-18">https://javascript.plainenglish.io/rxjs-angular-retrying-sequential-or-parallel-http-requests-a-fixed-number-of-times-and-also-with-a-b445e1560f88?source=collection_archive---------0-----------------------#2022-06-18</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><div class=""><h2 id="d41d" class="pw-subtitle-paragraph jk im in bd b jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb dk translated">关于使用RXJS，Angular以固定的延迟次数重试顺序或并行HTTP请求的指南。</h2></div><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi kc"><img src="../Images/3c2479a011d88355ccb2583dbe5f7084.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*YAJln7cvgZ2T7kJ7"/></div></div><figcaption class="ko kp gj gh gi kq kr bd b be z dk">Photo by <a class="ae ks" href="https://unsplash.com/@mitchel3uo?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Mitchell Luo</a> on <a class="ae ks" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="e123" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">延迟重试HTTP请求或不延迟重试固定次数的HTTP请求非常简单，RXJS为我们提供了<strong class="kv io"> retryWhen、delay、</strong>和<strong class="kv io"> retry </strong>操作符来实现这一点。但是如果我们想要一个结果来处理重试之间的延迟和重试次数呢？</p><p id="4ecf" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">这些是我们的目标:</p><ol class=""><li id="6632" class="lp lq in kv b kw kx kz la lc lr lg ls lk lt lo lu lv lw lx bi translated">分别并行和按顺序执行2项任务。</li><li id="91b0" class="lp lq in kv b kw ly kz lz lc ma lg mb lk mc lo lu lv lw lx bi translated">如果失败，任务最多重试2次，每次重试之间有2000毫秒的间隔。</li></ol><p id="aac4" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">应用程序就像下面的截图一样简单。只需两个按钮就能实现上面列出的两个目标。</p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi md"><img src="../Images/b72e205254b807786b2d70c4978a29ad.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rksyDTfdMAickhPxWA4AgQ.png"/></div></div><figcaption class="ko kp gj gh gi kq kr bd b be z dk">angular application</figcaption></figure><p id="f1fb" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated"><strong class="kv io"> AppComponent模板:</strong>这个模板包含了你可以在截图中看到的2个按钮。点击它们将并行或顺序执行任务。</p><figure class="kd ke kf kg gt kh"><div class="bz fp l di"><div class="me mf l"/></div></figure><p id="7c63" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated"><strong class="kv io"> AppComponent类:</strong>在类中，我们定义了当我们点击AppComponent模板中的2个按钮时将被调用的2个方法。</p><figure class="kd ke kf kg gt kh"><div class="bz fp l di"><div class="me mf l"/></div></figure><p id="4bd2" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">让我们从<strong class="kv io">executeinsidenttasksinparallel()</strong>开始。我们使用了<strong class="kv io"> forkJoin </strong> RXJS操作符来并行执行这两个任务。</p><p id="846d" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">这两个任务，即task1()和task2()不过是我们在<strong class="kv io"> RetryService </strong>中定义的<strong class="kv io"> HTTP GET请求</strong>。我们将很快进入服务。</p><p id="e712" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">请注意，我们已经用管道将<strong class="kv io"> catchError </strong>操作符连接到从<strong class="kv io"> task1() </strong>和<strong class="kv io"> task2()返回的<strong class="kv io">内部观察值</strong>。</strong>这样做的原因是，无论哪个任务先执行:task1()或task2()，如果任务失败，<strong class="kv io"> catchError </strong>运算符将执行可观测替换的任务。它将使用操作员的<strong class="kv io">创建的成功可观察值替换错误可观察值。</strong></p><p id="d563" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">如果没有这种替换，在第一个执行的任务失败时，源可观察对象将出错，第二个任务将不会执行。但是我们要求无论成功或错误都执行这两个任务来验证所有场景。</p><p id="3b45" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">转到<strong class="kv io">executeinsidenttasksinsequence()</strong>，我们只是使用<strong class="kv io"> concat </strong> rxjs操作符按顺序执行task1()和task2()。</p><p id="b665" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">现在，让我们检查一下<strong class="kv io"> RetryService </strong>，看看这些任务做了什么。</p><figure class="kd ke kf kg gt kh"><div class="bz fp l di"><div class="me mf l"/></div></figure><p id="ad05" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">task1()正在向<a class="ae ks" href="https://jsonplaceholder.typicode.com/users/10" rel="noopener ugc nofollow" target="_blank">https://jsonplaceholder.typicode.com/users/10</a>发出HTTP GET请求。这是一个有效的请求，预计将发送一个JSON对象，其中包含userId为10的用户的详细信息。</p><p id="3e36" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">task2()正在向https://jsonplaceholder.typicode.com/users/12的<a class="ae ks" href="https://jsonplaceholder.typicode.com/users/12" rel="noopener ugc nofollow" target="_blank">发出一个HTTP GET请求。没有userId为12的用户。因此，我们预计这个请求会失败，并出现404错误。</a></p><p id="69cb" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">现在让我们来看看这个方法，在这个方法中，我们配置了一个特定的重试次数，在重试之间有一个延迟。</p><p id="1a87" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">当请求失败时，触发<strong class="kv io"> RetryService </strong>中的<strong class="kv io"> handleRetryError() </strong>。我们将“重试之间的延迟”作为该方法的参数传递。在本例中，两个任务的延迟时间相同，均为2000毫秒。</p><pre class="kd ke kf kg gt mg mh mi mj aw mk bi"><span id="5b81" class="ml mm in mh b gy mn mo l mp mq">let retries = 0;<br/>let exceedAttemptLimit = 3;</span></pre><p id="8599" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">因为我们希望失败的任务最多重试2次，所以我们将变量<strong class="kv io">exceetattemplimit</strong>设置为3。变量<strong class="kv io"> retries </strong>记录任务完成的重试次数。</p><pre class="kd ke kf kg gt mg mh mi mj aw mk bi"><span id="b269" class="ml mm in mh b gy mn mo l mp mq">return <strong class="mh io">retryWhen</strong>((error) =&gt; {<br/>return error.pipe(<br/><strong class="mh io">delay</strong>(delayTime),<br/><strong class="mh io">concatMap</strong>((err) =&gt; {<br/><strong class="mh io">retries = retries + 1;<br/>if (retries &lt; exceedAttemptLimit) {<br/>return of(err);<br/>} else {<br/>throw err;</strong><br/>}<br/>})<br/>);<br/>});</span></pre><p id="4df5" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">只有当2000 ms的延迟完成并且<strong class="kv io"> retries </strong>变量的值小于3时，<strong class="kv io"> retryWhen </strong>操作器才会重试失败的任务。</p><p id="431c" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">当<strong class="kv io">重试</strong>变量等于3时，我们使用<strong class="kv io"> throw </strong>操作符来防止进一步的重试。</p><p id="8807" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">当我点击“<strong class="kv io">按顺序执行任务</strong>按钮时，正如你在第一张截图中看到的，task1()已经执行并成功返回了一个200状态码的响应。</p><p id="f753" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">task2()第一次失败，出现404错误，然后该任务重试了2次，延迟时间为2000毫秒</p><p id="1272" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">在第二个屏幕截图中，我们记录了来自task1()的JSON对象和来自task2()的错误响应。</p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi md"><img src="../Images/e51461c049200472bf2281f5af1b5624.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3PHlwXRQvU1MbLTeK72eag.png"/></div></div><figcaption class="ko kp gj gh gi kq kr bd b be z dk">Network response for sequential execution</figcaption></figure><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi md"><img src="../Images/36958c667c0469649effa5efe4527c25.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*AnnSPheAoMmViAAxMIkUWg.png"/></div></div><figcaption class="ko kp gj gh gi kq kr bd b be z dk">Console response for sequential execution</figcaption></figure><p id="72ea" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">为了验证任务是否在2000毫秒的延迟后重试，您可以在开发工具中右键单击任何请求，并选择“<strong class="kv io">将所有内容保存为HAR</strong>”。</p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi mr"><img src="../Images/8b7f5867f33fac6bba71d5cfa985593e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ohsItRu0tscW48p8vTapoQ.png"/></div></div><figcaption class="ko kp gj gh gi kq kr bd b be z dk">save .har file</figcaption></figure><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi ms"><img src="../Images/40b35fae5066af8e2cceb5bbce9ea053.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Ltrh_Cg9KlcrQCOC2smOoA.png"/></div></div><figcaption class="ko kp gj gh gi kq kr bd b be z dk">.har file</figcaption></figure><p id="f0d1" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">答。har文件将被下载到您的系统中。您可以通过URL在文件中搜索失败的请求，并检查属性<strong class="kv io"> startedDateTime的值。</strong>由于该任务已经执行了3次，您可以在这里查看所有3个实例的请求和响应细节。har文件。在每个实例中，<strong class="kv io"> startedDateTime </strong>属性的值将相差2000毫秒。</p><p id="2c86" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">当我点击<strong class="kv io">执行并行任务</strong>按钮时，结果会如你在下面2张截图中看到的那样。</p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi mt"><img src="../Images/b56fb33d171445f2fbbbb25e4fc994b2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dTc-SHX3Oq4RywyflOWgLA.png"/></div></div><figcaption class="ko kp gj gh gi kq kr bd b be z dk">Network Response for parallel execution</figcaption></figure><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi md"><img src="../Images/d0cf5b4358f9bf4dfd3bb8f2710beb0b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BmPrtgXNfOcjguIsfH83dQ.png"/></div></div><figcaption class="ko kp gj gh gi kq kr bd b be z dk">Console Response for parallel execution</figcaption></figure><p id="6719" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">请注意，在subscribe catch块中没有捕获到任何错误。相反，我们可以在subscribe success块中看到记录的结果对象。该对象有两个属性:<strong class="kv io"> task1 </strong>，其中<strong class="kv io"> </strong>包含userId为10的用户的JSON对象，<strong class="kv io"> task2 </strong>包含404错误响应。</p><p id="d0f0" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">失败的task2以类似的方式重试了2次。</p><p id="2f60" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">这只是两种情况。这里还可以尝试3种变化:</p><ol class=""><li id="92ff" class="lp lq in kv b kw kx kz la lc lr lg ls lk lt lo lu lv lw lx bi translated">两个任务都失败了。</li><li id="68a1" class="lp lq in kv b kw ly kz lz lc ma lg mb lk mc lo lu lv lw lx bi translated">任务1失败，任务2成功。</li><li id="01f2" class="lp lq in kv b kw ly kz lz lc ma lg mb lk mc lo lu lv lw lx bi translated">两项任务都成功了。</li></ol><p id="8edd" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">您可以查看下面的完整工作示例:</p><div class="mu mv gp gr mw mx"><a href="https://stackblitz.com/edit/angular-ivy-ezvzzr?file=src/app/retry.service.ts" rel="noopener  ugc nofollow" target="_blank"><div class="my ab fo"><div class="mz ab na cl cj nb"><h2 class="bd io gy z fp nc fr fs nd fu fw im bi translated">角状常春藤(分叉)- StackBlitz</h2><div class="ne l"><h3 class="bd b gy z fp nc fr fs nd fu fw dk translated">基于@angular/animations、@angular/compiler、@angular/core、@angular/common的angular-cli项目…</h3></div><div class="nf l"><p class="bd b dl z fp nc fr fs nd fu fw dk translated">stackblitz.com</p></div></div><div class="ng l"><div class="nh l ni nj nk ng nl km mx"/></div></div></a></div><p id="8490" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated"><em class="nm">更多内容看</em> <a class="ae ks" href="https://plainenglish.io/" rel="noopener ugc nofollow" target="_blank"> <strong class="kv io"> <em class="nm">说白了就是io </em> </strong> </a> <em class="nm">。报名参加我们的</em> <a class="ae ks" href="http://newsletter.plainenglish.io/" rel="noopener ugc nofollow" target="_blank"> <strong class="kv io"> <em class="nm">免费周报</em> </strong> </a> <em class="nm">。关注我们关于</em><a class="ae ks" href="https://twitter.com/inPlainEngHQ" rel="noopener ugc nofollow" target="_blank"><strong class="kv io"><em class="nm">Twitter</em></strong></a><em class="nm">和</em><a class="ae ks" href="https://www.linkedin.com/company/inplainenglish/" rel="noopener ugc nofollow" target="_blank"><strong class="kv io"><em class="nm">LinkedIn</em></strong></a><em class="nm">。查看我们的</em> <a class="ae ks" href="https://discord.gg/GtDtUAvyhW" rel="noopener ugc nofollow" target="_blank"> <strong class="kv io"> <em class="nm">社区不和谐</em> </strong> </a> <em class="nm">加入我们的</em> <a class="ae ks" href="https://inplainenglish.pallet.com/talent/welcome" rel="noopener ugc nofollow" target="_blank"> <strong class="kv io"> <em class="nm">人才集体</em> </strong> </a> <em class="nm">。</em></p></div></div>    
</body>
</html>