<html>
<head>
<title>What About Vite SSR?</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Vite SSR呢？</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/what-about-vite-ssr-ef7ccdf58b5?source=collection_archive---------3-----------------------#2022-03-15">https://javascript.plainenglish.io/what-about-vite-ssr-ef7ccdf58b5?source=collection_archive---------3-----------------------#2022-03-15</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><figure class="gl gn jl jm jn jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi jk"><img src="../Images/d4831ebf24d53da52448fba39b61749a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*b6CcO9DK1PeMSs2C.png"/></div></div></figure><p id="678e" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">本文将带你更深入的了解Vite SSR</p><p id="9bde" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">网上关于Vite的文章主要分为入门教程或者原理分析。本文采用不同的方法，向您展示Vite作为2021年最热门的构建工具是如何实现SSR的</p><blockquote class="kt ku kv"><p id="7d57" class="jv jw kw jx b jy jz ka kb kc kd ke kf kx kh ki kj ky kl km kn kz kp kq kr ks ig bi translated">这篇文章是时间敏感的，当前的官方版本是2.7.13</p></blockquote><h1 id="da3c" class="la lb in bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">为什么要用SSR？</h1><p id="4087" class="pw-post-body-paragraph jv jw in jx b jy ly ka kb kc lz ke kf kg ma ki kj kk mb km kn ko mc kq kr ks ig bi translated">r，我们来简单介绍一下SSR</p><p id="a9c4" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">我之前接触的大部分项目都是客户端渲染，客户端渲染也叫CSR(客户端渲染)。</p><p id="ad5b" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">CSR采用前后端分离的结构。当客户端请求HTML时，服务器只返回“空”HTML</p><blockquote class="kt ku kv"><p id="b5fd" class="jv jw kw jx b jy jz ka kb kc kd ke kf kx kh ki kj ky kl km kn kz kp kq kr ks ig bi translated">空HTML是指只包含挂载点和Vue运行时，不包含任何页面内容的HTML</p></blockquote><p id="9788" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">最终客户端通过运行Vue运行时动态创建页面DOM来呈现完整的HTML</p><figure class="me mf mg mh gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi md"><img src="../Images/d2370387cbef6f0f1e650cace5d8cbee.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lZrQmZAx-hvaZgSFCqieRQ.png"/></div></div></figure><p id="f4b6" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">服务器端渲染也称为SSR(服务器端渲染)</p><p id="3b58" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">当客户端请求HTML时，服务器将返回完整的HTML</p><blockquote class="kt ku kv"><p id="ecb7" class="jv jw kw jx b jy jz ka kb kc kd ke kf kx kh ki kj ky kl km kn kz kp kq kr ks ig bi translated">完整的HTML，包括挂载点、Vue运行时和页面内容的HTML</p></blockquote><figure class="me mf mg mh gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi md"><img src="../Images/d64d1f35c69ff26a5c1dff3a05eccbec.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*U5k9NduNU56BODV2fhhR5g.png"/></div></div></figure><p id="8c02" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">由于完整的HTML在服务器端返回，Vue runtime不需要动态生成DOM。一方面减轻了客户端渲染的压力(动态创建大量DOM会造成一定的滞后)，另一方面让用户更早看到。满足于</p><p id="d157" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">这两点最终使得第一个使用SSR渲染页面的项目的画图速度非常快</p><p id="dac0" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">企业社会责任</p><figure class="me mf mg mh gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi md"><img src="../Images/15cbc0583c17743f130e035d287f19c0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nlUs2M2t9Xs3pkrwx5bV_Q.png"/></div></div></figure><p id="ce18" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">苏维埃社会主义共和国</p><figure class="me mf mg mh gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi md"><img src="../Images/4b9f145053809b8248a7935167ffa3c2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RP8N-ttvQfmDGq-j9c0D3A.png"/></div></div></figure><blockquote class="kt ku kv"><p id="424d" class="jv jw kw jx b jy jz ka kb kc kd ke kf kx kh ki kj ky kl km kn kz kp kq kr ks ig bi translated">除了客户端渲染和服务器端渲染，还有一种预渲染技术，SSG (static site generate)。在构建构件时直接生成包含页面内容的HTML构件</p><p id="8945" class="jv jw kw jx b jy jz ka kb kc kd ke kf kx kh ki kj ky kl km kn kz kp kq kr ks ig bi translated">SSG和SSR在第一个屏幕上具有相同的优化效果，但比SSR更轻、更简单。适用于博客、官网等首屏数据变化不大的项目。</p><p id="54da" class="jv jw kw jx b jy jz ka kb kc kd ke kf kx kh ki kj ky kl km kn kz kp kq kr ks ig bi translated"><a class="ae mi" href="https://nextjs.org/docs/basic-features/pages#static-generation-recommended" rel="noopener ugc nofollow" target="_blank"><em class="in">https://nextjs . org/docs/basic-features/pages # static-generation-推荐</em> </a></p></blockquote><h2 id="5ec0" class="mj lb in bd lc mk ml dn lg mm mn dp lk kg mo mp lo kk mq mr ls ko ms mt lw mu bi translated">CSR与SSR</h2><p id="8e80" class="pw-post-body-paragraph jv jw in jx b jy ly ka kb kc lz ke kf kg ma ki kj kk mb km kn ko mc kq kr ks ig bi translated">企业社会责任</p><p id="fe78" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">优势</p><p id="c902" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">–开发简单，无需担心服务器上运行的代码引起的兼容性问题</p><p id="f81c" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">–简单部署，仅涉及静态资源服务器</p><p id="9bbd" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">–获取数据的方法很简单，使用ajax/fetch获取数据</p><p id="a3ab" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">缺点</p><p id="dcb9" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">–第一个屏幕很慢</p><p id="d2a2" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">–糟糕的搜索引擎优化</p><p id="6518" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">苏维埃社会主义共和国</p><p id="1036" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">优势</p><p id="ec92" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">–首屏速度快(浏览器版本越低效果越好)</p><p id="c593" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">–搜索引擎优化很好</p><p id="43f8" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">–可以获得关于请求上下文的附加信息</p><p id="f5db" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">缺点</p><p id="62e7" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">–开发很复杂，需要编写SSR的服务器端代码</p><p id="1f8b" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">–复杂的部署需要SSR服务器和静态资源服务器来进行降级灾难恢复，增加了后期运营和维护成本</p><p id="69c6" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">–编写代码需要考虑平台兼容性，增加了额外的精神负担</p><h2 id="130f" class="mj lb in bd lc mk ml dn lg mm mn dp lk kg mo mp lo kk mq mr ls ko ms mt lw mu bi translated">要使用的场景</h2><p id="963a" class="pw-post-body-paragraph jv jw in jx b jy ly ka kb kc lz ke kf kg ma ki kj kk mb km kn ko mc kq kr ks ig bi translated">对于后端管理系统、数据中端平台等toB项目，由于对首屏要求低，用户数量少，一般采用CSR来简化开发流程，快速交付项目。</p><p id="5892" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">对于官网首页、电商首页等toC项目来说，首屏速度直接关系到用户留存率，而良好的SEO也是提高转化率的前提，因此需要依靠SSR来探索进一步的可能性</p><h1 id="a19e" class="la lb in bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">项目结构(开发)</h1><p id="2301" class="pw-post-body-paragraph jv jw in jx b jy ly ka kb kc lz ke kf kg ma ki kj kk mb km kn ko mc kq kr ks ig bi translated">以<a class="ae mi" href="https://github.com/vitejs/vite/blob/main/packages/playground/ssr-vue" rel="noopener ugc nofollow" target="_blank"> <em class="kw"> Vite官方知识库的简化SSR项目</em> </a>为例</p><p id="3c51" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">Vite SSR项目至少包含以下文件</p><pre class="me mf mg mh gt mv mw mx my aw mz bi"><span id="0e26" class="mj lb in mw b gy na nb l nc nd">├── index.html // template，include SSR client entry<br/> ├── package.json<br/> ├── server.js // dev server<br/> ├── src<br/> │ ├── App.vue // Vue container<br/> │ ├── main.js // common entry<br/> │ ├── entry-client.js // SSR client entry<br/> │ ├── entry-server.js // SSR server entry<br/> │ └── pages // page files<br/> │ └── Home.vue<br/> └── vite.config.js</span></pre><h2 id="f378" class="mj lb in bd lc mk ml dn lg mm mn dp lk kg mo mp lo kk mq mr ls ko ms mt lw mu bi translated">index.html</h2><p id="56c8" class="pw-post-body-paragraph jv jw in jx b jy ly ka kb kc lz ke kf kg ma ki kj kk mb km kn ko mc kq kr ks ig bi translated">项目模板文件</p><figure class="me mf mg mh gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi ne"><img src="../Images/39ca082d0af32ed18a8f019d11588e68.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gZn6sBbtlTKzvYP7aWI47A.png"/></div></div></figure><p id="95aa" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">与CSR的区别在于</p><p id="bc65" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">更多<em class="kw"> &lt;！— app-html — &gt; </em>，<em class="kw"> &lt;！—预加载-链接— &gt; </em>注释</p><p id="2c0e" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">条目文件变成/src/entry-client.js</p><p id="600e" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><em class="kw">哪里来的&lt;！— app-html — &gt; </em>是页面内容的占位符，在服务器渲染带有页面内容的html字符串后，它将替换<em class="kw"> &lt;！— app-html — &gt; </em>占位符</p><p id="0ac1" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">还有<em class="kw"> &lt;！— preload-links — &gt; </em>是preload节点的占位符，用于生成预渲染的HTML字符串，<strong class="jx io">开发环境没有实质影响</strong></p><p id="7267" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">在构建了SSR生产环境之后，您可以选择生成一个manifest.json文件，它记录了源文件和构建产品的依赖关系</p><pre class="me mf mg mh gt mv mw mx my aw mz bi"><span id="2a40" class="mj lb in mw b gy na nb l nc nd">{<br/>   "src/App.vue": [<br/>     "/assets/Inter-Italic.bab4e808.woff2",<br/>     "/assets/Inter-Italic.7b187d57.woff"<br/>   ],<br/>   "vite/preload-helper": [<br/>     "/assets/Inter-Italic.bab4e808.woff2",<br/>     "/assets/Inter-Italic.7b187d57.woff"<br/>   ],<br/>   "src/router.js": [<br/>     "/assets/Inter-Italic.bab4e808.woff2",<br/>     "/assets/Inter-Italic.7b187d57.woff"<br/>   ],<br/>   ...<br/>}</span></pre><p id="beec" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">从这个清单文件中，生成一个HTML字符串进行预渲染，替换掉<em class="kw"> &lt;！—预加载-链接— &gt; </em>占位符</p><figure class="me mf mg mh gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi nf"><img src="../Images/70a6a4a63cd03262c84a6ccb39a88b3b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Mm3mzsSzEDtXnHqr7YIHfQ.png"/></div></div></figure><blockquote class="kt ku kv"><p id="1cc8" class="jv jw kw jx b jy jz ka kb kc kd ke kf kx kh ki kj ky kl km kn kz kp kq kr ks ig bi translated">为什么开发环境不使用预加载占位符？</p><p id="69b6" class="jv jw kw jx b jy jz ka kb kc kd ke kf kx kh ki kj ky kl km kn kz kp kq kr ks ig bi translated">因为开发环境无法获取生成信息，如生成哈希，所以无法生成清单文件。</p><p id="89cb" class="jv jw kw jx b jy jz ka kb kc kd ke kf kx kh ki kj ky kl km kn kz kp kq kr ks ig bi translated">同时，开发环境从生成预加载节点中几乎没有产生利润</p><p id="06ba" class="jv jw kw jx b jy jz ka kb kc kd ke kf kx kh ki kj ky kl km kn kz kp kq kr ks ig bi translated">为什么CSR中不需要考虑预加载，SSR中需要额外处理？</p><p id="5d83" class="jv jw kw jx b jy jz ka kb kc kd ke kf kx kh ki kj ky kl km kn kz kp kq kr ks ig bi translated">因为在构建CSR时会自动生成全部预加载代码</p><p id="f5e5" class="jv jw kw jx b jy jz ka kb kc kd ke kf kx kh ki kj ky kl km kn kz kp kq kr ks ig bi translated">另一方面，SSR只允许加载条目所需的预加载节点，因为它可以获得更多的信息，比如用户访问了哪个页面。虽然牺牲了一些便利性，但是获得了灵活创建预加载节点的能力，减少了资源浪费</p><p id="443e" class="jv jw kw jx b jy jz ka kb kc kd ke kf kx kh ki kj ky kl km kn kz kp kq kr ks ig bi translated"><a class="ae mi" href="https://ssr.vuejs.org/zh/api/#shouldpreload" rel="noopener ugc nofollow" target="_blank"><em class="in">https://ssr.vuejs.org/en/api/#shouldpreload</em></a></p></blockquote><p id="f78c" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">也就是说，返回给客户端的完整HTML至少需要包含</p><p id="6447" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">模板<em class="kw">index.html</em></p><p id="0e9b" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">页面内容<em class="kw"> app-html </em></p><p id="765e" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">预载节点<em class="kw">预载链接</em>(开发环境不需要)</p><p id="d3bc" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">模板是静态的，页面内容和预加载信息由服务器为每个请求动态生成</p><h2 id="3600" class="mj lb in bd lc mk ml dn lg mm mn dp lk kg mo mp lo kk mq mr ls ko ms mt lw mu bi translated">server.js</h2><p id="332c" class="pw-post-body-paragraph jv jw in jx b jy ly ka kb kc lz ke kf kg ma ki kj kk mb km kn ko mc kq kr ks ig bi translated"><strong class="jx io">开发环境用于调试</strong>的SSR服务器</p><figure class="me mf mg mh gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi ng"><img src="../Images/8bd502a2a6639a3660a14890eee5011b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5E1Mzu2YKRIQmWHOxF2OMw.png"/></div></div></figure><p id="e699" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><strong class="jx io">该文件不会在生产环境中使用</strong></p><p id="5726" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><strong class="jx io">该文件不会在生产环境中使用</strong></p><p id="f7b0" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><strong class="jx io">该文件不会在生产环境中使用</strong></p><p id="2d69" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">重要的事情说三遍，打包的产品不会有任何server.js相关的代码</p><blockquote class="kt ku kv"><p id="4977" class="jv jw kw jx b jy jz ka kb kc kd ke kf kx kh ki kj ky kl km kn kz kp kq kr ks ig bi translated">为什么不把server.js放在产品里？</p><p id="c475" class="jv jw kw jx b jy jz ka kb kc kd ke kf kx kh ki kj ky kl km kn kz kp kq kr ks ig bi translated">请参见下面的“生产环境不能开箱即用”一节</p><p id="1090" class="jv jw kw jx b jy jz ka kb kc kd ke kf kx kh ki kj ky kl km kn kz kp kq kr ks ig bi translated">server.js的作用是</p></blockquote><p id="436a" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">1.当接收到页面请求时，使用vite.ssrLoadModule读取SSR服务器条目文件，并返回呈现页面内容的函数(render函数)</p><blockquote class="kt ku kv"><p id="e561" class="jv jw kw jx b jy jz ka kb kc kd ke kf kx kh ki kj ky kl km kn kz kp kq kr ks ig bi translated">为什么需要使用vite.ssrLoadModule而不是require函数？</p><p id="5bbd" class="jv jw kw jx b jy jz ka kb kc kd ke kf kx kh ki kj ky kl km kn kz kp kq kr ks ig bi translated"><a class="ae mi" href="http://nodejs.cn/api/esm.html#import-expressions" rel="noopener ugc nofollow" target="_blank"> <em class="in">动态导入</em> </a>用于vite . ssrloadmodule<a class="ae mi" href="http://nodejs.cn/api/esm.html#import-expressions" rel="noopener ugc nofollow" target="_blank"><em class="in"/></a>后面，同时兼容CommonJS模块和es模块</p><p id="9894" class="jv jw kw jx b jy jz ka kb kc kd ke kf kx kh ki kj ky kl km kn kz kp kq kr ks ig bi translated">同时，vite.ssrLoadModule还包含了热更新的能力</p></blockquote><p id="3c48" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">2.运行render函数获取页面内容的HTML并替换</p><blockquote class="kt ku kv"><p id="3e83" class="jv jw kw jx b jy jz ka kb kc kd ke kf kx kh ki kj ky kl km kn kz kp kq kr ks ig bi translated">Will other static resources (js/css/img) also execute vite.ssrLoadModule?</p><p id="0579" class="jv jw kw jx b jy jz ka kb kc kd ke kf kx kh ki kj ky kl km kn kz kp kq kr ks ig bi translated">No, only the html as the entry will trigger vite.ssrLoadModule, other static resource requests will be intercepted and returned in advance by the built-in static resource server in vite.middlewares</p></blockquote><h2 id="32c9" class="mj lb in bd lc mk ml dn lg mm mn dp lk kg mo mp lo kk mq mr ls ko ms mt lw mu bi translated">main.js</h2><p id="6f3d" class="pw-post-body-paragraph jv jw in jx b jy ly ka kb kc lz ke kf kg ma ki kj kk mb km kn ko mc kq kr ks ig bi translated">public entry file</p><figure class="me mf mg mh gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi nh"><img src="../Images/aaba38234d8c8ef6d573edb528eddcec.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-zud-7p0w1jTeNyV4UDHkA.png"/></div></div></figure><p id="7d93" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">In SSR, both the client entry file entry-client.js and the server entry file entry-server.js will execute main.js</p><p id="c112" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">The difference from CSR is that SSR’s main.js declares a factory function called <em class="kw"> bootstrap </em>，bootstrap 替换原来的并立即执行。</p><blockquote class="kt ku kv"><p id="3912" class="jv jw kw jx b jy jz ka kb kc kd ke kf kx kh ki kj ky kl km kn kz kp kq kr ks ig bi translated">未指定函数名，入口客户端/入口服务器可以正确找到该函数</p></blockquote><p id="7f31" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">为每个请求创建一个新的Vue实例，通过工厂函数保证每个请求的数据和状态相互独立</p><p id="5949" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">此外，SSR使用<em class="kw">createsrapp</em>来创建Vue实例。与CSR使用的<em class="kw"> createApp </em>不同的是<em class="kw">createsrapp</em>会根据当前环境实现不同的功能。</p><p id="59a0" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">SSR客户端:“激活”静态HTML(下一节解释这是什么意思)</p><p id="43d1" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">SSR服务器:类似于<em class="kw"> createApp </em>，区别在于一个在客户端创建Vue实例，另一个在服务器端创建Vue实例</p><h2 id="3386" class="mj lb in bd lc mk ml dn lg mm mn dp lk kg mo mp lo kk mq mr ls ko ms mt lw mu bi translated">条目-客户端. js</h2><p id="ff8e" class="pw-post-body-paragraph jv jw in jx b jy ly ka kb kc lz ke kf kg ma ki kj kk mb km kn ko mc kq kr ks ig bi translated">SSR客户端条目文件</p><figure class="me mf mg mh gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi ni"><img src="../Images/d83d7dfa2595a138f38d477f62e11da5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*475_mgI-9kZqeQga8cLlKA.png"/></div></div></figure><p id="0689" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">服务器返回给客户机的HTML包含一个指向SSR客户机条目/src/entry-client.js的脚本标记</p><figure class="me mf mg mh gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi md"><img src="../Images/76b76b1e5f857fec15b9c7c3f54ad1d7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1rtvz7f4fMBoLWghgmOdpQ.png"/></div></div></figure><p id="5f29" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">客户端获得入口文件后，执行main.js中的<em class="kw">createsrapp</em>来“<a class="ae mi" href="https://vuejs.org/guide/scaling-up/ssr.html#client-hydration" rel="noopener ugc nofollow" target="_blank">T5】激活 </a>静态HTML</p><figure class="me mf mg mh gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi md"><img src="../Images/f80f9e8d7cb2c14b79608cbbbedab883.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*iaGbwW14TOolOBesFdFywA.png"/></div></div></figure><p id="6d4d" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">由于服务器会将包含页面内容的完整HTML发送给客户端，Vue不会重新创建HTML节点，而是使用<em class="kw">createsrapp</em>将事件绑定到获取的HTML节点，初始化背后Vue实例的状态等。，这样它看起来就像由CSR呈现的页面一样</p><div class="nj nk gp gr nl nm"><a href="https://github.com/vuejs/core/blob/main/packages/runtime-core/src/apiCreateApp.ts#L298" rel="noopener  ugc nofollow" target="_blank"><div class="nn ab fo"><div class="no ab np cl cj nq"><h2 class="bd io gy z fp nr fr fs ns fu fw im bi translated">主vuejs/core处的core/apiCreateApp.ts</h2><div class="nt l"><h3 class="bd b gy z fp nr fr fs ns fu fw dk translated">此文件包含双向Unicode文本，其解释或编译可能与下面显示的不同…</h3></div><div class="nu l"><p class="bd b dl z fp nr fr fs ns fu fw dk translated">github.com</p></div></div><div class="nv l"><div class="nw l nx ny nz nv oa jt nm"/></div></div></a></div><figure class="me mf mg mh gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi md"><img src="../Images/49552672fb2c5ab5b12ba3f2a3a8b334.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*AE4byexpO9SbA45jPHaaNg.png"/></div></div></figure><p id="5bd6" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">激活后，HTML完全被客户端接管，行为与CSR一致。到目前为止，与SSR服务器无关。</p><p id="8682" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">本文仅针对最简单的场景。对于SSR框架，如next.js、nuxt.js、remix.js，主张SSR客户端与SSR服务器集成，水化后也可能与SSR服务器通信</p><h2 id="e3c2" class="mj lb in bd lc mk ml dn lg mm mn dp lk kg mo mp lo kk mq mr ls ko ms mt lw mu bi translated">入门级服务器. js</h2><p id="c2a9" class="pw-post-body-paragraph jv jw in jx b jy ly ka kb kc lz ke kf kg ma ki kj kk mb km kn ko mc kq kr ks ig bi translated">SSR服务器条目文件</p><figure class="me mf mg mh gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi nh"><img src="../Images/a581a1c45b8fb8919898ecc6bf96ce63.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nyhUoDKEig2dGCSXuEC6NQ.png"/></div></div></figure><p id="cc7d" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">entry-server.js需要导出一个生成页面内容的函数</p><p id="a9ce" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">Vue提供了<em class="kw"> renderToString </em>，可以很容易地将Vue实例转换成页面内容的HTML字符串</p><p id="c6d1" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">此外，示例中的entry-server.js还负责动态生成预加载节点(开发环境没有实际作用)</p><blockquote class="kt ku kv"><p id="1aa7" class="jv jw kw jx b jy jz ka kb kc kd ke kf kx kh ki kj ky kl km kn kz kp kq kr ks ig bi translated">对entry-server.js的输入参数、输出参数和函数名没有严格的要求，server.js可以正确的从entry-server.js获取渲染函数。</p><p id="015f" class="jv jw kw jx b jy jz ka kb kc kd ke kf kx kh ki kj ky kl km kn kz kp kq kr ks ig bi translated">ctx对象在render函数中的作用是什么？</p><p id="46c5" class="jv jw kw jx b jy jz ka kb kc kd ke kf kx kh ki kj ky kl km kn kz kp kq kr ks ig bi translated">以上注释有详细解释，主要用于<strong class="jx io"> SSR服务器</strong>(不能使用<strong class="jx io"> SSR客户端)</strong>中服务器与Vue组件之间的数据通信</p><p id="fe07" class="jv jw kw jx b jy jz ka kb kc kd ke kf kx kh ki kj ky kl km kn kz kp kq kr ks ig bi translated">ctx可以存储一些只有SSR服务器才能获得的数据(cookies、headers ),并将其作为参数传递给renderToString</p><p id="b69f" class="jv jw kw jx b jy jz ka kb kc kd ke kf kx kh ki kj ky kl km kn kz kp kq kr ks ig bi translated">之后，Vue组件可以通过useSSRContext返回ctx对象来获取这些数据</p></blockquote><figure class="me mf mg mh gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi ob"><img src="../Images/cf9543cf4defd73c8ebf97185491a3c2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0Xkr8Q9TdKXeYhIMBYf2tQ.png"/></div></div></figure><h2 id="36d7" class="mj lb in bd lc mk ml dn lg mm mn dp lk kg mo mp lo kk mq mr ls ko ms mt lw mu bi translated">流程图</h2><figure class="me mf mg mh gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi md"><img src="../Images/a23114f7516490ef4976990cb994a20a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*E7ir0geIilsbEWKaMwh7Rw.png"/></div></div></figure><h1 id="05fd" class="la lb in bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">项目结构(生产)</h1><p id="75f0" class="pw-post-body-paragraph jv jw in jx b jy ly ka kb kc lz ke kf kg ma ki kj kk mb km kn ko mc kq kr ks ig bi translated">生产环境中的产品结构如下</p><pre class="me mf mg mh gt mv mw mx my aw mz bi"><span id="b9a1" class="mj lb in mw b gy na nb l nc nd">├── client <em class="kw">// SSR client files</em><br/> │ ├── assets <em class="kw">// static files</em><br/> │ │ ├── Home.149d59e2.css<br/> │ │ ├── Home.c041839f.js<br/> │ │ ├── index.b988c137.css<br/> │ │ ├── index.cd252472.js<br/> │ │ └── vendor.9ebeb296.js<br/> │ ├── index.html <em class="kw">// template，include SSR client entry output</em><br/> │ └── ssr-manifest.json <em class="kw">// output manifest</em><br/> └── server <em class="kw">// SSR server file</em><br/> └── entry-server.js <em class="kw">// SSR server entry</em></span></pre><h2 id="1385" class="mj lb in bd lc mk ml dn lg mm mn dp lk kg mo mp lo kk mq mr ls ko ms mt lw mu bi translated">index.html</h2><figure class="me mf mg mh gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi oc"><img src="../Images/ccaf840cb4c52432955130a62f806293.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PvDJJFhpDl51tAAFEwvwrg.png"/></div></div></figure><p id="8ed5" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">SSR客户端条目文件entry-client.js由Vite构建，并发展成一个静态资源文件</p><p id="610b" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">/assets/vendor.js包含用于在客户端激活HTML的Vue运行时</p><p id="5919" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">/assets/index.js包含每个页面的Vue组件</p><p id="af3f" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><em class="kw">T18】！— app-html - &gt; </em>和<em class="kw"> &lt;！—预加载-链接- &gt; </em>仍被保留。当SSR服务器收到页面请求时，它将动态替换这两个占位符</p><h2 id="beab" class="mj lb in bd lc mk ml dn lg mm mn dp lk kg mo mp lo kk mq mr ls ko ms mt lw mu bi translated">ssr-manifest.json</h2><p id="ba30" class="pw-post-body-paragraph jv jw in jx b jy ly ka kb kc lz ke kf kg ma ki kj kk mb km kn ko mc kq kr ks ig bi translated"><a class="ae mi" href="https://vitejs.dev/guide/ssr.html#generating-preload-directives" rel="noopener ugc nofollow" target="_blank"> <em class="kw">生成-预载-指令</em> </a></p><figure class="me mf mg mh gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi md"><img src="../Images/f00ad8f349935161cc083edbe341e6ca.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Siw9bvxLYJzSnBMD6E5FLQ.png"/></div></div></figure><p id="a036" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">当服务器执行render函数时，它将额外读取ssr-manifest.json并动态生成preload节点</p><h2 id="3a79" class="mj lb in bd lc mk ml dn lg mm mn dp lk kg mo mp lo kk mq mr ls ko ms mt lw mu bi translated">入门级服务器. js</h2><p id="6663" class="pw-post-body-paragraph jv jw in jx b jy ly ka kb kc lz ke kf kg ma ki kj kk mb km kn ko mc kq kr ks ig bi translated">Vite还会在构建时将所有Vue组件编译到entry-server.js中</p><figure class="me mf mg mh gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi md"><img src="../Images/3b4921e09fb0aa45e482b55ebb329049.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*iQqUVceJ3TZqtI92Fndkow.png"/></div></div></figure><blockquote class="kt ku kv"><p id="4e7c" class="jv jw kw jx b jy jz ka kb kc kd ke kf kx kh ki kj ky kl km kn kz kp kq kr ks ig bi translated">看产品结构可以发现，SSR客户端生成的静态资源文件和构造时在entry-server.js中额外注入的代码实际上代表的是同一个Vue组件</p><p id="51d6" class="jv jw kw jx b jy jz ka kb kc kd ke kf kx kh ki kj ky kl km kn kz kp kq kr ks ig bi translated">但是考虑到SSR客户端和服务器端的区别，Vite并没有直接重用客户端的静态资源文件为entry-server.js，而是一次打包。个人觉得还是有一定的优化空间的。</p></blockquote><p id="611e" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">构建的产品中没有server.js，验证server.js只存在于开发环境中</p><p id="c764" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">一般来说，<strong class="jx io"> entry-server.js是一个只负责返回页面内容的函数</strong>，entry-server.js单独是无法启动SSR服务器的</p><p id="1d9a" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">那么，如何为生产环境启动SSR服务器呢？</p><p id="5a65" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">这里我们需要一个定制服务器，作为生产环境的“server.js”。有关详细信息，请参见“生产环境不能开箱即用”一节。</p><h2 id="ca39" class="mj lb in bd lc mk ml dn lg mm mn dp lk kg mo mp lo kk mq mr ls ko ms mt lw mu bi translated">流程图</h2><figure class="me mf mg mh gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi md"><img src="../Images/23ee6327a475810e1cf19348af77289a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0gfbTO6AMpSSjEcYcdeBxQ.png"/></div></div></figure><h1 id="b71a" class="la lb in bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">当前问题</h1><p id="1816" class="pw-post-body-paragraph jv jw in jx b jy ly ka kb kc lz ke kf kg ma ki kj kk mb km kn ko mc kq kr ks ig bi translated">截至目前(Vite 2.7.13)，Vite SSR仍处于实验阶段</p><p id="b782" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">Vite在问题区 正式开设了<a class="ae mi" href="https://github.com/vitejs/vite/issues/4231" rel="noopener ugc nofollow" target="_blank"> <em class="kw">讨论区</em></a></p><figure class="me mf mg mh gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi md"><img src="../Images/38bd6d0ca0716ceed70cd5582d21bb32.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8U__T2_bniuC1p1GX6tkiA.png"/></div></div></figure><figure class="me mf mg mh gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi md"><img src="../Images/9673b50792b0677e0334e30ef19a6f8c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zohnZqe4HtSoP69UlTAi3w.png"/></div></div></figure><p id="3a74" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">为什么在Vue3发布两年多，Vite发布一年多之后，Vite SSR仍然无法正式投入使用？</p><p id="b0a2" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">围绕问题领域的讨论主要分为以下几个问题</p><h2 id="31f7" class="mj lb in bd lc mk ml dn lg mm mn dp lk kg mo mp lo kk mq mr ls ko ms mt lw mu bi translated">生产环境不能开箱即用</h2><p id="e0ac" class="pw-post-body-paragraph jv jw in jx b jy ly ka kb kc lz ke kf kg ma ki kj kk mb km kn ko mc kq kr ks ig bi translated">相关问题:<a class="ae mi" href="https://github.com/vitejs/vite/discussions/4230#discussioncomment-1162698" rel="noopener ugc nofollow" target="_blank"><em class="kw">https://github . com/vitejs/vite/discussions/4230 # discussion comment-1162698</em></a></p><p id="2ebf" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">如前所述，Vite只会在开发环境中提供一个服务器，产品中不会存在server.js。因此，为了使代码在生产环境中正常运行，还需要一个生产服务器。</p><p id="e928" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">这里肯定有人要问了，为什么不包server.js呢？</p><p id="1678" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">结合问题区的讨论，猜测Vite的动机</p><p id="f1e6" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">由于市面上基于节点的服务器端框架种类繁多(express、koa、nest、serverless)，一旦Vite绑定了某一风格的服务器端框架，其他风格的开发者就不得不跟随</p><p id="74e6" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">此外，提供开箱即用的服务器也限制了对其进行定制的能力。为了增加框架的通用性，Vite只是让产品不绑定到任何服务器端框架，而是由开发人员单独进行适配</p><p id="875b" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">例如，要在生产环境中部署SSR服务器，您需要执行以下操作:</p><p id="4884" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">1.构建源代码并将产品上传到CDN服务器</p><figure class="me mf mg mh gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi md"><img src="../Images/ada2889a5d98e36a3dea2aaaae7a3bba.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1KdmKrrENuLUCo1IjfKRMQ.png"/></div></div></figure><p id="811c" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">2.创建一个单独的代码存储库来存储SSR服务器</p><p id="517b" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">3.创建一个定制服务器，可以是任何技术堆栈，如express、koa等。</p><figure class="me mf mg mh gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi md"><img src="../Images/2a64cd094cca2dcf28e363662d27a987.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*EozfDdq2hQDVY7iaXT0GZA.png"/></div></div></figure><p id="1e22" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">4.以express框架为例，直接复制<a class="ae mi" href="https://github.com/vitejs/vite/blob/main/packages/playground/ssr-vue/server.js" rel="noopener ugc nofollow" target="_blank"> <em class="kw">官方演示(express风格)</em> </a>的server.js代码</p><figure class="me mf mg mh gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi md"><img src="../Images/429ccb6fda70fee46f2a5f97d8c8179a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BwWJ3jUk4Gi9UsE72Q_jQg.png"/></div></div></figure><p id="d7ad" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">5.将server.js require的文件地址指向CDN(也可以使用CDN，只要能读取第一步的产品)</p><figure class="me mf mg mh gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi md"><img src="../Images/ba369570b4ee5f4647a2c041383b2398.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*om-QFoczTBfVeZar_sOxEA.png"/></div></div></figure><p id="cfb8" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">6.将process.env.NODE_ENV设置为“prod”(server . js通过NODE_ENV区分环境)，运行<em class="kw"> node server.js </em>，启动服务器</p><p id="6a22" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">可以发现，在生产环境中部署服务器还是有一定成本的。社区也意识到了这个痛点，提出了解决方案<a class="ae mi" href="https://github.com/axe-me/vite-plugin-node" rel="noopener ugc nofollow" target="_blank"> <em class="kw"> vite-plugin-node </em> </a></p><figure class="me mf mg mh gt jo gh gi paragraph-image"><div class="gh gi od"><img src="../Images/c13dc352a1a72f0674b726039c314096.png" data-original-src="https://miro.medium.com/v2/resize:fit:600/format:webp/0*hR9aK5B0leRsdz7f.png"/></div></figure><p id="ee11" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">这个插件将为Vite提供多个主流的服务器端框架适配器。开发者只需要选择其中一个服务器端框架，这样在开发环境中就不再需要server.js了(目的只针对开发环境，作者说以后会衍生。到构建侧)</p><figure class="me mf mg mh gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi oe"><img src="../Images/d226512fd2fdd072851cba8449f755d9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*j4cV_SJ3v4EFJWz3x7A59A.png"/></div></div></figure><p id="c83f" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">Vite官方如何回应还有待考证</p><h2 id="05d8" class="mj lb in bd lc mk ml dn lg mm mn dp lk kg mo mp lo kk mq mr ls ko ms mt lw mu bi translated">关于外部化的争论</h2><p id="368f" class="pw-post-body-paragraph jv jw in jx b jy ly ka kb kc lz ke kf kg ma ki kj kk mb km kn ko mc kq kr ks ig bi translated">相关问题:</p><p id="9549" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><a class="ae mi" href="https://cn.vitejs.dev/guide/ssr.html#ssr-externals" rel="noopener ugc nofollow" target="_blank"><em class="kw">https://cn.vitejs.dev/guide/ssr.html#ssr-externals</em></a></p><p id="6e48" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><a class="ae mi" href="https://github.com/vitejs/vite/discussions/4230#discussioncomment-997865" rel="noopener ugc nofollow" target="_blank"><em class="kw">https://github . com/vitejs/vite/discussions/4230 # discussion comment-997865</em></a></p><p id="a5c6" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><a class="ae mi" href="https://github.com/vitejs/vite/pull/5903" rel="noopener ugc nofollow" target="_blank"><em class="kw">https://github.com/vitejs/vite/pull/5903</em></a></p><p id="edd6" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><a class="ae mi" href="https://github.com/vitejs/vite/issues/4340" rel="noopener ugc nofollow" target="_blank">T23】https://github.com/vitejs/vite/issues/4340T25】</a></p><p id="b313" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">通过两种产品的区别理解什么是“外部化”</p><p id="61ef" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">外部化产品</p><figure class="me mf mg mh gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi of"><img src="../Images/df0b78872a8fcce1f1a8473890607a1e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*g5JlDXhqXng8VzhgJKcKCQ.png"/></div></div></figure><p id="d515" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">非外部化产品</p><figure class="me mf mg mh gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi og"><img src="../Images/8ee8a8ca0eefb83d83601e12ea2ba77a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VUnaJ4ZzkpIqwp1VxzcY_w.png"/></div></div></figure><p id="38b3" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">两者的区别是<strong class="jx io">代码是否打包</strong></p><p id="6da9" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">外部化后，依赖包(vue，vue-router，vuex)以require的形式引入，非外部化会对依赖进行打包(类似于webpack)</p><p id="3ff0" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">外化的好处是不对模块做任何处理，直接引用模块。因此，尽可能将模块外部化将显著优化构建速度和产品量。</p><p id="7b70" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">但是，对于一些特殊的环境，如worker、serverless、deno、docker，可能会对节点的本地加载模块(require/import)提供有限的支持。此时，您需要重新打包项目和依赖项，以生成一个不依赖于任何主机环境的js文件</p><figure class="me mf mg mh gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi md"><img src="../Images/6be7f1baf7b22e7c12587ca1ebe9d8a2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*v-35QY0YakrwR7cWXGicHw.png"/></div></div></figure><p id="5e9d" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">有些人认为，在生产环境中，所有模块都应该外部化，以提高性能并避免在打包模块时出现问题</p><p id="a13b" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">有些人认为所有模块都应该打包，以确保任何平台都能完美运行</p><p id="986e" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">所以目前还没有完美的解决方案，甚至连外化的判断条件都不稳定。</p><figure class="me mf mg mh gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi md"><img src="../Images/48e15a19096929c029e8181668467202.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FwW_jsYwkjO3Y2R8r9SY1g.png"/></div></div></figure><h2 id="1fb9" class="mj lb in bd lc mk ml dn lg mm mn dp lk kg mo mp lo kk mq mr ls ko ms mt lw mu bi translated">与CommonJS模块不兼容</h2><p id="7d84" class="pw-post-body-paragraph jv jw in jx b jy ly ka kb kc lz ke kf kg ma ki kj kk mb km kn ko mc kq kr ks ig bi translated">相关问题:<a class="ae mi" href="https://github.com/vitejs/vite/issues/5424" rel="noopener ugc nofollow" target="_blank">T3【https://github.com/vitejs/vite/issues/5424】T5</a></p><p id="d0f8" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">Vite的模块加载器(<em class="kw"> vite.ssrLoadModule </em>加载的模块，一旦CommonJS模块被引入到<strong class="jx io">项目本身</strong>中，就会出现如下错误</p><figure class="me mf mg mh gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi oh"><img src="../Images/2d93b5b1c0857d0de34f59464a5612a5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lvRb9WSP8mmfkRmC0k1VlQ.png"/></div></div></figure><figure class="me mf mg mh gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi oi"><img src="../Images/a6810bb60231a9e3ec453fa20096c94c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*lhBj1_vW7_VRPQm6.png"/></div></div></figure><p id="1808" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">原因是Vite的加载器由新的<a class="ae mi" href="https://github.com/vitejs/vite/blob/main/packages/vite/src/node/ssr/ssrModuleLoader.ts#L173" rel="noopener ugc nofollow" target="_blank"><em class="kw">async function</em></a>+<a class="ae mi" href="https://github.com/vitejs/vite/blob/3f27d58036/packages/vite/src/node/utils.ts#L634" rel="noopener ugc nofollow" target="_blank"><em class="kw">动态导入</em> </a>组成</p><figure class="me mf mg mh gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi md"><img src="../Images/f3e35771b235efa446ab938b7d278fd2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pxCxakslYgUg17Msqqot8w.png"/></div></div></figure><figure class="me mf mg mh gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi md"><img src="../Images/5208a46f824bebd04aed546be5259507.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*iHAdvwzWb4JpleaVIwc_Gg.png"/></div></div></figure><p id="6222" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">我们知道，当使用node运行一个js文件时，node运行时会将文件包装成一个函数，并注入一些特定的参数</p><figure class="me mf mg mh gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi oj"><img src="../Images/8d150128302151cefc13076e4fd0cb04.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*l7vKECI9o4dR-0PtW5noRA.png"/></div></div></figure><p id="6581" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">Vite SSR借鉴node的实现，通过一个新的AsyncFunction包装文件，使用<em class="kw"> global </em>作为上下文，传入<em class="kw"> ssrModule </em>、<em class="kw"> ssrImportMeta </em>等参数。</p><figure class="me mf mg mh gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi ob"><img src="../Images/3c30b5fbe5ed7aa6668e579c0148eca9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*o-OvPSgXyw-7BHbJbZZdeQ.png"/></div></div></figure><p id="d313" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">但是Vite并没有注入require函数，所以一旦执行require函数，就会提示找不到变量</p><p id="52b3" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">server.js不属于Vite接手的代码，可以用require</p><p id="20ac" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">官方的解释是，Vite应该在ESM模块环境下运行，ESM模块默认不支持CommonJS语法</p><figure class="me mf mg mh gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi md"><img src="../Images/a90e6dca85ef809d5ae9a11450ec9fd9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Fko7Wf-MpmoyNsXZueXksQ.png"/></div></div></figure><figure class="me mf mg mh gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi md"><img src="../Images/4c6a4c11bc074d2ce592970ce7129f55.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*G5asOGE5BTrsWpBoH_9cxw.png"/></div></div></figure><p id="3a37" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">所以Vite理论上不允许出现require、module.exports这样的语法</p><blockquote class="kt ku kv"><p id="ab22" class="jv jw kw jx b jy jz ka kb kc kd ke kf kx kh ki kj ky kl km kn kz kp kq kr ks ig bi translated">但是为了适应npm社区中大量的CommonJS模块，对于npm包，Vite还是会通过<a class="ae mi" href="https://cn.vitejs.dev/guide/dep-pre-bundling.html" rel="noopener ugc nofollow" target="_blank"> <em class="in">预捆绑将CommonJS转换为ESM，所以上面的场景只是针对项目本身的代码</em> </a></p></blockquote><p id="ffb2" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">当然，ESM为CommonJS预留了“后门”。通过<a class="ae mi" href="https://nodejs.org/api/module.html#modulecreaterequirefilename" rel="noopener ugc nofollow" target="_blank"> <em class="kw"> createRequire </em> </a>，可以在ESM模块中动态创建一个CommonJS模块加载器。</p><figure class="me mf mg mh gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi ok"><img src="../Images/c3328a82356cb7ae4c695e45e86ba19d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Q2xkw-935HswZ0ZB2O-JIg.png"/></div></div></figure><h1 id="3fba" class="la lb in bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">总结</h1><p id="da29" class="pw-post-body-paragraph jv jw in jx b jy ly ka kb kc lz ke kf kg ma ki kj kk mb km kn ko mc kq kr ks ig bi translated">SSR是指在服务器端生成完整HTML内容的技术，可以提高首屏时间，增加SEO。适用于用户量大，对首屏要求高的系统。</p><p id="bfdb" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">SSR同时涉及客户端和服务器端，需要编写兼容两端的代码，部署还需要额外的SSR服务器。</p><p id="8c35" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">Vite SSR还处于实验性质，产品的结构以及如何与npm生态系统兼容还需要进一步探讨。</p><p id="fb8e" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><em class="kw">更多内容看</em> <a class="ae mi" href="https://plainenglish.io/" rel="noopener ugc nofollow" target="_blank"> <strong class="jx io"> <em class="kw">说白了。报名参加我们的</em> <a class="ae mi" href="http://newsletter.plainenglish.io/" rel="noopener ugc nofollow" target="_blank"> <strong class="jx io"> <em class="kw">免费周报</em> </strong> </a> <em class="kw">。关注我们关于</em><a class="ae mi" href="https://twitter.com/inPlainEngHQ" rel="noopener ugc nofollow" target="_blank"><strong class="jx io"><em class="kw">Twitter</em></strong></a><em class="kw">和</em><a class="ae mi" href="https://www.linkedin.com/company/inplainenglish/" rel="noopener ugc nofollow" target="_blank"><strong class="jx io"><em class="kw">LinkedIn</em></strong></a><em class="kw">。加入我们的</em> <a class="ae mi" href="https://discord.gg/GtDtUAvyhW" rel="noopener ugc nofollow" target="_blank"> <strong class="jx io"> <em class="kw">社区</em> </strong> </a> <em class="kw">。</em></strong></a></p></div></div>    
</body>
</html>