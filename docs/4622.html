<html>
<head>
<title>Reduce Docker Image size for your Next.js App</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">减小Next.js应用程序的Docker图像大小</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/reduce-docker-image-size-for-your-next-js-app-bcb65d322222?source=collection_archive---------4-----------------------#2022-12-19">https://javascript.plainenglish.io/reduce-docker-image-size-for-your-next-js-app-bcb65d322222?source=collection_archive---------4-----------------------#2022-12-19</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><figure class="gl gn jl jm jn jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi jk"><img src="../Images/0d174f825d2b229385a5b958f6b2242d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*W92W0C9qFIOKiHsd.png"/></div></div></figure><h1 id="ccfd" class="jv jw in bd jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks bi translated">介绍</h1><p id="bfbc" class="pw-post-body-paragraph kt ku in kv b kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq ig bi translated">首先，我希望你知道Docker是什么，但如果你不知道:</p><blockquote class="lr ls lt"><p id="2400" class="kt ku lu kv b kw lv ky kz la lw lc ld lx ly lg lh lz ma lk ll mb mc lo lp lq ig bi translated">Docker是一个开发、发布和运行应用程序的开放平台</p></blockquote><p id="1e62" class="pw-post-body-paragraph kt ku in kv b kw lv ky kz la lw lc ld le ly lg lh li ma lk ll lm mc lo lp lq ig bi translated">你可以花时间<a class="ae md" href="https://docs.docker.com/get-started/overview/" rel="noopener ugc nofollow" target="_blank">了解一下</a></p><p id="e867" class="pw-post-body-paragraph kt ku in kv b kw lv ky kz la lw lc ld le ly lg lh li ma lk ll lm mc lo lp lq ig bi translated">另一方面，NextJS是一个灵活的React框架，它为你提供了构建快速web应用的基础。</p><h1 id="d003" class="jv jw in bd jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks bi translated">将你的应用归档</h1><p id="3baf" class="pw-post-body-paragraph kt ku in kv b kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq ig bi translated">在我们优化任何东西之前，我们必须首先对应用程序进行dockerize。假设我们的应用程序名为<code class="fe me mf mg mh b">my-space</code>。从以下内容开始:</p><p id="76dd" class="pw-post-body-paragraph kt ku in kv b kw lv ky kz la lw lc ld le ly lg lh li ma lk ll lm mc lo lp lq ig bi translated">创建<code class="fe me mf mg mh b">Dockerfile</code>:</p><pre class="mi mj mk ml gt mm mh mn bn mo mp bi"><span id="8443" class="mq jw in mh b be mr ms l mt mu">touch Dockerfile</span></pre><p id="7760" class="pw-post-body-paragraph kt ku in kv b kw lv ky kz la lw lc ld le ly lg lh li ma lk ll lm mc lo lp lq ig bi translated">忽略<code class="fe me mf mg mh b">dockerignore</code>中不必要的文件:</p><pre class="mi mj mk ml gt mm mh mn bn mo mp bi"><span id="4633" class="mq jw in mh b be mr ms l mt mu">node_modules<br/>.next<br/>.vscode<br/>.gitignore<br/>README.md<br/>.dockerignore<br/>.git</span></pre><p id="de58" class="pw-post-body-paragraph kt ku in kv b kw lv ky kz la lw lc ld le ly lg lh li ma lk ll lm mc lo lp lq ig bi translated">将它归档:</p><figure class="mi mj mk ml gt jo gh gi paragraph-image"><div class="gh gi mv"><img src="../Images/6f2329b7cda03b3e7a50f17e3c43f3dc.png" data-original-src="https://miro.medium.com/v2/resize:fit:398/format:webp/1*6BkaJCD2zST243a2a68wSw.png"/></div></figure><p id="92ff" class="pw-post-body-paragraph kt ku in kv b kw lv ky kz la lw lc ld le ly lg lh li ma lk ll lm mc lo lp lq ig bi translated">这是关于如何对你的应用程序进行dockerize的最基本的例子，现在让我们用:</p><pre class="mi mj mk ml gt mm mh mn bn mo mp bi"><span id="b2e6" class="mq jw in mh b be mr ms l mt mu">docker build -t my-space .</span></pre><p id="40f6" class="pw-post-body-paragraph kt ku in kv b kw lv ky kz la lw lc ld le ly lg lh li ma lk ll lm mc lo lp lq ig bi translated">现在看看大小:</p><figure class="mi mj mk ml gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi mw"><img src="../Images/8e059636686a17e8a6aa69b2e941d570.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xGPBUPnOYdZJcQ-rOeONag.png"/></div></div></figure><p id="9420" class="pw-post-body-paragraph kt ku in kv b kw lv ky kz la lw lc ld le ly lg lh li ma lk ll lm mc lo lp lq ig bi translated"><strong class="kv io">太疯狂了，2.42gb！！</strong></p><p id="670f" class="pw-post-body-paragraph kt ku in kv b kw lv ky kz la lw lc ld le ly lg lh li ma lk ll lm mc lo lp lq ig bi translated">难以置信的权利，我们不能发表这个图像，它太沉重了！</p><h1 id="b8d9" class="jv jw in bd jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks bi translated">缩小图像尺寸</h1><h2 id="73fa" class="mx jw in bd jx my mz dn kb na nb dp kf le nc nd kj li ne nf kn lm ng nh kr ni bi translated">使用阿尔卑斯山</h2><p id="84ad" class="pw-post-body-paragraph kt ku in kv b kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq ig bi translated">Node.js Docker团队维护一个<code class="fe me mf mg mh b">node:alpine</code>图像标签及其变体，以将Alpine Linux发行版的特定版本与Node.js运行时的版本相匹配。原始版本大小约为1gb。</p><p id="8098" class="pw-post-body-paragraph kt ku in kv b kw lv ky kz la lw lc ld le ly lg lh li ma lk ll lm mc lo lp lq ig bi translated">现在我们将转向<code class="fe me mf mg mh b">alpine</code>版本:</p><figure class="mi mj mk ml gt jo gh gi paragraph-image"><div class="gh gi nj"><img src="../Images/9a9e7bdc76c0aab0b94dc6e0ca547795.png" data-original-src="https://miro.medium.com/v2/resize:fit:508/format:webp/1*D6ilPGettZ6GJU93aI6Ygg.png"/></div></figure><figure class="mi mj mk ml gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi nk"><img src="../Images/0d1cd73f34efda165fffcb554a8012ce.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tvni_KLa9uvo59cPOj_PBQ.png"/></div></div></figure><p id="5f21" class="pw-post-body-paragraph kt ku in kv b kw lv ky kz la lw lc ld le ly lg lh li ma lk ll lm mc lo lp lq ig bi translated">现在尺寸缩小到了<strong class="kv io"> 1.65gb，比</strong>小了800mb。这是一个好的开始！</p><h2 id="1d9d" class="mx jw in bd jx my mz dn kb na nb dp kf le nc nd kj li ne nf kn lm ng nh kr ni bi translated">多阶段构建</h2><p id="10ba" class="pw-post-body-paragraph kt ku in kv b kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq ig bi translated">多阶段构建对于那些努力优化docker文件同时保持它们易于阅读和维护的人来说非常有用。</p><p id="cae4" class="pw-post-body-paragraph kt ku in kv b kw lv ky kz la lw lc ld le ly lg lh li ma lk ll lm mc lo lp lq ig bi translated">我们将在<code class="fe me mf mg mh b">Dockerfile</code>中创建2个阶段。我将称之为<code class="fe me mf mg mh b">builder</code>和<code class="fe me mf mg mh b">runner</code></p><p id="b0b0" class="pw-post-body-paragraph kt ku in kv b kw lv ky kz la lw lc ld le ly lg lh li ma lk ll lm mc lo lp lq ig bi translated">通过这种方式，我们可以删除映像中不必要的文件:</p><figure class="mi mj mk ml gt jo gh gi paragraph-image"><div class="gh gi nl"><img src="../Images/566b4f037e382ea0624fe9d4d107eaaa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1056/format:webp/1*lSjMS7wUJufcq5LVXkm4qw.png"/></div></figure><p id="5c8e" class="pw-post-body-paragraph kt ku in kv b kw lv ky kz la lw lc ld le ly lg lh li ma lk ll lm mc lo lp lq ig bi translated">我们将从<code class="fe me mf mg mh b">builder</code>中挑选文件，并将其移动到我们最终将使用的<code class="fe me mf mg mh b">runner</code></p><figure class="mi mj mk ml gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi nm"><img src="../Images/5ab4361dfa6b595d9cbfcf0236fff0e4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Iqf5fHa4WhiNEEajGmeGkA.png"/></div></div></figure><p id="9d9d" class="pw-post-body-paragraph kt ku in kv b kw lv ky kz la lw lc ld le ly lg lh li ma lk ll lm mc lo lp lq ig bi translated">大小下降到<strong class="kv io"> 1.36gb，约300mb小，我们做得很好！</strong></p><h2 id="0656" class="mx jw in bd jx my mz dn kb na nb dp kf le nc nd kj li ne nf kn lm ng nh kr ni bi translated">移除重复层</h2><p id="1a0b" class="pw-post-body-paragraph kt ku in kv b kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq ig bi translated">你可以看到有东西在复制。是的，我们为每个阶段安装了两次依赖项。虽然这种工程和项目规模仍然是一样的。由于缓存和图层的原因，图像尺寸仍然很大。</p><p id="2477" class="pw-post-body-paragraph kt ku in kv b kw lv ky kz la lw lc ld le ly lg lh li ma lk ll lm mc lo lp lq ig bi translated">所以我们可以在构建阶段选择<code class="fe me mf mg mh b">node_modules</code>:</p><figure class="mi mj mk ml gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi nn"><img src="../Images/ed90dca984b0b3218d50c8508e32b495.png" data-original-src="https://miro.medium.com/v2/resize:fit:1258/format:webp/1*SHLKZrBXJtSW6jmYXJcxgw.png"/></div></div></figure><figure class="mi mj mk ml gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi no"><img src="../Images/13a33254fd4fb0bcefa8ca1976ea56b5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fZbbP0w0Jm0HvFBomB_-Jg.png"/></div></div></figure><p id="4dca" class="pw-post-body-paragraph kt ku in kv b kw lv ky kz la lw lc ld le ly lg lh li ma lk ll lm mc lo lp lq ig bi translated">对于一个NextJS应用程序来说，现在的大小相当不错，<strong class="kv io">低于500mb </strong></p><p id="af60" class="pw-post-body-paragraph kt ku in kv b kw lv ky kz la lw lc ld le ly lg lh li ma lk ll lm mc lo lp lq ig bi translated">但是我们还可以让它变轻！</p><h1 id="4844" class="jv jw in bd jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks bi translated">输出文件跟踪</h1><p id="dd14" class="pw-post-body-paragraph kt ku in kv b kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq ig bi translated">在构建期间，Next.js将自动跟踪每个页面及其依赖项，以确定部署应用程序的生产版本所需的所有文件。</p><p id="aef7" class="pw-post-body-paragraph kt ku in kv b kw lv ky kz la lw lc ld le ly lg lh li ma lk ll lm mc lo lp lq ig bi translated">此功能有助于大幅降低部署规模。以前，当使用Docker部署时，您需要安装软件包<code class="fe me mf mg mh b">dependencies</code>中的所有文件来运行<code class="fe me mf mg mh b">next start</code>。从Next.js 12开始，您可以利用<code class="fe me mf mg mh b">.next/</code>目录中的输出文件跟踪来只包含必要的文件。</p><p id="c1df" class="pw-post-body-paragraph kt ku in kv b kw lv ky kz la lw lc ld le ly lg lh li ma lk ll lm mc lo lp lq ig bi translated">在您的<code class="fe me mf mg mh b">next.config.js</code>文件中，启用独立输出</p><pre class="mi mj mk ml gt mm mh mn bn mo mp bi"><span id="fc7c" class="mq jw in mh b be mr ms l mt mu">experimental: {<br/>    outputStandalone: true,<br/>  },</span></pre><p id="f8ad" class="pw-post-body-paragraph kt ku in kv b kw lv ky kz la lw lc ld le ly lg lh li ma lk ll lm mc lo lp lq ig bi translated">这将在<code class="fe me mf mg mh b">.next/standalone</code>创建一个文件夹，然后可以在不安装<code class="fe me mf mg mh b">node_modules</code>的情况下自行部署。</p><figure class="mi mj mk ml gt jo gh gi paragraph-image"><div class="gh gi np"><img src="../Images/d1e06d82def7ccdf9c60fb8353abfbc2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1242/format:webp/1*bFO0slh57S4YAQIKWuW94g.png"/></div></figure><figure class="mi mj mk ml gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi nq"><img src="../Images/ab3e2cf695bfb32a4a67291d67346956.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6Z4FAH7DNV2JOMD1uLlHzw.png"/></div></div></figure><p id="fe84" class="pw-post-body-paragraph kt ku in kv b kw lv ky kz la lw lc ld le ly lg lh li ma lk ll lm mc lo lp lq ig bi translated">大小现在是<strong class="kv io"> 176mb！对大多数情况来说足够小</strong></p><h1 id="195d" class="jv jw in bd jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks bi translated">结论</h1><p id="80ae" class="pw-post-body-paragraph kt ku in kv b kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq ig bi translated">这只是一个关于如何优化docker图片大小的简单例子，你可以在Docker文档中找到最适合你的应用的处理方法！</p><h2 id="945c" class="mx jw in bd jx my mz dn kb na nb dp kf le nc nd kj li ne nf kn lm ng nh kr ni bi translated">更多内容请访问<a class="ae md" href="https://plainenglish.io/" rel="noopener ugc nofollow" target="_blank"> PlainEnglish.io </a>。</h2><p id="8f48" class="pw-post-body-paragraph kt ku in kv b kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq ig bi translated">报名参加我们的<a class="ae md" href="http://newsletter.plainenglish.io/" rel="noopener ugc nofollow" target="_blank"> <strong class="kv io">免费每周简讯</strong> </a>。关注我们<a class="ae md" href="https://twitter.com/inPlainEngHQ" rel="noopener ugc nofollow" target="_blank"> <strong class="kv io">推特</strong> </a>，<a class="ae md" href="https://www.linkedin.com/company/inplainenglish/" rel="noopener ugc nofollow" target="_blank"><strong class="kv io">LinkedIn</strong></a><strong class="kv io">，</strong><a class="ae md" href="https://www.youtube.com/channel/UCtipWUghju290NWcn8jhyAw" rel="noopener ugc nofollow" target="_blank"><strong class="kv io">YouTube</strong></a><strong class="kv io">，</strong> <a class="ae md" href="https://discord.gg/GtDtUAvyhW" rel="noopener ugc nofollow" target="_blank"> <strong class="kv io">不和谐</strong> </a> <strong class="kv io">。</strong></p><h2 id="3e9e" class="mx jw in bd jx my mz dn kb na nb dp kf le nc nd kj li ne nf kn lm ng nh kr ni bi translated">对扩展您的软件启动感兴趣吗？检查<a class="ae md" href="https://circuit.ooo/?utm=publication-post-cta" rel="noopener ugc nofollow" target="_blank">电路</a>。</h2><p id="77b0" class="pw-post-body-paragraph kt ku in kv b kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq ig bi translated">我们提供免费的专家建议和定制解决方案，帮助您建立对您的技术产品或服务的认知和采用。</p></div></div>    
</body>
</html>