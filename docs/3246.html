<html>
<head>
<title>React Official Answer: The Right Way of Requesting Data in React18 (Other Frameworks Also Apply)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">React官方回答:React18中请求数据的正确方式(其他框架也适用)</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/react-official-answer-the-right-way-of-requesting-data-in-react18-other-frameworks-also-apply-50d907c1f6c4?source=collection_archive---------3-----------------------#2022-08-12">https://javascript.plainenglish.io/react-official-answer-the-right-way-of-requesting-data-in-react18-other-frameworks-also-apply-50d907c1f6c4?source=collection_archive---------3-----------------------#2022-08-12</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="38fa" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">React 18中使用useEffect进行数据提取有哪些问题？</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/7ac577546ac5b689083eb19d7ba7c794.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*yGDrrq5fA6TAfAjR"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk">Photo by <a class="ae kv" href="https://unsplash.com/@r3dmax?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Jonatan Pie</a> on <a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="623e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">有些学生喜欢以下列方式用useEffect请求初始数据:</p><pre class="kg kh ki kj gt ls lt lu lv aw lw bi"><span id="2410" class="lx ly iq lt b gy lz ma l mb mc">useEffect(() =&gt; {<br/>  fetch(xxx).then(data =&gt; setState(data.json()))<br/>}, [])</span></pre><p id="4fcb" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">但是React18并不推荐这种方式。这样写有什么问题？如果这个不推荐，推荐的方式是什么？<a class="ae kv" href="https://www.reddit.com/r/reactjs/comments/vi6q6f/what_is_the_recommended_way_to_load_data_for/" rel="noopener ugc nofollow" target="_blank">让我们来看看Dan是如何回应上面Reddit的问题</a>的。</p><h2 id="605d" class="lx ly iq bd md me mf dn mg mh mi dp mj lf mk ml mm lj mn mo mp ln mq mr ms mt bi translated">这是一个常见的问题。</h2><p id="2970" class="pw-post-body-paragraph kw kx iq ky b kz mu jr lb lc mv ju le lf mw lh li lj mx ll lm ln my lp lq lr ij bi translated">除了React，大多数组织为“组件”的前端框架都有类似的API，如下所示:</p><ul class=""><li id="935d" class="mz na iq ky b kz la lc ld lf nb lj nc ln nd lr ne nf ng nh bi translated">影响</li><li id="1599" class="mz na iq ky b kz ni lc nj lf nk lj nl ln nm lr ne nf ng nh bi translated">didMount/didUpdate</li></ul><p id="9f1d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如果需要“初始化时请求数据”，这类框架选择在上述回调函数内执行请求操作，并在数据返回时更新状态。所以，这不是一个需要反应的独特问题。相反，他很普通。</p><p id="1989" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">它在React中如此突出的原因是React官员正在引导开发人员远离以这种形式编写代码(通过说“useEffect在严格模式下执行两次”来放大问题)。React这样做的原因是为了项目的“性能”和“UX”(用户体验)。我们再来谈谈这其中的含义。请注意，这些含义也适用于其他框架。为什么不推荐这个？</p><h2 id="5d00" class="lx ly iq bd md me mf dn mg mh mi dp mj lf mk ml mm lj mn mo mp ln mq mr ms mt bi translated"><strong class="ak">比赛条件</strong></h2><p id="edc9" class="pw-post-body-paragraph kw kx iq ky b kz mu jr lb lc mv ju le lf mw lh li lj mx ll lm ln my lp lq lr ij bi translated">在useEffect中请求数据时，您面临的第一个问题是“需要解决竞争条件问题”。假设您有一个组件用户，它接收userID作为道具，并在用userID请求数据后显示用户信息。你应该这样写:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nn no l"/></div></figure><p id="21a3" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这里有一个在开发阶段很难重现的bug如果userID变化得足够快，就会发起多个不同的用户请求。最终显示哪个用户的数据，取决于先返回哪个请求。这就是“请求竞争问题”。</p><h2 id="bc81" class="lx ly iq bd md me mf dn mg mh mi dp mj lf mk ml mm lj mn mo mp ln mq mr ms mt bi translated">单击后退按钮后重新请求数据</h2><p id="0684" class="pw-post-body-paragraph kw kx iq ky b kz mu jr lb lc mv ju le lf mw lh li lj mx ll lm ln my lp lq lr ij bi translated">如果用户导航到一个新页面，然后通过浏览器的后退按钮返回到当前页面，他不会立即看到跳转之前所在的页面。相反，他可能会看到一个白屏——因为他仍然需要重新执行useEffect来获取初始数据。这个问题的本质原因是没有缓存初始数据。</p><h2 id="3b58" class="lx ly iq bd md me mf dn mg mh mi dp mj lf mk ml mm lj mn mo mp ln mq mr ms mt bi translated">在CSR期间，白屏时间</h2><p id="a209" class="pw-post-body-paragraph kw kx iq ky b kz mu jr lb lc mv ju le lf mw lh li lj mx ll lm ln my lp lq lr ij bi translated">当在CSR(客户端呈现)期间请求useEffect中的数据时，页面是白色的，直到数据被返回。</p><h2 id="52de" class="lx ly iq bd md me mf dn mg mh mi dp mj lf mk ml mm lj mn mo mp ln mq mr ms mt bi translated">瀑布问题</h2><p id="589b" class="pw-post-body-paragraph kw kx iq ky b kz mu jr lb lc mv ju le lf mw lh li lj mx ll lm ln my lp lq lr ij bi translated">如果父组件和子组件都依赖useEffect进行初始数据呈现，那么整个呈现流程如下。</p><ol class=""><li id="7b2b" class="mz na iq ky b kz la lc ld lf nb lj nc ln nd lr np nf ng nh bi translated">父组件安装</li><li id="bebe" class="mz na iq ky b kz ni lc nj lf nk lj nl ln nm lr np nf ng nh bi translated">父组件useEffect执行并请求数据</li><li id="0abd" class="mz na iq ky b kz ni lc nj lf nk lj nl ln nm lr np nf ng nh bi translated">返回数据后，将重新呈现父组件</li><li id="c5c8" class="mz na iq ky b kz ni lc nj lf nk lj nl ln nm lr np nf ng nh bi translated">子组件安装</li><li id="5898" class="mz na iq ky b kz ni lc nj lf nk lj nl ln nm lr np nf ng nh bi translated">子组件useEffect执行并请求数据</li><li id="6647" class="mz na iq ky b kz ni lc nj lf nk lj nl ln nm lr np nf ng nh bi translated">返回数据后，将重新呈现子组件。</li></ol><p id="2ba3" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如您所见，当父组件的数据请求成功时，子组件甚至还没有开始呈现第一个屏幕。这就是渲染中的瀑布问题——数据像瀑布一样往下流，到达的组件才开始渲染，效率很低。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nq"><img src="../Images/a74120c719dedb137486068b38cd88a8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*PJby3YFh4aOzQZVt"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk">Photo by <a class="ae kv" href="https://unsplash.com/@mikeanywhere?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Mike Lewis HeadSmart Media</a> on <a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="0d40" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">既然直接写useEffect有这么多问题，有什么推荐的方式？</p><h2 id="35e1" class="lx ly iq bd md me mf dn mg mh mi dp mj lf mk ml mm lj mn mo mp ln mq mr ms mt bi translated">推荐的方式</h2><p id="715b" class="pw-post-body-paragraph kw kx iq ky b kz mu jr lb lc mv ju le lf mw lh li lj mx ll lm ln my lp lq lr ij bi translated">在Meta中，数据是基于中继驱动的(但是请求数据需要GraphQL)，所以很难在社区中推广这种架构。然而，社区现在有了一个成熟的“请求数据的解决方案”</p><ul class=""><li id="a41a" class="mz na iq ky b kz la lc ld lf nb lj nc ln nd lr ne nf ng nh bi translated">SSR，可以用Next.js和Remix来接管数据请求。</li><li id="d0f9" class="mz na iq ky b kz ni lc nj lf nk lj nl ln nm lr ne nf ng nh bi translated">CSR，您可以使用React Query和useSWR来接管数据请求。</li></ul><p id="bfcc" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">所有这些成熟的解决方案都致力于解决上述问题。如果不想用这些解决方案，想自己写，可以参考新React文档中的以下两篇文章。</p><p id="4994" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><a class="ae kv" href="https://beta.reactjs.org/learn/synchronizing-with-effects#fetching-data" rel="noopener ugc nofollow" target="_blank">使用效果同步数据</a></p><p id="559d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><a class="ae kv" href="https://beta.reactjs.org/learn/you-might-not-need-an-effect#fetching-data" rel="noopener ugc nofollow" target="_blank">你可能不需要特效</a></p><p id="0336" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">可以看看我写的总结——<a class="ae kv" rel="noopener ugc nofollow" target="_blank" href="/the-new-react-document-dont-abuse-effect-2ee10a6b4718?source=your_stories_page-------------------------------------">新React文档:不要滥用效果</a></p><div class="nr ns gp gr nt nu"><a rel="noopener  ugc nofollow" target="_blank" href="/the-new-react-document-dont-abuse-effect-2ee10a6b4718"><div class="nv ab fo"><div class="nw ab nx cl cj ny"><h2 class="bd ir gy z fp nz fr fs oa fu fw ip bi translated">新React文档:不要滥用效果</h2><div class="ob l"><h3 class="bd b gy z fp nz fr fs oa fu fw dk translated">当您或您的同事使用useEffect挂钩时，是否出现过以下情况？</h3></div><div class="oc l"><p class="bd b dl z fp nz fr fs oa fu fw dk translated">javascript.plainenglish.io</p></div></div><div class="od l"><div class="oe l of og oh od oi kp nu"/></div></div></a></div><h2 id="85e1" class="lx ly iq bd md me mf dn mg mh mi dp mj lf mk ml mm lj mn mo mp ln mq mr ms mt bi translated">摘要</h2><p id="e78c" class="pw-post-body-paragraph kw kx iq ky b kz mu jr lb lc mv ju le lf mw lh li lj mx ll lm ln my lp lq lr ij bi translated">在本文中，我们讨论了请求数据的“<strong class="ky ir">不推荐方式”和React18后请求数据</strong>的“<strong class="ky ir">推荐方式”。“不推荐的请求数据的方式”不仅仅存在于React中，很多前端框架都有这样的问题。</strong></p></div><div class="ab cl oj ok hu ol" role="separator"><span class="om bw bk on oo op"/><span class="om bw bk on oo op"/><span class="om bw bk on oo"/></div><div class="ij ik il im in"><p id="b27a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir"> <em class="oq">欢迎关注我关于</em></strong><a class="ae kv" href="https://twitter.com/yanghui0324" rel="noopener ugc nofollow" target="_blank"><strong class="ky ir"><em class="oq">Twitter</em></strong></a><strong class="ky ir"><em class="oq"/></strong><a class="ae kv" href="https://www.linkedin.com/in/hui-yang-075076245/" rel="noopener ugc nofollow" target="_blank"><strong class="ky ir"><em class="oq">LinkedIn</em></strong></a><strong class="ky ir"><em class="oq">，以及</em></strong><a class="ae kv" href="https://github.com/guchen-yh" rel="noopener ugc nofollow" target="_blank"><strong class="ky ir"><em class="oq">GitHub</em></strong></a><strong class="ky ir"><em class="oq">！</em> </strong></p><p id="fbc1" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">写作一直是我的激情所在，它带给我帮助和激励他人的快乐。如果您有任何问题，请随时联系我们！T3】</p></div><div class="ab cl oj ok hu ol" role="separator"><span class="om bw bk on oo op"/><span class="om bw bk on oo op"/><span class="om bw bk on oo"/></div><div class="ij ik il im in"><p id="7c3e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><em class="oq">更多内容看</em> <a class="ae kv" href="https://plainenglish.io/" rel="noopener ugc nofollow" target="_blank"> <strong class="ky ir"> <em class="oq">说白了就是</em> </strong> </a> <em class="oq">。报名参加我们的</em> <a class="ae kv" href="http://newsletter.plainenglish.io/" rel="noopener ugc nofollow" target="_blank"> <strong class="ky ir"> <em class="oq">免费周报</em> </strong> </a> <em class="oq">。关注我们关于</em> <a class="ae kv" href="https://twitter.com/inPlainEngHQ" rel="noopener ugc nofollow" target="_blank"> <strong class="ky ir"> <em class="oq">推特</em> </strong> </a>，<a class="ae kv" href="https://www.linkedin.com/company/inplainenglish/" rel="noopener ugc nofollow" target="_blank"> <strong class="ky ir"> <em class="oq">领英</em> </strong> </a> <em class="oq">，以及</em> <a class="ae kv" href="https://discord.gg/GtDtUAvyhW" rel="noopener ugc nofollow" target="_blank"> <strong class="ky ir"> <em class="oq">不和</em> </strong> </a> <em class="oq">。</em></p></div></div>    
</body>
</html>