<html>
<head>
<title>How to Deploy Multiple Node.js Apps on a Single Server with SSL, Nginx, PM2</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何用SSL、Nginx、PM2在一台服务器上部署多个Node.js应用</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/deploy-multiple-nodejs-apps-on-a-single-server-with-ssl-nginx-pm2-part-1-7758e290f597?source=collection_archive---------8-----------------------#2022-08-22">https://javascript.plainenglish.io/deploy-multiple-nodejs-apps-on-a-single-server-with-ssl-nginx-pm2-part-1-7758e290f597?source=collection_archive---------8-----------------------#2022-08-22</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><div class=""><h2 id="acd2" class="pw-subtitle-paragraph jk im in bd b jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb dk translated">第1部分:用SSL在一台服务器上部署多个Node.js应用程序，Nginx，PM2</h2></div><h1 id="1b6b" class="kc kd in bd ke kf kg kh ki kj kk kl km jt kn ju ko jw kp jx kq jz kr ka ks kt bi translated">动机</h1><figure class="kv kw kx ky gt kz gh gi paragraph-image"><div role="button" tabindex="0" class="la lb di lc bf ld"><div class="gh gi ku"><img src="../Images/ec254b2d199252b8db73706a7715d927.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yBsSgiWJblfzV1KcyKV_xQ.png"/></div></div></figure><p id="d0ab" class="pw-post-body-paragraph lg lh in li b lj lk jo ll lm ln jr lo lp lq lr ls lt lu lv lw lx ly lz ma mb ig bi translated">你好。假设您完成了准备部署到服务器的出色Node.js应用程序的编码，并希望将其托管在VPS上，或者您有多个应用程序要托管到单个VPS上。你会怎么做？</p><h1 id="9fb3" class="kc kd in bd ke kf kg kh ki kj kk kl km jt kn ju ko jw kp jx kq jz kr ka ks kt bi translated">介绍</h1><p id="cdb8" class="pw-post-body-paragraph lg lh in li b lj mc jo ll lm md jr lo lp me lr ls lt mf lv lw lx mg lz ma mb ig bi translated"><strong class="li io">Nginx:</strong>web服务器或反向代理来处理传入请求。</p><p id="8dbb" class="pw-post-body-paragraph lg lh in li b lj lk jo ll lm ln jr lo lp lq lr ls lt lu lv lw lx ly lz ma mb ig bi translated"><strong class="li io"> PM2: </strong>流程管理器，管理你的Node.js应用。就像确保它一直在运行，即使它捕捉到错误，或者确保创建同一应用程序的多个实例，以利用应用程序可用的核心/线程(集群模式)最后一部分是可选的。</p><p id="e551" class="pw-post-body-paragraph lg lh in li b lj lk jo ll lm ln jr lo lp lq lr ls lt lu lv lw lx ly lz ma mb ig bi translated"><strong class="li io"> Certbot: </strong>免费使用Let's Encrypt SSL为您的域管理应用SSL。</p><h1 id="4dca" class="kc kd in bd ke kf kg kh ki kj kk kl km jt kn ju ko jw kp jx kq jz kr ka ks kt bi translated">先决条件</h1><p id="84f2" class="pw-post-body-paragraph lg lh in li b lj mc jo ll lm md jr lo lp me lr ls lt mf lv lw lx mg lz ma mb ig bi translated">具有SSH访问权限的Ubuntu 20.04服务器和具有Sudo权限的非root用户。</p><h1 id="1fe5" class="kc kd in bd ke kf kg kh ki kj kk kl km jt kn ju ko jw kp jx kq jz kr ka ks kt bi translated">步骤01 —安装Node.js</h1><p id="a0a6" class="pw-post-body-paragraph lg lh in li b lj mc jo ll lm md jr lo lp me lr ls lt mf lv lw lx mg lz ma mb ig bi translated">首先，要安装Node.js，我们需要为最新的LTS版本添加PPA:</p><pre class="kv kw kx ky gt mh mi mj mk aw ml bi"><span id="7f9f" class="mm kd in mi b gy mn mo l mp mq">cd ~<br/>curl -sL https://deb.nodesource.com/setup_16.x -o nodesource_setup.sh</span><span id="84d5" class="mm kd in mi b gy mr mo l mp mq"># and then </span><span id="e3fc" class="mm kd in mi b gy mr mo l mp mq">sudo bash nodesource_setup.sh</span></pre><p id="726d" class="pw-post-body-paragraph lg lh in li b lj lk jo ll lm ln jr lo lp lq lr ls lt lu lv lw lx ly lz ma mb ig bi translated">添加PPA后，我们可以简单地安装Node.js:</p><pre class="kv kw kx ky gt mh mi mj mk aw ml bi"><span id="ac5f" class="mm kd in mi b gy mn mo l mp mq">sudo apt install nodejs</span></pre><p id="f6ae" class="pw-post-body-paragraph lg lh in li b lj lk jo ll lm ln jr lo lp lq lr ls lt lu lv lw lx ly lz ma mb ig bi translated">要检查我们安装的节点的版本，请键入:</p><pre class="kv kw kx ky gt mh mi mj mk aw ml bi"><span id="3a50" class="mm kd in mi b gy mn mo l mp mq">node -v</span></pre><p id="d064" class="pw-post-body-paragraph lg lh in li b lj lk jo ll lm ln jr lo lp lq lr ls lt lu lv lw lx ly lz ma mb ig bi translated">它会显示安装的确切版本，在我的例子中是<code class="fe ms mt mu mi b">16.17.0</code>。</p><p id="9a19" class="pw-post-body-paragraph lg lh in li b lj lk jo ll lm ln jr lo lp lq lr ls lt lu lv lw lx ly lz ma mb ig bi translated">最有可能的是，我们将需要<code class="fe ms mt mu mi b">build-essentials</code>来从源代码编译任何包，所以让我们也安装它。</p><pre class="kv kw kx ky gt mh mi mj mk aw ml bi"><span id="47eb" class="mm kd in mi b gy mn mo l mp mq">sudo apt install build-essential</span></pre><h1 id="5387" class="kc kd in bd ke kf kg kh ki kj kk kl km jt kn ju ko jw kp jx kq jz kr ka ks kt bi translated">步骤02 —克隆项目并安装依赖项</h1><pre class="kv kw kx ky gt mh mi mj mk aw ml bi"><span id="e105" class="mm kd in mi b gy mn mo l mp mq">git clone awesomeproject.git</span><span id="9bcf" class="mm kd in mi b gy mr mo l mp mq">cd awesomeproject<br/>npm install<br/>npm start (or whatever your start command)<br/># stop app<br/>ctrl+C</span></pre><p id="0273" class="pw-post-body-paragraph lg lh in li b lj lk jo ll lm ln jr lo lp lq lr ls lt lu lv lw lx ly lz ma mb ig bi translated">或者你可以创建一个简单的应用程序:</p><pre class="kv kw kx ky gt mh mi mj mk aw ml bi"><span id="1e63" class="mm kd in mi b gy mn mo l mp mq">cd ~<br/>nano app.js</span></pre><p id="185b" class="pw-post-body-paragraph lg lh in li b lj lk jo ll lm ln jr lo lp lq lr ls lt lu lv lw lx ly lz ma mb ig bi translated">将以下内容插入文件:</p><pre class="kv kw kx ky gt mh mi mj mk aw ml bi"><span id="5e7d" class="mm kd in mi b gy mn mo l mp mq">const http = require('http');</span><span id="543e" class="mm kd in mi b gy mr mo l mp mq">const hostname = 'localhost';<br/>const port = 3000;</span><span id="73d5" class="mm kd in mi b gy mr mo l mp mq">const server = http.createServer((req, res) =&gt; {<br/>  res.statusCode = 200;<br/>  res.setHeader('Content-Type', 'text/plain');<br/>  res.end('Hello Everyone!\n');<br/>});</span><span id="1aca" class="mm kd in mi b gy mr mo l mp mq">server.listen(port, hostname, () =&gt; {<br/>  console.log(`Server running at http://${hostname}:${port}/`);<br/>});</span></pre><p id="c501" class="pw-post-body-paragraph lg lh in li b lj lk jo ll lm ln jr lo lp lq lr ls lt lu lv lw lx ly lz ma mb ig bi translated">然后运行它:</p><pre class="kv kw kx ky gt mh mi mj mk aw ml bi"><span id="a6f8" class="mm kd in mi b gy mn mo l mp mq">node app</span></pre><p id="4fac" class="pw-post-body-paragraph lg lh in li b lj lk jo ll lm ln jr lo lp lq lr ls lt lu lv lw lx ly lz ma mb ig bi translated">您将收到以下输出:</p><pre class="kv kw kx ky gt mh mi mj mk aw ml bi"><span id="ee44" class="mm kd in mi b gy mn mo l mp mq">Output<br/>Server running at <a class="ae mv" href="http://localhost:3000/" rel="noopener ugc nofollow" target="_blank">http://localhost:3000/</a></span></pre><h1 id="778f" class="kc kd in bd ke kf kg kh ki kj kk kl km jt kn ju ko jw kp jx kq jz kr ka ks kt bi translated">步骤03 —设置PM2</h1><p id="4ef6" class="pw-post-body-paragraph lg lh in li b lj mc jo ll lm md jr lo lp me lr ls lt mf lv lw lx mg lz ma mb ig bi translated">首先，我们需要安装PM2:</p><pre class="kv kw kx ky gt mh mi mj mk aw ml bi"><span id="62e8" class="mm kd in mi b gy mn mo l mp mq">sudo npm i pm2 -g</span></pre><p id="6035" class="pw-post-body-paragraph lg lh in li b lj lk jo ll lm ln jr lo lp lq lr ls lt lu lv lw lx ly lz ma mb ig bi translated">要启动该应用程序:</p><pre class="kv kw kx ky gt mh mi mj mk aw ml bi"><span id="6e6b" class="mm kd in mi b gy mn mo l mp mq">pm2 start app  #(or whatever your file name)</span><span id="cea2" class="mm kd in mi b gy mr mo l mp mq">#for Cluster mode <br/>pm2 start app -i max <br/>#it will create an instance for every available thread <br/>#optionally you can also pass Number like 2,3 for instances count</span><span id="fd9e" class="mm kd in mi b gy mr mo l mp mq"># Other pm2 commands<br/>pm2 show app<br/>pm2 status<br/>pm2 restart app<br/>pm2 stop app<br/>pm2 logs (Show log stream)<br/>pm2 flush (Clear logs)</span><span id="984a" class="mm kd in mi b gy mr mo l mp mq"># To make sure app starts when reboot<br/>pm2 startup ubuntu</span></pre><p id="37d4" class="pw-post-body-paragraph lg lh in li b lj lk jo ll lm ln jr lo lp lq lr ls lt lu lv lw lx ly lz ma mb ig bi translated">该应用程序应该可以使用定义的IP和端口访问。</p><h1 id="e7e5" class="kc kd in bd ke kf kg kh ki kj kk kl km jt kn ju ko jw kp jx kq jz kr ka ks kt bi translated">步骤04 —设置UFW防火墙</h1><p id="32e3" class="pw-post-body-paragraph lg lh in li b lj mc jo ll lm md jr lo lp me lr ls lt mf lv lw lx mg lz ma mb ig bi translated">现在，我们希望设置一个防火墙来阻止该端口，并将NGINX设置为反向代理，这样我们就可以使用端口80 (http)或端口443 (https)直接访问它。</p><pre class="kv kw kx ky gt mh mi mj mk aw ml bi"><span id="72c2" class="mm kd in mi b gy mn mo l mp mq">sudo ufw enable<br/>sudo ufw status<br/>sudo ufw allow ssh (Port 22) # for SSH<br/>sudo ufw allow http (Port 80)<br/>sudo ufw allow https (Port 443)</span></pre><h1 id="07d7" class="kc kd in bd ke kf kg kh ki kj kk kl km jt kn ju ko jw kp jx kq jz kr ka ks kt bi translated">步骤05 —安装NGINX并进行配置</h1><p id="5051" class="pw-post-body-paragraph lg lh in li b lj mc jo ll lm md jr lo lp me lr ls lt mf lv lw lx mg lz ma mb ig bi translated">安装Nginx非常简单，只需输入以下命令:</p><pre class="kv kw kx ky gt mh mi mj mk aw ml bi"><span id="38fb" class="mm kd in mi b gy mn mo l mp mq">sudo apt install nginx</span></pre><p id="a29e" class="pw-post-body-paragraph lg lh in li b lj lk jo ll lm ln jr lo lp lq lr ls lt lu lv lw lx ly lz ma mb ig bi translated">并打开默认配置进行编辑:</p><pre class="kv kw kx ky gt mh mi mj mk aw ml bi"><span id="05b3" class="mm kd in mi b gy mn mo l mp mq">sudo nano /etc/nginx/sites-available/default</span></pre><p id="a5aa" class="pw-post-body-paragraph lg lh in li b lj lk jo ll lm ln jr lo lp lq lr ls lt lu lv lw lx ly lz ma mb ig bi translated">将以下内容添加到服务器块的<strong class="li io">位置</strong>部分:</p><pre class="kv kw kx ky gt mh mi mj mk aw ml bi"><span id="8be7" class="mm kd in mi b gy mn mo l mp mq">server_name yourdomain.com www.yourdomain.com;</span><span id="63cb" class="mm kd in mi b gy mr mo l mp mq">    location / {<br/>        proxy_pass http://localhost:3000; #whatever port your app runs on<br/>        proxy_http_version 1.1;<br/>        proxy_set_header Upgrade $http_upgrade;<br/>        proxy_set_header Connection 'upgrade';<br/>        proxy_set_header Host $host;<br/>        proxy_cache_bypass $http_upgrade;<br/>    }</span></pre><p id="2898" class="pw-post-body-paragraph lg lh in li b lj lk jo ll lm ln jr lo lp lq lr ls lt lu lv lw lx ly lz ma mb ig bi translated">然后检查并重启NGINX:</p><pre class="kv kw kx ky gt mh mi mj mk aw ml bi"><span id="d4e8" class="mm kd in mi b gy mn mo l mp mq"># Check NGINX config<br/>sudo nginx -t</span><span id="b6e7" class="mm kd in mi b gy mr mo l mp mq"># Restart NGINX<br/>sudo service nginx restart</span></pre><p id="e5b5" class="pw-post-body-paragraph lg lh in li b lj lk jo ll lm ln jr lo lp lq lr ls lt lu lv lw lx ly lz ma mb ig bi translated">你现在应该能够访问你的IP没有端口(端口80)，并看到你的应用程序。</p><h1 id="9c47" class="kc kd in bd ke kf kg kh ki kj kk kl km jt kn ju ko jw kp jx kq jz kr ka ks kt bi translated">步骤06 —添加域</h1><p id="2492" class="pw-post-body-paragraph lg lh in li b lj mc jo ll lm md jr lo lp me lr ls lt mf lv lw lx mg lz ma mb ig bi translated">向任何VPS添加域在每个提供商上都有很大的不同。首先，您需要注册并添加一个<strong class="li io">和一个</strong>记录以指向VPS的IP地址，或者如果您的VPS提供商支持，您也可以添加<strong class="li io">自定义名称服务器</strong>，这可能需要一段时间才能显示。</p><h1 id="219c" class="kc kd in bd ke kf kg kh ki kj kk kl km jt kn ju ko jw kp jx kq jz kr ka ks kt bi translated">步骤07 —添加带有加密的SSL</h1><p id="acb3" class="pw-post-body-paragraph lg lh in li b lj mc jo ll lm md jr lo lp me lr ls lt mf lv lw lx mg lz ma mb ig bi translated">让加密提供免费的SSL与<code class="fe ms mt mu mi b">certbot</code>包，所以首先我们需要安装软件包:</p><pre class="kv kw kx ky gt mh mi mj mk aw ml bi"><span id="831a" class="mm kd in mi b gy mn mo l mp mq">sudo add-apt-repository ppa:certbot/certbot<br/>sudo apt-get update<br/>sudo apt-get install python3-certbot-nginx</span></pre><p id="9b01" class="pw-post-body-paragraph lg lh in li b lj lk jo ll lm ln jr lo lp lq lr ls lt lu lv lw lx ly lz ma mb ig bi translated">然后为我们添加的域添加证书:</p><pre class="kv kw kx ky gt mh mi mj mk aw ml bi"><span id="1e18" class="mm kd in mi b gy mn mo l mp mq">sudo certbot --nginx -d yourdomain.com -d <a class="ae mv" href="http://www.yourdomain.com" rel="noopener ugc nofollow" target="_blank">www.yourdomain.com</a></span></pre><p id="1d7f" class="pw-post-body-paragraph lg lh in li b lj lk jo ll lm ln jr lo lp lq lr ls lt lu lv lw lx ly lz ma mb ig bi translated">你的应用应该在<a class="ae mv" href="https://yourdomain.com/" rel="noopener ugc nofollow" target="_blank">https://yourdomain.com</a>直播。</p><p id="96be" class="pw-post-body-paragraph lg lh in li b lj lk jo ll lm ln jr lo lp lq lr ls lt lu lv lw lx ly lz ma mb ig bi translated">请注意，我们必须每隔90天更新这些证书。要续订，请运行:</p><pre class="kv kw kx ky gt mh mi mj mk aw ml bi"><span id="b3b3" class="mm kd in mi b gy mn mo l mp mq">certbot renew</span></pre><p id="d4f0" class="pw-post-body-paragraph lg lh in li b lj lk jo ll lm ln jr lo lp lq lr ls lt lu lv lw lx ly lz ma mb ig bi translated">我们将在下一部分添加另一个应用程序，敬请期待！😃</p><p id="047b" class="pw-post-body-paragraph lg lh in li b lj lk jo ll lm ln jr lo lp lq lr ls lt lu lv lw lx ly lz ma mb ig bi translated"><em class="mw">更多内容看</em> <a class="ae mv" href="https://plainenglish.io/" rel="noopener ugc nofollow" target="_blank"> <strong class="li io"> <em class="mw">说白了。报名参加我们的</em> <a class="ae mv" href="http://newsletter.plainenglish.io/" rel="noopener ugc nofollow" target="_blank"> <strong class="li io"> <em class="mw">免费周报</em> </strong> </a> <em class="mw">。关注我们关于</em> <a class="ae mv" href="https://twitter.com/inPlainEngHQ" rel="noopener ugc nofollow" target="_blank"> <strong class="li io"> <em class="mw">推特</em></strong></a><a class="ae mv" href="https://www.linkedin.com/company/inplainenglish/" rel="noopener ugc nofollow" target="_blank"><strong class="li io"><em class="mw">LinkedIn</em></strong></a><em class="mw"/><a class="ae mv" href="https://www.youtube.com/channel/UCtipWUghju290NWcn8jhyAw" rel="noopener ugc nofollow" target="_blank"><strong class="li io"><em class="mw">YouTube</em></strong></a><em class="mw"/><a class="ae mv" href="https://discord.gg/GtDtUAvyhW" rel="noopener ugc nofollow" target="_blank"><strong class="li io"><em class="mw">不和</em> </strong> </a> <em class="mw">。</em></strong></a></p></div></div>    
</body>
</html>