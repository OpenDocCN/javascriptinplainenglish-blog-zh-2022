<html>
<head>
<title>Upload Files to Google Cloud Storage from React</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">从React上传文件到Google云存储</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/upload-files-to-google-cloud-storage-from-react-cf839d7361a5?source=collection_archive---------2-----------------------#2022-05-23">https://javascript.plainenglish.io/upload-files-to-google-cloud-storage-from-react-cf839d7361a5?source=collection_archive---------2-----------------------#2022-05-23</a></blockquote><div><div class="fc if ig ih ii ij"/><div class="ik il im in io"><div class=""/><div class=""><h2 id="2a43" class="pw-subtitle-paragraph jo iq ir bd b jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf dk translated">关于如何使用Node.js和Multer将文件从React上传到Google云存储的教程</h2></div><figure class="kh ki kj kk gu kl gi gj paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="gi gj kg"><img src="../Images/5912b5f1dad7086b1f7de82124e56997.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9IHDvOnSJLRXQqvPu0hvrQ.jpeg"/></div></div><figcaption class="ks kt gk gi gj ku kv bd b be z dk">Photo by <a class="ae kw" href="https://unsplash.com/@aideal?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">Aideal Hwa</a> on <a class="ae kw" href="https://unsplash.com/s/photos/technology?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="9e6e" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">今天，我们将了解如何使用Node.js后端从React前端向Google云存储上传文件。</p><h1 id="3a73" class="lt lu ir bd lv lw lx ly lz ma mb mc md jx me jy mf ka mg kb mh kd mi ke mj mk bi translated">第一步:做前端</h1><p id="9de2" class="pw-post-body-paragraph kx ky ir kz b la ml js lc ld mm jv lf lg mn li lj lk mo lm ln lo mp lq lr ls ik bi translated">前端代码非常容易。我们只需要一个文件选择器从本地机器上选择一个文件，并将其发送到Node.js服务器。</p><figure class="kh ki kj kk gu kl"><div class="bz fq l di"><div class="mq mr l"/></div><figcaption class="ks kt gk gi gj ku kv bd b be z dk">GoogleStorageFileUploader.tsx</figcaption></figure><h1 id="33ab" class="lt lu ir bd lv lw lx ly lz ma mb mc md jx me jy mf ka mg kb mh kd mi ke mj mk bi translated">准备云存储:</h1><p id="df65" class="pw-post-body-paragraph kx ky ir kz b la ml js lc ld mm jv lf lg mn li lj lk mo lm ln lo mp lq lr ls ik bi translated">转到您的Google Cloud控制台，创建一个有权将文件上传到Google云存储的服务帐户。</p><p id="a1a6" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">然后下载该服务帐户的密钥文件，并将其存储在一个安全的地方。</p><p id="756e" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">然后在你的云控制台中选择云存储，创建一个存储桶。</p><p id="b41d" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">为了避免这篇文章太长，我们没有在这里展示这一部分。</p><h1 id="0f38" class="lt lu ir bd lv lw lx ly lz ma mb mc md jx me jy mf ka mg kb mh kd mi ke mj mk bi translated">准备后端</h1><p id="8b22" class="pw-post-body-paragraph kx ky ir kz b la ml js lc ld mm jv lf lg mn li lj lk mo lm ln lo mp lq lr ls ik bi translated">让我们首先通过安装一些依赖项来初始化项目。</p><pre class="kh ki kj kk gu ms mt mu mv aw mw bi"><span id="3f43" class="mx lu ir mt b gz my mz l na nb">yarn add @google-cloud/storage express cors multer</span></pre><p id="78b3" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">这里multer是一个特殊的Express中间件，帮助文件上传。</p><p id="566b" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated"><code class="fe nc nd ne mt b">@google-cloud/storage</code>是我们上传文件到谷歌云存储的客户端。</p><p id="b57e" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">然后使用以下代码创建我们的服务器:</p><ol class=""><li id="4bab" class="nf ng ir kz b la lb ld le lg nh lk ni lo nj ls nk nl nm nn bi translated">这里我们正在创建我们的Express应用程序。</li><li id="d690" class="nf ng ir kz b la no ld np lg nq lk nr lo ns ls nk nl nm nn bi translated">然后我们创建一个multer实例。</li><li id="cab6" class="nf ng ir kz b la no ld np lg nq lk nr lo ns ls nk nl nm nn bi translated">然后通过提供云存储客户端的路径来配置我们的云存储客户端</li></ol><pre class="kh ki kj kk gu ms mt mu mv aw mw bi"><span id="e55d" class="mx lu ir mt b gz my mz l na nb">import { Storage } from "@google-cloud/storage";<br/>import express from "express";<br/>import cors from "cors";<br/>import { format } from "util";<br/>import Multer from "multer";<br/>const app = express();<br/>const port = 5000;</span><span id="cee7" class="mx lu ir mt b gz nt mz l na nb">const multer = Multer({<br/>  storage: Multer.memoryStorage(),<br/>  limits: {<br/>    fileSize: 5 * 1024 * 1024, // no larger than 5mb, you can change as needed.<br/>  },<br/>});</span><span id="f032" class="mx lu ir mt b gz nt mz l na nb">app.use(cors());</span><span id="7356" class="mx lu ir mt b gz nt mz l na nb">const cloudStorage = new Storage({<br/>  keyFilename: `${__dirname}/service_account_key.json`,<br/>  projectId: "PROJECT_ID",<br/>});<br/>const bucketName = "YOUR_BUCKET_NAME";</span><span id="fa6a" class="mx lu ir mt b gz nt mz l na nb">const bucket = cloudStorage.bucket(bucketName);</span><span id="ff25" class="mx lu ir mt b gz nt mz l na nb">app.post("/upload-file-to-cloud-storage", multer.single("file"), function (req, res, next) {<br/>  if (!req.file) {<br/>    res.status(400).send("No file uploaded.");<br/>    return;<br/>  }</span><span id="a073" class="mx lu ir mt b gz nt mz l na nb">  const blob = bucket.file(req.file.originalname);<br/>  const blobStream = blob.createWriteStream();</span><span id="87f3" class="mx lu ir mt b gz nt mz l na nb">  blobStream.on("error", (err) =&gt; {<br/>    next(err);<br/>  });</span><span id="25e7" class="mx lu ir mt b gz nt mz l na nb">  blobStream.on("finish", () =&gt; {<br/>    // The public URL can be used to directly access the file via HTTP.<br/>    const publicUrl = format(`https://storage.googleapis.com/${bucket.name}/${blob.name}`);</span><span id="34fc" class="mx lu ir mt b gz nt mz l na nb">    res.status(200).json({ publicUrl });<br/>  });</span><span id="14fd" class="mx lu ir mt b gz nt mz l na nb">  blobStream.end(req.file.buffer);<br/>  console.log(req.file);<br/>});</span><span id="0d1c" class="mx lu ir mt b gz nt mz l na nb">app.listen(port, () =&gt; {<br/>  console.log(`listening at http://localhost:${port}`);<br/>});</span></pre><p id="afbd" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">然后使用以下命令启动服务器:</p><pre class="kh ki kj kk gu ms mt mu mv aw mw bi"><span id="1e43" class="mx lu ir mt b gz my mz l na nb">node index.js</span></pre><p id="ca45" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">保持服务器运行，并尝试使用我们的React前端上传文件。</p><h1 id="d78b" class="lt lu ir bd lv lw lx ly lz ma mb mc md jx me jy mf ka mg kb mh kd mi ke mj mk bi translated">下载文件</h1><p id="7261" class="pw-post-body-paragraph kx ky ir kz b la ml js lc ld mm jv lf lg mn li lj lk mo lm ln lo mp lq lr ls ik bi translated">您还可以使用同一个客户端库从云存储中下载文件。使用以下函数生成一个签名的下载URL，使您可以安全地访问该文件。</p><pre class="kh ki kj kk gu ms mt mu mv aw mw bi"><span id="291f" class="mx lu ir mt b gz my mz l na nb">app.get("/get-url", (req, res) =&gt; {<br/>  const file = bucket.file("FILE_NAME_IN_THE_BUCKET");<br/>  const config: any = {<br/>    action: "read", // giving read permission here<br/>    expires: "03-17-2025", // specifying the expiry date<br/>  };<br/>  file.getSignedUrl(config, (err, url) =&gt; {<br/>    res.status(200).json({ url });<br/>  });<br/>});</span></pre><h1 id="c652" class="lt lu ir bd lv lw lx ly lz ma mb mc md jx me jy mf ka mg kb mh kd mi ke mj mk bi translated">列出文件</h1><p id="851e" class="pw-post-body-paragraph kx ky ir kz b la ml js lc ld mm jv lf lg mn li lj lk mo lm ln lo mp lq lr ls ik bi translated">要从云存储中获取文件列表，可以使用以下代码:</p><pre class="kh ki kj kk gu ms mt mu mv aw mw bi"><span id="4dfe" class="mx lu ir mt b gz my mz l na nb">app.get("/get-files-list", async (req, res) =&gt; {<br/>  const options = {<br/>    prefix: "audio", // or anything you want!<br/>  };<br/>  const [files] = await bucket.getFiles(options);<br/>  res.status(200).json({ files });<br/>});</span></pre><p id="6202" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">所以这是一个超级短的教程，向你展示如何上传文件到谷歌云存储。希望你今天学到了新东西！</p><p id="3316" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">祝您愉快！</p><p id="246e" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated"><strong class="kz is">通过</strong> <a class="ae kw" href="https://www.linkedin.com/in/56faisal/" rel="noopener ugc nofollow" target="_blank"> <strong class="kz is"> LinkedIn </strong> </a> <strong class="kz is">或我的</strong> <a class="ae kw" href="https://www.mohammadfaisal.dev/" rel="noopener ugc nofollow" target="_blank"> <strong class="kz is">个人网站</strong> </a> <strong class="kz is">与我取得联系。</strong></p><div class="nu nv gq gs nw nx"><a rel="noopener  ugc nofollow" target="_blank" href="/upload-files-to-google-drive-from-react-without-oauth2-73b1f4add606"><div class="ny ab fp"><div class="nz ab oa cl cj ob"><h2 class="bd is gz z fq oc fs ft od fv fx iq bi translated">从React上传文件到Google Drive，无需OAuth2</h2><div class="oe l"><h3 class="bd b gz z fq oc fs ft od fv fx dk translated">在Node.js和Multer的帮助下，没有OAuth2！</h3></div><div class="of l"><p class="bd b dl z fq oc fs ft od fv fx dk translated">javascript.plainenglish.io</p></div></div><div class="og l"><div class="oh l oi oj ok og ol kq nx"/></div></div></a></div><p id="5ffb" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated"><em class="om">更多内容请看</em><a class="ae kw" href="https://plainenglish.io/" rel="noopener ugc nofollow" target="_blank"><strong class="kz is"><em class="om">plain English . io</em></strong></a><em class="om">。报名参加我们的</em> <a class="ae kw" href="http://newsletter.plainenglish.io/" rel="noopener ugc nofollow" target="_blank"> <strong class="kz is"> <em class="om">免费周报</em> </strong> </a> <em class="om">。关注我们关于</em><a class="ae kw" href="https://twitter.com/inPlainEngHQ" rel="noopener ugc nofollow" target="_blank"><strong class="kz is"><em class="om">Twitter</em></strong></a><em class="om">和</em><a class="ae kw" href="https://www.linkedin.com/company/inplainenglish/" rel="noopener ugc nofollow" target="_blank"><strong class="kz is"><em class="om">LinkedIn</em></strong></a><em class="om">。查看我们的</em> <a class="ae kw" href="https://discord.gg/GtDtUAvyhW" rel="noopener ugc nofollow" target="_blank"> <strong class="kz is"> <em class="om">社区不和谐</em> </strong> </a> <em class="om">加入我们的</em> <a class="ae kw" href="https://inplainenglish.pallet.com/talent/welcome" rel="noopener ugc nofollow" target="_blank"> <strong class="kz is"> <em class="om">人才集体</em> </strong> </a> <em class="om">。</em></p></div></div>    
</body>
</html>