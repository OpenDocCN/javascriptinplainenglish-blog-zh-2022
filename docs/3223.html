<html>
<head>
<title>Create Your Own JavaScript Runtime</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">创建自己的JavaScript运行时</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/create-your-own-javascript-runtime-2e3642713b62?source=collection_archive---------3-----------------------#2022-08-10">https://javascript.plainenglish.io/create-your-own-javascript-runtime-2e3642713b62?source=collection_archive---------3-----------------------#2022-08-10</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="bf95" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">关于如何使用V8 JavaScript引擎创建自己的基本JavaScript运行时的教程。</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/10c7f9568dbc623f17dd182d77535e4b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*dXwzDB4Tjc099Pvb"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk">Photo by <a class="ae kv" href="https://unsplash.com/@clark_fransa?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Arnold Francisca</a> on <a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="c7a8" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">无论是浏览器运行时还是像Node.js这样的服务器端运行时，我们都使用某种运行时来运行JavaScript代码。今天，我们将使用V8 JavaScript引擎创建一个我们自己的基本JavaScript运行时。</p><h1 id="9c71" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated"><strong class="ak">什么是JavaScript运行时？</strong></h1><p id="1938" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">JavaScript运行时只是一个环境，它通过提供有用的API来扩展JavaScript引擎，并允许程序与其容器外部的世界进行交互。这不同于引擎，引擎只是简单地解析代码并在一个包含的环境中执行它。</p><p id="db4e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">正如我前面提到的，V8是一个JavaScript引擎，这意味着它处理JavaScript源代码的解析和执行。Node.js和Chrome(都由v8支持)提供了对象和API，允许代码与文件系统(通过<code class="fe mp mq mr ms b">node:fs</code>)或窗口对象(在Chrome中)进行交互。</p><h1 id="3082" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">设置</h1><p id="d437" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">在本教程中，我们将使用Rust来创建我们的运行时。我们将使用由Deno团队维护的<a class="ae kv" href="https://crates.io/crates/v8" rel="noopener ugc nofollow" target="_blank"> V8绑定</a>。因为创建一个运行时是一个复杂的过程，今天我们将从简单的开始，通过实现一个REPL(读取-评估-打印循环)。一次运行JavaScript一行输入的提示符。</p><div class="mt mu gp gr mv mw"><a href="https://crates.io/crates/v8" rel="noopener  ugc nofollow" target="_blank"><div class="mx ab fo"><div class="my ab mz cl cj na"><h2 class="bd ir gy z fp nb fr fs nc fu fw ip bi translated">V8 — Crates.io: Rust包注册表</h2><div class="nd l"><h3 class="bd b gy z fp nb fr fs nc fu fw dk translated">生锈的V8装订</h3></div><div class="ne l"><p class="bd b dl z fp nb fr fs nc fu fw dk translated">crates.io</p></div></div></div></a></div><p id="bb62" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">首先，用<code class="fe mp mq mr ms b">cargo init</code>创建一个新项目。然后，向<code class="fe mp mq mr ms b">Cargo.toml</code>文件添加一些依赖项。<code class="fe mp mq mr ms b">v8</code>包包含对V8 JavaScript引擎的绑定，<code class="fe mp mq mr ms b">clap</code>是一个用于处理命令行参数的流行库。</p><pre class="kg kh ki kj gt nf ms ng nh aw ni bi"><span id="4c1b" class="nj lt iq ms b gy nk nl l nm nn">[dependencies]<br/>v8 = "0.48.0"<br/>clap = "3.2.16"</span></pre><h1 id="180b" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated"><strong class="ak">管理命令输入</strong></h1><p id="a48c" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">当使用我们的运行时，我们可能希望为它提供一些命令行参数，比如运行什么文件，或者修改行为的任何标志。打开<code class="fe mp mq mr ms b">src/main.rs</code>，在<code class="fe mp mq mr ms b">main</code>函数中，用定义子命令和输入参数的代码替换<code class="fe mp mq mr ms b">println</code>调用。如果没有提供子命令，我们将做与Node.js相同的事情，将用户扔进REPL。我们还将创建一个子命令“run ”,我们将在后面的教程中实现它。<code class="fe mp mq mr ms b">run</code>，一旦实现，将允许用户运行一个JavaScript文件(与我们定义的任何其他参数)。</p><pre class="kg kh ki kj gt nf ms ng nh aw ni bi"><span id="462b" class="nj lt iq ms b gy nk nl l nm nn">use clap::{Command, arg};</span><span id="253f" class="nj lt iq ms b gy no nl l nm nn">fn main() {<br/>  let cmd = clap::Command::new("myruntime")<br/>  .bin_name("myruntime")<br/>  .subcommand_required(false)<br/>  .subcommand(<br/>    Command::new("run")<br/>      .about("Run a file")<br/>      .arg(arg!(&lt;FILE&gt; "The file to run"))<br/>      .arg_required_else_help(true),<br/>  );<br/>}</span></pre><p id="1e3e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在，我们将根据这个模式匹配参数，并相应地处理响应。</p><pre class="kg kh ki kj gt nf ms ng nh aw ni bi"><span id="838b" class="nj lt iq ms b gy nk nl l nm nn">  ...</span><span id="09dc" class="nj lt iq ms b gy no nl l nm nn">  let matches = cmd.get_matches();<br/>  match matches.subcommand() {<br/>    Some(("run", _matches)) =&gt; unimplemented!(),<br/>    _ =&gt; {<br/>      unimplemented!("Implement this in the next step")<br/>    },<br/>  };</span></pre><p id="0047" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们现在只有两种可能。第一个是<code class="fe mp mq mr ms b">run</code>，我们今天不会实现，第二个是没有子命令，这将打开我们的REPL。在实现REPL之前，我们首先需要创建JavaScript环境。</p><h1 id="0630" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated"><strong class="ak">初始化V8 &amp;创建引擎实例</strong></h1><p id="4f58" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">在我们对V8做任何事情之前，我们必须首先初始化它。然后，我们需要制造一个隔离区。一个包罗万象的对象，表示JavaScript引擎的单个实例。</p><p id="4df7" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在文件顶部添加一条<code class="fe mp mq mr ms b">use</code>语句，以包含<code class="fe mp mq mr ms b">v8</code>板条箱。接下来，让我们回到REPL的未实现代码部分，初始化V8，并创建一个隔离区，将其封装在一个<code class="fe mp mq mr ms b">HandleScope</code>中。</p><pre class="kg kh ki kj gt nf ms ng nh aw ni bi"><span id="19d3" class="nj lt iq ms b gy nk nl l nm nn">use v8;</span><span id="9f96" class="nj lt iq ms b gy no nl l nm nn">...<br/>    _ =&gt; {<br/>      let platform = v8::new_default_platform(0, false).make_shared();<br/>      v8::V8::initialize_platform(platform);<br/>      v8::V8::initialize();</span><span id="7821" class="nj lt iq ms b gy no nl l nm nn">      let isolate = &amp;mut v8::Isolate::new(v8::CreateParams::default());<br/>      let handle_scope = &amp;mut v8::HandleScope::new(isolate);<br/>    },</span></pre><h1 id="1e7f" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated"><strong class="ak">创造REPL </strong></h1><p id="e6ca" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">为了帮助管理我们的代码，我们将在一个<code class="fe mp mq mr ms b">struct</code>中创建我们的运行时。当创建一个新实例时，我们将创建一个<code class="fe mp mq mr ms b">Context</code>。<code class="fe mp mq mr ms b">Context</code>允许一组全局和内置对象存在于一个“上下文”中。说到全局对象，我们将创建一个名为global的对象模板，以便在后面的教程中使用。这个对象允许我们绑定自己的全局函数，但是现在，我们只是用它来创建上下文。</p><pre class="kg kh ki kj gt nf ms ng nh aw ni bi"><span id="3396" class="nj lt iq ms b gy nk nl l nm nn">struct Runtime&lt;'s, 'i&gt; {<br/>  context_scope: v8::ContextScope&lt;'i, v8::HandleScope&lt;'s&gt;&gt;,<br/>}</span><span id="96ba" class="nj lt iq ms b gy no nl l nm nn">impl&lt;'s, 'i&gt; Runtime&lt;'s, 'i&gt;<br/>where<br/>  's: 'i,<br/>{<br/>  pub fn new(<br/>    isolate_scope: &amp;'i mut v8::HandleScope&lt;'s, ()&gt;,<br/>  ) -&gt; Self {<br/>    let global = v8::ObjectTemplate::new(isolate_scope);</span><span id="a5d6" class="nj lt iq ms b gy no nl l nm nn">    let context = v8::Context::new_from_template(isolate_scope, global);<br/>    let context_scope = v8::ContextScope::new(isolate_scope, context);</span><span id="bdfb" class="nj lt iq ms b gy no nl l nm nn">Runtime { context_scope }<br/>  }<br/>}</span></pre><p id="1173" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">接下来，让我们在<code class="fe mp mq mr ms b">Runtime</code>中定义一个方法，负责处理REPL，并且只处理REPL。使用一个<code class="fe mp mq mr ms b">loop</code>，我们将在每次迭代中获取输入，如果成功的话就运行它。我们还需要从文件顶部的<code class="fe mp mq mr ms b">std::io</code>导入一些东西。</p><pre class="kg kh ki kj gt nf ms ng nh aw ni bi"><span id="65dc" class="nj lt iq ms b gy nk nl l nm nn">use std::io::{self, Write};</span><span id="3214" class="nj lt iq ms b gy no nl l nm nn">...</span><span id="3468" class="nj lt iq ms b gy no nl l nm nn">pub fn repl(&amp;mut self) {<br/>    println!("My Runtime REPL (V8 {})", v8::V8::get_version());</span><span id="b5e8" class="nj lt iq ms b gy no nl l nm nn">    loop {<br/>      print!("&gt; ");<br/>      io::stdout().flush().unwrap();<br/>  <br/>      let mut buf = String::new();<br/>      match io::stdin().read_line(&amp;mut buf) {<br/>        Ok(n) =&gt; {<br/>          if n == 0 {<br/>            println!();<br/>            return;<br/>          }<br/>  <br/>          // prints the input (you'll replace this in the next step)<br/>          println!("input: {}", &amp;buf);<br/>        }<br/>        Err(error) =&gt; println!("error: {}", error),<br/>      }<br/>    }<br/>  }</span></pre><p id="6f3e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在让我们返回<code class="fe mp mq mr ms b">main</code>中的REPL命令，创建一个运行时实例，并初始化REPL。</p><pre class="kg kh ki kj gt nf ms ng nh aw ni bi"><span id="feff" class="nj lt iq ms b gy nk nl l nm nn">      ...</span><span id="8338" class="nj lt iq ms b gy no nl l nm nn">      let mut runtime = Runtime::new(handle_scope);<br/>      runtime.repl();</span></pre><h1 id="f457" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">运行代码</h1><p id="ba21" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">我们的<code class="fe mp mq mr ms b">run</code>方法将接受代码和文件名(对于REPL，我们将简单地使用<code class="fe mp mq mr ms b">(shell)</code>)进行错误处理。我们创建一个新的作用域来处理脚本的执行，并将其包装在一个<code class="fe mp mq mr ms b">TryCatch</code>作用域中，以获得更好的错误处理(我们将在未来的教程中实现)。接下来，我们初始化脚本并创建一个origin对象，它定义了脚本的来源(在一个文件中)。</p><pre class="kg kh ki kj gt nf ms ng nh aw ni bi"><span id="ea75" class="nj lt iq ms b gy nk nl l nm nn">  fn run(<br/>    &amp;mut self,<br/>    script: &amp;str,<br/>    filename: &amp;str,<br/>  ) -&gt; Option&lt;String&gt; {<br/>    let scope = &amp;mut v8::HandleScope::new(&amp;mut self.context_scope);<br/>    let mut scope = v8::TryCatch::new(scope);</span><span id="5be6" class="nj lt iq ms b gy no nl l nm nn">    let filename = v8::String::new(&amp;mut scope, filename).unwrap();<br/>    let undefined = v8::undefined(&amp;mut scope);<br/>    let script = v8::String::new(&amp;mut scope, script).unwrap();<br/>    let origin = v8::ScriptOrigin::new(<br/>      &amp;mut scope,<br/>      filename.into(),<br/>      0,<br/>      0,<br/>      false,<br/>      0,<br/>      undefined.into(),<br/>      false,<br/>      false,<br/>      false,<br/>    );</span><span id="fdd4" class="nj lt iq ms b gy no nl l nm nn">}</span></pre><p id="eebc" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在，继续<code class="fe mp mq mr ms b">run</code>，我们编译脚本，捕捉任何错误，并打印错误发生。然后，我们运行脚本，再次捕捉任何错误，并记录是否发生了错误。然后，我们返回脚本的结果(如果发生错误，则返回<code class="fe mp mq mr ms b">None</code>)。</p><pre class="kg kh ki kj gt nf ms ng nh aw ni bi"><span id="8942" class="nj lt iq ms b gy nk nl l nm nn">    ...</span><span id="9446" class="nj lt iq ms b gy no nl l nm nn">    let script = if let Some(script) = v8::Script::compile(&amp;mut scope, script, Some(&amp;origin)) {<br/>      script<br/>    } else {<br/>      assert!(scope.has_caught());<br/>      eprintln!("An error occurred when compiling the JavaScript!");<br/>      return None;<br/>    };</span><span id="c23a" class="nj lt iq ms b gy no nl l nm nn">    if let Some(result) = script.run(&amp;mut scope) {<br/>      return Some(result.to_string(&amp;mut scope).unwrap().to_rust_string_lossy(&amp;mut scope));<br/>    } else {<br/>      assert!(scope.has_caught());<br/>      eprintln!("An error occurred when running the JavaScript!");<br/>      return None;<br/>    }</span></pre><p id="9079" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在我们的<code class="fe mp mq mr ms b">repl</code>方法中返回这两行。</p><pre class="kg kh ki kj gt nf ms ng nh aw ni bi"><span id="4252" class="nj lt iq ms b gy nk nl l nm nn">          // prints the input (you'll replace this in the next step)<br/>          println!("input: {}", &amp;buf);</span></pre><p id="3c5a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们现在可以实现我们的<code class="fe mp mq mr ms b">run</code>方法了。用一个<code class="fe mp mq mr ms b">if</code>语句替换<code class="fe mp mq mr ms b">println</code>来运行脚本，并打印结果。</p><pre class="kg kh ki kj gt nf ms ng nh aw ni bi"><span id="002d" class="nj lt iq ms b gy nk nl l nm nn">          if let Some(result) = self.run(&amp;buf, "(shell)") {<br/>            println!("{}", result);<br/>          }</span></pre><h1 id="c571" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated"><strong class="ak">结论</strong></h1><p id="9f6c" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">恭喜你！您已经迈出了使用V8引擎创建自己的JavaScript运行时的第一步。本教程的完整代码可以在<a class="ae kv" href="https://github.com/TheOtterlord/v8-runtime-tutorial/tree/main/01-creating-a-repl" rel="noopener ugc nofollow" target="_blank"> GitHub </a>上找到，我在下面列出了一些使本教程成为可能的精彩资源。</p><p id="5824" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">下一次，我们将使用一些已经准备好的代码(比如<code class="fe mp mq mr ms b">TryCatch</code>范围)来处理错误。</p><h1 id="35b2" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated"><strong class="ak">资源</strong></h1><ul class=""><li id="67dd" class="np nq iq ky b kz mk lc ml lf nr lj ns ln nt lr nu nv nw nx bi translated"><a class="ae kv" href="https://github.com/TheOtterlord/v8-runtime-tutorial/tree/main/01-creating-a-repl" rel="noopener ugc nofollow" target="_blank">教程源代码</a></li><li id="a7b9" class="np nq iq ky b kz ny lc nz lf oa lj ob ln oc lr nu nv nw nx bi translated"><a class="ae kv" href="https://github.com/nodejs/node/tree/main/src#helpful-concepts" rel="noopener ugc nofollow" target="_blank">有用的概念— Node.js GitHub库</a></li><li id="4be9" class="np nq iq ky b kz ny lc nz lf oa lj ob ln oc lr nu nv nw nx bi translated"><a class="ae kv" href="https://docs.rs/v8/latest/v8/index.html" rel="noopener ugc nofollow" target="_blank"> V8防锈绑定文档— Docs.rs </a></li><li id="3ff2" class="np nq iq ky b kz ny lc nz lf oa lj ob ln oc lr nu nv nw nx bi translated"><a class="ae kv" href="https://github.com/denoland/rusty_v8/tree/main/examples" rel="noopener ugc nofollow" target="_blank"> V8生锈绑定示例—生锈的V8 GitHub </a></li></ul></div><div class="ab cl od oe hu of" role="separator"><span class="og bw bk oh oi oj"/><span class="og bw bk oh oi oj"/><span class="og bw bk oh oi"/></div><div class="ij ik il im in"><p id="fe9a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><em class="ok">更多内容看</em> <a class="ae kv" href="https://plainenglish.io/" rel="noopener ugc nofollow" target="_blank"> <strong class="ky ir"> <em class="ok">说白了。报名参加我们的</em> <a class="ae kv" href="http://newsletter.plainenglish.io/" rel="noopener ugc nofollow" target="_blank"> <strong class="ky ir"> <em class="ok">免费每周简讯</em> </strong> </a> <em class="ok">。关注我们关于</em> <a class="ae kv" href="https://twitter.com/inPlainEngHQ" rel="noopener ugc nofollow" target="_blank"> <strong class="ky ir"> <em class="ok">推特</em> </strong> </a>，<a class="ae kv" href="https://www.linkedin.com/company/inplainenglish/" rel="noopener ugc nofollow" target="_blank"> <strong class="ky ir"> <em class="ok">领英</em> </strong> </a> <em class="ok">，以及</em> <a class="ae kv" href="https://discord.gg/GtDtUAvyhW" rel="noopener ugc nofollow" target="_blank"> <strong class="ky ir"> <em class="ok">不和</em> </strong> </a> <em class="ok">。</em></strong></a></p></div></div>    
</body>
</html>