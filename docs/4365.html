<html>
<head>
<title>How to Use LocalStorage Safely</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何安全使用LocalStorage</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/how-to-use-localstorage-safely-a96eb50fbb4e?source=collection_archive---------1-----------------------#2022-11-25">https://javascript.plainenglish.io/how-to-use-localstorage-safely-a96eb50fbb4e?source=collection_archive---------1-----------------------#2022-11-25</a></blockquote><div><div class="fc ic id ie if ig"/><div class="ih ii ij ik il"><div class=""/><div class=""><h2 id="4048" class="pw-subtitle-paragraph jl in io bd b jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc dk translated">检测浏览器是否支持本地存储</h2></div><figure class="ke kf kg kh gu ki gi gj paragraph-image"><div role="button" tabindex="0" class="kj kk di kl bf km"><div class="gi gj kd"><img src="../Images/ce7b5ca0ad89628fe05d04aa9e2de7ba.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*TfrDNRPLJV80Px4s"/></div></div><figcaption class="kp kq gk gi gj kr ks bd b be z dk">Photo by <a class="ae kt" href="https://unsplash.com/@kmuza?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Carlos Muza</a> on <a class="ae kt" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="ce38" class="pw-post-body-paragraph ku kv io kw b kx ky jp kz la lb js lc ld le lf lg lh li lj lk ll lm ln lo lp ih bi translated">上周，当我专注于编码时，一个生产错误警告消息打断了我。我不得不停止工作，看看发生了什么事。</p><p id="152f" class="pw-post-body-paragraph ku kv io kw b kx ky jp kz la lb js lc ld le lf lg lh li lj lk ll lm ln lo lp ih bi translated">错误是</p><figure class="ke kf kg kh gu ki gi gj paragraph-image"><div role="button" tabindex="0" class="kj kk di kl bf km"><div class="gi gj lq"><img src="../Images/b22888e0462cfe5cd1205af445fe08fc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_kamA_DgyR1E7-2x5ww35g.png"/></div></div></figure><p id="a147" class="pw-post-body-paragraph ku kv io kw b kx ky jp kz la lb js lc ld le lf lg lh li lj lk ll lm ln lo lp ih bi translated">我们无法从生产的代码位置知道哪些代码工作不好。javascript文件都是编译过的，而且很难看。</p><p id="0eaa" class="pw-post-body-paragraph ku kv io kw b kx ky jp kz la lb js lc ld le lf lg lh li lj lk ll lm ln lo lp ih bi translated">在搜索问题时，我们可以发现浏览器不支持localStorage。最简单的解决方案是在使用localStorage时捕获错误:</p><pre class="ke kf kg kh gu lr ls lt bn lu lv bi"><span id="2eda" class="lw lx io ls b be ly lz l ma mb">try {<br/>  const data = localStroage.getItem(key)<br/>} catch(e) {<br/>  // if localStorage not support, fallback<br/>}</span></pre><p id="3320" class="pw-post-body-paragraph ku kv io kw b kx ky jp kz la lb js lc ld le lf lg lh li lj lk ll lm ln lo lp ih bi translated">但是如果有很多localStorage代码片段，这种方式会使我们的代码变得复杂。</p><p id="5a53" class="pw-post-body-paragraph ku kv io kw b kx ky jp kz la lb js lc ld le lf lg lh li lj lk ll lm ln lo lp ih bi translated">更好的方法是提供一个util文件来完成:</p><pre class="ke kf kg kh gu lr ls lt bn lu lv bi"><span id="860c" class="lw lx io ls b be ly lz l ma mb">export const storage = {<br/>  getItem(key, fallbackValue) {<br/>    try {<br/>      return localStorage.getItem(key);<br/>    } catch(e) {<br/>      return fallbackValue;<br/>    }<br/>  },<br/>  setItem(key, value) {<br/>    try {<br/>      localStorage.setItem(key, value);<br/>    } catch(e) {<br/>      // <br/>    }<br/>  }<br/>  removeItem(key, value) {<br/>    try {<br/>      localStorage.removeItem(key, value);<br/>    } catch(e) {<br/>      // <br/>    }<br/>  }<br/>}</span></pre><p id="1c6c" class="pw-post-body-paragraph ku kv io kw b kx ky jp kz la lb js lc ld le lf lg lh li lj lk ll lm ln lo lp ih bi translated">在我们的代码中，我们可以导入util并使用<code class="fe mc md me ls b">storage.getItem</code>来访问本地存储数据。但是这种方式也可以继续优化，因为它会丢失相同页面上下文中的数据。</p><p id="47a8" class="pw-post-body-paragraph ku kv io kw b kx ky jp kz la lb js lc ld le lf lg lh li lj lk ll lm ln lo lp ih bi translated">如果不支持localStorage，我们可以退而使用内存。最终的方式会是这样的:</p><pre class="ke kf kg kh gu lr ls lt bn lu lv bi"><span id="eafd" class="lw lx io ls b be ly lz l ma mb">function isSupportLS() {<br/>  try {<br/>    localStorage.setItem('_ranger-test-key', 'hi')<br/>    localStorage.getItem('_ranger-test-key')<br/>    localStorage.removeItem('_ranger-test-key')<br/>    return true<br/>  } catch (e) {<br/>    return false<br/>  }<br/>}<br/><br/>class Memory {<br/>  constructor() {<br/>    this.cache = {}<br/>  }<br/>  setItem(cacheKey, data) {<br/>    this.cache[cacheKey] = data<br/>  }<br/>  getItem(cacheKey) {<br/>    return this.cache[cacheKey]<br/>  }<br/>  removeItem(cacheKey) {<br/>    this.cache[cacheKey] = undefined<br/>  }<br/>}<br/>// if not support localStorage, fallback to memory<br/>export const storage = isSupportLS() ? window.localStorage : new Memory();</span></pre><p id="6277" class="pw-post-body-paragraph ku kv io kw b kx ky jp kz la lb js lc ld le lf lg lh li lj lk ll lm ln lo lp ih bi translated">我们可以通过阻止所有cookie来禁用localStorage，请访问chrome://settings/cookies:</p><figure class="ke kf kg kh gu ki gi gj paragraph-image"><div role="button" tabindex="0" class="kj kk di kl bf km"><div class="gi gj mf"><img src="../Images/d5daf217fb7c177e938167af6e45bd39.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*R_QX-edi621dpZ62fmW3Og.png"/></div></div></figure><p id="8557" class="pw-post-body-paragraph ku kv io kw b kx ky jp kz la lb js lc ld le lf lg lh li lj lk ll lm ln lo lp ih bi translated">然后在Chrome控制台中测试这段代码，它运行良好:</p><figure class="ke kf kg kh gu ki gi gj paragraph-image"><div role="button" tabindex="0" class="kj kk di kl bf km"><div class="gi gj mg"><img src="../Images/b602317a28da67edf13898f4b83154f1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fL5Tl4HehrlwHsXt7oWa5A.png"/></div></div></figure><p id="31b8" class="pw-post-body-paragraph ku kv io kw b kx ky jp kz la lb js lc ld le lf lg lh li lj lk ll lm ln lo lp ih bi translated">希望这篇文章能帮到你，也期待跟着我学习更多的技巧。</p><p id="0d94" class="pw-post-body-paragraph ku kv io kw b kx ky jp kz la lb js lc ld le lf lg lh li lj lk ll lm ln lo lp ih bi translated"><em class="mh">更多内容尽在</em> <a class="ae kt" href="https://plainenglish.io/" rel="noopener ugc nofollow" target="_blank"> <strong class="kw ip"> <em class="mh">说白了. io </em> </strong> </a> <em class="mh">。报名参加我们的</em> <a class="ae kt" href="http://newsletter.plainenglish.io/" rel="noopener ugc nofollow" target="_blank"> <strong class="kw ip"> <em class="mh">免费周报</em> </strong> </a> <em class="mh">。关注我们关于</em> <a class="ae kt" href="https://twitter.com/inPlainEngHQ" rel="noopener ugc nofollow" target="_blank"> <strong class="kw ip"> <em class="mh">推特</em> </strong> </a>，<a class="ae kt" href="https://www.linkedin.com/company/inplainenglish/" rel="noopener ugc nofollow" target="_blank"><strong class="kw ip"><em class="mh">LinkedIn</em></strong></a><em class="mh">，</em><a class="ae kt" href="https://www.youtube.com/channel/UCtipWUghju290NWcn8jhyAw" rel="noopener ugc nofollow" target="_blank"><strong class="kw ip"><em class="mh">YouTube</em></strong></a><em class="mh">，</em> <a class="ae kt" href="https://discord.gg/GtDtUAvyhW" rel="noopener ugc nofollow" target="_blank"> <strong class="kw ip"> <em class="mh">不和</em> </strong> </a> <em class="mh">。对增长黑客感兴趣？检查</em> <a class="ae kt" href="https://circuit.ooo/" rel="noopener ugc nofollow" target="_blank"> <strong class="kw ip"> <em class="mh">电路</em> </strong> </a> <em class="mh">。</em></p></div></div>    
</body>
</html>