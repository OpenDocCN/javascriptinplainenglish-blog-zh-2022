<html>
<head>
<title>What are Cross-Site Request Forgery (CSRF) Attacks</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">什么是跨站点请求伪造(CSRF)攻击</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/what-are-cross-site-request-forgery-csrf-attacks-4fe5f5670c08?source=collection_archive---------11-----------------------#2022-06-06">https://javascript.plainenglish.io/what-are-cross-site-request-forgery-csrf-attacks-4fe5f5670c08?source=collection_archive---------11-----------------------#2022-06-06</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><div class=""><h2 id="7673" class="pw-subtitle-paragraph jk im in bd b jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb dk translated">通过创建模拟应用程序了解CSRF攻击。</h2></div><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi kc"><img src="../Images/d987e6167e23f9dfd9d6b63c10fafa1d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zuBZXC2YoVm1ldSVVp5TOw.jpeg"/></div></div><figcaption class="ko kp gj gh gi kq kr bd b be z dk">Photo by <a class="ae ks" href="https://www.pexels.com/@kaiquestr/" rel="noopener ugc nofollow" target="_blank">Kaique Rocha</a> on <a class="ae ks" href="https://www.pexels.com/photo/person-wearing-adidas-hoodie-during-daytime-171945/" rel="noopener ugc nofollow" target="_blank">pexels</a></figcaption></figure><p id="829b" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">当我第一次开始我的web开发之旅时，我有很多关于令牌管理和认证的问题。我心中的主要问题是，我如何在客户端管理令牌。通过在线阅读，我看到了许多参考了<a class="ae ks" href="https://owasp.org/www-community/attacks/xss/" rel="noopener ugc nofollow" target="_blank">跨站脚本(XSS)攻击</a>的文章。阅读了关于XSS的文章后，我得出结论，将令牌存储为HTTP-only cookie可以解决我的所有问题，因为在客户端无法通过JavaScript访问它。虽然HTTP-only标志有助于抵御XSS，但它使我的应用程序容易受到<a class="ae ks" href="https://owasp.org/www-community/attacks/csrf" rel="noopener ugc nofollow" target="_blank">跨站请求伪造(CSRF)攻击</a>。</p><p id="788e" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">在这篇博客中，我将通过一个非常简单的模拟应用程序来展示CSRF是如何工作的。由于代码库很大，所以我不会在这篇博客中一一介绍。我将只强调关键部分，以解释是什么使应用程序容易受到CSRF的攻击。如果你想回顾所有的代码，你可以在这里找到它<a class="ae ks" href="https://github.com/hanskrohn/CSRF-example" rel="noopener ugc nofollow" target="_blank">。</a></p><p id="219f" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated"><em class="lp">免责声明:我不是安全专家，而是对学习感兴趣的人。如果你注意到这篇文章中的错误或者可以改进的地方，请在评论中提出来。帮助我和其他人继续学习。</em></p><h2 id="620d" class="lq lr in bd ls lt lu dn lv lw lx dp ly lc lz ma mb lg mc md me lk mf mg mh mi bi translated">了解CSRF以及我们将如何实施攻击</h2><p id="31d9" class="pw-post-body-paragraph kt ku in kv b kw mj jo ky kz mk jr lb lc ml le lf lg mm li lj lk mn lm ln lo ig bi translated">首先，让我们快速讨论一下CSRF攻击是如何工作的。CSRF的目的是欺骗受害者提交一个不想要的请求。这些攻击还侧重于改变服务器的状态，而不是接收信息。为了使这些攻击起作用，受害者必须以这样的方式被认证，即服务器不能知道是谁在发出请求。在我们的应用程序中，我们将管理用于身份验证的JWT令牌，并将它们存储为cookies。将认证作为cookie来管理的问题是，cookie是在每个请求时<a class="ae ks" href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Cookies" rel="noopener ugc nofollow" target="_blank">发送的。这是一个主要的设计缺陷，因为任何请求都会被服务器认为是合法的。</a></p><p id="819d" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">幸运的是，有一些方法可以帮助防止这种攻击。首先是使用<code class="fe mo mp mq mr b">same-origin policy</code>。在应用程序中，你会注意到我指定CORS允许来自任何来源的请求。通过允许来自任何来源的请求，攻击者可以通过网络钓鱼技术诱骗受害者提交不想要的/未知的请求。通过限制来自同一来源的请求，我们可以保证客户端只提交通过我们的应用程序可用的请求(除非您的应用程序有XSS漏洞，在这种情况下，可以发起CSRF攻击。但是如果是这样的话，你的网站就有更大的问题要担心了。).另一个解决方案是实现一个刷新和认证令牌系统。我的朋友写了一篇博客，解释了如何使用NodeJS和React实现这个系统。你可以在这里查看<a class="ae ks" href="https://blog.garethlau.me/token-authentication" rel="noopener ugc nofollow" target="_blank"/>。</p><h2 id="7ae9" class="lq lr in bd ls lt lu dn lv lw lx dp ly lc lz ma mb lg mc md me lk mf mg mh mi bi translated">构建应用程序</h2><p id="848d" class="pw-post-body-paragraph kt ku in kv b kw mj jo ky kz mk jr lb lc ml le lf lg mm li lj lk mn lm ln lo ig bi translated">如前所述，我将只讨论关键细节，以展示这个模拟应用程序如何容易受到CSRF的攻击。如果你想看完整的代码库，你可以点击这里<a class="ae ks" href="https://github.com/hanskrohn/CSRF-example" rel="noopener ugc nofollow" target="_blank"/>。</p><p id="74e5" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">这款应用试图模仿一家银行。它有一些非常简单的功能。登录功能、获取余额功能和转账功能。它也只有两个客户端。一个真正的用户，他将充当我们的受害者，和一个恶意用户。下面你可以看到账户信息。</p><figure class="kd ke kf kg gt kh"><div class="bz fp l di"><div class="ms mt l"/></div></figure><p id="00a9" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">接下来，我们将检查应用程序的功能。如前所述，有三个端点。它们都写得非常简单，我没有太多的验证。例如，您会注意到，我在完成转账之前不会检查是否有足够的资金。我还通过检查有效的用户id来执行登录功能。这只是为了简单起见。如果您通过密码进行身份验证，这个逻辑同样适用。需要注意的关键信息是，<code class="fe mo mp mq mr b">login</code>函数创建了一个JWT令牌，它作为一个HTTP-only cookie存储在客户端，并且<code class="fe mo mp mq mr b">getBalance</code>和<code class="fe mo mp mq mr b">transfer</code>端点通过认证中间件得到保护。</p><figure class="kd ke kf kg gt kh"><div class="bz fp l di"><div class="ms mt l"/></div></figure><p id="9517" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">最后，我在下面包括了认证中间件。这只是在继续处理请求之前做一个快速检查，以确保JWT令牌有效。</p><figure class="kd ke kf kg gt kh"><div class="bz fp l di"><div class="ms mt l"/></div></figure><p id="28cc" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">接下来，我们获得了银行应用程序的客户端代码。还是那句话，超级简单。按下按钮的响应将记录在浏览器控制台中。</p><figure class="kd ke kf kg gt kh"><div class="bz fp l di"><div class="ms mt l"/></div></figure><figure class="kd ke kf kg gt kh"><div class="bz fp l di"><div class="ms mt l"/></div></figure><p id="ac02" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">最后，我们得到了我们将发起CSRF攻击的网站的代码。在这个例子中，一个站点只是一个带有提交按钮的空表单，它向我们的传输端点发送一个<code class="fe mo mp mq mr b">POST</code>请求。</p><figure class="kd ke kf kg gt kh"><div class="bz fp l di"><div class="ms mt l"/></div></figure><p id="0f30" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">请记住，CSRF攻击不仅限于形式，攻击者可以非常有创意地欺骗受害者提交不需要的请求。</p><h2 id="18ea" class="lq lr in bd ls lt lu dn lv lw lx dp ly lc lz ma mb lg mc md me lk mf mg mh mi bi translated">运行这段代码并观察它的运行</h2><p id="9da2" class="pw-post-body-paragraph kt ku in kv b kw mj jo ky kz mk jr lb lc ml le lf lg mm li lj lk mn lm ln lo ig bi translated">接下来，我将运行这段代码，从受害者的角度展示会发生什么。</p><p id="0e67" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">当我们第一次打开网站时，我们将进入一个类似这样的页面。如果我尝试检查我的余额，您会注意到由于身份验证失败，请求被阻止。这很好，表明我们的受保护终端正在按预期工作。</p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi mu"><img src="../Images/87d7f07122c9fac01efffe665254ab5d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4yNdF5epqs9jmoMmTMHFew.png"/></div></div><figcaption class="ko kp gj gh gi kq kr bd b be z dk">Request to protected endpoint blocked</figcaption></figure><p id="54e4" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">接下来，我将登录并尝试检查我的余额。这一次，我们应该能够看到我们的请求成功，并返回我们的银行余额10，000。检查application选项卡，我们还可以看到我们的身份验证令牌实际上被正确地存储为一个HTTP-only cookie。</p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi mv"><img src="../Images/88130bd6d3bb3a35c959685144c2e144.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rW2_q_6ZeF6Aqy7yI93dJw.png"/></div></div><figcaption class="ko kp gj gh gi kq kr bd b be z dk">Successful Authentication</figcaption></figure><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi mv"><img src="../Images/857c55cca5fde1b8819c4a58366bdb74.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*U0euhBo0i3uyZjCtzxnfxA.png"/></div></div><figcaption class="ko kp gj gh gi kq kr bd b be z dk">Displaying Balance</figcaption></figure><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi mw"><img src="../Images/8a3aa326a4614bfbefcf0d948619b998.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-LjOZd8yjGYDD8myhsvA1A.png"/></div></div><figcaption class="ko kp gj gh gi kq kr bd b be z dk">Token being stored as HTTP-only cookie</figcaption></figure><p id="c3c6" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">接下来，我会想象我通过电子邮件链接被钓鱼。当我访问攻击者的网站时，我点击了提交按钮，这触发了一个代表我的不必要的请求。同样，由于身份验证是通过cookie管理的，服务器认为我的请求是有效的请求，并将我的钱转移到攻击者的帐户。下面你可以看到攻击者的网站显示什么。</p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi mx"><img src="../Images/e8a5a83dc0f9d8014491cf38beb6d7d0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xR-yFewuBdYQ8CFjwlIewQ.png"/></div></div></figure><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi my"><img src="../Images/0d806bcdf99c1ea81890c2528f4c05ca.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NcldgF9HpJigXEjNZbbrYg.png"/></div></div><figcaption class="ko kp gj gh gi kq kr bd b be z dk">After submitting displays my banks JSON response. Transfer succeeded</figcaption></figure><p id="126e" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">回到官方网站，我们可以看到我的平衡是如何由于CSRF的成功攻击而改变的。</p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi mz"><img src="../Images/1dcdab2f4750c3b7df8fcfc5b9531d27.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*TeXQu4UNGGdRexb4j24kfA.png"/></div></div><figcaption class="ko kp gj gh gi kq kr bd b be z dk">After checking balance again, we can see 9990 was transferred out of my account.</figcaption></figure></div><div class="ab cl na nb hr nc" role="separator"><span class="nd bw bk ne nf ng"/><span class="nd bw bk ne nf ng"/><span class="nd bw bk ne nf"/></div><div class="ig ih ii ij ik"><p id="81e4" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">同样，如果我犯了一个错误，或者如果这篇文章有改进的地方，请留下评论，帮助我和其他人继续学习。下次见。编码快乐！</p><p id="d642" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated"><em class="lp">更多内容请看</em><a class="ae ks" href="https://plainenglish.io/" rel="noopener ugc nofollow" target="_blank"><strong class="kv io"><em class="lp">plain English . io</em></strong></a><em class="lp">。报名参加我们的</em> <a class="ae ks" href="http://newsletter.plainenglish.io/" rel="noopener ugc nofollow" target="_blank"> <strong class="kv io"> <em class="lp">免费周报</em> </strong> </a> <em class="lp">。关注我们关于</em><a class="ae ks" href="https://twitter.com/inPlainEngHQ" rel="noopener ugc nofollow" target="_blank"><strong class="kv io"><em class="lp">Twitter</em></strong></a><em class="lp">和</em><a class="ae ks" href="https://www.linkedin.com/company/inplainenglish/" rel="noopener ugc nofollow" target="_blank"><strong class="kv io"><em class="lp">LinkedIn</em></strong></a><em class="lp">。查看我们的</em> <a class="ae ks" href="https://discord.gg/GtDtUAvyhW" rel="noopener ugc nofollow" target="_blank"> <strong class="kv io"> <em class="lp">社区不和谐</em> </strong> </a> <em class="lp">加入我们的</em> <a class="ae ks" href="https://inplainenglish.pallet.com/talent/welcome" rel="noopener ugc nofollow" target="_blank"> <strong class="kv io"> <em class="lp">人才集体</em> </strong> </a> <em class="lp">。</em></p></div></div>    
</body>
</html>