<html>
<head>
<title>MongoDB Updates with Mongoose and Node.js Streams</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">MongoDB用Mongoose和Node.js流更新</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/mongodb-updates-with-mongoose-and-node-js-streams-c1839783b07d?source=collection_archive---------5-----------------------#2022-11-09">https://javascript.plainenglish.io/mongodb-updates-with-mongoose-and-node-js-streams-c1839783b07d?source=collection_archive---------5-----------------------#2022-11-09</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><figure class="gl gn jl jm jn jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi jk"><img src="../Images/82d0bd2a7c757698dd3d0699a83860b4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Sdnd53sqLK-JcPAb"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk">Photo by <a class="ae jz" href="https://unsplash.com/@veroz?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Andy Mai</a> on <a class="ae jz" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="15ce" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">在MongoDB上工作的一个常见任务是通过一些重新计算来更新一个大型集合，这是直接数据库查询无法完成的。</p><p id="608a" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">第一种方法是将整个集合读入内存，然后更新文档。如果收集量很大，那么发生oom的几率是不可避免的。</p><figure class="ky kz la lb gt jo"><div class="bz fp l di"><div class="lc ld l"/></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk">Update all documents in memory</figcaption></figure><p id="5e8c" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">第二种方法是使用分页，然后批量更新。<br/>第二种方法的问题是，我们是分批进行的，而且是连续处理的。</p><p id="babe" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">首先，我们获得一个批处理，然后应用一些转换，然后保存文档。</p><figure class="ky kz la lb gt jo"><div class="bz fp l di"><div class="lc ld l"/></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk">Update in batches</figcaption></figure><p id="438f" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><strong class="kc io">如果我们能同时做这三件事会怎么样？</strong> <br/>我们在处理和保存上一批数据的同时，得到下一批数据。<br/>这就是流处理和管道发挥作用的地方。<br/> 1。想象一下从MongoDB中以读取流的形式批量读取</p><p id="5f2a" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">2.然后，我们使用转换流将转换应用于文档</p><p id="afaa" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">3.最后，使用写流将数据保存到数据库</p><p id="ccbc" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">因此，并行运行这3个流是通过使用管道实现的。</p><figure class="ky kz la lb gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi le"><img src="../Images/b7a3eeae56b28905f0e40eb90f25026e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*lHsSHTrMYZTd44hJ"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk">Photo by <a class="ae jz" href="https://unsplash.com/@spacexuan?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Crystal Kwok</a> on <a class="ae jz" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="5f2c" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">Node.js支持带有<code class="fe lf lg lh li b">stream</code>包的流，Mongoose支持使用<code class="fe lf lg lh li b">cursor</code>方法读取流以进行<code class="fe lf lg lh li b">find</code>查询</p><p id="a20f" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><strong class="kc io"> 1。在模型</strong>上创建样本读取流</p><pre class="ky kz la lb gt lj li lk ll aw lm bi"><span id="597b" class="ln lo in li b gy lp lq l lr ls">const readStream = Model.find(filters).cursor({batchSize: 10});</span></pre><p id="0d1e" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><strong class="kc io"> 2。创建一个转换流</strong></p><pre class="ky kz la lb gt lj li lk ll aw lm bi"><span id="5e03" class="ln lo in li b gy lp lq l lr ls">const transformStream = new Transform({<br/>    objectMode: true,<br/>    transform: (doc, encoding, callback) =&gt; {<br/>        // processing logic on each doc<br/>        callback(null, doc);<br/>    },<br/>});</span></pre><p id="a9b0" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><strong class="kc io"> 3。创建到数据库的写流</strong></p><pre class="ky kz la lb gt lj li lk ll aw lm bi"><span id="092d" class="ln lo in li b gy lp lq l lr ls">const writeStream = new Writable({<br/>    objectMode: true,<br/>    write: async(doc, encoding, callback) =&gt; {<br/>      await doc.save();<br/>      callback();<br/>    }<br/>});</span></pre><p id="3562" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><em class="lt">注意:-我们已经将objectMode设置为true，因为默认情况下流使用缓冲区，但是我们使用的是对象</em></p><p id="b679" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><strong class="kc io">连接所有三样东西</strong></p><pre class="ky kz la lb gt lj li lk ll aw lm bi"><span id="7abd" class="ln lo in li b gy lp lq l lr ls">readStream.pipe(transformStream).pipe(writeStream);</span></pre><p id="40da" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><strong class="kc io">如何等待所有流完成？</strong></p><pre class="ky kz la lb gt lj li lk ll aw lm bi"><span id="48be" class="ln lo in li b gy lp lq l lr ls">writeStream.on('end', ()=&gt;{<br/>   console.log('Done');<br/>});</span></pre><p id="5694" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">更好的方法是使用Nodejs <code class="fe lf lg lh li b">stream</code>包中的<code class="fe lf lg lh li b">pipeline</code></p><pre class="ky kz la lb gt lj li lk ll aw lm bi"><span id="699b" class="ln lo in li b gy lp lq l lr ls">pipeline(readStream, transformStream, wrriteStream, (err)=&gt;{<br/>    if(err) {<br/>        console.error(err);<br/>        return;<br/>    }<br/>    console.log('Done');<br/>});</span><span id="2476" class="ln lo in li b gy lu lq l lr ls">// Or using pipeline from stream/promises</span><span id="e3e6" class="ln lo in li b gy lu lq l lr ls">await pipeline(readStream, transformStream, wrriteStream);</span></pre><p id="26be" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">我们用Mongoose编写了一个通用的util方法来处理这种模式的事情。</p><figure class="ky kz la lb gt jo"><div class="bz fp l di"><div class="lc ld l"/></div></figure><p id="ec3d" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><strong class="kc io">上述实用程序有5个参数</strong></p><ol class=""><li id="a8d8" class="lv lw in kc b kd ke kh ki kl lx kp ly kt lz kx ma mb mc md bi translated">模型类</li><li id="56c4" class="lv lw in kc b kd me kh mf kl mg kp mh kt mi kx ma mb mc md bi translated">流式传输时要应用的过滤器</li><li id="fe05" class="lv lw in kc b kd me kh mf kl mg kp mh kt mi kx ma mb mc md bi translated">转换函数</li><li id="1f46" class="lv lw in kc b kd me kh mf kl mg kp mh kt mi kx ma mb mc md bi translated">写入功能</li><li id="a964" class="lv lw in kc b kd me kh mf kl mg kp mh kt mi kx ma mb mc md bi translated">选项:- <code class="fe lf lg lh li b">batchSize</code>默认10张单据批量取数据</li></ol><p id="053f" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><strong class="kc io">样品用途</strong></p><pre class="ky kz la lb gt lj li lk ll aw lm bi"><span id="05f4" class="ln lo in li b gy lp lq l lr ls">// Assume we are breaking fullName to firstName and lastName</span><span id="5d61" class="ln lo in li b gy lu lq l lr ls">const filters = {<br/>    fullName: {<br/>      $exists: true<br/>    }<br/>};</span><span id="098f" class="ln lo in li b gy lu lq l lr ls">const transform = (doc)=&gt; {<br/>  const [firstName, lastName] = doc.fullName.split(' ');<br/>  doc.firstName = firstName;<br/>  doc.lastName = lastName;<br/>  delete doc.fullName;<br/>  return doc;<br/>}</span><span id="d02a" class="ln lo in li b gy lu lq l lr ls">const save = doc =&gt; doc.save();</span><span id="287a" class="ln lo in li b gy lu lq l lr ls">await updateWithStream(Person, filters, transform, save, {<br/>   batchSize: 20,<br/>});</span></pre><p id="e90b" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><strong class="kc io">参考文献:- </strong></p><p id="2c98" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">Util代码:-<a class="ae jz" href="https://gist.github.com/Deepak13245/d920fe4035dc52894dc084c29f7b4b5e" rel="noopener ugc nofollow" target="_blank">https://gist . github . com/Deepak 13245/d 920 Fe 4035 DC 52894 DC 084 c 29 f 7 B4 b 5 e</a></p><p id="1196" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">Nodejs流:-<a class="ae jz" href="https://nodejs.org/api/stream.html" rel="noopener ugc nofollow" target="_blank">https://nodejs.org/api/stream.html</a></p><p id="dfc5" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">猫鼬光标:-<a class="ae jz" href="https://mongoosejs.com/docs/api/querycursor.html" rel="noopener ugc nofollow" target="_blank">https://mongoosejs.com/docs/api/querycursor.html</a></p><p id="4e80" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><em class="lt">更多内容请看</em><a class="ae jz" href="https://plainenglish.io/" rel="noopener ugc nofollow" target="_blank"><strong class="kc io"><em class="lt">plain English . io</em></strong></a><em class="lt">。报名参加我们的</em> <a class="ae jz" href="http://newsletter.plainenglish.io/" rel="noopener ugc nofollow" target="_blank"> <strong class="kc io"> <em class="lt">免费周报</em> </strong> </a> <em class="lt">。关注我们关于</em><a class="ae jz" href="https://twitter.com/inPlainEngHQ" rel="noopener ugc nofollow" target="_blank"><strong class="kc io"><em class="lt">Twitter</em></strong></a><a class="ae jz" href="https://www.linkedin.com/company/inplainenglish/" rel="noopener ugc nofollow" target="_blank"><strong class="kc io"><em class="lt">LinkedIn</em></strong></a><em class="lt"/><a class="ae jz" href="https://www.youtube.com/channel/UCtipWUghju290NWcn8jhyAw" rel="noopener ugc nofollow" target="_blank"><strong class="kc io"><em class="lt">YouTube</em></strong></a><em class="lt"/><a class="ae jz" href="https://discord.gg/GtDtUAvyhW" rel="noopener ugc nofollow" target="_blank"><strong class="kc io"><em class="lt">不和</em> </strong> </a> <em class="lt">。对增长黑客感兴趣？检查</em> <a class="ae jz" href="https://circuit.ooo/" rel="noopener ugc nofollow" target="_blank"> <strong class="kc io"> <em class="lt">电路</em> </strong> </a> <em class="lt">。</em></p></div></div>    
</body>
</html>