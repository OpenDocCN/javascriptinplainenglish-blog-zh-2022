# ä½¿ç”¨ sendBeacon()åœ¨ JavaScript ä¸­è®¡ç®—â€œé¡µé¢æ—¶é—´â€çš„ç®—æ³•

> åŸæ–‡ï¼š<https://javascript.plainenglish.io/best-algorithm-to-implement-time-on-page-in-vanilla-javascript-using-sendbeacon-530bc8391ef5?source=collection_archive---------1----------------------->

![](img/a847405b10817582caf24ce096a73681.png)

*å£°æ˜:åŸæ–‡ç« å‘è¡¨äº* ***æˆ‘çš„å®˜æ–¹åšå®¢*** *ã€‚æŸ¥çœ‹* [*è¿™é‡Œ*](https://nerdsway.herokuapp.com/blog/best-way-to-implement-time-on-page-in-vanilla-javascript-using-sendbeacon-vvwptpu/)

ç†æƒ³æƒ…å†µä¸‹ï¼Œâ€œ**é¡µé¢ä¸Šçš„æ—¶é—´**â€æ˜¯æŒ‡ä¸€ä¸ªäººç™»é™†ä¸€ä¸ªç½‘é¡µå’Œè½¬åˆ°å¦ä¸€ä¸ªç½‘é¡µä¹‹é—´çš„æ—¶é—´ã€‚è¯·è®°ä½ï¼Œå¦‚æœè¿™ä¸ªäººæ²¡æœ‰ç§»åŠ¨åˆ°ç¬¬äºŒé¡µï¼Œåœ¨è¯¥é¡µä¸Šçš„æ—¶é—´ä¸ä¼šè¢«è®¡ç®—æˆ–æ·»åŠ åˆ°å¹³å‡å€¼ä¸­ã€‚å°±å¥½åƒè¿™ä¸ªäººä»æ¥æ²¡æœ‰æ¥è¿‡ã€‚ä½†æ˜¯æ‚¨ä¸åº”è¯¥å°†è¿™ä¸ªæŒ‡æ ‡ä¸ä¼šè¯æŒç»­æ—¶é—´æ··æ·†ã€‚

ä½†æ˜¯ï¼Œæˆ‘ä»¬ä¸ä¼šåšç±»ä¼¼è°·æ­Œåˆ†æçš„ä¸œè¥¿ã€‚è¿™æœ‰ä¸¤ä¸ªåŸå› ã€‚ç¬¬ä¸€ï¼Œæˆ‘ä»¬ä¸å·æ•°æ®ï¼Œç¬¬äºŒï¼Œæˆ‘ä»¬æ²¡é‚£ä¹ˆèªæ˜ã€‚æ­¤å¤–ï¼ŒGA ä¸å…è®¸å°†ä»–ä»¬çš„æ•°æ®ç”¨äºå¼€å‘ç”¨é€”ã€‚æˆ‘ä»¬ä¸ä¼šè·Ÿè¸ªç”¨æˆ·ï¼Œç›¸åï¼Œæˆ‘ä»¬å°†åˆ›å»ºä¸€ä¸ªç®—æ³•ï¼Œå¯ä»¥è¿”å›ç”¨æˆ·åœ¨è¯¥é¡µé¢ä¸ŠèŠ±è´¹çš„ç§’æ•°(æˆ–åˆ†é’Ÿæ•°)ã€‚

> *ç›¸ä¿¡æˆ‘ï¼Œå‡†ç¡®ç‡é«˜è¾¾ 98%*

åœ¨åšäº†å¤§é‡çš„ç ”ç©¶(Google/StackOverflow/Academia)åï¼Œæˆ‘æ‰¾åˆ°äº†è§£å†³è¿™ä¸ªé—®é¢˜çš„æœ€ä½³æ–¹æ³•ã€‚

**è¿™ç§æ–¹æ³•æœ‰é—®é¢˜å—ï¼Ÿå½“ç„¶äº†ã€‚æ˜¯ä¸æ˜¯å“ªé‡Œéƒ½é€‚ç”¨ï¼Ÿå¤§æ¦‚å§ã€‚ä½†æ˜¯å®ƒèƒ½åœ¨å°è§„æ¨¡çš„å®é™…åº”ç”¨ä¸­å®ç°å—ï¼Ÿæ˜¯å•Šï¼**

è¿™ä¸ªè§£å†³æ–¹æ¡ˆä¸­ä½¿ç”¨çš„è¯­è¨€æ˜¯ JavaScriptï¼Œå› ä¸ºè¿™æ˜¯æˆ‘ä»¬çŸ¥é“ DOM ä¸­å‘ç”Ÿäº†ä»€ä¹ˆçš„å”¯ä¸€æ–¹æ³•ã€‚è¿˜å› ä¸ºä¸€ä½æ™ºè€…æ›¾ç»è¯´è¿‡**â€œä»»ä½•å¯ä»¥ç”¨ JavaScript ç¼–å†™çš„åº”ç”¨ç¨‹åºï¼Œæœ€ç»ˆéƒ½ä¼šç”¨ JavaScript ç¼–å†™ã€‚â€â€”â€”é˜¿ç‰¹ä¼å¾·å®šå¾‹(æ°å¤«Â·é˜¿ç‰¹ä¼å¾·)**

# ç†è®ºè§£é‡Š

æ‰€ä»¥è¿™æ˜¯æˆ‘ä»¬è¦åšçš„â€”

ç”¨æˆ·è®¿é—®é¡µé¢çš„æ—¶åˆ»æˆ‘ä»¬æ ‡è®°æ—¶é—´ï¼Œæ¯”å¦‚è¯´ xï¼Œæ¯å½“ç”¨æˆ·ç¦»å¼€é¡µé¢ï¼Œæˆ‘ä»¬æ ‡è®°æ—¶é—´ï¼Œæ¯”å¦‚è¯´ Yï¼Œ
æ‰€ä»¥ï¼ŒèŠ±è´¹çš„æ—¶é—´ç®€å•æ¥è¯´å°±æ˜¯(Y-Z)ç§’ï¼Œæˆ–è€…æ˜¯ï¼Ÿï¼Ÿï¼Ÿ

ç­”æ¡ˆæ˜¯å¦å®šçš„ï¼Œä¸æ˜¯ã€‚å› ä¸ºç”¨æˆ·æ²¡æœ‰å¿…è¦æŠŠæ¯ä¸€ç§’é’Ÿéƒ½èŠ±åœ¨é˜…è¯»æˆ–é˜…è¯»é¡µé¢ä¸Šã€‚

å› æ­¤ï¼Œä¸ºäº†æŠµæ¶ˆè¿™ä¸€ç‚¹ï¼Œæˆ‘ä»¬å°†ä»æ€»æŒç»­æ—¶é—´ä¸­å‡å»ä¸æ´»åŠ¨çš„æ—¶é—´ã€‚

ä¸æ´»è·ƒçš„æ—¶åˆ»å°±åƒç”¨æˆ·åœ¨æ»šåŠ¨ï¼Œæˆ–è€…å·²ç»è¿‡äº† 30 ç§’ï¼Œè€Œç”¨æˆ·ç”šè‡³æ²¡æœ‰ç§»åŠ¨å…‰æ ‡ã€æ»šåŠ¨æˆ–ç‚¹å‡»ã€‚

## 100%ç²¾ç¡®èŠ±è´¹åœ¨é¡µé¢ä¸Šçš„æ—¶é—´

ä¸‹é¢è¿™æ®µä»£ç æ˜¾ç¤ºäº†å¸–å­åœ¨é¡µé¢ä¸ŠèŠ±è´¹çš„ç¡®åˆ‡æ—¶é—´ï¼Œæ²¡æœ‰è€ƒè™‘ä»»ä½•å˜é‡ã€‚

```
document.addEventListener("DOMContentLoaded", () => {
    const start = new Date().getTime(); window.addEventListener("beforeunload", () => {
        const end = new Date().getTime();
        const totalTime = (end - start) / 1000

        console.log(totalTime)
    });});
```

ä½†æ˜¯**é‚£ä¸æ˜¯**ï¼Œæˆ‘ä»¬æƒ³è¦çš„ï¼Œæ˜¯åŸºäºå®é™…ä½¿ç”¨æ¡ˆä¾‹çš„å…·ä½“ä»·å€¼ã€‚

## æ»šåŠ¨èŠ±è´¹çš„æ—¶é—´

æ‰€ä»¥è¿™æ®µä»£ç å°†æœ€ç»ˆæ¶ˆé™¤æ»šåŠ¨é¡µé¢æ‰€èŠ±è´¹çš„æ—¶é—´ï¼Œå› ä¸ºç”¨æˆ·åœ¨æ»šåŠ¨é¡µé¢æ—¶ä¸ä¼šé˜…è¯»æ˜¯éå¸¸åˆç†çš„ã€‚

```
let timeSpentScrolling = 0;window.addEventListener('scroll', () => {
    timeSpentScrolling += 1.8;
});
```

è¿™ä¸ª**å€¼â€œ1.8â€**æ˜¯ç»è¿‡å¤§é‡çš„å‘½ä¸­&è¯•éªŒåŠªåŠ›åå‘ç°çš„ğŸ˜…ã€‚è¯·æ¬£èµæˆ‘çš„åŠªåŠ›ï¼Œä¸ºè¿™ç¯‡æ–‡ç« é¼“æŒã€‚è°¢äº†ã€‚

æ³¨æ„:ä¸è¦å¿˜è®°æ›´æ–°æ€»æ—¶é—´`const totalTime = ((end - start) / 1000) - (timeSpentScrolling / 1000)`

## å¤„äºæš‚åœçŠ¶æ€çš„æ—¶é—´

è¿™æ˜¯æ‰€æœ‰æ¡ˆä¾‹ä¸­æœ€é‡è¦çš„ä¸€ä¸ªã€‚å¦‚æœç”¨æˆ·ç«™èµ·æ¥èµ°å¼€å»æ’’å°¿æ€ä¹ˆåŠã€‚æˆ‘ä»¬çš„ JavaScript ä¼šè®¤ä¸ºä»–åœ¨å¿™ç€ä½¿ç”¨é¡µé¢ï¼Œè€Œç”¨æˆ·å´åœ¨äº«å—æ’’å°¿çš„ä¹è¶£ã€‚

ä¸ºäº†é¿å…è¿™äº›æƒ…å†µï¼Œæˆ‘ä»¬å°†æš‚æ—¶åœæ­¢æ—¶é—´å¢é‡ã€‚
æˆ‘ä»¬å¯ä»¥åˆ›å»ºä¸€ä¸ªåä¸º`haltedStartTime`ã€`haltEndTime`å’Œ`isHalted`çš„æ–°å˜é‡ã€‚

åœ¨åšäº†ä¸€ä¸ªå°è°ƒæŸ¥åï¼Œå‘ç°æ™®é€šç”¨æˆ·æ¯ 39 ç§’å°±ä¼šåœ¨**åæ»šåŠ¨ä¸€æ¬¡é¡µé¢ã€‚**(ä¿æŒ **200 å­—/åˆ†é’Ÿ**é˜…è¯»é€Ÿåº¦åœ¨ä¼°ç®—ä¸­)

å› æ­¤ï¼Œå¦‚æœå·²ç»è¿‡äº† 39 ç§’ï¼Œè€Œç”¨æˆ·è¿˜æ²¡æœ‰æ»šåŠ¨é¡µé¢ï¼Œè¿™åªèƒ½è¯´æ˜ä»¥ä¸‹æƒ…å†µä¹‹ä¸€:

*   ä»–/å¥¹ä¸åœ¨é‚£é‡Œ
*   ä»–/å¥¹èŠ±åœ¨ç†è§£å†…å®¹ä¸Šçš„æ—¶é—´è¶…è¿‡äº†è¦æ±‚
*   ä»–/å¥¹å¾ˆæ…¢

åœ¨ä»»ä½•ä¸€ç§æƒ…å†µä¸‹ï¼Œè®¡æ—¶å™¨åº”åœæ­¢è®¡æ—¶ã€‚

```
...let isHalted = false;
let haltedStartTime, haltedEndTime;
let totalHaltedTime = 0;const update_halt_state = () => {
    if (isHalted) {
	isHalted = false;
        haltedEndTime = new Date().getTime()
        totalHaltedTime += (haltedEndTime - haltedStartTime) / 1000
    } else {
        isHalted = true;
        haltedStartTime = new Date().getTime()
    }
}window.addEventListener('scroll', () => {
    ...
    update_halt_state()
});document.addEventListener("DOMContentLoaded", () => {
    ...
    setInterval(() => {
	if (new Date().getTime() - start > 39000) {
	    update_halt_state()
	}
    }, 39000) ...
});
```

æ³¨æ„:å†æ¬¡æé†’ï¼Œä¸è¦å¿˜è®°æ›´æ–°æ€»æ—¶é—´
`const totalTime = ((end - start) / 1000) - (timeSpentScrolling / 1000) - totalHaltedTime`

## ä½¿ç”¨ä¿¡æ ‡ API â€”å°†æ•°æ®å‘é€åˆ°åç«¯

```
window.addEventListener("beforeunload", () => {
    ...
    const totalTime = ((end - start) / 1000) - (timeSpentScrolling / 1000) - totalHaltedTime navigator.sendBeacon("https://topapi2.free.beeceptor.com", {"totalTime":totalTime})
});
```

ç»è¿‡ä¸€å †éº»çƒ¦ä¹‹åï¼Œæˆ‘å‘ç°äº†è¿™ä¸ªå†…ç½®çš„ JavaScriptï¼Œå®ƒè¢«ç”¨æ¥å‘æœåŠ¡å™¨å‘é€å°æ•°æ®ï¼Œç”šè‡³åœ¨é¡µé¢è¢«ç»ˆæ­¢ä¹‹åã€‚

ç°åœ¨æœ‰äººå¯èƒ½ä¼šé—®ï¼Œâ€œä¸ºä»€ä¹ˆæˆ‘ä»¬ä¸æ€»æ˜¯ä½¿ç”¨`navigator.sendBeacon()`è€Œä¸æ˜¯`fetch()`ï¼Ÿâ€ã€‚
ç­”æ¡ˆæ˜¯æ•°æ®çš„å¤§å°ï¼Œæˆ‘ä»¬åªèƒ½é€šè¿‡*å‘é€ **64KB** çš„æœ‰æ•ˆè½½è·ã€‚sendBeacon()*

# å®é™…å®ç°çš„ä»£ç 

å¦‚æœæ‚¨ä¸ç†è§£ä»£ç éƒ¨åˆ†(è¿™æ˜¯éå¸¸å¯èƒ½çš„)ï¼Œè¿™é‡Œæ˜¯å®Œæ•´çš„ä»£ç 

> å¦‚æœä½ è§‰å¾—è¿™æœ‰å¸®åŠ©ï¼Œè¯·é¼“æŒã€‚
> 
> æˆ‘ä¹Ÿå¾ˆæ„Ÿæ¿€æœ‰äººè·Ÿè¸ªæˆ‘ğŸ˜Šã€‚
> 
> è¯·åœ¨ Instagram å’Œ LinkedIn ä¸Šä¸æˆ‘è”ç³»ï¼Œæˆ‘ä»¬å°†æœ‰ä¸€æ¬¡èŠå¤©ã€‚
> 
> insta gram/Twitterâ€”@ mrvaibh 0
> LinkedInâ€”@ mrvaibh

*æ›´å¤šå†…å®¹è¯·çœ‹*[***plain English . io***](https://plainenglish.io/)*ã€‚æŠ¥åå‚åŠ æˆ‘ä»¬çš„* [***å…è´¹å‘¨æŠ¥***](http://newsletter.plainenglish.io/) *ã€‚å…³æ³¨æˆ‘ä»¬å…³äº*[***Twitter***](https://twitter.com/inPlainEngHQ)*å’Œ*[***LinkedIn***](https://www.linkedin.com/company/inplainenglish/)*ã€‚åŠ å…¥æˆ‘ä»¬çš„* [***ç¤¾åŒºä¸å’Œè°***](https://discord.gg/GtDtUAvyhW) *ã€‚*