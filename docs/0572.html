<html>
<head>
<title>How to Build a Multi-Tenant App with Vercel’s Next.js Middleware</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何用Vercel的Next.js中间件构建多租户App</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/how-to-build-a-multi-tenant-app-with-vercels-next-js-middleware-eeb02e08d41d?source=collection_archive---------4-----------------------#2022-02-01">https://javascript.plainenglish.io/how-to-build-a-multi-tenant-app-with-vercels-next-js-middleware-eeb02e08d41d?source=collection_archive---------4-----------------------#2022-02-01</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="e58b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">好吧，这是一项非常酷的技术，几乎有无限的可能性。最近，我使用Next.js中间件提前接触到了Vercel的多租户技术，我被其易用性惊呆了。</p><p id="2eab" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在不到15分钟的时间里，我就能够将示例存储库转换成能够为我正在构建的项目增加显著商业价值的东西。<br/>今天，我将向您展示如何做到这一点！</p><p id="312e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">但是首先，让我快速解释一下我所说的中间件和多租户是什么意思！</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi kl"><img src="../Images/6b0cb0d4b4d7f435944e5eec4b8db8f2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*ktxcu0z2KpRqFlEW.jpeg"/></div></div></figure><h1 id="f8ef" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">什么是中间件？🧐</h1><p id="5ffc" class="pw-post-body-paragraph jn jo iq jp b jq lv js jt ju lw jw jx jy lx ka kb kc ly ke kf kg lz ki kj kk ij bi translated">中间件是一个在请求被传递到你的应用程序之前运行的功能。在中间件功能内部，您可以执行逻辑并实际更改请求。改变请求正是我们将用来创建多租户系统的技术！</p><p id="4e09" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">看看<a class="ae ma" href="https://vercel.com/docs/concepts/functions/edge-functions#middleware-use-cases" rel="noopener ugc nofollow" target="_blank"> Vercel的文档</a>中可能的用例。</p><h1 id="9dd2" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">什么是多租户应用程序？🤔</h1><p id="802d" class="pw-post-body-paragraph jn jo iq jp b jq lv js jt ju lw jw jx jy lx ka kb kc ly ke kf kg lz ki kj kk ij bi translated">多租户应用程序是一项非常酷的技术，它允许您从不同的(子)域运行应用程序，并根据所使用的域显示不同的内容。</p><p id="c2f3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果你还不相信它超级酷，看看你现在使用的平台吧！是的，没错。Medium实际上使用了这项技术，今天您将学习如何做同样的事情。</p><h2 id="4ddc" class="mb ky iq bd kz mc md dn ld me mf dp lh jy mg mh ll kc mi mj lp kg mk ml lt mm bi translated">多租户应用程序的一些示例</h2><ul class=""><li id="3b3a" class="mn mo iq jp b jq lv ju lw jy mp kc mq kg mr kk ms mt mu mv bi translated">一个类似博客的媒介，每个人都有自己的子域</li><li id="be67" class="mn mo iq jp b jq mw ju mx jy my kc mz kg na kk ms mt mu mv bi translated">像Gumroad或Redbubble这样的电子商务商店</li><li id="e014" class="mn mo iq jp b jq mw ju mx jy my kc mz kg na kk ms mt mu mv bi translated">任何你能想象到的💭</li></ul><p id="5abb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我向您展示如何构建相同的内容！</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi nb"><img src="../Images/b6e22721848f3aa487af5a323c885cc0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*PJBXINohuERO6DpC.png"/></div></div><figcaption class="nc nd gj gh gi ne nf bd b be z dk">A graphic explaining multi-tenancy</figcaption></figure><h1 id="9eab" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">入门指南🎬</h1><p id="0756" class="pw-post-body-paragraph jn jo iq jp b jq lv js jt ju lw jw jx jy lx ka kb kc ly ke kf kg lz ki kj kk ij bi translated">我们需要做的第一件事是创建一个新的Next.js应用程序。</p><p id="d062" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">为此，请在终端中运行以下命令:</p><pre class="km kn ko kp gt ng nh ni nj aw nk bi"><span id="b499" class="mb ky iq nh b gy nl nm l nn no">yarn create next-app</span></pre><p id="eb56" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">按照设置，当它完成后，你就可以开始了！</p><p id="f703" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">对于那些想要在他们现有的Next.js应用中实现这一点的人来说，这只是一个快速的提醒。中间件只从Next.js 12开始提供。</p><h1 id="966d" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">设置我们的中间件</h1><p id="305d" class="pw-post-body-paragraph jn jo iq jp b jq lv js jt ju lw jw jx jy lx ka kb kc ly ke kf kg lz ki kj kk ij bi translated">我们需要做的第一件事是创建我们的中间件。<br/>要在Next.js中创建一个新的中间件函数，您需要做的就是在pages目录中添加一个名为<code class="fe np nq nr nh b">_middleware.js</code>的新文件。</p><p id="b0bf" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">创建该文件后，向其中添加以下内容。</p><p id="2387" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我没有一步一步地解释，而是决定在Vercel已经给我的评论的基础上添加大量的评论来解释正在发生的事情！</p><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="ns nt l"/></div></figure><p id="f2e4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这个中间件功能的作用是解析用于调用应用程序的子域，并将主机名重写为<code class="fe np nq nr nh b">_sites</code>路由的参数。</p><p id="8371" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在剩下要做就是创建<code class="fe np nq nr nh b">_sites</code>路由并检索主机名！</p><h1 id="4325" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">正在检索主机名</h1><p id="453a" class="pw-post-body-paragraph jn jo iq jp b jq lv js jt ju lw jw jx jy lx ka kb kc ly ke kf kg lz ki kj kk ij bi translated">让我们创建解析主机名所需的路由！</p><p id="fe24" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">请遵循以下步骤:</p><ul class=""><li id="cded" class="mn mo iq jp b jq jr ju jv jy nu kc nv kg nw kk ms mt mu mv bi translated">在pages文件夹中创建一个新文件夹<code class="fe np nq nr nh b">_sites</code></li><li id="0676" class="mn mo iq jp b jq mw ju mx jy my kc mz kg na kk ms mt mu mv bi translated">在<code class="fe np nq nr nh b">_sites</code>文件夹中，创建另一个名为<code class="fe np nq nr nh b">[site]</code>的文件夹</li><li id="61f6" class="mn mo iq jp b jq mw ju mx jy my kc mz kg na kk ms mt mu mv bi translated">在<code class="fe np nq nr nh b">[site]</code>文件夹中，创建一个名为<code class="fe np nq nr nh b">index.js</code>的文件</li></ul><p id="3c1c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这就是你完成所有设置后pages文件夹的样子！</p><pre class="km kn ko kp gt ng nh ni nj aw nk bi"><span id="29d6" class="mb ky iq nh b gy nl nm l nn no">pages              <br/>├─ _sites          <br/>│  └─ [site]       <br/>│     └─ index.js  <br/>├─ _app.js         <br/>├─ _middleware.js  <br/>└─ index.js</span></pre><h2 id="7b5f" class="mb ky iq bd kz mc md dn ld me mf dp lh jy mg mh ll kc mi mj lp kg mk ml lt mm bi translated">获取所有路径</h2><p id="159a" class="pw-post-body-paragraph jn jo iq jp b jq lv js jt ju lw jw jx jy lx ka kb kc ly ke kf kg lz ki kj kk ij bi translated">我们需要做的第一件事是让Next.js知道所有可能的路径是什么。为此，我们将使用方便的<code class="fe np nq nr nh b">getStaticPaths</code>函数。在我的例子中，我们将使用一个模拟设置，但是您可以很容易地将它连接到您自己的API上！</p><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="ns nt l"/></div></figure><h2 id="d97b" class="mb ky iq bd kz mc md dn ld me mf dp lh jy mg mh ll kc mi mj lp kg mk ml lt mm bi translated">获取数据</h2><p id="64e0" class="pw-post-body-paragraph jn jo iq jp b jq lv js jt ju lw jw jx jy lx ka kb kc ly ke kf kg lz ki kj kk ij bi translated">在我们检索了所有的路由之后，是时候根据正在使用的子域获取正确的数据了。</p><p id="1bd7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">为了实现这一点，我们将使用服务器端渲染的强大功能。</p><p id="9ffb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">创建一个新的<code class="fe np nq nr nh b">getStaticProps</code>函数，从上下文中读取<code class="fe np nq nr nh b">site</code>参数，您就可以开始了！</p><p id="6953" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">该函数看起来会像这样:</p><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="ns nt l"/></div></figure><p id="5da5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">就像我们的<code class="fe np nq nr nh b">getStaticPaths</code>函数一样，我们使用的是我们数据的模拟，但是你可以很容易地调用你的API并返回正确的数据。</p><h2 id="279c" class="mb ky iq bd kz mc md dn ld me mf dp lh jy mg mh ll kc mi mj lp kg mk ml lt mm bi translated">创建组件</h2><p id="b469" class="pw-post-body-paragraph jn jo iq jp b jq lv js jt ju lw jw jx jy lx ka kb kc ly ke kf kg lz ki kj kk ij bi translated">关于<code class="fe np nq nr nh b">getStaticProps</code>的美妙之处在于，我们获取的项目现在可以作为我们组件中的常规道具使用了。不需要<code class="fe np nq nr nh b">await</code>它或用钩子找到它。所有这些都是服务器端渲染的。</p><p id="6630" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们最基本的组件如下所示:</p><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="ns nt l"/></div></figure><h2 id="acd5" class="mb ky iq bd kz mc md dn ld me mf dp lh jy mg mh ll kc mi mj lp kg mk ml lt mm bi translated">整个组件</h2><p id="1721" class="pw-post-body-paragraph jn jo iq jp b jq lv js jt ju lw jw jx jy lx ka kb kc ly ke kf kg lz ki kj kk ij bi translated">如果一切顺利，那么您的整个组件应该看起来像这样。你准备好测试它了吗？</p><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="ns nt l"/></div></figure><h1 id="fb24" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">测试它</h1><p id="ee2b" class="pw-post-body-paragraph jn jo iq jp b jq lv js jt ju lw jw jx jy lx ka kb kc ly ke kf kg lz ki kj kk ij bi translated">用<code class="fe np nq nr nh b">yarn dev</code>启动你的开发服务器，打开你最喜欢的浏览器。</p><p id="13b6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在剩下要做的就是浏览两个子域名中的一个。您可以选择<code class="fe np nq nr nh b"><a class="ae ma" href="http://test.localhost:3000" rel="noopener ugc nofollow" target="_blank">http://test.localhost:3000</a></code>或<code class="fe np nq nr nh b"><a class="ae ma" href="http://test2.localhost:3000." rel="noopener ugc nofollow" target="_blank">http://test2.localhost:3000</a></code>或<a class="ae ma" href="http://test2.localhost:3000." rel="noopener ugc nofollow" target="_blank">。根据您选择的不同，您将看到不同的输出！</a></p><p id="f277" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">很漂亮吧？🥳</p><h2 id="8f41" class="mb ky iq bd kz mc md dn ld me mf dp lh jy mg mh ll kc mi mj lp kg mk ml lt mm bi translated">小小的改进</h2><p id="9394" class="pw-post-body-paragraph jn jo iq jp b jq lv js jt ju lw jw jx jy lx ka kb kc ly ke kf kg lz ki kj kk ij bi translated">在我们当前的例子中，对于未知的域没有回退。</p><p id="8b46" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">当有人试图访问未知的子域时，你的应用程序会崩溃，但幸运的是，我们可以很容易地解决这个问题！</p><p id="4a76" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">用这个快速检查更改您的<code class="fe np nq nr nh b">getStaticProps</code>功能，您就一切就绪了！</p><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="ns nt l"/></div></figure><p id="4599" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">当有人试图访问一个未知的URL时，我们会自动向他们显示内置的404页Next.js。</p><h2 id="ecaf" class="mb ky iq bd kz mc md dn ld me mf dp lh jy mg mh ll kc mi mj lp kg mk ml lt mm bi translated">添加额外页面</h2><p id="7962" class="pw-post-body-paragraph jn jo iq jp b jq lv js jt ju lw jw jx jy lx ka kb kc ly ke kf kg lz ki kj kk ij bi translated">如果您正在使用这种技术构建一个实际的应用程序，您可能希望向平台添加额外的页面。不要担心，这是超级容易做到的！<br/>在这个<code class="fe np nq nr nh b">[site]</code>文件夹中，您可以使用常规的Next.js基于页面的路由！你在那里添加的任何文件都会自动成为平台上的新页面。</p><p id="7e85" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这就是关于Next.js多租户设置的所有信息。是时候发挥创造力，建立自己的项目了。</p></div><div class="ab cl nx ny hu nz" role="separator"><span class="oa bw bk ob oc od"/><span class="oa bw bk ob oc od"/><span class="oa bw bk ob oc"/></div><div class="ij ik il im in"><p id="dc15" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">祝你有美好的一天💙</p><p id="5ee4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="oe">更多内容看</em> <a class="ae ma" href="http://plainenglish.io/" rel="noopener ugc nofollow" target="_blank"> <strong class="jp ir"> <em class="oe">说白了。报名参加我们的</em> <a class="ae ma" href="http://newsletter.plainenglish.io/" rel="noopener ugc nofollow" target="_blank"> <strong class="jp ir"> <em class="oe">免费周报</em> </strong> </a> <em class="oe">。在我们的</em> <a class="ae ma" href="https://discord.gg/GtDtUAvyhW" rel="noopener ugc nofollow" target="_blank"> <strong class="jp ir"> <em class="oe">社区获得独家访问写作机会和建议</em> </strong> </a> <em class="oe">。</em></strong></a></p></div></div>    
</body>
</html>