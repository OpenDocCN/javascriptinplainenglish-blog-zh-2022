<html>
<head>
<title>React Native: Fix For Flickering Field Formatting</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">反应原生:修复闪烁字段格式</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/react-native-finding-a-fix-for-flickering-field-formatting-dc1923e97cc?source=collection_archive---------3-----------------------#2022-07-15">https://javascript.plainenglish.io/react-native-finding-a-fix-for-flickering-field-formatting-dc1923e97cc?source=collection_archive---------3-----------------------#2022-07-15</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="bf37" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">在React Native中对TextField输入应用动态格式会触发难看的闪烁——以下是解决方法。</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/e7345831e6577dacee091ad3a6769717.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*m9-u9ErDUzTt41uK"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk">Photo by <a class="ae kv" href="https://unsplash.com/@zvessels55?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Zach Vessels</a> on <a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><h1 id="e301" class="kw kx iq bd ky kz la lb lc ld le lf lg jw lh jx li jz lj ka lk kc ll kd lm ln bi translated">场景</h1><p id="b98e" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">我们试图做的是<strong class="lq ir">构建一个TextField，它可以对用户输入应用某种格式或其他限制</strong>。</p><p id="a5b5" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">一个非常常见的用例是格式化货币金额:如果我的应用程序要显示一个美元值作为用户输入，我可能希望输入“1–0–9–9”，并让我的输入显示“$10.99”。如果用户输入一个非数字字符，我希望这个击键被忽略。同样，如果用户试图添加第三个小数位。无论输入什么，您都希望文本被格式化为美元和美分的货币值。</p><p id="93a6" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">另一个用例可能是限制输入，只允许某些字符。假设我们希望用户为用户名提供一个只包含字母数字字符的字符串:如果用户键入“joe_bob19！!"，我们的输入应该会自动将输入限制为“joebob19”。任何其他字符都应该被自动剔除。</p><p id="7f81" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">那么我们如何在React Native中实现这个用例呢？让我们尝试几种方法，看看它们是如何工作的。</p><h1 id="6550" class="kw kx iq bd ky kz la lb lc ld le lf lg jw lh jx li jz lj ka lk kc ll kd lm ln bi translated">最初的尝试</h1><p id="6c9a" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">如果您是从零开始处理这个用例，有两种通用的方法可以用来解决这个问题。至少，这些是我在找到解决方案之前尝试过的想法。</p><p id="948b" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated"><strong class="lq ir">方法#1 </strong>:实现一个<strong class="lq ir"> onChange </strong>处理程序来格式化或处理用户输入，并改变传回到<strong class="lq ir"> TextInput </strong>中的值。它看起来大概是这样的:</p><p id="dc68" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated"><code class="fe mp mq mr ms b">&lt;TextInput value={name} onChange={value =&gt; setName(format(value))} /&gt;</code></p><p id="ff23" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">这种方法将允许您获取完整的用户输入字符串，对其进行处理以格式化或过滤掉不需要的字符，然后在<strong class="lq ir"> TextInput </strong>上将它重新设置。这里没有显示完整的代码，但是我们显然使用了某种状态管理，比如用<code class="fe mp mq mr ms b">React.useState</code>表示<code class="fe mp mq mr ms b">name</code>和<code class="fe mp mq mr ms b">setName</code>，我们还有一些<code class="fe mp mq mr ms b">process</code>函数，它可以接受任何字符串并返回它的“修正”版本。</p><p id="4823" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated"><strong class="lq ir">方法#2 </strong>:向按键处理程序添加一些逻辑，并尝试拒绝导致不良输入的事件。您可以尝试一个<strong class="lq ir"> onKeyDown </strong>处理程序，并尝试在事件到来时对其进行处理。如果事件导致无效输入，您可以拒绝该事件。</p><p id="ed2d" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">这种方法在使用案例中会有一些限制，因为它不允许您格式化整个字符串，但是它仍然允许您解决“不可用字符”的情况。</p><p id="4885" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">这两种方法在React for web中都是可行的(做了一些小的改动)，但不幸的是，这两种方法都不能在React Native中很好地工作！</p><h1 id="f3e4" class="kw kx iq bd ky kz la lb lc ld le lf lg jw lh jx li jz lj ka lk kc ll kd lm ln bi translated">问题是</h1><p id="fcab" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">这些方法的问题是，因为React Native是，嗯，<em class="mt">原生的</em>，我们最终会与原生文本输入组件发生冲突。在React for web中,“文本输入”实际上是React完全控制的DOM的一部分，这使得上述两种方法都可行。然而，在React Native中，<strong class="lq ir"> TextInput </strong>组件是一个真正的本机组件，它在本机端消耗键盘事件并更新自身，不受React Native的完全控制。只有在组件更新之后<em class="mt">我们的hander代码才会运行。</em></p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi mu"><img src="../Images/d07e635f102baa479c7bf339d3c91ee4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1372/1*iOmgmW_sqoXKn18GfFz3lw.gif"/></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk">Flickering &amp; flashing in a ReactNative TextInput</figcaption></figure><p id="34dd" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">因此，上面的方法#1有点“工作”,但有一个主要的不良视觉副作用:当(不良)输入首先被本机组件立即显示，然后被JavaScript“修复”时，输入值闪烁不定。</p><p id="0fe1" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">方法#2根本不起作用，因为在JS方对发生的事情有发言权之前，事件已经被本地组件使用了。</p><p id="7cd9" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">不幸的是，这种闪烁是React Native 的一个<a class="ae kv" href="https://github.com/facebook/react-native/issues/24585" rel="noopener ugc nofollow" target="_blank">已知问题，这两种提议的方法都不可行。那么我们如何解决这个问题呢？</a></p><h1 id="eee4" class="kw kx iq bd ky kz la lb lc ld le lf lg jw lh jx li jz lj ka lk kc ll kd lm ln bi translated">修复</h1><p id="1194" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">这个问题的解决方案并不明显，但是相当简单。我们将使用两个，而不是使用一个<strong class="lq ir">文本字段！第一个将是“input”<strong class="lq ir">文本字段</strong>，它将接受用户输入<em class="mt">，但不会显示。</em>第二个将是我们的“显示”<strong class="lq ir">文本字段</strong>，它将显示<em class="mt">但不接受用户输入</em>。</strong></p><p id="a8ce" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">通过将显示字段精确地放在输入字段的上面，我们甚至可以保持正确的光标显示。最终结果如下所示:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi mu"><img src="../Images/fe13a353df8648552692e8997406ae5f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1372/1*HhzkzxmhLSX7JsldOktKhw.gif"/></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk">The fixed TextField inputs</figcaption></figure><p id="9a64" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">如果你仔细观察上面的动画，你会发现当用户输入被格式化时，你会看到一个<em class="mt">微小的</em>光标移动。我认为这是一个可以接受的折衷，但是如果你不喜欢，你可以移除光标或者实现你自己的光标行为。</p><p id="17e0" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">关于这种方法的实现有几点注意事项:</p><ul class=""><li id="4d98" class="mv mw iq lq b lr mk lu ml lx mx mb my mf mz mj na nb nc nd bi translated">显示字段是关于定位的“主”文本字段——使用<strong class="lq ir"> onLayout </strong>处理程序获取其位置，然后相应地绝对定位输入文本字段，以获得正确的光标行为</li><li id="88d2" class="mv mw iq lq b lr ne lu nf lx ng mb nh mf ni mj na nb nc nd bi translated">如果你把显示文本域直接放在另一个之上，你还需要在显示域上添加<strong class="lq ir"> pointerEvents="none" </strong>来允许用户与底层输入交互。</li><li id="e430" class="mv mw iq lq b lr ne lu nf lx ng mb nh mf ni mj na nb nc nd bi translated">你应该用<strong class="lq ir">颜色:“透明”</strong>使输入文本字段“隐藏”，而不是像<strong class="lq ir">不透明度:0 </strong>那样的另一种方法，因为这将使文本不可见，但仍会显示光标。</li></ul><h1 id="e8da" class="kw kx iq bd ky kz la lb lc ld le lf lg jw lh jx li jz lj ka lk kc ll kd lm ln bi translated">结论</h1><p id="b37b" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">React Native是跨平台应用程序开发的一个很好的框架，但是“JavaScript加Native”的方法有时会导致棘手(并且令人讨厌)的情况，就像本文中描述的那样。不过，只要有点创造力，我们通常可以找到这些问题的解决方案，并继续做重要的事情。</p><p id="c141" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated"><a class="ae kv" href="http://medium.com/@jonnystartup" rel="noopener"> <em class="mt"> Jonathan </em> </a> <em class="mt">在创业公司大&amp;小有超过20年的工程领导经验。在业余时间，他在做一个文档自动化平台，</em><a class="ae kv" href="http://imagepipe.co/" rel="noopener ugc nofollow" target="_blank"><em class="mt">【Imagepipe.co】</em></a><em class="mt">。</em></p><p id="0576" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated"><em class="mt">更多内容请看</em> <a class="ae kv" href="https://plainenglish.io/" rel="noopener ugc nofollow" target="_blank"> <strong class="lq ir"> <em class="mt">说白了就是</em> </strong> </a> <em class="mt">。报名参加我们的</em> <a class="ae kv" href="http://newsletter.plainenglish.io/" rel="noopener ugc nofollow" target="_blank"> <strong class="lq ir"> <em class="mt">免费每周简讯</em> </strong> </a> <em class="mt">。关注我们</em> <a class="ae kv" href="https://twitter.com/inPlainEngHQ" rel="noopener ugc nofollow" target="_blank"> <strong class="lq ir"> <em class="mt">推特</em></strong></a><strong class="lq ir"><em class="mt"/></strong><em class="mt">和</em><a class="ae kv" href="https://www.linkedin.com/company/inplainenglish/" rel="noopener ugc nofollow" target="_blank"><strong class="lq ir"><em class="mt">LinkedIn</em></strong></a><em class="mt">。查看我们的</em> <a class="ae kv" href="https://discord.gg/GtDtUAvyhW" rel="noopener ugc nofollow" target="_blank"> <strong class="lq ir"> <em class="mt">社区不和谐</em> </strong> </a> <em class="mt">加入我们的</em> <a class="ae kv" href="https://inplainenglish.pallet.com/talent/welcome" rel="noopener ugc nofollow" target="_blank"> <strong class="lq ir"> <em class="mt">人才集体</em> </strong> </a> <em class="mt">。</em></p></div></div>    
</body>
</html>