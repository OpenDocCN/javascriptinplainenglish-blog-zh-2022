<html>
<head>
<title>Avoid Memory Leaks and Improve Performance with Cleanup Functions in React’s useEffect Hook</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用React的useEffect挂钩中的清理功能避免内存泄漏并提高性能</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/why-should-you-use-cleanup-functions-in-reacts-useeffect-hook-bdff48bd9b3?source=collection_archive---------5-----------------------#2022-07-07">https://javascript.plainenglish.io/why-should-you-use-cleanup-functions-in-reacts-useeffect-hook-bdff48bd9b3?source=collection_archive---------5-----------------------#2022-07-07</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="0e0a" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">副作用——用例子解释。</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi kf"><img src="../Images/0c6379d68a7892c47bd34657185021ca.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*hhvhUVTLTOYeJSD7"/></div><figcaption class="kn ko gj gh gi kp kq bd b be z dk">Photo by <a class="ae kr" href="https://unsplash.com/@towfiqu999999?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Towfiqu barbhuiya</a> on <a class="ae kr" href="https://unsplash.com/?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="2032" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">如果您刚开始学习React或者已经有一段时间在使用这个库，那么您肯定会遇到一些与异步函数相关的错误或警告，尤其是在使用钩子<code class="fe lo lp lq lr b">useEffect</code>的时候。</p><p id="5bb2" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">当我学习这个钩子的功能时，我不明白为什么要在这个函数中使用return，因为在大多数情况下没有必要使用它，React没有它也能很好地工作。</p><p id="d280" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">随着我越来越熟悉React的工作方式和组件的生命周期，我开始注意到，在很多情况下，在钩子<code class="fe lo lp lq lr b">useEffect</code>中使用return太重要了，尤其是在副作用方面。</p><h1 id="69e2" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">有什么副作用？</h1><p id="fcef" class="pw-post-body-paragraph ks kt iq ku b kv mk jr kx ky ml ju la lb mm ld le lf mn lh li lj mo ll lm ln ij bi translated">副作用可能是从远程服务器获取数据、读写本地存储、设置事件侦听器或设置订阅。当单击按钮、提交表单或安装和卸载组件时，会出现这些副作用。</p><p id="a88d" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">React的<code class="fe lo lp lq lr b"><a class="ae kr" href="https://reactjs.org/docs/hooks-reference.html#useeffect" rel="noopener ugc nofollow" target="_blank">useEffect</a></code>钩子允许功能组件在一个组件被挂载或者一些属性或状态改变时做一些事情。这个钩子还允许在组件被卸载时进行清理。</p><h1 id="f08b" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">为什么要清理副作用？</h1><p id="896c" class="pw-post-body-paragraph ks kt iq ku b kv mk jr kx ky ml ju la lb mm ld le lf mn lh li lj mo ll lm ln ij bi translated">在React中处理副作用是一项中等复杂程度的任务。但是，有时您可能会在组件生命周期(初始渲染、组装、使用、拆卸)和副作用生命周期(开始、进行中、完成)的交叉点遇到困难。</p><p id="f0ee" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">其中一个困难是当副作用完成并试图更新已经分解的组件的状态时。</p><p id="7ef0" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">这将导致如下反应警告:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi kf"><img src="../Images/63d2ce3d162f126072e19b64b1ed63b8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*P-Zbol9-DqqCCovT"/></div></figure><p id="9758" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">React应用程序中的内存泄漏主要是由于在卸载组件之前没有取消组件安装时所做的订阅。</p><p id="cfb5" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">它们会导致许多问题，包括:</p><ul class=""><li id="6767" class="mp mq iq ku b kv kw ky kz lb mr lf ms lj mt ln mu mv mw mx bi translated">通过减少可用内存量来影响项目的性能。</li><li id="c659" class="mp mq iq ku b kv my ky mz lb na lf nb lj nc ln mu mv mw mx bi translated">降低了应用程序的速度。</li><li id="fb3b" class="mp mq iq ku b kv my ky mz lb na lf nb lj nc ln mu mv mw mx bi translated">系统崩溃。</li></ul><p id="764f" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">因此，有必要消除内存泄漏问题。</p><h1 id="e77e" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">什么是useEffect清理功能？</h1><p id="b4df" class="pw-post-body-paragraph ks kt iq ku b kv mk jr kx ky ml ju la lb mm ld le lf mn lh li lj mo ll lm ln ij bi translated">这是<code class="fe lo lp lq lr b">useEffect</code>钩子的一个功能，它允许我们在卸载组件之前停止不再需要执行的副作用。</p><p id="eff7" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated"><code class="fe lo lp lq lr b">useEffect</code>是以这样一种方式构建的，我们可以在它里面返回一个函数，这个返回函数就是清理发生的地方。</p><p id="ae70" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">例如，组件A请求API获取产品列表，但是在发出异步请求时，组件A被从DOM中移除(它是卸载的)。不需要完成那个异步请求。</p><p id="8d0c" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">因此，作为一种改进应用程序的清理方法，您可以清理(取消)异步请求，使其不完成。</p><p id="d5e1" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated"><a class="ae kr" href="https://reactjs.org/docs/hooks-effect.html#effects-without-cleanup" rel="noopener ugc nofollow" target="_blank"/><code class="fe lo lp lq lr b"><a class="ae kr" href="https://reactjs.org/docs/hooks-effect.html#effects-without-cleanup" rel="noopener ugc nofollow" target="_blank">useEffect</a></code>的清理功能:</p><pre class="kg kh ki kj gt nd lr ne nf aw ng bi"><span id="93ae" class="nh lt iq lr b gy ni nj l nk nl">useEffect(() =&gt; {<br/>  // Your effect<br/>  return () =&gt; {<br/>    // Cleanup<br/>  }<br/>}, [input])</span></pre><h1 id="e09e" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">清理效果</h1><h2 id="743f" class="nh lt iq bd lu nm nn dn ly no np dp mc lb nq nr me lf ns nt mg lj nu nv mi nw bi translated">取消提取请求</h2><p id="5285" class="pw-post-body-paragraph ks kt iq ku b kv mk jr kx ky ml ju la lb mm ld le lf mn lh li lj mo ll lm ln ij bi translated">取消fetch请求调用有不同的方法，我们可以使用fetch <code class="fe lo lp lq lr b"><a class="ae kr" href="https://javascript.info/fetch-abort#:~:text=To%20be%20able%20to%20cancel,how%20to%20work%20with%20AbortController%20." rel="noopener ugc nofollow" target="_blank">AbortController</a></code>或者Axios <code class="fe lo lp lq lr b"><a class="ae kr" href="https://axios-http.com/docs/cancellation" rel="noopener ugc nofollow" target="_blank">AbortController</a>.</code></p><p id="8701" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">要使用<code class="fe lo lp lq lr b">AbortController</code>，我们必须使用<code class="fe lo lp lq lr b">AbortController()</code>构造函数创建一个控制器。然后，当我们的获取请求启动时，我们将<code class="fe lo lp lq lr b">AbortSignal</code>作为请求的<code class="fe lo lp lq lr b">options</code>对象中的一个选项进行传递。</p><p id="60e1" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">这将控制器和信号与获取请求相关联，并允许我们随时使用<code class="fe lo lp lq lr b">AbortController.abort()</code>取消它:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nx ny l"/></div><figcaption class="kn ko gj gh gi kp kq bd b be z dk">Fetch: Abort</figcaption></figure><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nx ny l"/></div><figcaption class="kn ko gj gh gi kp kq bd b be z dk">Axios: Abort</figcaption></figure><h2 id="1ad5" class="nh lt iq bd lu nm nn dn ly no np dp mc lb nq nr me lf ns nt mg lj nu nv mi nw bi translated">清除超时</h2><p id="041d" class="pw-post-body-paragraph ks kt iq ku b kv mk jr kx ky ml ju la lb mm ld le lf mn lh li lj mo ll lm ln ij bi translated">当使用<code class="fe lo lp lq lr b"><a class="ae kr" href="https://developer.mozilla.org/en-US/docs/Web/API/setTimeout" rel="noopener ugc nofollow" target="_blank">setTimeout</a>(callback, time)</code>定时器函数时，我们可以通过使用特殊的<code class="fe lo lp lq lr b">clearTimeout(timerId)</code>函数在卸载时清除它们。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nx ny l"/></div><figcaption class="kn ko gj gh gi kp kq bd b be z dk">Cleaning up Timeouts</figcaption></figure><h2 id="dad0" class="nh lt iq bd lu nm nn dn ly no np dp mc lb nq nr me lf ns nt mg lj nu nv mi nw bi translated">清理间隔</h2><p id="4156" class="pw-post-body-paragraph ks kt iq ku b kv mk jr kx ky ml ju la lb mm ld le lf mn lh li lj mo ll lm ln ij bi translated">像超时一样，<code class="fe lo lp lq lr b"><a class="ae kr" href="https://developer.mozilla.org/en-US/docs/Web/API/setInterval" rel="noopener ugc nofollow" target="_blank">setIntervals</a>(callback, time)</code>有一个特殊的功能，用<code class="fe lo lp lq lr b">clearInterval(intervalId)</code>函数来清除它们。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nx ny l"/></div><figcaption class="kn ko gj gh gi kp kq bd b be z dk">Cleaning up Intervals</figcaption></figure><h2 id="ec80" class="nh lt iq bd lu nm nn dn ly no np dp mc lb nq nr me lf ns nt mg lj nu nv mi nw bi translated">清理事件侦听器</h2><p id="4db2" class="pw-post-body-paragraph ks kt iq ku b kv mk jr kx ky ml ju la lb mm ld le lf mn lh li lj mo ll lm ln ij bi translated">清理监听器通过<code class="fe lo lp lq lr b"><a class="ae kr" href="https://developer.mozilla.org/es/docs/Web/API/EventTarget/removeEventListener" rel="noopener ugc nofollow" target="_blank">window.removeEventListener</a></code>进行。<code class="fe lo lp lq lr b">removeEventListener</code>调用必须引用<code class="fe lo lp lq lr b">removeEventListener</code>调用中的<em class="nz">相同的</em>函数，以正确移除监听器。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nx ny l"/></div><figcaption class="kn ko gj gh gi kp kq bd b be z dk">Cleaning up Event Listeners</figcaption></figure><h2 id="6cc9" class="nh lt iq bd lu nm nn dn ly no np dp mc lb nq nr me lf ns nt mg lj nu nv mi nw bi translated">清理Web套接字</h2><p id="bd5e" class="pw-post-body-paragraph ks kt iq ku b kv mk jr kx ky ml ju la lb mm ld le lf mn lh li lj mo ll lm ln ij bi translated">当你创建一个<a class="ae kr" href="https://developer.mozilla.org/en-US/docs/Web/API/WebSocket" rel="noopener ugc nofollow" target="_blank"> WebSocket </a>连接时，你可以在清理<code class="fe lo lp lq lr b">socket.close()</code>函数中关闭它。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nx ny l"/></div><figcaption class="kn ko gj gh gi kp kq bd b be z dk">Cleaning up Web Sockets</figcaption></figure><h1 id="6399" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">结论</h1><p id="24a8" class="pw-post-body-paragraph ks kt iq ku b kv mk jr kx ky ml ju la lb mm ld le lf mn lh li lj mo ll lm ln ij bi translated">我们已经知道，一些副作用需要清理，以避免内存泄漏和不必要的和不想要的行为。我们必须了解何时以及如何使用<code class="fe lo lp lq lr b">useEffect</code>钩子的清理功能来避免这些问题并优化应用程序。</p><p id="bc5b" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">我建议在卸载组件时清理异步效应。此外，如果异步副作用依赖于属性或状态值，那么考虑在组件更新时也清除它们。</p><p id="094b" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">我希望这篇文章对您有用，并且您现在可以正确地使用清理功能了。</p><p id="9940" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated"><strong class="ku ir">阅读更多</strong></p><div class="oa ob gp gr oc od"><a href="https://blog.bitsrc.io/build-a-blog-with-react-and-markdown-files-30d969ce62d5" rel="noopener  ugc nofollow" target="_blank"><div class="oe ab fo"><div class="of ab og cl cj oh"><h2 class="bd ir gy z fp oi fr fs oj fu fw ip bi translated">用React和Markdown文件创建一个博客</h2><div class="ok l"><h3 class="bd b gy z fp oi fr fs oj fu fw dk translated">创建一个带有代码语法突出显示，黑暗模式和复制到剪贴板的教程博客</h3></div><div class="ol l"><p class="bd b dl z fp oi fr fs oj fu fw dk translated">blog.bitsrc.io</p></div></div><div class="om l"><div class="on l oo op oq om or kl od"/></div></div></a></div><div class="oa ob gp gr oc od"><a href="https://betterprogramming.pub/developing-a-crud-app-in-react-js-with-a-fake-api-rest-9f401bad5f04" rel="noopener  ugc nofollow" target="_blank"><div class="oe ab fo"><div class="of ab og cl cj oh"><h2 class="bd ir gy z fp oi fr fs oj fu fw ip bi translated">用假的API Rest在React JS中开发CRUD应用</h2><div class="ok l"><h3 class="bd b gy z fp oi fr fs oj fu fw dk translated">用JSON服务器添加CRUD功能</h3></div><div class="ol l"><p class="bd b dl z fp oi fr fs oj fu fw dk translated">better编程. pub</p></div></div><div class="om l"><div class="os l oo op oq om or kl od"/></div></div></a></div><pre class="kg kh ki kj gt nd lr ne nf aw ng bi"><span id="8a6b" class="nh lt iq lr b gy ni nj l nk nl"><strong class="lr ir">Want to Connect?<br/></strong>Love connecting with friends all around the world on <a class="ae kr" href="https://twitter.com/ljaviertovar" rel="noopener ugc nofollow" target="_blank">Twitter</a>.</span></pre><p id="ae14" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated"><em class="nz">更多内容看</em> <a class="ae kr" href="https://plainenglish.io/" rel="noopener ugc nofollow" target="_blank"> <strong class="ku ir"> <em class="nz">说白了就是io </em> </strong> </a> <em class="nz">。报名参加我们的</em> <a class="ae kr" href="http://newsletter.plainenglish.io/" rel="noopener ugc nofollow" target="_blank"> <strong class="ku ir"> <em class="nz">免费周报</em> </strong> </a> <em class="nz">。关注我们关于</em><a class="ae kr" href="https://twitter.com/inPlainEngHQ" rel="noopener ugc nofollow" target="_blank"><strong class="ku ir"><em class="nz">Twitter</em></strong></a><strong class="ku ir"><em class="nz"/></strong><em class="nz">和</em><a class="ae kr" href="https://www.linkedin.com/company/inplainenglish/" rel="noopener ugc nofollow" target="_blank"><strong class="ku ir"><em class="nz">LinkedIn</em></strong></a><em class="nz">。查看我们的</em><strong class="ku ir"><em class="nz"/></strong><a class="ae kr" href="https://discord.gg/GtDtUAvyhW" rel="noopener ugc nofollow" target="_blank"><strong class="ku ir"><em class="nz">社区不和谐</em> </strong> </a> <em class="nz">加入我们的</em> <a class="ae kr" href="https://inplainenglish.pallet.com/talent/welcome" rel="noopener ugc nofollow" target="_blank"> <strong class="ku ir"> <em class="nz">人才集体</em> </strong> </a> <em class="nz">。</em></p></div></div>    
</body>
</html>