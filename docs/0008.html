<html>
<head>
<title>Building the fastest object and array differ</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">构建最快的对象和阵列不同</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/building-the-fastest-object-and-array-differ-a58ac7112b1f?source=collection_archive---------7-----------------------#2022-01-01">https://javascript.plainenglish.io/building-the-fastest-object-and-array-differ-a58ac7112b1f?source=collection_archive---------7-----------------------#2022-01-01</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><figure class="ip iq gp gr ir is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi io"><img src="../Images/eb41cf25edf36615bf10ff94c0f0f097.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bw49Mo9WIUNTGEsf52XkrQ.png"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk">Microdiff’s logo</figcaption></figure><div class=""/><div class=""><h2 id="be6e" class="pw-subtitle-paragraph kc je jf bd b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt dk translated">我如何构建Microdiff，以及它如何比大多数其他对象和数组差异库更快</h2></div><p id="7ad4" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">我维护<a class="ae lq" href="https://github.com/AsyncBanana/microdiff" rel="noopener ugc nofollow" target="_blank"> Microdiff </a>，这是一个性能和大小优化的库，用于深度对象区分。有人在一期<a class="ae lq" href="https://github.com/AsyncBanana/microdiff/issues/2#issuecomment-962491393" rel="noopener ugc nofollow" target="_blank">微diff</a>中发帖，要求我写一篇关于我如何快速制作微diff的博文。</p><blockquote class="lr ls lt"><p id="a79d" class="ku kv lu kw b kx ky kg kz la lb kj lc lv le lf lg lw li lj lk lx lm ln lo lp ij bi translated"><em class="jf">我相信一个解释者(也许是一篇博文？)您注意到的其他库的低效率以及您如何克服它们(包括您所说的不受支持的“边缘情况”)将会非常有趣。它们还有助于正确解释基准测试的结果。</em></p></blockquote><p id="6eb6" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">所以，我决定这么做。这篇博文描述了我如何使Microdiff比大多数其他对象和数组diffing库更快。</p><blockquote class="lr ls lt"><p id="7002" class="ku kv lu kw b kx ky kg kz la lb kj lc lv le lf lg lw li lj lk lx lm ln lo lp ij bi translated"><strong class="kw jg"> <em class="jf">免责声明</em> </strong> <em class="jf">:我对这个题目很有偏见。</em></p></blockquote><h1 id="3501" class="ly lz jf bd ma mb mc md me mf mg mh mi kl mj km mk ko ml kp mm kr mn ks mo mp bi translated">差异简介</h1><p id="f225" class="pw-post-body-paragraph ku kv jf kw b kx mq kg kz la mr kj lc ld ms lf lg lh mt lj lk ll mu ln lo lp ij bi translated">Diffing(差异跟踪)是跟踪两个对象之间的不同之处。例如，假设你有两个对象，对象a和对象b。</p><figure class="mv mw mx my gt is"><div class="bz fp l di"><div class="mz na l"/></div></figure><p id="67ce" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">使用Microdiff，要获得差异，您可以这样做:</p><figure class="mv mw mx my gt is"><div class="bz fp l di"><div class="mz na l"/></div></figure><p id="ac37" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">如您所见，所有的更改，无论是值的更改、添加还是删除，都被记录了下来。差异对于许多事情来说是必不可少的，比如虚拟DOM，因为它们需要记录元素的变化。现在，让我们来了解一下微diff之前的diffing生态系统的问题。</p><h1 id="941a" class="ly lz jf bd ma mb mc md me mf mg mh mi kl mj km mk ko ml kp mm kr mn ks mo mp bi translated">微观分化前的分化生态系统</h1><p id="be61" class="pw-post-body-paragraph ku kv jf kw b kx mq kg kz la mr kj lc ld ms lf lg lh mt lj lk ll mu ln lo lp ij bi translated">不同的生态系统处于一种糟糕的状态。许多图书馆下载了数百万次，但没有得到积极维护，而且制作质量很差。现在，让我们看看第一个例子，deep-diff。</p><h2 id="cf8f" class="nb lz jf bd ma nc nd dn me ne nf dp mi ld ng nh mk lh ni nj mm ll nk nl mo nm bi translated">深度差异</h2><p id="5657" class="pw-post-body-paragraph ku kv jf kw b kx mq kg kz la mr kj lc ld ms lf lg lh mt lj lk ll mu ln lo lp ij bi translated">Deep-Diff 是用于深度对象区分的最流行的JavaScript库之一。它每周获得100万到200万次下载，拥有超过10k颗GitHub星的工具都在使用它。</p><p id="bb3d" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">然而，它有许多缺陷。首先，最后一次提交是在2019年，它没有遵循现代的约定，如支持ESM和提供捆绑的TypeScript类型。</p><p id="c035" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">此外，它的尺寸和性能也有问题。它的大小为5.5kb，压缩后为1.9kb。这个大小并不可怕，只是这是一个简单的实用程序，因此应该有一个更小的大小。相比之下，Microdiff的大小为0.9kb minified和0.5kb Gzipped。</p><p id="d917" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">现在，就性能而言，Deep-Diff也做得不好。它不能做得很小或很快，因为它有许多不同的功能，这增加了大量的开销。此外，它不做诸如分组类型行为之类的事情来提高性能。因为所有这些事情，Microdiff可以比<a class="ae lq" href="https://github.com/AsyncBanana/microdiff#benchmarks" rel="noopener ugc nofollow" target="_blank">快400%</a>。</p><h2 id="1d0d" class="nb lz jf bd ma nc nd dn me ne nf dp mi ld ng nh mk lh ni nj mm ll nk nl mo nm bi translated">深层对象差异</h2><p id="c996" class="pw-post-body-paragraph ku kv jf kw b kx mq kg kz la mr kj lc ld ms lf lg lh mt lj lk ll mu ln lo lp ij bi translated"><a class="ae lq" href="https://www.npmjs.com/package/deep-object-diff" rel="noopener ugc nofollow" target="_blank"> Deep-Object-Diff </a>是另一个流行的diffing库。虽然它自2018年以来一直没有更新，但它拥有Deep-Diff所缺少的一些现代功能，如ESM和内置的TypeScript类型。</p><p id="653a" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">此外，如果使用基本差分，它可以以接近微diff的速度运行。然而，它仍然有两个问题，大小和它提供的信息。</p><p id="30a9" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">首先，虽然它没有deep-diff大，但仍然很重要，5.2kb minified和1kb Gzipped。其次，由于输出的设计方式，它提供的细节很少。</p><p id="8305" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">在微diff提供变更类型、新值、旧值和路径的情况下，Deep-Object-Diff的最详细的diff ( <code class="fe nn no np nq b">detailedDiff</code>)不提供旧值。此外，如果您想要接近微diff速度，您必须使用主diff函数而不是<code class="fe nn no np nq b">detailedDiff</code>，这样您就不知道变化类型。</p><h2 id="2d12" class="nb lz jf bd ma nc nd dn me ne nf dp mi ld ng nh mk lh ni nj mm ll nk nl mo nm bi translated">JSDiff</h2><p id="a6c7" class="pw-post-body-paragraph ku kv jf kw b kx mq kg kz la mr kj lc ld ms lf lg lh mt lj lk ll mu ln lo lp ij bi translated">虽然JSDiff 支持对象区分，但它主要是为区分文本而设计的。它很大，有15.8kb的Microdiff和5.9kb的gzip，而且非常慢(比Microdiff慢2100%)。我不会深入解释为什么它这么慢，因为它根本不是为对象区分而设计的。</p><h1 id="ee42" class="ly lz jf bd ma mb mc md me mf mg mh mi kl mj km mk ko ml kp mm kr mn ks mo mp bi translated">Microdiff如何解决这个问题</h1><h2 id="8b54" class="nb lz jf bd ma nc nd dn me ne nf dp mi ld ng nh mk lh ni nj mm ll nk nl mo nm bi translated">注重性能的架构</h2><p id="58e0" class="pw-post-body-paragraph ku kv jf kw b kx mq kg kz la mr kj lc ld ms lf lg lh mt lj lk ll mu ln lo lp ij bi translated">Microdiff通过专注于性能和大小而不牺牲易用性，解决了许多这样的问题。它不是一个复杂的函数网络，而是一个简单的递归函数。Microdiff还使用类似组合类型行为的策略来减小大小，同时提高性能。</p><p id="f278" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">例如，假设您想要查看RegEx和JavaScript日期之间的差异。为了获得准确的变更跟踪，您必须将RegEx字符串化，并将日期转换成数字。一个简单的实现可能是这样的:</p><figure class="mv mw mx my gt is"><div class="bz fp l di"><div class="mz na l"/></div></figure><p id="3798" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">这是可行的，但是如果您也需要检查<code class="fe nn no np nq b">new String()</code>对象或<code class="fe nn no np nq b">new Number()</code>对象呢？(<code class="fe nn no np nq b">new String()</code>和<code class="fe nn no np nq b">new Number()</code>不创建原语，所以你必须将它们转换成类似于日期和正则表达式的原语)为了解决这个问题而不引入大量的<code class="fe nn no np nq b">if then</code>，Microdiff的实现是这样的:</p><figure class="mv mw mx my gt is"><div class="bz fp l di"><div class="mz na l"/></div></figure><p id="1da3" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">这段代码首先得到一个不能直接比较的类型列表(<code class="fe nn no np nq b">richTypes</code>)。</p><p id="14ba" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">然后，它检查该值是否属于这些类型之一。如果是，那么代码检查该值是否可以用<code class="fe nn no np nq b">isNaN</code>强制转换成一个数字。如果可以的话(在日期和<code class="fe nn no np nq b">new Number()</code> s的情况下是真的)，它检查被强制为数字的版本。如果不是(RegEx和<code class="fe nn no np nq b">new String()</code>就是这种情况)，它将值强制转换成一个字符串，并比较该版本。</p><p id="21c5" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">在Microdiff中，实际的rich类型转换逻辑并没有太大的不同，尽管有一些差异减小了大小，并有助于逻辑与代码的其余部分相适应。</p><p id="9b00" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">诸如此类的事情是Microdiff速度快的部分原因。然而，另一个原因是它只关注更常见的情况，而不是每一种可能的边缘情况。</p><h2 id="b16f" class="nb lz jf bd ma nc nd dn me ne nf dp mi ld ng nh mk lh ni nj mm ll nk nl mo nm bi translated">关注99%的案例，而不是解决所有边缘案例</h2><p id="461f" class="pw-post-body-paragraph ku kv jf kw b kx mq kg kz la mr kj lc ld ms lf lg lh mt lj lk ll mu ln lo lp ij bi translated">在这方面，Microdiff自发布以来已经有了很大的改进。事实上，自从编写了<a class="ae lq" href="https://github.com/AsyncBanana/microdiff/issues/2#issuecomment-960291469" rel="noopener ugc nofollow" target="_blank">初始解释</a>以来，Microdiff已经增加了对更丰富类型和循环引用的支持。</p><p id="9aa2" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">然而，仍有一些情况下，Microdiff的行为不太正确，比如在比较具有原型属性的对象时，因为它包含了原型属性。类型组合为列出的类型解决了这个问题，但不是为所有其他类型。</p><p id="6713" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">在以前的测试中，排除原型属性的方法并不快速。但是，我可能会为您添加一种方法来为字符串/数字强制传递自定义继承类型，这可能对某些事情有所帮助。然而，目前这是不可能的。</p><h1 id="f228" class="ly lz jf bd ma mb mc md me mf mg mh mi kl mj km mk ko ml kp mm kr mn ks mo mp bi translated">结论</h1><p id="b176" class="pw-post-body-paragraph ku kv jf kw b kx mq kg kz la mr kj lc ld ms lf lg lh mt lj lk ll mu ln lo lp ij bi translated">总之，Microdiff是速度最快的区别库，因为它以性能为中心的体系结构和对99%案例的关注，并且Microdiff仍然能够使用现代功能，使其易于使用。如果你对Microdiff感兴趣，请查看GitHub repo 。希望你从中有所收获，感谢你的阅读。</p></div><div class="ab cl nr ns hu nt" role="separator"><span class="nu bw bk nv nw nx"/><span class="nu bw bk nv nw nx"/><span class="nu bw bk nv nw"/></div><div class="ij ik il im in"><p id="0f88" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated"><em class="lu">最初发表于2022年1月1日</em><a class="ae lq" href="https://byteofdev.com/posts/microdiff/" rel="noopener ugc nofollow" target="_blank"><em class="lu">【https://byteofdev.com】</em></a><em class="lu">。</em></p><p id="7e0b" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated"><em class="lu">更多内容看</em> <a class="ae lq" href="http://plainenglish.io/" rel="noopener ugc nofollow" target="_blank"> <strong class="kw jg"> <em class="lu">说白了。报名参加我们的</em> <a class="ae lq" href="http://newsletter.plainenglish.io/" rel="noopener ugc nofollow" target="_blank"> <strong class="kw jg"> <em class="lu">免费周报</em> </strong> </a> <em class="lu">。在我们的</em> <a class="ae lq" href="https://discord.gg/GtDtUAvyhW" rel="noopener ugc nofollow" target="_blank"> <strong class="kw jg"> <em class="lu">社区不和谐</em> </strong> </a> <em class="lu">获得独家获取写作机会和建议。</em></strong></a></p></div></div>    
</body>
</html>