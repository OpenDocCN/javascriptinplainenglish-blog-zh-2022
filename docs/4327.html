<html>
<head>
<title>How Front-end Engineers Compress Pictures, You Can Do This</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">前端工程师如何压缩图片，你可以这样做</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/how-front-end-engineers-compress-pictures-you-can-do-this-80988ea447d8?source=collection_archive---------8-----------------------#2022-11-21">https://javascript.plainenglish.io/how-front-end-engineers-compress-pictures-you-can-do-this-80988ea447d8?source=collection_archive---------8-----------------------#2022-11-21</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/e2109d69c8658458525e9db676cf67cd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*CGuPGxtDggxiA7IH"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">Photo by <a class="ae kc" href="https://unsplash.com/@grakozy?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Greg Rakozy</a> on <a class="ae kc" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="e3ca" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们从PS等工具导出的图片，或者美术直接给的剪切图，都是未压缩的，比较大。在这里，有优化的空间。</p><h1 id="f3e4" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">1.TinyPng</h1><p id="f571" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">TinyPNG使用智能的“有损压缩技术”来减小WEBP、JPEG和PNG文件的文件大小。通过选择性地减少图像中的“颜色数量”,使用更少的字节来存储数据。这种影响几乎看不见，但会对文件大小产生非常大的影响。</p><p id="ef71" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">用过TinyPng的人都知道，它的压缩效果非常好，体积大大减小，显示效果也差不多。所以选择它作为压缩工具是个不错的选择。</p><p id="c164" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">TinyPng提供了两种压缩方法:</p><ul class=""><li id="b331" class="me mf iq kf b kg kh kk kl ko mg ks mh kw mi la mj mk ml mm bi translated">通过在官网手动压缩</li><li id="377a" class="me mf iq kf b kg mn kk mo ko mp ks mq kw mr la mj mk ml mm bi translated">压缩通过官方测试</li></ul><p id="dfaa" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">作为一个程序员，我不能接受手工一个一个上传压缩文件的方法。所以选择第二种方法，通过封装一个工具自动压缩项目中的图片，彻底解放双手。</p><h1 id="7c00" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">2.工具类型</h1><p id="71e9" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">第一步，思考这个工具的“目的”是什么？没错，“压缩图片”。</p><p id="99ab" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">第二步，思考压缩哪个“环节”？没错，“上映前”。</p><p id="9288" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">从这个角度来说，开发一个webpack插件是一个不错的选择。打包“生产环境”代码时，启用插件来处理图像。然而，这将面临两个问题:</p><ul class=""><li id="72f6" class="me mf iq kf b kg kh kk kl ko mg ks mh kw mi la mj mk ml mm bi translated">页面迭代，加了几张图。重新打包上线时，旧图片会被多次压缩。</li><li id="d945" class="me mf iq kf b kg mn kk mo ko mp ks mq kw mr la mj mk ml mm bi translated">无法选择哪些图像要压缩，哪些不要压缩。</li></ul><p id="b43b" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">虽然以上问题可以通过“配置”来解决，但是每个包都需要一个特殊的配置，有点麻烦。看来外挂不是最好的选择。</p><p id="cf51" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">使用“命令行工具”可以完美解决以上两个问题。在打包“生产环境”代码之前，执行“压缩命令”，通过命令行交互选择要压缩的图像。</p><h1 id="0d0c" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">3.使用</h1><pre class="ms mt mu mv gt mw mx my bn mz na bi"><span id="2d30" class="nb lc iq mx b be nc nd l ne nf">$ npm i yx-tiny -D<br/>$ npx tiny</span></pre><p id="b452" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">压缩结果为:2.64MB ==&gt; 1.02MB</p><h1 id="54f6" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">4.实施理念</h1><p id="ca61" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">总的来说，有五个过程:</p><ul class=""><li id="de9a" class="me mf iq kf b kg kh kk kl ko mg ks mh kw mi la mj mk ml mm bi translated"><strong class="kf ir">查找</strong>:查找所有图像资源</li><li id="5eb2" class="me mf iq kf b kg mn kk mo ko mp ks mq kw mr la mj mk ml mm bi translated"><strong class="kf ir">分配</strong>:将任务平均分配给各个流程</li><li id="7b7b" class="me mf iq kf b kg mn kk mo ko mp ks mq kw mr la mj mk ml mm bi translated"><strong class="kf ir">上传</strong>:上传原图到TinyPng</li><li id="67fc" class="me mf iq kf b kg mn kk mo ko mp ks mq kw mr la mj mk ml mm bi translated"><strong class="kf ir">下载</strong>:从TinyPng下载压缩图片</li><li id="a2f0" class="me mf iq kf b kg mn kk mo ko mp ks mq kw mr la mj mk ml mm bi translated"><strong class="kf ir">写</strong>:用下载的镜像覆盖本地镜像</li></ul><h2 id="f58a" class="ng lc iq bd ld nh ni dn lh nj nk dp ll ko nl nm lp ks nn no lt kw np nq lx nr bi translated">4.1查找</h2><p id="83ff" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">查找所有图像资产。</p><figure class="ms mt mu mv gt jr"><div class="bz fp l di"><div class="ns nt l"/></div></figure><p id="cb8c" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">通过命令行交互后，获取目标文件夹的路径，然后获取路径下的所有内容，再遍历所有内容。首先确定内容的文件信息:如果是“文件夹”，那么以文件夹路径为路径，递归调用deepFindImg，如果不是“文件夹”，确定内容是图片，读取图片数据，推送图片。最后，返回所有找到的图像。</p><h2 id="71c6" class="ng lc iq bd ld nh ni dn lh nj nk dp ll ko nl nm lp ks nn no lt kw np nq lx nr bi translated">4.2分配</h2><p id="7584" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">将任务平均分配给每个流程。</p><figure class="ms mt mu mv gt jr"><div class="bz fp l di"><div class="ns nt l"/></div></figure><p id="20fc" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">使用cluster根据“CPU核心数”创建相同数量的进程。Works用于保存创建的流程。该列表存储要处理的压缩任务。通过遍历列表，任务被依次分配给每个进程。然后遍历作品，通过send方法发送流程任务。通过监听message事件，使用pageNum记录流程任务的完成情况，当所有流程任务执行完毕后，流程关闭。</p><h2 id="70dc" class="ng lc iq bd ld nh ni dn lh nj nk dp ll ko nl nm lp ks nn no lt kw np nq lx nr bi translated">4.3上传</h2><p id="321b" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">官方的tinify工具有“500张/月”的限制。超过限额后，需要付费。</p><figure class="ms mt mu mv gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nu"><img src="../Images/313518436afca24414757d56d3487432.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lVZzxOf_dUxtJwzGu8aUTg.png"/></div></div></figure><figure class="ms mt mu mv gt jr"><div class="bz fp l di"><div class="ns nt l"/></div></figure><p id="1779" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">使用节点附带的HTTPS模块来构造请求头，并上传由deepFindImg返回的图像。上传成功后，会返回压缩图片的URL链接。</p><h2 id="b6b6" class="ng lc iq bd ld nh ni dn lh nj nk dp ll ko nl nm lp ks nn no lt kw np nq lx nr bi translated">4.4下载</h2><p id="39f1" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">从TinyPng下载压缩图像。</p><figure class="ms mt mu mv gt jr"><div class="bz fp l di"><div class="ns nt l"/></div></figure><p id="2310" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">使用节点附带的HTTPS模块下载上传中返回的图像链接。下载成功后，返回图片的缓冲数据。</p><h2 id="c786" class="ng lc iq bd ld nh ni dn lh nj nk dp ll ko nl nm lp ks nn no lt kw np nq lx nr bi translated">4.5写</h2><p id="0bb0" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">用本地图片覆盖下载的图片。</p><figure class="ms mt mu mv gt jr"><div class="bz fp l di"><div class="ns nt l"/></div></figure><p id="b4a6" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">Process.on监控每个进程发送的任务。当任务类型为“图片”时，使用压缩方法处理图片。当任务类型为“svga”时，使用compressSvga方法处理Svga。最后，将处理后的资源写到本地覆盖旧的资源。</p><p id="dfeb" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kf ir">压缩</strong></p><figure class="ms mt mu mv gt jr"><div class="bz fp l di"><div class="ns nt l"/></div></figure><p id="a43e" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">CompressImg返回一个异步函数，先调用upload上传图片，再调用download下载，最后返回图片的缓冲区数据。</p><p id="adb7" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kf ir"> CompressSvga </strong></p><figure class="ms mt mu mv gt jr"><div class="bz fp l di"><div class="ns nt l"/></div></figure><p id="e06c" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">compressSvga的“输入”和“输出”与compressImg一致，目的是用promise.all同时调用。在compressSvga内部，将Svga解析成数据，获取svga的图像列表图像，然后调用compressImg对图像进行压缩，用压缩后的图像覆盖data.images，最后对数据进行编码，写入本地覆盖原来的svga。</p><h1 id="c1e7" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">最后</h1><p id="2a34" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated"><strong class="kf ir">感谢阅读</strong>。期待您的关注，阅读更多高质量的文章。</p><div class="nv nw gp gr nx"><div role="button" tabindex="0" class="ab bv gv cb fp ny nz bn oa jw ex"><div class="ob l"><div class="ab q"><div class="l di"><img alt="omgzui" class="l de bw oc od fe" src="../Images/113db82933227743d0067a68e250ac93.png" width="20" height="20" loading="lazy" data-original-src="https://miro.medium.com/v2/resize:fill:40:40/1*AmBIV4haXTWPO--EhE0Q1A.jpeg"/><div class="fb bw l oc od fc n aw fd"/></div><div class="hh l fo"><p class="bd b dl z fp fq fr fs ft fu fv fw dk translated"><a class="ae af ag ah ai aj ak al am an ao ap aq ar as" href="https://medium.com/@omgzui?source=post_page-----80988ea447d8--------------------------------" rel="noopener follow" target="_top"> omgzui </a></p></div></div><div class="og oh gw l"><h2 class="bd ir tn me fp to fr fs tp fu fw ip bi translated">更好的编程</h2></div><div class="ab q"><div class="l fo"><a class="bd b be z bi tq au tr ts tt qc tu an eh ei tv tw tx el em eo de bk ep" href="https://medium.com/@omgzui/list/better-programing-9b4c9bb174aa?source=post_page-----80988ea447d8--------------------------------" rel="noopener follow" target="_top">View list</a></div><div class="ty l fo"><span class="bd b dl z dk">109 stories</span></div></div></div><div class="ot dh ou fp ab ov fo di"><div class="di ol bv om on"><div class="dh l"><img alt="" class="dh" src="../Images/64fcf15e27c514ec49d62966b68dbc15.png" width="194" height="194" loading="lazy" role="presentation" data-original-src="https://miro.medium.com/v2/resize:fill:388:388/0*DbDdSUf5SchniJuq"/></div></div><div class="di ol bv oo op oq"><div class="dh l"><img alt="" class="dh" src="../Images/3e6ce891363c151131c5993ca0dcc526.png" width="194" height="194" loading="lazy" role="presentation" data-original-src="https://miro.medium.com/v2/resize:fill:388:388/0*7cAp-WibSblfO7hT"/></div></div><div class="di bv or os oq"><div class="dh l"><img alt="" class="dh" src="../Images/a7dd413de22f319a3c4729c9e737feb8.png" width="194" height="194" loading="lazy" role="presentation" data-original-src="https://miro.medium.com/v2/resize:fill:388:388/0*FcmHdVfoUOhlJlsG"/></div></div></div></div></div><div class="nv nw gp gr nx"><div role="button" tabindex="0" class="ab bv gv cb fp ny nz bn oa jw ex"><div class="ob l"><div class="ab q"><div class="l di"><img alt="omgzui" class="l de bw oc od fe" src="../Images/113db82933227743d0067a68e250ac93.png" width="20" height="20" loading="lazy" data-original-src="https://miro.medium.com/v2/resize:fill:40:40/1*AmBIV4haXTWPO--EhE0Q1A.jpeg"/><div class="fb bw l oc od fc n aw fd"/></div><div class="hh l fo"><p class="bd b dl z fp fq fr fs ft fu fv fw dk translated"><a class="ae af ag ah ai aj ak al am an ao ap aq ar as" href="https://medium.com/@omgzui?source=post_page-----80988ea447d8--------------------------------" rel="noopener follow" target="_top"> omgzui </a></p></div></div><div class="og oh gw l"><h2 class="bd ir tn me fp to fr fs tp fu fw ip bi translated">Java Script语言</h2></div><div class="ab q"><div class="l fo"><a class="bd b be z bi tq au tr ts tt qc tu an eh ei tv tw tx el em eo de bk ep" href="https://medium.com/@omgzui/list/javascript-48bfc7b5f93c?source=post_page-----80988ea447d8--------------------------------" rel="noopener follow" target="_top">View list</a></div><div class="ty l fo"><span class="bd b dl z dk">57 stories</span></div></div></div><div class="ot dh ou fp ab ov fo di"><div class="di ol bv om on"><div class="dh l"><img alt="" class="dh" src="../Images/64fcf15e27c514ec49d62966b68dbc15.png" width="194" height="194" loading="lazy" role="presentation" data-original-src="https://miro.medium.com/v2/resize:fill:388:388/0*DbDdSUf5SchniJuq"/></div></div><div class="di ol bv oo op oq"><div class="dh l"><img alt="" class="dh" src="../Images/3e6ce891363c151131c5993ca0dcc526.png" width="194" height="194" loading="lazy" role="presentation" data-original-src="https://miro.medium.com/v2/resize:fill:388:388/0*7cAp-WibSblfO7hT"/></div></div><div class="di bv or os oq"><div class="dh l"><img alt="" class="dh" src="../Images/a7dd413de22f319a3c4729c9e737feb8.png" width="194" height="194" loading="lazy" role="presentation" data-original-src="https://miro.medium.com/v2/resize:fill:388:388/0*FcmHdVfoUOhlJlsG"/></div></div></div></div></div><div class="nv nw gp gr nx"><div role="button" tabindex="0" class="ab bv gv cb fp ny nz bn oa jw ex"><div class="ob l"><div class="ab q"><div class="l di"><img alt="omgzui" class="l de bw oc od fe" src="../Images/113db82933227743d0067a68e250ac93.png" width="20" height="20" loading="lazy" data-original-src="https://miro.medium.com/v2/resize:fill:40:40/1*AmBIV4haXTWPO--EhE0Q1A.jpeg"/><div class="fb bw l oc od fc n aw fd"/></div><div class="hh l fo"><p class="bd b dl z fp fq fr fs ft fu fv fw dk translated"><a class="ae af ag ah ai aj ak al am an ao ap aq ar as" href="https://medium.com/@omgzui?source=post_page-----80988ea447d8--------------------------------" rel="noopener follow" target="_top"> omgzui </a></p></div></div><div class="og oh gw l"><h2 class="bd ir tn me fp to fr fs tp fu fw ip bi translated">新闻</h2></div><div class="ab q"><div class="l fo"><a class="bd b be z bi tq au tr ts tt qc tu an eh ei tv tw tx el em eo de bk ep" href="https://medium.com/@omgzui/list/news-67ec0a972660?source=post_page-----80988ea447d8--------------------------------" rel="noopener follow" target="_top">View list</a></div><div class="ty l fo"><span class="bd b dl z dk">23 stories</span></div></div></div><div class="ot dh ou fp ab ov fo di"><div class="di ol bv om on"><div class="dh l"><img alt="" class="dh" src="../Images/c3f36b36bf050f98fd5a8e3c89103cad.png" width="194" height="194" loading="lazy" role="presentation" data-original-src="https://miro.medium.com/v2/resize:fill:388:388/0*LISEmTdz19k7BAHY"/></div></div><div class="di ol bv oo op oq"><div class="dh l"><img alt="" class="dh" src="../Images/8459df5aae62dc00f04377e09544be88.png" width="194" height="194" loading="lazy" role="presentation" data-original-src="https://miro.medium.com/v2/resize:fill:388:388/0*RvBGLw3V9JZfn_HO"/></div></div><div class="di bv or os oq"><div class="dh l"><img alt="" class="dh" src="../Images/2864058bcedc8c1cd6492624ba9671c6.png" width="194" height="194" loading="lazy" role="presentation" data-original-src="https://miro.medium.com/v2/resize:fill:388:388/0*IUWVb3zTn1_HKV9P"/></div></div></div></div></div><p id="6d16" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><em class="pa">更多内容看</em> <a class="ae kc" href="https://plainenglish.io/" rel="noopener ugc nofollow" target="_blank"> <strong class="kf ir"> <em class="pa">说白了就是</em> </strong> </a> <em class="pa">。报名参加我们的</em> <a class="ae kc" href="http://newsletter.plainenglish.io/" rel="noopener ugc nofollow" target="_blank"> <strong class="kf ir"> <em class="pa">免费周报</em> </strong> </a> <em class="pa">。关注我们关于</em> <a class="ae kc" href="https://twitter.com/inPlainEngHQ" rel="noopener ugc nofollow" target="_blank"> <strong class="kf ir"> <em class="pa">推特</em> </strong> </a>，<a class="ae kc" href="https://www.linkedin.com/company/inplainenglish/" rel="noopener ugc nofollow" target="_blank"> <strong class="kf ir"> <em class="pa">领英</em> </strong> </a> <em class="pa">，</em><a class="ae kc" href="https://www.youtube.com/channel/UCtipWUghju290NWcn8jhyAw" rel="noopener ugc nofollow" target="_blank"><strong class="kf ir"><em class="pa">YouTube</em></strong></a><em class="pa">，以及</em> <a class="ae kc" href="https://discord.gg/GtDtUAvyhW" rel="noopener ugc nofollow" target="_blank"> <strong class="kf ir"> <em class="pa">不和</em> </strong> </a> <em class="pa">。对增长黑客感兴趣？检查</em> <a class="ae kc" href="https://circuit.ooo/" rel="noopener ugc nofollow" target="_blank"> <strong class="kf ir"> <em class="pa">电路</em> </strong> </a> <em class="pa">。</em></p></div></div>    
</body>
</html>