<html>
<head>
<title>Learn winstonjs — Master Logging in Node.js</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">了解Winston js—node . js中的主日志记录</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/learn-winstonjs-master-logging-in-node-js-d00f43df6496?source=collection_archive---------6-----------------------#2022-04-14">https://javascript.plainenglish.io/learn-winstonjs-master-logging-in-node-js-d00f43df6496?source=collection_archive---------6-----------------------#2022-04-14</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="13b3" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">winstonjs入门所需的一切。</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/217672c059527ed49d6bde52a2375eaa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*ndTJEV9iblsAy3tR"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk">Photo by <a class="ae kv" href="https://unsplash.com/@usefulcollective?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Mildly Useful</a> on <a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="c011" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">Winston是一个易于使用且灵活的日志库。在本教程中，我们将涵盖你需要开始的一切。</p><h1 id="1e56" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated"><strong class="ak">入门</strong></h1><p id="7bab" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">在本教程中，我将建立一个简单的应用程序，但是您可以自由地跟随您自己的项目。如果您正在使用自己的项目，可以跳到下一部分。</p><ol class=""><li id="fc03" class="mp mq iq ky b kz la lc ld lf mr lj ms ln mt lr mu mv mw mx bi translated">为您的项目创建新目录。</li><li id="1390" class="mp mq iq ky b kz my lc mz lf na lj nb ln nc lr mu mv mw mx bi translated">运行<code class="fe nd ne nf ng b">npm init -y</code>(或<code class="fe nd ne nf ng b">yarn init</code>)创建一个空白的NPM项目。</li><li id="a6c5" class="mp mq iq ky b kz my lc mz lf na lj nb ln nc lr mu mv mw mx bi translated">用<code class="fe nd ne nf ng b">npm i winston</code>(或<code class="fe nd ne nf ng b">yarn add winston</code>)安装温斯顿。</li><li id="8280" class="mp mq iq ky b kz my lc mz lf na lj nb ln nc lr mu mv mw mx bi translated">创建一个名为<code class="fe nd ne nf ng b">index.js</code>的新文件，并添加以下样板代码。</li><li id="36bd" class="mp mq iq ky b kz my lc mz lf na lj nb ln nc lr mu mv mw mx bi translated">用<code class="fe nd ne nf ng b">node .</code>运行应用程序，确认web服务器已经启动(在本教程的剩余部分，我们将使用这个命令来启动应用程序)</li><li id="8732" class="mp mq iq ky b kz my lc mz lf na lj nb ln nc lr mu mv mw mx bi translated">在<a class="ae kv" href="http://localhost:8080" rel="noopener ugc nofollow" target="_blank"> http://localhost:8080 </a>访问任何路由，以显示它正在工作</li><li id="e4d6" class="mp mq iq ky b kz my lc mz lf na lj nb ln nc lr mu mv mw mx bi translated">通过访问<a class="ae kv" href="http://localhost:8080/stop" rel="noopener ugc nofollow" target="_blank">http://localhost:8080/stop</a>停止服务器</li></ol><pre class="kg kh ki kj gt nh ng ni nj aw nk bi"><span id="86be" class="nl lt iq ng b gy nm nn l no np">const { createServer } = require('http')</span><span id="51b8" class="nl lt iq ng b gy nq nn l no np">/**<br/> * My test app<br/> */<br/>class App {<br/>  constructor() {<br/>    this.server = createServer((req, res) =&gt; {<br/>      // if someone visits <a class="ae kv" href="http://localhost:8080/stop" rel="noopener ugc nofollow" target="_blank">http://localhost:8080/stop</a><br/>      // then stop the server<br/>      if (req.url === '/stop') {<br/>        res.writeHead(200, { 'Content-Type': 'application/json' })<br/>        res.end(JSON.stringify({<br/>          message: 'Server is stopping'<br/>        }))<br/>        return this.stop()<br/>      }</span><span id="1af8" class="nl lt iq ng b gy nq nn l no np">// otherwise, just send a simple response<br/>      res.writeHead(200, { 'Content-Type': 'application/json' })<br/>      res.end(JSON.stringify({<br/>        message: 'Hello World'<br/>      }))<br/>    })<br/>  }</span><span id="cb60" class="nl lt iq ng b gy nq nn l no np">/**<br/>   * Start the server<br/>   */<br/>  start() {<br/>    this.server.listen(8080)<br/>  }</span><span id="f97b" class="nl lt iq ng b gy nq nn l no np">/**<br/>   * Stop the server<br/>   */<br/>  stop() {<br/>    this.server.close()<br/>    process.exit(0)<br/>  }<br/>}</span><span id="2111" class="nl lt iq ng b gy nq nn l no np">let app = new App()<br/>app.start()</span></pre><h1 id="ac43" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated"><strong class="ak">创建我们的记录器</strong></h1><p id="85a1" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">现在我们有一个项目要做，让我们用推荐的配置创建一个Winston记录器的实例。如果你有多个文件，我建议把它放在你的应用程序的类中，但是为了简单起见，我会把它作为一个全局对象放在我的文件的顶部(在导入之后)。</p><pre class="kg kh ki kj gt nh ng ni nj aw nk bi"><span id="6919" class="nl lt iq ng b gy nm nn l no np">const winston = require('winston')<br/>// ESModules<br/>import winston from 'winston'</span><span id="bcd0" class="nl lt iq ng b gy nq nn l no np">const logger = winston.createLogger({<br/>  level: 'info',<br/>  format: winston.format.json(),<br/>  defaultMeta: { service: 'user-service' },<br/>  transports: [<br/>    //<br/>    // - Write all logs with importance level of `error` or less to `error.log`<br/>    // - Write all logs with importance level of `info` or less to `combined.log`<br/>    //<br/>    new winston.transports.File({ filename: 'error.log', level: 'error' }),<br/>    new winston.transports.File({ filename: 'combined.log' }),<br/>  ],<br/>})</span></pre><p id="164b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们可以看到，在这个默认配置中，我们将日志输出到两个不同的文件中。错误进入<code class="fe nd ne nf ng b">error.log</code>，所有日志进入<code class="fe nd ne nf ng b">combined.log</code>。我们还使用JSON格式作为输出。这样我们就可以更清楚地看到这会产生什么，给“开始”和“停止”函数添加一些日志，或者如果你正在使用你自己的项目，找到你自己的开始和停止代码并添加一些日志来显示发生了什么。</p><pre class="kg kh ki kj gt nh ng ni nj aw nk bi"><span id="1c3e" class="nl lt iq ng b gy nm nn l no np">  start() {<br/>    logger.info('Starting the server')<br/>    ...<br/>  }</span><span id="08ae" class="nl lt iq ng b gy nq nn l no np">  stop() {<br/>    logger.info('Stopping the server')<br/>    ...<br/>  }</span></pre><p id="e10b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在此之后运行应用程序会创建2个日志文件。然而，我们在终端中看不到任何东西。默认情况下，Winston不会在任何地方记录日志，所以我们必须使用传输明确地告诉它将日志发送到哪里。我们已经使用文件传输将它们发送到我们的文件中，并且我们可以添加一个控制台传输来记录到控制台。</p><p id="669e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">Winston提供了一点不错的样板文件，只在开发过程中记录到控制台。在创建记录器的位置下添加以下代码。</p><pre class="kg kh ki kj gt nh ng ni nj aw nk bi"><span id="0174" class="nl lt iq ng b gy nm nn l no np">if (process.env.NODE_ENV !== 'production') {<br/>  logger.add(new winston.transports.Console({<br/>    format: winston.format.simple(),<br/>  }));<br/>}</span></pre><p id="da7e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如你所见，我们还可以选择其他格式。“简单”格式将您的日志显示到控制台，如下所示。</p><pre class="kg kh ki kj gt nh ng ni nj aw nk bi"><span id="bc73" class="nl lt iq ng b gy nm nn l no np">info: Starting the server {“service”:”user-service”}</span></pre><p id="2b34" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">向您的项目添加一些日志(比如记录传入的请求)，然后继续下一步，我们将创建自己的传输。</p><h1 id="d617" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated"><strong class="ak">定制运输</strong></h1><p id="1674" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">自定义传输很容易创建，可以做各种各样的事情。下面的例子把我们的日志作为一个webhook发送到另一个服务器(这对于集中日志记录很有用)。在构造函数中，我们要求一个url参数，如果我们没有得到，就抛出一个错误。然后，我们可以在log方法中使用它将我们的webhook发送到url。</p><pre class="kg kh ki kj gt nh ng ni nj aw nk bi"><span id="4ffb" class="nl lt iq ng b gy nm nn l no np">class CustomTransport extends winston.Transport {<br/>  constructor(opts) {<br/>    super(opts);<br/>    if (!opts.url) throw Error('URL not provided')<br/>    this.url = opts.url<br/>  }</span><span id="a575" class="nl lt iq ng b gy nq nn l no np">log(info, callback) {<br/>    setImmediate(() =&gt; {<br/>      this.emit('logged', info);<br/>    });</span><span id="cb96" class="nl lt iq ng b gy nq nn l no np">// Send a webhook, write to a file, or anything else you wish to do with the log<br/>    fetch(this.url, {<br/>      method: 'post',<br/>      body: {<br/>        info<br/>      }<br/>    })<br/>    callback();<br/>  }<br/>}</span></pre><p id="b35e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们可以将我们的传输添加到我们的日志配置中，并指定我们需要的任何选项。</p><pre class="kg kh ki kj gt nh ng ni nj aw nk bi"><span id="c57b" class="nl lt iq ng b gy nm nn l no np">const winston = require('winston')<br/>// ESModules<br/>import winston from 'winston'</span><span id="c490" class="nl lt iq ng b gy nq nn l no np">const logger = winston.createLogger({<br/>  level: 'info',<br/>  format: winston.format.json(),<br/>  defaultMeta: { service: 'user-service' },<br/>  transports: [<br/>    new winston.transports.File({ filename: 'error.log', level: 'error' }),<br/>    new winston.transports.File({ filename: 'combined.log' }),<br/>    // remember to pass in any options you defined<br/>    new CustomTransport({ url: '<a class="ae kv" href="https://example.com/logging'" rel="noopener ugc nofollow" target="_blank">https://example.com/logging'</a> }),<br/>  ],<br/>})</span></pre><h1 id="8eb1" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated"><strong class="ak">结论</strong></h1><p id="3a52" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">像Winston这样的库的优点是为任何用例提供了一个简单、灵活、可定制的记录器。无论是通过自定义传输向开发人员发送电子邮件来报告错误，还是简单地登录到开发中的控制台。</p><p id="19ac" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><em class="nr">更多内容看</em> <a class="ae kv" href="https://plainenglish.io/" rel="noopener ugc nofollow" target="_blank"> <strong class="ky ir"> <em class="nr">说白了。报名参加我们的</em> <a class="ae kv" href="http://newsletter.plainenglish.io/" rel="noopener ugc nofollow" target="_blank"> <strong class="ky ir"> <em class="nr">免费周报</em> </strong> </a> <em class="nr">。关注我们关于</em><a class="ae kv" href="https://twitter.com/inPlainEngHQ" rel="noopener ugc nofollow" target="_blank"><strong class="ky ir"><em class="nr">Twitter</em></strong></a><em class="nr">和</em><a class="ae kv" href="https://www.linkedin.com/company/inplainenglish/" rel="noopener ugc nofollow" target="_blank"><strong class="ky ir"><em class="nr">LinkedIn</em></strong></a><em class="nr">。加入我们的</em> <a class="ae kv" href="https://discord.gg/GtDtUAvyhW" rel="noopener ugc nofollow" target="_blank"> <strong class="ky ir"> <em class="nr">社区</em> </strong> </a> <em class="nr">。</em></strong></a></p></div></div>    
</body>
</html>