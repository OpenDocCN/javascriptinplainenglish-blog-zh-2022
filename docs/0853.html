<html>
<head>
<title>How to Talk to a RabbitMQ Instance with Node.js and TypeScript</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何使用Node.js和TypeScript与RabbitMQ实例对话</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/how-to-talk-to-a-rabbitmq-instance-with-node-js-and-typescript-92dbc514eaf8?source=collection_archive---------0-----------------------#2022-02-17">https://javascript.plainenglish.io/how-to-talk-to-a-rabbitmq-instance-with-node-js-and-typescript-92dbc514eaf8?source=collection_archive---------0-----------------------#2022-02-17</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="4f46" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">RabbitMQ、Node.js和TypeScript一起使用</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/22168a1e3fd26c4542c699d91fb5ce21.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zKw-aEYEk-3wNVxkbp7-0A.jpeg"/></div></div></figure><p id="f7d8" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">RabbitMQ是一个<strong class="kt ir">消息队列系统</strong>，它允许您对消息(对您的应用程序有意义的字符串值)进行排队，以供消费者(处理RabbitMQ消息的程序片段)使用。</p><p id="8693" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">当有大量数据需要处理，但处理不一定是即时的时，可以使用它。</p><p id="e134" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">在本文中，我们将建立一个Node.js应用程序，它可以使用RabbitMQ实例发送和使用消息。</p><h2 id="6283" class="ln lo iq bd lp lq lr dn ls lt lu dp lv la lw lx ly le lz ma mb li mc md me mf bi translated">先决条件</h2><p id="ea75" class="pw-post-body-paragraph kr ks iq kt b ku mg jr kw kx mh ju kz la mi lc ld le mj lg lh li mk lk ll lm ij bi translated">我们不会花太多时间来设置RabbitMQ。相反，我们将使用RabbitMQ 的<strong class="kt ir"> docker图像。</strong></p><p id="eb50" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">为此，您需要在您的机器上安装并运行Docker。</p><p id="725c" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">我们还将使用Node.js，无论有无NVM，您都必须安装npm。14版或更新版本就够了！</p><h2 id="ef19" class="ln lo iq bd lp lq lr dn ls lt lu dp lv la lw lx ly le lz ma mb li mc md me mf bi translated">使用docker-compose的RabbitMQ</h2><p id="0609" class="pw-post-body-paragraph kr ks iq kt b ku mg jr kw kx mh ju kz la mi lc ld le mj lg lh li mk lk ll lm ij bi translated">我们不想浪费时间配置RabbitMQ。相反，我们将使用Docker快速部署RabbitMQ。</p><p id="5938" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">在您的项目中，创建一个<code class="fe ml mm mn mo b">docker-compose.yml</code>文件，并将以下内容粘贴到其中:</p><pre class="kg kh ki kj gt mp mo mq mr aw ms bi"><span id="bd5d" class="ln lo iq mo b gy mt mu l mv mw">version: "3.7"<br/>services:<br/>  rabbitmq:<br/>    image: rabbitmq:3.9.13-management-alpine<br/>    container_name: 'rabbitmq'<br/>    restart: always<br/>    environment:<br/>      - "RABBITMQ_DEFAULT_PASS=password"<br/>      - "RABBITMQ_DEFAULT_USER=username"<br/>    ports:<br/>      - 15672:15672<br/>      - 5672:5672<br/>    networks:<br/>      - rabbitmq_go_net<br/><br/>networks:<br/>  rabbitmq_go_net:<br/>    driver: bridge</span></pre><p id="0168" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">然后在终端中，只需运行命令<code class="fe ml mm mn mo b">docker-compose up -d</code> <br/>它就会部署一个新的RabbitMQ运行实例！</p><p id="4508" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">完成后，在浏览器中打开http://localhost:15672 ，使用docker-compose文件中提供的用户名和密码。</p><p id="05cf" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">你应该看到RabbitMQ的管理页面！如果你不熟悉的话，不要犹豫，赶快四处看看。</p><h2 id="da99" class="ln lo iq bd lp lq lr dn ls lt lu dp lv la lw lx ly le lz ma mb li mc md me mf bi translated">与RabbitMQ建立联系</h2><p id="7e54" class="pw-post-body-paragraph kr ks iq kt b ku mg jr kw kx mh ju kz la mi lc ld le mj lg lh li mk lk ll lm ij bi translated">为此，我们将使用一个名为amqplib的库，它是Node.js 的<strong class="kt ir"> RabbitMQ客户端。</strong></p><div class="my mz gp gr na nb"><a href="https://www.npmjs.com/package/amqplib" rel="noopener  ugc nofollow" target="_blank"><div class="nc ab fo"><div class="nd ab ne cl cj nf"><h2 class="bd ir gy z fp ng fr fs nh fu fw ip bi translated">amqplib</h2><div class="ni l"><h3 class="bd b gy z fp ng fr fs nh fu fw dk translated">npm安装amqplib库，用于为节点制作AMQP 0-9-1客户端。JS和一个AMQP 0-9-1节点客户端。JS v10+…</h3></div><div class="nj l"><p class="bd b dl z fp ng fr fs nh fu fw dk translated">www.npmjs.com</p></div></div><div class="nk l"><div class="nl l nm nn no nk np kp nb"/></div></div></a></div><p id="f700" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">安装它并安装它的类型定义(如果您没有使用TypeScript，您不需要这样做)。</p><pre class="kg kh ki kj gt mp mo mq mr aw ms bi"><span id="3420" class="ln lo iq mo b gy mt mu l mv mw">npm install amqplib -S<br/>npm install @types/amqplib -D</span></pre><p id="5270" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">安装完成后，我们将连接到RabbitMQ实例。</p><blockquote class="nq nr ns"><p id="6a2d" class="kr ks nt kt b ku kv jr kw kx ky ju kz nu lb lc ld nv lf lg lh nw lj lk ll lm ij bi translated">该库支持2种方法(异步或回调),我们将在这里使用异步。如果你想启用回调函数，只需在每次导入后添加<code class="fe ml mm mn mo b">/callback_api</code>即可。</p></blockquote><pre class="kg kh ki kj gt mp mo mq mr aw ms bi"><span id="6533" class="ln lo iq mo b gy mt mu l mv mw">import client, {Connection} from 'amqplib'</span><span id="30cf" class="ln lo iq mo b gy nx mu l mv mw">...</span><span id="a303" class="ln lo iq mo b gy nx mu l mv mw">const connection: Connection = await client.connect(<br/>  'amqp://username:password@localhost:5672'<br/>)</span></pre><p id="c9ce" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">这是使用RabbitMQ的第一步，即连接到服务。该URL使用docker-compose文件中定义的相同用户/密码。端口是配置文件中的第二个端口:5672</p><p id="95aa" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">异步函数<code class="fe ml mm mn mo b">connect</code>返回连接对象。</p><h2 id="6c31" class="ln lo iq bd lp lq lr dn ls lt lu dp lv la lw lx ly le lz ma mb li mc md me mf bi translated">向RabbitMQ发送消息</h2><p id="e138" class="pw-post-body-paragraph kr ks iq kt b ku mg jr kw kx mh ju kz la mi lc ld le mj lg lh li mk lk ll lm ij bi translated">第二步是向我们的RabbitMQ服务发送消息。</p><p id="7739" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">我们将不得不访问我们的队列。队列是在第一次访问时自动创建的，不需要担心它们的存在。</p><p id="10f3" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">我们首先要创建一个通道。通道是一个轻量级TCP连接，用于向RabbitMQ发送数据或从rabbit MQ接收数据。它们与连接共存，如果连接关闭，它们也会关闭。</p><pre class="kg kh ki kj gt mp mo mq mr aw ms bi"><span id="e7b8" class="ln lo iq mo b gy mt mu l mv mw">const connection: Connection = await client.connect(<br/>'amqp://username:password@localhost:5672'<br/>)</span><span id="77f3" class="ln lo iq mo b gy nx mu l mv mw">// Create a channel<br/>const channel: Channel = await connection.createChannel()</span><span id="3285" class="ln lo iq mo b gy nx mu l mv mw">// Makes the queue available to the client<br/>await channel.assertQueue('myQueue')</span><span id="52b4" class="ln lo iq mo b gy nx mu l mv mw">//Send a message to the queue<br/>channel.sendToQueue('myQueue', <strong class="mo ir"><em class="nt">Buffer</em></strong>.from('message'))</span></pre><p id="2593" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">将这段代码添加到您的程序后，您应该会看到您的管理页面，尤其是<a class="ae mx" href="http://localhost:15672/#/queues" rel="noopener ugc nofollow" target="_blank">队列选项卡</a>。</p><p id="c79d" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">如果一切都按预期运行，您应该会看到一个名为<code class="fe ml mm mn mo b">myQueue</code>(或者无论您如何称呼它)的队列，如果您打开它，它会有一条空闲模式的消息。此消息正等待使用。这是我们文章的下一步，也是最后一步。</p><h2 id="1e56" class="ln lo iq bd lp lq lr dn ls lt lu dp lv la lw lx ly le lz ma mb li mc md me mf bi translated">消费我们的信息</h2><p id="f988" class="pw-post-body-paragraph kr ks iq kt b ku mg jr kw kx mh ju kz la mi lc ld le mj lg lh li mk lk ll lm ij bi translated">消费消息相当简单。我们所要做的就是使用通道调用<code class="fe ml mm mn mo b">consume</code>方法，并给它队列来消费，以及在接收消息时要调用的回调。</p><blockquote class="nq nr ns"><p id="72b5" class="kr ks nt kt b ku kv jr kw kx ky ju kz nu lb lc ld nv lf lg lh nw lj lk ll lm ij bi translated">你应该创建一些小程序来消费，而不是将消费者添加到主应用程序中。原因是javascript是单线程的，如果用户需要处理大量的工作，他们可能会降低主应用程序的速度。</p></blockquote><pre class="kg kh ki kj gt mp mo mq mr aw ms bi"><span id="e7b5" class="ln lo iq mo b gy mt mu l mv mw">import client, {Connection, Channel, ConsumeMessage} from 'amqplib'<br/><br/>// Function to send some messages before consuming the queue<br/>const sendMessages = (channel: Channel) =&gt; {<br/>  for (let i = 0; i &lt; 10; i++) {<br/>    channel.sendToQueue('myQueue', <strong class="mo ir"><em class="nt">Buffer</em></strong>.from(`message ${i}`))<br/>  }<br/>}<br/><br/>// consumer for the queue. <br/>// We use currying to give it the channel required to acknowledge the message<br/>const consumer = (channel: Channel) =&gt; (msg: ConsumeMessage | null): void =&gt; {<br/>  if (msg) {<br/>    // Display the received message<br/>    <strong class="mo ir"><em class="nt">console</em></strong>.log(msg.content.toString())<br/>    // Acknowledge the message<br/>    channel.ack(msg)<br/>  }<br/>}</span><span id="526a" class="ln lo iq mo b gy nx mu l mv mw">const connection: Connection = await client.connect(<br/>'amqp://username:password@localhost:5672'<br/>)<br/>// Create a channel<br/>const channel: Channel = await connection.createChannel()<br/>// Makes the queue available to the client<br/>await channel.assertQueue('myQueue')<br/>// Send some messages to the queue<br/>sendMessages(channel)<br/>// Start the consumer<br/>await channel.consume('myQueue', consumer(channel))</span></pre><p id="0e00" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">这是我们的最终代码！这段代码将创建/访问我们的队列，在上面发送一些消息并使用它。</p><blockquote class="nq nr ns"><p id="5508" class="kr ks nt kt b ku kv jr kw kx ky ju kz nu lb lc ld nv lf lg lh nw lj lk ll lm ij bi translated">Y <!-- -->您可能会注意到对<code class="fe ml mm mn mo b">channel.ack</code>的调用，这是为了告诉RabbitMQ消息已经成功处理。否则，RabbitMQ将等待它完成，并最终重新发布它(就像您这样设置它)。</p></blockquote><h2 id="74ff" class="ln lo iq bd lp lq lr dn ls lt lu dp lv la lw lx ly le lz ma mb li mc md me mf bi translated">结论</h2><p id="9d7e" class="pw-post-body-paragraph kr ks iq kt b ku mg jr kw kx mh ju kz la mi lc ld le mj lg lh li mk lk ll lm ij bi translated">现在，Node.js应用程序上应该有一个正常工作的RabbitMQ客户端了。</p><p id="8976" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">如果你想了解更多关于amqplib的API，你应该去看看他们的文档。</p><p id="2007" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">你可以在<a class="ae mx" href="https://github.com/psyycker-medium/rabbitmq-nodejs-typescript" rel="noopener ugc nofollow" target="_blank">我的GitHub </a>上找到文章的代码。</p><p id="5100" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">我希望你喜欢这篇文章！保重！</p><p id="e5cd" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated"><em class="nt">更多内容看</em> <a class="ae mx" href="http://plainenglish.io/" rel="noopener ugc nofollow" target="_blank"> <strong class="kt ir"> <em class="nt">说白了。报名参加我们的</em> <a class="ae mx" href="http://newsletter.plainenglish.io/" rel="noopener ugc nofollow" target="_blank"> <strong class="kt ir"> <em class="nt">免费周报</em> </strong> </a> <em class="nt">。在我们的</em> <a class="ae mx" href="https://discord.gg/GtDtUAvyhW" rel="noopener ugc nofollow" target="_blank"> <strong class="kt ir"> <em class="nt">社区不和谐</em> </strong> </a> <em class="nt">获得独家获取写作机会和建议。</em></strong></a></p></div></div>    
</body>
</html>