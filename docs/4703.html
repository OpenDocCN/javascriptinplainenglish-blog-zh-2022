<html>
<head>
<title>Logging system in NodeJS and Mongoose</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">NodeJS和Mongoose中的日志系统</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/logging-system-in-nodejs-and-mongoose-f0f6a8854f2d?source=collection_archive---------2-----------------------#2022-12-24">https://javascript.plainenglish.io/logging-system-in-nodejs-and-mongoose-f0f6a8854f2d?source=collection_archive---------2-----------------------#2022-12-24</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><figure class="gl gn jl jm jn jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi jk"><img src="../Images/2782d473a0cee6bb2888fcaef1029190.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*VPJQK6EOFqprIIyZ"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk">Photo by <a class="ae jz" href="https://unsplash.com/@pankajpatel?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Pankaj Patel</a> on <a class="ae jz" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><h1 id="45a1" class="ka kb in bd kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx bi translated">什么是日志记录？</h1><p id="d4ab" class="pw-post-body-paragraph ky kz in la b lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv ig bi translated">对于任何生产稳定的应用程序，我们需要一些日志机制来让我们知道应用程序日志、错误、警告或任何其他重要的细节。有很多方法可以使用普通的<code class="fe lw lx ly lz b">console.log</code>或<code class="fe lw lx ly lz b">winston</code>或任何其他库来设置应用程序日志，但有时您可能需要创建自己的日志记录机制来获得顶级的功能。</p><p id="0e40" class="pw-post-body-paragraph ky kz in la b lb ma ld le lf mb lh li lj mc ll lm ln md lp lq lr me lt lu lv ig bi translated">它还取决于应用程序中使用的编程语言及其本地支持</p><h2 id="45d5" class="mf kb in bd kc mg mh dn kg mi mj dp kk lj mk ml ko ln mm mn ks lr mo mp kw mq bi translated">什么是数据库级应用程序日志？</h2><p id="f656" class="pw-post-body-paragraph ky kz in la b lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv ig bi translated">对于需要在任何页面上查看日志和/或支持外部API进行日志记录的应用程序，我们需要将它们存储在数据库中。通常，有3个级别(可以更多)的日志记录</p><ul class=""><li id="4baa" class="mr ms in la b lb ma lf mb lj mt ln mu lr mv lv mw mx my mz bi translated">错误</li><li id="24c6" class="mr ms in la b lb na lf nb lj nc ln nd lr ne lv mw mx my mz bi translated">信息</li><li id="0674" class="mr ms in la b lb na lf nb lj nc ln nd lr ne lv mw mx my mz bi translated">警告</li></ul><p id="399e" class="pw-post-body-paragraph ky kz in la b lb ma ld le lf mb lh li lj mc ll lm ln md lp lq lr me lt lu lv ig bi translated">我们还将在数据库中保留3个不同的表/集合</p><blockquote class="nf ng nh"><p id="60db" class="ky kz ni la b lb ma ld le lf mb lh li nj mc ll lm nk md lp lq nl me lt lu lv ig bi translated">我们可以将所有内容存储在一个表/集合中，但是日志的数量可能会更大，这会影响获取日志的速度。在级别上还可以有另一个双重性，可以基于它们创建集合</p></blockquote><h2 id="ddde" class="mf kb in bd kc mg mh dn kg mi mj dp kk lj mk ml ko ln mm mn ks lr mo mp kw mq bi translated">开始</h2><p id="fff4" class="pw-post-body-paragraph ky kz in la b lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv ig bi translated">让我们从开始一个新的节点项目<code class="fe lw lx ly lz b">npm init -y</code>开始，你也可以在你现有的项目中使用它，然后定义你想要用于日志的模型。</p><p id="9683" class="pw-post-body-paragraph ky kz in la b lb ma ld le lf mb lh li lj mc ll lm ln md lp lq lr me lt lu lv ig bi translated">我们还将创建<code class="fe lw lx ly lz b">models</code>文件夹，并将所有模型文件放在那里。从<code class="fe lw lx ly lz b">ErrorLogs</code>开始，因为我们不知道类型，它可以是集合中的任何东西，我们使用<code class="fe lw lx ly lz b">strict: false</code>模式让用户存储任何东西，但你可以考虑定制它</p><figure class="nn no np nq gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi nm"><img src="../Images/3e76fddc61f1b546bbed94abd675e4d2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*A_gVcIfWCIunWVItuq7aZQ.png"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk">ErrorLogs.js</figcaption></figure><p id="3d77" class="pw-post-body-paragraph ky kz in la b lb ma ld le lf mb lh li lj mc ll lm ln md lp lq lr me lt lu lv ig bi translated">在<code class="fe lw lx ly lz b">ErrorLogs</code>之后，让我们创建一个新的集合<code class="fe lw lx ly lz b">InfoLogs</code>来存储信息日志</p><figure class="nn no np nq gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi nm"><img src="../Images/c4011e8ad1554f14c485bae24170f111.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PVEslpLZJ_SIx2KK6PloIg.png"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk">InfoLog.js</figcaption></figure><p id="b78e" class="pw-post-body-paragraph ky kz in la b lb ma ld le lf mb lh li lj mc ll lm ln md lp lq lr me lt lu lv ig bi translated">在<code class="fe lw lx ly lz b">InfoLogs</code>之后，让我们创建一个新的集合<code class="fe lw lx ly lz b">WarnLogs</code>来存储信息日志</p><figure class="nn no np nq gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi nm"><img src="../Images/3420bb65e0b0f9ff286bdf530c8f8ef7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PV5hOsnvjvzlDArgUlYeQQ.png"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk">WarnLog.js</figcaption></figure><p id="db01" class="pw-post-body-paragraph ky kz in la b lb ma ld le lf mb lh li lj mc ll lm ln md lp lq lr me lt lu lv ig bi translated">我不喜欢直接使用<code class="fe lw lx ly lz b">process</code>实例，所以我将创建一个常量文件，并将环境放在一个引用中，以后再使用它</p><figure class="nn no np nq gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi nr"><img src="../Images/5dbb333c5104e58b896b3c2b06e7931d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3EiYBE9wu1_KuqYSR8ZQrQ.png"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk">constant.js</figcaption></figure><p id="6767" class="pw-post-body-paragraph ky kz in la b lb ma ld le lf mb lh li lj mc ll lm ln md lp lq lr me lt lu lv ig bi translated">存储错误响应时，可能会出现循环依赖。所以我们将避免使用圆形对象，这样包装函数将会照顾我们</p><figure class="nn no np nq gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi ns"><img src="../Images/0f702292a7e45cddbefbe77e76d892c7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*d4EtwUTJZ5o2EXNOyhz_hQ.png"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk">util</figcaption></figure><p id="4be5" class="pw-post-body-paragraph ky kz in la b lb ma ld le lf mb lh li lj mc ll lm ln md lp lq lr me lt lu lv ig bi translated">除了循环依赖，我们将通过使用包<code class="fe lw lx ly lz b"><a class="ae jz" href="https://www.npmjs.com/package/error-to-json" rel="noopener ugc nofollow" target="_blank">error-to-json</a></code>使用它来迭代有效载荷中的任何<code class="fe lw lx ly lz b">Error</code>实例。</p><figure class="nn no np nq gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi nt"><img src="../Images/de73664b95f7ecc1590566b1bfe11a5a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fWcKKyLkM4RVsedHeNb-JQ.png"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk">Converting error to JSON</figcaption></figure><h2 id="ac1c" class="mf kb in bd kc mg mh dn kg mi mj dp kk lj mk ml ko ln mm mn ks lr mo mp kw mq bi translated">创建记录器</h2><p id="44a6" class="pw-post-body-paragraph ky kz in la b lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv ig bi translated">让我们为Logger创建一个类，它的属性包含信息、警告和错误列表对象以及它们的阈值。以下是我们将使用的属性</p><ul class=""><li id="537a" class="mr ms in la b lb ma lf mb lj mt ln mu lr mv lv mw mx my mz bi translated">错误、警告、信息—列表<any/></li><li id="81a0" class="mr ms in la b lb na lf nb lj nc ln nd lr ne lv mw mx my mz bi translated">阈值— <number/></li></ul><p id="c7b3" class="pw-post-body-paragraph ky kz in la b lb ma ld le lf mb lh li lj mc ll lm ln md lp lq lr me lt lu lv ig bi translated">导入我们创建的模型和utils文件将是我们的第一步</p><figure class="nn no np nq gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi nt"><img src="../Images/9a4aebc4272dbc497831aa2ca98d89ae.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zsVPXPXBXDsR5R4Sv6ComQ.png"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk">imports</figcaption></figure><p id="cdbb" class="pw-post-body-paragraph ky kz in la b lb ma ld le lf mb lh li lj mc ll lm ln md lp lq lr me lt lu lv ig bi translated">用描述的属性为我们的类创建框架。我们将为所有这些值设置日志、警告和错误的阈值。我们为每个阈值赋予不同的级别属性</p><pre class="nn no np nq gt nu lz nv bn nw nx bi"><span id="b1d3" class="ny kb in lz b be nz oa l ob oc">class CustomMongoLogger {<br/>  constructor(logThreshold = 20, errorThreshold = 5, warningThreshold = 5) {<br/>    this.warnings = [];<br/>    this.errors = [];<br/>    this.infos = [];<br/>    this.levels = {<br/>      info: "info",<br/>      error: "error",<br/>      warning: "warning",<br/>    };<br/>    this.logThreshold = logThreshold;<br/>    this.errorThreshold = errorThreshold;<br/>    this.warningThreshold = warningThreshold;<br/>  }<br/>}</span></pre><p id="dc72" class="pw-post-body-paragraph ky kz in la b lb ma ld le lf mb lh li lj mc ll lm ln md lp lq lr me lt lu lv ig bi translated">因为所有的文档都是部分日志，所以让我们创建一个私有的包装器函数，将数据绑定到一个简单的格式。我们将添加一些默认属性，如时间戳和消息属性</p><pre class="nn no np nq gt nu lz nv bn nw nx bi"><span id="998a" class="ny kb in lz b be nz oa l ob oc">#createEntry(payload, level) {<br/>    const checkedPayload =<br/>      typeof payload === "string" ? { message: payload } : payload;<br/>    const input = {<br/>      timestamp: new Date(),<br/>      level,<br/>      message: checkedPayload.message,<br/>      meta: {<br/>        ...checkedPayload,<br/>        ENV: Constants.NODE_ENV,<br/>        service: "main",<br/>        timestamp: new Date(),<br/>      },<br/>    };<br/>    return input;<br/>  }</span></pre><p id="6f66" class="pw-post-body-paragraph ky kz in la b lb ma ld le lf mb lh li lj mc ll lm ln md lp lq lr me lt lu lv ig bi translated">我们将需要在各自的集合中存储日志，因此也需要很少的方法。首先，我们将所有日志存储为临时变量，然后清除它们，同时存储在数据库中</p><pre class="nn no np nq gt nu lz nv bn nw nx bi"><span id="34dc" class="ny kb in lz b be nz oa l ob oc">async saveInfoLogs() {<br/>    const toBeUploaded = [...this.infos]<br/>    this.infos.length = 0<br/>    await InfoLogs.insertMany(toBeUploaded);<br/> }<br/>async saveErrorLogs() {<br/>  const toBeUploaded = [...this.errors]<br/>  this.errors.length = 0<br/>  await ErrorLogs.insertMany(toBeUploaded);<br/>}<br/>async saveWarningLogs() {<br/>  const toBeUploaded = [...this.warnings]<br/>  this.warnings.length = 0<br/>  await WarnLogs.insertMany(toBeUploaded);<br/>}</span></pre><p id="1128" class="pw-post-body-paragraph ky kz in la b lb ma ld le lf mb lh li lj mc ll lm ln md lp lq lr me lt lu lv ig bi translated">现在，最后一步是同步更改，并检查何时需要将数据存储到数据库中。每当该值超过阈值时，我们将使用之前创建的方法将其存储在数据库中</p><pre class="nn no np nq gt nu lz nv bn nw nx bi"><span id="c173" class="ny kb in lz b be nz oa l ob oc">async #syncChanges(listKey) {<br/>    try {<br/>        switch (listKey) {<br/>          case this.levels.info:<br/>            if (this.infos.length &gt;= this.logThreshold) {<br/>              await this.saveInfoLogs();<br/>            }<br/>            break;<br/>          case this.levels.error:<br/>            if (this.errors.length &gt;= this.errorThreshold) {<br/>              await this.saveErrorLogs();<br/>            }<br/>            break;<br/>          case this.levels.warning:<br/>            if (this.warnings.length &gt;= this.warningThreshold) {<br/>              await this.saveWarningLogs();<br/>            }<br/>            break;<br/>          default:<br/>            break;<br/>        }<br/>    } catch (error) {<br/>        console.error(error)<br/>        console.log('==')<br/>        console.error(error.message)<br/>        this.error({<br/>          message: error.message,<br/>          critical: 1,<br/>        })<br/>    }<br/>  }</span></pre><p id="bb82" class="pw-post-body-paragraph ky kz in la b lb ma ld le lf mb lh li lj mc ll lm ln md lp lq lr me lt lu lv ig bi translated">现在我们将公开将在应用程序中使用的方法，该方法可以接受string或JSON对象作为输入</p><pre class="nn no np nq gt nu lz nv bn nw nx bi"><span id="620b" class="ny kb in lz b be nz oa l ob oc">info(payload) {<br/>    this.infos.push(this.#createEntry(payload, this.levels.info));<br/>    this.#syncChanges(this.levels.info)<br/>}<br/>error(payload) {<br/>  const isString = typeof payload === "string"<br/>  const error = isString ? new Error(payload) : payload.err ?? payload.error ?? new Error(payload.message);<br/>  convertErrorToGoodFormat(error);<br/>  const customizedPayload = isString ? { error, message: payload } : { ...payload, error } <br/>  this.errors.push(this.#createEntry(convertPayloadToErrorJson(customizedPayload), this.levels.error));<br/>  this.#syncChanges(this.levels.error)<br/>}<br/>warn(payload) {<br/>  this.warnings.push(this.#createEntry(payload, this.levels.warning));<br/>  this.#syncChanges(this.levels.warning)<br/>}</span></pre><p id="32b4" class="pw-post-body-paragraph ky kz in la b lb ma ld le lf mb lh li lj mc ll lm ln md lp lq lr me lt lu lv ig bi translated">最终的代码看起来像这样，我们可以用它来创建应用程序日志的实例</p><figure class="nn no np nq gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi od"><img src="../Images/077f58538dc1efc373d46f3a9a0d590d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pn9-6Iwk5IYnNETmFoy1-A.png"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk">Logger.js</figcaption></figure><h2 id="76f4" class="mf kb in bd kc mg mh dn kg mi mj dp kk lj mk ml ko ln mm mn ks lr mo mp kw mq bi translated">结论</h2><p id="9436" class="pw-post-body-paragraph ky kz in la b lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv ig bi translated">现在我们有了一个日志类，我们可以使用实例来存储日志。您可以在整个应用程序中分发单个实例，也可以为每个功能创建单独的实例。为了测试这个特性，让我们用它来连接数据库</p><figure class="nn no np nq gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi od"><img src="../Images/d5ed8f73877f30b1abc2f99e45ca3224.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PbE1sA4fvNDGFFsb_yhBlQ.png"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk">Testing</figcaption></figure><p id="39d4" class="pw-post-body-paragraph ky kz in la b lb ma ld le lf mb lh li lj mc ll lm ln md lp lq lr me lt lu lv ig bi translated">这将按预期工作。您可以在<a class="ae jz" href="https://github.com/Piyush-Use-Personal/mongoose-logger" rel="noopener ugc nofollow" target="_blank">mongose logger</a>资源库中找到源代码。编码快乐！</p><h2 id="0e5b" class="mf kb in bd kc mg mh dn kg mi mj dp kk lj mk ml ko ln mm mn ks lr mo mp kw mq bi translated">更多内容请访问<a class="ae jz" href="https://plainenglish.io/" rel="noopener ugc nofollow" target="_blank"> PlainEnglish.io </a>。</h2><p id="e8a0" class="pw-post-body-paragraph ky kz in la b lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv ig bi translated"><em class="ni">报名参加我们的</em> <a class="ae jz" href="http://newsletter.plainenglish.io/" rel="noopener ugc nofollow" target="_blank"> <strong class="la io"> <em class="ni">免费每周简讯</em> </strong> </a> <em class="ni">。关注我们关于</em> <a class="ae jz" href="https://twitter.com/inPlainEngHQ" rel="noopener ugc nofollow" target="_blank"> <strong class="la io"> <em class="ni">推特</em> </strong> </a>，<a class="ae jz" href="https://www.linkedin.com/company/inplainenglish/" rel="noopener ugc nofollow" target="_blank"> <strong class="la io"> <em class="ni">领英</em> </strong> </a> <strong class="la io"> <em class="ni">，</em></strong><a class="ae jz" href="https://www.youtube.com/channel/UCtipWUghju290NWcn8jhyAw" rel="noopener ugc nofollow" target="_blank"><strong class="la io"><em class="ni">YouTube</em></strong></a><strong class="la io"><em class="ni">，以及</em></strong><em class="ni"/><a class="ae jz" href="https://discord.gg/GtDtUAvyhW" rel="noopener ugc nofollow" target="_blank"><strong class="la io"><em class="ni">不和</em> </strong> </a> </p><h2 id="9278" class="mf kb in bd kc mg mh dn kg mi mj dp kk lj mk ml ko ln mm mn ks lr mo mp kw mq bi translated">想扩大你的软件创业规模吗？检查<a class="ae jz" href="https://circuit.ooo/?utm=publication-post-cta" rel="noopener ugc nofollow" target="_blank">电路</a>。</h2></div></div>    
</body>
</html>