<html>
<head>
<title>Putting Things Together — CI/CD Pipeline for GatsbyJS Page</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">将东西放在一起GatsbyJS页面的CI/CD管道</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/putting-things-together-ci-cd-pipeline-for-gatsbyjs-page-870f68151b77?source=collection_archive---------10-----------------------#2022-12-21">https://javascript.plainenglish.io/putting-things-together-ci-cd-pipeline-for-gatsbyjs-page-870f68151b77?source=collection_archive---------10-----------------------#2022-12-21</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><figure class="im in gp gr io ip gh gi paragraph-image"><div role="button" tabindex="0" class="iq ir di is bf it"><div class="gh gi il"><img src="../Images/8c03f18dad4eea72d45273881420e4c6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*j2vfE-5NwthbJ3yC"/></div></div><figcaption class="iw ix gj gh gi iy iz bd b be z dk">Photo by <a class="ae ja" href="https://unsplash.com/@markusspiske?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Markus Spiske</a> on <a class="ae ja" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><div class=""/><p id="4b55" class="pw-post-body-paragraph ka kb jd kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">我邀请你和我一起体验一下GatsbyJS框架，结合Auth0认证服务，用CodeceptJS进行端到端测试。通过基于GitHub动作的CI/CD管道，所有东西都变得活跃起来，将页面交付给Gatsby Cloud。</p><p id="44b2" class="pw-post-body-paragraph ka kb jd kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">由于这样一个实验的范围可以很容易地从一篇博客文章变成书籍材料，我将触及每一篇文章的最基本部分。我将把重点放在把事情联系在一起，形成一个可行的概念证明，作为进一步实验的基础。我的主要目标是了解整个系统如何以最少的功能作为完全集成的堆栈协同工作。</p><p id="a392" class="pw-post-body-paragraph ka kb jd kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">尽管我使用了上面提到的框架和服务，这里的想法应该很容易适用于任何其他类型的网页——认证服务here测试设置。</p><p id="ece0" class="pw-post-body-paragraph ka kb jd kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">你可以在这个回购里找到一个<a class="ae ja" href="https://github.com/jploskonka/gatsby-auth0-codeceptjs" rel="noopener ugc nofollow" target="_blank">的工作实例。</a></p><h1 id="d73c" class="ky kz jd bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">Auth0设置</h1><p id="db45" class="pw-post-body-paragraph ka kb jd kc b kd lw kf kg kh lx kj kk kl ly kn ko kp lz kr ks kt ma kv kw kx ig bi translated">让我们从三个不同的Auth0租户(开发、测试、生产)开始，每个租户都有一个应用程序。</p><p id="f484" class="pw-post-body-paragraph ka kb jd kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">在开发和测试中，只允许他们使用用户名/密码登录方法。在生产，这将是谷歌，但没有用户名/密码。这将带来一个额外的挑战去解决，开启了一个有趣的解决方案的可能性。当您无法让测试环境100%模拟生产环境时，您如何确保生产环境仍然正常运行？但是，让我们暂时把它放在一边…</p><p id="ccf0" class="pw-post-body-paragraph ka kb jd kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">为了了解更多关于Auth0租户的信息，我邀请您查看文档。正如它所说:</p><blockquote class="mb mc md"><p id="fc36" class="ka kb me kc b kd ke kf kg kh ki kj kk mf km kn ko mg kq kr ks mh ku kv kw kx ig bi translated">一切都始于Auth0租户。</p></blockquote><p id="9323" class="pw-post-body-paragraph ka kb jd kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">登录到您的Auth0帐户(<a class="ae ja" href="https://auth0.com/signup" rel="noopener ugc nofollow" target="_blank">或创建一个</a>)并从顶部栏的下拉菜单中选择<code class="fe mi mj mk ml b">Create tenant</code>选项。</p><figure class="mn mo mp mq gt ip gh gi paragraph-image"><div class="gh gi mm"><img src="../Images/c570c61826412fb6964ec46583f2ccce.png" data-original-src="https://miro.medium.com/v2/resize:fit:762/format:webp/1*3emf7zMBdOOMA0g0AF56YA.jpeg"/></div></figure><p id="d84f" class="pw-post-body-paragraph ka kb jd kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">让我们创建三个租户，使用以下域和环境标记:</p><ul class=""><li id="541b" class="mr ms jd kc b kd ke kh ki kl mt kp mu kt mv kx mw mx my mz bi translated">带有环境标签<code class="fe mi mj mk ml b">Development</code>的域名<code class="fe mi mj mk ml b">gatsby-auth0-codecept-dev</code></li><li id="f7b4" class="mr ms jd kc b kd na kh nb kl nc kp nd kt ne kx mw mx my mz bi translated">带环境标签的域名<code class="fe mi mj mk ml b">gatsby-auth0-codecept-test</code><code class="fe mi mj mk ml b">Staging</code></li><li id="b9fd" class="mr ms jd kc b kd na kh nb kl nc kp nd kt ne kx mw mx my mz bi translated">带有环境标签<code class="fe mi mj mk ml b">Production</code>的域<code class="fe mi mj mk ml b">gatsby-auth0-codecept-prod</code></li></ul><p id="dcf7" class="pw-post-body-paragraph ka kb jd kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">现在，对于每一个租户，我们都需要一个应用程序。从<code class="fe mi mj mk ml b">Development</code>一个开始。确保您使用下拉菜单中的<code class="fe mi mj mk ml b">Switch tenant</code>选项选择了合适的租户。然后在左侧菜单中选择<code class="fe mi mj mk ml b">Applications</code></p><figure class="mn mo mp mq gt ip gh gi paragraph-image"><div class="gh gi nf"><img src="../Images/c3c099108284bc401b41b02b8efeafd5.png" data-original-src="https://miro.medium.com/v2/resize:fit:620/format:webp/1*Y97VyT4w6W8t7CavTNiMVQ.jpeg"/></div></figure><p id="08e8" class="pw-post-body-paragraph ka kb jd kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><code class="fe mi mj mk ml b">Default app</code>已经在列表中，从下拉菜单中选择<code class="fe mi mj mk ml b">Settings</code>即可。</p><figure class="mn mo mp mq gt ip gh gi paragraph-image"><div role="button" tabindex="0" class="iq ir di is bf it"><div class="gh gi ng"><img src="../Images/9fa35e3840bb2e95c8067668317003db.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*EEycPhe0omTAHUhufsqHFg.jpeg"/></div></div></figure><p id="0a64" class="pw-post-body-paragraph ka kb jd kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">这里需要做一些改动:</p><ul class=""><li id="b5f4" class="mr ms jd kc b kd ke kh ki kl mt kp mu kt mv kx mw mx my mz bi translated">把应用程序的名字改成有意义的，对我来说是<code class="fe mi mj mk ml b">Gatsby Auth0 Codecept Dev</code>。</li><li id="4832" class="mr ms jd kc b kd na kh nb kl nc kp nd kt ne kx mw mx my mz bi translated">你会在名字下面找到<code class="fe mi mj mk ml b">Domain</code>和<code class="fe mi mj mk ml b">Client ID</code>字段。我们以后再去找他们。</li><li id="100c" class="mr ms jd kc b kd na kh nb kl nc kp nd kt ne kx mw mx my mz bi translated">然后在<code class="fe mi mj mk ml b">Application Type</code>中选择<code class="fe mi mj mk ml b">Single Page Application</code>。</li><li id="e262" class="mr ms jd kc b kd na kh nb kl nc kp nd kt ne kx mw mx my mz bi translated">在<code class="fe mi mj mk ml b">Application URIs</code>部分输入以下内容:<br/> —应用程序登录URI:留空<br/> —允许的回调URL:<code class="fe mi mj mk ml b"><a class="ae ja" href="http://localhost:8000`" rel="noopener ugc nofollow" target="_blank">http://localhost:8000</a></code><br/>—允许的注销URL:<code class="fe mi mj mk ml b"><a class="ae ja" href="http://localhost:8000`" rel="noopener ugc nofollow" target="_blank">http://localhost:8000</a></code><br/>—允许的web源:<code class="fe mi mj mk ml b"><a class="ae ja" href="http://localhost:8000`" rel="noopener ugc nofollow" target="_blank">http://localhost:8000</a></code></li></ul><p id="1d38" class="pw-post-body-paragraph ka kb jd kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">点击底部的<code class="fe mi mj mk ml b">Save changes</code>按钮。</p><h2 id="b42c" class="nh kz jd bd la ni nj dn le nk nl dp li kl nm nn lm kp no np lq kt nq nr lu ns bi translated">禁用通过Google登录</h2><p id="ab39" class="pw-post-body-paragraph ka kb jd kc b kd lw kf kg kh lx kj kk kl ly kn ko kp lz kr ks kt ma kv kw kx ig bi translated">我们在开发中不需要这个，再加上我想在<code class="fe mi mj mk ml b">dev</code> &amp; <code class="fe mi mj mk ml b">production</code>环境中有一些区别。转到<code class="fe mi mj mk ml b">Connections</code>选项卡，并解开<code class="fe mi mj mk ml b">google-oauth2</code></p><figure class="mn mo mp mq gt ip gh gi paragraph-image"><div role="button" tabindex="0" class="iq ir di is bf it"><div class="gh gi nt"><img src="../Images/f649dc8f42d70fc42103c41dd40a466a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*M9lq-vRgZ4tLmDk8RF7Hpg.jpeg"/></div></div></figure><h2 id="a5ba" class="nh kz jd bd la ni nj dn le nk nl dp li kl nm nn lm kp no np lq kt nq nr lu ns bi translated">测试用户</h2><p id="eea6" class="pw-post-body-paragraph ka kb jd kc b kd lw kf kg kh lx kj kk kl ly kn ko kp lz kr ks kt ma kv kw kx ig bi translated">转到左侧菜单中的<code class="fe mi mj mk ml b">User Management -&gt; Users</code>，然后转到<code class="fe mi mj mk ml b">Create user</code>。输入凭证，点击<code class="fe mi mj mk ml b">create</code>。</p><figure class="mn mo mp mq gt ip gh gi paragraph-image"><div role="button" tabindex="0" class="iq ir di is bf it"><div class="gh gi nt"><img src="../Images/721ed3e5ab7d21b4ea7de587aca91ef9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tRUh-EHDsdnn4DmJ9G4jww.jpeg"/></div></div></figure><p id="fa6e" class="pw-post-body-paragraph ka kb jd kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">然后点击<code class="fe mi mj mk ml b">Change email</code>选项和<code class="fe mi mj mk ml b">Set email as verified</code>。</p><h2 id="9e00" class="nh kz jd bd la ni nj dn le nk nl dp li kl nm nn lm kp no np lq kt nq nr lu ns bi translated">设置<em class="nu">-测试</em>租户</h2><p id="1480" class="pw-post-body-paragraph ka kb jd kc b kd lw kf kg kh lx kj kk kl ly kn ko kp lz kr ks kt ma kv kw kx ig bi translated">整个过程需要重复，只有一点不同URLs中使用的端口将是<code class="fe mi mj mk ml b">9000</code>而不是<code class="fe mi mj mk ml b">8000</code>，所以:</p><ul class=""><li id="bf1d" class="mr ms jd kc b kd ke kh ki kl mt kp mu kt mv kx mw mx my mz bi translated">应用名称:<code class="fe mi mj mk ml b">Gatsby Auth0 Codecept Test</code>。</li><li id="03c8" class="mr ms jd kc b kd na kh nb kl nc kp nd kt ne kx mw mx my mz bi translated">然后在<code class="fe mi mj mk ml b">Application Type</code>中选择<code class="fe mi mj mk ml b">Single Page Application</code>。</li><li id="7594" class="mr ms jd kc b kd na kh nb kl nc kp nd kt ne kx mw mx my mz bi translated">在<code class="fe mi mj mk ml b">Application URIs</code>部分输入以下内容:<br/> —应用程序登录URI:留空<br/> —允许的回调URL:<code class="fe mi mj mk ml b"><a class="ae ja" href="http://localhost:8000`" rel="noopener ugc nofollow" target="_blank">http://localhost:9000</a></code><br/>—允许的注销URL:<code class="fe mi mj mk ml b"><a class="ae ja" href="http://localhost:8000`" rel="noopener ugc nofollow" target="_blank">http://localhost:9000</a></code><br/>—允许的web源:<code class="fe mi mj mk ml b"><a class="ae ja" href="http://localhost:8000`" rel="noopener ugc nofollow" target="_blank">http://localhost:9000</a></code></li><li id="0336" class="mr ms jd kc b kd na kh nb kl nc kp nd kt ne kx mw mx my mz bi translated">google-oauth2已禁用</li><li id="c357" class="mr ms jd kc b kd na kh nb kl nc kp nd kt ne kx mw mx my mz bi translated">记得创建一个测试用户，使用与<code class="fe mi mj mk ml b">dev</code>不同的凭证</li></ul><h2 id="a8c8" class="nh kz jd bd la ni nj dn le nk nl dp li kl nm nn lm kp no np lq kt nq nr lu ns bi translated">设置“生产”租户</h2><p id="92ac" class="pw-post-body-paragraph ka kb jd kc b kd lw kf kg kh lx kj kk kl ly kn ko kp lz kr ks kt ma kv kw kx ig bi translated">这将在以后，因为我们还不知道网址。</p><h1 id="4e7a" class="ky kz jd bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">GatsbyJS设置</h1><p id="8126" class="pw-post-body-paragraph ka kb jd kc b kd lw kf kg kh lx kj kk kl ly kn ko kp lz kr ks kt ma kv kw kx ig bi translated">使用他们最简单的入门模板创建一个新的gatsby项目:</p><pre class="mn mo mp mq gt nv ml nw bn nx ny bi"><span id="a4bf" class="nz kz jd ml b be oa ob l oc od">$ npm init gatsby</span></pre><p id="b917" class="pw-post-body-paragraph ka kb jd kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">脚本会询问你应用程序的名称，存储代码库的目录，如果你想使用JavaScript或TypeScript，如果你想获得任何额外的功能或插件。我将使用JavaScript，不添加任何内容。</p><figure class="mn mo mp mq gt ip gh gi paragraph-image"><div role="button" tabindex="0" class="iq ir di is bf it"><div class="gh gi oe"><img src="../Images/ef80514c65464d169789cd813741fee6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PEVdNDZSH6QIFIaYOlClJw.jpeg"/></div></div></figure><p id="0479" class="pw-post-body-paragraph ka kb jd kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">好了，让我们进入创建的目录，看看那里有什么:</p><pre class="mn mo mp mq gt nv ml nw bn nx ny bi"><span id="03c3" class="nz kz jd ml b be oa ob l oc od">$ cd gatsby-auth0codecept<br/>$ tree -CI 'node_modules' # -C for colors, -I for ignore<br/># output:<br/>.<br/>├── README.md<br/>├── gatsby-config.js<br/>├── package-lock.json<br/>├── package.json<br/>└── src<br/> ├── images<br/> │ └── icon.png<br/> └── pages<br/> ├── 404.js<br/> └── index.js<br/>3 directories, 7 files</span></pre><p id="8cbe" class="pw-post-body-paragraph ka kb jd kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">我想你不能再简单了。两页(<code class="fe mi mj mk ml b">index.js</code>和<code class="fe mi mj mk ml b">404.js</code>)，一张图片(<code class="fe mi mj mk ml b">icon.png</code>)，基本<code class="fe mi mj mk ml b">gatsby-config.js</code>。</p><p id="326b" class="pw-post-body-paragraph ka kb jd kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">让我们现在运行它，并在web浏览器中查看它:</p><pre class="mn mo mp mq gt nv ml nw bn nx ny bi"><span id="f2eb" class="nz kz jd ml b be oa ob l oc od">$ npm run develop<br/># now open localhost:8000 in your browser</span></pre><p id="8dd1" class="pw-post-body-paragraph ka kb jd kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">您将看到一个包含大量链接的页面:</p><figure class="mn mo mp mq gt ip gh gi paragraph-image"><div class="gh gi of"><img src="../Images/774c36461d9fefa804405a1f133b136b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1360/format:webp/1*k-J6UBt9myHlMQQVZYcyww.jpeg"/></div></figure><p id="ea61" class="pw-post-body-paragraph ka kb jd kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">它非常简洁漂亮，但是对于这个例子来说，它仍然有多余的代码。让我们把<code class="fe mi mj mk ml b">frontend/src/pages/index.js</code>文件变成一个更简单的形式:</p><pre class="mn mo mp mq gt nv ml nw bn nx ny bi"><span id="6e07" class="nz kz jd ml b be oa ob l oc od">import * as React from "react"<br/><br/>const IndexPage = () =&gt; {<br/>  return (<br/>    &lt;main&gt;<br/>      &lt;h1&gt;<br/>        Hello world<br/>      &lt;/h1&gt;<br/>    &lt;/main&gt;<br/>  )<br/>}<br/><br/>export default IndexPage</span></pre><figure class="mn mo mp mq gt ip gh gi paragraph-image"><div role="button" tabindex="0" class="iq ir di is bf it"><div class="gh gi og"><img src="../Images/75bb8dbe746eddb8248d9271aaf8ac6c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UoaRMihNYdJwmLlTggTlcg.png"/></div></div></figure><p id="7549" class="pw-post-body-paragraph ka kb jd kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><strong class="kc je">好多了！</strong></p><h1 id="838f" class="ky kz jd bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">CodeceptJS安装程序</h1><p id="3e82" class="pw-post-body-paragraph ka kb jd kc b kd lw kf kg kh lx kj kk kl ly kn ko kp lz kr ks kt ma kv kw kx ig bi translated">让我们用高层次的规范来描述对页面进化的渴望。从添加<code class="fe mi mj mk ml b">codeceptjs </code>和<code class="fe mi mj mk ml b">playwright</code>依赖项开始。</p><p id="0e61" class="pw-post-body-paragraph ka kb jd kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">这里出现的第一个问题是——端到端测试放在哪里？在单个应用程序的世界中，最常见的方法是将它们放在应用程序所在的根目录中。将依赖关系放在同一个<code class="fe mi mj mk ml b">package.json</code>文件中，并将测试和web应用程序视为一件事情。</p><p id="b7f9" class="pw-post-body-paragraph ka kb jd kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">这种方法非常适合这个演示规模的项目。考虑到现实世界，我建议将测试和应用程序视为独立的个体。有一组独立的依赖项，甚至可能存在于由不同团队维护的独立存储库中。</p><p id="8d20" class="pw-post-body-paragraph ka kb jd kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">我不会在这里进行单独的回购(端到端测试的多回购设置是一个值得单独发布的主题)，但我将用两个主要目录来构建项目:<code class="fe mi mj mk ml b">frontend</code>和<code class="fe mi mj mk ml b">e2e</code>。</p><p id="455d" class="pw-post-body-paragraph ka kb jd kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">从把盖茨比应用程序移到<code class="fe mi mj mk ml b">frontend</code>目录开始:</p><pre class="mn mo mp mq gt nv ml nw bn nx ny bi"><span id="57c4" class="nz kz jd ml b be oa ob l oc od">$ mkdir frontend<br/>$ mv * frontend # move all visible files<br/>$ mv .cache .gitignore frontend # move hidden files too</span></pre><p id="8aa2" class="pw-post-body-paragraph ka kb jd kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">并在<code class="fe mi mj mk ml b">e2e</code>目录中设置CodeceptJS:</p><pre class="mn mo mp mq gt nv ml nw bn nx ny bi"><span id="e773" class="nz kz jd ml b be oa ob l oc od">$ mkdir e2e<br/>$ cd e2e<br/>$ npm init -y # initialize npm package<br/>$ npm add codeceptjs playwright<br/>$ npx codeceptjs init</span></pre><p id="4048" class="pw-post-body-paragraph ka kb jd kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">最后一个命令让您获得一个交互式项目启动器，类似于我们在GatsbyJS中看到的。它会问你一堆选择:</p><ul class=""><li id="245b" class="mr ms jd kc b kd ke kh ki kl mt kp mu kt mv kx mw mx my mz bi translated">JS vs TS:这里用JS</li><li id="0cb2" class="mr ms jd kc b kd na kh nb kl nc kp nd kt ne kx mw mx my mz bi translated">测试位置:按<code class="fe mi mj mk ml b">Enter</code>获得默认值</li><li id="eb43" class="mr ms jd kc b kd na kh nb kl nc kp nd kt ne kx mw mx my mz bi translated">要使用的助手:选择<code class="fe mi mj mk ml b">Playwright</code></li><li id="0ea7" class="mr ms jd kc b kd na kh nb kl nc kp nd kt ne kx mw mx my mz bi translated">对于日志、截图和报告位置:按<code class="fe mi mj mk ml b">Enter</code>获取默认值</li><li id="4ba5" class="mr ms jd kc b kd na kh nb kl nc kp nd kt ne kx mw mx my mz bi translated">待测试页面的网址:<code class="fe mi mj mk ml b"><a class="ae ja" href="http://localhost:8000`" rel="noopener ugc nofollow" target="_blank">http://localhost:8000</a></code></li><li id="5244" class="mr ms jd kc b kd na kh nb kl nc kp nd kt ne kx mw mx my mz bi translated">显示浏览器窗口:<code class="fe mi mj mk ml b">Yes</code></li><li id="ce96" class="mr ms jd kc b kd na kh nb kl nc kp nd kt ne kx mw mx my mz bi translated">我们测试的浏览器:<code class="fe mi mj mk ml b">chromium</code>很好</li></ul><p id="a83e" class="pw-post-body-paragraph ka kb jd kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">在初始设置之后，将会出现关于第一个要测试的特性的问题。我将使用<code class="fe mi mj mk ml b">User authentication</code>和测试的默认文件名— <code class="fe mi mj mk ml b">User_authentication_test.js</code>。</p><p id="cf65" class="pw-post-body-paragraph ka kb jd kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">让我们看看我们从发电机里得到了什么:</p><pre class="mn mo mp mq gt nv ml nw bn nx ny bi"><span id="d211" class="nz kz jd ml b be oa ob l oc od">$ ls -l | awk { 'print $9' } # print out filenames only<br/><br/># output:<br/>User_authentication_test.js<br/>codecept.conf.js<br/>jsconfig.json<br/>node_modules<br/>output<br/>package-lock.json<br/>package.json<br/>steps.d.ts<br/>steps_file.js</span></pre><p id="552b" class="pw-post-body-paragraph ka kb jd kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">有道理，我要稍微清理一下:</p><pre class="mn mo mp mq gt nv ml nw bn nx ny bi"><span id="3f42" class="nz kz jd ml b be oa ob l oc od">$ rm jsconfig.json steps.d.ts steps_file.js # I won't use those files anyway<br/>$ mkdir tests # I don't like `_test.js` files living in root dir<br/>$ mv User_authentication_test.js tests</span></pre><p id="b4cf" class="pw-post-body-paragraph ka kb jd kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">同时添加<code class="fe mi mj mk ml b">dotenv</code>包，从<code class="fe mi mj mk ml b">.env</code>文件中读取环境变量。我们将把用户凭证指定为env变量，这样会使开发体验稍微好一点。</p><pre class="mn mo mp mq gt nv ml nw bn nx ny bi"><span id="69ea" class="nz kz jd ml b be oa ob l oc od">$ npm install dotenv</span></pre><p id="bd73" class="pw-post-body-paragraph ka kb jd kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">之后<code class="fe mi mj mk ml b">codecept.conf.js</code>需要一些调整:</p><pre class="mn mo mp mq gt nv ml nw bn nx ny bi"><span id="7a6c" class="nz kz jd ml b be oa ob l oc od">// ...<br/>// Gatsby comes with `dotenv` setup out of the box, <br/>// codecept needs this line to pick up `.env` files<br/>require('dotenv').config();<br/><br/>exports.config = {<br/> // this changed to include `tests` directory<br/>  tests: './tests/*_test.js', <br/>  output: './output',<br/>  helpers: {<br/>    Playwright: {<br/>      // URL will differ in CI, so let's have a way to customize it<br/>      url: process.env.TEST_PAGE_URL || 'http://localhost:8000',<br/>      show: true,<br/>      browser: 'chromium',<br/>      waitForTimeout: 5000, // increase from default 1s<br/>    }<br/>  },<br/>  include: { <br/>    // steps_file is removed<br/>  },<br/>  name: 'e2e'<br/>}</span></pre><h2 id="bc12" class="nh kz jd bd la ni nj dn le nk nl dp li kl nm nn lm kp no np lq kt nq nr lu ns bi translated">TDD用户认证</h2><p id="22f2" class="pw-post-body-paragraph ka kb jd kc b kd lw kf kg kh lx kj kk kl ly kn ko kp lz kr ks kt ma kv kw kx ig bi translated">打开<code class="fe mi mj mk ml b">User_authentication_test.js</code>文件，描述认证是如何工作的:</p><pre class="mn mo mp mq gt nv ml nw bn nx ny bi"><span id="f2ee" class="nz kz jd ml b be oa ob l oc od">Feature('User authentication');<br/><br/>// URLs that will be used in tests. I don't like using URLs directly in tests,<br/>// for both readability and changeability<br/>const rootUrl = '/'<br/>const afterLoginUrl = '/'<br/>const afterLogoutUrl = '/'<br/><br/>// I'll need to have some user credentials to test authentication with.<br/>// This may differ in dev/test environments so will be provided<br/>// as environment variables<br/>const user = {<br/>  login: process.env.TEST_USER_LOGIN,<br/>  pass: process.env.TEST_USER_PASS<br/>}<br/><br/>// In real world this function would either live in a custom steps file,<br/>// or in some page object file. For this example, I'll keep it here.<br/>const login = async (I, user) =&gt; {<br/>  const acceptBtn = `button[value=accept]`<br/><br/>  I.click(`Log in`)<br/>  I.fillField(`username`, user.login)<br/>  I.fillField(`password`, secret(user.pass))<br/>  I.click(`Continue`)<br/><br/>  // when user logs in for the first time with Auth0 account, they need to<br/>  // authorize the app to access their account.<br/>  const needsAuthorization = await I.grabNumberOfVisibleElements(acceptBtn) &gt; 0<br/>  if (needsAuthorization) { I.click(acceptBtn) }<br/><br/>  I.waitForText(`Log out`) // wait for page to load<br/>}<br/><br/>// Scenario messages in such a test are perfect documentation of the project.<br/>// Don't be afraid to get verbose here.<br/>Scenario(`User logs in and lands on ${afterLoginUrl} page.`, async ({ I }) =&gt; {<br/>  I.amOnPage(rootUrl)<br/>  await login(I, user)<br/><br/>  I.see(user.login)<br/>  I.seeCurrentUrlEquals(afterLoginUrl)<br/>})<br/><br/>// One may say let's have this as one scenario where a user logs in, then logs<br/>// out. It could work out, but if such a scenario fails it's hard to identify<br/>// which part is broken.<br/>Scenario(`User logs out and lands on ${afterLogoutUrl}`, async ({ I }) =&gt; {<br/>  I.amOnPage(rootUrl)<br/>  await login(I, user)<br/><br/>  I.click(`Log out`)<br/>  I.waitForText(`Log in`)<br/>  I.seeCurrentUrlEquals(afterLogoutUrl)<br/>  I.dontSee(user.login)<br/>})</span></pre><p id="32a9" class="pw-post-body-paragraph ka kb jd kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">然后将Auth0中创建的用户的凭证放入<code class="fe mi mj mk ml b">e2e/.env</code>文件中:</p><pre class="mn mo mp mq gt nv ml nw bn nx ny bi"><span id="d42f" class="nz kz jd ml b be oa ob l oc od">TEST_USER_LOGIN=dev-user@example.com<br/>TEST_USER_PASS=dev-user-password</span></pre><p id="68cc" class="pw-post-body-paragraph ka kb jd kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">注意:对于GatsbyJS，这个文件叫做<code class="fe mi mj mk ml b">.env.development</code>，这里只是<code class="fe mi mj mk ml b">.env</code>。</p><p id="9281" class="pw-post-body-paragraph ka kb jd kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">重述登录—用户打开一个页面并点击<code class="fe mi mj mk ml b">Log in</code>按钮。然后输入他们的凭证，我们期待重定向回来。此外，他们的电子邮件现在应该是可见的，连同<code class="fe mi mj mk ml b">Log out</code>按钮。</p><p id="ea7f" class="pw-post-body-paragraph ka kb jd kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">注销——流程以同样的方式开始，因此用户打开页面，<em class="me">登录</em>。然后点击<code class="fe mi mj mk ml b">Log out</code>按钮。现在，应该不会再看到他们的电子邮件，应该会出现<code class="fe mi mj mk ml b">Log in</code>按钮。</p><p id="516d" class="pw-post-body-paragraph ka kb jd kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">确保您的Gatsby dev服务器运行在<code class="fe mi mj mk ml b">frontend</code>目录中，并运行测试。</p><pre class="mn mo mp mq gt nv ml nw bn nx ny bi"><span id="cec3" class="nz kz jd ml b be oa ob l oc od"># in frontend dir<br/>$ npm run develop<br/># in e2e dir<br/>$ npx codeceptjs run --steps</span></pre><p id="5f28" class="pw-post-body-paragraph ka kb jd kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">浏览器会闪烁一会儿，这两个场景都会失败，因为页面上缺少了<code class="fe mi mj mk ml b">Log in</code>链接。让我们修理它。</p><h1 id="2a44" class="ky kz jd bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">把东西放在一起</h1><p id="63ad" class="pw-post-body-paragraph ka kb jd kc b kd lw kf kg kh lx kj kk kl ly kn ko kp lz kr ks kt ma kv kw kx ig bi translated">使这些测试变绿的最小页面，在<code class="fe mi mj mk ml b">frontend/src/pages/index.js</code>中:</p><pre class="mn mo mp mq gt nv ml nw bn nx ny bi"><span id="33a5" class="nz kz jd ml b be oa ob l oc od">import * as React from "react"<br/>import { useAuth0 } from "@auth0/auth0-react"<br/><br/>const IndexPage = () =&gt; {<br/>  // line below is added<br/>  const { loginWithRedirect, isAuthenticated, user, logout } = useAuth0()<br/><br/>  return (<br/>    &lt;main&gt;<br/>      &lt;h1&gt;<br/>        Hello world<br/>      &lt;/h1&gt;<br/>      <br/>      // below block is added<br/>      { isAuthenticated ? <br/>        &lt;div&gt;<br/>          {user.email}&lt;br /&gt;<br/>          &lt;button onClick={() =&gt; logout({ returnTo: window.location.origin })}&gt;<br/>            Log out<br/>          &lt;/button&gt;<br/>        &lt;/div&gt;<br/>        :<br/>        &lt;button onClick={() =&gt; loginWithRedirect()}&gt;<br/>          Log in<br/>        &lt;/button&gt;<br/>      }<br/>    &lt;/main&gt;<br/>  )<br/>}<br/><br/>export default IndexPage</span></pre><p id="eff5" class="pw-post-body-paragraph ka kb jd kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">当然，要实现这一点，我们需要在<code class="fe mi mj mk ml b">frontend</code>应用中添加<code class="fe mi mj mk ml b">@auth0/auth0-react</code>包:</p><pre class="mn mo mp mq gt nv ml nw bn nx ny bi"><span id="473c" class="nz kz jd ml b be oa ob l oc od">$ npm install @auth0/auth0-react</span></pre><p id="8247" class="pw-post-body-paragraph ka kb jd kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">页面也需要用<code class="fe mi mj mk ml b">Auth0Provider</code>包裹，所以添加<code class="fe mi mj mk ml b">frontend/gatsby-browser.js</code>文件:</p><pre class="mn mo mp mq gt nv ml nw bn nx ny bi"><span id="2729" class="nz kz jd ml b be oa ob l oc od">import React from "react";<br/>import { Auth0Provider } from "@auth0/auth0-react";<br/>import { navigate } from "gatsby";<br/><br/>const onRedirectCallback = (appState) =&gt; {<br/>  navigate(`/user`);<br/>}<br/><br/>export const wrapRootElement = ({ element }) =&gt; (<br/>  &lt;Auth0Provider<br/>    domain={process.env.GATSBY_AUTH0_DOMAIN}<br/>    clientId={process.env.GATSBY_AUTH0_CLIENT_ID}<br/>    redirectUri={window.location.origin}<br/>    onRedirectCallback={onRedirectCallback}<br/>  &gt;<br/>    {element}<br/>  &lt;/Auth0Provider&gt;<br/>)</span></pre><p id="6da7" class="pw-post-body-paragraph ka kb jd kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">并添加具有Auth0域&amp;客户端ID的<code class="fe mi mj mk ml b">frontend/.env.development</code>文件:</p><pre class="mn mo mp mq gt nv ml nw bn nx ny bi"><span id="0e0b" class="nz kz jd ml b be oa ob l oc od">GATSBY_AUTH0_DOMAIN="foo"<br/>GATSBY_AUTH0_CLIENT_ID="bar"</span></pre><p id="14bd" class="pw-post-body-paragraph ka kb jd kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">立即运行测试，享受绿色信息。</p><figure class="mn mo mp mq gt ip gh gi paragraph-image"><div role="button" tabindex="0" class="iq ir di is bf it"><div class="gh gi oh"><img src="../Images/46ae3fd4c33f78cea277f3e37adcc7db.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mxnFpIByD2Fzr0F7giKG_Q.jpeg"/></div></div></figure><h1 id="8cbb" class="ky kz jd bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">设置CI-GitHub操作</h1><p id="03ac" class="pw-post-body-paragraph ka kb jd kc b kd lw kf kg kh lx kj kk kl ly kn ko kp lz kr ks kt ma kv kw kx ig bi translated">创建新的GitHub repo，提交并推送到目前为止创建的代码。确保没有<code class="fe mi mj mk ml b">.env*</code>和其他框架文件在版本控制下:</p><pre class="mn mo mp mq gt nv ml nw bn nx ny bi"><span id="ed1f" class="nz kz jd ml b be oa ob l oc od"># .gitignore <br/>.env*<br/>node_modules/<br/>.cache/<br/>frontend/public<br/>e2e/output</span></pre><p id="05b2" class="pw-post-body-paragraph ka kb jd kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">将git remote添加到repo并推送<code class="fe mi mj mk ml b">main</code>分支:</p><pre class="mn mo mp mq gt nv ml nw bn nx ny bi"><span id="534f" class="nz kz jd ml b be oa ob l oc od">$ git remote add origin git@github.com:REPO_URL_FROM_GITHUB.git<br/>$ git push -u origin main</span></pre><p id="8132" class="pw-post-body-paragraph ka kb jd kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">然后在<code class="fe mi mj mk ml b">.github/workflows/e2e.yml</code>创建GitHub动作配置文件:</p><pre class="mn mo mp mq gt nv ml nw bn nx ny bi"><span id="bac0" class="nz kz jd ml b be oa ob l oc od"># .github/workflows/e2e.yml<br/>name: e2e tests<br/>on:<br/>  push:<br/><br/>env:<br/>  HEADLESS: true<br/>  TEST_PAGE_URL: http://localhost:9000<br/>  TEST_USER_LOGIN: ${{ secrets.TEST_USER_LOGIN }}<br/>  TEST_USER_PASS: ${{ secrets.TEST_USER_PASS }}<br/>  GATSBY_AUTH0_DOMAIN: ${{ secrets.GATSBY_AUTH0_DOMAIN }}<br/>  GATSBY_AUTH0_CLIENT_ID: ${{ secrets.GATSBY_AUTH0_CLIENT_ID }}<br/><br/>jobs:<br/>  test:<br/>    runs-on: ubuntu-latest<br/>    steps:<br/>      - uses: actions/checkout@v2<br/><br/>      - name: setup nodejs<br/>        uses: actions/setup-node@v2<br/>        with:<br/>          node-version: 18.0.0<br/><br/>      - name: frontend - npm install<br/>        working-directory: frontend<br/>        run: npm install<br/><br/>      - name: frontend - build page<br/>        working-directory: frontend<br/>        run: npm run build<br/><br/>      - name: frontend - serve page in the background<br/>        working-directory: frontend<br/>        run: npm run serve &amp;<br/><br/>      - name: e2e - npm install<br/>        working-directory: e2e<br/>        run: npm install<br/><br/>      - name: e2e - run tests<br/>        working-directory: e2e<br/>        run: |<br/>          # wait for webserver to be running before starting tests<br/>          while ! nc -z localhost 9000; do   <br/>            echo "Waiting for webserver..."<br/>            sleep 0.5<br/>          done<br/><br/>          npx codeceptjs run --steps</span></pre><p id="14fa" class="pw-post-body-paragraph ka kb jd kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">并创建要在工作流中使用的存储库机密:</p><figure class="mn mo mp mq gt ip gh gi paragraph-image"><div role="button" tabindex="0" class="iq ir di is bf it"><div class="gh gi oi"><img src="../Images/41ddbfb384b1f301aff1efff5f686d8a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4LMyA-p1HJT6hv-PqvKpkg.jpeg"/></div></div></figure><ul class=""><li id="4729" class="mr ms jd kc b kd ke kh ki kl mt kp mu kt mv kx mw mx my mz bi translated"><code class="fe mi mj mk ml b">TEST_USER_LOGIN</code> &amp; <code class="fe mi mj mk ml b">TEST_USER_PASS</code>:需要匹配在Auth0中为<code class="fe mi mj mk ml b">Test</code>应用程序(<code class="fe mi mj mk ml b">Staging</code>租户)创建的用户凭证</li><li id="45ec" class="mr ms jd kc b kd na kh nb kl nc kp nd kt ne kx mw mx my mz bi translated"><code class="fe mi mj mk ml b">GATSBY_AUTH0_DOMAIN</code> &amp; <code class="fe mi mj mk ml b">GATSBY_AUTH0_CLIENT_ID</code>:需要匹配<code class="fe mi mj mk ml b">Test</code>应用(<code class="fe mi mj mk ml b">Staging</code>租户)</li></ul><figure class="mn mo mp mq gt ip gh gi paragraph-image"><div role="button" tabindex="0" class="iq ir di is bf it"><div class="gh gi oj"><img src="../Images/5237fd107e30c2160d96e7b9648d816f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*IpmcrJTZ8hK1IPT2NVqqOg.jpeg"/></div></div></figure><p id="aa6f" class="pw-post-body-paragraph ka kb jd kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">现在，推动您的更改，打开一个PR，您将得到一个挂起的测试运行。</p><figure class="mn mo mp mq gt ip gh gi paragraph-image"><div role="button" tabindex="0" class="iq ir di is bf it"><div class="gh gi ok"><img src="../Images/398f1fc2e31e745f7fada07cb3357c2b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hLbx44AZAGZXIW14p4Vp9w.jpeg"/></div></div></figure><p id="fea3" class="pw-post-body-paragraph ka kb jd kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">等一下…享受一个绿色标记，合并那个PR。🎉</p><figure class="mn mo mp mq gt ip gh gi paragraph-image"><div role="button" tabindex="0" class="iq ir di is bf it"><div class="gh gi ok"><img src="../Images/33ba16f31bec525193964c14ebc0ea94.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*c5bCrOLKL76rlE8ScTapEg.jpeg"/></div></div></figure><h1 id="a922" class="ky kz jd bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">持续交付给盖茨比云</h1><p id="e933" class="pw-post-body-paragraph ka kb jd kc b kd lw kf kg kh lx kj kk kl ly kn ko kp lz kr ks kt ma kv kw kx ig bi translated">登录<a class="ae ja" href="https://www.gatsbyjs.com/dashboard/sites" rel="noopener ugc nofollow" target="_blank">盖茨比云</a>，点击<code class="fe mi mj mk ml b">Add a site</code>按钮。选择您的回购并点击<code class="fe mi mj mk ml b">Import</code>。</p><figure class="mn mo mp mq gt ip gh gi paragraph-image"><div role="button" tabindex="0" class="iq ir di is bf it"><div class="gh gi ol"><img src="../Images/3c70dbed5b4856d735e6149b3cd647b8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3vz0MgFIljSaSSjdZjbagA.jpeg"/></div></div></figure><p id="c233" class="pw-post-body-paragraph ka kb jd kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">在下一个屏幕中输入<code class="fe mi mj mk ml b">frontend</code>作为盖茨比根文件夹，并跳过<code class="fe mi mj mk ml b">Connect integrations</code>部分。</p><p id="e0d6" class="pw-post-body-paragraph ka kb jd kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">从属于之前在Auth0中创建的<code class="fe mi mj mk ml b">Production</code>租户的app中获取<code class="fe mi mj mk ml b">domain </code>和<code class="fe mi mj mk ml b">clientId</code>。添加<code class="fe mi mj mk ml b">GATSBY_AUTH0_CLIENT_ID</code>和<code class="fe mi mj mk ml b">GATSBY_AUTH0_DOMAIN</code>环境变量并点击<code class="fe mi mj mk ml b">Save</code>。</p><p id="e32c" class="pw-post-body-paragraph ka kb jd kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">只填写<code class="fe mi mj mk ml b">Build variables</code>，忽略<code class="fe mi mj mk ml b">Preview variables</code>部分。</p><figure class="mn mo mp mq gt ip gh gi paragraph-image"><div role="button" tabindex="0" class="iq ir di is bf it"><div class="gh gi om"><img src="../Images/83fa392c20e2c3924d56fb47127d60ce.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hSCeQL0z0jmgt6Bz2ca9qQ.jpeg"/></div></div></figure><p id="e02b" class="pw-post-body-paragraph ka kb jd kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">用<code class="fe mi mj mk ml b">Build site</code>按钮完成设置。创建页面需要几分钟时间，因此现在是调整Auth0应用设置的好时机。</p><ul class=""><li id="8973" class="mr ms jd kc b kd ke kh ki kl mt kp mu kt mv kx mw mx my mz bi translated">更改应用程序名称(在我的例子中是<code class="fe mi mj mk ml b">Gatsby Auth0 Codecept Prod)</code></li><li id="f7ff" class="mr ms jd kc b kd na kh nb kl nc kp nd kt ne kx mw mx my mz bi translated">将<code class="fe mi mj mk ml b">Application Type</code>改为<code class="fe mi mj mk ml b">Single Page Application</code></li><li id="4829" class="mr ms jd kc b kd na kh nb kl nc kp nd kt ne kx mw mx my mz bi translated">对于真正的生产使用，你需要准备一个登录页面，并输入它的URI。我将跳过它(<a class="ae ja" href="https://auth0.com/docs/authenticate/login/auth0-universal-login/configure-default-login-routes" rel="noopener ugc nofollow" target="_blank">查看文档了解更多信息</a>)。</li><li id="a9a9" class="mr ms jd kc b kd na kh nb kl nc kp nd kt ne kx mw mx my mz bi translated">现在，您将在Gatsby Cloud面板中找到您的GatsbyJS站点URL。你可能想看看关于在实际生产中使用定制域的<a class="ae ja" href="https://support.gatsbyjs.com/hc/en-us/articles/360063469873-Adding-a-Custom-Domain" rel="noopener ugc nofollow" target="_blank">文档。我将使用GatsbyJS中的默认域，并将其输入到<code class="fe mi mj mk ml b">Allowed Callback URL</code>、<code class="fe mi mj mk ml b">Allowed Logout URLs</code>和<code class="fe mi mj mk ml b">Allowed Web Origins</code>字段中。</a></li><li id="d22c" class="mr ms jd kc b kd na kh nb kl nc kp nd kt ne kx mw mx my mz bi translated">最后在<code class="fe mi mj mk ml b">Connections</code>选项卡上禁用<code class="fe mi mj mk ml b">Username-Password-Authentication</code>并启用<code class="fe mi mj mk ml b">google-oauth2</code></li></ul><figure class="mn mo mp mq gt ip gh gi paragraph-image"><div role="button" tabindex="0" class="iq ir di is bf it"><div class="gh gi on"><img src="../Images/db5fff45e405ca843dfe482143396472.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7DUpmUcuUcOsLeZxFawbww.jpeg"/></div></div></figure><p id="2f00" class="pw-post-body-paragraph ka kb jd kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">注意:<a class="ae ja" href="https://auth0.com/docs/authenticate/identity-providers/social-identity-providers/devkeys" rel="noopener ugc nofollow" target="_blank">默认情况下，这将使用谷歌集成的开发者密钥，对于实际的生产使用，你需要提供自己的</a>。</p><p id="2869" class="pw-post-body-paragraph ka kb jd kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">现在，您可以访问您的GatsbyJS站点，并在<em class="me">产品</em>中使用登录功能🎉</p><h1 id="70d3" class="ky kz jd bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">部署检查后</h1><p id="faa8" class="pw-post-body-paragraph ka kb jd kc b kd lw kf kg kh lx kj kk kl ly kn ko kp lz kr ks kt ma kv kw kx ig bi translated">经常说要相信外部服务，不要去测试。我有点同意。如果你真的没什么需要做的，那好吧。但即使是像Auth0这样的外部服务，也有很多地方可能出错。</p><p id="c4dd" class="pw-post-body-paragraph ka kb jd kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">例如，我可以在盖茨比的一个环境变量中打错字。或者，我可以在浏览器中打开多个选项卡，错误地禁用google on production，而不是test environments。一些新人可能来到团队，发现<code class="fe mi mj mk ml b">dev</code>和<code class="fe mi mj mk ml b">production</code>之间的漂移是一个错误，并启用用户名/密码认证方法。</p><p id="6a1c" class="pw-post-body-paragraph ka kb jd kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">为了获得一些安全，让我们在每次部署后运行一次检查，确保不可能使用用户名/密码登录，并且在生产应用程序上有一个通过Google登录的选项。我就不多说了——我足够信任Auth0，认为只要他们的页面上有<code class="fe mi mj mk ml b">Continue with Google</code>链接，它就能正常工作。</p><p id="22b4" class="pw-post-body-paragraph ka kb jd kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">软件开发中的一个事实是，我们不应该在生产环境中运行测试。确实如此。但是这并不意味着我们不应该测试它，也不意味着唯一允许的测试是手工测试。</p><h2 id="4387" class="nh kz jd bd la ni nj dn le nk nl dp li kl nm nn lm kp no np lq kt nq nr lu ns bi translated">大意</h2><p id="91b4" class="pw-post-body-paragraph ka kb jd kc b kd lw kf kg kh lx kj kk kl ly kn ko kp lz kr ks kt ma kv kw kx ig bi translated">当部署完成时，它会通过webhook触发一个GitHub操作任务。这将是一个CodeceptJS测试，它打开一个页面(是的，生产页面)，点击<code class="fe mi mj mk ml b">Log in</code>按钮，并检查是否有通过google登录的选项。</p><h2 id="2614" class="nh kz jd bd la ni nj dn le nk nl dp li kl nm nn lm kp no np lq kt nq nr lu ns bi translated">盖茨比云的问题</h2><p id="1cf8" class="pw-post-body-paragraph ka kb jd kc b kd lw kf kg kh lx kj kk kl ly kn ko kp lz kr ks kt ma kv kw kx ig bi translated">在写这篇文章的时候，Gatsby Cloud <a class="ae ja" href="https://www.gatsbyjs.com/docs/how-to/cloud/outgoing-notifications/" rel="noopener ugc nofollow" target="_blank">不支持任何外发通知</a>的定制化。在某些事件之后，只能指定一个URL来从Gatsby Cloud获取带有标准有效负载的POST请求。为了通过webhook触发GitHub动作工作流，请求需要<a class="ae ja" href="https://docs.github.com/en/rest/repos/repos?apiVersion=2022-11-28#create-a-repository-dispatch-event)" rel="noopener ugc nofollow" target="_blank">具有特定的头和有效负载</a>。这个不能直接设置在盖茨比云上。</p><p id="febe" class="pw-post-body-paragraph ka kb jd kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">可能有一些代理服务器接收GatsbyJS通知并进一步调用GitHub操作，但这超出了本实验的范围。</p><p id="e61e" class="pw-post-body-paragraph ka kb jd kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">相反，在我的概念验证版本中，健康检查工作流将在将某些东西推送到<code class="fe mi mj mk ml b">main</code>分支后被触发。这是当部署也被触发，所以听起来很合理。不管推送是通过PR合并还是直接推送。然后，在真正运行检查以确保部署完成之前，作业将休眠5分钟。这不是理想的情况，但对于这种情况来说已经足够好了。但总比没有好。</p><p id="2636" class="pw-post-body-paragraph ka kb jd kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">这里还有一点值得一提——GitHub为外部服务提供了<a class="ae ja" href="https://docs.github.com/en/rest/deployments/deployments" rel="noopener ugc nofollow" target="_blank">部署API </a>来通知repo部署状态。那么<a class="ae ja" href="https://docs.github.com/en/actions/using-workflows/events-that-trigger-workflows#deployment" rel="noopener ugc nofollow" target="_blank">动作可以基于</a> <code class="fe mi mj mk ml b"><a class="ae ja" href="https://docs.github.com/en/actions/using-workflows/events-that-trigger-workflows#deployment" rel="noopener ugc nofollow" target="_blank">deployment</a></code> <a class="ae ja" href="https://docs.github.com/en/actions/using-workflows/events-that-trigger-workflows#deployment" rel="noopener ugc nofollow" target="_blank">事件</a>而不是使用Webhooks来触发。这也不会仅仅适用于Gatsby Cloud，而是适用于不同的平台。</p><h2 id="e4ba" class="nh kz jd bd la ni nj dn le nk nl dp li kl nm nn lm kp no np lq kt nq nr lu ns bi translated">CodeceptJS运行状况检查</h2><p id="d022" class="pw-post-body-paragraph ka kb jd kc b kd lw kf kg kh lx kj kk kl ly kn ko kp lz kr ks kt ma kv kw kx ig bi translated">第一件事是用单独的<code class="fe mi mj mk ml b">e2e/codecept.prod.conf.js</code>文件来保存这个配置:</p><pre class="mn mo mp mq gt nv ml nw bn nx ny bi"><span id="7844" class="nz kz jd ml b be oa ob l oc od">const { setHeadlessWhen } = require('@codeceptjs/configure');<br/>setHeadlessWhen(process.env.HEADLESS);<br/><br/>exports.config = {<br/>  tests: './health_checks/*_check.js',<br/>  output: './output',<br/>  helpers: {<br/>    Playwright: {<br/>      url: process.env.PROD_PAGE_URL,<br/>      show: true,<br/>      browser: 'chromium',<br/>      // when running on GitHub actions I experienced strangely long times<br/>      // for the external page to load so waitForTimeout is increased<br/>      waitForTimeout: 10000,<br/>    }<br/>  },<br/>  include: { },<br/>  name: 'e2e'<br/>}</span></pre><p id="0af7" class="pw-post-body-paragraph ka kb jd kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">这几乎就像是测试的配置。它使用不同的目录来存储检查，并从<code class="fe mi mj mk ml b">PROD_PAGE_URL</code> env变量中获取页面URL，没有默认值。我也跳过了这里的<code class="fe mi mj mk ml b">dotenv</code>设置。</p><p id="feec" class="pw-post-body-paragraph ka kb jd kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">现在检查本身在<code class="fe mi mj mk ml b">e2e/health_checks/auth_check.js</code>:</p><pre class="mn mo mp mq gt nv ml nw bn nx ny bi"><span id="1b07" class="nz kz jd ml b be oa ob l oc od">Feature('Authentication health check');<br/><br/>Scenario('User can login via google but not with username/pass', ({ I }) =&gt; {<br/>  I.amOnPage('/')<br/>  I.click(`Log in`)<br/>  I.waitForText('Continue with Google')<br/>  I.dontSeeElement('input[name=username]')<br/>}).retry(5); <br/><br/>// For some unknown to me reason, when using a real webpage, SOMETIMES<br/>// line 5 clicks on `Log in` button (so the element is already loaded),<br/>// but Auth0 flow doesn't start. I don't know exactly why, I suspect<br/>// something about page loading taking longer in the real page than in local<br/>// build. Luckily codecept comes with a handy `retry` method.<br/>// I don't like this, but I accept it as good enough.</span></pre><p id="1401" class="pw-post-body-paragraph ka kb jd kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">要在本地测试它:</p><pre class="mn mo mp mq gt nv ml nw bn nx ny bi"><span id="b1a5" class="nz kz jd ml b be oa ob l oc od"># inside `e2e` directory<br/>$ PROD_PAGE_URL=https://my-gatsby-page.io npx codeceptjs run -c codecept.prod.conf.js --steps</span></pre><h2 id="ae64" class="nh kz jd bd la ni nj dn le nk nl dp li kl nm nn lm kp no np lq kt nq nr lu ns bi translated">GitHub操作配置</h2><p id="7810" class="pw-post-body-paragraph ka kb jd kc b kd lw kf kg kh lx kj kk kl ly kn ko kp lz kr ks kt ma kv kw kx ig bi translated">在<code class="fe mi mj mk ml b">.github/workflows/health_checks.yml</code>中添加新的工作流程:</p><pre class="mn mo mp mq gt nv ml nw bn nx ny bi"><span id="8b42" class="nz kz jd ml b be oa ob l oc od">name: Production page health checks<br/>on:<br/>  push:<br/>    branches:<br/>      - main<br/><br/>env:<br/>  HEADLESS: true<br/>  PROD_PAGE_URL: https://gatsbyauth0codeceptjsmain.gatsbyjs.io/<br/><br/>jobs:<br/>  test:<br/>    runs-on: ubuntu-latest<br/><br/>    defaults:<br/>      run:<br/>        working-directory: e2e<br/><br/>    steps:<br/>      - uses: actions/checkout@v2<br/><br/>      - name: setup nodejs<br/>        uses: actions/setup-node@v2<br/>        with:<br/>          node-version: 18.0.0<br/><br/>      - name: npm install<br/>        run: npm install<br/><br/>      - name: sleep for 5 minutes to make sure deploy finished<br/>        run: sleep 300<br/><br/>      - name: Run health checks<br/>        run: |<br/>          npx codeceptjs run -c codecept.prod.conf.js</span></pre><p id="a02e" class="pw-post-body-paragraph ka kb jd kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">现在合并PR，如果你前往GitHub repo中的<code class="fe mi mj mk ml b">Actions</code>选项卡，你会看到两个工作流正在运行——一个是常规e2e测试，另一个是健康检查。也许在工作流程5分钟后结束之前，这是一个起身伸展一下的好时机？</p><p id="346f" class="pw-post-body-paragraph ka kb jd kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">5分钟过去了，体检也过去了。我们完成了:-)</p><figure class="mn mo mp mq gt ip gh gi paragraph-image"><div role="button" tabindex="0" class="iq ir di is bf it"><div class="gh gi oo"><img src="../Images/102006338a95c4a334c6717b8442743c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*udW2vswodafgceIZR2xr_w.png"/></div></div></figure><p id="87a0" class="pw-post-body-paragraph ka kb jd kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">在实际使用中，您可能希望在健康检查作业结束时插入一些通知，例如使用<a class="ae ja" href="https://github.com/marketplace/actions/slack-notification" rel="noopener ugc nofollow" target="_blank"> GitHub Action slack。</a></p><h1 id="65f7" class="ky kz jd bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">包裹</h1><ul class=""><li id="b046" class="mr ms jd kc b kd lw kh lx kl op kp oq kt or kx mw mx my mz bi translated">我们已经通过租户特性查看了三种不同环境的Auth0设置</li><li id="28d2" class="mr ms jd kc b kd na kh nb kl nc kp nd kt ne kx mw mx my mz bi translated">在实现身份验证之前，我们创建了一系列高级测试来描述身份验证</li><li id="8758" class="mr ms jd kc b kd na kh nb kl nc kp nd kt ne kx mw mx my mz bi translated">通过一个简单的例子，我们已经看到了Gatsby使用Auth0</li><li id="77d0" class="mr ms jd kc b kd na kh nb kl nc kp nd kt ne kx mw mx my mz bi translated">GitHub动作已经开始发挥作用，以方便设置CI管道</li><li id="c8ab" class="mr ms jd kc b kd na kh nb kl nc kp nd kt ne kx mw mx my mz bi translated">我们已经研究过Gatsby Cloud，它(几乎)没有为页面托管任何配置</li><li id="f0d1" class="mr ms jd kc b kd na kh nb kl nc kp nd kt ne kx mw mx my mz bi translated">最后，我们查看了来自Gatsby Cloud的GitHub Actions方向的通信，并在生产页面上运行了一些健康检查。遗憾的是，没有简单的方法来实现适当的部署后工作流触发。</li></ul><p id="5031" class="pw-post-body-paragraph ka kb jd kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">每个提到的应用和工具都有至少十几个可用的资源，涵盖了各种不同的使用环境。这里展示的每一件作品都有很大的改进空间，以便为生产做好准备。</p><p id="a9d6" class="pw-post-body-paragraph ka kb jd kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">希望有了这个概述，您可以获得一些进一步实验的起点。</p><p id="5f01" class="pw-post-body-paragraph ka kb jd kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">玩得开心。</p><h2 id="e64d" class="nh kz jd bd la ni nj dn le nk nl dp li kl nm nn lm kp no np lq kt nq nr lu ns bi translated">资源</h2><ul class=""><li id="0453" class="mr ms jd kc b kd lw kh lx kl op kp oq kt or kx mw mx my mz bi translated">盖茨比文件:<a class="ae ja" href="https://www.gatsbyjs.com/docs" rel="noopener ugc nofollow" target="_blank">https://www.gatsbyjs.com/docs</a></li><li id="aaaa" class="mr ms jd kc b kd na kh nb kl nc kp nd kt ne kx mw mx my mz bi translated">CodeceptJS文档:<a class="ae ja" href="https://codecept.io/" rel="noopener ugc nofollow" target="_blank">https://codecept.io/</a></li><li id="5a21" class="mr ms jd kc b kd na kh nb kl nc kp nd kt ne kx mw mx my mz bi translated">CodeceptJS书籍和帖子:<a class="ae ja" href="https://github.com/codeceptjs/CodeceptJS/wiki/Books-&amp;-Posts" rel="noopener ugc nofollow" target="_blank">https://github.com/codeceptjs/CodeceptJS/wiki/Books-&amp;-帖子</a></li><li id="34ac" class="mr ms jd kc b kd na kh nb kl nc kp nd kt ne kx mw mx my mz bi translated">GitHub操作文档:<a class="ae ja" href="https://docs.github.com/en/actions" rel="noopener ugc nofollow" target="_blank">https://docs.github.com/en/actions</a></li><li id="5d32" class="mr ms jd kc b kd na kh nb kl nc kp nd kt ne kx mw mx my mz bi translated">Auth0租户:<a class="ae ja" href="https://auth0.com/docs/get-started/auth0-overview/create-tenants" rel="noopener ugc nofollow" target="_blank">https://auth 0 . com/docs/get-started/auth 0-overview/create-tenances</a></li></ul><p id="ef86" class="pw-post-body-paragraph ka kb jd kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">对于Gatsby &amp; Auth0的集成，您可以查看几个地方:</p><ul class=""><li id="f526" class="mr ms jd kc b kd ke kh ki kl mt kp mu kt mv kx mw mx my mz bi translated">Auth0博文:【https://auth0.com/blog/securing-gatsby-with-auth0/<a class="ae ja" href="https://auth0.com/blog/securing-gatsby-with-auth0/" rel="noopener ugc nofollow" target="_blank">T3】</a></li><li id="577b" class="mr ms jd kc b kd na kh nb kl nc kp nd kt ne kx mw mx my mz bi translated">来自Auth0的示例应用:【https://github.com/auth0-blog/gatsby-auth0 T4】</li><li id="ed8a" class="mr ms jd kc b kd na kh nb kl nc kp nd kt ne kx mw mx my mz bi translated">盖茨比Auth0主题:<a class="ae ja" href="https://www.gatsbyjs.com/plugins/gatsby-theme-auth0/" rel="noopener ugc nofollow" target="_blank">https://www.gatsbyjs.com/plugins/gatsby-theme-auth0/</a></li></ul><p id="051d" class="pw-post-body-paragraph ka kb jd kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><em class="me">更多内容看</em> <a class="ae ja" href="https://plainenglish.io/" rel="noopener ugc nofollow" target="_blank"> <strong class="kc je"> <em class="me">说白了。报名参加我们的</em> <a class="ae ja" href="http://newsletter.plainenglish.io/" rel="noopener ugc nofollow" target="_blank"> <strong class="kc je"> <em class="me">免费周报</em> </strong> </a> <em class="me">。关注我们关于</em> <a class="ae ja" href="https://twitter.com/inPlainEngHQ" rel="noopener ugc nofollow" target="_blank"> <strong class="kc je"> <em class="me">推特</em> </strong> </a>，<a class="ae ja" href="https://www.linkedin.com/company/inplainenglish/" rel="noopener ugc nofollow" target="_blank"><strong class="kc je"><em class="me">LinkedIn</em></strong></a><em class="me">，</em><a class="ae ja" href="https://www.youtube.com/channel/UCtipWUghju290NWcn8jhyAw" rel="noopener ugc nofollow" target="_blank"><strong class="kc je"><em class="me">YouTube</em></strong></a><em class="me">，以及</em> <a class="ae ja" href="https://discord.gg/GtDtUAvyhW" rel="noopener ugc nofollow" target="_blank"> <strong class="kc je"> <em class="me">不和</em> </strong> </a> <strong class="kc je"> <em class="me">。</em>T57】</strong></strong></a></p><p id="c9d9" class="pw-post-body-paragraph ka kb jd kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><strong class="kc je"> <em class="me">有兴趣缩放你的软件启动</em> </strong> <em class="me">？检查出</em> <a class="ae ja" href="https://circuit.ooo?utm=publication-post-cta" rel="noopener ugc nofollow" target="_blank"> <strong class="kc je"> <em class="me">电路</em> </strong> </a> <em class="me">。</em></p></div></div>    
</body>
</html>