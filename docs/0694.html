<html>
<head>
<title>Stripe Elements in Next.js</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Next.js中的条带元素</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/stripe-elements-in-next-js-da59c502af48?source=collection_archive---------0-----------------------#2022-02-08">https://javascript.plainenglish.io/stripe-elements-in-next-js-da59c502af48?source=collection_archive---------0-----------------------#2022-02-08</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/9f8233c5e780396bc691f8a16e91be12.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vVGh4fZsynsFarFJwqBlGw.jpeg"/></div></div></figure><p id="826c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><a class="ae kw" href="https://stripe.com/" rel="noopener ugc nofollow" target="_blank"> Stripe </a>是信用卡(以及其他支付方式，包括Google Pay和Apple Pay)的在线支付处理系统。他们提供了广泛的功能，从定期付款到延迟付款(对预订非常有用)，而且他们的定价非常方便。</p><p id="c718" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">从开发者的角度来看，他们提供了两种在网站或应用上集成支付的主要方式:<strong class="ka ir">结账</strong>和<strong class="ka ir">元素</strong>。</p><p id="b251" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">有了Checkout，一旦你的用户准备好支付，他们会被重定向到一个Stripe托管的页面(你可以自定义)，在那里他们完成支付；使用Elements，您可以在您的网站上创建支付表单，这样您就可以为用户提供出色的体验，使他们在支付过程中不会离开您的网站，同时保持高水平的安全性。</p><p id="756f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在本教程中，我将重点关注元素，因为它的实现可能比checkout稍微复杂一些，而且我们将使用<a class="ae kw" href="https://nextjs.org/" rel="noopener ugc nofollow" target="_blank"> Next.js </a>作为我们的框架，因为Stripe需要服务器到服务器的通信，Next提供了这种开箱即用的能力<a class="ae kw" href="https://nextjs.org/docs/api-routes/introduction" rel="noopener ugc nofollow" target="_blank"/>。</p><figure class="ky kz la lb gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi kx"><img src="../Images/309a9a8980762948c47d28cc56b637cb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1320/format:webp/1*GQjWBdP4DpIXP4n9ZwjqnA.png"/></div></div><figcaption class="lc ld gj gh gi le lf bd b be z dk">How or final page will look</figcaption></figure><p id="bff2" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">为了跟随本教程，您可以从这里克隆完整的存储库:</p><div class="lg lh gp gr li lj"><a href="https://github.com/popeating/stripe-elements" rel="noopener  ugc nofollow" target="_blank"><div class="lk ab fo"><div class="ll ab lm cl cj ln"><h2 class="bd ir gy z fp lo fr fs lp fu fw ip bi translated">GitHub流行元素/条纹元素</h2><div class="lq l"><h3 class="bd b gy z fp lo fr fs lp fu fw dk translated">这是一个用create-next-app引导的Next.js项目。首先，运行开发服务器:打开…</h3></div><div class="lr l"><p class="bd b dl z fp lo fr fs lp fu fw dk translated">github.com</p></div></div></div></a></div><h2 id="a072" class="ls lt iq bd lu lv lw dn lx ly lz dp ma kj mb mc md kn me mf mg kr mh mi mj mk bi translated">先决条件</h2><p id="8e65" class="pw-post-body-paragraph jy jz iq ka b kb ml kd ke kf mm kh ki kj mn kl km kn mo kp kq kr mp kt ku kv ij bi translated">为了完成本教程，您需要:</p><ul class=""><li id="642c" class="mq mr iq ka b kb kc kf kg kj ms kn mt kr mu kv mv mw mx my bi translated">一个Stripe帐户(你可以在Stripe上免费注册)已配置并处于测试模式(可以访问可发布的密钥和Webhook secret)。</li><li id="8329" class="mq mr iq ka b kb mz kf na kj nb kn nc kr nd kv mv mw mx my bi translated">了解Next.js框架，包括前端开发和API开发。</li><li id="c1bd" class="mq mr iq ka b kb mz kf na kj nb kn nc kr nd kv mv mw mx my bi translated">了解回调、webhook、服务器到服务器通信的工作原理。</li><li id="64ae" class="mq mr iq ka b kb mz kf na kj nb kn nc kr nd kv mv mw mx my bi translated">关于节点和NPM如何安装模块和运行本地服务器的一点知识</li></ul><p id="857b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">您还需要了解一些关于Tailwind CSS框架的知识来进行样式设计。</p><p id="f56e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果你想在本地测试webhook，你需要<a class="ae kw" href="https://ngrok.com/" rel="noopener ugc nofollow" target="_blank"><strong class="ka ir">ngrok</strong></a><strong class="ka ir"/>(免费版本对本教程来说很有用)或者<a class="ae kw" href="https://stripe.com/docs/stripe-cli" rel="noopener ugc nofollow" target="_blank"> <strong class="ka ir"> Stripe CLI </strong> </a>。</p><h2 id="c72a" class="ls lt iq bd lu lv lw dn lx ly lz dp ma kj mb mc md kn me mf mg kr mh mi mj mk bi translated">条纹元素的工作原理</h2><p id="4688" class="pw-post-body-paragraph jy jz iq ka b kb ml kd ke kf mm kh ki kj mn kl km kn mo kp kq kr mp kt ku kv ij bi translated">在开始编码之前，我们应该先了解一下条带事务是如何工作的。假设您正在从事电子商务(但任何其他需要支付的网站也可以)，在某一点上，您的客户/用户将到达结账页面，这里将开始Stripe工作流(我们稍后将详细介绍每个操作):</p><ul class=""><li id="1a66" class="mq mr iq ka b kb kc kf kg kj ms kn mt kr mu kv mv mw mx my bi translated">在登陆该页面时，你的应用程序将与Stripe服务器通信以创建一个<strong class="ka ir"> PaymentIntent </strong>，发送购物车的金额并接收回一个id和一个密钥；将id存储在客户端的某个地方是一个好主意。</li><li id="29a0" class="mq mr iq ka b kb mz kf na kj nb kn nc kr nd kv mv mw mx my bi translated">如果用户改变购物车(添加或删除产品，应用优惠券等)，应用程序将更新Stripe服务器上的<strong class="ka ir"> PaymentIntent </strong>的值(保存id允许用户离开购物车，稍后返回，仍然有一个PaymentIntent准备好)</li><li id="ba54" class="mq mr iq ka b kb mz kf na kj nb kn nc kr nd kv mv mw mx my bi translated">与此同时，该页面将从Stripe服务器动态获取构建支付表单所需的javascript，由于安全规则，该JavaScript不能存储在本地，信用卡表单将作为页面内的一个<em class="ne"> iframe </em>呈现。该表单已经通过之前生成的密钥为当前的<strong class="ka ir"> PaymentIntent </strong>进行了配置</li><li id="3e60" class="mq mr iq ka b kb mz kf na kj nb kn nc kr nd kv mv mw mx my bi translated">此时，用户将在表单中填写信用卡详细信息并提交。您的应用程序将调用远程<strong class="ka ir"> confirmPayment </strong> Stripe端点，该端点将制作卡并发回结果(并重定向用户)。</li><li id="dc59" class="mq mr iq ka b kb mz kf na kj nb kn nc kr nd kv mv mw mx my bi translated">在此期间，除了正常的响应，Stripe将通过webhook与我们的服务器通信(如果在Stripe Dashboard上配置了web hook ),通知我们发生的一切；这对于处理支付后操作(更新订单、发送电子邮件、更新股票)特别有用，无需等待客户端回调。稍后将详细介绍。</li></ul><h2 id="35d1" class="ls lt iq bd lu lv lw dn lx ly lz dp ma kj mb mc md kn me mf mg kr mh mi mj mk bi translated">初始化项目和依赖项</h2><p id="1ecc" class="pw-post-body-paragraph jy jz iq ka b kb ml kd ke kf mm kh ki kj mn kl km kn mo kp kq kr mp kt ku kv ij bi translated">使用以下内容创建新项目:</p><pre class="ky kz la lb gt nf ng nh ni aw nj bi"><span id="520c" class="ls lt iq ng b gy nk nl l nm nn">npx create-react-app stripe-element</span></pre><p id="8a0f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">进入新创建的文件夹并安装以下依赖项:</p><pre class="ky kz la lb gt nf ng nh ni aw nj bi"><span id="2abe" class="ls lt iq ng b gy nk nl l nm nn">npm i @stripe/stripe-js @stripe/react-stripe-js stripe micro </span><span id="0189" class="ls lt iq ng b gy no nl l nm nn">npm i -D tailwindcss postcss autoprefixer @tailwindcss/forms</span></pre><p id="e8c8" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">除了stripe模块，我们还安装了<em class="ne"> micro </em>，它是一个小工具，我们将在webhook开发过程中使用，它允许我们访问原始格式的请求正文内容。我们还将Tailwind安装为一个开发依赖项。</p><p id="bae5" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">设置(可选)tailwind.css:</p><pre class="ky kz la lb gt nf ng nh ni aw nj bi"><span id="3093" class="ls lt iq ng b gy nk nl l nm nn">npx tailwindcss init -p</span></pre><p id="57b6" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">并像这样配置tailwind.js.conf:</p><figure class="ky kz la lb gt jr"><div class="bz fp l di"><div class="np nq l"/></div></figure><p id="b9aa" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">准备好你的<em class="ne">。env </em>文件(不要忘记将它添加到。gitignore并在部署期间将变量放置在您的托管服务的环境中)，使用测试数据从您的Stripe仪表板中获取这些数据(webhook secret可以在以后配置，一旦您启用了webhooks)。</p><figure class="ky kz la lb gt jr"><div class="bz fp l di"><div class="np nq l"/></div></figure><p id="c9a6" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">设置您的工作空间，准备我们需要的文件(您可以安全地删除其他文件):</p><figure class="ky kz la lb gt jr gh gi paragraph-image"><div class="gh gi nr"><img src="../Images/af0c3a5cddae8e4b89050709278b6666.png" data-original-src="https://miro.medium.com/v2/resize:fit:844/format:webp/1*L3ZsDTtEzrmzSY30HCSGeQ.png"/></div><figcaption class="lc ld gj gh gi le lf bd b be z dk">Project structure</figcaption></figure><h2 id="7642" class="ls lt iq bd lu lv lw dn lx ly lz dp ma kj mb mc md kn me mf mg kr mh mi mj mk bi translated">付款意向</h2><p id="0799" class="pw-post-body-paragraph jy jz iq ka b kb ml kd ke kf mm kh ki kj mn kl km kn mo kp kq kr mp kt ku kv ij bi translated">正如工作流中提到的，我们需要处理的第一件事是paymentIntent，为此我们使用一个本地访问的API，它将与Stripe服务器通信并返回到我们的应用程序。</p><p id="8f1a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">编辑文件<code class="fe ns nt nu ng b"><strong class="ka ir">/pages/api/stripe_intent.js</strong></code> <strong class="ka ir"> </strong>(代码在最后注释):</p><figure class="ky kz la lb gt jr"><div class="bz fp l di"><div class="np nq l"/></div></figure><p id="190f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">基本上，这个API(可以在URL<strong class="ka ir">http://localhost:3000/API/stripe _ intent</strong>访问)将用两个参数调用:<strong class="ka ir"> amount </strong>，我们要开账单的金额，以及<strong class="ka ir"> payment_intent_id </strong>，(但是您也可以处理更多参数，比如<em class="ne">描述</em>，在我们的例子中是硬编码的)我们要更新的先前创建的paymentIntent(如果存在的话)的id。基于这些参数，API将检索，然后更新或创建一个新的支付内容，并将其返回到我们的应用程序。正如Stripe建议的那样，总是尝试重用paymentIntent，这将有助于跟踪用户活动，并将保持工作流“干净”。</p><p id="633f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">您可以通过使用body param <strong class="ka ir"> amount </strong>发布到<strong class="ka ir">http://localhost:3000/API/stripe _ intent</strong>来测试这个API(使用rest工具，如<a class="ae kw" href="https://www.postman.com/" rel="noopener ugc nofollow" target="_blank"> Postman </a>或REST client for vs code ), API将回复一个paymentIntent对象，该对象将包含一个id(如果我们需要，将用于更新它)和一个client_secret(将用于完成支付)。</p><figure class="ky kz la lb gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nv"><img src="../Images/6f2b3d8e3aac1e9f2582cc9babc481eb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-JOJ4VDm2b9E8QLSx4bNYA.png"/></div></div><figcaption class="lc ld gj gh gi le lf bd b be z dk">Creating a paymentIntent</figcaption></figure><p id="b99a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果您再次调用API，使用新的金额，但是指定payment_intent_id参数，使用您从以前的回复中获得的值和新的金额，作为回复，您将获得一个具有相同id和新金额的对象。</p><figure class="ky kz la lb gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nv"><img src="../Images/fa80fe0ac44bfccdb3c6c5b63738afe9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zGdoT2wd9Nf4SEzV95klXw.png"/></div></div><figcaption class="lc ld gj gh gi le lf bd b be z dk">Updating a paymentIntent</figcaption></figure><p id="7fd2" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">您也可以尝试错误(例如，不传递金额将导致错误)。</p><p id="7af3" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">通过访问您的Stripe仪表板并访问开发人员部分以检查事件和日志，您可以检查一切是否真正与Stripe通信，以及是否在Stripe服务器上有效地创建了paymentIntent:</p><figure class="ky kz la lb gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nw"><img src="../Images/0fe43747672b753b14345148d2556e5b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Q3r6oWGtmPDXFrX5qo89TA.png"/></div></div></figure><p id="f6bf" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">一旦一切都对齐正确，你可以开始工作的前端应用程序</p><h2 id="8d8f" class="ls lt iq bd lu lv lw dn lx ly lz dp ma kj mb mc md kn me mf mg kr mh mi mj mk bi translated">结账/支付页面</h2><p id="cfb7" class="pw-post-body-paragraph jy jz iq ka b kb ml kd ke kf mm kh ki kj mn kl km kn mo kp kq kr mp kt ku kv ij bi translated">我们创建了一个页面(index.js ),假设这是一个虚构的电子商务网站结帐页面，用户将在这里填写他的帐单/送货地址并确认付款。我们的页面将使用<em class="ne"> loadStripe </em>作为包装器来加载Stripe Elements组件和所需的js库。在<em class="ne">元素</em>组件中，我们将呈现<em class="ne"> CheckoutForm </em>组件，它是账单表单本身:</p><figure class="ky kz la lb gt jr"><div class="bz fp l di"><div class="np nq l"/></div></figure><p id="6050" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">当我们到达结帐页面时(在我们的例子中是index.js ),我们通过获取我们的<em class="ne"> stripe_intent </em> API来创建一个新的paymentIntent，传递我们要开账单的金额。在这种情况下，金额是硬编码的，但在现实场景中，金额将是购物车总额(或我们希望向用户收取的金额)。金额作为较低货币单位的整数传递，在我们的例子中(€，但美元是相同的)是分，因此3000导致€ 300，00的帐单。</p><p id="2642" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">API响应被处理，两个相关数据(clientSecret和paymentIntend id)被存储在一个状态中。您可能也想将id存储在客户机上的某个地方(比如LocalStorage)，这样即使用户离开页面以后又回来，也可以再次访问它。</p><p id="4b32" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们实例化Elements组件，传递一个对主<em class="ne"> stripe </em>实例的引用，以及一个对包含<em class="ne"> clientSecret </em>的<em class="ne"> options </em>对象和一个将用于定制账单表单的Apparence对象的引用(关于Apparence API的更多信息可以在这里找到:<a class="ae kw" href="https://stripe.com/docs/stripe-js/appearance-api" rel="noopener ugc nofollow" target="_blank">https://stripe.com/docs/stripe-js/appearance-api</a></p><p id="40ab" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们还将<em class="ne"> paymentIntent id </em>传递给CheckoutForm。</p><h2 id="f616" class="ls lt iq bd lu lv lw dn lx ly lz dp ma kj mb mc md kn me mf mg kr mh mi mj mk bi translated">结帐表单</h2><p id="05b8" class="pw-post-body-paragraph jy jz iq ka b kb ml kd ke kf mm kh ki kj mn kl km kn mo kp kq kr mp kt ku kv ij bi translated">结帐表单将呈现该表单以捕获支付数据并处理其提交。它还将用于通知用户支付错误/成功。在我们的例子中，它还将收集一封电子邮件，并跟踪账单金额的变化(例如，当用户从购物车中移除产品时，金额必须在<em class="ne"> paymentIntent </em>上更新)</p><figure class="ky kz la lb gt jr"><div class="bz fp l di"><div class="np nq l"/></div></figure><p id="66dc" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们将大多数变量(如金额、电子邮件、结果消息和付款的加载状态)保存在react状态中。</p><p id="8dd7" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们定义了一个函数来跟踪更新的金额值，在每次更改时(在生产环境中，更明智地选择事件可能更有意义，比如在失去焦点时或者就在表单提交之前)我们使用本地的<em class="ne"> stripe_intent </em> API更新<em class="ne"> paymentIntent </em>金额。</p><p id="4b10" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们还定义了一个函数来处理表单提交。它基本上确认了对当前<em class="ne">条带元素</em>的支付，这些元素已经在条带服务器上创建。您可以向<em class="ne"> confirmPayment </em>端点传递一系列参数，比如receipt_email(这将使Stripe on production向用户发送一封包含付款收据的电子邮件)、账单和运输细节(更多信息请参见:<a class="ae kw" href="https://stripe.com/docs/js/payment_intents/confirm_payment" rel="noopener ugc nofollow" target="_blank">https://stripe.com/docs/js/payment_intents/confirm_payment</a>)。唯一必需的是<em class="ne"> redirect_url </em>，用户在成功支付后被重定向到这个url，在这个重定向URL上附加了支付状态和客户端密码作为参数，您可以使用这些参数在支付后向用户显示一条消息(在我们的例子中是在页面的useEffect部分实现的)。</p><p id="08bf" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在一个真实的电子商务示例中，在确认付款之前，您希望在您的系统上创建并存储订单(可能有一个<em class="ne">等待</em>状态)，以便您可以向Stripe发送对它的引用，一旦付款成功，您希望更新订单并重定向到一个感谢页面，该页面将处理退货状态参数，您可能还希望基于该状态更新订单。</p><h2 id="9af3" class="ls lt iq bd lu lv lw dn lx ly lz dp ma kj mb mc md kn me mf mg kr mh mi mj mk bi translated">Webhooks</h2><p id="35da" class="pw-post-body-paragraph jy jz iq ka b kb ml kd ke kf mm kh ki kj mn kl km kn mo kp kq kr mp kt ku kv ij bi translated">Stripe还可以使用webhooks与您的服务器通信。您可以激活webhooks(并从Stripe dashboard中选择触发它们的操作。</p><p id="f0de" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">首先，在<code class="fe ns nt nu ng b"><strong class="ka ir">/pages/api/webhook.js</strong></code>中创建webhook端点</p><figure class="ky kz la lb gt jr"><div class="bz fp l di"><div class="np nq l"/></div></figure><p id="29c9" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">Stripe将对每个webhook请求进行签名，验证使用请求的原始内容(以及标题Stripe签名和webhookSecret)。由于next不支持原始内容，我们需要禁用bodyparser并用<em class="ne"> micro将请求转换为原始内容。</em></p><p id="d112" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">剩下的就很简单了，如果请求被验证，我们就可以读取哪个事件被传递了等等(我们只是简单地记录几个事件，但是您可以使用webhooks通知您的客户，更新订单和股票，通知团队发生了一些动作)。</p><p id="a3f2" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果您正在生产级别上工作，总是建议使用webhook，而不是等待客户端。</p><p id="a8e7" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">由于webhooks运行在localhost上，但是Stripe需要从远程访问它，所以在Stripe dashboard上配置它之前，您需要一种方法让localhost从外部访问。我个人使用的是<strong class="ka ir"> ngrok </strong>，它给你一个映射到本地主机的公共URL。就像这样运行ngrok:</p><pre class="ky kz la lb gt nf ng nh ni aw nj bi"><span id="abc9" class="ls lt iq ng b gy nk nl l nm nn"><strong class="ng ir">ngrok http http://localhost:3000</strong></span></pre><p id="fb1d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">它会像这样回复</p><pre class="ky kz la lb gt nf ng nh ni aw nj bi"><span id="e94e" class="ls lt iq ng b gy nk nl l nm nn"><strong class="ng ir">Forwarding                    http://d12b-2-236-77-43.ngrok.io -&gt; http://localhost:3000</strong></span></pre><p id="975b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">并且在Stripe上配置时可以使用http://d12b-2-236-77-43 . ngrok . io作为webhook端点。</p><h2 id="98eb" class="ls lt iq bd lu lv lw dn lx ly lz dp ma kj mb mc md kn me mf mg kr mh mi mj mk bi translated">下一步是什么</h2><p id="bed0" class="pw-post-body-paragraph jy jz iq ka b kb ml kd ke kf mm kh ki kj mn kl km kn mo kp kq kr mp kt ku kv ij bi translated">Stripe(和Stripe Elements)是一个非常灵活的工具，它的API是有据可查的(带有React代码片段)，它将允许你保存客户、存储支付数据用于重复支付、延迟支付等等；它是补充需要集成客户体验和定制支付解决方案的电子商务网站或web应用程序的最佳解决方案之一。</p><h2 id="1e38" class="ls lt iq bd lu lv lw dn lx ly lz dp ma kj mb mc md kn me mf mg kr mh mi mj mk bi translated">进一步阅读</h2><div class="lg lh gp gr li lj"><a href="https://blog.bitsrc.io/next-js-13-what-do-the-new-bleeding-edge-features-actually-do-d3e5fd418563" rel="noopener  ugc nofollow" target="_blank"><div class="lk ab fo"><div class="ll ab lm cl cj ln"><h2 class="bd ir gy z fp lo fr fs lp fu fw ip bi translated">Next.js 13:新的前沿特性实际上是做什么的？</h2><div class="lq l"><h3 class="bd b gy z fp lo fr fs lp fu fw dk translated">你听说过Next.js 13是一个游戏改变者，但是为什么？让我们看看有哪些新功能，有哪些变化，以及它们…</h3></div><div class="lr l"><p class="bd b dl z fp lo fr fs lp fu fw dk translated">blog.bitsrc.io</p></div></div><div class="nx l"><div class="ny l nz oa ob nx oc jw lj"/></div></div></a></div><p id="e02b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><em class="ne">更多内容请看</em><a class="ae kw" href="https://plainenglish.io/" rel="noopener ugc nofollow" target="_blank"><strong class="ka ir"><em class="ne">plain English . io</em></strong></a><em class="ne">。报名参加我们的</em> <a class="ae kw" href="http://newsletter.plainenglish.io/" rel="noopener ugc nofollow" target="_blank"> <strong class="ka ir"> <em class="ne">免费周报</em> </strong> </a> <em class="ne">。关注我们关于</em><a class="ae kw" href="https://twitter.com/inPlainEngHQ" rel="noopener ugc nofollow" target="_blank"><strong class="ka ir"><em class="ne">Twitter</em></strong></a><a class="ae kw" href="https://www.linkedin.com/company/inplainenglish/" rel="noopener ugc nofollow" target="_blank"><strong class="ka ir"><em class="ne">LinkedIn</em></strong></a><em class="ne"/><a class="ae kw" href="https://www.youtube.com/channel/UCtipWUghju290NWcn8jhyAw" rel="noopener ugc nofollow" target="_blank"><strong class="ka ir"><em class="ne">YouTube</em></strong></a><em class="ne"/><a class="ae kw" href="https://discord.gg/GtDtUAvyhW" rel="noopener ugc nofollow" target="_blank"><strong class="ka ir"><em class="ne">不和</em> </strong> </a> <em class="ne">。对增长黑客感兴趣？检查</em> <a class="ae kw" href="https://circuit.ooo/" rel="noopener ugc nofollow" target="_blank"> <strong class="ka ir"> <em class="ne">电路</em> </strong> </a> <em class="ne">。</em></p></div></div>    
</body>
</html>