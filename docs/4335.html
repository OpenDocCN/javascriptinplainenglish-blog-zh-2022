<html>
<head>
<title>Easy and Custom Angular-RxJS State Management Under 50 Lines of Code</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">50è¡Œä»£ç ä¸‹çš„ç®€å•å®šåˆ¶Angular-RxJSçŠ¶æ€ç®¡ç†</h1>
<blockquote>åŸæ–‡ï¼š<a href="https://javascript.plainenglish.io/easy-and-custom-angular-rxjs-state-management-under-50-lines-of-code-a2e7188da926?source=collection_archive---------1-----------------------#2022-11-22">https://javascript.plainenglish.io/easy-and-custom-angular-rxjs-state-management-under-50-lines-of-code-a2e7188da926?source=collection_archive---------1-----------------------#2022-11-22</a></blockquote><div><div class="fc if ig ih ii ij"/><div class="ik il im in io"><div class=""/><figure class="gm go jp jq jr js gi gj paragraph-image"><div role="button" tabindex="0" class="jt ju di jv bf jw"><div class="gi gj jo"><img src="../Images/7f2fe9e0f98f082b5965e8d4109bfbeb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*oqFRPzTVNROw0U5pmX0Jew.jpeg"/></div></div></figure><p id="dcdf" class="pw-post-body-paragraph jz ka ir kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ik bi translated">å‰ç«¯åº”ç”¨ç¨‹åºä¸­çš„çŠ¶æ€ç®¡ç†æ€»æ˜¯ä¸€ä¸ªå¯æ€•çš„è¯é¢˜ã€‚â€<em class="kx">å¯¹NGRX </em>çš„ææƒ§â€œæ˜¯çœŸå®å­˜åœ¨çš„(ğŸ˜…)ï¼Œè‡³å°‘å¯¹æˆ‘æ¥è¯´æ˜¯è¿™æ ·ã€‚æ‰€ä»¥æˆ‘å°½é‡è¿œç¦»å®ƒï¼Œé™¤éåœ¨æˆ‘çš„å·¥ä½œåœºæ‰€éœ€è¦å®ƒã€‚ä½†æ˜¯ï¼Œåœ¨å…¶æ ¸å¿ƒï¼ŒçŠ¶æ€ç®¡ç†æ˜¯ä¸€ä¸ªå¼ºå¤§çš„æ¦‚å¿µï¼Œå¯ä»¥å¸®åŠ©æ‚¨ç¼–å†™å¥å£®ã€å¯ç»´æŠ¤ã€å¯è¯»å’Œé«˜è´¨é‡çš„ä»£ç ã€‚ä¸€æ—¦æˆ‘æŒæ¡äº†è¿™ä¸ªæ¦‚å¿µï¼Œæˆ‘å°±ä¸ä¼šå›å¤´äº†ã€‚ç°åœ¨æˆ‘æ‰€æœ‰çš„ä¸ªäººé¡¹ç›®éƒ½ä½¿ç”¨çŠ¶æ€ç®¡ç†ï¼Œè™½ç„¶ä¸æ˜¯ç”¨NGRXã€‚æˆ‘éµå¾ªä¸€ä¸ªéå¸¸ç®€å•å’Œè½»é‡çº§çš„å®ç°ï¼Œå¯¹æˆ‘çš„å¤§è„‘æ¥è¯´å¾ˆå®¹æ˜“ï¼Œæˆ‘å¸Œæœ›å¯¹ä½ ä¹Ÿæ˜¯å¦‚æ­¤ï¼æ‰€ä»¥ï¼Œè®©æˆ‘ä»¬å¼€å§‹å§ã€‚</p><h2 id="8aec" class="ky kz ir bd la lb lc dn ld le lf dp lg kk lh li lj ko lk ll lm ks ln lo lp lq bi translated">æ­¥éª¤1:é™ˆè¿°ä¸»é¢˜</h2><p id="8032" class="pw-post-body-paragraph jz ka ir kb b kc lr ke kf kg ls ki kj kk lt km kn ko lu kq kr ks lv ku kv kw ik bi translated">ä½ çŸ¥é“RxJSç»™ä½ ä¸‰ç§é¢˜æâ€”â€”<code class="fe lw lx ly lz b">Subject, BehaviorSubject</code>ï¼Œå’Œ<code class="fe lw lx ly lz b">AsyncSubject</code>ã€‚ä¸ºäº†å¼€å‘æˆ‘è‡ªå·±çš„çŠ¶æ€ç®¡ç†è§£å†³æ–¹æ¡ˆï¼Œæˆ‘éœ€è¦ä»BehaviorSubjectä¸­è·å–æ›´å¤šä¿¡æ¯ã€‚</p><p id="ed94" class="pw-post-body-paragraph jz ka ir kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ik bi translated">è¿›å…¥<strong class="kb is">çŠ¶æ€æœä»</strong>ã€‚</p><p id="b486" class="pw-post-body-paragraph jz ka ir kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ik bi translated">åŸºæœ¬ä¸Šï¼ŒStateSubjectæ˜¯ä¸€ä¸ªæ‰©å±•çš„BehaviorSubjectï¼Œå®ƒæ‹¥æœ‰ä¸€ä¸ªåˆå§‹å€¼ï¼Œå¯ä»¥è¢«é‡ç½®ä¸ºåˆå§‹å€¼ï¼Œå¹¶ä¸”å¯ä»¥é€šè¿‡æ·±åº¦ç›¸ç­‰æ“ä½œæ¥æ£€æŸ¥å®ƒçš„å¯è§‚å¯Ÿæµã€‚</p><pre class="ma mb mc md gu me lz mf bn mg mh bi"><span id="ab17" class="mi kz ir lz b be mj mk l ml mm">import { isEqual } from 'radash'<br/>import { BehaviorSubject, distinctUntilChanged, Observable } from 'rxjs'<br/><br/>/**<br/> * An extended BehaviorSubject that can be reset to its initial value.<br/> * The stream of change is checked for deep equality so that only when <br/> * the value has trully changed, the stream will emit.<br/> * <br/> * This util is also available as a npm package: <br/> * https://www.npmjs.com/package/rxjs-state-subject<br/> * @author Touhid Rahman &lt;touhidrahman1987@gmail.com&gt;<br/> */<br/>export class StateSubject&lt;T&gt; extends BehaviorSubject&lt;T&gt; {<br/>    private initialValue: T<br/><br/>    constructor(value: T) {<br/>        super(value)<br/>        this.initialValue = value<br/>    }<br/><br/>    get value$(): Observable&lt;T&gt; {<br/>        return super.asObservable().pipe(<br/>            distinctUntilChanged((a, b) =&gt; isEqual(a, b))<br/>        )<br/>    }<br/><br/>    update(value: T): void {<br/>        this.next(value)<br/>    }<br/><br/>    reset(): void {<br/>        this.next(this.initialValue)<br/>    }<br/>}</span></pre><p id="a809" class="pw-post-body-paragraph jz ka ir kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ik bi translated">StateSubjectçš„ç”¨é€”ä¸»è¦æ˜¯åœ¨å€¼æ²¡æœ‰å‘ç”Ÿæœ¬è´¨å˜åŒ–æ—¶é™åˆ¶ä¸å¿…è¦çš„å‘å‡ºã€‚ä¾‹å¦‚ï¼Œæ‚¨å¯èƒ½æœ‰ä¸€ä¸ªå¸¦æœ‰å¸ƒå°”å€¼çš„BehaviorSubjectã€‚ç¨åï¼Œæ‚¨ç”¨ç›¸åŒçš„å€¼æ›´æ–°å®ƒä¸¤æ¬¡ã€‚è¯¥æµå°†å‘å‡ºä¸¤æ¬¡ã€‚</p><pre class="ma mb mc md gu me lz mf bn mg mh bi"><span id="4397" class="mi kz ir lz b be mj mk l ml mm">const loading = new BehaviorSubject&lt;boolean&gt;(false)<br/><br/>loading<br/>    .asObservable()<br/>    .subscribe({ next: (val) =&gt; console.log(val) })<br/><br/>// update<br/>loading.next(true)<br/>loading.next(true)<br/><br/>// output (timeline)<br/>// -false-----true-----true----</span></pre><p id="2d37" class="pw-post-body-paragraph jz ka ir kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ik bi translated">å¦ä¸€æ–¹é¢ï¼Œå¦‚æœä½¿ç”¨StateSubjectï¼Œå®ƒå°†å‘å‡ºä¸€æ¬¡ï¼Œå› ä¸ºç¬¬äºŒæ¬¡æ–‡æœ¬å€¼æ²¡æœ‰æ”¹å˜ã€‚</p><pre class="ma mb mc md gu me lz mf bn mg mh bi"><span id="ebda" class="mi kz ir lz b be mj mk l ml mm">const loading = new StateSubject&lt;boolean&gt;(false)<br/><br/>loading<br/>    .value$<br/>    .subscribe({ next: (val) =&gt; console.log(val) })<br/><br/>// update<br/>loading.next(true)<br/>loading.next(true)<br/><br/>// output (timeline)<br/>// -false-----true-------------</span></pre><h2 id="5e63" class="ky kz ir bd la lb lc dn ld le lf dp lg kk lh li lj ko lk ll lm ks ln lo lp lq bi translated">ç¬¬äºŒæ­¥:å‚¨å­˜</h2><p id="e5d1" class="pw-post-body-paragraph jz ka ir kb b kc lr ke kf kg ls ki kj kk lt km kn ko lu kq kr ks lv ku kv kw ik bi translated">å¥½çš„ï¼Œæˆ‘ä»¬èŠ±äº†å¤§çº¦15è¡Œåœ¨StateSubjectç±»ä¸Šã€‚æ¥ä¸‹æ¥æ˜¯å¸¦<strong class="kb is">åº—</strong>çº§çš„~35ã€‚</p><pre class="ma mb mc md gu me lz mf bn mg mh bi"><span id="4b76" class="mi kz ir lz b be mj mk l ml mm">import { isEqual } from 'radash'<br/>import { distinctUntilChanged, filter, map, Observable, share, Subject, takeUntil } from 'rxjs'<br/>import { StateSubject } from './state-subject'<br/><br/>export class Store&lt;T extends Object&gt; {<br/>    private unsubscriber: Subject&lt;void&gt;<br/>    private state: StateSubject&lt;T&gt;<br/><br/>    constructor(value: T, unsubscriber: Subject&lt;void&gt;) {<br/>        this.state = new StateSubject(value)<br/>        this.unsubscriber = unsubscriber<br/>    }<br/><br/>    setState(value: Partial&lt;T&gt;): void {<br/>        this.state.next({ ...this.state.value, ...value })<br/>    }<br/><br/>    getState(): T {<br/>        return this.state.value<br/>    }<br/><br/>    select&lt;K extends keyof T&gt;(key: K): Observable&lt;T[K]&gt; {<br/>        return this.state.value$.pipe(<br/>            map((state) =&gt; state[key]),<br/>            distinctUntilChanged((a, b) =&gt; isEqual(a, b)),<br/>            share(),<br/>            takeUntil(this.unsubscriber),<br/>        )<br/>    }<br/><br/>    selectAll(): Observable&lt;T&gt; {<br/>        return this.state.value$.pipe(<br/>            share(), <br/>            takeUntil(this.unsubscriber)<br/>        )<br/>    }<br/><br/>    reset(): void {<br/>        this.state.reset()<br/>    }<br/>}</span></pre><p id="a5a2" class="pw-post-body-paragraph jz ka ir kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ik bi translated">ä¸ºäº†åˆå§‹åŒ–storeç±»ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªèµ·å§‹å€¼å’Œä¸€ä¸ªç»ˆæ­¢Storeçš„é€€è®¢å™¨<code class="fe lw lx ly lz b">Subject</code>ã€‚å•†åº—çš„å…¶ä»–æ–¹æ³•:</p><ul class=""><li id="bb4e" class="mn mo ir kb b kc kd kg kh kk mp ko mq ks mr kw ms mt mu mv bi translated"><strong class="kb is"> setState </strong>:ç”¨è¾“å…¥å€¼è¦†ç›–çŠ¶æ€ã€‚</li><li id="acb8" class="mn mo ir kb b kc mw kg mx kk my ko mz ks na kw ms mt mu mv bi translated"><strong class="kb is"> getState </strong>:è·å–å½“å‰çŠ¶æ€çš„é™æ€å€¼ã€‚æœ‰æ—¶å®ƒä¼šéå¸¸æ–¹ä¾¿ã€‚</li><li id="7795" class="mn mo ir kb b kc mw kg mx kk my ko mz ks na kw ms mt mu mv bi translated"><strong class="kb is">é€‰æ‹©</strong>:ä½ å¯èƒ½ç†Ÿæ‚‰å…¶ä»–çŠ¶æ€ç®¡ç†åº“ä¸­çš„æœ¯è¯­<code class="fe lw lx ly lz b">select</code>ã€‚å®ƒé€‰å–çŠ¶æ€çš„ä¸€éƒ¨åˆ†ä½œä¸ºå¯è§‚æµ‹å€¼ã€‚</li><li id="237c" class="mn mo ir kb b kc mw kg mx kk my ko mz ks na kw ms mt mu mv bi translated"><strong class="kb is">é€‰æ‹©å…¨éƒ¨</strong>:å½“éœ€è¦æ•´ä¸ªçŠ¶æ€ä¸ºå¯è§‚å¯Ÿæ—¶ã€‚</li><li id="34bb" class="mn mo ir kb b kc mw kg mx kk my ko mz ks na kw ms mt mu mv bi translated"><strong class="kb is">å¤ä½</strong>:å°†æ•´ä¸ªçŠ¶æ€å¤ä½åˆ°åˆå§‹å€¼ã€‚</li></ul><h2 id="b810" class="ky kz ir bd la lb lc dn ld le lf dp lg kk lh li lj ko lk ll lm ks ln lo lp lq bi translated">æ­¥éª¤3:ç”¨æ³•:MovieListStateService</h2><p id="5d02" class="pw-post-body-paragraph jz ka ir kb b kc lr ke kf kg ls ki kj kk lt km kn ko lu kq kr ks lv ku kv kw ik bi translated">æˆ‘ä»¬å·²ç»å®Œæˆäº†ç®¡ç†åº”ç”¨ç¨‹åºçŠ¶æ€æ‰€éœ€çš„ç±»ã€‚åœ¨è¿™ä¸ªç¤ºä¾‹åœºæ™¯ä¸­ï¼Œæˆ‘ä»¬æ­£åœ¨ç¼–å†™ä¸€ä¸ªå…·æœ‰æœç´¢å’Œåˆ†é¡µåŠŸèƒ½çš„ç”µå½±åˆ—è¡¨é¡µé¢ã€‚é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦å¼„æ¸…æ¥šç»„ä»¶çš„çŠ¶æ€éœ€è¦ä»€ä¹ˆå€¼:</p><ul class=""><li id="fc0a" class="mn mo ir kb b kc kd kg kh kk mp ko mq ks mr kw ms mt mu mv bi translated"><strong class="kb is">åŠ è½½</strong>:æ˜¾ç¤ºä¸€ä¸ªå¾®è°ƒæŒ‰é’®æˆ–è¿›åº¦æ¡ã€‚</li><li id="89f5" class="mn mo ir kb b kc mw kg mx kk my ko mz ks na kw ms mt mu mv bi translated"><strong class="kb is">é¡µ</strong>:å½“å‰é¡µç ã€‚</li><li id="4eb3" class="mn mo ir kb b kc mw kg mx kk my ko mz ks na kw ms mt mu mv bi translated"><strong class="kb is">å¤§å°</strong>:æ¯é¡µçš„ç»“æœæ•°ã€‚</li><li id="322d" class="mn mo ir kb b kc mw kg mx kk my ko mz ks na kw ms mt mu mv bi translated"><strong class="kb is">æœç´¢è¯</strong>:æŒ‰åç§°æœç´¢ç”µå½±ã€‚</li><li id="5ba7" class="mn mo ir kb b kc mw kg mx kk my ko mz ks na kw ms mt mu mv bi translated"><strong class="kb is">å¹´ä»½</strong>:è¿‡æ»¤ç‰¹å®šå¹´ä»½ä»¥åä¸Šæ˜ çš„ç”µå½±ã€‚</li><li id="9bcb" class="mn mo ir kb b kc mw kg mx kk my ko mz ks na kw ms mt mu mv bi translated"><strong class="kb is">ç”µå½±</strong>:æœ€åæ˜¯API/æ•°æ®åº“è¿”å›çš„ç”µå½±åˆ—è¡¨ã€‚</li></ul><p id="122c" class="pw-post-body-paragraph jz ka ir kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ik bi translated">å…¶æ¬¡ï¼Œæˆ‘ä»¬éœ€è¦ä¸ºæ•´ä¸ªçŠ¶æ€å¾—å‡ºä¸€ä¸ªåˆç†çš„åˆå§‹å€¼ã€‚å¼€å§‹çš„æ—¶å€™ï¼Œä¸ä¼šæœ‰ç”µå½±ï¼Œæœç´¢æ ä¹Ÿæ˜¯ç©ºçš„ã€‚æ‰€ä»¥æˆ‘ä»¬å¯ä»¥è¿™æ ·å£°æ˜æˆ‘ä»¬çš„å•†åº—:</p><pre class="ma mb mc md gu me lz mf bn mg mh bi"><span id="794b" class="mi kz ir lz b be mj mk l ml mm">store = new Store&lt;{<br/>    loading: boolean<br/>    movies: Movie[]<br/>    page: number<br/>    size: number<br/>    year: number<br/>    search: string<br/>}&gt;(<br/>    {<br/>        loading: false,<br/>        movies: [],<br/>        page: 0,<br/>        size: 10,<br/>        year: new Date().getFullYear(),<br/>        search: '',<br/>    },<br/>    this.unsubscriber, // 1<br/>)</span></pre><p id="e836" class="pw-post-body-paragraph jz ka ir kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ik bi translated">æ³¨æ„(1)ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªé€€è®¢ä¸»é¢˜ï¼Œå®ƒå°†åœ¨ç»„ä»¶è¢«é”€æ¯æ—¶å®Œæˆã€‚è¿™å°†ç¡®ä¿ä¸ä¼šå‘ç”Ÿå†…å­˜æ³„æ¼ã€‚æˆ‘ä»¬å¯ä»¥å°†å®ƒæŒ‚åœ¨<code class="fe lw lx ly lz b">ngOnDestroy</code>æŒ‚é’©ä¸Šï¼Œè½»æ¾åˆ¶ä½œä¸€ä¸ª:</p><pre class="ma mb mc md gu me lz mf bn mg mh bi"><span id="b040" class="mi kz ir lz b be mj mk l ml mm">private unsubscriber = new Subject&lt;void&gt;()<br/><br/>ngOnDestroy() {<br/>    this.unsubscriber.next()<br/>    this.unsubscriber.complete()<br/>}</span></pre><p id="16ed" class="pw-post-body-paragraph jz ka ir kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ik bi translated">ç°åœ¨ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ç§æœºåˆ¶ï¼Œæ— è®ºä½•æ—¶æœç´¢ã€é¡µç ã€é¡µé¢å¤§å°æˆ–å¹´ä»½å€¼å‘ç”Ÿå˜åŒ–ï¼Œéƒ½å¯ä»¥è·å–ç”µå½±:</p><pre class="ma mb mc md gu me lz mf bn mg mh bi"><span id="cd88" class="mi kz ir lz b be mj mk l ml mm">combineLatest({<br/>    search: this.store.select('search'),<br/>    page: this.store.select('page'),<br/>    size: this.store.select('size'),<br/>    year: this.store.select('year'),<br/>})<br/>.pipe(<br/>    debounceTime(300), // 2<br/>    tap(() =&gt; this.store.setState({ loading: true })),<br/>    switchMap(({ search, page, size, year }) =&gt; {<br/>        return this.movieApi.find({ search, page, size, year })<br/>    }),<br/>    takeUntil(this.unsubscriber),<br/>)<br/>.subscribe({<br/>    next: (res) =&gt; {<br/>        this.store.setState({ <br/>            movies: res.data, <br/>            loading: false <br/>        })<br/>    },<br/>})</span></pre><p id="a124" class="pw-post-body-paragraph jz ka ir kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ik bi translated">æ³¨æ„(2):æœ‰äº›æ—¶å€™å‚æ•°æ›´æ–°å¾—éå¸¸å¿«â€”â€”æ¯”å¦‚ç”¨æˆ·åœ¨åˆ†é¡µæ ä¸Šå•å‡»nextå¤ªå¿«ã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆæˆ‘ä»¬ä½¿ç”¨<code class="fe lw lx ly lz b">debounceTime()</code> RxJSæ“ä½œç¬¦æ¥ä¸¢å¼ƒé—´æ­‡å€¼ï¼Œä»¥ä¾¿åç«¯ä¸ä¼šè¢«è¿‡äºé¢‘ç¹åœ°è°ƒç”¨ã€‚</p><p id="89f8" class="pw-post-body-paragraph jz ka ir kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ik bi translated">æˆ‘ä»¬å¯ä»¥è€ƒè™‘å¦ä¸€ä¸ªåŠŸèƒ½â€”æ¯å½“æœç´¢è¯æ›´æ–°æ—¶ï¼Œé¡µç åº”è¯¥é‡ç½®ä¸º1:</p><pre class="ma mb mc md gu me lz mf bn mg mh bi"><span id="b888" class="mi kz ir lz b be mj mk l ml mm">private onSearchTermChange(): void {<br/>    this.store.select('search').pipe(<br/>        distinctUntilChange(),<br/>        takeUntil(this.unsubscriber),<br/>    ).subscribe({<br/>        next: () =&gt; this.store.setState({ page: 1 })<br/>    })<br/>}</span></pre><p id="0b95" class="pw-post-body-paragraph jz ka ir kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ik bi translated">è¯·æ³¨æ„ï¼Œå³ä½¿åœ¨ç¼–å†™æ¨¡æ¿ä¹‹å‰ï¼Œæ‚¨ä¹Ÿåœ¨å®šä¹‰ä¸šåŠ¡é€»è¾‘ã€‚ä»¥è¿™ç§æ–¹å¼éš”ç¦»ä¸šåŠ¡é€»è¾‘ç»™äº†æ‚¨å¯¹å¯è¯»æ€§å’Œå¯æµ‹è¯•æ€§çš„å·¨å¤§æ§åˆ¶ã€‚ç°åœ¨å¤§å¤šæ•°ä»£ç éƒ½æ˜¯å•å…ƒå¯æµ‹è¯•çš„ï¼Œä¸éœ€è¦è¿›è¡Œe2eæµ‹è¯•æ¥ä»¥ç¼–ç¨‹æ–¹å¼ç‚¹å‡»ä¸€ä¸ªæŒ‰é’®å¹¶æµ‹è¯•ä¸€ä¸ªç‰¹æ€§ã€‚å¦‚æœä¸šåŠ¡é€»è¾‘æ­£å¸¸å·¥ä½œï¼Œè¡¨ç¤ºå±‚ä¹Ÿæ˜¯å¦‚æ­¤ã€‚</p><p id="afc4" class="pw-post-body-paragraph jz ka ir kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ik bi translated">è¿™é‡Œæ˜¯<code class="fe lw lx ly lz b">MovieListStateService</code>çš„å®Œæ•´ä»£ç ã€‚å› ä¸ºå®ƒå°†åœ¨ä¸€ä¸ªç»„ä»¶ä¸­æä¾›ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸åœ¨<code class="fe lw lx ly lz b">@Injectable</code>è£…é¥°å™¨ä¸­ä½¿ç”¨<code class="fe lw lx ly lz b">providedIn: 'root'</code>ã€‚</p><pre class="ma mb mc md gu me lz mf bn mg mh bi"><span id="4357" class="mi kz ir lz b be mj mk l ml mm">import { Injectable, OnDestroy } from '@angular/core'<br/>import { Movie} from '@core/interfaces'<br/>import { Store } from '@core/utils/store'<br/>import { combineLatest, debounceTime, Subject, switchMap, takeUntil, tap } from 'rxjs'<br/>import { MovieApiService } from '../services/movie-api.service'<br/><br/>@Injectable()<br/>export class MovieListStateService implements OnDestroy {<br/>    private unsubscriber: Subject&lt;void&gt; = new Subject&lt;void&gt;()<br/><br/>    store = new Store&lt;{<br/>        loading: boolean<br/>        movies: Movie[]<br/>        page: number<br/>        size: number<br/>        year: number<br/>        search: string<br/>    }&gt;(<br/>        {<br/>            loading: false,<br/>            movies: [],<br/>            page: 0,<br/>            size: 10,<br/>            year: new Date().getFullYear(),<br/>            search: '',<br/>        },<br/>        this.unsubscriber,<br/>    )<br/><br/>    constructor(private movieApi: MovieApiService) {<br/>        this.init()<br/>        this.onSearchTermChange()<br/>    }<br/><br/>    ngOnDestroy(): void {<br/>        this.unsubscriber.next()<br/>        this.unsubscriber.complete()<br/>    }<br/><br/>    private init(): void {<br/>        combineLatest({<br/>            search: this.store.select('search'),<br/>            page: this.store.select('page'),<br/>            size: this.store.select('size'),<br/>            year: this.store.select('year'),<br/>        })<br/>        .pipe(<br/>            debounceTime(300),<br/>            tap(() =&gt; this.store.setState({ loading: true })),<br/>            switchMap(({ search, page, size, year }) =&gt; {<br/>                return this.movieApi.find({ search, page, size, year })<br/>            }),<br/>            takeUntil(this.unsubscriber),<br/>        )<br/>        .subscribe({<br/>            next: (res) =&gt; {<br/>                this.store.setState({ <br/>                    movies: res.data, <br/>                    loading: false <br/>                })<br/>            },<br/>        })<br/>    }<br/><br/>    private onSearchTermChange(): void {<br/>        // when search term changes, reset page to 1<br/>        this.store.select('search').pipe(<br/>            distinctUntilChange(),<br/>            takeUntil(this.unsubscriber),<br/>        ).subscribe({<br/>            next: () =&gt; this.store.setState({ page: 1 })<br/>        })<br/>    }<br/>}</span></pre><h2 id="6652" class="ky kz ir bd la lb lc dn ld le lf dp lg kk lh li lj ko lk ll lm ks ln lo lp lq bi translated">æ­¥éª¤4:å°†å®ƒæ’å…¥ç»„ä»¶</h2><p id="cdfc" class="pw-post-body-paragraph jz ka ir kb b kc lr ke kf kg ls ki kj kk lt km kn ko lu kq kr ks lv ku kv kw ik bi translated">ç°åœ¨è®©æˆ‘ä»¬å°†æˆ‘ä»¬çš„<code class="fe lw lx ly lz b">MovieListStateService</code>æä¾›ç»™é¡µé¢ç»„ä»¶ã€‚</p><pre class="ma mb mc md gu me lz mf bn mg mh bi"><span id="b5d5" class="mi kz ir lz b be mj mk l ml mm">@Component({<br/>    standalone: true,<br/>    imports: [CommonModule, RouterModule, //...],<br/>    template: `<br/>    &lt;app-loading-spinner *ngIf="loading$ | async"&gt;&lt;/app-loading-spinner&gt;<br/><br/>    &lt;input type="text" [(ngModel)]="search"&gt;<br/>    &lt;button (click)="doSearch()"&gt;Search&lt;/button&gt;<br/><br/>    &lt;div <br/>        *ngIf="movies$ | async as movies" <br/>    &gt;<br/>        &lt;app-movie-card<br/>            *ngFor="let movie of movies"<br/>            [movie]="movie"<br/>        &gt;&lt;/app-movie-card&gt;<br/>    &lt;/div&gt;<br/><br/>    &lt;button (click)="changePage(-1)"&gt;Prev&lt;/button&gt;<br/>    &lt;button (click)="changePage(1)"&gt;Next&lt;/button&gt;<br/>    `,<br/>    providers: [MovieListStateService],<br/>})<br/>export class HomePageComponent {<br/>    search = ''<br/><br/>    constructor(<br/>        private movieListState: MovieListStateService,<br/>        private activatedRoute: ActivatedRoute,<br/>    ) {<br/>        const page = +this.activatedRoute.snapshot.queryParams.page<br/>        // load first page<br/>        this.movieListState.store.setState({ page: page ?? 1 })<br/>    }<br/><br/>    get movies$(): Observable&lt;Movie[]&gt; {<br/>        return this.movieListState.store.select('movies')<br/>    }<br/><br/>    get loading$(): Observable&lt;boolean&gt; {<br/>        return this.movieListState.store.select('loading')<br/>    }<br/><br/>    changePage(dir: 1 | -1): void {<br/>        const next = this.movieListState.store.getState().page + dir<br/>        this.movieListState.store.setState({ page: next })<br/>    }<br/><br/>    doSearch(): void {<br/>        this.movieListState.store.setState({ search: this.search })<br/>    }<br/>}</span></pre><p id="6607" class="pw-post-body-paragraph jz ka ir kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ik bi translated">æˆ‘ä»¬ä»çŠ¶æ€ä¸­é€‰æ‹©<code class="fe lw lx ly lz b">movies</code>æ•°ç»„å’Œ<code class="fe lw lx ly lz b">loading</code>å€¼ï¼Œåœ¨æ¨¡æ¿ä¸­æŸ¥çœ‹ã€‚ç„¶è€Œï¼Œæˆ‘ä»¬æ›´æ–°é¡µé¢ï¼Œæœç´¢ç­‰ã€‚é€šè¿‡äº‹ä»¶ç”¨æ–°å€¼è®¾ç½®çŠ¶æ€ã€‚å°±æ˜¯è¿™æ ·ï¼æˆ‘ä»¬çš„ç»„ä»¶é™¤äº†æ¼”ç¤ºä¹‹å¤–ä¸åšä»»ä½•å¤æ‚çš„å·¥ä½œã€‚Angularæœ¬æ¥å°±æ˜¯è¿™æ ·çš„ã€‚</p><p id="a381" class="pw-post-body-paragraph jz ka ir kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ik bi translated">ä½ ä¸€ç›´ç¼–ç é”™è¯¯ï¼ğŸ˜„</p><h2 id="4a41" class="ky kz ir bd la lb lc dn ld le lf dp lg kk lh li lj ko lk ll lm ks ln lo lp lq bi translated">ç»“è®º</h2><p id="3110" class="pw-post-body-paragraph jz ka ir kb b kc lr ke kf kg ls ki kj kk lt km kn ko lu kq kr ks lv ku kv kw ik bi translated">ä½¿ç”¨çŠ¶æ€ç®¡ç†è§£å†³æ–¹æ¡ˆä¸ºæ‚¨çš„ä»£ç åº“å¸¦æ¥äº†è®¸å¤šå¯èƒ½æ€§ã€‚æ‚¨çš„ä¸šåŠ¡é€»è¾‘ä¸ä¸–éš”ç»ï¼Œè¿™æ˜¯ä¸€ä¸ªå·¨å¤§çš„å¥½å¤„ã€‚æ‚¨å¯ä»¥åœ¨å¤šä¸ªç»„ä»¶ä¸­é‡ç”¨ä¸€ä¸ªçŠ¶æ€ã€‚æœ€é‡è¦çš„æ˜¯ï¼Œä½ çš„åº”ç”¨ç¨‹åºä¼šæ„Ÿè§‰æµç•…ã€‚</p><p id="eef6" class="pw-post-body-paragraph jz ka ir kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ik bi translated">è®©å›¢é˜Ÿçš„æ–°æˆå‘˜ä½¿ç”¨åŸºæœ¬è§£å†³æ–¹æ¡ˆæ›´å®¹æ˜“ã€‚å½“æ¯ä¸ªäººéƒ½å‡†å¤‡å¥½äº†ï¼Œä½ å°±å¯ä»¥å¾ˆå®¹æ˜“åœ°ç§»æ¤åˆ°NGRXæˆ–ä»»ä½•å…¶ä»–é«˜çº§çŠ¶æ€ç®¡ç†åº“ï¼Œå› ä¸ºå®ƒä»¬çš„å·¥ä½œåŸç†æ˜¯ä¸€æ ·çš„ã€‚</p><p id="896b" class="pw-post-body-paragraph jz ka ir kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ik bi translated">æ„Ÿè°¢æ‚¨çš„é˜…è¯»ã€‚å…³æ³¨æˆ‘æ›´å¤šç±»ä¼¼è¿™æ ·æœ‰è¶£çš„æœ‰è§’åº¦çš„æ–‡ç« ã€‚</p><ul class=""><li id="5c69" class="mn mo ir kb b kc kd kg kh kk mp ko mq ks mr kw ms mt mu mv bi translated"><em class="kx"> *å¦‚æœä½ ä¸æƒ³åœ¨æ¯ä¸ªé¡¹ç›®ä¸­å†™StateSubjectå’ŒStoreç±»ï¼Œé‚£ä¹ˆå¥½æ¶ˆæ¯ï¼æˆ‘å·²ç»åœ¨ä¸€ä¸ªåä¸º</em><a class="ae nb" href="https://www.npmjs.com/package/rxjs-state-subject" rel="noopener ugc nofollow" target="_blank"><em class="kx">rxjs-state-subject</em></a><em class="kx">çš„npmåŒ…ä¸­å‘å¸ƒäº†è¿™äº›ç±»ã€‚å®ƒä½¿ç”¨RxJS v7.5+ï¼Œå’Œ</em><a class="ae nb" href="https://www.npmjs.com/package/radash" rel="noopener ugc nofollow" target="_blank"><em class="kx">radash</em></a>v 9.3+(lodashçš„ç°ä»£æ›¿ä»£)ã€‚</li></ul><p id="6879" class="pw-post-body-paragraph jz ka ir kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ik bi translated"><em class="kx">æ›´å¤šå†…å®¹çœ‹</em> <a class="ae nb" href="https://plainenglish.io/" rel="noopener ugc nofollow" target="_blank"> <strong class="kb is"> <em class="kx">è¯´ç™½äº†å°±æ˜¯</em> </strong> </a> <em class="kx">ã€‚æŠ¥åå‚åŠ æˆ‘ä»¬çš„</em> <a class="ae nb" href="http://newsletter.plainenglish.io/" rel="noopener ugc nofollow" target="_blank"> <strong class="kb is"> <em class="kx">å…è´¹å‘¨æŠ¥</em> </strong> </a> <em class="kx">ã€‚å…³æ³¨æˆ‘ä»¬</em> <a class="ae nb" href="https://twitter.com/inPlainEngHQ" rel="noopener ugc nofollow" target="_blank"> <strong class="kb is"> <em class="kx">æ¨ç‰¹</em> </strong> </a>ï¼Œ<a class="ae nb" href="https://www.linkedin.com/company/inplainenglish/" rel="noopener ugc nofollow" target="_blank"><strong class="kb is"><em class="kx">LinkedIn</em></strong></a><em class="kx">ï¼Œ</em><a class="ae nb" href="https://www.youtube.com/channel/UCtipWUghju290NWcn8jhyAw" rel="noopener ugc nofollow" target="_blank"><strong class="kb is"><em class="kx">YouTube</em></strong></a><em class="kx">ï¼Œ</em><a class="ae nb" href="https://discord.gg/GtDtUAvyhW" rel="noopener ugc nofollow" target="_blank"><em class="kx">ä¸å’Œ</em>  </a> <em class="kx">ã€‚å¯¹å¢é•¿é»‘å®¢æ„Ÿå…´è¶£ï¼Ÿæ£€æŸ¥å‡º</em> <a class="ae nb" href="https://circuit.ooo/" rel="noopener ugc nofollow" target="_blank"> <strong class="kb is"> <em class="kx">ç”µè·¯</em> </strong> </a> <em class="kx">ã€‚</em></p></div></div>    
</body>
</html>