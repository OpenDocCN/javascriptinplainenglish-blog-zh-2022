<html>
<head>
<title>Create Your Own URL Shortener with Next.js and MongoDB in 10 Minutes</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用Next.js和MongoDB在10分钟内创建你自己的网址缩写</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/create-your-own-url-shortener-with-next-js-and-mongodb-in-10-minutes-ccf52caf4d52?source=collection_archive---------11-----------------------#2022-03-14">https://javascript.plainenglish.io/create-your-own-url-shortener-with-next-js-and-mongodb-in-10-minutes-ccf52caf4d52?source=collection_archive---------11-----------------------#2022-03-14</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><div class=""><h2 id="e914" class="pw-subtitle-paragraph jk im in bd b jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb dk translated">使用Next.js创建URL shortener的完整服务和使用MongoDB存储链接的指南。</h2></div><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi kc"><img src="../Images/84fddde7fb46f8457fa7fea94471ca3a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*la26SYL1O-CrWL1C.png"/></div></div></figure><h1 id="812b" class="ko kp in bd kq kr ks kt ku kv kw kx ky jt kz ju la jw lb jx lc jz ld ka le lf bi translated">动机</h1><p id="40ff" class="pw-post-body-paragraph lg lh in li b lj lk jo ll lm ln jr lo lp lq lr ls lt lu lv lw lx ly lz ma mb ig bi translated">几周前，我正在开发一个Twitter机器人来发布我的热门文章，我意识到一些文章的链接在Tweet中没有被很好地解析。然而，使用<a class="ae mc" href="https://www.rebrandly.com/" rel="noopener ugc nofollow" target="_blank">重塑</a>来缩短它们效果很好。</p><p id="fecd" class="pw-post-body-paragraph lg lh in li b lj md jo ll lm me jr lo lp mf lr ls lt mg lv lw lx mh lz ma mb ig bi translated">所以，我决定为自己做一个网址缩短器。</p></div><div class="ab cl mi mj hr mk" role="separator"><span class="ml bw bk mm mn mo"/><span class="ml bw bk mm mn mo"/><span class="ml bw bk mm mn"/></div><div class="ig ih ii ij ik"><h1 id="829a" class="ko kp in bd kq kr mp kt ku kv mq kx ky jt mr ju la jw ms jx lc jz mt ka le lf bi translated">故障</h1><p id="9c75" class="pw-post-body-paragraph lg lh in li b lj lk jo ll lm ln jr lo lp lq lr ls lt lu lv lw lx ly lz ma mb ig bi translated">我们需要一个</p><ul class=""><li id="9da8" class="mu mv in li b lj md lm me lp mw lt mx lx my mb mz na nb nc bi translated">服务为每个长URL创建一个唯一的散列</li><li id="52eb" class="mu mv in li b lj nd lm ne lp nf lt ng lx nh mb mz na nb nc bi translated">用于保持长短URL映射的数据库</li><li id="b48a" class="mu mv in li b lj nd lm ne lp nf lt ng lx nh mb mz na nb nc bi translated">将短链接重定向到其目的地的服务</li></ul><p id="561e" class="pw-post-body-paragraph lg lh in li b lj md jo ll lm me jr lo lp mf lr ls lt mg lv lw lx mh lz ma mb ig bi translated">和往常一样，<strong class="li io"> Next.js </strong>是我构建完整服务的首选，而<strong class="li io"> MongoDB </strong>用于存储链接。</p></div><div class="ab cl mi mj hr mk" role="separator"><span class="ml bw bk mm mn mo"/><span class="ml bw bk mm mn mo"/><span class="ml bw bk mm mn"/></div><div class="ig ih ii ij ik"><h1 id="03ff" class="ko kp in bd kq kr mp kt ku kv mq kx ky jt mr ju la jw ms jx lc jz mt ka le lf bi translated">发展</h1><p id="f428" class="pw-post-body-paragraph lg lh in li b lj lk jo ll lm ln jr lo lp lq lr ls lt lu lv lw lx ly lz ma mb ig bi translated">既然我们已经想出了步骤，让我们一个接一个地做吧</p><h2 id="e1ce" class="ni kp in bd kq nj nk dn ku nl nm dp ky lp nn no la lt np nq lc lx nr ns le nt bi translated">设置项目</h2><p id="7c1a" class="pw-post-body-paragraph lg lh in li b lj lk jo ll lm ln jr lo lp lq lr ls lt lu lv lw lx ly lz ma mb ig bi translated">让我们使用<code class="fe nu nv nw nx b">npx create-next-app url-shortener</code>命令为我们的应用程序生成一个样板文件。</p><pre class="kd ke kf kg gt ny nx nz oa aw ob bi"><span id="8cc4" class="ni kp in nx b gy oc od l oe of">./.env.local <br/>DB_NAME=url-shortner<br/>ATLAS_URI_PROD=mongodb+srv://&lt;user&gt;:&lt;password&gt;&lt;cluster&gt;.mongodb.net/url-shortner?retryWrites=true&amp;w=majority </span><span id="e59f" class="ni kp in nx b gy og od l oe of">API_KEY=&lt;a-long-random-string&gt; <br/>HOST=http://localhost:3000</span></pre><p id="e1bb" class="pw-post-body-paragraph lg lh in li b lj md jo ll lm me jr lo lp mf lr ls lt mg lv lw lx mh lz ma mb ig bi translated">这些环境变量也应该存储在您的Vercel项目中。</p><blockquote class="oh oi oj"><p id="853d" class="lg lh ok li b lj md jo ll lm me jr lo ol mf lr ls om mg lv lw on mh lz ma mb ig bi translated"><em class="in"/><code class="fe nu nv nw nx b"><em class="in">HOST</em></code><em class="in">的值应该在你托管这个项目的时候设置到你的域。如果你没有公共域，就用你的</em> <code class="fe nu nv nw nx b"><em class="in">NEXT_PUBLIC_VERCEL_URL</em></code> <em class="in">环境变量代替</em> <code class="fe nu nv nw nx b"><em class="in">HOST</em></code> <em class="in">。</em></p></blockquote><h2 id="f26a" class="ni kp in bd kq nj nk dn ku nl nm dp ky lp nn no la lt np nq lc lx nr ns le nt bi translated">设置MongoDB</h2><ol class=""><li id="68ae" class="mu mv in li b lj lk lm ln lp oo lt op lx oq mb or na nb nc bi translated">跑<code class="fe nu nv nw nx b">npm i --save mongodb</code></li><li id="1c06" class="mu mv in li b lj nd lm ne lp nf lt ng lx nh mb or na nb nc bi translated">在repo的根目录下创建一个<code class="fe nu nv nw nx b">mongodb.ts</code>文件。</li></ol><pre class="kd ke kf kg gt ny nx nz oa aw ob bi"><span id="0cf5" class="ni kp in nx b gy oc od l oe of">// ./mongodb.ts<br/><br/>import { Db, MongoClient } from "mongodb";<br/>import { formatLog } from "./utils";<br/><br/>// Create cached connection variable<br/>let cachedDB: Db | null = null;<br/><br/>// A function for connecting to MongoDB,<br/>export default async function connectToDatabase(): Promise&lt;Db&gt; {<br/>  // If the database connection is cached, use it instead of creating a new connection<br/>  if (cachedDB) {<br/>    console.info(formatLog("Using cached client!"));<br/>    return cachedDB;<br/>  }<br/>  const opts = {<br/>    useNewUrlParser: true,<br/>    useUnifiedTopology: true,<br/>  };<br/>  console.info(formatLog("No client found! Creating a new one."));<br/>  // If no connection is cached, create a new one<br/>  const client = new MongoClient(process.env.ATLAS_URI_PROD as string, opts);<br/>  await client.connect();<br/>  const db: Db = client.db(process.env.DB_NAME);<br/>  cachedDB = db;<br/>  return cachedDB;<br/>}</span></pre><h2 id="96e8" class="ni kp in bd kq nj nk dn ku nl nm dp ky lp nn no la lt np nq lc lx nr ns le nt bi translated">添加创建短链接服务</h2><p id="bdb3" class="pw-post-body-paragraph lg lh in li b lj lk jo ll lm ln jr lo lp lq lr ls lt lu lv lw lx ly lz ma mb ig bi translated">继续添加一个<code class="fe nu nv nw nx b">./api/create-link.ts</code>文件，为这个服务创建一个REST端点。</p><p id="bde2" class="pw-post-body-paragraph lg lh in li b lj md jo ll lm me jr lo lp mf lr ls lt mg lv lw lx mh lz ma mb ig bi translated">我们需要注意几件事</p><ol class=""><li id="9c18" class="mu mv in li b lj md lm me lp mw lt mx lx my mb or na nb nc bi translated">创建短URL需要唯一的哈希。我使用<code class="fe nu nv nw nx b">nanoid</code>为长URL生成一个随机的短散列。</li><li id="1a08" class="mu mv in li b lj nd lm ne lp nf lt ng lx nh mb or na nb nc bi translated">此端点应仅由POST方法访问。</li><li id="0af7" class="mu mv in li b lj nd lm ne lp nf lt ng lx nh mb or na nb nc bi translated">我们应该设置一个API密钥认证来保护端点。这可以通过生成一个长字符串并将其用作API-KEY头来实现。</li></ol><pre class="kd ke kf kg gt ny nx nz oa aw ob bi"><span id="0bb7" class="ni kp in nx b gy oc od l oe of">// ./api/create-link.ts<br/><br/>import { NextApiRequest, NextApiResponse } from "next";<br/>import connectToDatabase from "../../mongodb";<br/>import { customAlphabet } from "nanoid";<br/>import { COLLECTION_NAMES } from "../../types";<br/><br/>const characters =<br/>  "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";<br/>const getHash = customAlphabet(characters, 4);<br/><br/>export default async function CreateLink(<br/>  request: NextApiRequest,<br/>  response: NextApiResponse<br/>) {<br/>  const apiKey = request.headers["api-key"] as string;<br/>  if (request.method !== "POST" || apiKey !== process.env.API_KEY) {<br/>    return response.status(405).json({<br/>      type: "Error",<br/>      code: 405,<br/>      message: "Only POST method is accepted on this route",<br/>    });<br/>  }<br/>  const { link } = request.body;<br/><br/>  if (!link) {<br/>    response.status(400).send({<br/>      type: "Error",<br/>      code: 400,<br/>      message: "Expected {link: string}",<br/>    });<br/>    return;<br/>  }<br/>  try {<br/>    const database = await connectToDatabase();<br/>    const urlInfoCollection = database.collection(COLLECTION_NAMES["url-info"]);<br/>    const hash = getHash();<br/>    const linkExists = await urlInfoCollection.findOne({<br/>      link,<br/>    });<br/>    const shortUrl = `${process.env.HOST}/${hash}`;<br/>    if (!linkExists) {<br/>      await urlInfoCollection.insertOne({<br/>        link,<br/>        uid: hash,<br/>        shortUrl: shortUrl,<br/>        createdAt: new Date(),<br/>      });<br/>    }<br/>    response.status(201);<br/>    response.send({<br/>      type: "success",<br/>      code: 201,<br/>      data: {<br/>        shortUrl: linkExists?.shortUrl || shortUrl,<br/>        link,<br/>      },<br/>    });<br/>  } catch (e: any) {<br/>    response.status(500);<br/>    response.send({<br/>      code: 500,<br/>      type: "error",<br/>      message: e.message,<br/>    });<br/>  }<br/>}</span></pre><h2 id="d51a" class="ni kp in bd kq nj nk dn ku nl nm dp ky lp nn no la lt np nq lc lx nr ns le nt bi translated">将短链接重定向到目标</h2><p id="f3de" class="pw-post-body-paragraph lg lh in li b lj lk jo ll lm ln jr lo lp lq lr ls lt lu lv lw lx ly lz ma mb ig bi translated">现在我们可以创建短链接，让我们添加将用户重定向到实际目的地的逻辑。</p><p id="3913" class="pw-post-body-paragraph lg lh in li b lj md jo ll lm me jr lo lp mf lr ls lt mg lv lw lx mh lz ma mb ig bi translated">为此，我们可以在Next.js应用程序中创建一个动态路由，并在服务器端编写重定向逻辑。</p><pre class="kd ke kf kg gt ny nx nz oa aw ob bi"><span id="c937" class="ni kp in nx b gy oc od l oe of">// ./pages/[hash].tsx</span><span id="74f6" class="ni kp in nx b gy og od l oe of">import { NextApiRequest, NextApiResponse, NextPage } from "next";<br/>import Head from "next/head";<br/>import connectToDatabase from "../mongodb";<br/>import { COLLECTION_NAMES } from "../types";</span><span id="eb81" class="ni kp in nx b gy og od l oe of">export async function getServerSideProps(request: NextApiRequest) {<br/>  const hash = request.query.hash as string;<br/>  const database = await connectToDatabase();<br/>  const campaign = await database<br/>    .collection(COLLECTION_NAMES["url-info"])<br/>    .findOne({ uid: hash });</span><span id="00c9" class="ni kp in nx b gy og od l oe of">  if (campaign) {<br/>    return {<br/>      redirect: {<br/>        destination: campaign.link,<br/>        permanent: false,<br/>      },<br/>    };<br/>  }</span><span id="dac4" class="ni kp in nx b gy og od l oe of">  return {<br/>    props: {},<br/>  };<br/>}</span><span id="4ba7" class="ni kp in nx b gy og od l oe of">const HashPage: NextPage = () =&gt; {<br/>  return (<br/>    &lt;div&gt;<br/>      &lt;Head&gt;<br/>        &lt;title&gt;URL Shortener&lt;/title&gt;<br/>        &lt;meta name="description" content="Generated by create next app" /&gt;<br/>        &lt;link rel="icon" href="/favicon.ico" /&gt;<br/>      &lt;/Head&gt;<br/>      &lt;h1&gt;Requested link not found&lt;/h1&gt;<br/>    &lt;/div&gt;<br/>  );<br/>};</span><span id="02d4" class="ni kp in nx b gy og od l oe of">export default HashPage;</span></pre><p id="ceab" class="pw-post-body-paragraph lg lh in li b lj md jo ll lm me jr lo lp mf lr ls lt mg lv lw lx mh lz ma mb ig bi translated">如果数据库中有<code class="fe nu nv nw nx b">hash</code>值，该页面会将用户重定向到目的地，否则会显示“未找到链接”消息。</p></div><div class="ab cl mi mj hr mk" role="separator"><span class="ml bw bk mm mn mo"/><span class="ml bw bk mm mn mo"/><span class="ml bw bk mm mn"/></div><div class="ig ih ii ij ik"><h1 id="8918" class="ko kp in bd kq kr mp kt ku kv mq kx ky jt mr ju la jw ms jx lc jz mt ka le lf bi translated">主办；主持</h1><p id="3c15" class="pw-post-body-paragraph lg lh in li b lj lk jo ll lm ln jr lo lp lq lr ls lt lu lv lw lx ly lz ma mb ig bi translated">主持这个项目是小菜一碟，因为Next.js与Vercel的集成非常出色。</p><p id="baa3" class="pw-post-body-paragraph lg lh in li b lj md jo ll lm me jr lo lp mf lr ls lt mg lv lw lx mh lz ma mb ig bi translated">简化的步骤列表:</p><ol class=""><li id="8761" class="mu mv in li b lj md lm me lp mw lt mx lx my mb or na nb nc bi translated">将Next.js项目推送到GitHub存储库</li><li id="3903" class="mu mv in li b lj nd lm ne lp nf lt ng lx nh mb or na nb nc bi translated">进入<a class="ae mc" href="https://vercel.app" rel="noopener ugc nofollow" target="_blank"> https://vercel.app </a>，用你的GitHub账号登录</li><li id="1327" class="mu mv in li b lj nd lm ne lp nf lt ng lx nh mb or na nb nc bi translated">通过点击Vercel仪表板上的“New Project”按钮导入<code class="fe nu nv nw nx b">url-shortener</code>存储库。</li></ol><p id="ab69" class="pw-post-body-paragraph lg lh in li b lj md jo ll lm me jr lo lp mf lr ls lt mg lv lw lx mh lz ma mb ig bi translated">你也可以在这里详细阅读<a class="ae mc" href="https://vercel.com/docs/concepts/projects/overview" rel="noopener ugc nofollow" target="_blank">。</a></p><p id="5fdd" class="pw-post-body-paragraph lg lh in li b lj md jo ll lm me jr lo lp mf lr ls lt mg lv lw lx mh lz ma mb ig bi translated">完成上述步骤后，进入项目设置，将我们在<code class="fe nu nv nw nx b">.env.local</code>文件中定义的环境变量添加到Vercel项目的环境变量中。</p><blockquote class="oh oi oj"><p id="de84" class="lg lh ok li b lj md jo ll lm me jr lo ol mf lr ls om mg lv lw on mh lz ma mb ig bi translated"><em class="in">您也可以从设置中将您的自定义域连接到此项目。</em></p></blockquote><p id="e961" class="pw-post-body-paragraph lg lh in li b lj md jo ll lm me jr lo lp mf lr ls lt mg lv lw lx mh lz ma mb ig bi translated">🎉Tada！你的网址缩写已经准备好了，现在可以托管了。</p></div><div class="ab cl mi mj hr mk" role="separator"><span class="ml bw bk mm mn mo"/><span class="ml bw bk mm mn mo"/><span class="ml bw bk mm mn"/></div><div class="ig ih ii ij ik"><h1 id="c819" class="ko kp in bd kq kr mp kt ku kv mq kx ky jt mr ju la jw ms jx lc jz mt ka le lf bi translated">下一步是什么？</h1><p id="53bf" class="pw-post-body-paragraph lg lh in li b lj lk jo ll lm ln jr lo lp lq lr ls lt lu lv lw lx ly lz ma mb ig bi translated">嗯，你可以像我一样继续使用这个项目作为REST API，或者你可以创建一个前端，使它成为一个web应用程序。</p><blockquote class="oh oi oj"><p id="9c8f" class="lg lh ok li b lj md jo ll lm me jr lo ol mf lr ls om mg lv lw on mh lz ma mb ig bi translated"><em class="in">在使其成为公共web应用程序之前，请确保您添加了额外的安全性。</em></p></blockquote><p id="ab6b" class="pw-post-body-paragraph lg lh in li b lj md jo ll lm me jr lo lp mf lr ls lt mg lv lw lx mh lz ma mb ig bi translated">您可以从这个<a class="ae mc" href="https://github.com/Anshuman71/url-shotener" rel="noopener ugc nofollow" target="_blank"> GitHub Repo </a>中克隆这个项目。</p><p id="faf0" class="pw-post-body-paragraph lg lh in li b lj md jo ll lm me jr lo lp mf lr ls lt mg lv lw lx mh lz ma mb ig bi translated">这篇文章并不是要在生产中遵循，而只应该作为学习的目的。</p><p id="c3ed" class="pw-post-body-paragraph lg lh in li b lj md jo ll lm me jr lo lp mf lr ls lt mg lv lw lx mh lz ma mb ig bi translated">在上面的方法中可以进行许多优化，比如使用更好的数据库或适当地索引它以使它更快。</p><p id="2250" class="pw-post-body-paragraph lg lh in li b lj md jo ll lm me jr lo lp mf lr ls lt mg lv lw lx mh lz ma mb ig bi translated">希望这篇文章对你有帮助！如果您有任何反馈或问题，请随时在下面的评论中提出。</p><p id="ba50" class="pw-post-body-paragraph lg lh in li b lj md jo ll lm me jr lo lp mf lr ls lt mg lv lw lx mh lz ma mb ig bi translated">更多此类内容，请关注我的<a class="ae mc" href="https://twitter.com/sun_anshuman" rel="noopener ugc nofollow" target="_blank"> Twitter </a></p><blockquote class="oh oi oj"><p id="1b85" class="lg lh ok li b lj md jo ll lm me jr lo ol mf lr ls om mg lv lw on mh lz ma mb ig bi translated"><em class="in">直到下一次</em></p></blockquote><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div class="gh gi os"><img src="../Images/4b46a85d6b9838f1ffd64b9346dc0186.png" data-original-src="https://miro.medium.com/v2/resize:fit:490/0*b1hsXcPr-ZX8Wg8A.gif"/></div></figure></div><div class="ab cl mi mj hr mk" role="separator"><span class="ml bw bk mm mn mo"/><span class="ml bw bk mm mn mo"/><span class="ml bw bk mm mn"/></div><div class="ig ih ii ij ik"><p id="6b26" class="pw-post-body-paragraph lg lh in li b lj md jo ll lm me jr lo lp mf lr ls lt mg lv lw lx mh lz ma mb ig bi translated"><em class="ok">原载于2022年3月14日</em><a class="ae mc" href="https://theanshuman.dev/articles/create-your-own-url-shortener-with-nextjs-and-mongodb-in-10-minutes-4fg" rel="noopener ugc nofollow" target="_blank"><em class="ok">https://theanshuman . dev</em></a><em class="ok">。</em></p><p id="1079" class="pw-post-body-paragraph lg lh in li b lj md jo ll lm me jr lo lp mf lr ls lt mg lv lw lx mh lz ma mb ig bi translated"><em class="ok">更多内容请看</em><a class="ae mc" href="https://plainenglish.io/" rel="noopener ugc nofollow" target="_blank"><strong class="li io"><em class="ok">plain English . io</em></strong></a><em class="ok">。报名参加我们的</em> <a class="ae mc" href="http://newsletter.plainenglish.io/" rel="noopener ugc nofollow" target="_blank"> <strong class="li io"> <em class="ok">免费周报</em> </strong> </a> <em class="ok">。关注我们关于</em><a class="ae mc" href="https://twitter.com/inPlainEngHQ" rel="noopener ugc nofollow" target="_blank"><strong class="li io"><em class="ok">Twitter</em></strong></a><em class="ok">和</em><a class="ae mc" href="https://www.linkedin.com/company/inplainenglish/" rel="noopener ugc nofollow" target="_blank"><strong class="li io"><em class="ok">LinkedIn</em></strong></a><em class="ok">。加入我们的</em> <a class="ae mc" href="https://discord.gg/GtDtUAvyhW" rel="noopener ugc nofollow" target="_blank"> <strong class="li io"> <em class="ok">社区不和谐</em> </strong> </a> <em class="ok">。</em></p></div></div>    
</body>
</html>