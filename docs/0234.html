<html>
<head>
<title>How to Make Short Links Shorter: Using NGINX and Custom Domain</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何让短链接更短:使用NGINX和自定义域</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/making-short-links-shorter-using-nginx-custom-domain-44d2637fb329?source=collection_archive---------18-----------------------#2022-01-13">https://javascript.plainenglish.io/making-short-links-shorter-using-nginx-custom-domain-44d2637fb329?source=collection_archive---------18-----------------------#2022-01-13</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><div class=""><h2 id="0b2a" class="pw-subtitle-paragraph jk im in bd b jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb dk translated">如何缩短Twirl生成的短链接的指南？</h2></div><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div class="gh gi kc"><img src="../Images/f31a8a7aef50a77670f06f2f76d1241f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1286/format:webp/0*5bCIHrTVNaxALKET.jpg"/></div></figure><p id="d690" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">在这篇文章中，我解释了如何缩短由<a class="ae lg" href="https://otee.dev/2022/01/13/making-short-links-shorter.html" rel="noopener ugc nofollow" target="_blank">旋转</a>产生的短链接。比如从<code class="fe lh li lj lk b">oteetwirl.herokuapp.com/l/L5w2</code>到<code class="fe lh li lj lk b">twirl.otee.dev/l/L5w2</code>。</p><h1 id="55c8" class="ll lm in bd ln lo lp lq lr ls lt lu lv jt lw ju lx jw ly jx lz jz ma ka mb mc bi translated">问题陈述</h1><ol class=""><li id="72b6" class="md me in km b kn mf kq mg kt mh kx mi lb mj lf mk ml mm mn bi translated"><strong class="km io"> Twirl </strong>是一款基于用户的网址缩短应用。要了解更多关于Twirl是如何建造和设计的，请阅读<a class="ae lg" href="https://otee.dev/2021/11/14/twirl-user-management.html" rel="noopener ugc nofollow" target="_blank">这个</a>、<a class="ae lg" href="https://otee.dev/2021/12/08/storing-passwords-securely.html" rel="noopener ugc nofollow" target="_blank">这个</a>和<a class="ae lg" href="https://otee.dev/2021/12/20/twirl-link-shortening.html" rel="noopener ugc nofollow" target="_blank">这个</a>。下面是托管Twirl的GitHub库:<a class="ae lg" href="https://github.com/oitee/twirl" rel="noopener ugc nofollow" target="_blank">https://github.com/oitee/twirl</a>。</li><li id="0324" class="md me in km b kn mo kq mp kt mq kx mr lb ms lf mk ml mm mn bi translated">Twirl部署在<strong class="km io"> Heroku </strong>上，作为一款免费应用。在<a class="ae lg" href="https://oteetwirl.herokuapp.com/" rel="noopener ugc nofollow" target="_blank">oteetwirl.herokuapp.com</a>有售。</li><li id="adf6" class="md me in km b kn mo kq mp kt mq kx mr lb ms lf mk ml mm mn bi translated">Heroku上不提供支持HTTPS的自定义域名免费服务。这使得Twirl生成的结果短链接并不那么短。</li><li id="4a29" class="md me in km b kn mo kq mp kt mq kx mr lb ms lf mk ml mm mn bi translated">解决方案:我们继续在Heroku上运行Twirl，但使用了一个<strong class="km io">更短的自定义域</strong>，这将缩短应用程序生成的短链接。比如，app应该生成<a class="ae lg" href="https://twirl.otee.dev/l/L5w2" rel="noopener ugc nofollow" target="_blank"><strong class="km io"/></a>而不是生成<a class="ae lg" href="https://oteetwirl.herokuapp.com/l/L5w2" rel="noopener ugc nofollow" target="_blank">【oteetwirl.herokuapp.com/l/L5w2】</a></li><li id="1e0a" class="md me in km b kn mo kq mp kt mq kx mr lb ms lf mk ml mm mn bi translated">为了公开这个新的短链接，Twirl还应该在其UI上显示短链接的较短版本。</li></ol><h1 id="efd7" class="ll lm in bd ln lo lp lq lr ls lt lu lv jt lw ju lx jw ly jx lz jz ma ka mb mc bi translated">技术考虑</h1><p id="c6b4" class="pw-post-body-paragraph kk kl in km b kn mf jo kp kq mg jr ks kt mt kv kw kx mu kz la lb mv ld le lf ig bi translated">大体上，有三种方法可以做到这一点:</p><ol class=""><li id="2465" class="md me in km b kn ko kq kr kt mw kx mx lb my lf mk ml mm mn bi translated"><strong class="km io">方法一:完全迁移到IaaS </strong>:在自有服务器上运行整个应用，比如谷歌云计算。这将允许我们选择我们的域名，也运行系统。但是如果我们这样做，我们将需要管理数据库，并让服务器一直运行(不像Heroku的自动睡眠选项)。这里更大的担忧是世界已经知道了oteetwirl.herokuapp.com<a class="ae lg" href="https://oteetwirl.herokuapp.com" rel="noopener ugc nofollow" target="_blank"/>。为了不中断用户体验，我们不仅要将Heroku数据库中的数据复制到GCP服务器上，还要持续提供该应用程序上的旧短网址(即，让Heroku将当前短链接的请求重定向到GCP)。</li><li id="e976" class="md me in km b kn mo kq mp kt mq kx mr lb ms lf mk ml mm mn bi translated"><strong class="km io">方法II:定制到PaaS的重定向</strong>:提供从较短链接(使用定制的短域名)到主系统的重定向机制，主系统继续在Heroku上运行。这具有成本效益的优势，因为我们已经有了一个GCP服务器，它是为另一个项目设置的</li><li id="235e" class="md me in km b kn mo kq mp kt mq kx mr lb ms lf mk ml mm mn bi translated"><strong class="km io">方法三:I &amp; II </strong>的混合:在方法一中，理论上，我们可以让数据库在Heroku上运行，但让应用程序在GCP上运行，而不是提升和转移的迁移方式。但是这仍然不如方法二划算，因为GCP上的HTTP服务器必须连续运行。</li></ol><p id="d0d9" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">因此，我们的首选方法是第二种方法:</p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div class="gh gi mz"><img src="../Images/a17c08fd70dd5440c07b75c5ffbc4f25.png" data-original-src="https://miro.medium.com/v2/resize:fit:1196/format:webp/0*00HcuqAncDtDDj2D.png"/></div></figure><p id="485e" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated"><em class="na">上面的C4图是用</em> <a class="ae lg" href="https://gist.github.com/oitee/725732646af54024d4bc242608e1cf4e" rel="noopener ugc nofollow" target="_blank"> <em class="na">这个</em> </a>生成的</p><h1 id="406d" class="ll lm in bd ln lo lp lq lr ls lt lu lv jt lw ju lx jw ly jx lz jz ma ka mb mc bi translated">步骤1:创建DNS条目</h1><p id="5a60" class="pw-post-body-paragraph kk kl in km b kn mf jo kp kq mg jr ks kt mt kv kw kx mu kz la lb mv ld le lf ig bi translated">我们为GCP虚拟机添加DNS条目，我们已经生成了另一个项目:</p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="nc nd di ne bf nf"><div class="gh gi nb"><img src="../Images/9ab107ea1354eeb7d50876a4bf78472b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*cG1rputXl3PC7mOC.png"/></div></div></figure><p id="7d46" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">所以现在，<a class="ae lg" href="https://twirl.otee.dev" rel="noopener ugc nofollow" target="_blank"> twirl.otee.dev </a>指向我的GCP虚拟机。</p><h1 id="7bdd" class="ll lm in bd ln lo lp lq lr ls lt lu lv jt lw ju lx jw ly jx lz jz ma ka mb mc bi translated">步骤2:设置NGINX</h1><p id="8a19" class="pw-post-body-paragraph kk kl in km b kn mf jo kp kq mg jr ks kt mt kv kw kx mu kz la lb mv ld le lf ig bi translated">我们将大致遵循官方文档中提到的<a class="ae lg" href="https://www.nginx.com/blog/creating-nginx-rewrite-rules/" rel="noopener ugc nofollow" target="_blank">重写URL的步骤:</a></p><ol class=""><li id="0105" class="md me in km b kn ko kq kr kt mw kx mx lb my lf mk ml mm mn bi translated">我们将使用<code class="fe lh li lj lk b">return</code>指令</li><li id="9ef0" class="md me in km b kn mo kq mp kt mq kx mr lb ms lf mk ml mm mn bi translated">我们将使用HTTP状态301重定向到客户端(永久移动)</li><li id="bd76" class="md me in km b kn mo kq mp kt mq kx mr lb ms lf mk ml mm mn bi translated">我们将通过保持一切不变来构造重定向URL，除了主机名。</li><li id="520d" class="md me in km b kn mo kq mp kt mq kx mr lb ms lf mk ml mm mn bi translated">我们将使用LetsEncrypt设置HTTPS</li></ol><p id="d31f" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">为了执行步骤1、2、3，我们在这里创建一个新文件:<code class="fe lh li lj lk b">/etc/nginx/sites-available/twirl.otee.dev</code>,包含:</p><pre class="kd ke kf kg gt ng lk nh ni aw nj bi"><span id="1cac" class="nk lm in lk b gy nl nm l nn no">server {<br/>    listen 80;<br/>    listen 443 ssl;<br/>    server_name twirl.otee.dev;<br/>    return 301 $scheme://oteetwirl.herokuapp.com$request_uri;<br/>}</span></pre><p id="57f3" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">接下来，我们通过创建一个符号链接来启用该站点:</p><pre class="kd ke kf kg gt ng lk nh ni aw nj bi"><span id="6da7" class="nk lm in lk b gy nl nm l nn no">sudo ln -s /etc/nginx/sites-available/twirl.otee.dev /etc/nginx/sites-enabled/twirl.otee.dev</span></pre><p id="7c83" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">接下来，我们应该重启NGINX:</p><pre class="kd ke kf kg gt ng lk nh ni aw nj bi"><span id="c8ee" class="nk lm in lk b gy nl nm l nn no">sudo systemctl status nginx<br/>sudo systemctl restart nginx</span></pre><p id="f4a6" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">在这一点上，如果我们去<code class="fe lh li lj lk b">twirl.otee.dev</code>它应该带我们旋转，它运行在Heroku上。但是，因为我们使用的是一个<code class="fe lh li lj lk b">.dev</code>域，所以我们有必要为<code class="fe lh li lj lk b">twirl.otee.dev</code>创建一个SSL证书，以便支持HTTPS。</p><p id="58a1" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">如果安装了certbot，我们可以简单地使用这个命令:<code class="fe lh li lj lk b">sudo certbot --nginx</code>。如果未安装certbot，则需要安装它(参见<a class="ae lg" href="https://certbot.eff.org/instructions?ws=nginx&amp;os=ubuntufocal" rel="noopener ugc nofollow" target="_blank">文档</a>)。</p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="nc nd di ne bf nf"><div class="gh gi np"><img src="../Images/d486b1e65060ff42a41f47908e4429f0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*cSVkGKNoxmccIGW1.png"/></div></div></figure><p id="a2cc" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">现在，重定向到<a class="ae lg" href="https://twirl.otee.dev" rel="noopener ugc nofollow" target="_blank"> twirl.otee.dev </a>应该可以工作了。但如果没有，我们可能不得不刷新DNS缓存。谷歌域名可以这样做:<a class="ae lg" href="https://dns.google/cache" rel="noopener ugc nofollow" target="_blank">https://dns.google/cache</a>。</p><p id="670c" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">至此，我们已经实现了为我们的短链接使用短域名的目标。例如，下面的链接现在应该工作:<code class="fe lh li lj lk b"><a class="ae lg" href="https://twirl.otee.dev/l/L5w2" rel="noopener ugc nofollow" target="_blank">twirl.otee.dev/l/L5w2</a></code>。</p><h1 id="c5a7" class="ll lm in bd ln lo lp lq lr ls lt lu lv jt lw ju lx jw ly jx lz jz ma ka mb mc bi translated">步骤3:在Twirl上显示短链接</h1><p id="3617" class="pw-post-body-paragraph kk kl in km b kn mf jo kp kq mg jr ks kt mt kv kw kx mu kz la lb mv ld le lf ig bi translated">虽然我们已经启用了域名<code class="fe lh li lj lk b">twirl.otee.dev</code>的短链接重定向，但Twirl应用程序仍然会显示较长的URL，使用Heroku的默认域名。</p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="nc nd di ne bf nf"><div class="gh gi nq"><img src="../Images/a42947a7cd454eed43d3c3057e7ef7ec.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*tiaxoe88yUPJ0ezW.png"/></div></div></figure><p id="b31a" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">我们希望Twirl显示twirl.otee.dev/l/L5w2，而不是显示oteetwirl.herokuapp.com/l/L5w2。目前，Twirl的设计方式是服务器生成唯一的URL路径，最终的链接由<a class="ae lg" href="https://github.com/oitee/twirl/blob/a58e20c/public/views/home.mustache#L139" rel="noopener ugc nofollow" target="_blank">客户端JavaScript </a>通过追加当前域来构建:</p><pre class="kd ke kf kg gt ng lk nh ni aw nj bi"><span id="c72d" class="nk lm in lk b gy nl nm l nn no">function shortLinkHref(link) {<br/>  let finalLink = window.location.protocol + "//" + window.location.host + link;<br/>  return `&lt;a href='${link}' target='_blank'&gt; ${finalLink}&lt;a/&gt;`;<br/>}</span></pre><p id="5ec2" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">代替这种方法，我们可以在服务器端本身创建短链接。为此，我们应该首先从服务器上的环境中公开预期的域名。这是必需的，因为<strong class="km io">服务器不知道它服务请求的域名</strong>。它只知道它在本地端口上服务请求。即使它知道机器的IP地址(有时就是这种情况)，它仍然不知道哪些域名(可以有多个)映射到该IP地址，因为这一部分(即域名到IP地址的转换)必须由客户端通过进行DNS查询来完成。因此，应将目标域名作为附加信息提供给服务器。这纯粹是装饰性的，服务器会通过在给定的域名后面附加一个简短的URL路径来盲目地生成这个简短的URL。</p><p id="b48a" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">为了实现这一点，服务器被暴露给一个新的环境变量，即<code class="fe lh li lj lk b">CUSTOM_DOMAIN_NAME</code>，它包含我们更短的域名，即<code class="fe lh li lj lk b">twirl.otee.dev</code>。现在，每次收到缩短链接的请求时，服务器都会发回完整的短URL(而不像前面那样只发送URL路径)。</p><p id="a612" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">根据这种设计，前端不能在从服务器接收的短链路上运行。这造成了一个小小的障碍，因为当用户点击主页上的<strong class="km io">切换</strong>按钮时，客户端JavaScript需要生成启用和禁用现有短链接的请求。之前，客户端JavaScript会以以下方式生成这些请求:</p><pre class="kd ke kf kg gt ng lk nh ni aw nj bi"><span id="af6a" class="nk lm in lk b gy nl nm l nn no">async function updateStatus(link, currentStatus) {<br/>  // 'link' is the URL path of a short link, <br/>  // 'currentStatus' indicates whether a short link is enabled or disabled at the moment<br/>  link = link.substring(3);<br/>  if (currentStatus) {<br/>    await fetch(`/l/disable/${link}`, { method: "POST" });<br/>  } else {<br/>    await fetch(`/l/enable/${link}`, { method: "POST" });<br/>  }<br/>  await analyticsGenerator();<br/>}</span></pre><p id="6f49" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">为了允许客户端JavaScript生成上述请求，服务器除了发送完整的短URL之外，还发送短URL路径(没有前三个常见字符<code class="fe lh li lj lk b">/l/</code>)。这允许上述功能在没有许多改变的情况下运行:</p><pre class="kd ke kf kg gt ng lk nh ni aw nj bi"><span id="8c65" class="nk lm in lk b gy nl nm l nn no">async function updateStatus(linkPath, currentStatus) {<br/>  if (currentStatus) {<br/>    await fetch(`/l/disable/${linkPath}`, { method: "POST" });<br/>  } else {<br/>    await fetch(`/l/enable/${linkPath}`, { method: "POST" });<br/>  }<br/>  await analyticsGenerator();<br/>}</span></pre><p id="569b" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">现在，swift在其主页上显示较短的短链接。🎉</p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="nc nd di ne bf nf"><div class="gh gi nq"><img src="../Images/b323493536d6f3561c9af15d3ddb0167.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*AAvOah_2ZUb323K3.png"/></div></div></figure></div><div class="ab cl nr ns hr nt" role="separator"><span class="nu bw bk nv nw nx"/><span class="nu bw bk nv nw nx"/><span class="nu bw bk nv nw"/></div><div class="ig ih ii ij ik"><p id="2298" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated"><em class="na">原载于2022年1月13日</em><a class="ae lg" href="https://otee.dev/2022/01/13/making-short-links-shorter.html" rel="noopener ugc nofollow" target="_blank"><em class="na">https://otee . dev</em></a><em class="na">。链接原文:</em><a class="ae lg" href="https://otee.dev/2022/01/13/making-short-links-shorter.html" rel="noopener ugc nofollow" target="_blank"><em class="na">https://otee.dev/2022/01/13/making-short-links-shorter.html</em></a></p><p id="b637" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated"><em class="na">更多内容请看</em><a class="ae lg" href="http://plainenglish.io/" rel="noopener ugc nofollow" target="_blank"><strong class="km io"><em class="na">plain English . io</em></strong></a><em class="na">。报名参加我们的</em> <a class="ae lg" href="http://newsletter.plainenglish.io/" rel="noopener ugc nofollow" target="_blank"> <strong class="km io"> <em class="na">免费周报</em> </strong> </a> <em class="na">。在我们的</em> <a class="ae lg" href="https://discord.gg/GtDtUAvyhW" rel="noopener ugc nofollow" target="_blank"> <strong class="km io"> <em class="na">社区</em> </strong> </a> <em class="na">获得独家获得写作机会和建议。</em></p></div></div>    
</body>
</html>