<html>
<head>
<title>Session Management in a Node.js &amp; Express App with MongoDB</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用MongoDB在Node.js &amp; Express应用程序中进行会话管理</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/session-management-in-a-nodejs-express-app-with-mongodb-19f52c392dad?source=collection_archive---------0-----------------------#2022-05-14">https://javascript.plainenglish.io/session-management-in-a-nodejs-express-app-with-mongodb-19f52c392dad?source=collection_archive---------0-----------------------#2022-05-14</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><div class=""><h2 id="6372" class="pw-subtitle-paragraph jk im in bd b jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb dk translated">使用express-session和MongoDB在下一个Node.js-Express应用程序中设置、使用和管理会话的简单指南</h2></div><p id="3ce2" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">对于任何后端开发人员来说，仅仅了解概念层面的东西可能并不总是足够的。有时候，你不得不弄脏你的手。</p><figure class="kz la lb lc gt ld gh gi paragraph-image"><div role="button" tabindex="0" class="le lf di lg bf lh"><div class="gh gi ky"><img src="../Images/94fc1b6947ba98b4488cc844d836bce6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5RSuPXeH8KbgL0fjFQNGlQ.png"/></div></div></figure><p id="9887" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">和往常一样，本文的完整代码可以在我的GitHub上找到👇</p><div class="lk ll gp gr lm ln"><a href="https://github.com/Aakash1103Jha/node-express-session.git" rel="noopener  ugc nofollow" target="_blank"><div class="lo ab fo"><div class="lp ab lq cl cj lr"><h2 class="bd io gy z fp ls fr fs lt fu fw im bi translated">GitHub—aa kash 1103 jha/node-express-session</h2><div class="lu l"><h3 class="bd b gy z fp ls fr fs lt fu fw dk translated">这是一个简单的项目，演示了如何在node-express应用程序中设置和使用会话。这个应用程序使用MongoDB…</h3></div><div class="lv l"><p class="bd b dl z fp ls fr fs lt fu fw dk translated">github.com</p></div></div><div class="lw l"><div class="lx l ly lz ma lw mb li ln"/></div></div></a></div></div><div class="ab cl mc md hr me" role="separator"><span class="mf bw bk mg mh mi"/><span class="mf bw bk mg mh mi"/><span class="mf bw bk mg mh"/></div><div class="ig ih ii ij ik"><h1 id="cd5a" class="mj mk in bd ml mm mn mo mp mq mr ms mt jt mu ju mv jw mw jx mx jz my ka mz na bi translated">饼干🍪vs会话🔗</h1><p id="7679" class="pw-post-body-paragraph kc kd in ke b kf nb jo kh ki nc jr kk kl nd kn ko kp ne kr ks kt nf kv kw kx ig bi translated">说到cookies或会话，现在，我们只能说，它们是同一个硬币的两面。cookie和会话的主要区别在于数据最终存储的位置。虽然cookie由浏览器存储在客户端，这意味着数据也存储在浏览器中，但另一方面，会话将数据存储在服务器端，可以在应用程序内存中(这不是一个很好或可伸缩的想法)或使用某种形式的数据库(SQL或无SQL)来实现数据持久性。</p><h1 id="982d" class="mj mk in bd ml mm ng mo mp mq nh ms mt jt ni ju mv jw nj jx mx jz nk ka mz na bi translated">入门指南🚀</h1><p id="64cc" class="pw-post-body-paragraph kc kd in ke b kf nb jo kh ki nc jr kk kl nd kn ko kp ne kr ks kt nf kv kw kx ig bi translated">在我们开始有趣的东西，例如代码之前，让我们先弄清楚一些事情。</p><ol class=""><li id="7241" class="nl nm in ke b kf kg ki kj kl nn kp no kt np kx nq nr ns nt bi translated">此应用程序使用TypeScript。我希望你和我一样喜欢TS😅但是如果你不习惯或者不了解它，不要担心——你需要做的就是忽略与TS相关的东西(比如定义类型),假装它是JS。</li><li id="aa97" class="nl nm in ke b kf nu ki nv kl nw kp nx kt ny kx nq nr ns nt bi translated">因为本文也是关于在Express应用程序中使用Mongo DB和Session的，所以您要么需要在本地系统上运行一个MongoDB实例，要么需要一个Atlas集群供您使用。</li><li id="207b" class="nl nm in ke b kf nu ki nv kl nw kp nx kt ny kx nq nr ns nt bi translated">请务必通读自述文件。我已经详细描述了在环境变量方面需要做出改变的地方，如何让应用程序运行…诸如此类的东西。</li></ol><h1 id="22a5" class="mj mk in bd ml mm ng mo mp mq nh ms mt jt ni ju mv jw nj jx mx jz nk ka mz na bi translated">目录结构📚</h1><p id="a9ee" class="pw-post-body-paragraph kc kd in ke b kf nb jo kh ki nc jr kk kl nd kn ko kp ne kr ks kt nf kv kw kx ig bi translated">浏览项目目录并浏览每个文件可能做的/相关的内容总是一个好主意。<code class="fe nz oa ob oc b">app.ts</code>拥有所有与Express相关的逻辑。<code class="fe nz oa ob oc b">session.ts</code>包含所有与会话相关的代码，比如中间件和商店的配置。而<code class="fe nz oa ob oc b">index.ts</code>是最简单的，充当应用程序的入口点。</p><figure class="kz la lb lc gt ld gh gi paragraph-image"><div class="gh gi od"><img src="../Images/81a2ad4e5169e393d4fa3f1140f696f0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1116/format:webp/1*EgJ6GUQ4nSvUzu7U_haOQg.png"/></div><figcaption class="oe of gj gh gi og oh bd b be z dk">Project directory structure</figcaption></figure><h1 id="155b" class="mj mk in bd ml mm ng mo mp mq nh ms mt jt ni ju mv jw nj jx mx jz nk ka mz na bi translated">给我看看代码！💻</h1><p id="38b2" class="pw-post-body-paragraph kc kd in ke b kf nb jo kh ki nc jr kk kl nd kn ko kp ne kr ks kt nf kv kw kx ig bi translated">行...好了…是时候看代码了…让我们看看每个文件看起来是什么样子，做了什么。此外，如果您选择在自己的项目中放弃TypeScript，您将不再需要任何那些<code class="fe nz oa ob oc b">@types/</code>相关的devDependencies。</p><h2 id="e38b" class="oi mk in bd ml oj ok dn mp ol om dp mt kl on oo mv kp op oq mx kt or os mz ot bi translated">步骤1:设置基本的express应用程序</h2><h2 id="bfa9" class="oi mk in bd ml oj ok dn mp ol om dp mt kl on oo mv kp op oq mx kt or os mz ot bi translated">src/app.ts</h2><p id="f6dc" class="pw-post-body-paragraph kc kd in ke b kf nb jo kh ki nc jr kk kl nd kn ko kp ne kr ks kt nf kv kw kx ig bi translated">这一步不要太花哨。我们在这里拥有的是一个服务器，它在<code class="fe nz oa ob oc b">PORT 4000</code>运行并监听请求，并且只有一个<code class="fe nz oa ob oc b">/</code>路由发送回<code class="fe nz oa ob oc b">Hello World</code>作为响应。简单的东西！</p><figure class="kz la lb lc gt ld gh gi paragraph-image"><div role="button" tabindex="0" class="le lf di lg bf lh"><div class="gh gi ou"><img src="../Images/3dd4d2268b607a2a4c45cae2a7b38c40.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qA_J_5dGeJ5wuGDvW3Ah9Q.png"/></div></div></figure><h2 id="23b9" class="oi mk in bd ml oj ok dn mp ol om dp mt kl on oo mv kp op oq mx kt or os mz ot bi translated">src/索引. ts</h2><p id="f0bb" class="pw-post-body-paragraph kc kd in ke b kf nb jo kh ki nc jr kk kl nd kn ko kp ne kr ks kt nf kv kw kx ig bi translated">就像我之前说过的，我们的<code class="fe nz oa ob oc b">index.ts</code>文件非常简单，充当应用程序的入口点。仅此而已。我们所做的就是导入express <code class="fe nz oa ob oc b">app</code>并在我们想要的任何端口启动一个服务器——在本例中是4000。此时，如果您继续运行<code class="fe nz oa ob oc b">npm run dev</code>，您应该会在控制台中看到运行在端口4000  上的<strong class="ke io"> <em class="ov">服务器。</em></strong></p><figure class="kz la lb lc gt ld gh gi paragraph-image"><div role="button" tabindex="0" class="le lf di lg bf lh"><div class="gh gi ou"><img src="../Images/e298760978b91eb320d295f29c77c909.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Evf0dDH4WNJZq7i34M1R0g.png"/></div></div></figure><h2 id="a769" class="oi mk in bd ml oj ok dn mp ol om dp mt kl on oo mv kp op oq mx kt or os mz ot bi translated">第二步:使用<code class="fe nz oa ob oc b"><a class="ae ow" href="https://www.npmjs.com/package/express-session" rel="noopener ugc nofollow" target="_blank">express-session</a></code>包</h2><p id="ba65" class="pw-post-body-paragraph kc kd in ke b kf nb jo kh ki nc jr kk kl nd kn ko kp ne kr ks kt nf kv kw kx ig bi translated">如果您正在使用附加的存储库，那么您在开始时就已经获得了所有的依赖项。但是如果您正在跟进，运行<code class="fe nz oa ob oc b">npm install --save express-session; npm install-D @types/express-session</code>来安装这个依赖项。我们要做的是，使用<code class="fe nz oa ob oc b">express-session</code>包作为中间件，为我们的应用程序完成所有与创建和管理会话相关的繁重工作。另外，如果您计划使用MongoDB作为您的会话存储，请在您的npm命令中包含<code class="fe nz oa ob oc b">connect-mongo</code>。如果你想使用其他数据库，你可以在这里找到兼容选项的列表。关于connect-mongo包，<a class="ae ow" href="https://www.npmjs.com/package/connect-mongo" rel="noopener ugc nofollow" target="_blank">官方文档在此</a>。</p><figure class="kz la lb lc gt ld gh gi paragraph-image"><div role="button" tabindex="0" class="le lf di lg bf lh"><div class="gh gi ou"><img src="../Images/2cf5ea78f79de1cffb926ab9c5c75e15.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hmF-IQ2sUTI5APW_hn4apw.png"/></div></div></figure><p id="3549" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">我们在这里做的是，首先，使用<code class="fe nz oa ob oc b">connect-mongo</code>包创建一个<code class="fe nz oa ob oc b">sessionStore</code>，它将被我们的会话使用(老实说，一句话中有太多的会话😅)来存储数据。<em class="ov">如果你选择不为你的应用添加会话存储，就不会有任何数据持久性</em>。除此之外，你的应用程序仍然可以工作，只要服务器不重启，数据就会存储在内存中。</p><h2 id="74e8" class="oi mk in bd ml oj ok dn mp ol om dp mt kl on oo mv kp op oq mx kt or os mz ot bi translated">步骤3:在app.ts文件中包含会话</h2><p id="fb1c" class="pw-post-body-paragraph kc kd in ke b kf nb jo kh ki nc jr kk kl nd kn ko kp ne kr ks kt nf kv kw kx ig bi translated">告诉我们的应用程序使用会话非常简单，只需导入<code class="fe nz oa ob oc b">express-session</code>包、<code class="fe nz oa ob oc b">sessionOptions</code>(在<code class="fe nz oa ob oc b">session.ts</code>中创建)，在<code class="fe nz oa ob oc b">session middleware</code>中传递这些选项，并告诉哪个路由应该对会话做什么。轻松点。😂</p><figure class="kz la lb lc gt ld gh gi paragraph-image"><div role="button" tabindex="0" class="le lf di lg bf lh"><div class="gh gi ou"><img src="../Images/1fb7b6ada5dde00058b73e328693a1c6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*uxBiAsAqQiSZ-LQ18ffFZg.png"/></div></div></figure><p id="9a41" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><code class="fe nz oa ob oc b">req.session</code>还附带了一些方法，当涉及到管理基于一些用户动作的会话时，这些方法非常有用——在本例中是注销。注销时，或者当浏览器关闭时，我们知道应该终止会话，并且必须删除会话id cookie。<code class="fe nz oa ob oc b">destroy</code>方法正是这样做的。</p><p id="461b" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">如果你还记得，在sessionStore中有一个<code class="fe nz oa ob oc b">ttl</code>属性。这就是告诉数据库会话数据多长时间有效，之后可以自动安全地删除它。</p><h2 id="4ae7" class="oi mk in bd ml oj ok dn mp ol om dp mt kl on oo mv kp op oq mx kt or os mz ot bi translated">第四步:发动引擎！</h2><p id="e77f" class="pw-post-body-paragraph kc kd in ke b kf nb jo kh ki nc jr kk kl nd kn ko kp ne kr ks kt nf kv kw kx ig bi translated">如果一切顺利，并且您已经将Mongo DB(本地或Atlas，无所谓)或您选择的任何其他DB连接为您的会话存储，那么访问<code class="fe nz oa ob oc b">/</code>端点将创建一个<strong class="ke io">新会话</strong>，并在您的浏览器中保存一个新的<strong class="ke io"> connect.sid cookie </strong>，并且<strong class="ke io">在<strong class="ke io">数据库</strong>中添加该会话id的会话数据</strong>。现在，一旦您访问了<code class="fe nz oa ob oc b">/logout</code>端点，会话cookie将从您的浏览器和会话数据中删除。分别来自数据库。</p><p id="446c" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">我们完事了。我们有一个Node.js-Express应用程序，它实现了一个会话，还有一个会话存储来保存会话数据，直到会话被删除或无效。</p></div><div class="ab cl mc md hr me" role="separator"><span class="mf bw bk mg mh mi"/><span class="mf bw bk mg mh mi"/><span class="mf bw bk mg mh"/></div><div class="ig ih ii ij ik"><p id="7816" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">感谢你的来访和阅读这篇文章。我希望你喜欢它，并发现它很有帮助🙂。</p><p id="9d87" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">请务必查看我在Node.js旁边讨论React和TypeScript的其他文章。</p><p id="8e7a" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">结束！🚀</p><p id="65e4" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><em class="ov">更多内容请看</em> <a class="ae ow" href="https://plainenglish.io/" rel="noopener ugc nofollow" target="_blank"> <strong class="ke io"> <em class="ov">说白了。报名参加我们的</em> <a class="ae ow" href="http://newsletter.plainenglish.io/" rel="noopener ugc nofollow" target="_blank"> <strong class="ke io"> <em class="ov">免费周报</em> </strong> </a> <em class="ov">。关注我们</em><a class="ae ow" href="https://twitter.com/inPlainEngHQ" rel="noopener ugc nofollow" target="_blank"><strong class="ke io"><em class="ov">Twitter</em></strong></a><em class="ov">和</em><a class="ae ow" href="https://www.linkedin.com/company/inplainenglish/" rel="noopener ugc nofollow" target="_blank"><strong class="ke io"><em class="ov">LinkedIn</em></strong></a><em class="ov">。查看我们的</em> <a class="ae ow" href="https://discord.gg/GtDtUAvyhW" rel="noopener ugc nofollow" target="_blank"> <strong class="ke io"> <em class="ov">社区不和谐</em> </strong> </a> <em class="ov">加入我们的</em> <a class="ae ow" href="https://inplainenglish.pallet.com/talent/welcome" rel="noopener ugc nofollow" target="_blank"> <strong class="ke io"> <em class="ov">人才集体</em> </strong> </a> <em class="ov">。</em></strong></a></p></div></div>    
</body>
</html>