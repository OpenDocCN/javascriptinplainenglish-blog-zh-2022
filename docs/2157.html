<html>
<head>
<title>Why You Shouldn’t Use forEach() with async/await!</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">为什么不应该将forEach()与async/await一起使用！</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/why-you-shouldnt-use-foreach-with-async-await-bece7bdc44b7?source=collection_archive---------8-----------------------#2022-05-18">https://javascript.plainenglish.io/why-you-shouldnt-use-foreach-with-async-await-bece7bdc44b7?source=collection_archive---------8-----------------------#2022-05-18</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><div class=""><h2 id="b32e" class="pw-subtitle-paragraph jk im in bd b jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb dk translated">Array.prototype.forEach()函数是否只需要一个同步函数？</h2></div><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi kc"><img src="../Images/4031c8c03fe4c1fe419502278549a340.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ko2dH7mit2Iri7414vPWZA.png"/></div></div><figcaption class="ko kp gj gh gi kq kr bd b be z dk">The code snippet that triggered the observation!</figcaption></figure><p id="9b7a" class="pw-post-body-paragraph ks kt in ku b kv kw jo kx ky kz jr la lb lc ld le lf lg lh li lj lk ll lm ln ig bi translated">查看下面的代码:</p><pre class="kd ke kf kg gt lo lp lq lr aw ls bi"><span id="8ec4" class="lt lu in lp b gy lv lw l lx ly">async function displayScores() {<br/>  const scores = [1, 2, 3, 4, 5];</span><span id="a1eb" class="lt lu in lp b gy lz lw l lx ly">  console.log("Starting to display scores");</span><span id="f9b5" class="lt lu in lp b gy lz lw l lx ly">  scores.forEach((score) =&gt; {<br/>    console.log('The current score is ', score);<br/>  });</span><span id="728e" class="lt lu in lp b gy lz lw l lx ly">  console.log("Finished displaying scores. This should execute last!");<br/>}</span><span id="75c9" class="lt lu in lp b gy lz lw l lx ly">displayScores();</span></pre><p id="3f55" class="pw-post-body-paragraph ks kt in ku b kv kw jo kx ky kz jr la lb lc ld le lf lg lh li lj lk ll lm ln ig bi translated">该代码将给出以下输出:</p><pre class="kd ke kf kg gt lo lp lq lr aw ls bi"><span id="e550" class="lt lu in lp b gy lv lw l lx ly">Starting to display scores<br/>The current score is 1<br/>The current score is 2<br/>The current score is 3<br/>The current score is 4<br/>The current score is 5<br/>Finished displaying scores. This should execute last!</span></pre><p id="bf5c" class="pw-post-body-paragraph ks kt in ku b kv kw jo kx ky kz jr la lb lc ld le lf lg lh li lj lk ll lm ln ig bi translated">然而，通过使用一些异步函数来修改代码:</p><pre class="kd ke kf kg gt lo lp lq lr aw ls bi"><span id="030c" class="lt lu in lp b gy lv lw l lx ly">function myFunction(value) {<br/>  return new Promise((resolve) =&gt; {<br/>    console.log("My extra function is running");<br/>    resolve();<br/>  });<br/>}</span><span id="b06d" class="lt lu in lp b gy lz lw l lx ly">async function displayScores() {<br/>  const scores = [1, 2, 3, 4, 5];<br/>  console.log("Starting to display scores");<br/>  scores.forEach(async (score) =&gt; {<br/>    console.log('Before the async function:');<br/>    await myFunction()<br/>    console.log('The current score is ', score);<br/>  });<br/>  console.log("Finished displaying scores. This should execute last!");<br/>}<br/>displayScores();</span></pre><p id="28f8" class="pw-post-body-paragraph ks kt in ku b kv kw jo kx ky kz jr la lb lc ld le lf lg lh li lj lk ll lm ln ig bi translated">你应该期望<strong class="ku io">显示完分数。这应该最后执行！</strong>仍然最后打印，因为forEach是同步的。</p><p id="a126" class="pw-post-body-paragraph ks kt in ku b kv kw jo kx ky kz jr la lb lc ld le lf lg lh li lj lk ll lm ln ig bi translated">实际上，这是输出结果:🤯</p><pre class="kd ke kf kg gt lo lp lq lr aw ls bi"><span id="0505" class="lt lu in lp b gy lv lw l lx ly">Starting to display scores<br/>Before the async function:<br/>My extra function is running<br/>Before the async function:<br/>My extra function is running<br/>Before the async function:<br/>My extra function is running<br/>Before the async function:<br/>My extra function is running<br/>Before the async function:<br/>My extra function is running<br/>Finished displaying scores. This should execute last!<br/>The current score is  1<br/>The current score is  2<br/>The current score is  3<br/>The current score is  4<br/>The current score is  5</span></pre><p id="fec3" class="pw-post-body-paragraph ks kt in ku b kv kw jo kx ky kz jr la lb lc ld le lf lg lh li lj lk ll lm ln ig bi translated">当这导致我正在开发的一个web应用程序出现错误时，我发现了这一点。</p><p id="3136" class="pw-post-body-paragraph ks kt in ku b kv kw jo kx ky kz jr la lb lc ld le lf lg lh li lj lk ll lm ln ig bi translated">我意识到对forEach使用async/await会导致意想不到的行为。虽然await关键字似乎已经完成了它的工作，但是forEach循环在进入下一个循环时不会等待承诺。</p><p id="167a" class="pw-post-body-paragraph ks kt in ku b kv kw jo kx ky kz jr la lb lc ld le lf lg lh li lj lk ll lm ln ig bi translated">我对这种意外行为的理解可能不够清楚，请<strong class="ku io">评论</strong>您对这种行为的看法。</p><p id="1125" class="pw-post-body-paragraph ks kt in ku b kv kw jo kx ky kz jr la lb lc ld le lf lg lh li lj lk ll lm ln ig bi translated">不管怎样，我发现这个解决方案是可行的。</p><p id="5801" class="pw-post-body-paragraph ks kt in ku b kv kw jo kx ky kz jr la lb lc ld le lf lg lh li lj lk ll lm ln ig bi translated">求助于使用基本的for循环，for(；；；)和for…of loop完美地工作着。</p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi ma"><img src="../Images/a10048e14cd456d217717b07cdebab87.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GNai7c2ay4MP1lHjQTDwbA.png"/></div></div><figcaption class="ko kp gj gh gi kq kr bd b be z dk">For of loop worked fine.</figcaption></figure><p id="7d27" class="pw-post-body-paragraph ks kt in ku b kv kw jo kx ky kz jr la lb lc ld le lf lg lh li lj lk ll lm ln ig bi translated">另一个可行的解决方案是将Array.map与Promise.all()一起使用，如下所示:</p><pre class="kd ke kf kg gt lo lp lq lr aw ls bi"><span id="f5e3" class="lt lu in lp b gy lv lw l lx ly">await Promise.all(<br/>    scores.map(async (score) =&gt; {<br/>        console.log('Before the async function:');<br/>        await myFunction()<br/>        console.log('The current score is ', score);<br/>    })<br/>);</span><span id="407b" class="lt lu in lp b gy lz lw l lx ly">// This works perfectly.</span><span id="423c" class="lt lu in lp b gy lz lw l lx ly">OUTPUT:<br/>Starting to display scores<br/>Before the async function:<br/>My extra function is running<br/>Before the async function:<br/>My extra function is running<br/>Before the async function:<br/>My extra function is running<br/>Before the async function:<br/>My extra function is running<br/>Before the async function:<br/>My extra function is running<br/>The current score is  1<br/>The current score is  2<br/>The current score is  3<br/>The current score is  4<br/>The current score is  5<br/>Finished displaying scores. This should execute last!</span></pre><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi mb"><img src="../Images/de848b11cf47ac01d103b391c564b91c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VZD9gh1jgpduOffhSUGz0Q.png"/></div></div><figcaption class="ko kp gj gh gi kq kr bd b be z dk">Surrounding Array.map with Promise.all()</figcaption></figure><p id="6513" class="pw-post-body-paragraph ks kt in ku b kv kw jo kx ky kz jr la lb lc ld le lf lg lh li lj lk ll lm ln ig bi translated">在评论区分享你的想法和经验。</p><p id="f3b4" class="pw-post-body-paragraph ks kt in ku b kv kw jo kx ky kz jr la lb lc ld le lf lg lh li lj lk ll lm ln ig bi translated">谢谢！👍</p><p id="fb8a" class="pw-post-body-paragraph ks kt in ku b kv kw jo kx ky kz jr la lb lc ld le lf lg lh li lj lk ll lm ln ig bi translated"><em class="mc">更多内容看</em> <a class="ae md" href="https://plainenglish.io/" rel="noopener ugc nofollow" target="_blank"> <strong class="ku io"> <em class="mc">说白了就是</em> </strong> </a> <em class="mc">。报名参加我们的</em> <a class="ae md" href="http://newsletter.plainenglish.io/" rel="noopener ugc nofollow" target="_blank"> <strong class="ku io"> <em class="mc">免费周报</em> </strong> </a> <em class="mc">。关注我们关于</em><a class="ae md" href="https://twitter.com/inPlainEngHQ" rel="noopener ugc nofollow" target="_blank"><strong class="ku io"><em class="mc">Twitter</em></strong></a><em class="mc">和</em><a class="ae md" href="https://www.linkedin.com/company/inplainenglish/" rel="noopener ugc nofollow" target="_blank"><strong class="ku io"><em class="mc">LinkedIn</em></strong></a><em class="mc">。查看我们的</em> <a class="ae md" href="https://discord.gg/GtDtUAvyhW" rel="noopener ugc nofollow" target="_blank"> <strong class="ku io"> <em class="mc">社区不和谐</em> </strong> </a> <em class="mc">加入我们的</em> <a class="ae md" href="https://inplainenglish.pallet.com/talent/welcome" rel="noopener ugc nofollow" target="_blank"> <strong class="ku io"> <em class="mc">人才集体</em> </strong> </a> <em class="mc">。</em></p></div></div>    
</body>
</html>