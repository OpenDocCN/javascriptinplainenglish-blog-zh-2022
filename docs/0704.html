<html>
<head>
<title>Learn Bot Sharding With Discord.js</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用Discord.js学习Bot Sharding</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/learn-bot-sharding-with-discord-js-adc1b33f6fc0?source=collection_archive---------10-----------------------#2022-02-08">https://javascript.plainenglish.io/learn-bot-sharding-with-discord-js-adc1b33f6fc0?source=collection_archive---------10-----------------------#2022-02-08</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><figure class="gl gn jl jm jn jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi jk"><img src="../Images/a74a22842aff170b99334c003aa5ace4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*sjB_qtAVwNv9Zadg"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk">Photo of The Shard by <a class="ae jz" href="https://unsplash.com/@jamie452?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Jamie Street</a> on <a class="ae jz" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="4f36" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">当一个不和谐机器人发展到一定规模时，通常大约有2000个加入的服务器，机器人的单个实例将开始与所有这些计算斗争。这就是分片的用武之地。分片是在<a class="ae jz" href="https://discord.com/developers/docs/topics/gateway#sharding" rel="noopener ugc nofollow" target="_blank"> Discord开发者文档</a>中定义的一种方法，它允许你运行同一个bot的多个实例，在所有实例之间分割服务器的份额。</p><p id="b834" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">假设你已经创造了下一个大的不和谐机器人。事情进展得非常顺利，您的机器人已经被添加到近2000台服务器上。但是你的机器人在挣扎，事实上，它已经崩溃过几次了。因此，为了处理这个带宽，您设置了bot的第二个实例，每个实例需要大约1000台服务器。这就是实际应用中的分片。现在，你不能只运行机器人的两个实例，你必须定义一个分片管理器来在两者之间分配工作。</p><p id="e897" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">今天，您将学习如何使用Discord.js和一些技巧来设置分片，以保持bot的所有功能正常工作，即使在通过分片管理器运行两个实例时也是如此。</p><h1 id="b3fc" class="ky kz in bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated"><strong class="ak">创建一个机器人(可选)</strong></h1><p id="c8d4" class="pw-post-body-paragraph ka kb in kc b kd lw kf kg kh lx kj kk kl ly kn ko kp lz kr ks kt ma kv kw kx ig bi translated">如果你已经有了一个用Discord.js编写的Discord bot，你可以放心地跳过这一步。对于那些还没有，让我们创建一个简单的NPM项目，并添加一个简单的机器人。</p><pre class="mb mc md me gt mf mg mh mi aw mj bi"><span id="82fb" class="mk kz in mg b gy ml mm l mn mo">mkdir pingbot<br/>cd pingbot<br/>npm init -y<br/>npm i discord.js</span></pre><p id="3c5f" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">在创建了NPM项目并安装了Discord.js之后，在该目录下创建一个<code class="fe mp mq mr mg b">index.js</code>文件并添加以下bot代码。然后添加您的bot令牌，并使用<code class="fe mp mq mr mg b">node .</code>运行项目，以测试它是否正常工作。</p><pre class="mb mc md me gt mf mg mh mi aw mj bi"><span id="8acf" class="mk kz in mg b gy ml mm l mn mo">const { Client, Intents } = require('discord.js')</span><span id="0318" class="mk kz in mg b gy ms mm l mn mo">const BOT_TOKEN = 'BOT_TOKEN_HERE'</span><span id="4c5b" class="mk kz in mg b gy ms mm l mn mo">let client = new Client({<br/>  intents: [Intents.FLAGS.GUILDS, Intents.FLAGS.GUILD_MESSAGES]<br/>})</span><span id="18d7" class="mk kz in mg b gy ms mm l mn mo">client.on('messageCreate', message =&gt; {<br/>  if (message.content === 'ping') message.reply('Pong!')<br/>})</span><span id="35d5" class="mk kz in mg b gy ms mm l mn mo">client.login(BOT_TOKEN)</span></pre><h1 id="255e" class="ky kz in bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">实现分片</h1><p id="71f8" class="pw-post-body-paragraph ka kb in kc b kd lw kf kg kh lx kj kk kl ly kn ko kp lz kr ks kt ma kv kw kx ig bi translated">那么我们如何分割我们的机器人呢？嗯，Discord.js有一个内置的分片管理器来管理同一台机器上的多个bot实例。创建一个名为<code class="fe mp mq mr mg b">shard.js</code>的新文件并导入<code class="fe mp mq mr mg b">ShardingManager</code>。然后创建一个<code class="fe mp mq mr mg b">manager</code>，给它一个bot条目文件(<code class="fe mp mq mr mg b">index.js</code>)和bot令牌。注意，您需要在碎片管理器和bot本身中传递令牌。对于经理来说，还有更多选项，你可以在<a class="ae jz" href="https://discord.js.org/#/docs/main/stable/class/ShardingManager" rel="noopener ugc nofollow" target="_blank"> Discord.js文档</a>中找到。</p><pre class="mb mc md me gt mf mg mh mi aw mj bi"><span id="4c85" class="mk kz in mg b gy ml mm l mn mo">const { ShardingManager } = require('discord.js')</span><span id="e931" class="mk kz in mg b gy ms mm l mn mo">const BOT_TOKEN = 'BOT_TOKEN_HERE'</span><span id="806c" class="mk kz in mg b gy ms mm l mn mo">const manager = new ShardingManager(`${__dirname}/index.js`, { token: BOT_TOKEN })</span></pre><p id="759e" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">然后我们可以监听<code class="fe mp mq mr mg b">shardCreate</code>事件，并在启动时记录碎片的id。然后，我们准备用<code class="fe mp mq mr mg b">.spawn()</code>产生我们的碎片。</p><pre class="mb mc md me gt mf mg mh mi aw mj bi"><span id="0edd" class="mk kz in mg b gy ml mm l mn mo">manager.on('shardCreate', shard =&gt; console.log(`Launched shard ${shard.id}`))<br/>manager.spawn()</span></pre><h1 id="7e5a" class="ky kz in bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated"><strong class="ak">清点服务器</strong></h1><p id="89b4" class="pw-post-body-paragraph ka kb in kc b kd lw kf kg kh lx kj kk kl ly kn ko kp lz kr ks kt ma kv kw kx ig bi translated">你在分片时可能会遇到的一个问题是试图显示你的机器人已经加入的服务器数量。这是机器人状态或<code class="fe mp mq mr mg b">/status</code>命令的一个常见特征。如果您尝试用<code class="fe mp mq mr mg b">client.guilds.cache.size</code>获取您的bot所在的服务器数量，您可能会惊讶地看到它返回一个远低于实际数量的数字。这只是为这个单独的碎片提供服务的服务器数量。为了获得总数，我们可以使用下面的代码片段来获得每个分片中的服务器数量，然后将它们相加，然后在promise中返回该值。</p><pre class="mb mc md me gt mf mg mh mi aw mj bi"><span id="d92e" class="mk kz in mg b gy ml mm l mn mo">function totalGuilds() {<br/>  return client.shard.fetchClientValues('guilds.cache.size')<br/>    .then(shards =&gt; {<br/>      return shards.reduce((acc, guilds) =&gt; acc + guilds, 0)<br/>    })<br/>}</span></pre><p id="402d" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">您可以使用类似的技巧来获取总成员数。这一次使用了<code class="fe mp mq mr mg b">broadcastEval</code>方法，该方法将代码发送给所有碎片进行评估，并返回包含响应数组的promise。</p><pre class="mb mc md me gt mf mg mh mi aw mj bi"><span id="a563" class="mk kz in mg b gy ml mm l mn mo">function totalMembers() {<br/>  return client.shard<br/>   .broadcastEval(c =&gt; c.guilds.cache.reduce((acc, guild) =&gt; acc + guild.memberCount, 0))<br/>   .then(shards =&gt; shards.reduce((acc, memberCount) =&gt; acc + memberCount, 0))<br/>}</span></pre><h1 id="f346" class="ky kz in bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated"><strong class="ak">结论</strong></h1><p id="2fe3" class="pw-post-body-paragraph ka kb in kc b kd lw kf kg kh lx kj kk kl ly kn ko kp lz kr ks kt ma kv kw kx ig bi translated">超过一定规模的机器人需要分片，一旦达到该规模，将机器人分成多个实例将有助于提高性能。Discord.js使设置分片变得很容易，所以如果你有一个增长很快的机器人，记住这一点，也许现在就开始实现它。如果您想提前计划好事情，也可以运行单个shard实例。</p><p id="4bff" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">您只能纵向扩展这么多，所以很快我将在本文的第二部分解释如何在多个物理机器上共享您的discord bot。</p></div><div class="ab cl mt mu hr mv" role="separator"><span class="mw bw bk mx my mz"/><span class="mw bw bk mx my mz"/><span class="mw bw bk mx my"/></div><div class="ig ih ii ij ik"><div class="mb mc md me gt na"><a rel="noopener  ugc nofollow" target="_blank" href="/technologies-i-plan-to-learn-in-2022-a9f44e9c3162"><div class="nb ab fo"><div class="nc ab nd cl cj ne"><h2 class="bd io gy z fp nf fr fs ng fu fw im bi translated">我计划在2022年学习的技术</h2><div class="nh l"><h3 class="bd b gy z fp nf fr fs ng fu fw dk translated">我2022年的学习目标。</h3></div><div class="ni l"><p class="bd b dl z fp nf fr fs ng fu fw dk translated">javascript.plainenglish.io</p></div></div><div class="nj l"><div class="nk l nl nm nn nj no jt na"/></div></div></a></div><div class="np nq gp gr nr na"><a href="https://medium.com/@otterlord/5-awesome-discord-bot-ideas-c5c6f550e307" rel="noopener follow" target="_blank"><div class="nb ab fo"><div class="nc ab nd cl cj ne"><h2 class="bd io gy z fp nf fr fs ng fu fw im bi translated">5个绝妙的不和谐机器人创意</h2><div class="nh l"><h3 class="bd b gy z fp nf fr fs ng fu fw dk translated">不和谐机器人非常受欢迎，而且比以往任何时候都更容易上手。每个专业都有图书馆…</h3></div><div class="ni l"><p class="bd b dl z fp nf fr fs ng fu fw dk translated">medium.com</p></div></div><div class="nj l"><div class="ns l nl nm nn nj no jt na"/></div></div></a></div><div class="np nq gp gr nr na"><a rel="noopener  ugc nofollow" target="_blank" href="/learn-jest-javascript-unit-testing-5ca104b564ce"><div class="nb ab fo"><div class="nc ab nd cl cj ne"><h2 class="bd io gy z fp nf fr fs ng fu fw im bi translated">学习Jest——JavaScript单元测试</h2><div class="nh l"><h3 class="bd b gy z fp nf fr fs ng fu fw dk translated">单元测试是指测试单个的代码单元，甚至是多个代码单元，以确保它们能正常工作…</h3></div><div class="ni l"><p class="bd b dl z fp nf fr fs ng fu fw dk translated">javascript.plainenglish.io</p></div></div><div class="nj l"><div class="nt l nl nm nn nj no jt na"/></div></div></a></div><p id="9097" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><em class="nu">更多内容看</em> <a class="ae jz" href="http://plainenglish.io/" rel="noopener ugc nofollow" target="_blank"> <strong class="kc io"> <em class="nu">说白了就是io </em> </strong> </a> <em class="nu">。报名参加我们的</em> <a class="ae jz" href="http://newsletter.plainenglish.io/" rel="noopener ugc nofollow" target="_blank"> <strong class="kc io"> <em class="nu">免费周报</em> </strong> </a> <em class="nu">。在我们的</em> <a class="ae jz" href="https://discord.gg/GtDtUAvyhW" rel="noopener ugc nofollow" target="_blank"> <strong class="kc io"> <em class="nu">社区不和谐</em> </strong> </a> <em class="nu">获得独家获取写作机会和建议。</em></p></div></div>    
</body>
</html>