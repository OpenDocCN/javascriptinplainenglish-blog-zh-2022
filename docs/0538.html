<html>
<head>
<title>Journey of a console.log in React Native</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">控制台之旅.登录React Native</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/journey-of-a-console-log-in-react-native-6148b4627563?source=collection_archive---------6-----------------------#2022-01-30">https://javascript.plainenglish.io/journey-of-a-console-log-in-react-native-6148b4627563?source=collection_archive---------6-----------------------#2022-01-30</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><div class=""><h2 id="44fc" class="pw-subtitle-paragraph jk im in bd b jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb dk translated">React Native新架构简介。</h2></div><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi kc"><img src="../Images/d5975fc0167f32542b8065778f3f52e6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*U0WSAruR02OOZFWXJ03Yeg.png"/></div></div></figure><p id="66ed" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">我已经开发用户界面很长时间了。在这个阶段，我学到了很多新东西，从JavaScript转到TypeScript一段时间，然后回到JavaScript，使用React开发web应用程序，也使用React Native开发移动应用程序。</p><p id="9277" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">有一件事一直伴随着我，那就是对<code class="fe lk ll lm ln b">console.log</code>的爱。今天，我使用不同的调试器和迷你器来调试我的代码，但是我不像信任T1那样信任任何人。</p><p id="b5dc" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">像大多数JavaScript初学者一样，我也在大部分时间里认为<code class="fe lk ll lm ln b">console.log</code>是JavaScript提供给我们的。但是随着我对谷歌的V8、JavaScript引擎和WebAPI等术语越来越熟悉，它变得越来越清晰。但是就像一个有经验的JavaScript开发者所说的——事情没那么简单。</p><h1 id="555e" class="lo lp in bd lq lr ls lt lu lv lw lx ly jt lz ju ma jw mb jx mc jz md ka me mf bi translated">没那么简单</h1><p id="9428" class="pw-post-body-paragraph ko kp in kq b kr mg jo kt ku mh jr kw kx mi kz la lb mj ld le lf mk lh li lj ig bi translated">是的，它不是。有一次，我尝试在浏览器里打印<code class="fe lk ll lm ln b">console.log</code>的值，得到一个函数说是原生代码。见下图。</p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi ml"><img src="../Images/80443a46213a9ede837eca9c41dddd7d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-3eA7YlhfGGgm5gj1dg1mg.png"/></div></div><figcaption class="mm mn gj gh gi mo mp bd b be z dk">Chrome in a normal environment</figcaption></figure><p id="3bd0" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">这非常符合我的期望，因为<code class="fe lk ll lm ln b">console.log</code>无论如何是一个包含本地代码的WebAPIs函数。但是我在react native环境中尝试了类似的事情，这就是事情开始发生变化的地方。见下图。</p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi mq"><img src="../Images/0583d6a9915d1b98cc841bc306bc4fea.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ClbhoWAB0Z6j53cEgCy3nw.png"/></div></div><figcaption class="mm mn gj gh gi mo mp bd b be z dk">Safari in React Native JSContext</figcaption></figure><p id="729e" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">那么，React Native是如何让<code class="fe lk ll lm ln b">console.log</code>从我们的JavaScript代码运行到原生Android和iOS设备的呢？我知道React Native的异步桥，以及它如何从JavaScript到原生Android和iOS序列化和反序列化东西。但这仅仅是这样吗？</p><h1 id="26cc" class="lo lp in bd lq lr ls lt lu lv lw lx ly jt lz ju ma jw mb jx mc jz md ka me mf bi translated">让我们找出答案</h1><p id="fdcb" class="pw-post-body-paragraph ko kp in kq b kr mg jo kt ku mh jr kw kx mi kz la lb mj ld le lf mk lh li lj ig bi translated">终于登陆React Native的Github库，搜索<code class="fe lk ll lm ln b">console</code>。见下图。</p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi mr"><img src="../Images/1babc65e72ea88072eddd7b52958f9d5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vKUc7_wJPxMhX79JhPWS7g.png"/></div></div></figure><p id="7278" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">出现了两个<code class="fe lk ll lm ln b">console.js</code>文件——第一个在<code class="fe lk ll lm ln b">flow</code>中，包含模块的类型声明，第二个在<code class="fe lk ll lm ln b">polyfills</code>中，似乎是开始研究的好地方。于是我打开文件，开始乱搞，读取函数，直到找到这个函数<code class="fe lk ll lm ln b">getNativeLogFunction</code>。见下文。</p><figure class="kd ke kf kg gt kh"><div class="bz fp l di"><div class="ms mt l"/></div><figcaption class="mm mn gj gh gi mo mp bd b be z dk">function getNativeLogFunction inside <code class="fe lk ll lm ln b">console.js</code> file</figcaption></figure><p id="a5f6" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">这个函数接受日志级别的参数，操作我们的字符串，最后调用全局对象上的<code class="fe lk ll lm ln b">nativeLoggingHook</code>。但是浏览器中没有名称为<code class="fe lk ll lm ln b">nativeLoggingHook</code>的功能。这让我很好奇，我进一步研究React Native是否提供了这个函数的实现。</p><p id="25bc" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">所以现在我在回购中搜索<code class="fe lk ll lm ln b">nativeLoggingHook</code>，有趣的是找到了一个文件。见下图。</p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi mu"><img src="../Images/7f5827338dc57933d572e7f047224242.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*l8A7uh_z-6J2eNeuwcLgEA.png"/></div></div></figure><p id="f1d1" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">在我的大部分开发生涯中，我一直是一名JavaScript开发人员，从未真正有机会从事CPP工作。但是我们内心都有一个好奇的孩子，我的孩子引导我打开文件，读了一下这个方法。</p><p id="ec6a" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">几分钟后，我意识到我在CPP方面有多糟糕，所以在陷入抑郁之前，我做了我在学习新东西时一直在做的事情——我假设我知道这个代码做什么，并继续调查<code class="fe lk ll lm ln b">bindNativeLogger</code>在代码中是如何使用的。</p><p id="080c" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">我在资源库中搜索了<code class="fe lk ll lm ln b">bindNativeLogger</code>，找到了两个文件。见下图。</p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi mv"><img src="../Images/c1b5c62897cb7610ce68c17f3c77ea11.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-i0SEXgVxaPbva4ock3eqA.png"/></div></div></figure><p id="dfd7" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">这是事情最终开始有意义的地方。在上面的这两个文件中，<code class="fe lk ll lm ln b">bindNativeLogger</code>是用JavaScript运行时和本地日志程序调用的——<code class="fe lk ll lm ln b">RCTJSIExecutorRuntimeInstaller.mm</code>中的<code class="fe lk ll lm ln b">iosLoggingBinder</code>和<code class="fe lk ll lm ln b">OnLoad.cpp</code>中的<code class="fe lk ll lm ln b">androidLogger</code>。</p><p id="06aa" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">然后我打开了<code class="fe lk ll lm ln b">RCTJSIExecutorRuntimeInstaller.mm</code>文件，在这里用JavaScript运行时和<code class="fe lk ll lm ln b">iosLoggingBinder</code>调用了方法<code class="fe lk ll lm ln b">bindNativeLogger</code>。参见下面第15行的代码。</p><figure class="kd ke kf kg gt kh"><div class="bz fp l di"><div class="ms mt l"/></div></figure><p id="b7de" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">再深入一点，我发现<code class="fe lk ll lm ln b">iosLoggingBinder</code>是在<code class="fe lk ll lm ln b">RCTLog.mm</code>中定义的一个函数<code class="fe lk ll lm ln b">_RCTLogJavaScriptInternal</code>。见下图。</p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi mw"><img src="../Images/a9f06bedb4004240ca04d1943f01b947.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xrl3BEjSF51GJ84KGM0PXw.png"/></div></div></figure><p id="e67d" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">这就是<code class="fe lk ll lm ln b">console.log</code>最终在iOS生态系统中被调用的地方。所以不知何故，我用JavaScript编写的控制台深入了一堆方法，最终在<code class="fe lk ll lm ln b">RCTLog.mm</code>文件中调用了<code class="fe lk ll lm ln b">_RCTLogJavaScriptInternal</code>方法。中间涉及到CPP，但是作为一个JavaScript开发人员，我可以忽略它，至少在一段时间内。见下图。</p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi mx"><img src="../Images/bd5d5f68ef4d8a789773c4dd3142a8ef.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bWvbO90mqOHpGcsjqnTTQw.png"/></div></div><figcaption class="mm mn gj gh gi mo mp bd b be z dk">Credit: YT video — Building React Native: Take a look at the internals — Parashuram N</figcaption></figure><p id="7d62" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">所以在某种程度上，JavaScript是在调用原生模块，而不是真正使用React原生桥。这甚至不是异步的，只是一个接一个的调用。这让我很好奇，我最终回到了我之前忽略的CPP代码。</p><p id="fd13" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">我之前忽略的CPP代码是众所周知的JavaScript接口，也就是JSI——新的React原生架构。JSI是一种新的、标准化的方式，将本机模块中的本机Java或Objective-C对象展示给JavaScript世界。</p><h1 id="8f47" class="lo lp in bd lq lr ls lt lu lv lw lx ly jt lz ju ma jw mb jx mc jz md ka me mf bi translated">奖金</h1><p id="e935" class="pw-post-body-paragraph ko kp in kq b kr mg jo kt ku mh jr kw kx mi kz la lb mj ld le lf mk lh li lj ig bi translated">这让我更加好奇，然后我开始了解React Native正在开发的新架构。这只是一个简短的介绍，以点燃您对React Native社区中正在酝酿的这一新的有趣事物的好奇心。</p><p id="b1d5" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">如果你一直在React Native上开发移动应用，那么请订阅这个博客，因为在下一部分中，我将更深入地研究这个新的架构，探索诸如TurboModules、JSI、Fabric和CodeGen之类的东西。</p><p id="5eb8" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated"><strong class="kq io"> <em class="my">让你内心的极客赢！</em>T3】</strong></p><p id="d385" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated"><em class="my">更多内容看</em> <a class="ae mz" href="http://plainenglish.io/" rel="noopener ugc nofollow" target="_blank"> <strong class="kq io"> <em class="my">说白了就是</em> </strong> </a> <em class="my">。报名参加我们的</em> <a class="ae mz" href="http://newsletter.plainenglish.io/" rel="noopener ugc nofollow" target="_blank"> <strong class="kq io"> <em class="my">免费周报</em> </strong> </a> <em class="my">。在我们的</em> <a class="ae mz" href="https://discord.gg/GtDtUAvyhW" rel="noopener ugc nofollow" target="_blank"> <strong class="kq io"> <em class="my">社区获得独家访问写作机会和建议</em> </strong> </a> <em class="my">。</em></p></div></div>    
</body>
</html>