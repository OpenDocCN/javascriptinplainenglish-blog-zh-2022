<html>
<head>
<title>Manage Cookie Consent in Next.js with Google Tag Manager</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Google标签管理器管理Next.js中的Cookie同意</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/manage-cookie-consent-in-next-js-with-google-tag-manager-4d58818266ea?source=collection_archive---------1-----------------------#2022-07-28">https://javascript.plainenglish.io/manage-cookie-consent-in-next-js-with-google-tag-manager-4d58818266ea?source=collection_archive---------1-----------------------#2022-07-28</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="3117" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">关于如何在Next.js项目中获得用户的Cookie同意并使用Google Tag Manager内置同意概述处理它的指南。</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/8863861af90e6f297c00fd5a6dc2b9eb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lVJIPeJ7TRThHQXlpIsmFQ.jpeg"/></div></div></figure><p id="1dbc" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">如今，大多数网站都需要Cookie许可系统来遵守GDPR(和其他)欧洲法规。基本上，这意味着你不能在用户的计算机上存储cookies，如果他们不允许你这样做的话。你也不能允许你网站上活跃的其他服务(如分析或广告)在你的域名上存储cookies。</p><p id="8f39" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">在本文中，我将展示如何在Next.js项目中获得用户的Cookie同意，并使用Google Tag Manager内置的同意概述来处理它。</p><h2 id="2b6c" class="ln lo iq bd lp lq lr dn ls lt lu dp lv la lw lx ly le lz ma mb li mc md me mf bi translated">先决条件</h2><p id="c831" class="pw-post-body-paragraph kr ks iq kt b ku mg jr kw kx mh ju kz la mi lc ld le mj lg lh li mk lk ll lm ij bi translated">要跟进这个项目，您需要:</p><ul class=""><li id="65ea" class="ml mm iq kt b ku kv kx ky la mn le mo li mp lm mq mr ms mt bi translated">一个Google Tag Manager帐户和它的带有启用同意概述的容器(我将向您展示如何启用它)</li><li id="3a83" class="ml mm iq kt b ku mu kx mv la mw le mx li my lm mq mr ms mt bi translated">set cookie使用Google Tag Manager实现的服务(我们将使用Google Analytics，因为大多数Google服务都有自动同意检查，但其他服务也可以轻松实现)</li><li id="c97e" class="ml mm iq kt b ku mu kx mv la mw le mx li my lm mq mr ms mt bi translated">一个基本的Next.js项目，其中我们将实现cookie同意的标志</li><li id="295e" class="ml mm iq kt b ku mu kx mv la mw le mx li my lm mq mr ms mt bi translated">我们将使用的Next.js布局的基本知识</li></ul><h2 id="45cc" class="ln lo iq bd lp lq lr dn ls lt lu dp lv la lw lx ly le lz ma mb li mc md me mf bi translated">限制</h2><p id="a8c9" class="pw-post-body-paragraph kr ks iq kt b ku mg jr kw kx mh ju kz la mi lc ld le mj lg lh li mk lk ll lm ij bi translated">我们将构建一个基本的例子，在这个例子中，用户可以接受或拒绝cookie，对于接受和拒绝哪些cookie没有粒度或选择。但是将这个例子扩展到一个更完整的解决方案将是一件容易的事情。</p><h2 id="83d8" class="ln lo iq bd lp lq lr dn ls lt lu dp lv la lw lx ly le lz ma mb li mc md me mf bi translated">它将如何工作</h2><p id="0300" class="pw-post-body-paragraph kr ks iq kt b ku mg jr kw kx mh ju kz la mi lc ld le mj lg lh li mk lk ll lm ij bi translated">我们的Next.js项目将在页面中包含一个标签管理器容器，它将成为我们所有监控代码(分析、广告、再营销……)的入口点，标签管理器将基于用户同意“运行”代码，因此我们将制作一个横幅，让用户给予(或拒绝)同意。同意(确切地说是同意，因为有更多的同意)被持久化，并在每个页面请求时被发送到标记管理器，以便标记被正确地触发，cookies根据用户的选择被设置。</p><p id="01ac" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">正如我们所说，有更多的同意和更多的cookie类型，标签管理器将支持:</p><ul class=""><li id="9119" class="ml mm iq kt b ku kv kx ky la mn le mo li mp lm mq mr ms mt bi translated">ad_storage(跟踪广告的cookies)</li><li id="78ae" class="ml mm iq kt b ku mu kx mv la mw le mx li my lm mq mr ms mt bi translated">分析_存储(cookies跟踪统计数据)</li><li id="28f3" class="ml mm iq kt b ku mu kx mv la mw le mx li my lm mq mr ms mt bi translated">functionality_storage(存储供网站使用的数据的cookies，如语言)</li><li id="69c3" class="ml mm iq kt b ku mu kx mv la mw le mx li my lm mq mr ms mt bi translated">personalization_storage(基于用户偏好定制用户体验的cookies)</li><li id="f0f7" class="ml mm iq kt b ku mu kx mv la mw le mx li my lm mq mr ms mt bi translated">security_storage(存储登录信息、密钥等的cookies)</li></ul><p id="bb7e" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">还有一些默认情况下启用的必要cookies，这是站点正常工作所必需的(例如电子商务中的购物车功能)</p><p id="c021" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">谷歌服务(如分析和广告)有内置的同意检查，对于其他服务，你需要指定所需的同意才能工作(稍后会详细介绍)</p><p id="f9c6" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">对于这个例子，我们将实现内置同意的Google Analytics。</p><h1 id="c420" class="mz lo iq bd lp na nb nc ls nd ne nf lv jw ng jx ly jz nh ka mb kc ni kd me nj bi translated">设置标签管理器</h1><p id="5c33" class="pw-post-body-paragraph kr ks iq kt b ku mg jr kw kx mh ju kz la mi lc ld le mj lg lh li mk lk ll lm ij bi translated">登录到您的谷歌标签管理器帐户，创建一个新的帐户和一个新的容器，给它一个名称，并选择Web作为目标平台。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nk"><img src="../Images/8fdab788c70a082e916d3e07526e89b6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yNuw7-r-WQqadhzv_4tMtg.png"/></div></div></figure><p id="7e67" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">在标签管理器中启用同意概述，标题为管理-&gt;容器设置:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nl"><img src="../Images/fd4395807110c206fcb70e33ffe01502.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*O4UrFOTlmJlhse9E514haw.png"/></div></div></figure><p id="ab9b" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">创建一个新标签来处理Google Analytics(您需要一个Google Analytics GA4活动帐户及其测量ID):转到<strong class="kt ir">标签</strong>，单击<strong class="kt ir">新建</strong>按钮，单击<strong class="kt ir">标签配置</strong>并添加<strong class="kt ir"> <em class="nm"> Google Analytics: GA4配置</em> </strong>标签类型。通过添加测量ID进行配置(您可以从Google Analytics配置中获得)，然后向下滚动到<em class="nm">同意设置</em>，并选择<em class="nm">无需额外同意</em>。如你所见，GA4为<em class="nm"> ad_storage </em>和<em class="nm"> analytics_storage启用了内置的同意检查。</em>这意味着您需要向Tag Manager提供这两项许可，以便从Google Analytics启用cookie存储和跟踪。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nn"><img src="../Images/2653178890329660288c2106879b5cfd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*78EY5u-u87klKR6rLwOo6w.png"/></div></div></figure><p id="202c" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">然后，您需要配置触发触发器，以便在Next.js中的每个页面上触发分析，您需要触发所有页面和历史更改。点击<em class="nm">选择一个触发器使该标签触发……</em>选择<em class="nm">所有页面</em>，然后点击+按钮添加另一个触发器，再次点击+号创建一个自定义触发器。在Nextjs中将其命名为<em class="nm">页面更改</em>点击<em class="nm">选择一个触发类型开始设置… </em>选择<em class="nm">历史更改</em>并保存。最后，您的标记配置应该如下所示:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi no"><img src="../Images/94ac1689431c9e867f5fe6bcbfa907a5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_Mhkzoz_j-oG_JQH1j9hFA.png"/></div></div></figure><p id="8bd1" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">不要忘记提交工作区来发布它。</p><h1 id="e0f5" class="mz lo iq bd lp na nb nc ls nd ne nf lv jw ng jx ly jz nh ka mb kc ni kd me nj bi translated">创建新的Next.js项目</h1><p id="9d69" class="pw-post-body-paragraph kr ks iq kt b ku mg jr kw kx mh ju kz la mi lc ld le mj lg lh li mk lk ll lm ij bi translated">我们现在可以创建一个新的Next.js项目并安装我们需要的依赖项，我们将使用cookies-next来处理cookies，并使用Tailwind来设置同意弹出窗口的样式。</p><p id="f493" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">创建新项目:</p><pre class="kg kh ki kj gt np nq nr ns aw nt bi"><span id="5ffa" class="ln lo iq nq b gy nu nv l nw nx"><strong class="nq ir">npx create-next-app consent</strong></span></pre><p id="2ab4" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">添加cookies下一个模块:</p><pre class="kg kh ki kj gt np nq nr ns aw nt bi"><span id="3b9e" class="ln lo iq nq b gy nu nv l nw nx"><strong class="nq ir">npm install --save cookies-next</strong></span></pre><p id="2933" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">按照官方指南安装和配置顺风CSS <a class="ae ny" href="https://tailwindcss.com/docs/guides/nextjs" rel="noopener ugc nofollow" target="_blank">:</a></p><div class="nz oa gp gr ob oc"><a href="https://tailwindcss.com/docs/guides/nextjs" rel="noopener  ugc nofollow" target="_blank"><div class="od ab fo"><div class="oe ab of cl cj og"><h2 class="bd ir gy z fp oh fr fs oi fu fw ip bi translated">用Next.js - Tailwind CSS安装Tailwind CSS</h2><div class="oj l"><h3 class="bd b gy z fp oh fr fs oi fu fw dk translated">顺风CSS框架的文档。</h3></div><div class="ok l"><p class="bd b dl z fp oh fr fs oi fu fw dk translated">tailwindcss.com</p></div></div><div class="ol l"><div class="om l on oo op ol oq kp oc"/></div></div></a></div><p id="113f" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">在这一点上，如果你用<code class="fe or os ot nq b"><strong class="kt ir">npm run dev</strong></code>运行应用程序，并前往<code class="fe or os ot nq b"><a class="ae ny" href="http://localhost:3000" rel="noopener ugc nofollow" target="_blank"><strong class="kt ir">http://localhost:3000</strong></a></code> <strong class="kt ir"> </strong>，你应该得到基本的Next.js主屏幕:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ou"><img src="../Images/68baed99220ceafe527d778632071d89.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_jISB7yuPP3eUowTAC3wCQ.png"/></div></div></figure><h2 id="295c" class="ln lo iq bd lp lq lr dn ls lt lu dp lv la lw lx ly le lz ma mb li mc md me mf bi translated">将标记管理器代码添加到项目中</h2><p id="bfdc" class="pw-post-body-paragraph kr ks iq kt b ku mg jr kw kx mh ju kz la mi lc ld le mj lg lh li mk lk ll lm ij bi translated">首先，我们需要将标签管理器代码添加到我们的项目中；为此，我们将使用<strong class="kt ir">next/script API</strong>(<a class="ae ny" href="https://nextjs.org/docs/api-reference/next/script" rel="noopener ugc nofollow" target="_blank">https://nextjs.org/docs/api-reference/next/script</a>)。从标签管理器Admin - &gt;中获取JavaScript代码(您需要获取放在<strong class="kt ir">头</strong>中的代码)安装Google标签管理器:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi no"><img src="../Images/69bbb0eab25ca3105f48948f877e1971.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*d8H0eIe-zTIqStN0qNKJvg.png"/></div></div></figure><p id="5b3f" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">复制的代码将被添加到our _app.js中，以便在我们项目的每个页面上执行:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ov ow l"/></div></figure><p id="546b" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">要测试一切是否正确，您可以使用标签管理器中的<strong class="kt ir">预览</strong>功能。转到您当前在Tag Manager中使用的工作区，然后单击预览按钮。系统会提示您输入要测试的URL，键入<a class="ae ny" href="http://localhost:3000" rel="noopener ugc nofollow" target="_blank"> http://localhost:3000 </a>，然后连接。将会打开一个包含您的本地站点的新页面，如果一切都已配置好，该页面将会显示一个通知，告知您Tag Manager已连接:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ox"><img src="../Images/837f2ed02bbf39b6fc542dd2f209de12.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*M37EW7JFQFlz2zt5-h0rfw.png"/></div></div></figure><p id="7f9a" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">您还可以在标签助手页面上看到页面渲染和触发标签的工作流程，因为您可以看到标签管理器将正确触发GA4标签(它将在加载了的<em class="nm">容器中触发):</em></p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ox"><img src="../Images/0c54f007994e7d3ab704b23f09edcb44.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WKuiBcRd3pUky6MLON0YLA.png"/></div></div></figure><h2 id="6fc1" class="ln lo iq bd lp lq lr dn ls lt lu dp lv la lw lx ly le lz ma mb li mc md me mf bi translated">在每个页面上添加同意弹出窗口</h2><p id="a062" class="pw-post-body-paragraph kr ks iq kt b ku mg jr kw kx mh ju kz la mi lc ld le mj lg lh li mk lk ll lm ij bi translated">我们现在需要在项目的每个页面上添加一个同意弹出窗口，该弹出窗口将有一个<strong class="kt ir">关闭按钮</strong>，一个<strong class="kt ir">拒绝cookie按钮</strong>和一个<strong class="kt ir">接受cookie按钮</strong>。根据用户的选择，同意cookie将与首选项一起保存在用户的计算机上。仅当首选项cookie不存在时，弹出窗口才会打开。关闭按钮不会保存cookie，因此弹出窗口将再次显示。</p><p id="5bab" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">使用这些特性创建弹出窗口有许多策略，我们将使用Nextjs布局特性和弹出窗口本身的组件。<a class="ae ny" href="https://nextjs.org/docs/basic-features/layouts" rel="noopener ugc nofollow" target="_blank">了解Next.js中布局的更多信息</a>。</p><p id="b6f3" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">首先，我们创建一个新组件(在<code class="fe or os ot nq b"><strong class="kt ir">component/consent.js</strong></code>):</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ov ow l"/></div></figure><p id="7ba3" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">这是一个基本的div，绝对位于页面底部，有3个按钮，每个按钮单击都会关闭横幅(通过隐藏它)，而且<strong class="kt ir">接受</strong>和<strong class="kt ir">拒绝</strong>按钮将设置一个cookie(名称为localConsent，持续时间为一年)，该cookie的值可以为true或false。用户上的cookie不会再次显示横幅，cookie的值将在以后用于启用(或禁用)Tag Manager上的一致性。</p><p id="0e85" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">将通过使用Next.js布局将consent.js组件添加到页面中，在<strong class="kt ir">组件</strong>文件夹中添加一个名为<code class="fe or os ot nq b"><strong class="kt ir">layout.js</strong></code> <strong class="kt ir">的文件。</strong></p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ov ow l"/></div></figure><p id="32a6" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">并使用<code class="fe or os ot nq b"><strong class="kt ir">app.js</strong></code> <strong class="kt ir"> : </strong>实现</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ov ow l"/></div></figure><p id="e7a7" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">这样，每个页面都将包含同意横幅。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ou"><img src="../Images/ff2372ce93faea9cedae7dcf5a936d56.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Ax7xFKZskKIA7bFBwgp6DQ.jpeg"/></div></div><figcaption class="oy oz gj gh gi pa pb bd b be z dk">Before accepting the cookie</figcaption></figure><p id="ae7f" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">此时，如果您运行您的项目，页面底部将出现同意横幅，当您单击其中一个按钮时，横幅将隐藏，并且(如果您单击了<strong class="kt ir">接受</strong>或<strong class="kt ir">拒绝</strong>)将设置本地同意cookie。如果本地同意cookie存在，横幅将不会再次显示，但如果您(手动)删除cookie，横幅将会显示回来。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ou"><img src="../Images/098b7fe0a0aaeea9f8a02a2ca3126da2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5avub0vAhulVw3MCOfByXQ.jpeg"/></div></div><figcaption class="oy oz gj gh gi pa pb bd b be z dk">After accepting the cookie</figcaption></figure><p id="0176" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">你可能会注意到，由于我们还没有实现同意模式，Google Analytics(通过标签管理器)还设置了两个cookies来跟踪你。</p><h2 id="8864" class="ln lo iq bd lp lq lr dn ls lt lu dp lv la lw lx ly le lz ma mb li mc md me mf bi translated">实施同意模式</h2><p id="7e79" class="pw-post-body-paragraph kr ks iq kt b ku mg jr kw kx mh ju kz la mi lc ld le mj lg lh li mk lk ll lm ij bi translated">现在所有的部分都就位了，我们可以开始把它们连接起来。正如Google所记录的，同意模式应该总是以拒绝开始，然后应该使用本地存储的用户偏好进行更新。这个检查必须在站点的每个页面上进行，所以我们现在必须再次修改<code class="fe or os ot nq b"><strong class="kt ir">_app.js</strong></code> <strong class="kt ir"> </strong>以将默认同意值<strong class="kt ir">拒绝</strong>添加到我们的标签管理器代码中:</p><pre class="kg kh ki kj gt np nq nr ns aw nt bi"><span id="17f3" class="ln lo iq nq b gy nu nv l nw nx">gtag(‘consent’, ‘default’, {<br/>   ‘ad_storage’: ‘denied’,<br/>   ‘analytics_storage’: ‘denied’<br/>});</span></pre><p id="9bc9" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">这样就变成了:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ov ow l"/></div></figure><p id="4319" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">如果您删除了<strong class="kt ir"> localConsent </strong> cookie，并使用Tag Manager Tag Assistant测试您的项目，您将看到两个指定范围的同意状态被拒绝，并且我们发送了一个默认值，没有更新:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ox"><img src="../Images/01033afb50f395aceeac6a3195035064.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HkNsjysvdre8REWmd2HxXw.png"/></div></div></figure><p id="20e5" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">如果您单击Accept now，那么在Tag Manager端将不会发生任何事情，同样，如果您重新加载localConsent cookie设置为<em class="nm"> true </em>的页面，那么您的同意仍然会被拒绝，并且不会检测到更新。我们需要找到一种方法来通知标签管理器更新，一旦同意就在按钮点击和页面加载时通知。</p><p id="4611" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">对于(accept)按钮，我们在content.js组件的Accept函数中添加了gtag更新:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ov ow l"/></div></figure><p id="9a64" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">因此，当单击该按钮时，ad_storage和analytics storage的Tag Manager上的许可设置为granted。<br/>删除所有localhost cookies并用Tag Assistant再次测试，您会看到当您单击accept all时，将触发一个新的<em class="nm">同意</em>事件来检测更新。您还会注意到，如果您没有单击Accept，则GA4 cookies中的一个没有设置，该cookie是跟踪您的cookie。如果您单击“拒绝”,同意不会更新，因此GA不会发送跟踪cookie。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ox"><img src="../Images/683191e49e51658167ffb9493adf8588.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JVR39-qibauseiNdIgUjqg.png"/></div></div></figure><p id="4d12" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">如果您重新加载页面或移动到另一个页面，同意再次被初始化为拒绝，因此为了在导航期间保持，我们需要在<code class="fe or os ot nq b"><strong class="kt ir">_app.js</strong></code> <strong class="kt ir"> </strong>文件中实现更新，方法是读取cookie并在需要时发送gtag更新事件:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ov ow l"/></div></figure><p id="ae84" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">如果您现在在标签助手中测试，您将会看到在移动到页面或重新加载时发送了更新为“已授予”的内容(如果之前已给予同意)。</p><h2 id="d52d" class="ln lo iq bd lp lq lr dn ls lt lu dp lv la lw lx ly le lz ma mb li mc md me mf bi translated">对更多服务实施同意</h2><p id="04f9" class="pw-post-body-paragraph kr ks iq kt b ku mg jr kw kx mh ju kz la mi lc ld le mj lg lh li mk lk ll lm ij bi translated">正如我们之前提到的，谷歌服务已经内置了同意检查。如果您需要为其他跟踪服务(脸书像素、Pinterest跟踪、其他广告或分析系统)实现它，您需要知道哪些是要启用的服务的范围(ad_storage、analytics_storage等)，并将它们添加到标签的同意设置中的<em class="nm">需要标签启动的附加同意</em>:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi pc"><img src="../Images/f15e00b53e7ec42b3690856f48d645e1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lVOOr3HRwpb5ZeH79VIDgQ.png"/></div></div><figcaption class="oy oz gj gh gi pa pb bd b be z dk">Adding Consent for non-Google services</figcaption></figure><h1 id="0d47" class="mz lo iq bd lp na nb nc ls nd ne nf lv jw ng jx ly jz nh ka mb kc ni kd me nj bi translated">改进和扩展</h1><p id="58d2" class="pw-post-body-paragraph kr ks iq kt b ku mg jr kw kx mh ju kz la mi lc ld le mj lg lh li mk lk ll lm ij bi translated">由于这是一个基础项目，只是一个关于如何使用Google Tag Manager管理Next.js中的同意的概念，所以它不能被视为一个完整的产品化项目。</p><p id="c050" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">您可能想要改进和扩展项目，以下是您可以/应该为生产环境做的几件事:</p><ul class=""><li id="d135" class="ml mm iq kt b ku kv kx ky la mn le mo li mp lm mq mr ms mt bi translated">除了Accept/Deny all之外，您希望用户通过给用户选择接受和拒绝哪个范围的机会来单独管理同意范围；您可以将首选项存储在多个cookie中，或者存储在单个cookie中的序列化对象中。</li><li id="486a" class="ml mm iq kt b ku mu kx mv la mw le mx li my lm mq mr ms mt bi translated">让用户管理cookie首选项，在首次设置后，允许用户删除或授予单个同意范围。</li></ul><p id="9559" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">感谢阅读。</p></div><div class="ab cl pd pe hu pf" role="separator"><span class="pg bw bk ph pi pj"/><span class="pg bw bk ph pi pj"/><span class="pg bw bk ph pi"/></div><div class="ij ik il im in"><h2 id="0026" class="ln lo iq bd lp lq lr dn ls lt lu dp lv la lw lx ly le lz ma mb li mc md me mf bi translated">进一步阅读</h2><div class="nz oa gp gr ob oc"><a rel="noopener  ugc nofollow" target="_blank" href="/i-built-a-serverless-live-chat-app-with-next-js-fauna-and-wundergraph-for-graphql-live-queries-b671d9646f6"><div class="od ab fo"><div class="oe ab of cl cj og"><h2 class="bd ir gy z fp oh fr fs oi fu fw ip bi translated">我用Next.js、Fauna和WunderGraph为GraphQL实时查询构建了一个无服务器的实时聊天应用程序</h2><div class="oj l"><h3 class="bd b gy z fp oh fr fs oi fu fw dk translated">这是使用无服务器技术创建可扩展的实时聊天应用程序的一步一步的指南，并有来自…</h3></div><div class="ok l"><p class="bd b dl z fp oh fr fs oi fu fw dk translated">javascript.plainenglish.io</p></div></div><div class="ol l"><div class="pk l on oo op ol oq kp oc"/></div></div></a></div><div class="nz oa gp gr ob oc"><a href="https://blog.bitsrc.io/next-js-13-what-do-the-new-bleeding-edge-features-actually-do-d3e5fd418563" rel="noopener  ugc nofollow" target="_blank"><div class="od ab fo"><div class="oe ab of cl cj og"><h2 class="bd ir gy z fp oh fr fs oi fu fw ip bi translated">Next.js 13:新的前沿特性实际上是做什么的？</h2><div class="oj l"><h3 class="bd b gy z fp oh fr fs oi fu fw dk translated">你听说过Next.js 13是一个游戏改变者，但是为什么？让我们看看有哪些新功能，有哪些变化，以及它们…</h3></div><div class="ok l"><p class="bd b dl z fp oh fr fs oi fu fw dk translated">blog.bitsrc.io</p></div></div><div class="ol l"><div class="pl l on oo op ol oq kp oc"/></div></div></a></div><p id="e02b" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated"><em class="nm">更多内容请看</em><a class="ae ny" href="https://plainenglish.io/" rel="noopener ugc nofollow" target="_blank"><strong class="kt ir"><em class="nm">plain English . io</em></strong></a><em class="nm">。报名参加我们的</em> <a class="ae ny" href="http://newsletter.plainenglish.io/" rel="noopener ugc nofollow" target="_blank"> <strong class="kt ir"> <em class="nm">免费周报</em> </strong> </a> <em class="nm">。关注我们关于</em><a class="ae ny" href="https://twitter.com/inPlainEngHQ" rel="noopener ugc nofollow" target="_blank"><strong class="kt ir"><em class="nm">Twitter</em></strong></a><a class="ae ny" href="https://www.linkedin.com/company/inplainenglish/" rel="noopener ugc nofollow" target="_blank"><strong class="kt ir"><em class="nm">LinkedIn</em></strong></a><em class="nm"/><a class="ae ny" href="https://www.youtube.com/channel/UCtipWUghju290NWcn8jhyAw" rel="noopener ugc nofollow" target="_blank"><strong class="kt ir"><em class="nm">YouTube</em></strong></a><em class="nm"/><a class="ae ny" href="https://discord.gg/GtDtUAvyhW" rel="noopener ugc nofollow" target="_blank"><strong class="kt ir"><em class="nm">不和</em> </strong> </a> <em class="nm">。对增长黑客感兴趣？检查</em> <a class="ae ny" href="https://circuit.ooo/" rel="noopener ugc nofollow" target="_blank"> <strong class="kt ir"> <em class="nm">电路</em> </strong> </a> <em class="nm">。</em></p></div></div>    
</body>
</html>