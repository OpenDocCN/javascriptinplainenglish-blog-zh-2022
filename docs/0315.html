<html>
<head>
<title>Passwordless Authentication in Next.js with NextAuth.js and MongoDB</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用NextAuth.js和MongoDB在Next.js中进行无密码身份验证</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/passwordless-authentication-in-next-js-with-nextauth-js-and-mongodb-19760c79184?source=collection_archive---------2-----------------------#2022-01-19">https://javascript.plainenglish.io/passwordless-authentication-in-next-js-with-nextauth-js-and-mongodb-19760c79184?source=collection_archive---------2-----------------------#2022-01-19</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="e8e5" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">关于使用NextAuth.js和MongoDB进行无密码身份验证的指南。</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/3d00fbc92cf00235882e98c5089c3f42.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZVTUOH267Zow8odT1ikMhQ.jpeg"/></div></div></figure><p id="dd26" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">无密码身份验证允许用户无需提供和注册密码即可登录网站。即使它不能被认为是完全安全的(就像每一种登录方法一样)，它也完全绕过了用户对密码的选择，这通常是登录过程中最薄弱的部分。</p><p id="738f" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">在无密码登录中，所谓的所有权因素用于身份验证:一次性密码、注册的设备访问、生物识别和发送到用户电子邮件的神奇链接，这是我们将实现的。</p><h2 id="ffd8" class="ln lo iq bd lp lq lr dn ls lt lu dp lv la lw lx ly le lz ma mb li mc md me mf bi translated">工作流程</h2><p id="f153" class="pw-post-body-paragraph kr ks iq kt b ku mg jr kw kx mh ju kz la mi lc ld le mj lg lh li mk lk ll lm ij bi translated">在我们的例子中(使用神奇链接的无密码认证)，用户向他/她想要登录的服务/网站提供一个电子邮件地址，网站将生成一个一次性令牌，该令牌被发送到用户的电子邮件(在登录链接内)并存储在服务器上的某个位置。</p><p id="d09d" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">一旦用户点击链接，令牌就会与服务器上的令牌进行核对，如果匹配，用户就通过了身份验证。用户也存储在服务器上，这样在下次使用相同的电子邮件登录时，用户将被识别。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ml"><img src="../Images/ddb6f864b2b014745bade48884f54e4b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Ekx1RP0QaBJOgooNSCsDJA.jpeg"/></div></div><figcaption class="mm mn gj gh gi mo mp bd b be z dk">Magic Link Authentication Workflow</figcaption></figure><p id="bbf1" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">为了在Next.js应用程序中集成这种身份验证，我们将使用NextAuth.js，它是Next.js的一个身份验证解决方案，支持广泛的身份验证方法和数据库支持，我们选择将数据存储在MongoDB服务器上，因为从我们的测试来看，它看起来更可靠，更容易实现</p><div class="mq mr gp gr ms mt"><a href="https://next-auth.js.org/" rel="noopener  ugc nofollow" target="_blank"><div class="mu ab fo"><div class="mv ab mw cl cj mx"><h2 class="bd ir gy z fp my fr fs mz fu fw ip bi translated">NextAuth.js</h2><div class="na l"><h3 class="bd b gy z fp my fr fs mz fu fw dk translated">Next.js的身份验证</h3></div><div class="nb l"><p class="bd b dl z fp my fr fs mz fu fw dk translated">next-auth.js.org</p></div></div><div class="nc l"><div class="nd l ne nf ng nc nh kp mt"/></div></div></a></div><h2 id="a1ba" class="ln lo iq bd lp lq lr dn ls lt lu dp lv la lw lx ly le lz ma mb li mc md me mf bi translated"><strong class="ak">先决条件</strong></h2><p id="da5b" class="pw-post-body-paragraph kr ks iq kt b ku mg jr kw kx mh ju kz la mi lc ld le mj lg lh li mk lk ll lm ij bi translated">要跟进，您需要:</p><ul class=""><li id="c9a9" class="ni nj iq kt b ku kv kx ky la nk le nl li nm lm nn no np nq bi translated">Next.js的基础知识，尤其是路由/页面系统。</li><li id="bf0a" class="ni nj iq kt b ku nr kx ns la nt le nu li nv lm nn no np nq bi translated">MongoDB数据库访问可以是本地的，也可以是远程托管的(比如<a class="ae nw" href="https://www.mongodb.com/it-it/cloud/atlas/register" rel="noopener ugc nofollow" target="_blank"> MongoDB Atlas </a></li><li id="14db" class="ni nj iq kt b ku nr kx ns la nt le nu li nv lm nn no np nq bi translated">节点包管理的基本知识</li><li id="9456" class="ni nj iq kt b ku nr kx ns la nt le nu li nv lm nn no np nq bi translated">你可以访问SMTP服务器来发送电子邮件，你可以使用本地服务器或远程服务(例如<a class="ae nw" href="https://www.mailjet.com/" rel="noopener ugc nofollow" target="_blank"> Mailjet </a>或<a class="ae nw" href="https://sendinblue.com" rel="noopener ugc nofollow" target="_blank"> Sendinblue </a>，如果你使用Google Workspace，你也可以使用Gmail SMTP)</li></ul><h2 id="2d21" class="ln lo iq bd lp lq lr dn ls lt lu dp lv la lw lx ly le lz ma mb li mc md me mf bi translated">设置应用程序</h2><p id="4f74" class="pw-post-body-paragraph kr ks iq kt b ku mg jr kw kx mh ju kz la mi lc ld le mj lg lh li mk lk ll lm ij bi translated">使用以下命令创建一个新的Next.js应用程序:</p><pre class="kg kh ki kj gt nx ny nz oa aw ob bi"><span id="bd0f" class="ln lo iq ny b gy oc od l oe of">npx create-next-app some-project-name</span></pre><p id="73b0" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">安装所需的模块:</p><pre class="kg kh ki kj gt nx ny nz oa aw ob bi"><span id="46cd" class="ln lo iq ny b gy oc od l oe of">npm install nodemailer<br/>npm install next-auth <a class="ae nw" href="http://twitter.com/next" rel="noopener ugc nofollow" target="_blank">@next</a>-auth/mongodb-adapter mongodb</span></pre><p id="b087" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">创建密钥(在开发中是可选的，但在生产中是必需的)</p><pre class="kg kh ki kj gt nx ny nz oa aw ob bi"><span id="f481" class="ln lo iq ny b gy oc od l oe of">openssl rand -base64 32</span></pre><p id="33b3" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">此时，您可以用所有需要的配置设置您的环境文件<code class="fe og oh oi ny b">.env.local</code>:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="oj ok l"/></div></figure><p id="6cc5" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">您需要填写您的SMTP服务器数据、您希望发送电子邮件的电子邮件地址、到MongoDB服务器的连接字符串。在这里，您可以添加应用程序的密钥和基本URL。</p><p id="83d3" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">创建文件<code class="fe og oh oi ny b"><strong class="kt ir">pages/lib/mongodb.js</strong></code>，根据Next.js文档和示例，这是连接到MongoDB服务器并与应用程序共享连接的正确方式:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="oj ok l"/></div></figure><p id="d47b" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">我们现在需要一个页面来响应所有NextAuth.js API端点(登录表单、错误、通知)。我们将通过创建以下文件来使用Next.js总括路由:<code class="fe og oh oi ny b"><strong class="kt ir">pages/api/auth/[...nextauth].js</strong></code>。它将自动显示预定义的NextAuth.js页面(稍后将详细介绍定制)。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="oj ok l"/></div></figure><p id="4a8f" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">在这个文件中，我们简单地定义了哪个是用于存储数据的适配器(MongoDB ),哪个是我们将在应用程序中使用的身份验证方法(在本例中，我们只使用电子邮件，但我们可以在以后添加更多)及其配置。我们还指定要使用JWT，这样就不会在每次请求时都查询数据库。</p><p id="4236" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">如果您转到以下URL，我们现在可以测试身份验证了:</p><pre class="kg kh ki kj gt nx ny nz oa aw ob bi"><span id="7a41" class="ln lo iq ny b gy oc od l oe of"><strong class="ny ir">http://localhost:3000/api/auth/signin</strong></span></pre><p id="6338" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">您将看到一个请求您发送电子邮件的表单(它使用标准的NextAuth.js前端):</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi ol"><img src="../Images/31e2fbf54d9b80714e41ad84b9bb6d43.png" data-original-src="https://miro.medium.com/v2/resize:fit:756/format:webp/1*kBvyuN-f9Qx2-Rho5euB2g.png"/></div></figure><p id="cd6a" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">提交您的电子邮件地址将会给您发送一封带有登录按钮的电子邮件。点击登录按钮，您将返回到该网站:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi gj"><img src="../Images/ae60e553985fc85128287520be8b9f36.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XqAWk_sv4f2aDo56N94phw.png"/></div></div></figure><p id="6b61" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">目前，身份验证工作流工作正常，但是我们需要一种方法来检查用户是否经过身份验证，页面是否受到保护等等。</p><p id="159f" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">为了实现这一点，我们需要将所有的应用程序页面包装在一个由NextAuth.js提供的SessionProvider中，它将处理用户会话和身份验证状态。首先，我们需要修改<code class="fe og oh oi ny b"><strong class="kt ir">_app.js</strong></code>文件以包含SessionProvider，这样session参数在站点范围内可用，并可用于检查用户是否经过身份验证:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="oj ok l"/></div></figure><p id="3819" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">然后我们可以用一种基本的方式修改我们的<code class="fe og oh oi ny b">index.js</code>文件，这样我们就可以知道我们是否通过了身份验证:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="oj ok l"/></div></figure><p id="6613" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">在文件中，我们检查用户的会话，如果它存在，我们假设用户已经过身份验证；<strong class="kt ir"> signIn </strong>和<strong class="kt ir"> signOut </strong>是提供的两个NextAuth.js API端点。<strong class="kt ir"> useSession </strong>对象还包含一个<em class="om">状态</em>，它可以有三个值:<code class="fe og oh oi ny b">loading | authenticated | unauthenticated</code>，这也可以用于更精细地控制向用户显示什么。</p><p id="8cfe" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">使用useSession，只有通过身份验证的用户才能访问单个页面，未通过身份验证的用户将看到登录表单，并在成功登录后被重定向到他们启动的页面:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="oj ok l"/></div></figure><h2 id="bc3a" class="ln lo iq bd lp lq lr dn ls lt lu dp lv la lw lx ly le lz ma mb li mc md me mf bi translated">用户化</h2><p id="9d1d" class="pw-post-body-paragraph kr ks iq kt b ku mg jr kw kx mh ju kz la mi lc ld le mj lg lh li mk lk ll lm ij bi translated">所有的NextAuth.js页面(登录表单、错误页面、通知)和电子邮件消息都可以定制。</p><p id="4b23" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">可以通过在<code class="fe og oh oi ny b"><strong class="kt ir">[...nextauth].js</strong></code>中添加<code class="fe og oh oi ny b"><strong class="kt ir">pages</strong></code> <strong class="kt ir"> </strong>部分来定制页面:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="oj ok l"/></div></figure><p id="60a9" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">您可能需要定制<strong class="kt ir">登录</strong>页面，只需创建一个<code class="fe og oh oi ny b">pages/auth/signin.js</code>，它将向签名API端点发送电子邮件地址(和一个csfrToken ):</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="oj ok l"/></div></figure><p id="2f5b" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">电子邮件定制仍将在<code class="fe og oh oi ny b"><strong class="kt ir">[...nextauth].js</strong></code>中进行，您需要将一个函数传递给EmailProvider()的<code class="fe og oh oi ny b"><strong class="kt ir">sendVerificationRequest</strong></code> <strong class="kt ir"> </strong>选项:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="oj ok l"/></div></figure><h2 id="6c1f" class="ln lo iq bd lp lq lr dn ls lt lu dp lv la lw lx ly le lz ma mb li mc md me mf bi translated">下一步是什么</h2><p id="5fae" class="pw-post-body-paragraph kr ks iq kt b ku mg jr kw kx mh ju kz la mi lc ld le mj lg lh li mk lk ll lm ij bi translated">NextAuth.js支持多种认证服务，你可以用社交登录来扩展你的登录表单(像脸书、推特和谷歌)。它还支持任意凭证登录，如果您已经有一个带有登录数据的用户基础，您可以将NextAuth.js插入其中。</p><p id="5f95" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">现在你知道了。感谢您的阅读。</p><p id="a4fd" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated"><em class="om">更多内容看</em> <a class="ae nw" href="http://plainenglish.io/" rel="noopener ugc nofollow" target="_blank"> <strong class="kt ir"> <em class="om">说白了。报名参加我们的</em> <a class="ae nw" href="http://newsletter.plainenglish.io/" rel="noopener ugc nofollow" target="_blank"> <strong class="kt ir"> <em class="om">免费周报</em> </strong> </a> <em class="om">。在我们的</em> <a class="ae nw" href="https://discord.gg/GtDtUAvyhW" rel="noopener ugc nofollow" target="_blank"> <strong class="kt ir"> <em class="om">社区不和谐</em> </strong> </a> <em class="om">获得独家获取写作机会和建议。</em></strong></a></p></div></div>    
</body>
</html>