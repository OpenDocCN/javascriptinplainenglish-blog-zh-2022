<html>
<head>
<title>Design Patterns: Observer Pattern in JavaScript</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">设计模式:JavaScript中的观察者模式</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/design-patterns-observer-pattern-in-javascript-b9611827a876?source=collection_archive---------1-----------------------#2022-12-20">https://javascript.plainenglish.io/design-patterns-observer-pattern-in-javascript-b9611827a876?source=collection_archive---------1-----------------------#2022-12-20</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="af95" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">使用主题在事件发生时通知观察者</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/ea7fe9ba285518cada8eb1d3f7c3f338.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*xALWoq_psmarsMrM"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk">Photo by <a class="ae kv" href="https://unsplash.com/@dlerman6?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Daniel Lerman</a> on <a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="8b49" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">早期很多网上商城运营不佳，没有提供价格下跌预警的功能。所以，这时候要想低价买到自己想要的产品，就需要经常逛网店，查看产品是否降价。这种方式很麻烦，很容易错过最佳购买时机。为了解决这一用户痛点，大多数网上商城不断升级系统，陆续上架了产品降价提醒功能。</p><p id="8eeb" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">以上场景很好理解，但现在问题来了。如果让你模拟实现单一产品的价格下跌预警功能，你会怎么做？给你一点时间考虑一下。让我也分析一下这个功能。</p><p id="4a2c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在单个产品降价提醒的场景中，主要包含两个角色:产品和用户。因为对产品感兴趣的用户可能不止一个，他们会开启降价提醒功能，所以产品要保存关注它的用户列表，当产品价格下降时，系统会获取关注该产品的用户列表，并逐一向他们推送消息。相关流程如下图所示。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ls"><img src="../Images/ea670f4f5e411f7222047f4adc2c668e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tCe9PQYTsZAaPkuP5oHEEw.jpeg"/></div></div></figure><p id="2fe2" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">基于上图中的流程信息，我们先定义一个<code class="fe lt lu lv lw b">Product</code>类:</p><pre class="kg kh ki kj gt lx lw ly bn lz ma bi"><span id="7371" class="mb mc iq lw b be md me l mf mg">class Product {<br/>  constructor(pid, name, price) {<br/>    this.pid = pid;<br/>    this.name = name;<br/>    this.price = price;<br/>  }<br/>  userIds = [];<br/><br/>  addNotification(userId) {<br/>    this.userIds.push(userId);<br/>  }<br/><br/>  notifyAllUser(price) {<br/>    this.userIds.forEach((userId) =&gt; {<br/>      console.log(<br/>        `Dear user ${userId},the product you are concerned about:<br/>          ${this.name},Price drop of $${this.price - price}.`<br/>      ); <br/>    });<br/>  }<br/>}<br/><br/>const laptop = new Product("A001", "Notebook", 999);<br/>laptop.addNotification("U001");<br/>laptop.addNotification("U002");<br/>laptop.notifyAllUser(899);</span></pre><p id="8191" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">当上述代码成功运行时，控制台将输出以下结果:</p><pre class="kg kh ki kj gt lx lw ly bn lz ma bi"><span id="292c" class="mb mc iq lw b be md me l mh mg">Dear user U001,the product you are concerned about:<br/>            Notebook,Price drop of $100.<br/>Dear user U002,the product you are concerned about:<br/>            Notebook,Price drop of $100.</span></pre><p id="6ce2" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">对于上面的例子，我们实际上在<code class="fe lt lu lv lw b">Product</code>类的定义中使用了观察者模式的思想。<strong class="ky ir">观察者模式定义了一对多的关系，允许多个观察者对象同时监听一个特定的对象。</strong></p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mi"><img src="../Images/2019ed853ca665e7326e4e2844a8b10b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cXGN1VJ1yM4WoDEWaJwOzg.png"/></div></div></figure><p id="3429" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">当这个对象的状态发生变化时，它会主动通知所有观察者对象，允许它们及时接收消息并执行相应的处理逻辑。</p><p id="316b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">观察者模式主要由以下四个角色组成:</p><ul class=""><li id="f258" class="mj mk iq ky b kz la lc ld lf ml lj mm ln mn lr mo mp mq mr bi translated"><code class="fe lt lu lv lw b">Subject</code>:抽象类或接口，包含添加观察器、移除观察器和通知观察器的方法；</li><li id="8142" class="mj mk iq ky b kz ms lc mt lf mu lj mv ln mw lr mo mp mq mr bi translated"><code class="fe lt lu lv lw b">Concrete Subject</code>:具体的subject类，实现抽象subject类或接口中定义的方法。</li><li id="5432" class="mj mk iq ky b kz ms lc mt lf mu lj mv ln mw lr mo mp mq mr bi translated"><code class="fe lt lu lv lw b">Observer</code>:抽象类或接口，一般包含接收更新的抽象方法，在特定主体发生变化时被调用；</li><li id="4dc9" class="mj mk iq ky b kz ms lc mt lf mu lj mv ln mw lr mo mp mq mr bi translated"><code class="fe lt lu lv lw b">Concrete Observer</code>:接收到更新后，实现抽象观察者中定义的抽象方法来处理具体的业务逻辑。</li></ul><p id="a661" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我将使用观察者模式来实现上面的价格下降提醒功能。首先，让我们重构<code class="fe lt lu lv lw b">Product</code>类，并提取原始<code class="fe lt lu lv lw b">Product</code>类中的所有逻辑:</p><pre class="kg kh ki kj gt lx lw ly bn lz ma bi"><span id="1884" class="mb mc iq lw b be md me l mf mg">class Product {<br/>  constructor(pid, name, price) {<br/>    this.pid = pid;<br/>    this.name = name;<br/>    this.price = price;<br/>  }<br/>}</span></pre><p id="58dc" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">然后，我们定义了<code class="fe lt lu lv lw b">User</code>类(具体的观察者)，它包含一个用于接收价格下跌通知的<code class="fe lt lu lv lw b">notify</code>方法。</p><pre class="kg kh ki kj gt lx lw ly bn lz ma bi"><span id="4f10" class="mb mc iq lw b be md me l mf mg">class User {<br/>  constructor(uid, name) {<br/>    this.uid = uid;<br/>    this.name = name;<br/>  }<br/><br/>  notify(product, price) {<br/>    console.log(<br/>      `Dear user ${this.uid},the product you are concerned about:<br/>        ${product.name},Price drop of $${product.price - price}.`<br/>    ); <br/>  }<br/>}</span></pre><p id="84a8" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">有了<code class="fe lt lu lv lw b">User</code>类之后，再定义<code class="fe lt lu lv lw b">ProductSubject</code>(具体科目)类。该类包含添加观察器、移除观察器和通知观察器的三种方法:</p><pre class="kg kh ki kj gt lx lw ly bn lz ma bi"><span id="0d45" class="mb mc iq lw b be md me l mf mg">class ProductSubject  {<br/>   observers = [];<br/><br/>  constructor(pid) {<br/>    this.pid = pid;<br/>  }<br/><br/>  addObserver(observer) {<br/>    this.observers.push(observer);<br/>  }<br/><br/>  deleteObserver(observer) {<br/>    const n = this.observers.indexOf(observer);<br/>    n != -1 &amp;&amp; this.observers.splice(n, 1);<br/>  }<br/><br/>  notifyObservers(product, price) {<br/>    this.observers.forEach((observer) =&gt; observer.notify(product, price));<br/>  }<br/>}</span></pre><p id="29dd" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">接下来，我们来验证一下重构后的产品降价提醒的功能:</p><pre class="kg kh ki kj gt lx lw ly bn lz ma bi"><span id="55b5" class="mb mc iq lw b be md me l mf mg">const laptop = new Product("A001", "Notebook", 999);<br/>const productSubject = new ProductSubject(laptop.pid);<br/>const u001 = new User("U001", "Bytefer");<br/>const u002 = new User("U002", "Semlinker");<br/>productSubject.addObserver(u001);<br/>productSubject.addObserver(u002);<br/><br/>productSubject.notifyObservers(laptop, 899);</span></pre><p id="46ff" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">当上述代码成功运行时，控制台将输出以下结果:</p><pre class="kg kh ki kj gt lx lw ly bn lz ma bi"><span id="1dfe" class="mb mc iq lw b be md me l mh mg">Dear user U001,the product you are concerned about:<br/>        Notebook,Price drop of $100.<br/>Dear user U002,the product you are concerned about:<br/>        Notebook,Price drop of $100.</span></pre><p id="451f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在前端领域，观察者模式是一种非常常见的设计模式。比如在<code class="fe lt lu lv lw b"><a class="ae kv" href="https://developer.mozilla.org/en-US/docs/Web/API/MutationObserver" rel="noopener ugc nofollow" target="_blank"><strong class="ky ir">MutationObserver</strong></a></code>、<code class="fe lt lu lv lw b"><a class="ae kv" href="https://developer.mozilla.org/en-US/docs/Web/API/IntersectionObserver" rel="noopener ugc nofollow" target="_blank"><strong class="ky ir">IntersectionObserver</strong></a></code>、<code class="fe lt lu lv lw b"><a class="ae kv" href="https://developer.mozilla.org/en-US/docs/Web/API/PerformanceObserver" rel="noopener ugc nofollow" target="_blank"><strong class="ky ir">PerformanceObserver</strong></a></code>、<code class="fe lt lu lv lw b"><a class="ae kv" href="https://developer.mozilla.org/en-US/docs/Web/API/ResizeObserver" rel="noopener ugc nofollow" target="_blank"><strong class="ky ir">ResizeObserver</strong></a></code>、<code class="fe lt lu lv lw b"><a class="ae kv" href="https://developer.mozilla.org/en-US/docs/Web/API/ReportingObserver/ReportingObserver" rel="noopener ugc nofollow" target="_blank"><strong class="ky ir">ReportingObserver</strong></a></code>中可以看到观察者模式，都是Web APIs。此外，观察者模式还用于事件监听和数据响应(例如，当数据改变时自动更新页面)。</p><p id="f8c1" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">要实现页面自动更新，需要满足两个条件:<strong class="ky ir">一是能够实现精准更新，二是能够检测到数据变化。</strong>为了实现准确的更新，需要收集对数据变化感兴趣的更新函数(观察者)。在收集完成之后，当检测到数据改变时，可以通知相应的更新功能。</p><p id="c391" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">上面的描述可能很难理解，其实要实现自动更新，我们就是要让(1)创建一个subject object，(2)添加一个observer，(3)通知observer这三个步骤实现自动化，这是实现responsive的核心思想。接下来，为了方便你理解上面的内容，我来画个图。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mx"><img src="../Images/d9a83853d2fa27162f64d082438edb62.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*SU4q81e-jpnW0_nPCdPbkw.png"/></div></div></figure><p id="40e5" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如果你了解Vue2的数据响应原理，你就会熟悉上图中的代码，第二步也叫收集依赖关系。通过使用<code class="fe lt lu lv lw b"><a class="ae kv" href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object/defineProperty" rel="noopener ugc nofollow" target="_blank"><strong class="ky ir">Object.defineProperty</strong></a></code> API，我们可以拦截对数据的读取和修改操作。</p><p id="5156" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如果在函数体中读取了某些数据，则意味着该函数对数据的变化感兴趣。当读取数据时，会触发定义的<code class="fe lt lu lv lw b">getter</code>函数，此时可以存储数据的观察者。当数据发生变化时，我们可以通知观察者列表中的所有观察者进行相应的更新操作。</p><p id="25a6" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">好了，观察者模式到此为止。对于使用过Vue的开发者，如果有兴趣，可以回顾一下Vue2数据响应相关的代码。</p><p id="d9b5" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">稍后我会继续介绍其他模式，如果你有兴趣，可以关注我的<a class="ae kv" href="https://medium.com/@bytefer" rel="noopener">媒体</a>或<a class="ae kv" href="https://twitter.com/Tbytefer" rel="noopener ugc nofollow" target="_blank">推特</a>。</p></div><div class="ab cl my mz hu na" role="separator"><span class="nb bw bk nc nd ne"/><span class="nb bw bk nc nd ne"/><span class="nb bw bk nc nd"/></div><div class="ij ik il im in"><p id="bbec" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">想学习打字稿，千万不要错过<strong class="ky ir">掌握打字稿</strong>系列。</p><div class="nf ng gp gr nh ni"><a href="https://medium.com/frontend-canteen/with-these-articles-you-will-not-be-confused-when-learning-typescript-d96a5c99e229" rel="noopener follow" target="_blank"><div class="nj ab fo"><div class="nk ab nl cl cj nm"><h2 class="bd ir gy z fp nn fr fs no fu fw ip bi translated">有了40+篇文章，学习TypeScript就不会迷茫了</h2><div class="np l"><h3 class="bd b gy z fp nn fr fs no fu fw dk translated">通过生动的动画，让你轻松了解TypeScript的难点和核心知识！不断地…</h3></div><div class="nq l"><p class="bd b dl z fp nn fr fs no fu fw dk translated">medium.com</p></div></div><div class="nr l"><div class="ns l nt nu nv nr nw kp ni"/></div></div></a></div><p id="0fa5" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><em class="nx">更多内容请看</em><a class="ae kv" href="https://plainenglish.io/" rel="noopener ugc nofollow" target="_blank"><strong class="ky ir"><em class="nx">plain English . io</em></strong></a><em class="nx">。报名参加我们的</em> <a class="ae kv" href="http://newsletter.plainenglish.io/" rel="noopener ugc nofollow" target="_blank"> <strong class="ky ir"> <em class="nx">免费周报</em> </strong> </a> <em class="nx">。关注我们关于</em><a class="ae kv" href="https://twitter.com/inPlainEngHQ" rel="noopener ugc nofollow" target="_blank"><strong class="ky ir"><em class="nx">Twitter</em></strong></a><a class="ae kv" href="https://www.linkedin.com/company/inplainenglish/" rel="noopener ugc nofollow" target="_blank"><strong class="ky ir"><em class="nx">LinkedIn</em></strong></a><em class="nx"/><a class="ae kv" href="https://www.youtube.com/channel/UCtipWUghju290NWcn8jhyAw" rel="noopener ugc nofollow" target="_blank"><strong class="ky ir"><em class="nx">YouTube</em></strong></a><em class="nx"/><a class="ae kv" href="https://discord.gg/GtDtUAvyhW" rel="noopener ugc nofollow" target="_blank"><strong class="ky ir"><em class="nx">不和</em> </strong> </a> <strong class="ky ir"> <em class="nx">。</em>T49】</strong></p><p id="a719" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir"> <em class="nx">对缩放您的软件启动感兴趣</em> </strong> <em class="nx">？检查</em> <a class="ae kv" href="https://circuit.ooo/?utm=publication-post-cta" rel="noopener ugc nofollow" target="_blank"> <strong class="ky ir"> <em class="nx">电路</em> </strong> </a> <em class="nx">。</em></p></div></div>    
</body>
</html>