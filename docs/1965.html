<html>
<head>
<title>Will Running JavaScript in the Browser Block Rendering?</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在浏览器中运行JavaScript会阻碍渲染吗？</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/will-running-javascript-in-the-browser-block-rendering-3e963bb1d2dd?source=collection_archive---------12-----------------------#2022-05-03">https://javascript.plainenglish.io/will-running-javascript-in-the-browser-block-rendering-3e963bb1d2dd?source=collection_archive---------12-----------------------#2022-05-03</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="3f0b" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">浏览器里这个确定吗？</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/948084a1ad4bc4bb83a95ff72dbc8889.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*iCFmEdNvTIlfY0TS"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk">Photo by <a class="ae kv" href="https://unsplash.com/@acfb5071?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Keith Johnston</a> on <a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="5666" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在浏览器中运行JavaScript一定会阻碍网页的渲染吗？</p><p id="80f5" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">你大概知道答案，但这篇文章会从根源上给你解释。</p></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><p id="bf14" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们打开Chrome DevTools的性能面板来记录:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi lz"><img src="../Images/1f152daf4668812b86feb508031e292e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gTVx3FwaP_4g0m1_t4ay6A.png"/></div></div></figure><p id="7921" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们先看左边:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi ma"><img src="../Images/8257914bcfdd6610fa3f5a62c46741fc.png" data-original-src="https://miro.medium.com/v2/resize:fit:714/format:webp/1*b4YcR-NSPGdEBEfljOenWw.png"/></div></figure><p id="963b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">网络:记录网络请求相关内容</p><p id="133c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">帧:显示特定帧的FPS</p><p id="131f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">Main: <strong class="ky ir">记录渲染过程主线程的任务</strong></p><p id="2732" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">光栅:记录光栅化器线程池任务</p><p id="9c4f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">GPU:记录GPU复合位图的任务</p><p id="b3f1" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">Chrome_ChildIOThread:记录对应的IO线程任务记录。例如联网、用户输入、与设备相关的任务等。</p><p id="e63d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">合成器:记录合成线程的任务执行情况</p><p id="b250" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这里我们重点分析主要的:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mb"><img src="../Images/b17b3a906f315ee83074adb30db86744.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fo4pp7xCCf2rzH1tMJdAxw.png"/></div></div></figure><p id="1bc8" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这些灰色块中的每一个都是独立的任务。然后缩小范围，将HTML解析为First Paint(FP):</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mc"><img src="../Images/4afc5b1dd5bd483fa44f382a89345185.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*df_mmZwKv-px7ntWwUPdVQ.png"/></div></div></figure><div class="kg kh ki kj gt ab cb"><figure class="md kk me mf mg mh mi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><img src="../Images/73a4e187fe2228ae52cd9cd35f644311.png" data-original-src="https://miro.medium.com/v2/resize:fit:1026/format:webp/1*LfFvOffXVAXSwVc_x85gFA.png"/></div></figure><figure class="md kk mj mf mg mh mi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><img src="../Images/df30824860f5ee65f6c22fa208a18d95.png" data-original-src="https://miro.medium.com/v2/resize:fit:976/format:webp/1*bVQvbMtVWN8mjHQaolj5uQ.png"/></div></figure></div><p id="ccc7" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">让我简单解释一下:</p><p id="28e0" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">解析HTML:将HTML文本转换成内存中的DOM树。解析到脚本后，就会执行，也就是评估脚本。这大大延长了解析HTML的时间。在这里，我们可以将async或defer添加到脚本标签中进行优化。</p><p id="459a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">重算样式:分析解析样式，输出为<a class="ae kv" href="https://developer.mozilla.org/en-US/docs/Web/API/Document/styleSheets" rel="noopener ugc nofollow" target="_blank">文档.样式表</a></p><p id="9e13" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">布局:根据样式计算每个节点的布局位置，去掉那些没有显示的节点(<code class="fe mk ml mm mn b">display: none</code>)</p><p id="77c1" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">更新层树:根据浏览器的堆叠规则形成层</p><p id="7c7c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">画图:生成画图指令传递给<strong class="ky ir">合成线程</strong></p><p id="d50b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">合成线程收到画图指令后，将负责后续的画图工作。生成的图像将显示在我们的屏幕上。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mo"><img src="../Images/1afc17e76f4e4b1568768367ee7493b9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wv7H6m0TIa2pS39l2tac4Q.png"/></div></div></figure><p id="db40" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这里我们可以看到最终的画图交给了合成线程，而不是负责JavaScript执行的主线程。那么是否可以得出JavaScript的执行不影响网页渲染的结论呢？</p><p id="9f6b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">不会。因为合成线程只有在收到绘制命令时才会工作。绘图指令由主线程中的Paint任务生成。所以一旦JavaScript执行时间过长，那么画图任务就会延迟。</p><p id="5b87" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">当显示器的刷新率为60FPS时，相当于每16.6ms生成一个新画面，这也叫帧。如果在一帧内没有及时执行绘画任务，将不会生成新的图片，因此用户看到的是前一帧的图片。如果多帧丢失，用户将会遇到口吃。</p><p id="f51f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">下面是一个简单的例子，你可以切换复选框来直观地感受页面的口吃:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mp mq l"/></div></figure><p id="e63a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我在本地记录了较短的目标值<code class="fe mk ml mm mn b">1_000_0</code>。可以看出，JavaScript的执行占用了主线程很长时间，画图任务只有完成后才能执行。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi mr"><img src="../Images/1235ba9677be8a4c5d5d62b4b374c50a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1390/format:webp/1*IJ3KNCXF3OC_-y9Jzy3n0Q.png"/></div></figure><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ms"><img src="../Images/c44acdb43461c962201897a5db3fe632.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rVZH9OP9ygX-HdraU-gHKA.png"/></div></div></figure><p id="ea27" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">所以执行JavaScript会阻塞网页的呈现，因为它们都是在主线程上处理的。同样，一旦JavaScript的执行时间过长，渲染相关的任务也无法及时执行。还会有掉帧，用户会有卡顿感。</p></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><p id="942e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><em class="mt">今天就到这里。我是Zachary，我将继续输出与web开发相关的故事。如果你喜欢这样的故事，想支持我，请考虑成为</em> <a class="ae kv" href="https://medium.com/@islizeqiang/membership" rel="noopener"> <em class="mt">中等会员</em> </a> <em class="mt">。每月5美元，你可以无限制地访问媒体内容。如果你通过</em> <a class="ae kv" href="https://medium.com/@islizeqiang/membership" rel="noopener"> <em class="mt">我的链接</em> </a> <em class="mt">报名，我会得到一点佣金。</em></p><p id="f3f0" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">你的支持对我来说非常重要——谢谢。</p><p id="0ea3" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><em class="mt">更多内容看</em> <a class="ae kv" href="https://plainenglish.io/" rel="noopener ugc nofollow" target="_blank"> <strong class="ky ir"> <em class="mt">说白了就是</em> </strong> </a> <em class="mt">。报名参加我们的</em> <a class="ae kv" href="http://newsletter.plainenglish.io/" rel="noopener ugc nofollow" target="_blank"> <strong class="ky ir"> <em class="mt">免费每周简讯</em> </strong> </a> <em class="mt">。关注我们</em> <a class="ae kv" href="https://twitter.com/inPlainEngHQ" rel="noopener ugc nofollow" target="_blank"> <strong class="ky ir"> <em class="mt">推特</em> </strong> </a> <em class="mt">和</em><a class="ae kv" href="https://www.linkedin.com/company/inplainenglish/" rel="noopener ugc nofollow" target="_blank"><strong class="ky ir"><em class="mt">LinkedIn</em></strong></a><em class="mt">。加入我们的</em> <a class="ae kv" href="https://discord.gg/GtDtUAvyhW" rel="noopener ugc nofollow" target="_blank"> <strong class="ky ir"> <em class="mt">社区不和谐</em> </strong> </a> <em class="mt">。</em></p></div></div>    
</body>
</html>