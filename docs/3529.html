<html>
<head>
<title>Resizing &amp; Adding Watermark on Images with Node.js and Sharp-Multer</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用Node.js和Sharp-Multer在图像上调整大小和添加水印</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/resizing-adding-watermark-on-images-with-nodejs-and-sharp-multer-e86fb4ee8ad8?source=collection_archive---------9-----------------------#2022-09-05">https://javascript.plainenglish.io/resizing-adding-watermark-on-images-with-nodejs-and-sharp-multer-e86fb4ee8ad8?source=collection_archive---------9-----------------------#2022-09-05</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><figure class="gl gn jl jm jn jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi jk"><img src="../Images/28032ebfb284daef690a14a06b8a08ee.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PRZ8Pc24tyrko_xn9NqISA.png"/></div></div></figure><h1 id="a654" class="jv jw in bd jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks bi translated">动机:</h1><p id="a944" class="pw-post-body-paragraph kt ku in kv b kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq ig bi translated">每当我们开始上传图片时，调整大小是第一位的，通常我们还需要添加水印。</p><p id="cff8" class="pw-post-body-paragraph kt ku in kv b kw lr ky kz la ls lc ld le lt lg lh li lu lk ll lm lv lo lp lq ig bi translated">在上一篇<a class="ae lw" href="https://dev.to/ranjan/simple-node-js-resize-image-before-upload-using-sharp-multer-p8c" rel="noopener ugc nofollow" target="_blank">文章</a>中，我们学习了如何用<a class="ae lw" href="https://www.npmjs.com/package/sharp-multer" rel="noopener ugc nofollow" target="_blank">锐化工具</a>设置图像的基本尺寸调整和优化。在这里，我们将添加先进的调整大小和添加水印到所有上传的图像。</p><h1 id="5960" class="jv jw in bd jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks bi translated">先决条件:</h1><p id="c5e6" class="pw-post-body-paragraph kt ku in kv b kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq ig bi translated">请在此阅读本系列的<a class="ae lw" href="https://dev.to/ranjan/simple-node-js-resize-image-before-upload-using-sharp-multer-p8c" rel="noopener ugc nofollow" target="_blank">第1部分</a>。</p><h1 id="7a3f" class="jv jw in bd jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks bi translated">设置和配置:</h1><p id="6f58" class="pw-post-body-paragraph kt ku in kv b kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq ig bi translated">在上一部分中，我们设置了一个简单的Node.js应用程序，这些文件包含以下代码:</p><h1 id="5b04" class="jv jw in bd jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks bi translated">Server.js</h1><pre class="lx ly lz ma gt mb mc md me aw mf bi"><span id="e2ef" class="mg jw in mc b gy mh mi l mj mk">const express = require("express");<br/>const path = require("path");<br/>const multer = require("multer");<br/>const SharpMulter = require("sharp-multer");<br/>const app = express();</span><span id="090e" class="mg jw in mc b gy ml mi l mj mk">const storage = SharpMulter({<br/>  destination: (req, file, callback) =&gt; callback(null, "images"),<br/>  imageOptions: {<br/>    fileFormat: "png",<br/>    quality: 80,<br/>    resize: { width: 500, height: 500 },<br/>  }<br/>});<br/>const upload = multer({ storage });</span><span id="fd61" class="mg jw in mc b gy ml mi l mj mk">app.post("/upload", upload.single("avatar"), async (req, res) =&gt; {<br/>  console.log(req.file);<br/>  return res.json("File Uploaded Successfully!");<br/>});<br/>app.get("/", function (req, res) {<br/>  res.sendFile(path.join(__dirname, "/index.html"));<br/>});</span><span id="2852" class="mg jw in mc b gy ml mi l mj mk">app.listen(3000, () =&gt; {<br/>  console.log(`Server is running on port ${3000}`);<br/>});</span></pre><h1 id="eb05" class="jv jw in bd jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks bi translated">index.html</h1><pre class="lx ly lz ma gt mb mc md me aw mf bi"><span id="4d8f" class="mg jw in mc b gy mh mi l mj mk">&lt;!DOCTYPE html&gt;<br/>&lt;html lang="en"&gt;<br/>&lt;head&gt;<br/>    &lt;meta charset="UTF-8"&gt;<br/>    &lt;meta http-equiv="X-UA-Compatible" content="IE=edge"&gt;<br/>    &lt;meta name="viewport" content="width=device-width, initial-scale=1.0"&gt; <br/>    &lt;title&gt;File Upload&lt;/title&gt;<br/>&lt;/head&gt;<br/>&lt;body&gt;<br/>    &lt;div class="container"&gt;<br/>        &lt;h1&gt;File Upload&lt;/h1&gt;<br/>&lt;!--Create a form to send the file to a route  "upload"--&gt;<br/>&lt;!--Set the request method to POST--&gt;<br/>&lt;!--Set the encytype to "multipart/form-data" in order to send files and not just text--&gt;<br/>        &lt;form action="/upload" method="POST" enctype="multipart/form-data"&gt;<br/>            &lt;div class="file-field input-field"&gt;<br/>              &lt;div class="btn grey"&gt;<br/>                &lt;input type="file" name="avatar"&gt;<br/>              &lt;/div&gt;<br/>            &lt;/div&gt;<br/>            &lt;button class="btn" type="submit"&gt;Submit&lt;/button&gt;<br/>          &lt;/form&gt;<br/>    &lt;/div&gt;<br/>&lt;/body&gt;<br/>&lt;/html&gt;</span></pre><p id="3dfe" class="pw-post-body-paragraph kt ku in kv b kw lr ky kz la ls lc ld le lt lg lh li lu lk ll lm lv lo lp lq ig bi translated">我们已经有了基本的尺寸调整和优化，但是现在有了<code class="fe mm mn mo mc b">sharp-multer 0.2.1</code>，我们有了一些高级的尺寸调整选项。我们现在可以定义图像使用哪种大小调整模式。</p><h1 id="920c" class="jv jw in bd jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks bi translated">尺寸模式</h1><blockquote class="mp mq mr"><p id="e16b" class="kt ku ms kv b kw lr ky kz la ls lc ld mt lt lg lh mu lu lk ll mv lv lo lp lq ig bi translated"><em class="in"> resize.resizeMode </em></p></blockquote><ul class=""><li id="93bd" class="mw mx in kv b kw lr la ls le my li mz lm na lq nb nc nd ne bi translated"><code class="fe mm mn mo mc b">cover</code>:(默认)保留纵横比，通过裁剪/剪裁来确保图像覆盖提供的两个尺寸。</li><li id="9dca" class="mw mx in kv b kw nf la ng le nh li ni lm nj lq nb nc nd ne bi translated"><code class="fe mm mn mo mc b">contain</code>:保留纵横比，包含在两个提供的尺寸中，必要时使用“信箱模式”。</li><li id="ff52" class="mw mx in kv b kw nf la ng le nh li ni lm nj lq nb nc nd ne bi translated"><code class="fe mm mn mo mc b">fill</code>:忽略输入的长宽比，拉伸到两个提供的尺寸。<em class="ms">即图像将被拉伸以匹配所提供的尺寸</em></li><li id="383f" class="mw mx in kv b kw nf la ng le nh li ni lm nj lq nb nc nd ne bi translated"><code class="fe mm mn mo mc b">inside</code>:保持纵横比，在保证图像尺寸小于或等于指定尺寸的情况下，尽可能放大图像。<em class="ms">即宽度将固定为您提供的最大值，而高度将根据纵横比</em>调整为比提供的值更低的值。</li><li id="d277" class="mw mx in kv b kw nf la ng le nh li ni lm nj lq nb nc nd ne bi translated"><code class="fe mm mn mo mc b">outside</code>:保持宽高比，在保证图像尺寸大于或等于指定尺寸的情况下，尽可能缩小图像尺寸。<em class="ms">即高度将固定为您提供的值，宽度将根据长宽比调整为比提供的值更高的值。</em></li></ul><p id="707c" class="pw-post-body-paragraph kt ku in kv b kw lr ky kz la ls lc ld le lt lg lh li lu lk ll lm lv lo lp lq ig bi translated">要使用它，我们需要在imageOptions resize对象中提供resizeMode键，例如:</p><pre class="lx ly lz ma gt mb mc md me aw mf bi"><span id="afe3" class="mg jw in mc b gy mh mi l mj mk">imageOptions: {<br/>    fileFormat: "png",<br/>    quality: 80,<br/>    resize: { width: 500, height: 500, resizeMode: "outside" },<br/>  }</span></pre><h1 id="df05" class="jv jw in bd jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks bi translated">添加水印</h1><p id="d528" class="pw-post-body-paragraph kt ku in kv b kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq ig bi translated">使用新的sharp-multer，添加水印非常容易。我们可以只提供输入图像路径和我们想要放置水印的位置。<br/>目前我们可以在这些位置放置水印:<code class="fe mm mn mo mc b">"center","top-left","top-right","bottom-left","bottom-right"</code>。因此，为了添加水印，我们的存储配置将如下所示:</p><pre class="lx ly lz ma gt mb mc md me aw mf bi"><span id="3f96" class="mg jw in mc b gy mh mi l mj mk">const storage = SharpMulter({<br/>  destination: (req, file, callback) =&gt; callback(null, "images"),<br/>  imageOptions: {<br/>    fileFormat: "png",<br/>    quality: 80,<br/>    resize: { width: 500, height: 500, resizeMode: "outside" },<br/>  },<br/>  watermarkOptions: {<br/>    input: "./images/logo.png", // watermark image location<br/>    location: "top-right",<br/>  },<br/>});</span></pre><p id="bbd8" class="pw-post-body-paragraph kt ku in kv b kw lr ky kz la ls lc ld le lt lg lh li lu lk ll lm lv lo lp lq ig bi translated">你可以在这个<a class="ae lw" href="https://github.com/ranjandsingh/image-upload-resize-test.git" rel="noopener ugc nofollow" target="_blank">回购</a>里找到完整的代码。试试看，玩得开心。干杯！</p><p id="fd88" class="pw-post-body-paragraph kt ku in kv b kw lr ky kz la ls lc ld le lt lg lh li lu lk ll lm lv lo lp lq ig bi translated"><em class="ms">更多内容看</em> <a class="ae lw" href="https://plainenglish.io/" rel="noopener ugc nofollow" target="_blank"> <strong class="kv io"> <em class="ms">说白了。报名参加我们的</em> <a class="ae lw" href="http://newsletter.plainenglish.io/" rel="noopener ugc nofollow" target="_blank"> <strong class="kv io"> <em class="ms">免费周报</em> </strong> </a> <em class="ms">。关注我们关于</em> <a class="ae lw" href="https://twitter.com/inPlainEngHQ" rel="noopener ugc nofollow" target="_blank"> <strong class="kv io"> <em class="ms">推特</em></strong></a><a class="ae lw" href="https://www.linkedin.com/company/inplainenglish/" rel="noopener ugc nofollow" target="_blank"><strong class="kv io"><em class="ms">LinkedIn</em></strong></a><em class="ms"/><a class="ae lw" href="https://www.youtube.com/channel/UCtipWUghju290NWcn8jhyAw" rel="noopener ugc nofollow" target="_blank"><strong class="kv io"><em class="ms">YouTube</em></strong></a><em class="ms"/><a class="ae lw" href="https://discord.gg/GtDtUAvyhW" rel="noopener ugc nofollow" target="_blank"><strong class="kv io"><em class="ms">不和</em> </strong> </a> <em class="ms">。</em></strong></a></p></div></div>    
</body>
</html>