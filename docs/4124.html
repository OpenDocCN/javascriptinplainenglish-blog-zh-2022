<html>
<head>
<title>Let’s Understand Chrome V8: How Does the Ignition Work</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">让我们来了解一下Chrome V8:点火是如何工作的</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/lets-understand-chrome-v8-how-does-the-ignition-work-fb79aae6757f?source=collection_archive---------4-----------------------#2022-10-27">https://javascript.plainenglish.io/lets-understand-chrome-v8-how-does-the-ignition-work-fb79aae6757f?source=collection_archive---------4-----------------------#2022-10-27</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><div class=""><h2 id="dfe0" class="pw-subtitle-paragraph jk im in bd b jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb dk translated">第30章:加载JSfunction并执行字节码</h2></div><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi kc"><img src="../Images/2229cb027639f57877eb360bf75cd927.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yCFNVeb4ds9hl7WF-NP-kw.png"/></div></div></figure><p id="d277" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated"><em class="lk">欢迎阅读</em> <a class="ae ll" href="https://medium.com/@huidou" rel="noopener"> <em class="lk">其他章节让我们来了解一下Chrome V8 </em> </a></p><p id="1e91" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">在本文中，我将讨论ignition，并让您了解它是如何工作的，它如何加载JSfunction，以及它在执行之前会做什么。</p><h1 id="0d66" class="lm ln in bd lo lp lq lr ls lt lu lv lw jt lx ju ly jw lz jx ma jz mb ka mc md bi translated"><strong class="ak"> 1。调用JSfunction </strong></h1><p id="a9a5" class="pw-post-body-paragraph ko kp in kq b kr me jo kt ku mf jr kw kx mg kz la lb mh ld le lf mi lh li lj ig bi translated">对于V8解释器，所有这些都从加载JSfunction(V8术语是invoke)开始，因为它有一个字节码数组。下面是调用函数。</p><figure class="kd ke kf kg gt kh"><div class="bz fp l di"><div class="mj mk l"/></div></figure><p id="f94b" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">在调用JSfunction之前，V8将它包装到invoke-params中，但不会添加其他新内容，所以我们不关心它，但要记住哪个成员是其中的JSfcuntion。我把重要的内容列在下面。</p><p id="5d00" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated"><strong class="kq io"> (1) </strong>第1–13行，SetupForCall()就是我提到的包装函数。</p><p id="b12e" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated"><strong class="kq io"> (2) </strong>第17行，代码是Builtin::kJSEntry函数地址。</p><p id="cc79" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated"><strong class="kq io"> (3) </strong>第24行，stub_entry是Builtin::kJSEntry的第一条指令。</p><p id="6ad6" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated"><strong class="kq io"> (4) </strong>第27行，func是一个将执行的JSfunction。</p><p id="25a0" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated"><strong class="kq io"> (5) </strong>第31行，存根_分录。调用开始进入点火状态以执行您的JavaScript。<strong class="kq io">注意:</strong>现在您的JavaScript还没有被调用，因为Ignition正在创建调用堆栈，然后会跳转到您的代码中。</p><h1 id="5072" class="lm ln in bd lo lp lq lr ls lt lu lv lw jt lx ju ly jw lz jx ma jz mb ka mc md bi translated"><strong class="ak"> 2。Builtin::kJSEntry </strong></h1><p id="d22b" class="pw-post-body-paragraph ko kp in kq b kr me jo kt ku mf jr kw kx mg kz la lb mh ld le lf mi lh li lj ig bi translated">在讲Builtin::kJSEntry之前，我想强调一下JSFunction的一些成员，这个函数经常用在Ignition中。</p><p id="7898" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated"><strong class="kq io"> (1) SharedFunction </strong>，是JSFunction的成员，我们需要知道的关键是SharedFunction有点火将执行的字节码数组。</p><p id="3b5c" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated"><strong class="kq io"> (2) </strong> <strong class="kq io">代码</strong>，是Builtins::kinterpetertentrytrampoline。</p><p id="f4d6" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated"><strong class="kq io"> (3) </strong> <strong class="kq io">上下文</strong>，是当前运行时对应的上下文。</p><p id="6658" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">让我们进入内置::kJSEntry。</p><figure class="kd ke kf kg gt kh"><div class="bz fp l di"><div class="mj mk l"/></div></figure><p id="c092" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">在上面的代码中，第2行调用Generate_JSEntryVariant()，它的第三个参数是最终调用我们的字节码的trampoline。</p><p id="8a5f" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">第15行，arg_reg_1表示isolate-&gt; isolate _ data()-&gt; isolate_root()，我之所以强调它，是因为isolate _ root()包含所有必要的东西，如builtins和heap，所有这些对运行时都很有用。</p><p id="35b3" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">第17–22行，将顶部的帧推入堆栈，就像我们在X86中所做的一样。</p><p id="6381" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">第24–26行，将当前上下文加载到ScratchRegister中。</p><p id="1c49" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">第46–48行，exectue JSEntryTrampoline。</p><h1 id="1a2c" class="lm ln in bd lo lp lq lr ls lt lu lv lw jt lx ju ly jw lz jx ma jz mb ka mc md bi translated"><strong class="ak"> 3。内置::kJSEntryTrampoline </strong></h1><figure class="kd ke kf kg gt kh"><div class="bz fp l di"><div class="mj mk l"/></div></figure><p id="d99c" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">在上面的代码中，第7–28行将参数推入堆栈，其中参数函数是来自JavaScript的字节码。第40–49行，注释描述了堆栈框架布局。第53行，获取builtin地址，即Builtin::kCall_ReceiverIsAny。</p><h1 id="fdda" class="lm ln in bd lo lp lq lr ls lt lu lv lw jt lx ju ly jw lz jx ma jz mb ka mc md bi translated"><strong class="ak"> 4。builtin::kCall _ receive risany</strong></h1><figure class="kd ke kf kg gt kh"><div class="bz fp l di"><div class="mj mk l"/></div></figure><p id="171e" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">在上面的代码中，第13行，<em class="lk"> rdi </em>是正在执行的JSFunction，<em class="lk"> rcx </em>是它的map。一般情况下，CmpObjectType为true，跳转到第14行，最后调用kCallFunction _ ReceiverIsAny。</p><h1 id="ad2f" class="lm ln in bd lo lp lq lr ls lt lu lv lw jt lx ju ly jw lz jx ma jz mb ka mc md bi translated"><strong class="ak"> 5。builtin::kCallFunction _ receive risany</strong></h1><figure class="kd ke kf kg gt kh"><div class="bz fp l di"><div class="mj mk l"/></div></figure><p id="8e23" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">在上面的代码中，第7–19行将参数压入堆栈，<em class="lk"> rax </em>寄存器对于确保JavaScript参数始终匹配至关重要，因为如果参数丢失，V8会填充一个Null，或者V8会丢弃多余的参数。第10-14行，<em class="lk"> rdi </em>是js函数，<em class="lk"> rdx </em>是它的shared函数。最后执行第20行。</p><h1 id="fa5b" class="lm ln in bd lo lp lq lr ls lt lu lv lw jt lx ju ly jw lz jx ma jz mb ka mc md bi translated"><strong class="ak"> 6。InvokeFunctionCode </strong></h1><figure class="kd ke kf kg gt kh"><div class="bz fp l di"><div class="mj mk l"/></div></figure><p id="1f85" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">在上面的代码中，第23行调用的是<em class="lk"> rcx </em>，而<em class="lk"> rcx </em>只是Builtins::kinterpetereentrytrampoline，这是我们的JavaScript的序言。换句话说，如果您想知道JavaScript是如何执行的，从这里开始调试是最简单的方法。</p><p id="7654" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">以下描述来自v8.dev。</p><p id="5857" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">当在运行时调用该函数时，会进入InterpreterEntryTrampoline存根。这个存根设置了一个适当的堆栈框架，然后分派给解释器的字节码处理程序，处理函数的第一个字节码，以便在解释器中开始执行函数。基于字节码，每个字节码处理程序的末尾通过全局解释器表的索引直接分派到下一个处理程序。”</p><p id="aadc" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">好了，这部分就到此为止了。下次再见，保重！</p><p id="f847" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">如果你有任何问题，请联系我。<strong class="kq io">微信</strong> : qq9123013 <strong class="kq io">邮箱</strong>:<a class="ae ll" href="mailto:v8blink@outlook.com" rel="noopener ugc nofollow" target="_blank">v8blink@outlook.com</a></p></div><div class="ab cl ml mm hr mn" role="separator"><span class="mo bw bk mp mq mr"/><span class="mo bw bk mp mq mr"/><span class="mo bw bk mp mq"/></div><div class="ig ih ii ij ik"><p id="5dbc" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated"><em class="lk">更多内容请看</em><a class="ae ll" href="https://plainenglish.io/" rel="noopener ugc nofollow" target="_blank"><strong class="kq io"><em class="lk">plain English . io</em></strong></a><em class="lk">。报名参加我们的</em> <a class="ae ll" href="http://newsletter.plainenglish.io/" rel="noopener ugc nofollow" target="_blank"> <strong class="kq io"> <em class="lk">免费周报</em> </strong> </a> <em class="lk">。关注我们关于</em><a class="ae ll" href="https://twitter.com/inPlainEngHQ" rel="noopener ugc nofollow" target="_blank"><strong class="kq io"><em class="lk">Twitter</em></strong></a><a class="ae ll" href="https://www.linkedin.com/company/inplainenglish/" rel="noopener ugc nofollow" target="_blank"><strong class="kq io"><em class="lk">LinkedIn</em></strong></a><em class="lk"/><a class="ae ll" href="https://www.youtube.com/channel/UCtipWUghju290NWcn8jhyAw" rel="noopener ugc nofollow" target="_blank"><strong class="kq io"><em class="lk">YouTube</em></strong></a><em class="lk"/><a class="ae ll" href="https://discord.gg/GtDtUAvyhW" rel="noopener ugc nofollow" target="_blank"><strong class="kq io"><em class="lk">不和</em> </strong> </a> <em class="lk">。对增长黑客感兴趣？检查</em> <a class="ae ll" href="https://circuit.ooo/" rel="noopener ugc nofollow" target="_blank"> <strong class="kq io"> <em class="lk">电路</em> </strong> </a> <em class="lk">。</em></p></div></div>    
</body>
</html>