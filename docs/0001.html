<html>
<head>
<title>Run Migrations Using Docker in Node.js and PostgreSQL</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Node.js和PostgreSQL中的Docker运行迁移</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/run-migrations-using-docker-in-node-and-pg-c6d80e7cd578?source=collection_archive---------0-----------------------#2022-01-01">https://javascript.plainenglish.io/run-migrations-using-docker-in-node-and-pg-c6d80e7cd578?source=collection_archive---------0-----------------------#2022-01-01</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><figure class="gl gn jl jm jn jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi jk"><img src="../Images/7e41a0ed744df3acae23d4d4faa128d7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*XNZPRXY53eNZyb4D"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk">Photo by <a class="ae jz" href="https://unsplash.com/@carrier_lost?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Ian Taylor</a> on <a class="ae jz" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="16b0" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">如今，Docker正成为创建任何类型的web应用程序的必备工具。它隔离你的应用程序，你可以在任何你需要的地方运行。</p><p id="fb82" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">如果你不熟悉docker，我会推荐以下链接，你可以从那里开始。</p><ul class=""><li id="7108" class="ky kz in kc b kd ke kh ki kl la kp lb kt lc kx ld le lf lg bi translated"><a class="ae jz" href="https://docs.docker.com/" rel="noopener ugc nofollow" target="_blank">https://docs.docker.com/</a></li><li id="6982" class="ky kz in kc b kd lh kh li kl lj kp lk kt ll kx ld le lf lg bi translated"><a class="ae jz" href="https://www.digitalocean.com/community/tutorials/getting-started-with-docker" rel="noopener ugc nofollow" target="_blank">https://www . digital ocean . com/community/tutorials/getting-started-with-docker</a></li><li id="3c95" class="ky kz in kc b kd lh kh li kl lj kp lk kt ll kx ld le lf lg bi translated"><a class="ae jz" href="https://docker-curriculum.com/" rel="noopener ugc nofollow" target="_blank">https://docker-curriculum.com/</a></li></ul><p id="78d3" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">你可以在docker上找到大量的其他资源，这是你应该知道的。我假设你至少对docker和docker-compose有初步的了解，你可以从这篇文章开始。</p><h1 id="e52f" class="lm ln in bd lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj bi translated">在开始之前</h1><p id="e45a" class="pw-post-body-paragraph ka kb in kc b kd mk kf kg kh ml kj kk kl mm kn ko kp mn kr ks kt mo kv kw kx ig bi translated">有些事情你应该明白，当运行任何容器时，都有一段时间容器需要花费时间来构建。在此之前，任何依赖于此的进程都需要暂停。</p><p id="25fc" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">在我们的例子中，我们应该等到数据库启动并连接了卷，然后只有我们能够运行我们的迁移，对吗？</p><p id="d13f" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">如果我具体说一下，那么在PostgreSQL中，当我们打开数据库容器时，下面是它执行的一些操作。</p><figure class="mq mr ms mt gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi mp"><img src="../Images/d9a47a767119a795026f38f8152dc369.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QkA2HXv7MB5Y04j_pCi7xA.png"/></div></div></figure><p id="9a93" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">您可以跳过这些内容，我只是想让您知道，即使数据库正在启动，也不意味着它在启动后就可用，所以您可能需要等待一段时间才能开始。</p><p id="b7e4" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">Bdw，如果你想跳过理论，可以从<a class="ae jz" href="https://github.com/Piyush-Use-Personal/migration-in-docker" rel="noopener ugc nofollow" target="_blank">这里</a>获取源代码。</p><h1 id="4655" class="lm ln in bd lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj bi translated">我们开始吧</h1><p id="9dd6" class="pw-post-body-paragraph ka kb in kc b kd mk kf kg kh ml kj kk kl mm kn ko kp mn kr ks kt mo kv kw kx ig bi translated">我将开门见山，您将有一个执行迁移的命令。在我的例子中，我有一个<code class="fe mu mv mw mx b">package.json</code>文件和一个名为<code class="fe mu mv mw mx b">npm run migrate</code>的命令，它将运行我所有的迁移。</p><p id="f808" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">现在让我们创建一个名为<code class="fe mu mv mw mx b">Dockerfile</code>的文件，并在那里放一些内容。</p><figure class="mq mr ms mt gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi my"><img src="../Images/f8812eb94d92820c8d71f72a6838617f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FGTBVGFT0iWjuRmH1CuaFg.png"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk">Dockerfile</figcaption></figure><p id="5a04" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">现在，让我们了解一下除了传统的Dockerfile文件之外，我们还写了什么。您将只看到一行</p><pre class="mq mr ms mt gt mz mx na nb aw nc bi"><span id="ff69" class="nd ln in mx b gy ne nf l ng nh">RUN git clone https://github.com/vishnubob/wait-for-it.git</span></pre><p id="b9e8" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">这将制作一个wait-it repo的克隆，并使用它的命令行方法来获得我们想要的东西。</p><blockquote class="ni nj nk"><p id="628e" class="ka kb nl kc b kd ke kf kg kh ki kj kk nm km kn ko nn kq kr ks no ku kv kw kx ig bi translated">你应该去看看github repo上正在运行的等待程序</p></blockquote><p id="5e10" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">除此之外，我们还在外部安装了一个额外的依赖项<code class="fe mu mv mw mx b">db-migrate-pg</code>，这是可选的，它是需要安装的包，所以以这种方式安装。</p><p id="b0cb" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">现在让我们再创建一个名为<code class="fe mu mv mw mx b">docker-compose.yml</code>的文件，它将处理我们的up、down、pull和build操作。首先，让我们了解一下结构。</p><p id="d6c8" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">我们将有3个应用程序:</p><ul class=""><li id="5e36" class="ky kz in kc b kd ke kh ki kl la kp lb kt lc kx ld le lf lg bi translated">数据库</li><li id="e7e2" class="ky kz in kc b kd lh kh li kl lj kp lk kt ll kx ld le lf lg bi translated">web(根据您的需要选择任何其他方式)</li><li id="9e19" class="ky kz in kc b kd lh kh li kl lj kp lk kt ll kx ld le lf lg bi translated">迁移(将迁移到您的项目)</li></ul><p id="ebe7" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">在这里，web和迁移都将依赖于数据库应用程序，在它运行后，它们将开始执行。</p><figure class="mq mr ms mt gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi np"><img src="../Images/3aa3e2aae1e0d1ff3cd59a8b95fcf865.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*m7ODWINXNU37X_EQgUjoiA.png"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk">docker-compose.yml</figcaption></figure><p id="f64b" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><strong class="kc io">数据库服务</strong></p><p id="7a20" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">我们从env获取值，并向它附加一个列，从它公开一个端口5432，这很残忍，因为我们需要照顾端口。</p><p id="df62" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><strong class="kc io">网络服务</strong></p><p id="ab60" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">让我们从<code class="fe mu mv mw mx b">Dockerfile</code>的上下文中构建它，并将卷和端口连接到它。如果您注意到，我们将主机公开为依赖于数据库服务的数据库应用程序名称。</p><p id="bea6" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><strong class="kc io">迁移</strong></p><p id="9666" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">该服务将类似于web服务，但是如果您看到的是一个有点不同的命令，它等待数据库在端口5432上启动，就像在数据库服务上公开它，然后运行迁移命令一样。</p><h1 id="a003" class="lm ln in bd lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj bi translated">最後的</h1><p id="1a09" class="pw-post-body-paragraph ka kb in kc b kd mk kf kg kh ml kj kk kl mm kn ko kp mn kr ks kt mo kv kw kx ig bi translated">为了测试一切是否正常，让write命令<code class="fe mu mv mw mx b">docker-compose up</code>首先构建映像，然后执行所有操作。以下是您可以在终端上看到的输出。</p><figure class="mq mr ms mt gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi nq"><img src="../Images/6ce7f22f25ec0fbefbb89fb885ee86b1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BqPEp-4P3ZpjnwDNybz6gg.png"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk">output</figcaption></figure><p id="038b" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">太好了！现在看来，这种方法非常有效。你可以在这里找到源代码<a class="ae jz" href="https://github.com/Piyush-Use-Personal/migration-in-docker" rel="noopener ugc nofollow" target="_blank">。</a></p><p id="ddda" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">我希望你今天学到了一些新东西；如果你喜欢我的内容，请考虑在这里订阅我的简讯<a class="ae jz" href="https://piyushdubey.substack.com/?r=omfzc&amp;utm_campaign=pub&amp;utm_medium=web" rel="noopener ugc nofollow" target="_blank"/>。</p><p id="a520" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">谢谢！</p><p id="160e" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><em class="nl">更多内容请看</em><a class="ae jz" href="http://plainenglish.io/" rel="noopener ugc nofollow" target="_blank"><em class="nl">plain English . io</em></a><em class="nl">。报名参加我们的</em> <a class="ae jz" href="http://newsletter.plainenglish.io/" rel="noopener ugc nofollow" target="_blank"> <em class="nl">免费周报</em> </a> <em class="nl">。在我们的</em> <a class="ae jz" href="https://discord.gg/GtDtUAvyhW" rel="noopener ugc nofollow" target="_blank"> <em class="nl">社区不和谐</em> </a> <em class="nl">获得独家获得写作机会和建议。</em></p></div></div>    
</body>
</html>