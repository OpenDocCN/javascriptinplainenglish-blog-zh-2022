<html>
<head>
<title>Learn the TCP/IP Protocol Suite And TCP Three Handshakes</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">学习TCP/IP协议族和TCP三握手</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/learn-the-tcp-ip-protocol-suite-and-tcp-three-handshakes-a4a0f56deb9c?source=collection_archive---------5-----------------------#2022-11-07">https://javascript.plainenglish.io/learn-the-tcp-ip-protocol-suite-and-tcp-three-handshakes-a4a0f56deb9c?source=collection_archive---------5-----------------------#2022-11-07</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/55b19779d0dfb06c8669a5f6acb0540f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rdQxuqTn2bK9fCfjcqzVZA.jpeg"/></div></div></figure><h1 id="26e3" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">TCP/IP协议族</h1><h2 id="77d0" class="kw jz iq bd ka kx ky dn ke kz la dp ki lb lc ld km le lf lg kq lh li lj ku lk bi translated">TCP/IP协议族的定义</h2><p id="56bc" class="pw-post-body-paragraph ll lm iq ln b lo lp lq lr ls lt lu lv lb lw lx ly le lz ma mb lh mc md me mf ij bi translated">TCP/IP是IP协议通信过程中使用的协议族的总称。换句话说，就是计算机与网络设备之间的通信协议规则。</p><p id="4b3b" class="pw-post-body-paragraph ll lm iq ln b lo mg lq lr ls mh lu lv lb mi lx ly le mj ma mb lh mk md me mf ij bi translated">计算机和网络设备必须以相同的方式相互通信。比如如何找到另一个通信设备，双方中哪一方发起通信，使用哪种语言进行通信等都要约定。否则就像两个人在不同的地方用不同的语言交流。双方都不知道对方的存在；即使他们明白，他们也不明白对方想表达什么。</p><h2 id="d7f8" class="kw jz iq bd ka kx ky dn ke kz la dp ki lb lc ld km le lf lg kq lh li lj ku lk bi translated">TCP/IP协议族的分层管理</h2><p id="6fc3" class="pw-post-body-paragraph ll lm iq ln b lo lp lq lr ls lt lu lv lb lw lx ly le lz ma mb lh mc md me mf ij bi translated">TCP/IP协议族分为四层:应用层、传输层、网络层和数据链路层。</p><figure class="mm mn mo mp gt jr gh gi paragraph-image"><div class="gh gi ml"><img src="../Images/544d0804e32550b075192c2dd42ca877.png" data-original-src="https://miro.medium.com/v2/resize:fit:1352/format:webp/1*a-ZYzQGBIPWUtNuQYpV-mw.png"/></div></figure><p id="cf31" class="pw-post-body-paragraph ll lm iq ln b lo mg lq lr ls mh lu lv lb mi lx ly le mj ma mb lh mk md me mf ij bi translated">值得一提的是，IP互联网协议属于网络层，占据了TCP/IP的半壁江山，重要性可见一斑。IP协议的作用是获取分配的IP地址和MAC地址(网卡的固定地址)等。，并向另一方发送各种数据包。一般来说，通信传输只能通过多台计算机和网络设备的中转来连接，中转需要使用下一站中转设备的MAC地址来搜索下一个传输目标。只要拨公司总机号码到前台，前台会把电话转到分机号码。</p><p id="46c1" class="pw-post-body-paragraph ll lm iq ln b lo mg lq lr ls mh lu lv lb mi lx ly le mj ma mb lh mk md me mf ij bi translated">使用TCP/IP协议族进行通信时，发送端会先从应用层向下移动到网络层，到达接收端后再从网络层移动到应用层，如下图所示。图中的箭头是双向的，表示发送方可以是客户端也可以是服务器，接收方也可以使用相同的原理。</p><figure class="mm mn mo mp gt jr gh gi paragraph-image"><div class="gh gi mq"><img src="../Images/b813f740ec67b9bb477e80908a52f96c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1104/format:webp/1*oZorxs2rXBN6sitUFCCrYw.png"/></div></figure><p id="36e6" class="pw-post-body-paragraph ll lm iq ln b lo mg lq lr ls mh lu lv lb mi lx ly le mj ma mb lh mk md me mf ij bi translated">在TCP/IP协议通信过程中，发送端从应用层到链路层的每一层，都会在把上层当作数据的基础上，封装上一层当前层的头信息。相反，在接收端从链路层到应用层的每一层都会解析当前层的报头，得到下一层的信息，并消除当前层的报头。这种数据信息封装方法称为封装。如下图所示:</p><figure class="mm mn mo mp gt jr gh gi paragraph-image"><div class="gh gi mr"><img src="../Images/d0ac575916d3b3d2657bea86a49545e4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1026/format:webp/1*GETyh3C3kfMK2YjFuAhwmw.png"/></div></figure><p id="f7dc" class="pw-post-body-paragraph ll lm iq ln b lo mg lq lr ls mh lu lv lb mi lx ly le mj ma mb lh mk md me mf ij bi translated">TCP协议属于传输层。在HTTP连接中，TCP协议的功能是提供可靠的字节流服务(将大块数据分成消息段的包管理)。也就是说，TCP协议会对大数据进行分段，以便于传输，并保证数据准确可靠地发送给对方。</p><p id="7c42" class="pw-post-body-paragraph ll lm iq ln b lo mg lq lr ls mh lu lv lb mi lx ly le mj ma mb lh mk md me mf ij bi translated">TCP如何确保数据从发送方准确传输到接收方？这里我们使用众所周知的TCP三重握手策略。</p><h1 id="6039" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">TCP三握手四浪</h1><h2 id="8ca9" class="kw jz iq bd ka kx ky dn ke kz la dp ki lb lc ld km le lf lg kq lh li lj ku lk bi translated">了解TCP连接</h2><p id="7625" class="pw-post-body-paragraph ll lm iq ln b lo lp lq lr ls lt lu lv lb lw lx ly le lz ma mb lh mc md me mf ij bi translated">要理解TCP三次握手过程，首先需要理解TCP报头结构。下图显示了TCP报头的结构:</p><figure class="mm mn mo mp gt jr gh gi paragraph-image"><div class="gh gi ms"><img src="../Images/0c104aa41a96819331c06b0e29997cc0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1372/format:webp/1*pIWVWiIfHEvBG5AWc9Hsuw.png"/></div></figure><p id="cf8b" class="pw-post-body-paragraph ll lm iq ln b lo mg lq lr ls mh lu lv lb mi lx ly le mj ma mb lh mk md me mf ij bi translated">在TCP报头的结构图中，每行代表一个字节，每个字节有32位。</p><ul class=""><li id="bdaf" class="mt mu iq ln b lo mg ls mh lb mv le mw lh mx mf my mz na nb bi translated">第一个字节包含源端口号和目的端口号，每个端口号占用16位；</li><li id="a380" class="mt mu iq ln b lo nc ls nd lb ne le nf lh ng mf my mz na nb bi translated">第二个字节代表由计算机随机生成的数字，用于唯一标识消息的当前序列号(Seq );</li><li id="f664" class="mt mu iq ln b lo nc ls nd lb ne le nf lh ng mf my mz na nb bi translated">第三个字节32确认序列号(ack)是对收到的TCP报文的确认，表示接收方期望从发送方收到的下一个报文段的第一个字节数据的编号，其值为收到的TCP报文段序列号值加1；</li><li id="7ddc" class="mt mu iq ln b lo nc ls nd lb ne le nf lh ng mf my mz na nb bi translated">第四个字节由4位报头长度、6位保留位和6位标志位组成。我们使用的ACK、SYN、FIN标志位分别占用1位，其值为二进制1或0，分别表示是或否。ack标志表示序列号是否有效(注意区分大写ACK和小写ACK)，SYN标志表示是否发起新的连接，FIN标志表示是否结束一个TCP连接。</li><li id="6433" class="mt mu iq ln b lo nc ls nd lb ne le nf lh ng mf my mz na nb bi translated">校验和提供额外的可靠性，紧急指针标记紧急数据在数据字段中的位置，等等。</li></ul><h2 id="ba16" class="kw jz iq bd ka kx ky dn ke kz la dp ki lb lc ld km le lf lg kq lh li lj ku lk bi translated">TCP三次握手</h2><p id="d501" class="pw-post-body-paragraph ll lm iq ln b lo lp lq lr ls lt lu lv lb lw lx ly le lz ma mb lh mc md me mf ij bi translated">TCP是全双工的。发送方和服务器相互发送信息。当客户端想要发起一个新的连接时，需要向服务器发送一个SYN标志位为1的请求，称为三次握手，如下图所示:</p><figure class="mm mn mo mp gt jr gh gi paragraph-image"><div class="gh gi nh"><img src="../Images/dbe5b1e9a369f72745258aa885ad58b9.png" data-original-src="https://miro.medium.com/v2/resize:fit:622/format:webp/1*eBaJ69C8rg0i0dS4jkzT8g.png"/></div></figure><p id="4321" class="pw-post-body-paragraph ll lm iq ln b lo mg lq lr ls mh lu lv lb mi lx ly le mj ma mb lh mk md me mf ij bi translated">三次TCP握手的过程:</p><ol class=""><li id="3ebe" class="mt mu iq ln b lo mg ls mh lb mv le mw lh mx mf ni mz na nb bi translated">第一次握手:客户端向服务器发送一个小的TCP数据包。数据包中TCP报头的SYN标志位为1，它有一个随机生成的序列号。这里，假设序列号是10000，表示从服务器请求新的TCP连接。</li><li id="ecbd" class="mt mu iq ln b lo nc ls nd lb ne le nf lh ng mf ni mz na nb bi translated">第二次握手:如果服务器接受连接请求，它将用一个TCP包回复客户端。在这个数据包中，TCP报头的SYN标志位为1，ACK标志位为1，表示同步确认。那么服务器也会生成自己的序列号。假设序列号是20000，服务器也会加一个确认号，在客户端发来的序列号的基础上加1，也就是10001。</li><li id="1225" class="mt mu iq ln b lo nc ls nd lb ne le nf lh ng mf ni mz na nb bi translated">第三次握手:客户端收到对方回复后，可以根据收到的确认号减1得到的值判断是否是自己发送的TCP报文。但此时服务器并不知道自己发送的SYN+ACK报文是否被客户端接受，所以客户端需要向服务器发送一个TCP报文，其中ACK位为1，确认号根据从服务器收到的报文序列号加1，即20001，连接正式建立。</li></ol><h2 id="c544" class="kw jz iq bd ka kx ky dn ke kz la dp ki lb lc ld km le lf lg kq lh li lj ku lk bi translated">TCP的四次浪潮</h2><p id="8e29" class="pw-post-body-paragraph ll lm iq ln b lo lp lq lr ls lt lu lv lb lw lx ly le lz ma mb lh mc md me mf ij bi translated">当客户端或服务器要断开连接时，会向对方发送断开连接请求。有四个过程，叫做四波。</p><figure class="mm mn mo mp gt jr gh gi paragraph-image"><div class="gh gi nh"><img src="../Images/4e002ea0f6dbb24a4ee31038af2ef3f7.png" data-original-src="https://miro.medium.com/v2/resize:fit:622/format:webp/1*V0F43dVW5g-HxklMv1WUAw.png"/></div></figure><p id="dd08" class="pw-post-body-paragraph ll lm iq ln b lo mg lq lr ls mh lu lv lb mi lx ly le mj ma mb lh mk md me mf ij bi translated">如上图所示，TCP挥舞四次的过程如下:</p><ol class=""><li id="3830" class="mt mu iq ln b lo mg ls mh lb mv le mw lh mx mf ni mz na nb bi translated">第一波:当客户端想要关闭连接时，它向服务器发送一个TCP消息段。报头中的FIN标志位的值是1。这里FIN的意思是完成，产生一个随机的序列号。假设序列号是26000。</li><li id="03fa" class="mt mu iq ln b lo nc ls nd lb ne le nf lh ng mf ni mz na nb bi translated">第二波:服务器收到客户端的FIN请求时，会发送ACK标志值为1的消息段进行确认，自己的序列号会使用对方的确认号，而自己的确认号会使用对方的序列号加1。</li><li id="9ffa" class="mt mu iq ln b lo nc ls nd lb ne le nf lh ng mf ni mz na nb bi translated">第三波:此时客户端不知道服务器是否还会有未发送的数据，所以客户端需要等到服务器发送完所有数据后，再向客户端发送FIN+ACK，并生成自己的序列号。假设这里是10930，说明确认后可以平仓。</li><li id="3bec" class="mt mu iq ln b lo nc ls nd lb ne le nf lh ng mf ni mz na nb bi translated">第四波:最后，客户端收到服务器发来的FIN消息后，会发送一个ACK标志位为1的TCP消息段进行确认。消息段的序列号就是对方的确认号。确认号是对方的序列号加1，也就是10931。此时，TCP完成四次挥手，连接关闭。</li></ol><p id="850b" class="pw-post-body-paragraph ll lm iq ln b lo mg lq lr ls mh lu lv lb mi lx ly le mj ma mb lh mk md me mf ij bi translated"><em class="nj">更多内容请看</em><a class="ae nk" href="https://plainenglish.io/" rel="noopener ugc nofollow" target="_blank"><strong class="ln ir"><em class="nj">plain English . io</em></strong></a><em class="nj">。报名参加我们的</em> <a class="ae nk" href="http://newsletter.plainenglish.io/" rel="noopener ugc nofollow" target="_blank"> <strong class="ln ir"> <em class="nj">免费周报</em> </strong> </a> <em class="nj">。关注我们关于</em><a class="ae nk" href="https://twitter.com/inPlainEngHQ" rel="noopener ugc nofollow" target="_blank"><strong class="ln ir"><em class="nj">Twitter</em></strong></a><a class="ae nk" href="https://www.linkedin.com/company/inplainenglish/" rel="noopener ugc nofollow" target="_blank"><strong class="ln ir"><em class="nj">LinkedIn</em></strong></a><strong class="ln ir"><em class="nj"/></strong><a class="ae nk" href="https://www.youtube.com/channel/UCtipWUghju290NWcn8jhyAw" rel="noopener ugc nofollow" target="_blank"><strong class="ln ir"><em class="nj">YouTube</em></strong></a><strong class="ln ir"><em class="nj">，以及</em></strong><em class="nj"/><a class="ae nk" href="https://discord.gg/GtDtUAvyhW" rel="noopener ugc nofollow" target="_blank"><strong class="ln ir"><em class="nj">不和</em> </strong> </a>  <em class="nj">对成长黑客感兴趣？检查</em> <a class="ae nk" href="https://circuit.ooo/" rel="noopener ugc nofollow" target="_blank"> <strong class="ln ir"> <em class="nj">电路</em> </strong> </a> <strong class="ln ir"> <em class="nj">。</em> </strong></p></div></div>    
</body>
</html>