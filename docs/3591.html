<html>
<head>
<title>Let’s Understand Chrome V8: Compiler Workflow: Bytecode, Constant Pool</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">让我们来理解Chrome V8:编译器工作流:字节码，常量池</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/lets-understand-chrome-v8-compiler-workflow-bytecode-constant-pool-4b77825812b4?source=collection_archive---------14-----------------------#2022-09-09">https://javascript.plainenglish.io/lets-understand-chrome-v8-compiler-workflow-bytecode-constant-pool-4b77825812b4?source=collection_archive---------14-----------------------#2022-09-09</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><div class=""><h2 id="9898" class="pw-subtitle-paragraph jk im in bd b jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb dk translated">第22章:字节码生成的细节</h2></div><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi kc"><img src="../Images/2229cb027639f57877eb360bf75cd927.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yCFNVeb4ds9hl7WF-NP-kw.png"/></div></div></figure><p id="9ab4" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated"><em class="lk">欢迎阅读</em> <a class="ae ll" href="https://medium.com/@huidou" rel="noopener"> <em class="lk">其他章节让我们来了解一下Chrome V8 </em> </a></p><p id="3e11" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">在本文中，我们将深入字节码，详细研究字节码生成和常量池。</p><h1 id="f43c" class="lm ln in bd lo lp lq lr ls lt lu lv lw jt lx ju ly jw lz jx ma jz mb ka mc md bi translated"><strong class="ak"> 1。字节码生成</strong></h1><p id="0dab" class="pw-post-body-paragraph ko kp in kq b kr me jo kt ku mf jr kw kx mg kz la lb mh ld le lf mi lh li lj ig bi translated">GenerateUnoptimizedCodeForToplevel负责将AST树转换成字节码。</p><figure class="kd ke kf kg gt kh"><div class="bz fp l di"><div class="mj mk l"/></div></figure><p id="e39c" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">第7行<em class="lk"> job- &gt; ExecuteJob() </em>从parse_info中读取AST树并生成字节码。通过调试它，我们进入下面的函数，该函数分析每个AST节点并生成相应的字节码。</p><figure class="kd ke kf kg gt kh"><div class="bz fp l di"><div class="mj mk l"/></div></figure><p id="9eb7" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">在上面的函数中，第11、12和23行首先分别分析声明、导入模块和语句，然后生成相应的字节码。</p><p id="b3b3" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">在我们的例子中，我们将更深入地研究第11行VisitDeclarations()。在VisitDeclarations()中，调用了以下函数。</p><figure class="kd ke kf kg gt kh"><div class="bz fp l di"><div class="mj mk l"/></div></figure><p id="9cd3" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">在第3行，OutputLdaConstant将一个全局常量存储到常量池中，并生成用于加载该常量的字节码LdaGlobal，这样我们就可以在执行过程中通过LdaGlobal取出该常量。关于恒池，我以后再说。</p><p id="067a" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">通过调试OutputLdaConstant()，我们进入了EmitBytecode()，它为相应的语句生成一个字节码，也是为全局常量生成LdaGlobal的函数。</p><figure class="kd ke kf kg gt kh"><div class="bz fp l di"><div class="mj mk l"/></div></figure><p id="76b6" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">从第4行到第25行，计算我们的LdaGlobal的操作数大小，因为在执行中，字节码需要操作数大小来正确操作操作数。</p><p id="9ddf" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">回到GenerateBytecodeBody()，在第23行，VisitStatements()读取一个表示相应JavaScript语句的AST节点，并生成一个字节码。</p><p id="ebd5" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated"><strong class="kq io">注意:</strong>如果一个AST节点代表一个JavaScript语句块，VisitStatements()会递归调用自身生成很多字节码。</p><figure class="kd ke kf kg gt kh"><div class="bz fp l di"><div class="mj mk l"/></div></figure><p id="21bc" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">图1显示了VisitStatements的调用堆栈。</p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi ml"><img src="../Images/6af67d2a61482f5fd6c7da77d7f8dfb3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*oLDzYZNqVfp6DN4mIbOAjg.png"/></div></div></figure><h1 id="40a3" class="lm ln in bd lo lp lq lr ls lt lu lv lw jt lx ju ly jw lz jx ma jz mb ka mc md bi translated"><strong class="ak"> 2。常量池</strong></h1><figure class="kd ke kf kg gt kh"><div class="bz fp l di"><div class="mj mk l"/></div></figure><p id="834d" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">编译函数test()时，编译器推断将调用add3，add3地址应该被推入常量池。</p><p id="85ac" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">但是，这里有一个问题。如果add3()还没有编译，我们就没有地址。在这种情况下，编译器在常量池中为add3保留一个槽，并在add3()编译后填充它，即DeferredConstants。</p><p id="f59f" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">让我们看一下FinalizeBytecode()。</p><figure class="kd ke kf kg gt kh"><div class="bz fp l di"><div class="mj mk l"/></div></figure><p id="7fcd" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">在第4行，AllocateDeferredConstants创建了DeferredConstants。</p><figure class="kd ke kf kg gt kh"><div class="bz fp l di"><div class="mj mk l"/></div></figure><p id="35c0" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">从第4行到第10行，循环for将全局变量存储到常量池中。</p><p id="0aff" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">从第11行到第35行，将sharedfunction、constant property和其他内容存储到常量池中。</p><h1 id="182c" class="lm ln in bd lo lp lq lr ls lt lu lv lw jt lx ju ly jw lz jx ma jz mb ka mc md bi translated"><strong class="ak"> 3。FinalizeBytecode </strong></h1><p id="c842" class="pw-post-body-paragraph ko kp in kq b kr me jo kt ku mf jr kw kx mg kz la lb mh ld le lf mi lh li lj ig bi translated">FinalizeBytecode()是生成字节码的最后一步。让我们看一下FinalizeBytecode的第13行，<em class="lk">builder()-&gt;ToBytecodeArray</em>重新组织字节码并返回一个字节码数组，该数组包含一个表示JavaScript代码的字节码数组。什么是“重组”？它只是放置字节码、常量池等。因为所有的东西在ToBytecodeArray之前就已经做好了。</p><figure class="kd ke kf kg gt kh"><div class="bz fp l di"><div class="mj mk l"/></div></figure><p id="2c2c" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">第9行显示了handler_table，也就是我刚才提到的dispatch_table。</p><p id="143b" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">第11行将handler_table地址存储到一个字节码数组中。请记住，每个字节码只有一个处理程序，它是实际的worker，由dispatch_table保存。</p><p id="56af" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">让我们看一下第11行字节码_数组_写入器_.ToBytecodeArray。</p><figure class="kd ke kf kg gt kh"><div class="bz fp l di"><div class="mj mk l"/></div></figure><p id="51bb" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">第7行生成constant_pool，第9行生成一个字节码数组，源代码如下:</p><figure class="kd ke kf kg gt kh"><div class="bz fp l di"><div class="mj mk l"/></div></figure><p id="d4c3" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">第12行从V8堆中分配内存，然后第15–25行将字节码数组复制到内存中，最后第28行返回字节码。</p><h1 id="f4f9" class="lm ln in bd lo lp lq lr ls lt lu lv lw jt lx ju ly jw lz jx ma jz mb ka mc md bi translated"><strong class="ak">外卖</strong></h1><ul class=""><li id="a7ab" class="mm mn in kq b kr me ku mf kx mo lb mp lf mq lj mr ms mt mu bi translated">常量池保存常量、函数地址等。<strong class="kq io">注:</strong>如果一个变量名是已知的，它作为一个常量存储在常量池中；</li><li id="c9f8" class="mm mn in kq b kr mv ku mw kx mx lb my lf mz lj mr ms mt mu bi translated">常量池始终位于字节码数组[0]中。换句话说，给定一个字节码数组，数组的第一个元素总是常量池；</li><li id="df0d" class="mm mn in kq b kr mv ku mw kx mx lb my lf mz lj mr ms mt mu bi translated">字节码数组是一个堆对象，它的类型是FixedArray。</li></ul><p id="b20a" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated"><em class="lk">好了，这部分就到此为止了。下次再见，保重！</em></p><p id="56ab" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">如果你有任何问题，请联系我。<strong class="kq io">微信</strong> : qq9123013 <strong class="kq io">邮箱</strong>:<a class="ae ll" href="mailto:v8blink@outlook.com" rel="noopener ugc nofollow" target="_blank">v8blink@outlook.com</a></p></div><div class="ab cl na nb hr nc" role="separator"><span class="nd bw bk ne nf ng"/><span class="nd bw bk ne nf ng"/><span class="nd bw bk ne nf"/></div><div class="ig ih ii ij ik"><p id="a928" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated"><em class="lk">更多内容看</em> <a class="ae ll" href="https://plainenglish.io/" rel="noopener ugc nofollow" target="_blank"> <strong class="kq io"> <em class="lk">说白了就是</em> </strong> </a> <em class="lk">。报名参加我们的</em> <a class="ae ll" href="http://newsletter.plainenglish.io/" rel="noopener ugc nofollow" target="_blank"> <strong class="kq io"> <em class="lk">免费周报</em> </strong> </a> <em class="lk">。关注我们</em> <a class="ae ll" href="https://twitter.com/inPlainEngHQ" rel="noopener ugc nofollow" target="_blank"> <strong class="kq io"> <em class="lk">推特</em> </strong> </a>，<a class="ae ll" href="https://www.linkedin.com/company/inplainenglish/" rel="noopener ugc nofollow" target="_blank"><strong class="kq io"><em class="lk">LinkedIn</em></strong></a><em class="lk">，</em><a class="ae ll" href="https://www.youtube.com/channel/UCtipWUghju290NWcn8jhyAw" rel="noopener ugc nofollow" target="_blank"><strong class="kq io"><em class="lk">YouTube</em></strong></a><em class="lk">，</em><a class="ae ll" href="https://discord.gg/GtDtUAvyhW" rel="noopener ugc nofollow" target="_blank"><em class="lk">不和</em>  </a> <em class="lk">。</em></p></div></div>    
</body>
</html>