<html>
<head>
<title>Build a React Hook for Fetching Data</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">构建一个获取数据的React钩子</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/build-a-react-hook-for-fetching-data-262aabcf9d7e?source=collection_archive---------9-----------------------#2022-01-19">https://javascript.plainenglish.io/build-a-react-hook-for-fetching-data-262aabcf9d7e?source=collection_archive---------9-----------------------#2022-01-19</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><div class=""><h2 id="cf07" class="pw-subtitle-paragraph jk im in bd b jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb dk translated">让我们把它钩起来！</h2></div><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi kc"><img src="../Images/be782f5e82a11677905e35a4feddbfc7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FY0XFiURQPLjRE6no5b2Fg.jpeg"/></div></div><figcaption class="ko kp gj gh gi kq kr bd b be z dk">Photo by <a class="ae ks" href="https://unsplash.com/@taylor65s?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">Taylor Beach</a> on <a class="ae ks" href="https://unsplash.com/s/photos/hook?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="6867" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">钩子改变了React的使用方式。钩子支持的事情之一是代码的可重用性。许多著名的库，如<a class="ae ks" href="https://reactrouter.com/" rel="noopener ugc nofollow" target="_blank"> react-router </a>、<a class="ae ks" href="https://react-query.tanstack.com/" rel="noopener ugc nofollow" target="_blank"> react-query </a>都更好地采用了钩子。钩子的另一个特点是它们是可组合的。您可以使用基本的钩子，如<a class="ae ks" href="https://reactjs.org/docs/hooks-reference.html#usestate" rel="noopener ugc nofollow" target="_blank"> useState </a>和<a class="ae ks" href="https://reactjs.org/docs/hooks-reference.html#useeffect" rel="noopener ugc nofollow" target="_blank"> useEffect </a>来编写您自己的定制钩子，并在您的应用程序中重用它们。</p><p id="1b71" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">今天，我们将为这样一个获取数据的常见场景编写一个钩子。没有任何进一步的延迟，让我们马上看看这个钩子—</p><figure class="kd ke kf kg gt kh"><div class="bz fp l di"><div class="lp lq l"/></div></figure><p id="3d72" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">让我们一步一步地分解它——</p><h1 id="93aa" class="lr ls in bd lt lu lv lw lx ly lz ma mb jt mc ju md jw me jx mf jz mg ka mh mi bi translated">存储状态、数据和错误。</h1><p id="db13" class="pw-post-body-paragraph kt ku in kv b kw mj jo ky kz mk jr lb lc ml le lf lg mm li lj lk mn lm ln lo ig bi translated">我们的自定义钩子中的数据由useState钩子<code class="fe mo mp mq mr b">Line 5</code>管理。数据和错误属性是相当自描述的。状态变量使它变得有趣。它可以取idle、loading、resolved和errored中的任何值。初始状态设置为空闲<code class="fe mo mp mq mr b">Line 8</code>，从那里转换到加载状态<code class="fe mo mp mq mr b">Line 14</code>。此后，它可以取值为已解决或出错。如果已解析，则使用来自API <code class="fe mo mp mq mr b">Line 19</code>的响应设置数据属性。如果有错误，用错误对象<code class="fe mo mp mq mr b">Line 23</code>设置错误属性。</p><p id="ff85" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">很简单，对吧。我们继续。</p><h2 id="1aea" class="ms ls in bd lt mt mu dn lx mv mw dp mb lc mx my md lg mz na mf lk nb nc mh nd bi translated">为什么是状态变量而不是isLoading，isError这样的变量？</h2><p id="3ab0" class="pw-post-body-paragraph kt ku in kv b kw mj jo ky kz mk jr lb lc ml le lf lg mm li lj lk mn lm ln lo ig bi translated">你可能会问为什么只有一个string类型的状态变量，而不是像isLoading和isError这样的布尔变量。boolean难道不会让API更干净一点吗？</p><pre class="kd ke kf kg gt ne mr nf ng aw nh bi"><span id="be81" class="ms ls in mr b gy ni nj l nk nl"><strong class="mr io">// consuming hook using status varible</strong></span><span id="49a2" class="ms ls in mr b gy nm nj l nk nl">if(status === "loading")<br/>  return &lt;div className="loading"&gt;&lt;/div&gt;<br/>else if(status === "errored")<br/>  return &lt;div&gt;An error occured.&lt;/div&gt;<br/>else<br/>  return &lt;div&gt;{data.id}&lt;/div&gt;</span><span id="081b" class="ms ls in mr b gy nm nj l nk nl"><strong class="mr io">// consuming hook using boolean variables like isLoading, isError</strong></span><span id="98f5" class="ms ls in mr b gy nm nj l nk nl">if(isLoading)<br/>  return &lt;div className="loading"&gt;&lt;/div&gt;<br/>else if(isError)<br/>  return &lt;div&gt;An error occured.&lt;/div&gt;<br/>else<br/>  return &lt;div&gt;{data.id}&lt;/div&gt;</span></pre><p id="6aa8" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">嗯，这有两个原因—</p><ul class=""><li id="f08e" class="nn no in kv b kw kx kz la lc np lg nq lk nr lo ns nt nu nv bi translated">因为只有一个变量(状态变量),所以最大限度地减少了混淆。我们需要做的就是设置当前状态，而不用担心设置其他变量的状态。让我们考虑有两个布尔变量。理论上，应该有四种不同的状态组合。此外，用单个变量扩展状态相当简单。</li><li id="248f" class="nn no in kv b kw nw kz nx lc ny lg nz lk oa lo ns nt nu nv bi translated">你总是可以写一个有布尔变量的实用程序—</li></ul><pre class="kd ke kf kg gt ne mr nf ng aw nh bi"><span id="aa1d" class="ms ls in mr b gy ni nj l nk nl">const mapStatus = (status) =&gt; {<br/>  return {<br/>    isIdle: status === "idle",<br/>    isLoading: status === "loading",<br/>    isResolved: status === "resolved",<br/>    isError: status === "errored",<br/>  }<br/>}</span><span id="dff2" class="ms ls in mr b gy nm nj l nk nl">/* Only one amongst the four properties from the above object will be true at any given time.*/</span></pre><h1 id="44d5" class="lr ls in bd lt lu lv lw lx ly lz ma mb jt mc ju md jw me jx mf jz mg ka mh mi bi translated">有效地进行API调用。</h1><p id="2314" class="pw-post-body-paragraph kt ku in kv b kw mj jo ky kz mk jr lb lc ml le lf lg mm li lj lk mn lm ln lo ig bi translated">自定义钩子使用useEffect通过使用<a class="ae ks" href="https://axios-http.com/" rel="noopener ugc nofollow" target="_blank"> axios </a>进行外部API(在本例中为<a class="ae ks" href="https://jsonplaceholder.typicode.com/" rel="noopener ugc nofollow" target="_blank"> jsonplaceholder </a>)调用。使用<a class="ae ks" href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/async_function" rel="noopener ugc nofollow" target="_blank"> async-await </a>从服务器获取数据是非常标准的。然而，有两件事需要讨论—</p><h2 id="f5ca" class="ms ls in bd lt mt mu dn lx mv mw dp mb lc mx my md lg mz na mf lk nb nc mh nd bi translated">shouldSetData变量的使用。</h2><p id="15e7" class="pw-post-body-paragraph kt ku in kv b kw mj jo ky kz mk jr lb lc ml le lf lg mm li lj lk mn lm ln lo ig bi translated">假设您正在列出帖子，单击其中一个列出的帖子会获取相应帖子的详细信息。假设你有一个10篇文章的列表。理想情况下，用户点击帖子5并看到其详细信息。然后他们点击第9篇文章并查看其详细内容。效果相当好！</p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div class="gh gi ob"><img src="../Images/00b5ee548118161eb07c2f8b4de02401.png" data-original-src="https://miro.medium.com/v2/resize:fit:1060/format:webp/1*7GqgJ3TqsF56r1vOWUifIg.png"/></div><figcaption class="ko kp gj gh gi kq kr bd b be z dk">List of 10 posts and details of post 9.</figcaption></figure><p id="c23d" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">然而，假设用户点击post 1，在它完成获取之前，他们点击post 4，在完成加载之前，他们点击post 9，最后等待它加载。</p><p id="a466" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">刚刚发生了什么？让我们开始吧。</p><ul class=""><li id="1367" class="nn no in kv b kw kx kz la lc np lg nq lk nr lo ns nt nu nv bi translated">我们不知道服务器会以什么样的顺序满足我们的请求。然而，我们知道用户只对第9篇文章感兴趣。所以基本上所有花在post 1和post 4上的时间在前端和服务器上都是不必要的。</li><li id="361f" class="nn no in kv b kw nw kz nx lc ny lg nz lk oa lo ns nt nu nv bi translated">此外，在卸载组件的情况下(可能是因为您离开了),由于在卸载的组件中设置了状态，会引发以下错误。</li></ul><pre class="kd ke kf kg gt ne mr nf ng aw nh bi"><span id="8670" class="ms ls in mr b gy ni nj l nk nl"><strong class="mr io">Warning: Can’t call setState (or forceUpdate) on an unmounted component. This is a no-op, but it indicates a memory leak in your application. To fix, cancel all subscriptions and asynchronous tasks in the componentWillUnmount method</strong></span></pre><ul class=""><li id="313d" class="nn no in kv b kw kx kz la lc np lg nq lk nr lo ns nt nu nv bi translated">即使在组件重新呈现的情况下，它可能会在最终显示post 9之前闪烁post 1和post 4的结果响应。</li></ul><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div class="gh gi oc"><img src="../Images/0dc70e6b2107eb0b79b58f5c4e98ea7a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1200/1*V1h_jbj9k_VGXJPg0e5QSg.gif"/></div><figcaption class="ko kp gj gh gi kq kr bd b be z dk">Notice how the screen flashes for 2 before finally showing details of 3rd post.</figcaption></figure><figure class="kd ke kf kg gt kh"><div class="bz fp l di"><div class="lp lq l"/></div></figure><p id="5aa4" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">实际发生的情况是，当用户点击按钮<code class="fe mo mp mq mr b">Line 35</code>来获取post 1的详细信息时(没有等待它完成)，它触发了一个API调用<code class="fe mo mp mq mr b">Line 2</code>。但是，当API完成调用时，用户已经点击了另一个帖子(或者可能已经离开了组件)。但是，react仍然会尝试设置与post 1对应的数据、状态和错误变量。</p><p id="4e53" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">变量shouldSetData帮助我们控制应用程序在任何情况下的行为(卸载或重新渲染)。观察作为效果清理的一部分，shouldSetState如何设置为false。它确保数据、错误和状态仅在需要时为正确的URL设置。</p><p id="5059" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">这是处理这种行为的前端部分。不过，还有一点需要考虑。</p><h2 id="c737" class="ms ls in bd lt mt mu dn lx mv mw dp mb lc mx my md lg mz na mf lk nb nc mh nd bi translated">使用堕胎控制器</h2><p id="aea5" class="pw-post-body-paragraph kt ku in kv b kw mj jo ky kz mk jr lb lc ml le lf lg mm li lj lk mn lm ln lo ig bi translated">我们已经处理了组件中的行为。但是网络请求仍然被触发。<a class="ae ks" href="https://developer.mozilla.org/en-US/docs/Web/API/AbortController" rel="noopener ugc nofollow" target="_blank">中止控制器</a>允许我们取消网络请求。</p><p id="6f18" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">每次更改URL时都会触发一个网络请求<code class="fe mo mp mq mr b">Look at the dependency array for useFetch</code>。清理功能中的controller.abort()确保对帖子1和帖子4的请求被取消，用户只等待帖子9的数据。</p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div class="gh gi od"><img src="../Images/d6801d3e91c1e1aef1a93f50e9254ab1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1062/format:webp/1*Cce4tjuTypgfK1fUxGn4fQ.png"/></div><figcaption class="ko kp gj gh gi kq kr bd b be z dk">Observe the request for post 1 and post 4 is aborted without getting resolved.</figcaption></figure><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div class="gh gi oe"><img src="../Images/0f63a0f05684a7582a5f56e511844a71.png" data-original-src="https://miro.medium.com/v2/resize:fit:1014/format:webp/1*_uxptbOsqnq7KHCUC6d5pQ.png"/></div><figcaption class="ko kp gj gh gi kq kr bd b be z dk">Network tab cancelling requests.</figcaption></figure><p id="3dec" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">希望你喜欢这篇文章。下面的沙箱提供了演示示例。</p><figure class="kd ke kf kg gt kh"><div class="bz fp l di"><div class="of lq l"/></div><figcaption class="ko kp gj gh gi kq kr bd b be z dk">A sample of code.</figcaption></figure><p id="ec61" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated"><em class="og">多内容见于</em> <a class="ae ks" href="http://plainenglish.io/" rel="noopener ugc nofollow" target="_blank"> <strong class="kv io"> <em class="og">通俗易懂的英语中</em> </strong> </a> <em class="og">。报名参加我们的</em> <a class="ae ks" href="http://newsletter.plainenglish.io/" rel="noopener ugc nofollow" target="_blank"> <strong class="kv io"> <em class="og">免费周报</em> </strong> </a> <em class="og">。在我们的</em> <a class="ae ks" href="https://discord.gg/GtDtUAvyhW" rel="noopener ugc nofollow" target="_blank"> <strong class="kv io"> <em class="og">社区纠纷</em> </strong> </a> <em class="og">中获得独家写作机会和建议。</em></p></div></div>    
</body>
</html>