<html>
<head>
<title>How to Resolve a Promise from Outside in JavaScript</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何在JavaScript中解析来自外部的承诺</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/javascript-resolve-promise-from-outside-cefdb7381128?source=collection_archive---------2-----------------------#2022-07-04">https://javascript.plainenglish.io/javascript-resolve-promise-from-outside-cefdb7381128?source=collection_archive---------2-----------------------#2022-07-04</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><figure class="gl gn jl jm jn jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi jk"><img src="../Images/ef628095de36309c84fbd9376992786f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*s20a83MwtcjOlaMxGiVhAA.png"/></div></div></figure><p id="29ee" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">要在JavaScript中解析来自外部的承诺，将<code class="fe kt ku kv kw b">resolve</code>回调赋给在<code class="fe kt ku kv kw b">Promise</code>构造函数范围之外定义的变量，然后调用该变量来解析<code class="fe kt ku kv kw b">Promise</code>。例如:</p><pre class="kx ky kz la gt lb kw lc ld aw le bi"><span id="ca88" class="lf lg in kw b gy lh li l lj lk">let promiseResolve;<br/>let promiseReject;</span><span id="454c" class="lf lg in kw b gy ll li l lj lk">const promise = new Promise((resolve, reject) =&gt; {<br/>  promiseResolve = resolve;<br/>  promiseReject = reject;<br/>});</span><span id="8032" class="lf lg in kw b gy ll li l lj lk">promiseResolve();</span></pre><p id="6273" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">为什么我们需要做这样的事情呢？好吧，也许我们有一个正在进行的操作A，用户希望另一个操作B发生，但是B必须等待A完成。假设我们有一个简单的社交应用程序，用户可以在其中创建、保存和发布帖子。</p><p id="5016" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><strong class="jx io">index.html</strong></p><pre class="kx ky kz la gt lb kw lc ld aw le bi"><span id="156e" class="lf lg in kw b gy lh li l lj lk">&lt;!DOCTYPE html&gt;<br/>&lt;html&gt;<br/>  &lt;head&gt;<br/>    &lt;title&gt;Resolving a Promise from Outside&lt;/title&gt;<br/>  &lt;/head&gt;<br/>  &lt;body&gt;<br/>    &lt;p&gt;<br/>      Save status:<br/>      &lt;b&gt;&lt;span id="save-status"&gt;Not saved&lt;/span&gt;&lt;/b&gt;<br/>    &lt;/p&gt;<br/>    &lt;p&gt;<br/>      Publish status:<br/>      &lt;b&gt;&lt;span id="publish-status"&gt;Not published&lt;/span&gt;&lt;/b&gt;<br/>    &lt;/p&gt;<br/>    &lt;button id="save"&gt;Save&lt;/button&gt;<br/>    &lt;button id="publish"&gt;Publish&lt;/button&gt;<br/>    &lt;script src="index.js"&gt;&lt;/script&gt;<br/>  &lt;/body&gt;<br/>&lt;/html&gt;</span></pre><figure class="kx ky kz la gt jo gh gi paragraph-image"><div class="gh gi lm"><img src="../Images/d1a49f116df438d7304a8cd56b6a1861.png" data-original-src="https://miro.medium.com/v2/resize:fit:616/format:webp/0*4QmJJfwfOSZF8mCj.png"/></div><figcaption class="ln lo gj gh gi lp lq bd b be z dk">Users can save and publish posts.</figcaption></figure><p id="01d3" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">如果一篇文章正在被保存(操作A ),而用户希望在保存过程中发布该文章(操作B ),该怎么办？。如果我们不想在保存时禁用“发布”按钮，我们需要确保在发布之前保存文章。</p><p id="1ea4" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><strong class="jx io"> index.js </strong></p><pre class="kx ky kz la gt lb kw lc ld aw le bi"><span id="d50c" class="lf lg in kw b gy lh li l lj lk">// Enable UI interactivity<br/>const saveStatus = document.getElementById('save-status');<br/>const saveButton = document.getElementById('save');<br/>const publishStatus = document.getElementById(<br/>  'publish-status'<br/>);<br/>const publishButton = document.getElementById('publish');<br/>saveButton.onclick = () =&gt; {<br/>  save();<br/>};<br/>publishButton.onclick = async () =&gt; {<br/>  await publish();<br/>};</span><span id="f645" class="lf lg in kw b gy ll li l lj lk">let saveResolve;<br/>let hasSaved = false;</span><span id="edd0" class="lf lg in kw b gy ll li l lj lk">function save() {<br/>  hasSaved = false;<br/>  saveStatus.textContent = 'Saving...';<br/>  setTimeout(() =&gt; {<br/>    saveResolve();<br/>    hasSaved = true;<br/>    saveStatus.textContent = 'Saved';<br/>  }, 3000);<br/>}</span><span id="cc28" class="lf lg in kw b gy ll li l lj lk">async function waitForSave() {<br/>  if (!hasSaved) {<br/>    await new Promise((resolve) =&gt; {<br/>      saveResolve = resolve;<br/>    });<br/>  }<br/>}</span><span id="0b02" class="lf lg in kw b gy ll li l lj lk">async function publish() {<br/>  publishStatus.textContent = 'Waiting for save...';<br/>  await waitForSave();<br/>  publishStatus.textContent = 'Published';<br/>  return;<br/>}</span></pre><p id="c8f3" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">这段代码的关键部分是<code class="fe kt ku kv kw b">save()</code>和<code class="fe kt ku kv kw b">waitForSave()</code>函数。当用户点击“发布”时，调用<code class="fe kt ku kv kw b">waitForSave()</code>。如果帖子已经保存，从<code class="fe kt ku kv kw b">waitForSave()</code>返回的<code class="fe kt ku kv kw b">Promise</code>会立即解析，否则它会将其<code class="fe kt ku kv kw b">resolve</code>回调分配给一个外部变量，该变量将在保存后被调用。这使得<code class="fe kt ku kv kw b">publish()</code>在继续之前等待<code class="fe kt ku kv kw b">save()</code>中的超时到期。</p><figure class="kx ky kz la gt jo gh gi paragraph-image"><div class="gh gi lr"><img src="../Images/2625c2cb5a8ed58ebfae4fc29e1c3747.png" data-original-src="https://miro.medium.com/v2/resize:fit:588/0*t_17TqHN9-9sL4lr.gif"/></div><figcaption class="ln lo gj gh gi lp lq bd b be z dk">Publish doesn’t happen until after save.</figcaption></figure><p id="f8fb" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">我们可以创建一个<code class="fe kt ku kv kw b">Deferred</code>类来抽象和重用这个逻辑:</p><pre class="kx ky kz la gt lb kw lc ld aw le bi"><span id="7437" class="lf lg in kw b gy lh li l lj lk">class Deferred {<br/>  constructor() {<br/>    this.promise = new Promise((resolve, reject) =&gt; {<br/>      this.reject = reject;<br/>      this.resolve = resolve;<br/>    });<br/>  }<br/>}</span><span id="ccb9" class="lf lg in kw b gy ll li l lj lk">const deferred = new Deferred();</span><span id="79e7" class="lf lg in kw b gy ll li l lj lk">// Resolve from outside<br/>deferred.resolve();</span></pre><p id="3559" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">现在，解析/拒绝<code class="fe kt ku kv kw b">Promise</code>的变量和<code class="fe kt ku kv kw b">Promise</code>本身将包含在同一个<code class="fe kt ku kv kw b">Deferred</code>对象中。</p><p id="f314" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">我们可以重构代码来使用这个类:</p><p id="94fc" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><strong class="jx io"> index.js </strong></p><pre class="kx ky kz la gt lb kw lc ld aw le bi"><span id="ee86" class="lf lg in kw b gy lh li l lj lk">// Enable UI interactivity<br/>// ...</span><span id="2489" class="lf lg in kw b gy ll li l lj lk">const deferredSave = new Deferred();<br/>let hasSaved = false;</span><span id="6264" class="lf lg in kw b gy ll li l lj lk">function save() {<br/>  hasSaved = false;<br/>  saveStatus.textContent = 'Saving...';<br/>  setTimeout(() =&gt; {<br/>    deferredSave.resolve();<br/>    hasSaved = true;<br/>    saveStatus.textContent = 'Saved';<br/>  }, 3000);<br/>}</span><span id="41d2" class="lf lg in kw b gy ll li l lj lk">async function waitForSave() {<br/>  if (!hasSaved) await deferredSave.promise;<br/>}</span><span id="5841" class="lf lg in kw b gy ll li l lj lk">async function publish() {<br/>  // ...<br/>}</span></pre><p id="5e75" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">功能将像以前一样工作:</p><figure class="kx ky kz la gt jo gh gi paragraph-image"><div class="gh gi lr"><img src="../Images/2625c2cb5a8ed58ebfae4fc29e1c3747.png" data-original-src="https://miro.medium.com/v2/resize:fit:588/0*t_17TqHN9-9sL4lr.gif"/></div><figcaption class="ln lo gj gh gi lp lq bd b be z dk">The functionality works as before after using the Deferred class.</figcaption></figure><p id="c2c4" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">【codingbeautydev.com】更新于:<a class="ae lt" href="https://cbdev.link/0edf01" rel="noopener ugc nofollow" target="_blank"><em class="ls"/></a></p></div><div class="ab cl lu lv hr lw" role="separator"><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz"/></div><div class="ig ih ii ij ik"><p id="a550" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">您可以在哪里找到我们:</p><p id="3c47" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">🌐<a class="ae lt" href="https://cbdev.link/b621b9" rel="noopener ugc nofollow" target="_blank">网站</a> |🌟<a class="ae lt" href="https://twitter.com/CodingBeautyDev" rel="noopener ugc nofollow" target="_blank">推特</a> |🌟<a class="ae lt" href="http://facebook.com/CodingBeautyDev" rel="noopener ugc nofollow" target="_blank">脸书</a></p></div><div class="ab cl lu lv hr lw" role="separator"><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz"/></div><div class="ig ih ii ij ik"><h1 id="f82a" class="mb lg in bd mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx bi translated">JavaScript做的每一件疯狂的事情</h1><p id="9a76" class="pw-post-body-paragraph jv jw in jx b jy my ka kb kc mz ke kf kg na ki kj kk nb km kn ko nc kq kr ks ig bi translated">一本关于JavaScript微妙的警告和鲜为人知的部分的迷人指南。</p><figure class="kx ky kz la gt jo gh gi paragraph-image"><div class="gh gi nd"><img src="../Images/143ee152ba78025ea8643ba5b9726a20.png" data-original-src="https://miro.medium.com/v2/resize:fit:700/format:webp/1*YS5Oub8REWy8vnOEqBnsyQ.png"/></div></figure><p id="7d6e" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><a class="ae lt" href="https://cbdev.link/d3c4eb" rel="noopener ugc nofollow" target="_blank"> <strong class="jx io">报名</strong> </a>立即免费领取一份。</p></div></div>    
</body>
</html>