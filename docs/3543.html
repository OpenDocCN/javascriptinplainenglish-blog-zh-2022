<html>
<head>
<title>How to Override Methods in localStorage?</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何覆盖localStorage中的方法？</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/how-to-override-methods-in-localstorage-36c7e5edc47?source=collection_archive---------6-----------------------#2022-09-06">https://javascript.plainenglish.io/how-to-override-methods-in-localstorage-36c7e5edc47?source=collection_archive---------6-----------------------#2022-09-06</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><div class=""><h2 id="d55c" class="pw-subtitle-paragraph jk im in bd b jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb dk translated">将localStorage与JavaScript一起使用。</h2></div><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi kc"><img src="../Images/d43883e14038cf9398be3bab0abc0d6e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*73iHUn-KVVeL6h1HMozCdw.jpeg"/></div></div><figcaption class="ko kp gj gh gi kq kr bd b be z dk">Photo by <a class="ae ks" href="https://unsplash.com/@melodi2?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">Lia Trevarthen</a> on <a class="ae ks" href="https://unsplash.com/s/photos/storage?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="e617" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">经常想重写<code class="fe lp lq lr ls b">localStorage</code>实现某个功能。有哪些方法可以重写<code class="fe lp lq lr ls b">localStorage</code>中的方法？有很多开发者想重新编写<code class="fe lp lq lr ls b">localStorage</code>中的方法来实现密钥的到期时间，或者监控密钥的读写。那么有哪些方法可以覆盖<code class="fe lp lq lr ls b">localStorage</code>中的方法。这是我的第43篇媒体文章。</p><h1 id="e9b5" class="lt lu in bd lv lw lx ly lz ma mb mc md jt me ju mf jw mg jx mh jz mi ka mj mk bi translated">1.直接在本地存储上重写</h1><p id="b050" class="pw-post-body-paragraph kt ku in kv b kw ml jo ky kz mm jr lb lc mn le lf lg mo li lj lk mp lm ln lo ig bi translated">许多开发人员喜欢重写的想法，首先保留原来的方法，然后像下面这样直接在localStorage上重写方法。</p><figure class="kd ke kf kg gt kh"><div class="bz fp l di"><div class="mq mr l"/></div></figure><p id="c206" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">但是，这种写法并不是重写方法<code class="fe lp lq lr ls b">setItem()</code>，而是给<code class="fe lp lq lr ls b">localStorage</code>添加一个<code class="fe lp lq lr ls b">setItem</code>属性。当方法的value属性被声明时，本地的<code class="fe lp lq lr ls b">setItem()</code>方法被覆盖。</p><p id="8cbc" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">我没有对它进行过多的测试，但是在一些浏览器中，这个属性会被忽略，导致我们的重写失败。</p><h1 id="42f7" class="lt lu in bd lv lw lx ly lz ma mb mc md jt me ju mf jw mg jx mh jz mi ka mj mk bi translated">2.重写localStorage上的方法。__proto__</h1><p id="e26f" class="pw-post-body-paragraph kt ku in kv b kw ml jo ky kz mm jr lb lc mn le lf lg mo li lj lk mp lm ln lo ig bi translated">如果我们仔细观察，setItem和getItem继承自Storage <code class="fe lp lq lr ls b">__proto__</code>伪属性。</p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi ms"><img src="../Images/179fd4b830dd027facf1d70a41df3cc3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jVpE_3XAF0sjStNWAi7kHA.png"/></div></div></figure><p id="b2fc" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">然后我们直接重写上面的<code class="fe lp lq lr ls b">localStorage.__proto__</code>方法。</p><figure class="kd ke kf kg gt kh"><div class="bz fp l di"><div class="mq mr l"/></div></figure><p id="686b" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">这实现了对<code class="fe lp lq lr ls b">setItem()</code>方法的真正覆盖。</p><p id="1127" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">但是这里还有一个问题。<code class="fe lp lq lr ls b">localStorage</code>和<code class="fe lp lq lr ls b">sessionStorage</code>都继承自<a class="ae ks" href="https://developer.mozilla.org/en-US/docs/Web/API/Storage" rel="noopener ugc nofollow" target="_blank">存储器</a>。在重写了<code class="fe lp lq lr ls b">localStorage.__proto__</code>上的属性或方法后，<code class="fe lp lq lr ls b">sessionStorage</code>中的方法也被重写。</p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi mt"><img src="../Images/cb5db9684db2291cf62f97316e06b202.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nmNu0D5zmgtRgICjD2pV0w.png"/></div></div></figure><h1 id="f701" class="lt lu in bd lv lw lx ly lz ma mb mc md jt me ju mf jw mg jx mh jz mi ka mj mk bi translated">3.外包装层</h1><p id="fb51" class="pw-post-body-paragraph kt ku in kv b kw ml jo ky kz mm jr lb lc mn le lf lg mo li lj lk mp lm ln lo ig bi translated">我们不直接修改<code class="fe lp lq lr ls b">localStorage</code>本身的方法，而是在外面包裹一层，然后用<code class="fe lp lq lr ls b">localStorage</code>实现底层的存储功能。</p><figure class="kd ke kf kg gt kh"><div class="bz fp l di"><div class="mq mr l"/></div></figure><p id="ea75" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">这样自由度相对更高，不存在第1节的兼容性问题。只有使用的名称发生了变化，而<code class="fe lp lq lr ls b">localStorage</code>中的属性和方法被完全屏蔽。</p><p id="7889" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">如果你想使用一个没有包的自定义对象，那么你需要实现所有的属性和方法。像上面这样单独模仿一个方法是不可能的。</p><h1 id="6082" class="lt lu in bd lv lw lx ly lz ma mb mc md jt me ju mf jw mg jx mh jz mi ka mj mk bi translated">4.覆盖本地存储</h1><p id="fa7f" class="pw-post-body-paragraph kt ku in kv b kw ml jo ky kz mm jr lb lc mn le lf lg mo li lj lk mp lm ln lo ig bi translated">使用<code class="fe lp lq lr ls b">Object.defineProperty</code>或<code class="fe lp lq lr ls b">Proxy</code>等同于完全覆盖<code class="fe lp lq lr ls b">localStorage</code>变量。比第3部分更好，因为名称没有改变。</p><h2 id="95f2" class="mu lu in bd lv mv mw dn lz mx my dp md lc mz na mf lg nb nc mh lk nd ne mj nf bi translated">4.1直接覆盖，无效果</h2><p id="f907" class="pw-post-body-paragraph kt ku in kv b kw ml jo ky kz mm jr lb lc mn le lf lg mo li lj lk mp lm ln lo ig bi translated">如果用下面的方法直接覆盖，就没有效果了。</p><pre class="kd ke kf kg gt ng ls nh ni aw nj bi"><span id="4ad4" class="mu lu in ls b gy nk nl l nm nn">window.localStorage = Object.create(null);  console.log(window.localStorage); //still native</span></pre><p id="9b14" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">我们通过<code class="fe lp lq lr ls b"><a class="ae ks" href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object/getOwnPropertyDescriptor" rel="noopener ugc nofollow" target="_blank">Object.getOwnPropertyDescriptor</a></code>得到<code class="fe lp lq lr ls b">localStorage</code>的属性描述符。可以发现没有writable: true属性，也就是说<code class="fe lp lq lr ls b">localStorage</code>不是直接可写的。</p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi no"><img src="../Images/468d884da1bf761e13f26552bd4a4439.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yJtgfcwsocxfXDikBb2I6A.png"/></div></div></figure><h2 id="ed9e" class="mu lu in bd lv mv mw dn lz mx my dp md lc mz na mf lg nb nc mh lk nd ne mj nf bi translated">4.2用Object.defineProperty重写</h2><p id="c9b3" class="pw-post-body-paragraph kt ku in kv b kw ml jo ky kz mm jr lb lc mn le lf lg mo li lj lk mp lm ln lo ig bi translated">既然没有<code class="fe lp lq lr ls b">writable</code>属性，我们就给它加一个。我们可以用<code class="fe lp lq lr ls b">Object.defineProperty</code>覆盖<code class="fe lp lq lr ls b">localStorage</code>。</p><p id="0782" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">但是你不能用上面那种外面一层的写法。如果直接把上面的<code class="fe lp lq lr ls b">myLocalStorage</code>给<code class="fe lp lq lr ls b">localStorage</code>那么就会产生无限递归(为避免误导，错误的写法这里就不写了)。</p><figure class="kd ke kf kg gt kh"><div class="bz fp l di"><div class="mq mr l"/></div></figure><p id="9e46" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">我这里做了一个<code class="fe lp lq lr ls b">localStorage</code>的备份。如果你需要一个本地方法，你也可以操作它。</p><h1 id="3c44" class="lt lu in bd lv lw lx ly lz ma mb mc md jt me ju mf jw mg jx mh jz mi ka mj mk bi translated">5.摘要</h1><p id="8562" class="pw-post-body-paragraph kt ku in kv b kw ml jo ky kz mm jr lb lc mn le lf lg mo li lj lk mp lm ln lo ig bi translated">在本文中，我们不具体实现诸如设置到期时间这样的功能。而是从另一个角度来谈谈如何重写<code class="fe lp lq lr ls b">localStorage</code>或者其中的方法。</p><p id="50b1" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated"><em class="np">更多内容请看</em><a class="ae ks" href="https://plainenglish.io/" rel="noopener ugc nofollow" target="_blank"><strong class="kv io"><em class="np">plain English . io</em></strong></a><em class="np">。报名参加我们的</em> <a class="ae ks" href="http://newsletter.plainenglish.io/" rel="noopener ugc nofollow" target="_blank"> <strong class="kv io"> <em class="np">免费周报</em> </strong> </a> <em class="np">。关注我们关于</em><a class="ae ks" href="https://twitter.com/inPlainEngHQ" rel="noopener ugc nofollow" target="_blank"><strong class="kv io"><em class="np">Twitter</em></strong></a><a class="ae ks" href="https://www.linkedin.com/company/inplainenglish/" rel="noopener ugc nofollow" target="_blank"><strong class="kv io"><em class="np">LinkedIn</em></strong></a><em class="np"/><a class="ae ks" href="https://www.youtube.com/channel/UCtipWUghju290NWcn8jhyAw" rel="noopener ugc nofollow" target="_blank"><strong class="kv io"><em class="np">YouTube</em></strong></a><em class="np"/><a class="ae ks" href="https://discord.gg/GtDtUAvyhW" rel="noopener ugc nofollow" target="_blank"><strong class="kv io"><em class="np">不和</em> </strong> </a> <em class="np">。</em></p></div></div>    
</body>
</html>