<html>
<head>
<title>JavaScript Fetch — Are You Handling Responses Correctly?</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">JavaScript Fetch——您处理响应的方式正确吗？</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/js-fetch-are-you-handling-responses-correctly-1df3246b85af?source=collection_archive---------4-----------------------#2022-07-08">https://javascript.plainenglish.io/js-fetch-are-you-handling-responses-correctly-1df3246b85af?source=collection_archive---------4-----------------------#2022-07-08</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="1237" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">很多开发者都没有意识到的。</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/ede263bc1fe867421fb47d7f837dd088.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*j51kJGiFlFBqrTQlyCYGfQ.jpeg"/></div></div></figure><p id="a7b8" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">每个JavaScript开发人员可能都知道fetch API。它为向端点发出请求、获取或发布数据提供了一个简单的接口。然而，许多开发人员在使用fetch时并没有意识到一个常见的错误。</p><p id="05da" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">fetch如此受欢迎的部分原因是它返回一个承诺。承诺的优点是可以用处理函数优雅地处理它:<code class="fe ln lo lp lq b">then</code>、<code class="fe ln lo lp lq b">catch</code>和<code class="fe ln lo lp lq b">finally</code>。</p><p id="baa9" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">当承诺得到解决时，将执行<code class="fe ln lo lp lq b">then</code>函数，如果承诺被拒绝，将执行<code class="fe ln lo lp lq b">catch</code>函数。很自然，人们会假设成功的响应在<code class="fe ln lo lp lq b">then</code>函数中处理，不成功的响应在<code class="fe ln lo lp lq b">catch</code>函数中处理。令人惊讶的是，事实并非如此。</p><h1 id="ef0e" class="lr ls iq bd lt lu lv lw lx ly lz ma mb jw mc jx md jz me ka mf kc mg kd mh mi bi translated">棘手问题:<em class="mj">承诺什么时候会兑现？</em></h1><p id="2697" class="pw-post-body-paragraph kr ks iq kt b ku mk jr kw kx ml ju kz la mm lc ld le mn lg lh li mo lk ll lm ij bi translated">每当HTTP响应状态代码为200–299时都是这样吗？</p><p id="28aa" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">没有。好吧，不同的问题。什么时候承诺会被拒绝？</p><p id="e667" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">是每当HTTP响应状态代码为400–499还是500–599时(客户端或服务器错误)？</p><p id="e31c" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">没有。</p><h2 id="f5e8" class="mp ls iq bd lt mq mr dn lx ms mt dp mb la mu mv md le mw mx mf li my mz mh na bi translated">让我们弄清楚这件事</h2><p id="1318" class="pw-post-body-paragraph kr ks iq kt b ku mk jr kw kx ml ju kz la mm lc ld le mn lg lh li mo lk ll lm ij bi translated">如果服务器以400–499错误拒绝您的请求，承诺不是被<strong class="kt ir">拒绝</strong>而是被<strong class="kt ir">解决</strong>。例如，常见的401-未授权响应代码，将导致<strong class="kt ir">解决</strong>承诺。</p><p id="dbfe" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">即使您试图从中获取数据的服务器当前遇到了问题，并且返回了500内部服务器错误，promise仍然会解析并调用<code class="fe ln lo lp lq b">then</code>处理程序。不是<code class="fe ln lo lp lq b">catch</code>处理器。</p><p id="4568" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">只要服务器返回一个响应，任何响应，承诺都会解决。只有当服务器根本无法对您的请求做出响应时，承诺才会被拒绝。这可能会发生，例如，由于网络错误或如果服务器着火(戏剧性的，我知道)。</p><h1 id="2502" class="lr ls iq bd lt lu lv lw lx ly lz ma mb jw mc jx md jz me ka mf kc mg kd mh mi bi translated">这对使用fetch的开发人员来说意味着什么</h1><p id="1c8e" class="pw-post-body-paragraph kr ks iq kt b ku mk jr kw kx ml ju kz la mm lc ld le mn lg lh li mo lk ll lm ij bi translated">这意味着您不能只在<code class="fe ln lo lp lq b">then</code>处理程序中处理成功的响应(响应代码== 2xx)。您还必须处理不成功的响应(响应代码！= 2xx)。</p><p id="7f20" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">识别响应是否成功的最简单方法是使用响应对象的<code class="fe ln lo lp lq b">ok</code>属性。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nb"><img src="../Images/2f12cee0ec00f0b8e573e2bd4b475784.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KyY5deP_VC6c4qf8EdEQ5w.png"/></div></div><figcaption class="nc nd gj gh gi ne nf bd b be z dk">Response object returned from the jsonplaceholder.typicode API. Screenshot from Chrome browser console.</figcaption></figure><p id="645d" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">响应对象包含属性<code class="fe ln lo lp lq b">ok</code>，这是一个布尔值。如果响应状态代码在成功(2xx)范围内，则<code class="fe ln lo lp lq b">Response.ok</code>为真。这就是为什么一些开发人员检查状态代码是否在200和299之间，但是检查Response.ok实际上会做完全相同的事情，只是更短。</p><p id="a89c" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">如果<code class="fe ln lo lp lq b">response.ok</code>为真，我们继续一些逻辑，但是如果<strong class="kt ir">，</strong>为假，响应不成功，我们需要处理错误。一种常见的方法是抛出一个错误，这将导致调用<code class="fe ln lo lp lq b">catch</code>处理程序。通过这种方式，成功和不成功响应的处理可以通过处理程序函数分开，并且<code class="fe ln lo lp lq b">catch</code>处理程序可以一起处理不成功响应和拒绝承诺。</p><pre class="kg kh ki kj gt ng lq nh bn ni nj bi"><span id="a87a" class="nk ls iq lq b be nl nm l nn no">fetch("https://jsonplaceholder.typicode.com/todos")<br/>.then(response =&gt; {<br/>    if (response.ok) {<br/>        console.log(response); // do something with successful response<br/>    }<br/>    else {<br/>        throw new Error(`HTTP error, status = ${response.status}`);<br/>    }<br/>})<br/>.catch(error =&gt; {<br/>    console.error(error);<br/>})</span></pre><p id="bb1e" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">实际上，这是可行的，因为<code class="fe ln lo lp lq b">then</code>方法本身也返回一个承诺。抛出一个错误会导致该承诺被拒绝，并导致<code class="fe ln lo lp lq b">catch</code>被调用。关于承诺和错误处理的更多细节，请查看这个有用的<a class="ae np" href="https://javascript.info/promise-error-handling" rel="noopener ugc nofollow" target="_blank">资源</a>。</p><h1 id="7757" class="lr ls iq bd lt lu lv lw lx ly lz ma mb jw mc jx md jz me ka mf kc mg kd mh mi bi translated">外卖</h1><p id="1c58" class="pw-post-body-paragraph kr ks iq kt b ku mk jr kw kx ml ju kz la mm lc ld le mn lg lh li mo lk ll lm ij bi translated">重要的一点是，在执行假设成功响应的代码之前，总是检查<code class="fe ln lo lp lq b">then</code>处理程序中的<code class="fe ln lo lp lq b">response.ok</code>。如果您想在catch语句中进一步处理不成功的响应，抛出一个错误也很有帮助。</p></div><div class="ab cl nq nr hu ns" role="separator"><span class="nt bw bk nu nv nw"/><span class="nt bw bk nu nv nw"/><span class="nt bw bk nu nv"/></div><div class="ij ik il im in"><p id="5c29" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">感谢阅读！如何处理来自fetch api的不成功响应？请在评论中告诉我。如果你学到了一些新的东西，请关注我的媒体来获取更多的网站开发内容。</p><p id="1143" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated"><em class="nx">更多内容请看</em><a class="ae np" href="https://plainenglish.io/" rel="noopener ugc nofollow" target="_blank"><strong class="kt ir"><em class="nx">plain English . io</em></strong></a><em class="nx">。报名参加我们的</em> <a class="ae np" href="http://newsletter.plainenglish.io/" rel="noopener ugc nofollow" target="_blank"> <strong class="kt ir"> <em class="nx">免费周报</em> </strong> </a> <em class="nx">。关注我们关于</em><a class="ae np" href="https://twitter.com/inPlainEngHQ" rel="noopener ugc nofollow" target="_blank"><strong class="kt ir"><em class="nx">Twitter</em></strong></a><a class="ae np" href="https://www.linkedin.com/company/inplainenglish/" rel="noopener ugc nofollow" target="_blank"><strong class="kt ir"><em class="nx">LinkedIn</em></strong></a><em class="nx"/><a class="ae np" href="https://www.youtube.com/channel/UCtipWUghju290NWcn8jhyAw" rel="noopener ugc nofollow" target="_blank"><strong class="kt ir"><em class="nx">YouTube</em></strong></a><em class="nx"/><a class="ae np" href="https://discord.gg/GtDtUAvyhW" rel="noopener ugc nofollow" target="_blank"><strong class="kt ir"><em class="nx">不和</em> </strong> </a> <em class="nx">。</em></p></div></div>    
</body>
</html>