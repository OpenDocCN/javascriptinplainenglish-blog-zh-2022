<html>
<head>
<title>Getting Started with Tyk API Gateway with Keycloak</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Keycloak开始使用Tyk API网关</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/getting-started-to-tyk-api-gateway-with-keycloak-16307435584a?source=collection_archive---------3-----------------------#2022-02-08">https://javascript.plainenglish.io/getting-started-to-tyk-api-gateway-with-keycloak-16307435584a?source=collection_archive---------3-----------------------#2022-02-08</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><div class=""><h2 id="ed12" class="pw-subtitle-paragraph jk im in bd b jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb dk translated">如何使用Tyk Gateway(开源)保护Node.js API，在没有来自Keycloak实例的OIDC令牌的情况下拒绝对它的访问。</h2></div><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi kc"><img src="../Images/fbd736e36027940e17539b819f5d0045.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UrYV7rtayGBndA-bbY_nlw.jpeg"/></div></div><figcaption class="ko kp gj gh gi kq kr bd b be z dk">Basic Architecture — TYK with Keycloak</figcaption></figure><h1 id="8842" class="ks kt in bd ku kv kw kx ky kz la lb lc jt ld ju le jw lf jx lg jz lh ka li lj bi translated">介绍</h1><p id="91d2" class="pw-post-body-paragraph lk ll in lm b ln lo jo lp lq lr jr ls lt lu lv lw lx ly lz ma mb mc md me mf ig bi translated">在本文中，我们的目的是理解如何使用<a class="ae mg" href="https://tyk.io/" rel="noopener ugc nofollow" target="_blank"> Tyk </a>来保护我们自己的<a class="ae mg" href="https://github.com/santoshshinde2012/node-boilerplate" rel="noopener ugc nofollow" target="_blank"> Node.js API </a>。Tyk将阻止请求，除非它们带有由<a class="ae mg" href="https://www.keycloak.org/" rel="noopener ugc nofollow" target="_blank"> Keycloak </a>提供的ID令牌或有效签名的密钥。</p><p id="fa57" class="pw-post-body-paragraph lk ll in lm b ln mh jo lp lq mi jr ls lt mj lv lw lx mk lz ma mb ml md me mf ig bi translated">那些不熟悉Tyk网关并希望了解该网关的基本特性的人可以参考我以前的文章，请参见下面的链接。</p><div class="mm mn gp gr mo mp"><a rel="noopener  ugc nofollow" target="_blank" href="/getting-started-with-tyk-open-source-on-your-local-machine-6468d1c4f7b"><div class="mq ab fo"><div class="mr ab ms cl cj mt"><h2 class="bd io gy z fp mu fr fs mv fu fw im bi translated">在本地机器上开始使用Tyk API Gateway</h2><div class="mw l"><h3 class="bd b gy z fp mu fr fs mv fu fw dk translated">用Node.js和Express创建一个简单的API端点，然后创建一个本地TYK网关(开源)。</h3></div><div class="mx l"><p class="bd b dl z fp mu fr fs mv fu fw dk translated">javascript.plainenglish.io</p></div></div><div class="my l"><div class="mz l na nb nc my nd km mp"/></div></div></a></div><h1 id="bef3" class="ks kt in bd ku kv kw kx ky kz la lb lc jt ld ju le jw lf jx lg jz lh ka li lj bi translated">开始安装</h1><p id="d927" class="pw-post-body-paragraph lk ll in lm b ln lo jo lp lq lr jr ls lt lu lv lw lx ly lz ma mb mc md me mf ig bi translated">我们将使用docker-compose在本地安装TYK &amp; Keycloak，这是最快的方法。</p><p id="41e5" class="pw-post-body-paragraph lk ll in lm b ln mh jo lp lq mi jr ls lt mj lv lw lx mk lz ma mb ml md me mf ig bi translated"><strong class="lm io">步骤1 —克隆docker-compose存储库</strong></p><div class="mm mn gp gr mo mp"><a href="https://github.com/santoshshinde2012/tyk-keycloak-demo" rel="noopener  ugc nofollow" target="_blank"><div class="mq ab fo"><div class="mr ab ms cl cj mt"><h2 class="bd io gy z fp mu fr fs mv fu fw im bi translated">GitHub-Santosh shinde 2012/tyk-key cloak-demo:Basic demo将tyk gateway开源与…</h2><div class="mw l"><h3 class="bd b gy z fp mu fr fs mv fu fw dk translated">此时您不能执行该操作。您已使用另一个标签页或窗口登录。您已在另一个选项卡中注销，或者…</h3></div><div class="mx l"><p class="bd b dl z fp mu fr fs mv fu fw dk translated">github.com</p></div></div><div class="my l"><div class="ne l na nb nc my nd km mp"/></div></div></a></div><pre class="kd ke kf kg gt nf ng nh ni aw nj bi"><span id="ecb7" class="nk kt in ng b gy nl nm l nn no">git clone <a class="ae mg" href="https://github.com/santoshshinde2012/tyk-keycloak-demo.git" rel="noopener ugc nofollow" target="_blank">https://github.com/santoshshinde2012/tyk-keycloak-demo.git</a></span></pre><p id="4704" class="pw-post-body-paragraph lk ll in lm b ln mh jo lp lq mi jr ls lt mj lv lw lx mk lz ma mb ml md me mf ig bi translated"><strong class="lm io">步骤2—更新本地机器中的主机条目</strong></p><p id="0be2" class="pw-post-body-paragraph lk ll in lm b ln mh jo lp lq mi jr ls lt mj lv lw lx mk lz ma mb ml md me mf ig bi translated">请将以下几行添加到您的<code class="fe np nq nr ng b">/etc/hosts</code>:</p><pre class="kd ke kf kg gt nf ng nh ni aw nj bi"><span id="49cd" class="nk kt in ng b gy nl nm l nn no">127.0.0.1       oidc<br/>127.0.0.1       tyk</span></pre><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi ns"><img src="../Images/09e6962fd9f18f0890d5c742ca24a1e2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*soAX9j_TlEJDmayF0_glQQ.png"/></div></div><figcaption class="ko kp gj gh gi kq kr bd b be z dk"><code class="fe np nq nr ng b">/etc/hosts</code></figcaption></figure><p id="dd2e" class="pw-post-body-paragraph lk ll in lm b ln mh jo lp lq mi jr ls lt mj lv lw lx mk lz ma mb ml md me mf ig bi translated"><strong class="lm io">第3步—转到新目录</strong></p><pre class="kd ke kf kg gt nf ng nh ni aw nj bi"><span id="4eab" class="nk kt in ng b gy nl nm l nn no">cd <a class="ae mg" href="https://github.com/santoshshinde2012/tyk-keycloak-demo.git" rel="noopener ugc nofollow" target="_blank">tyk-keycloak-demo</a></span></pre><p id="8252" class="pw-post-body-paragraph lk ll in lm b ln mh jo lp lq mi jr ls lt mj lv lw lx mk lz ma mb ml md me mf ig bi translated"><strong class="lm io">步骤4—部署Tyk网关、Redis和Keycloak </strong></p><p id="681e" class="pw-post-body-paragraph lk ll in lm b ln mh jo lp lq mi jr ls lt mj lv lw lx mk lz ma mb ml md me mf ig bi translated"><a class="ae mg" href="https://raw.githubusercontent.com/santoshshinde2012/tyk-keycloak-demo/master/docker-compose.yml" rel="noopener ugc nofollow" target="_blank">https://raw . githubusercontent . com/Santosh shinde 2012/tyk-key cloak-demo/master/docker-compose . yml</a></p><pre class="kd ke kf kg gt nf ng nh ni aw nj bi"><span id="3c9a" class="nk kt in ng b gy nl nm l nn no">docker-compose up -d</span><span id="f194" class="nk kt in ng b gy nt nm l nn no">OR</span><span id="6770" class="nk kt in ng b gy nt nm l nn no">docker-compose up</span></pre><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi nu"><img src="../Images/22ecaf94b261dbb99c384ce8a708a57c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yZAA3gvs5T9SUQQnUmlUQQ.png"/></div></div><figcaption class="ko kp gj gh gi kq kr bd b be z dk">Deploy Tyk Gateway, Redis and Keycloak</figcaption></figure><p id="1c87" class="pw-post-body-paragraph lk ll in lm b ln mh jo lp lq mi jr ls lt mj lv lw lx mk lz ma mb ml md me mf ig bi translated"><strong class="lm io">步骤5—测试网关&amp; Keycloak是否正在运行</strong></p><p id="ef00" class="pw-post-body-paragraph lk ll in lm b ln mh jo lp lq mi jr ls lt mj lv lw lx mk lz ma mb ml md me mf ig bi translated">tyk gateway API的Swagger文档可在此处获得<a class="ae mg" href="https://tyk.io/docs/tyk-gateway-api/" rel="noopener ugc nofollow" target="_blank">https://tyk.io/docs/tyk-gateway-api</a>。下一步，我们将使用TYK网关API，Keycloak用户界面，我们将使用p <a class="ae mg" href="https://www.postman.com/" rel="noopener ugc nofollow" target="_blank"> ostman </a>客户端进行API调用。</p><pre class="kd ke kf kg gt nf ng nh ni aw nj bi"><span id="9d0c" class="nk kt in ng b gy nl nm l nn no">API - http://localhost:8000/hello<br/>METHOD - GET</span></pre><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi nv"><img src="../Images/bb680b36ec7217205213e0237138d303.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1CPlthyhveC3k3CkpKeFIA.jpeg"/></div></div><figcaption class="ko kp gj gh gi kq kr bd b be z dk"><strong class="bd nw">Test the Gateway is running or not</strong></figcaption></figure><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi kc"><img src="../Images/cfcaf8c8aba7a790e91ec3df2f826553.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UGTsDwRhd_1cR07EcBJVqw.jpeg"/></div></div><figcaption class="ko kp gj gh gi kq kr bd b be z dk"><strong class="bd nw">Test the Keyclaok is running or not</strong></figcaption></figure><p id="815f" class="pw-post-body-paragraph lk ll in lm b ln mh jo lp lq mi jr ls lt mj lv lw lx mk lz ma mb ml md me mf ig bi translated"><strong class="lm io">步骤6—创建演示Node.js应用程序</strong></p><p id="e42a" class="pw-post-body-paragraph lk ll in lm b ln mh jo lp lq mi jr ls lt mj lv lw lx mk lz ma mb ml md me mf ig bi translated">对于本文，我们将使用已经使用TypeScript和Express创建的<a class="ae mg" href="https://github.com/santoshshinde2012/node-boilerplate" rel="noopener ugc nofollow" target="_blank"> Node.js样板代码</a>。</p><div class="mm mn gp gr mo mp"><a href="https://github.com/santoshshinde2012/node-boilerplate" rel="noopener  ugc nofollow" target="_blank"><div class="mq ab fo"><div class="mr ab ms cl cj mt"><h2 class="bd io gy z fp mu fr fs mv fu fw im bi translated">GitHub-Santosh shinde 2012/Node-Boilerplate:用于微服务的节点类型脚本样板…</h2><div class="mw l"><h3 class="bd b gy z fp mu fr fs mv fu fw dk translated">微服务的节点类型脚本样板。用TypeScript编写的Node.js应用程序的框架(带有安装说明…</h3></div><div class="mx l"><p class="bd b dl z fp mu fr fs mv fu fw dk translated">github.com</p></div></div><div class="my l"><div class="nx l na nb nc my nd km mp"/></div></div></a></div><pre class="kd ke kf kg gt nf ng nh ni aw nj bi"><span id="b29d" class="nk kt in ng b gy nl nm l nn no">// clone the application<br/>git clone <a class="ae mg" href="https://github.com/santoshshinde2012/node-boilerplate.git" rel="noopener ugc nofollow" target="_blank">https://github.com/santoshshinde2012/node-boilerplate.git</a></span><span id="8fe6" class="nk kt in ng b gy nt nm l nn no">// change to the new directory<br/>cd node-boilerplate</span><span id="5653" class="nk kt in ng b gy nt nm l nn no">// Run the application using docker-compose<br/>docker-compose up</span></pre><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi ny"><img src="../Images/c2d7fc2750aa5418dd016b23e231b071.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Y7GMhqxp1KMxC-ZGnZqIzQ.png"/></div></div><figcaption class="ko kp gj gh gi kq kr bd b be z dk">Run the node js application</figcaption></figure><p id="536a" class="pw-post-body-paragraph lk ll in lm b ln mh jo lp lq mi jr ls lt mj lv lw lx mk lz ma mb ml md me mf ig bi translated">有关更多信息，请参考以下文章:</p><div class="mm mn gp gr mo mp"><a rel="noopener  ugc nofollow" target="_blank" href="/skeleton-for-node-js-apps-written-in-typescript-444fa1695b30"><div class="mq ab fo"><div class="mr ab ms cl cj mt"><h2 class="bd io gy z fp mu fr fs mv fu fw im bi translated">用TypeScript编写的Node.js应用程序的框架</h2><div class="mw l"><h3 class="bd b gy z fp mu fr fs mv fu fw dk translated">包含ESLint、Prettier和Husky的设置说明。</h3></div><div class="mx l"><p class="bd b dl z fp mu fr fs mv fu fw dk translated">javascript.plainenglish.io</p></div></div><div class="my l"><div class="nz l na nb nc my nd km mp"/></div></div></a></div><p id="fba7" class="pw-post-body-paragraph lk ll in lm b ln mh jo lp lq mi jr ls lt mj lv lw lx mk lz ma mb ml md me mf ig bi translated"><strong class="lm io">第七步——设置钥匙锁领域和客户端</strong></p><p id="b412" class="pw-post-body-paragraph lk ll in lm b ln mh jo lp lq mi jr ls lt mj lv lw lx mk lz ma mb ml md me mf ig bi translated">如果你是第一次接触<a class="ae mg" href="https://www.keycloak.org/documentation" rel="noopener ugc nofollow" target="_blank">键盘锁</a>，那么请浏览下面的文章了解更多细节。</p><div class="mm mn gp gr mo mp"><a rel="noopener  ugc nofollow" target="_blank" href="/introduction-to-building-an-effective-identity-and-access-management-architecture-with-keycloak-4c1645124d83"><div class="mq ab fo"><div class="mr ab ms cl cj mt"><h2 class="bd io gy z fp mu fr fs mv fu fw im bi translated">使用Keycloak构建有效的身份和访问管理架构简介</h2><div class="mw l"><h3 class="bd b gy z fp mu fr fs mv fu fw dk translated">Keycloak是一个开源软件产品，允许使用身份和访问管理进行单点登录，旨在为现代…</h3></div><div class="mx l"><p class="bd b dl z fp mu fr fs mv fu fw dk translated">javascript.plainenglish.io</p></div></div><div class="my l"><div class="oa l na nb nc my nd km mp"/></div></div></a></div><p id="647f" class="pw-post-body-paragraph lk ll in lm b ln mh jo lp lq mi jr ls lt mj lv lw lx mk lz ma mb ml md me mf ig bi translated">1.登录到Keycloak —要登录，我们将使用下面的凭据，这些凭据已经添加到docker-compose中。</p><pre class="kd ke kf kg gt nf ng nh ni aw nj bi"><span id="d40f" class="nk kt in ng b gy nl nm l nn no">KEYCLOAK_USER: kcadmin<br/>KEYCLOAK_PASSWORD: admin</span></pre><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi ob"><img src="../Images/24b35cadae78ccf651fa299fe1f12a0d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bCydgXe3X2rORBcjddnw9A.png"/></div></div><figcaption class="ko kp gj gh gi kq kr bd b be z dk">Keycloak Login</figcaption></figure><p id="0a42" class="pw-post-body-paragraph lk ll in lm b ln mh jo lp lq mi jr ls lt mj lv lw lx mk lz ma mb ml md me mf ig bi translated">2.创建领域—领域管理一组用户、凭据、角色和组。用户属于并登录到一个领域。领域相互隔离，只能管理和验证它们控制的用户。</p><pre class="kd ke kf kg gt nf ng nh ni aw nj bi"><span id="810c" class="nk kt in ng b gy nl nm l nn no">Name : tyk</span></pre><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi ob"><img src="../Images/c89a4a43bb76cdd6e840e61087110fef.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6iztvEwAys6ppNKw6vQRfg.png"/></div></div><figcaption class="ko kp gj gh gi kq kr bd b be z dk">Create Realm</figcaption></figure><p id="0d51" class="pw-post-body-paragraph lk ll in lm b ln mh jo lp lq mi jr ls lt mj lv lw lx mk lz ma mb ml md me mf ig bi translated">3.添加用户——一旦我们创建了一个新领域，我们就可以添加一个新用户</p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi ob"><img src="../Images/f1f992f022780de31cc0ccfe157009a9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pqrpev0yR2nsvbh7V62XGQ.png"/></div></div><figcaption class="ko kp gj gh gi kq kr bd b be z dk">create new user</figcaption></figure><p id="6021" class="pw-post-body-paragraph lk ll in lm b ln mh jo lp lq mi jr ls lt mj lv lw lx mk lz ma mb ml md me mf ig bi translated">4.更新密码—确保更新该用户的默认密码</p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi ob"><img src="../Images/2e8f4b23b88eddecb8cd5ab4fab5e7a9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Tky3gsYHBwTXJXTJl7jQ-A.png"/></div></div><figcaption class="ko kp gj gh gi kq kr bd b be z dk">update password</figcaption></figure><p id="f701" class="pw-post-body-paragraph lk ll in lm b ln mh jo lp lq mi jr ls lt mj lv lw lx mk lz ma mb ml md me mf ig bi translated">5.创建客户端—客户端是可以请求Keycloak对用户进行身份验证的实体。大多数情况下，客户端是希望使用Keycloak来保护自己并提供单点登录解决方案的应用程序和服务。</p><p id="830b" class="pw-post-body-paragraph lk ll in lm b ln mh jo lp lq mi jr ls lt mj lv lw lx mk lz ma mb ml md me mf ig bi translated">这里我们将创建两个客户端，一个用于API认证流，另一个用于网关。我们的网关客户端已经被映射到资源客户端，因此该条目被添加到我们的JWT令牌中。</p><pre class="kd ke kf kg gt nf ng nh ni aw nj bi"><span id="7c93" class="nk kt in ng b gy nl nm l nn no">Gateway Client Name : tyk-gateway<br/>Resource Client Name : tyk-client</span></pre><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi oc"><img src="../Images/1239f36ab75e66682d8d844db7e507dc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*l8DC3puPN8zIonHLaVkGlQ.png"/></div></div><figcaption class="ko kp gj gh gi kq kr bd b be z dk">tyk-gateway</figcaption></figure><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi od"><img src="../Images/a6b19fdb1296071bc81e85dfc893e580.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tc11adNP2OfqsJsK6pJKsQ.png"/></div></div><figcaption class="ko kp gj gh gi kq kr bd b be z dk">tyk-client</figcaption></figure><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi ob"><img src="../Images/3032600f6d07db119c4e1f6d3f4176d1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2gGnpFkmtoQv5iVLkR6TyQ.png"/></div></div><figcaption class="ko kp gj gh gi kq kr bd b be z dk">create protocol mapper from Mappers tab</figcaption></figure><p id="5f9b" class="pw-post-body-paragraph lk ll in lm b ln mh jo lp lq mi jr ls lt mj lv lw lx mk lz ma mb ml md me mf ig bi translated"><strong class="lm io">第8步—添加/创建新的API </strong></p><p id="9f7e" class="pw-post-body-paragraph lk ll in lm b ln mh jo lp lq mi jr ls lt mj lv lw lx mk lz ma mb ml md me mf ig bi translated">确保我们知道我们的API secret，我们的Tyk网关API secret存储在您的tyk.conf文件中，该属性称为secret，您将需要使用它作为名为<strong class="lm io"> x-tyk-authorization </strong>的头来调用网关API。如果您正在使用Docker-compose，那么默认的secrete是<code class="fe np nq nr ng b"><strong class="lm io">foo</strong></code>，它可以在Docker compose文件的环境部分找到。</p><pre class="kd ke kf kg gt nf ng nh ni aw nj bi"><span id="fb07" class="nk kt in ng b gy nl nm l nn no">environment:<br/>      - TYK_GW_SECRET=foo</span></pre><p id="55a0" class="pw-post-body-paragraph lk ll in lm b ln mh jo lp lq mi jr ls lt mj lv lw lx mk lz ma mb ml md me mf ig bi translated">我们将使用POST API <code class="fe np nq nr ng b">{{baseUrl}}/tyk/apis</code>创建一个API，这里的基本URL是<code class="fe np nq nr ng b">http://localhost:8080</code>。头<code class="fe np nq nr ng b">x-tyk-authorization: foo</code>和正文如下。</p><ul class=""><li id="8229" class="oe of in lm b ln mh lq mi lt og lx oh mb oi mf oj ok ol om bi translated"><code class="fe np nq nr ng b">proxy.listen_path</code>:监听的路径，如<code class="fe np nq nr ng b">/api</code>或<code class="fe np nq nr ng b">/</code>。在Tyk被配置为运行的端口上，任何进入主机的请求都将应用API定义中定义的规则。我们的演示将基于我们系统的状态API端点<code class="fe np nq nr ng b"><a class="ae mg" href="http://21b1-103-109-12-32.ngrok.io/api/status/system" rel="noopener ugc nofollow" target="_blank">/w</a>eb.</code></li><li id="342c" class="oe of in lm b ln on lq oo lt op lx oq mb or mf oj ok ol om bi translated"><code class="fe np nq nr ng b">proxy.target_url</code>:这定义了如果请求通过了Tyk中的所有检查，它应该被代理到的目标URL。示例— <code class="fe np nq nr ng b"><a class="ae mg" href="http://host.docker.internal:3146/web" rel="noopener ugc nofollow" target="_blank">http://host.docker.internal:3146/w</a>eb.</code></li></ul><p id="509b" class="pw-post-body-paragraph lk ll in lm b ln mh jo lp lq mi jr ls lt mj lv lw lx mk lz ma mb ml md me mf ig bi translated"><strong class="lm io">设置OIDC </strong></p><p id="d79d" class="pw-post-body-paragraph lk ll in lm b ln mh jo lp lq mi jr ls lt mj lv lw lx mk lz ma mb ml md me mf ig bi translated">要设置API定义以使用OIDC，请将以下块添加到定义中，并确保没有启用其他访问方法:</p><pre class="kd ke kf kg gt nf ng nh ni aw nj bi"><span id="e186" class="nk kt in ng b gy nl nm l nn no">"use_openid": true,<br/>"openid_options": {<br/>  "providers": [<br/>    {<br/>      "issuer": "<!-- -->http://oidc:8080/auth/realms/tyk<!-- -->",<br/>      "client_ids": {<br/>        "<!-- -->dHlrLWdhdGV3YXk<!-- -->=": "<!-- -->admin<!-- -->"<br/>      }<br/>    }<br/>  ],<br/>    "segregate_by_client": false<br/>}</span></pre><ul class=""><li id="7d1b" class="oe of in lm b ln mh lq mi lt og lx oh mb oi mf oj ok ol om bi translated"><code class="fe np nq nr ng b">use_openid</code>:设置为true以启用OpenID连接检查。</li><li id="a8ed" class="oe of in lm b ln on lq oo lt op lx oq mb or mf oj ok ol om bi translated"><code class="fe np nq nr ng b">openid_options.providers</code>:授权提供商及其客户端id/匹配策略的列表。</li><li id="af00" class="oe of in lm b ln on lq oo lt op lx oq mb or mf oj ok ol om bi translated"><code class="fe np nq nr ng b">openid_options.providers.client_ids</code>:应用于其用户的客户端id和策略id列表。</li><li id="1f04" class="oe of in lm b ln on lq oo lt op lx oq mb or mf oj ok ol om bi translated"><strong class="lm io">注意:</strong>客户端id是Base64编码的，所以映射是<code class="fe np nq nr ng b">base64(clientid):policy_id</code>。当匹配的idP/客户端ID中出现有效用户时，此条目中列出的策略将跨OIDC ID令牌应用于其令牌。</li><li id="cbb2" class="oe of in lm b ln on lq oo lt op lx oq mb or mf oj ok ol om bi translated"><code class="fe np nq nr ng b">openid_options.segregate_by_client</code>:启用此项可将策略应用于用户ID和客户端ID的组合。例如:</li><li id="e3fd" class="oe of in lm b ln on lq oo lt op lx oq mb or mf oj ok ol om bi translated"><strong class="lm io">如果禁用</strong>:当Alice使用移动应用程序登录API时，Tyk会应用与她通过web应用程序或桌面客户端登录时相同的速率限制和访问规则。</li><li id="ba14" class="oe of in lm b ln on lq oo lt op lx oq mb or mf oj ok ol om bi translated"><strong class="lm io">如果启用</strong>:当Alice使用移动应用程序登录API时，Tyk会应用与她通过web应用程序或桌面客户端登录时不同的速率限制和访问规则。事实上，每个客户端和用户组合都有自己的内部表示。</li></ul><div class="mm mn gp gr mo mp"><a href="https://tyk.io/docs/advanced-configuration/integrate/api-auth-mode/open-id-connect/" rel="noopener  ugc nofollow" target="_blank"><div class="mq ab fo"><div class="mr ab ms cl cj mt"><h2 class="bd io gy z fp mu fr fs mv fu fw im bi translated">与OIDC融合</h2><div class="mw l"><h3 class="bd b gy z fp mu fr fs mv fu fw dk translated">Tyk支持任何符合标准的OIDC提供商提供的OpenID Connect (OIDC)身份令牌…</h3></div><div class="mx l"><p class="bd b dl z fp mu fr fs mv fu fw dk translated">tyk.io</p></div></div><div class="my l"><div class="os l na nb nc my nd km mp"/></div></div></a></div><p id="e395" class="pw-post-body-paragraph lk ll in lm b ln mh jo lp lq mi jr ls lt mj lv lw lx mk lz ma mb ml md me mf ig bi translated">请在下面找到我们将要使用的示例</p><pre class="kd ke kf kg gt nf ng nh ni aw nj bi"><span id="0f7c" class="nk kt in ng b gy nl nm l nn no">{<br/> "name": "web",<br/> "slug": "web",<br/> "api_id": "web",<br/> "org_id": "gateway_demo",<br/> "active": true,<br/> "use_openid": true,<br/> "openid_options": {<br/>   "providers": [<br/>        {<br/>           "issuer": "http://oidc:8080/auth/realms/tyk",<br/>           "client_ids": {<br/>               "dHlrLWdhdGV3YXk=": "admin"<br/>            }<br/>        }<br/>    ],<br/>    "segregate_by_client": false<br/> },<br/> "version_data": {<br/> "not_versioned": true,<br/> "versions": {<br/>     "Default": {<br/>        "name": "Default"<br/>     }<br/>  }<br/> },<br/> "proxy": {<br/>   "listen_path": "/web",<br/>    "target_url": "http://host.docker.internal:3146/web",<br/>    "strip_listen_path": true<br/>  }<br/>}</span></pre><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi ot"><img src="../Images/fa317f92d134a9ae22d9b97631bd4217.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*TJafEyDt_ezxgQmBRg8Aiw.png"/></div></div><figcaption class="ko kp gj gh gi kq kr bd b be z dk">create new api</figcaption></figure><p id="4352" class="pw-post-body-paragraph lk ll in lm b ln mh jo lp lq mi jr ls lt mj lv lw lx mk lz ma mb ml md me mf ig bi translated"><strong class="lm io">第9步——重启或热重装</strong></p><p id="3efd" class="pw-post-body-paragraph lk ll in lm b ln mh jo lp lq mi jr ls lt mj lv lw lx mk lz ma mb ml md me mf ig bi translated">一旦我们创建了API文件，我们将需要重新启动Tyk网关或发出热重新加载命令:</p><pre class="kd ke kf kg gt nf ng nh ni aw nj bi"><span id="cc5d" class="nk kt in ng b gy nl nm l nn no">API - <a class="ae mg" href="http://localhost:8080/tyk/reload/group" rel="noopener ugc nofollow" target="_blank">http://localhost:8080/tyk/reload/group</a><br/>HEADER - `x-tyk-authorization: foo`<br/>METHOD - GET</span></pre><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi ou"><img src="../Images/47d113b2d8bfd8ccadedd324adfe7117.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*IRJL22B66e07EuXk.png"/></div></div><figcaption class="ko kp gj gh gi kq kr bd b be z dk">reload the API</figcaption></figure><p id="4281" class="pw-post-body-paragraph lk ll in lm b ln mh jo lp lq mi jr ls lt mj lv lw lx mk lz ma mb ml md me mf ig bi translated"><strong class="lm io">步骤10—尝试通过网关访问API</strong></p><p id="aaaf" class="pw-post-body-paragraph lk ll in lm b ln mh jo lp lq mi jr ls lt mj lv lw lx mk lz ma mb ml md me mf ig bi translated">我们在这里仅用一个API <code class="fe np nq nr ng b"><a class="ae mg" href="http://tyk:8000/test-api" rel="noopener ugc nofollow" target="_blank">http://tyk:8000/w</a>eb</code>配置了Tyk，它只是将我们定向到我们的节点js应用程序。如果我们试图在没有授权头的情况下访问API，那么它将返回带有<strong class="lm io"> 401 </strong>状态码的<strong class="lm io">未授权</strong>。</p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi ov"><img src="../Images/25385565ab4a9862ae40ebe7b8d568f8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*80FlJ1uQz0BLmGKvypoOEw.png"/></div></div><figcaption class="ko kp gj gh gi kq kr bd b be z dk"><strong class="bd nw">Try to access API via the gateway</strong></figcaption></figure><p id="708e" class="pw-post-body-paragraph lk ll in lm b ln mh jo lp lq mi jr ls lt mj lv lw lx mk lz ma mb ml md me mf ig bi translated"><strong class="lm io">步骤11—创建访问令牌</strong></p><p id="b9db" class="pw-post-body-paragraph lk ll in lm b ln mh jo lp lq mi jr ls lt mj lv lw lx mk lz ma mb ml md me mf ig bi translated">在Keycloak中，我们可以为网关使用仅承载客户端—它仅用于匹配JWT中的观众。这就是为什么有两个客户端——一个用于登录，一个用于网关。</p><pre class="kd ke kf kg gt nf ng nh ni aw nj bi"><span id="3c1d" class="nk kt in ng b gy nl nm l nn no">API - <a class="ae mg" href="http://oidc:8080/auth/realms/tyk/protocol/openid-connect/token" rel="noopener ugc nofollow" target="_blank">http://oidc:8080/auth/realms/tyk/protocol/openid-connect/token</a></span><span id="679e" class="nk kt in ng b gy nt nm l nn no">Authorization - <br/>    username - tyk-client<br/>    password - client secret of tyk-client </span><span id="77bc" class="nk kt in ng b gy nt nm l nn no">Content-Type - application/x-www-form-urlencoded</span><span id="1955" class="nk kt in ng b gy nt nm l nn no">METHOD - POST</span><span id="fb21" class="nk kt in ng b gy nt nm l nn no">Body -</span><span id="f3c5" class="nk kt in ng b gy nt nm l nn no">grant_type:password<br/>username:santosh<br/>password:pass1<br/>redirect_uri:<a class="ae mg" href="http://tyk:3000/auth/oidc" rel="noopener ugc nofollow" target="_blank">http://tyk:3000/auth/oidc</a></span></pre><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi nv"><img src="../Images/922a76513e492f31490c9125525f2244.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*su4jBK96istcxyRqzmEVZw.jpeg"/></div></div><figcaption class="ko kp gj gh gi kq kr bd b be z dk"><strong class="bd nw">Create Access Token</strong></figcaption></figure><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi kc"><img src="../Images/b3435f6730b11a1b296d402ef93d577b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QNRV8SK3_MpuPkyRdndWBw.jpeg"/></div></div><figcaption class="ko kp gj gh gi kq kr bd b be z dk"><strong class="bd nw">Create Access Token</strong></figcaption></figure><p id="69b9" class="pw-post-body-paragraph lk ll in lm b ln mh jo lp lq mi jr ls lt mj lv lw lx mk lz ma mb ml md me mf ig bi translated"><strong class="lm io">步骤12 —通过网关访问API</strong></p><p id="68a9" class="pw-post-body-paragraph lk ll in lm b ln mh jo lp lq mi jr ls lt mj lv lw lx mk lz ma mb ml md me mf ig bi translated">我们现在可以通过Tyk网关访问REST API端点。这里我们需要从上一个API接收到的密钥。</p><pre class="kd ke kf kg gt nf ng nh ni aw nj bi"><span id="2f1e" class="nk kt in ng b gy nl nm l nn no">API - http://localhost:8080/web<br/>METHOD - GET<br/>Header - Authorization: Bearer 1d1e45a4ffae843d39833a4412ce80a97</span></pre><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi ow"><img src="../Images/23980c9b2ac151c121f31f9c22a99781.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cZZLXdOMqrEOKXkb0JInWA.png"/></div></div><figcaption class="ko kp gj gh gi kq kr bd b be z dk">API via gateway with Authorization header</figcaption></figure><p id="06b0" class="pw-post-body-paragraph lk ll in lm b ln mh jo lp lq mi jr ls lt mj lv lw lx mk lz ma mb ml md me mf ig bi translated">感谢阅读，请分享你的评论，如果这个博客增加了你的学习价值，请鼓掌。</p><p id="1d49" class="pw-post-body-paragraph lk ll in lm b ln mh jo lp lq mi jr ls lt mj lv lw lx mk lz ma mb ml md me mf ig bi translated"><em class="ox">更多内容看</em> <a class="ae mg" href="http://plainenglish.io/" rel="noopener ugc nofollow" target="_blank"> <strong class="lm io"> <em class="ox">说白了。报名参加我们的</em> <a class="ae mg" href="http://newsletter.plainenglish.io/" rel="noopener ugc nofollow" target="_blank"> <strong class="lm io"> <em class="ox">免费周报</em> </strong> </a> <em class="ox">。在我们的</em> <a class="ae mg" href="https://discord.gg/GtDtUAvyhW" rel="noopener ugc nofollow" target="_blank"> <strong class="lm io"> <em class="ox">社区不和谐</em> </strong> </a> <em class="ox">获得独家获取写作机会和建议。</em></strong></a></p></div></div>    
</body>
</html>