<html>
<head>
<title>Host a NestJS App on Firebase Functions: The Complete Guide</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">主持一个关于Firebase函数的NestJS应用程序:完全指南</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/nestjs-with-firebase-the-complete-guide-aa0ade41cdef?source=collection_archive---------0-----------------------#2022-08-22">https://javascript.plainenglish.io/nestjs-with-firebase-the-complete-guide-aa0ade41cdef?source=collection_archive---------0-----------------------#2022-08-22</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><div class=""><h2 id="a651" class="pw-subtitle-paragraph jk im in bd b jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb dk translated">使用Firebase身份验证和Firestore在Firebase函数上托管NestJS应用程序的分步指南。</h2></div><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi kc"><img src="../Images/9f1d6bf0926598c51d6b349535df8848.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nfqnmZWzNmzk-p8TEwIggQ.jpeg"/></div></div></figure><p id="2df7" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">在本文中，我将向您提供使用NestJS和Firebase创建API所需的所有信息，包括在Firebase函数上托管NestJS应用程序、使用Firebase身份验证和Firestore，让我们开始吧。</p><p id="9240" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated"><em class="lk">注意:我假设在本文中你已经知道了NestJS和Firebase(但只是理解本文所需的基础知识)，所以我不会详细解释它们。本文旨在帮助您以最佳方式将两者联系起来。</em></p><p id="4225" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">下面是我们将要经历的步骤:</p><p id="ae95" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">1.<a class="ae ll" href="#c8b5" rel="noopener ugc nofollow">创建项目</a> <br/> 2。<a class="ae ll" href="#46b1" rel="noopener ugc nofollow">添加Firebase功能</a> <br/> 3。<a class="ae ll" href="#9828" rel="noopener ugc nofollow">部署到Firebase功能</a> <br/> 4。<a class="ae ll" href="#94b5" rel="noopener ugc nofollow">添加Firebase认证</a> <br/> 5。<a class="ae ll" href="#3410" rel="noopener ugc nofollow">启用CORS </a> <br/> 6。<a class="ae ll" href="#a1ef" rel="noopener ugc nofollow">连接NestJS和Firebase Admin </a> <br/> 7。增强我们的脚本以获得更好的开发者体验。<a class="ae ll" href="#44ca" rel="noopener ugc nofollow">连接Firestore </a></p></div><div class="ab cl lm ln hr lo" role="separator"><span class="lp bw bk lq lr ls"/><span class="lp bw bk lq lr ls"/><span class="lp bw bk lq lr"/></div><div class="ig ih ii ij ik"><h1 id="c8b5" class="lt lu in bd lv lw lx ly lz ma mb mc md jt me ju mf jw mg jx mh jz mi ka mj mk bi translated">1.创建项目</h1><p id="109a" class="pw-post-body-paragraph ko kp in kq b kr ml jo kt ku mm jr kw kx mn kz la lb mo ld le lf mp lh li lj ig bi translated">首先，您需要通过运行以下命令来安装NestJS和Firebase的全局包:</p><pre class="kd ke kf kg gt mq mr ms mt aw mu bi"><span id="4460" class="mv lu in mr b gy mw mx l my mz">npm install -g firebase-tools <!-- -->@nestjs/cli</span></pre><p id="e15f" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">然后创建您的项目:</p><pre class="kd ke kf kg gt mq mr ms mt aw mu bi"><span id="3daf" class="mv lu in mr b gy mw mx l my mz">nest new todo</span></pre><h1 id="46b1" class="lt lu in bd lv lw na ly lz ma nb mc md jt nc ju mf jw nd jx mh jz ne ka mj mk bi translated">2.添加Firebase函数</h1><p id="9ec9" class="pw-post-body-paragraph ko kp in kq b kr ml jo kt ku mm jr kw kx mn kz la lb mo ld le lf mp lh li lj ig bi translated">首先，你需要从<a class="ae ll" href="https://console.firebase.google.com/" rel="noopener ugc nofollow" target="_blank">https://console.firebase.google.com/</a>在Firebase中创建一个项目，然后你需要将你的计划更改为Blaze(否则，Firebase功能将无法工作)，从左侧边栏菜单点击功能，然后点击开始，直到你完成向导</p><p id="67cb" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">然后转到项目并执行以下命令:</p><pre class="kd ke kf kg gt mq mr ms mt aw mu bi"><span id="6f30" class="mv lu in mr b gy mw mx l my mz">firebase login<br/>firebase init functions</span></pre><p id="b4f5" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">然后选择<code class="fe nf ng nh mr b">Use an existing project</code>并选择您刚刚创建的项目。</p><p id="f6d7" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">然后继续。</p><pre class="kd ke kf kg gt mq mr ms mt aw mu bi"><span id="8e50" class="mv lu in mr b gy mw mx l my mz">? What language would you like to use to write Cloud Functions? TypeScript<br/>? Do you want to use ESLint to catch probable bugs and enforce style? No<br/>+  Wrote functions/package.json<br/>+  Wrote functions/tsconfig.json<br/>+  Wrote functions/src/index.ts<br/>+  Wrote functions/.gitignore<br/>? Do you want to install dependencies with npm now? No</span></pre><p id="7256" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">你会发现一个名为functions的新文件夹，里面有上面提到的文件。</p><p id="1951" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">我们只关心它里面的package.json，我们需要把它和我们拥有的主package.json合并。</p><p id="6b4f" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">为此，我们将把所有脚本从<code class="fe nf ng nh mr b">functions/package.json</code>复制到我们的主<code class="fe nf ng nh mr b">package.json</code>，除了构建和启动，因为它们已经在那里了。</p><p id="b6a3" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">然后复制引擎和主属性以及除TypeScript之外的所有依赖项(因为它已经在主<code class="fe nf ng nh mr b">package.json</code>中)。</p><p id="8566" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">然后删除<code class="fe nf ng nh mr b">functions</code>文件夹，并在项目的根目录下创建一个新文件<code class="fe nf ng nh mr b">index.ts</code>,内容如下:</p><pre class="kd ke kf kg gt mq mr ms mt aw mu bi"><span id="1396" class="mv lu in mr b gy mw mx l my mz">import { NestFactory } from '@nestjs/core';<br/>import { ExpressAdapter } from '@nestjs/platform-express';<br/>import * as express from 'express';<br/>import * as functions from 'firebase-functions';</span><span id="d9d1" class="mv lu in mr b gy ni mx l my mz">import { AppModule } from './src/app.module';</span><span id="085b" class="mv lu in mr b gy ni mx l my mz">const expressServer = express();</span><span id="1d57" class="mv lu in mr b gy ni mx l my mz">const createFunction = async (expressInstance): Promise&lt;void&gt; =&gt; {<br/>  const app = await NestFactory.create(<br/>    AppModule,<br/>    new ExpressAdapter(expressInstance),<br/>  );</span><span id="e19f" class="mv lu in mr b gy ni mx l my mz">await app.init();<br/>};</span><span id="40ed" class="mv lu in mr b gy ni mx l my mz">export const api = functions.https.onRequest(async (request, response) =&gt; {<br/>  await createFunction(expressServer);<br/>  expressServer(request, response);<br/>});</span></pre><p id="6ae0" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">然后将<code class="fe nf ng nh mr b">package.json</code>中的main改为指向<code class="fe nf ng nh mr b">dist/index.js</code>而不是<code class="fe nf ng nh mr b">lib/index.js</code>。</p><p id="bb79" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">所以，<code class="fe nf ng nh mr b">package.json</code>应该是这样的:</p><pre class="kd ke kf kg gt mq mr ms mt aw mu bi"><span id="d701" class="mv lu in mr b gy mw mx l my mz">{<br/>  "name": "todo",<br/>  "version": "0.0.1",<br/>  "description": "",<br/>  "author": "",<br/>  "private": true,<br/>  "license": "UNLICENSED",<br/>  "scripts": {<br/>    "prebuild": "rimraf dist",<br/>    "build": "nest build",<br/>    "format": "prettier --write \"src/**/*.ts\" \"test/**/*.ts\"",<br/>    "start": "nest start",<br/>    "start:dev": "nest start --watch",<br/>    "start:debug": "nest start --debug --watch",<br/>    "start:prod": "node dist/main",<br/>    "lint": "eslint \"{src,apps,libs,test}/**/*.ts\" --fix",<br/>    "test": "jest",<br/>    "test:watch": "jest --watch",<br/>    "test:cov": "jest --coverage",<br/>    "test:debug": "node --inspect-brk -r tsconfig-paths/register -r ts-node/register node_modules/.bin/jest --runInBand",<br/>    "test:e2e": "jest --config ./test/jest-e2e.json",<br/>    "serve": "npm run build &amp;&amp; firebase emulators:start --only functions",<br/>    "shell": "npm run build &amp;&amp; firebase functions:shell",<br/>    "deploy": "firebase deploy --only functions",<br/>    "logs": "firebase functions:log"<br/>  },<br/>  "engines": {<br/>    "node": "14"<br/>  },<br/>  "main": "dist/index.js",<br/>  "dependencies": {<br/>    "@nestjs/common": "^8.0.0",<br/>    "@nestjs/core": "^8.0.0",<br/>    "@nestjs/platform-express": "^8.0.0",<br/>    "reflect-metadata": "^0.1.13",<br/>    "rimraf": "^3.0.2",<br/>    "rxjs": "^7.2.0",<br/>    "firebase-admin": "^9.8.0",<br/>    "firebase-functions": "^3.14.1"<br/>  },<br/>  "devDependencies": {<br/>    "@nestjs/cli": "^8.0.0",<br/>    "@nestjs/schematics": "^8.0.0",<br/>    "@nestjs/testing": "^8.0.0",<br/>    "@types/express": "^4.17.13",<br/>    "@types/jest": "^26.0.24",<br/>    "@types/node": "^16.0.0",<br/>    "@types/supertest": "^2.0.11",<br/>    "@typescript-eslint/eslint-plugin": "^4.28.2",<br/>    "@typescript-eslint/parser": "^4.28.2",<br/>    "eslint": "^7.30.0",<br/>    "eslint-config-prettier": "^8.3.0",<br/>    "eslint-plugin-prettier": "^3.4.0",<br/>    "jest": "27.0.6",<br/>    "prettier": "^2.3.2",<br/>    "supertest": "^6.1.3",<br/>    "ts-jest": "^27.0.3",<br/>    "ts-loader": "^9.2.3",<br/>    "ts-node": "^10.0.0",<br/>    "tsconfig-paths": "^3.10.1",<br/>    "typescript": "^4.3.5",<br/>    "firebase-functions-test": "^0.2.0"<br/>  },<br/>  "jest": {<br/>    "moduleFileExtensions": [<br/>      "js",<br/>      "json",<br/>      "ts"<br/>    ],<br/>    "rootDir": "src",<br/>    "testRegex": ".*\\.spec\\.ts$",<br/>    "transform": {<br/>      "^.+\\.(t|j)s$": "ts-jest"<br/>    },<br/>    "collectCoverageFrom": [<br/>      "**/*.(t|j)s"<br/>    ],<br/>    "coverageDirectory": "../coverage",<br/>    "testEnvironment": "node"<br/>  }<br/>}</span></pre><p id="dc96" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">但是请不要复制和粘贴，因为这可能有过时的依赖和/或来自NestJS或Firebase的一些其他更改，我们需要合并生成的两个<code class="fe nf ng nh mr b">package.json</code>。</p><p id="1252" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">最后但并非最不重要的是修改<code class="fe nf ng nh mr b">firebase.json</code>文件，因为默认情况下它会查找functions文件夹，所以我们需要使它成为<code class="fe nf ng nh mr b">"source": "."</code>这意味着查看根文件夹而不是functions one，它看起来像这样:</p><pre class="kd ke kf kg gt mq mr ms mt aw mu bi"><span id="5346" class="mv lu in mr b gy mw mx l my mz">{<br/>  "functions": {<br/>    "predeploy": "npm --prefix \"$RESOURCE_DIR\" run build",<br/>    "source": "."<br/>  }<br/>}</span></pre><p id="91be" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">现在您需要运行:</p><pre class="kd ke kf kg gt mq mr ms mt aw mu bi"><span id="9acd" class="mv lu in mr b gy mw mx l my mz">npm run serve</span></pre><p id="9590" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">如果一切正常，您将会收到一条很长的消息，其中一条是这样的:</p><pre class="kd ke kf kg gt mq mr ms mt aw mu bi"><span id="7849" class="mv lu in mr b gy mw mx l my mz">functions[us-central1-api]: http function initialized (<a class="ae ll" href="http://localhost:5001/todo-7b299/us-central1/api" rel="noopener ugc nofollow" target="_blank">http://localhost:5001/todo-7b299/us-central1/api</a>).</span></pre><p id="6fef" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">在浏览器中打开这个URL来验证它是否真的在工作，它应该显示<code class="fe nf ng nh mr b">Hello World!</code></p><h1 id="9828" class="lt lu in bd lv lw na ly lz ma nb mc md jt nc ju mf jw nd jx mh jz ne ka mj mk bi translated">3.部署到Firebase功能</h1><p id="0e82" class="pw-post-body-paragraph ko kp in kq b kr ml jo kt ku mm jr kw kx mn kz la lb mo ld le lf mp lh li lj ig bi translated">我们需要运行:</p><pre class="kd ke kf kg gt mq mr ms mt aw mu bi"><span id="c4d2" class="mv lu in mr b gy mw mx l my mz">npm run deploy</span></pre><p id="0814" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">如果一切正常，它会给你一条很长的信息，只有一行:</p><pre class="kd ke kf kg gt mq mr ms mt aw mu bi"><span id="6378" class="mv lu in mr b gy mw mx l my mz">Function URL (api(us-central1)): <a class="ae ll" href="https://us-central1-todo-7b299.cloudfunctions.net/api" rel="noopener ugc nofollow" target="_blank">https://us-central1-todo-7b299.cloudfunctions.net/api</a></span></pre><p id="d8a0" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated"><em class="lk">如果你遇到一个错误，可能是因为你选择的引擎不被Firebase支持，或者你在改变</em> <code class="fe nf ng nh mr b"><em class="lk">package.json</em></code> <em class="lk">后没有运行</em> <code class="fe nf ng nh mr b"><em class="lk">npm i</em></code> <em class="lk">，或者你的计划不火。</em></p><p id="8412" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">如果你打开这个网址，它可能会给你:</p><pre class="kd ke kf kg gt mq mr ms mt aw mu bi"><span id="5419" class="mv lu in mr b gy mw mx l my mz">Error: Forbidden<br/>Your client does not have permission to get URL /api from this server.</span></pre><p id="d4a7" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">这是因为它尚未公开，要公开它，您需要执行以下操作:</p><ol class=""><li id="480e" class="nj nk in kq b kr ks ku kv kx nl lb nm lf nn lj no np nq nr bi translated">去消防基地控制台<a class="ae ll" href="https://console.firebase.google.com/u/0/" rel="noopener ugc nofollow" target="_blank">https://console.firebase.google.com/</a>。</li><li id="2e7e" class="nj nk in kq b kr ns ku nt kx nu lb nv lf nw lj no np nq nr bi translated">选择您的项目。</li><li id="bbfe" class="nj nk in kq b kr ns ku nt kx nu lb nv lf nw lj no np nq nr bi translated">转到“功能”选项卡。</li><li id="189f" class="nj nk in kq b kr ns ku nt kx nu lb nv lf nw lj no np nq nr bi translated">选择功能名称旁边的三个点，然后选择<code class="fe nf ng nh mr b">Detailed usage stats</code>，这将带您进入谷歌云。</li><li id="4034" class="nj nk in kq b kr ns ku nt kx nu lb nv lf nw lj no np nq nr bi translated">转到“权限”选项卡并添加权限。</li><li id="c14b" class="nj nk in kq b kr ns ku nt kx nu lb nv lf nw lj no np nq nr bi translated">如下图所示，选择“所有用户”主体和云函数调用程序规则并保存。</li></ol><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div class="gh gi nx"><img src="../Images/a39bd20fbf1acc96e0fb2a5091201c91.png" data-original-src="https://miro.medium.com/v2/resize:fit:1192/format:webp/1*Wr68SY3nYZREfMYxzi7CEg.png"/></div><figcaption class="ny nz gj gh gi oa ob bd b be z dk">make function publicly accessed</figcaption></figure><p id="677c" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">现在刷新网址，它也应该给你“你好世界！”这次。</p><p id="7ae5" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">恭喜你！您已经将您的NestJS应用程序部署到Firebase函数。</p><h1 id="94b5" class="lt lu in bd lv lw na ly lz ma nb mc md jt nc ju mf jw nd jx mh jz ne ka mj mk bi translated">4.添加Firebase身份验证</h1><p id="1482" class="pw-post-body-paragraph ko kp in kq b kr ml jo kt ku mm jr kw kx mn kz la lb mo ld le lf mp lh li lj ig bi translated"><em class="lk">注意:您需要启用用户如何进行身份验证，但通常这是前端/移动的一部分。</em></p><p id="b298" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">让我们从创建一个todo资源开始，使用:</p><pre class="kd ke kf kg gt mq mr ms mt aw mu bi"><span id="8272" class="mv lu in mr b gy mw mx l my mz">nest g res todo</span></pre><p id="29ee" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">让我们通过删除<code class="fe nf ng nh mr b">app.controller.ts</code>和<code class="fe nf ng nh mr b">app.service.ts</code>以及它们在<code class="fe nf ng nh mr b">app.module.ts</code>中的提及来清理一下这个项目。</p><p id="76e1" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">然后，我们需要使所有的todo路由只能通过Firebase JWT令牌访问，因为现在如果你去<code class="fe nf ng nh mr b">api/todo</code>它会显示“此操作返回所有todo ”,而它只显示如果它是一个认证的请求返回。</p><p id="94ce" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">首先，让我们安装所有必需的依赖项:</p><pre class="kd ke kf kg gt mq mr ms mt aw mu bi"><span id="a7a7" class="mv lu in mr b gy mw mx l my mz">npm i @nestjs/passport passport passport-firebase-jwt</span></pre><p id="296b" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">然后，让我们用以下代码创建一个名为<code class="fe nf ng nh mr b">auth</code>的全局模块:</p><pre class="kd ke kf kg gt mq mr ms mt aw mu bi"><span id="6cfb" class="mv lu in mr b gy mw mx l my mz">nest g mo auth</span></pre><p id="640b" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">并在<code class="fe nf ng nh mr b">@Module</code>前添加<code class="fe nf ng nh mr b">@Global()</code>，使其可以被我们所有的模块访问。</p><p id="f8c1" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">然后在<code class="fe nf ng nh mr b">auth</code>文件夹中创建一个新文件<code class="fe nf ng nh mr b">firebase-auth.strategy.ts</code>，内容如下:</p><pre class="kd ke kf kg gt mq mr ms mt aw mu bi"><span id="8393" class="mv lu in mr b gy mw mx l my mz">import { PassportStrategy } from '@nestjs/passport';<br/>import { Injectable, UnauthorizedException } from '@nestjs/common';<br/>import { Strategy, ExtractJwt } from 'passport-firebase-jwt';<br/>import { auth } from 'firebase-admin';<br/><br/>@Injectable()<br/>export class FirebaseAuthStrategy extends PassportStrategy(Strategy) {<br/>  constructor() {<br/>    super({<br/>      jwtFromRequest: ExtractJwt.fromAuthHeaderAsBearerToken(),<br/>    });<br/>  }<br/><br/>  validate(token) {<br/>    return auth()<br/>      .verifyIdToken(token, true)<br/>      .catch((err) =&gt; {<br/>        console.warn(err);<br/>        throw new UnauthorizedException();<br/>      });<br/>  }<br/>}</span></pre><p id="b7e5" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">然后在<code class="fe nf ng nh mr b">auth.module.ts</code>中使用它，看起来如下:</p><pre class="kd ke kf kg gt mq mr ms mt aw mu bi"><span id="9e73" class="mv lu in mr b gy mw mx l my mz">import { Global, Module } from '@nestjs/common';<br/>import { PassportModule } from '@nestjs/passport';<br/>import { FirebaseAuthStrategy } from './firebase-auth.strategy';<br/><br/>@Global()<br/>@Module({<br/>  imports: [PassportModule.<em class="lk">register</em>({ defaultStrategy: 'firebase-jwt' })],<br/>  providers: [FirebaseAuthStrategy],<br/>  exports: [PassportModule],<br/>})<br/>export class AuthModule {}</span></pre><p id="51b5" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">然后最后在<code class="fe nf ng nh mr b">TodoController</code>里加上<code class="fe nf ng nh mr b">@UseGuards(AuthGuard())</code>。</p><p id="b934" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">现在当你进入<code class="fe nf ng nh mr b"><a class="ae ll" href="http://localhost:5001/todo-7b299/us-central1/api/todo" rel="noopener ugc nofollow" target="_blank">http://localhost:5001/todo-7b299/us-central1/api/todo</a></code>时，它应该返回401(但是你需要重启服务器)。</p><h1 id="3410" class="lt lu in bd lv lw na ly lz ma nb mc md jt nc ju mf jw nd jx mh jz ne ka mj mk bi translated">5.启用CORS</h1><p id="3238" class="pw-post-body-paragraph ko kp in kq b kr ml jo kt ku mm jr kw kx mn kz la lb mo ld le lf mp lh li lj ig bi translated">现在让我们开始测试我们的API。</p><p id="5cbf" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">我创建了一个非常简单的Angular项目来测试API。</p><div class="oc od gp gr oe of"><a href="https://github.com/robertIsaac/angular-todo" rel="noopener  ugc nofollow" target="_blank"><div class="og ab fo"><div class="oh ab oi cl cj oj"><h2 class="bd io gy z fp ok fr fs ol fu fw im bi translated">GitHub-robertIsaac/angular-todo</h2><div class="om l"><h3 class="bd b gy z fp ok fr fs ol fu fw dk translated">此项目是使用Angular CLI版本12.2.2生成的。为开发服务器运行ng serve。导航到…</h3></div><div class="on l"><p class="bd b dl z fp ok fr fs ol fu fw dk translated">github.com</p></div></div><div class="oo l"><div class="op l oq or os oo ot km of"/></div></div></a></div><p id="1655" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">让我们克隆它，修改environment.ts，看看我们的API能否工作。</p><p id="83dc" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">你将面临的第一个问题是CORS错误。</p><p id="932a" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">要启用它，只需在index.ts文件中添加<code class="fe nf ng nh mr b">app.enableCors()</code>。</p><p id="840b" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">要那样:</p><pre class="kd ke kf kg gt mq mr ms mt aw mu bi"><span id="9670" class="mv lu in mr b gy mw mx l my mz">const createFunction = async (expressInstance): Promise&lt;void&gt; =&gt; {<br/>  const app = await NestFactory.create(<br/>    AppModule,<br/>    new ExpressAdapter(expressInstance),<br/>  );<br/>  <strong class="mr io">app.enableCors();</strong><br/>  app.useGlobalPipes(new ValidationPipe());<br/>  await app.init();<br/>};</span></pre><p id="d2b0" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">完成添加后，请重启<code class="fe nf ng nh mr b">npm run serve</code>。</p><p id="4222" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">你会发现CORS错误消失了，但是抛出了一个新的错误:</p><pre class="kd ke kf kg gt mq mr ms mt aw mu bi"><span id="44d8" class="mv lu in mr b gy mw mx l my mz">[Nest] 16468  - 08/06/2021, 10:51:49 AM   ERROR [ExceptionsHandler] The default Firebase app does not exist. Make sure you call initializeApp() before using any of the Firebase services.</span></pre><h1 id="a1ef" class="lt lu in bd lv lw na ly lz ma nb mc md jt nc ju mf jw nd jx mh jz ne ka mj mk bi translated">6.用Firebase Admin连接NestJS</h1><p id="2004" class="pw-post-body-paragraph ko kp in kq b kr ml jo kt ku mm jr kw kx mn kz la lb mo ld le lf mp lh li lj ig bi translated">现在的问题是，NestJS还不能连接Firebase，它只能部署代码。</p><p id="07ba" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">用Firebase连接有很多方法，但我更喜欢用Firebase Config。因此，证书不在代码中，这使它更安全，而且它在本地和云上都工作，而不必以多种方式提供它们。</p><p id="5877" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">所以第一步是下载凭证文件。</p><p id="d8de" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">你会这样截图:</p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi ou"><img src="../Images/c47fbcbda5357982927fea8a187fff60.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FLOAMazGgwjmJVQyaBzzrA.png"/></div></div></figure><p id="6eae" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">这将下载一个JSON文件。</p><p id="042b" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">现在您需要对它进行编码，只需使用<code class="fe nf ng nh mr b">JSON.stringify</code>。</p><h2 id="1e5a" class="mv lu in bd lv ov ow dn lz ox oy dp md kx oz pa mf lb pb pc mh lf pd pe mj pf bi translated">之前:</h2><pre class="kd ke kf kg gt mq mr ms mt aw mu bi"><span id="eaca" class="mv lu in mr b gy mw mx l my mz">{<br/>  "type": "service_account",<br/>  "project_id": "todo-7b299",<br/>  "private_key_id": "foobar",<br/>  "private_key": "-----BEGIN PRIVATE KEY-----...",<br/>  "client_email": "something.iam.gserviceaccount.com",<br/>  "client_id": "123",<br/>  "auth_uri": "https://accounts.google.com/o/oauth2/auth",<br/>  "token_uri": "https://oauth2.googleapis.com/token",<br/>  "auth_provider_x509_cert_url": "https://www.googleapis.com/oauth2/v1/certs",<br/>  "client_x509_cert_url": "https://www.googleapis.com/robot/v1/metadata/x509/firebase-adminsdk-foo.iam.gserviceaccount.com"<br/>}</span></pre><h2 id="c9e0" class="mv lu in bd lv ov ow dn lz ox oy dp md kx oz pa mf lb pb pc mh lf pd pe mj pf bi translated">之后:</h2><pre class="kd ke kf kg gt mq mr ms mt aw mu bi"><span id="833a" class="mv lu in mr b gy mw mx l my mz">"{\"type\":\"service_account\",\"project_id\":\"todo-7b299\",\"private_key_id\":\"foobar\",\"private_key\":\"-----BEGIN PRIVATE KEY-----...\",\"client_email\":\"something.iam.gserviceaccount.com\",\"client_id\":\"123\",\"auth_uri\":\"<a class="ae ll" href="https://accounts.google.com/o/oauth2/auth\" rel="noopener ugc nofollow" target="_blank">https://accounts.google.com/o/oauth2/auth\</a>",\"token_uri\":\"<a class="ae ll" href="https://oauth2.googleapis.com/token\" rel="noopener ugc nofollow" target="_blank">https://oauth2.googleapis.com/token\</a>",\"auth_provider_x509_cert_url\":\"<a class="ae ll" href="https://www.googleapis.com/oauth2/v1/certs\" rel="noopener ugc nofollow" target="_blank">https://www.googleapis.com/oauth2/v1/certs\</a>",\"client_x509_cert_url\":\"<a class="ae ll" href="https://www.googleapis.com/robot/v1/metadata/x509/firebase-adminsdk-foo.iam.gserviceaccount.com\" rel="noopener ugc nofollow" target="_blank">https://www.googleapis.com/robot/v1/metadata/x509/firebase-adminsdk-foo.iam.gserviceaccount.com\</a>"}"</span></pre><p id="86d9" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">现在，您可以执行以下命令:</p><pre class="kd ke kf kg gt mq mr ms mt aw mu bi"><span id="2149" class="mv lu in mr b gy mw mx l my mz">firebase functions:config:set todo_firebase_config="{\"type\":\"service_account\",\"project_id\":\"todo-7b299\",\"private_key_id\":\"foobar\",\"private_key\":\"-----BEGIN PRIVATE KEY-----...\",\"client_email\":\"something.iam.gserviceaccount.com\",\"client_id\":\"123\",\"auth_uri\":\"<a class="ae ll" href="https://accounts.google.com/o/oauth2/auth\" rel="noopener ugc nofollow" target="_blank">https://accounts.google.com/o/oauth2/auth\</a>",\"token_uri\":\"<a class="ae ll" href="https://oauth2.googleapis.com/token\" rel="noopener ugc nofollow" target="_blank">https://oauth2.googleapis.com/token\</a>",\"auth_provider_x509_cert_url\":\"<a class="ae ll" href="https://www.googleapis.com/oauth2/v1/certs\" rel="noopener ugc nofollow" target="_blank">https://www.googleapis.com/oauth2/v1/certs\</a>",\"client_x509_cert_url\":\"<a class="ae ll" href="https://www.googleapis.com/robot/v1/metadata/x509/firebase-adminsdk-foo.iam.gserviceaccount.com\" rel="noopener ugc nofollow" target="_blank">https://www.googleapis.com/robot/v1/metadata/x509/firebase-adminsdk-foo.iam.gserviceaccount.com\</a>"}"</span></pre><p id="b4d5" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">要验证它是否工作，运行<code class="fe nf ng nh mr b">firebase functions:config:get</code>。</p><pre class="kd ke kf kg gt mq mr ms mt aw mu bi"><span id="7f17" class="mv lu in mr b gy mw mx l my mz">$ firebase functions:config:get<br/>{<br/>  "todo_firebase_config": {<br/>    "project_id": "todo-7b299",<br/>    "auth_uri": "<a class="ae ll" href="https://accounts.google.com/o/oauth2/auth" rel="noopener ugc nofollow" target="_blank">https://accounts.google.com/o/oauth2/auth</a>",<br/>    "client_x509_cert_url": "<a class="ae ll" href="https://www.googleapis.com/robot/v1/metadata/x509/firebase-adminsdk-foo.iam.gserviceaccount.com" rel="noopener ugc nofollow" target="_blank">https://www.googleapis.com/robot/v1/metadata/x509/firebase-adminsdk-foo.iam.gserviceaccount.com</a>",<br/>    "token_uri": "<a class="ae ll" href="https://oauth2.googleapis.com/token" rel="noopener ugc nofollow" target="_blank">https://oauth2.googleapis.com/token</a>",<br/>    "private_key": "-----BEGIN PRIVATE KEY-----...",<br/>    "client_email": "something.iam.gserviceaccount.com",<br/>    "type": "service_account",<br/>    "private_key_id": "foobar",<br/>    "auth_provider_x509_cert_url": "<a class="ae ll" href="https://www.googleapis.com/oauth2/v1/certs" rel="noopener ugc nofollow" target="_blank">https://www.googleapis.com/oauth2/v1/certs</a>",<br/>    "client_id": "123"<br/>  }<br/>}</span></pre><p id="2072" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">现在让我们通过修改<code class="fe nf ng nh mr b">index.ts</code>并添加以下内容来加载它:</p><pre class="kd ke kf kg gt mq mr ms mt aw mu bi"><span id="f2d5" class="mv lu in mr b gy mw mx l my mz">admin.initializeApp({<br/>  credential: admin.credential.cert(functions.config().todo_firebase_config),<br/>  databaseURL: 'https://todo-c9f6e-default-rtdb.firebaseio.com',<br/>});</span></pre><p id="fd20" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">现在，这在云中可以很好地工作，但在本地仍然是相同的错误，要修复它，我们需要运行一个命令让函数模拟器正常工作，那就是:</p><pre class="kd ke kf kg gt mq mr ms mt aw mu bi"><span id="8e88" class="mv lu in mr b gy mw mx l my mz">firebase functions:config:get &gt; .runtimeconfig.json</span></pre><p id="e5e1" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">这将把<code class="fe nf ng nh mr b">functions:config:get</code>的内容返回到一个名为<code class="fe nf ng nh mr b">.runtimeconfig.json</code>的文件中。</p><p id="1c97" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">所以我们需要将这个文件添加到<code class="fe nf ng nh mr b">.gitignore</code>中。</p><h1 id="fd57" class="lt lu in bd lv lw na ly lz ma nb mc md jt nc ju mf jw nd jx mh jz ne ka mj mk bi translated">7.增强我们的脚本以获得更好的开发者体验</h1><p id="2774" class="pw-post-body-paragraph ko kp in kq b kr ml jo kt ku mm jr kw kx mn kz la lb mo ld le lf mp lh li lj ig bi translated">所以现在我们应该在每次开始之前运行这个命令，也就是说，以防同事修改了某些东西，或者有人第一次克隆了这个项目。</p><p id="efdd" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">现在还有另一个问题，那就是每次我们做出改变时都需要重启我们的应用程序。</p><p id="a39d" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">因此，我们需要一个更好的脚本来为我们处理这一切。</p><p id="e78b" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">为此，我使用并发包。使用以下代码将其作为开发工具安装:</p><pre class="kd ke kf kg gt mq mr ms mt aw mu bi"><span id="f18e" class="mv lu in mr b gy mw mx l my mz">npm i -D concurrently</span></pre><p id="8d0a" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">然后更改脚本，如下所示:</p><pre class="kd ke kf kg gt mq mr ms mt aw mu bi"><span id="bc76" class="mv lu in mr b gy mw mx l my mz">"scripts": {<br/>  "prebuild": "rimraf dist",<br/>  "build": "nest build",<br/><strong class="mr io">  "build:watch": "nest build --watch",<br/></strong>  "format": "prettier --write \"src/**/*.ts\" \"test/**/*.ts\"",<br/>  "start": "nest start",<br/>  "start:dev": "nest start --watch",<br/>  "start:debug": "nest start --debug --watch",<br/>  "start:prod": "node dist/main",<br/>  "lint": "eslint \"{src,apps,libs,test}/**/*.ts\" --fix",<br/>  "test": "jest",<br/>  "test:watch": "jest --watch",<br/>  "test:cov": "jest --coverage",<br/>  "test:debug": "node --inspect-brk -r tsconfig-paths/register -r ts-node/register node_modules/.bin/jest --runInBand",<br/>  "test:e2e": "jest --config ./test/jest-e2e.json",<br/><strong class="mr io">  "get:config": "firebase functions:config:get &gt; .runtimeconfig.json",<br/>  "firebase:emulator": "firebase emulators:start --only functions",<br/>  "serve": "npm run get:config &amp;&amp; npm run build &amp;&amp; npm run firebase:emulator",<br/>  "serve:watch": "concurrently npm:get:config npm:build &amp;&amp; concurrently npm:build:watch npm:firebase:emulator",<br/></strong>  "shell": "npm run build &amp;&amp; firebase functions:shell",<br/>  "deploy": "firebase deploy --only functions",<br/>  "logs": "firebase functions:log"<br/>}</span></pre><p id="fa7d" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">现在，您只需要运行以下命令:</p><pre class="kd ke kf kg gt mq mr ms mt aw mu bi"><span id="210f" class="mv lu in mr b gy mw mx l my mz">npm run serve:watch</span></pre><p id="b1f0" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">它将为您处理一切，不再需要重启应用程序。</p><h1 id="44ca" class="lt lu in bd lv lw na ly lz ma nb mc md jt nc ju mf jw nd jx mh jz ne ka mj mk bi translated">8.与Firestore连接</h1><p id="1f46" class="pw-post-body-paragraph ko kp in kq b kr ml jo kt ku mm jr kw kx mn kz la lb mo ld le lf mp lh li lj ig bi translated">最后一步是将我们的应用程序与Firestore连接起来，以存储我们的数据。</p><p id="15f7" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">在我们开始之前，您必须在<a class="ae ll" href="http://console.firebase.google.com" rel="noopener ugc nofollow" target="_blank"> Firebase控制台</a>中创建数据库。</p><p id="a0e8" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">首先是定义我们的实体和DTO</p><p id="8e78" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated"><code class="fe nf ng nh mr b">todo.entity.ts</code></p><pre class="kd ke kf kg gt mq mr ms mt aw mu bi"><span id="5709" class="mv lu in mr b gy mw mx l my mz">export class Todo {<br/>  id: string;<br/>  title: string;<br/>  details: string;<br/>  userId: string;<br/>  createdAt: string;<br/>}</span></pre><p id="8721" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated"><code class="fe nf ng nh mr b">create-todo.dto.ts</code></p><pre class="kd ke kf kg gt mq mr ms mt aw mu bi"><span id="5732" class="mv lu in mr b gy mw mx l my mz">import { IsNotEmpty, IsString } from 'class-validator';<br/><br/>export class CreateTodoDto {<br/>  @IsNotEmpty()<br/>  @IsString()<br/>  title: string;<br/><br/>  @IsString()<br/>  details: string;<br/>}</span></pre><p id="0028" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">为了进行验证，我们需要安装<code class="fe nf ng nh mr b">class-validator</code>和<code class="fe nf ng nh mr b">class-transformer</code>依赖项，并将<code class="fe nf ng nh mr b">app.useGlobalPipes(new ValidationPipe());</code>添加到我们的<code class="fe nf ng nh mr b">index.ts</code>文件中。</p><p id="00cd" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">现在我们需要将我们的服务连接到firebase，这是完整的代码:</p><pre class="kd ke kf kg gt mq mr ms mt aw mu bi"><span id="232a" class="mv lu in mr b gy mw mx l my mz">import { Inject, Injectable } from '@nestjs/common';<br/>import { CreateTodoDto } from './dto/create-todo.dto';<br/>import { UpdateTodoDto } from './dto/update-todo.dto';<br/>import { firestore } from 'firebase-admin';<br/>import { REQUEST } from '@nestjs/core';<br/>import { Todo } from './entities/todo.entity';<br/>import DocumentSnapshot = firestore.DocumentSnapshot;<br/>import QuerySnapshot = firestore.QuerySnapshot;<br/><br/>@Injectable()<br/>export class TodoService {<br/>  private collection: FirebaseFirestore.CollectionReference&lt;FirebaseFirestore.DocumentData&gt;;<br/><br/>  constructor(@Inject(REQUEST) private readonly request: { user: any }) {<br/>    this.collection = firestore().collection('todos');<br/>  }<br/><br/>  async create(createTodoDto: CreateTodoDto) {<br/>    const userId = this.request.user.uid;<br/>    const todo: Omit&lt;Todo, 'id'&gt; = {<br/>      ...createTodoDto,<br/>      createdAt: new Date().toISOString(),<br/>      userId,<br/>    };<br/><br/>    return this.collection.add(todo).then((doc) =&gt; {<br/>      return { id: doc.id, ...todo };<br/>    });<br/>  }<br/><br/>  findAll() {<br/>    return this.collection<br/>      .where('userId', '==', this.request.user.uid)<br/>      .get()<br/>      .then((querySnapshot: QuerySnapshot&lt;Todo&gt;) =&gt; {<br/>        if (querySnapshot.empty) {<br/>          return [];<br/>        }<br/><br/>        const todos: Todo[] = [];<br/>        for (const doc of querySnapshot.docs) {<br/>          todos.push(this.transformTodo(doc));<br/>        }<br/><br/>        return todos;<br/>      });<br/>  }<br/><br/>  findOne(id: string) {<br/>    return this.collection<br/>      .doc(id)<br/>      .get()<br/>      .then((querySnapshot: DocumentSnapshot&lt;Todo&gt;) =&gt; {<br/>        return this.transformTodo(querySnapshot);<br/>      });<br/>  }<br/><br/>  async update(id: string, updateTodoDto: UpdateTodoDto) {<br/>    await this.collection.doc(id).update(updateTodoDto);<br/>  }<br/><br/>  async remove(id: string) {<br/>    await this.collection.doc(id).delete();<br/>  }<br/><br/>  private transformTodo(querySnapshot: DocumentSnapshot&lt;Todo&gt;) {<br/>    if (!querySnapshot.exists) {<br/>      throw new Error(`no todo found with the given id`);<br/>    }<br/><br/>    const todo = querySnapshot.data();<br/>    const userId = this.request.user.uid;<br/><br/>    if (todo.userId !== userId) {<br/>      throw new Error(`no todo found with the given id`);<br/>    }<br/><br/>    return {<br/>      id: querySnapshot.id,<br/>      ...todo,<br/>    };<br/>  }<br/>}</span></pre><p id="f2cc" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">然后在我们的控制器中，我们只需要将id从字符串转换为数字:</p><pre class="kd ke kf kg gt mq mr ms mt aw mu bi"><span id="0cf6" class="mv lu in mr b gy mw mx l my mz">import {<br/>  Body,<br/>  Controller,<br/>  Delete,<br/>  Get,<br/>  Param,<br/>  Patch,<br/>  Post,<br/>  UseGuards,<br/>} from '@nestjs/common';<br/>import { TodoService } from './todo.service';<br/>import { CreateTodoDto } from './dto/create-todo.dto';<br/>import { UpdateTodoDto } from './dto/update-todo.dto';<br/>import { AuthGuard } from '@nestjs/passport';<br/><br/>@UseGuards(AuthGuard())<br/>@Controller('todo')<br/>export class TodoController {<br/>  constructor(private readonly todoService: TodoService) {}<br/><br/>  @Post()<br/>  create(@Body() createTodoDto: CreateTodoDto) {<br/>    return this.todoService.create(createTodoDto);<br/>  }<br/><br/>  @Get()<br/>  findAll() {<br/>    return this.todoService.findAll();<br/>  }<br/><br/>  @Get(':id')<br/>  findOne(@Param('id') id: string) {<br/>    <strong class="mr io">return this.todoService.findOne(id);</strong><br/>  }<br/><br/>  @Patch(':id')<br/>  update(@Param('id') id: string, @Body() updateTodoDto: UpdateTodoDto) {<br/>    <strong class="mr io">return this.todoService.update(id, updateTodoDto);</strong><br/>  }<br/><br/>  @Delete(':id')<br/>  remove(@Param('id') id: string) {<br/>    <strong class="mr io">return this.todoService.remove(id);</strong><br/>  }<br/>}</span></pre><p id="0701" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">现在我们结束了。</p><p id="5f45" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">在这个应用程序中，我们可以做很多改进，但我希望它尽可能简单。</p><p id="7296" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">查看我的GitHub repo中的完整代码:</p><div class="oc od gp gr oe of"><a href="https://github.com/robertIsaac/NestJS-with-Firebase" rel="noopener  ugc nofollow" target="_blank"><div class="og ab fo"><div class="oh ab oi cl cj oj"><h2 class="bd io gy z fp ok fr fs ol fu fw im bi translated">GitHub-robertIsaac/NestJS-with-Firebase:这是一个如何连接NestJS和Firebase的指南…</h2><div class="om l"><h3 class="bd b gy z fp ok fr fs ol fu fw dk translated">一个渐进式Node.js框架，用于构建高效且可伸缩的服务器端应用程序。嵌套框架类型脚本…</h3></div><div class="on l"><p class="bd b dl z fp ok fr fs ol fu fw dk translated">github.com</p></div></div><div class="oo l"><div class="pg l oq or os oo ot km of"/></div></div></a></div></div><div class="ab cl lm ln hr lo" role="separator"><span class="lp bw bk lq lr ls"/><span class="lp bw bk lq lr ls"/><span class="lp bw bk lq lr"/></div><div class="ig ih ii ij ik"><p id="e17f" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated"><em class="lk">更多内容请看</em><a class="ae ll" href="https://plainenglish.io/" rel="noopener ugc nofollow" target="_blank"><strong class="kq io"><em class="lk">plain English . io</em></strong></a><em class="lk">。报名参加我们的</em> <a class="ae ll" href="http://newsletter.plainenglish.io/" rel="noopener ugc nofollow" target="_blank"> <strong class="kq io"> <em class="lk">免费周报</em> </strong> </a> <em class="lk">。关注我们关于</em><a class="ae ll" href="https://twitter.com/inPlainEngHQ" rel="noopener ugc nofollow" target="_blank"><strong class="kq io"><em class="lk">Twitter</em></strong></a><a class="ae ll" href="https://www.linkedin.com/company/inplainenglish/" rel="noopener ugc nofollow" target="_blank"><strong class="kq io"><em class="lk">LinkedIn</em></strong></a><em class="lk"/><a class="ae ll" href="https://www.youtube.com/channel/UCtipWUghju290NWcn8jhyAw" rel="noopener ugc nofollow" target="_blank"><strong class="kq io"><em class="lk">YouTube</em></strong></a><em class="lk"/><a class="ae ll" href="https://discord.gg/GtDtUAvyhW" rel="noopener ugc nofollow" target="_blank"><strong class="kq io"><em class="lk">不和</em> </strong> </a> <em class="lk">。</em></p></div></div>    
</body>
</html>