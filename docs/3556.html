<html>
<head>
<title>Use “Istanbul” to Get Your JavaScript Code Coverage to 99%</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用“伊斯坦布尔”让您的JavaScript代码覆盖率达到99%</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/use-istanbul-to-get-your-javascript-code-coverage-to-99-bc03f083346d?source=collection_archive---------6-----------------------#2022-09-07">https://javascript.plainenglish.io/use-istanbul-to-get-your-javascript-code-coverage-to-99-bc03f083346d?source=collection_archive---------6-----------------------#2022-09-07</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/62a54311edccb1c5ae38048c957c7843.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*xkaHUCBGQm5bVNaz"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">Photo by <a class="ae kc" href="https://unsplash.com/@htroupe?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Hannah Troupe</a> on <a class="ae kc" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="db54" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">本人工作多年，经常发现一个边界案例没有测试，上线后用户操作刚好打中了漏例，导致上线意外。</p><h1 id="6bfd" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">情况分析</h1><p id="54b6" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">让我们用一个具体的场景来解释漏测的可能后果。</p><p id="d953" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">假设我在我的项目里开发了一个叫做<code class="fe me mf mg mh b">Welcome</code>的<code class="fe me mf mg mh b">React</code>组件，代码比较简单，你可以先看一下。</p><figure class="mi mj mk ml gt jr"><div class="bz fp l di"><div class="mm mn l"/></div></figure><p id="c1ce" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">可以看到，Welcome组件中只有一个div元素，内容显示为字符串“this welcome page”。当然，你也可以看到我绑定了一个<code class="fe me mf mg mh b">click</code>事件<code class="fe me mf mg mh b">showMessage</code>到div元素，但是当<code class="fe me mf mg mh b">showMessage </code>事件被执行时，会抛出一个异常。假设这个<code class="fe me mf mg mh b">div</code>上的<code class="fe me mf mg mh b">click</code>事件是一个边界案例，在测试过程中没有被覆盖，那么我们的项目就存在隐患。页面上线后，只要用户点击<code class="fe me mf mg mh b">div</code>，就会报错，导致功能异常。那么如何才能避免漏检呢？</p><h1 id="5f3d" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">代码覆盖率的概念</h1><p id="db34" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">在解释避免遗漏测试之前，让我向您介绍一下测试覆盖的概念。</p><p id="4cd8" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">简单来说，测试覆盖率是软件测试或软件工程中的一种软件度量，即<code class="fe me mf mg mh b">indicates the proportion of the software program that was tested</code>。覆盖率是判断测试严格性的一种方式，它可以被分解，例如:</p><ul class=""><li id="4dcf" class="mo mp iq kf b kg kh kk kl ko mq ks mr kw ms la mt mu mv mw bi translated"><strong class="kf ir">行覆盖</strong>:每一行都执行了吗？</li><li id="95d5" class="mo mp iq kf b kg mx kk my ko mz ks na kw nb la mt mu mv mw bi translated"><strong class="kf ir">函数覆盖</strong>:每个函数都被调用了吗？</li><li id="2f2e" class="mo mp iq kf b kg mx kk my ko mz ks na kw nb la mt mu mv mw bi translated"><strong class="kf ir">分支覆盖</strong>:每个块都执行了吗？</li><li id="0289" class="mo mp iq kf b kg mx kk my ko mz ks na kw nb la mt mu mv mw bi translated"><strong class="kf ir">语句覆盖</strong>:每条语句都执行了吗？</li></ul><p id="e571" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">那么在开源社区中，有一个工具可以帮助我们统计代码的覆盖率，它叫做<code class="fe me mf mg mh b">Istanbul</code>，如果你有兴趣可以查看源代码，<a class="ae kc" href="https://github.com/gotwarlost/istanbul" rel="noopener ugc nofollow" target="_blank">地址</a>。我们先简单学习一下如何使用。</p><p id="6092" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">首先，需要全局安装<code class="fe me mf mg mh b">Istanbul</code>依赖项，代码如下:</p><pre class="mi mj mk ml gt nc mh nd ne aw nf bi"><span id="86a9" class="ng lc iq mh b gy nh ni l nj nk">npm install -g istanbul</span></pre><p id="ac4a" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后，我这里有一个测试文件，代码如下:</p><pre class="mi mj mk ml gt nc mh nd ne aw nf bi"><span id="27b9" class="ng lc iq mh b gy nh ni l nj nk">// test.js<br/>var a = 1;<br/>var b = 1;<br/>if ((a + b) &gt; 2) {<br/>  console .log('more than two');<br/>}</span></pre><p id="fd31" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">接下来，使用<code class="fe me mf mg mh b">Istanbul</code>工具统计代码覆盖率，并执行以下命令:</p><pre class="mi mj mk ml gt nc mh nd ne aw nf bi"><span id="74dc" class="ng lc iq mh b gy nh ni l nj nk">istanbul cover test.js</span></pre><p id="787a" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">最后，代码覆盖的细节将在终端中输出:</p><figure class="mi mj mk ml gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nl"><img src="../Images/221993743e37012f9144750d2068c736.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*iHernTGKYVmRdYJz"/></div></div></figure><p id="c86e" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这个测试有75%的语句覆盖率、50%的分支覆盖率、100%的函数覆盖率和75%的行覆盖率。</p><p id="b649" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">好吧，让我们来理解代码覆盖率的概念。接下来，我们来解释一下如何在实战中统计代码覆盖率。</p><h1 id="8f75" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">单元测试统计代码覆盖率</h1><p id="aef6" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">一般在严格的开发过程中，我们的项目需要编写单元测试。好的单元测试可以帮助我们避免许多问题。例如，每次迭代需求时，您想要检查新的代码逻辑是否会影响之前的代码逻辑。函数，此时运行一个单元测试就可以知道了。如果所有的测试用例都通过了，您就可以对这个迭代放心了。</p><p id="2aa1" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">为了编写前端单元测试，我使用了<code class="fe me mf mg mh b">Jest + Chai</code>组合。因为Jest自带了代码覆盖率统计的功能，而Chai又是一个优秀的断言库，所以用这种组合我们很容易就能写出相关的测试用例。</p><p id="b235" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">对于前面场景分析中的<code class="fe me mf mg mh b">Welcome</code>组件，我们稍微修改了代码，如下所示:</p><figure class="mi mj mk ml gt jr"><div class="bz fp l di"><div class="mm mn l"/></div></figure><p id="9924" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们注释掉了<code class="fe me mf mg mh b">showMessage</code>方法中的异常，并执行正常的逻辑。那么单元测试用例可以这样写:</p><figure class="mi mj mk ml gt jr"><div class="bz fp l di"><div class="mm mn l"/></div></figure><p id="8739" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们再写两个测试用例，一个是第一次渲染，一个是<code class="fe me mf mg mh b">onclick</code>事件，涵盖了<code class="fe me mf mg mh b">Welcome</code>组件的所有功能。</p><p id="6eb0" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">接下来，我们需要向<code class="fe me mf mg mh b">package.json</code>文件的脚本中添加一个测试命令，如下所示:</p><pre class="mi mj mk ml gt nc mh nd ne aw nf bi"><span id="ce10" class="ng lc iq mh b gy nh ni l nj nk">"test": "jest --coverage"</span></pre><p id="9c66" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后通过执行<code class="fe me mf mg mh b">npm run test</code>命令，我们可以测试<code class="fe me mf mg mh b">Welcome</code>组件的功能并计算代码覆盖率。执行结果如下:</p><figure class="mi mj mk ml gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nm"><img src="../Images/2d7509ef630a96443cac7e8570e6474c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*11aj8TfruZ3whq_t"/></div></div></figure><p id="4401" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">可以看出，两个测试用例都正常通过，代码覆盖率100%，一定程度上避免了漏测。</p><p id="92e4" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">Jest统计代码覆盖率，底层也依赖于<code class="fe me mf mg mh b">Istanbul</code>。所以在一些工程建设中，工程师可以单独使用<code class="fe me mf mg mh b">Istanbul</code>进行代码覆盖统计，然后将相关数据交给QA或者项目负责人进行更完整的测试。</p><h1 id="c476" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">最后</h1><p id="d9ef" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated"><strong class="kf ir">感谢阅读。</strong>我期待着<strong class="kf ir"> </strong>您的关注和阅读更多高质量的文章。</p><div class="nn no gp gr np"><div role="button" tabindex="0" class="ab bv gv cb fp nq nr bn ns jw ex"><div class="nt l"><div class="ab q"><div class="l di"><img alt="omgzui" class="l de bw nu nv fe" src="../Images/113db82933227743d0067a68e250ac93.png" width="20" height="20" loading="lazy" data-original-src="https://miro.medium.com/v2/resize:fill:40:40/1*AmBIV4haXTWPO--EhE0Q1A.jpeg"/><div class="fb bw l nu nv fc n aw fd"/></div><div class="hh l fo"><p class="bd b dl z fp fq fr fs ft fu fv fw dk translated"><a class="ae af ag ah ai aj ak al am an ao ap aq ar as" href="https://medium.com/@omgzui?source=post_page-----bc03f083346d--------------------------------" rel="noopener follow" target="_top"> omgzui </a></p></div></div><div class="ny nz gw l"><h2 class="bd ir tj mo fp tk fr fs tl fu fw ip bi translated">更好的编程</h2></div><div class="ab q"><div class="l fo"><a class="bd b be z bi tm au tn to tp pt tq an eh ei tr ts tt el em eo de bk ep" href="https://medium.com/@omgzui/list/better-programing-9b4c9bb174aa?source=post_page-----bc03f083346d--------------------------------" rel="noopener follow" target="_top">View list</a></div><div class="tu l fo"><span class="bd b dl z dk">109 stories</span></div></div></div><div class="ol dh om fp ab on fo di"><div class="di od bv oe of"><div class="dh l"><img alt="" class="dh" src="../Images/64fcf15e27c514ec49d62966b68dbc15.png" width="194" height="194" loading="lazy" role="presentation" data-original-src="https://miro.medium.com/v2/resize:fill:388:388/0*DbDdSUf5SchniJuq"/></div></div><div class="di od bv og oh oi"><div class="dh l"><img alt="" class="dh" src="../Images/3e6ce891363c151131c5993ca0dcc526.png" width="194" height="194" loading="lazy" role="presentation" data-original-src="https://miro.medium.com/v2/resize:fill:388:388/0*7cAp-WibSblfO7hT"/></div></div><div class="di bv oj ok oi"><div class="dh l"><img alt="" class="dh" src="../Images/a7dd413de22f319a3c4729c9e737feb8.png" width="194" height="194" loading="lazy" role="presentation" data-original-src="https://miro.medium.com/v2/resize:fill:388:388/0*FcmHdVfoUOhlJlsG"/></div></div></div></div></div><div class="nn no gp gr np"><div role="button" tabindex="0" class="ab bv gv cb fp nq nr bn ns jw ex"><div class="nt l"><div class="ab q"><div class="l di"><img alt="omgzui" class="l de bw nu nv fe" src="../Images/113db82933227743d0067a68e250ac93.png" width="20" height="20" loading="lazy" data-original-src="https://miro.medium.com/v2/resize:fill:40:40/1*AmBIV4haXTWPO--EhE0Q1A.jpeg"/><div class="fb bw l nu nv fc n aw fd"/></div><div class="hh l fo"><p class="bd b dl z fp fq fr fs ft fu fv fw dk translated"><a class="ae af ag ah ai aj ak al am an ao ap aq ar as" href="https://medium.com/@omgzui?source=post_page-----bc03f083346d--------------------------------" rel="noopener follow" target="_top"> omgzui </a></p></div></div><div class="ny nz gw l"><h2 class="bd ir tj mo fp tk fr fs tl fu fw ip bi translated">Java Script语言</h2></div><div class="ab q"><div class="l fo"><a class="bd b be z bi tm au tn to tp pt tq an eh ei tr ts tt el em eo de bk ep" href="https://medium.com/@omgzui/list/javascript-48bfc7b5f93c?source=post_page-----bc03f083346d--------------------------------" rel="noopener follow" target="_top">View list</a></div><div class="tu l fo"><span class="bd b dl z dk">57 stories</span></div></div></div><div class="ol dh om fp ab on fo di"><div class="di od bv oe of"><div class="dh l"><img alt="" class="dh" src="../Images/64fcf15e27c514ec49d62966b68dbc15.png" width="194" height="194" loading="lazy" role="presentation" data-original-src="https://miro.medium.com/v2/resize:fill:388:388/0*DbDdSUf5SchniJuq"/></div></div><div class="di od bv og oh oi"><div class="dh l"><img alt="" class="dh" src="../Images/3e6ce891363c151131c5993ca0dcc526.png" width="194" height="194" loading="lazy" role="presentation" data-original-src="https://miro.medium.com/v2/resize:fill:388:388/0*7cAp-WibSblfO7hT"/></div></div><div class="di bv oj ok oi"><div class="dh l"><img alt="" class="dh" src="../Images/a7dd413de22f319a3c4729c9e737feb8.png" width="194" height="194" loading="lazy" role="presentation" data-original-src="https://miro.medium.com/v2/resize:fill:388:388/0*FcmHdVfoUOhlJlsG"/></div></div></div></div></div><p id="7f03" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><em class="or">更多内容请看</em><a class="ae kc" href="https://plainenglish.io/" rel="noopener ugc nofollow" target="_blank"><strong class="kf ir"><em class="or">plain English . io</em></strong></a><em class="or">。报名参加我们的</em> <a class="ae kc" href="http://newsletter.plainenglish.io/" rel="noopener ugc nofollow" target="_blank"> <strong class="kf ir"> <em class="or">免费周报</em> </strong> </a> <em class="or">。关注我们关于</em><a class="ae kc" href="https://twitter.com/inPlainEngHQ" rel="noopener ugc nofollow" target="_blank"><strong class="kf ir"><em class="or">Twitter</em></strong></a><a class="ae kc" href="https://www.linkedin.com/company/inplainenglish/" rel="noopener ugc nofollow" target="_blank"><strong class="kf ir"><em class="or">LinkedIn</em></strong></a><em class="or"/><a class="ae kc" href="https://www.youtube.com/channel/UCtipWUghju290NWcn8jhyAw" rel="noopener ugc nofollow" target="_blank"><strong class="kf ir"><em class="or">YouTube</em></strong></a><em class="or"/><a class="ae kc" href="https://discord.gg/GtDtUAvyhW" rel="noopener ugc nofollow" target="_blank"><strong class="kf ir"><em class="or">不和</em> </strong> </a> <em class="or">。</em></p></div></div>    
</body>
</html>