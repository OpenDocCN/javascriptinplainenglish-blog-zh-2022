<html>
<head>
<title>How to Implement a Request Interceptor Like Axios</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何实现像Axios这样的请求拦截器</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/how-to-implement-a-request-interceptor-like-axios-896a1431304a?source=collection_archive---------4-----------------------#2022-07-14">https://javascript.plainenglish.io/how-to-implement-a-request-interceptor-like-axios-896a1431304a?source=collection_archive---------4-----------------------#2022-07-14</a></blockquote><div><div class="fc if ig ih ii ij"/><div class="ik il im in io"><div class=""/><div class=""><h2 id="5b7b" class="pw-subtitle-paragraph jo iq ir bd b jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf dk translated">在处理请求或响应之前拦截它们</h2></div><figure class="kh ki kj kk gu kl gi gj paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="gi gj kg"><img src="../Images/c78df517d9379fe9dd2f5afac346e8ad.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NK_9b2NUSPTkOrXkUMmJZw.png"/></div></div></figure><h1 id="f855" class="ks kt ir bd ku kv kw kx ky kz la lb lc jx ld jy le ka lf kb lg kd lh ke li lj bi translated">介绍</h1><p id="a522" class="pw-post-body-paragraph lk ll ir lm b ln lo js lp lq lr jv ls lt lu lv lw lx ly lz ma mb mc md me mf ik bi translated">正如在这篇文章“为什么我更喜欢在Web应用中使用Axios”中提到的:</p><div class="mg mh gq gs mi mj"><a rel="noopener  ugc nofollow" target="_blank" href="/why-i-prefer-axios-in-web-app-9a78d655fd1d"><div class="mk ab fp"><div class="ml ab mm cl cj mn"><h2 class="bd is gz z fq mo fs ft mp fv fx iq bi translated">为什么我更喜欢在Web应用程序中使用Axios</h2><div class="mq l"><h3 class="bd b gz z fq mo fs ft mp fv fx dk translated">同构和基于承诺的代码使开发更加高效</h3></div><div class="mr l"><p class="bd b dl z fq mo fs ft mp fv fx dk translated">javascript.plainenglish.io</p></div></div><div class="ms l"><div class="mt l mu mv mw ms mx kq mj"/></div></div></a></div><p id="b71d" class="pw-post-body-paragraph lk ll ir lm b ln my js lp lq mz jv ls lt na lv lw lx nb lz ma mb nc md me mf ik bi translated">Axios的拦截器是我喜欢在我的项目中使用axios的原因之一，它使与请求相关的代码更有凝聚力。例如，在我的项目中，我通常在请求阶段根据请求调整请求参数，并在响应阶段使用toast提示用户是否有异常。</p><pre class="kh ki kj kk gu nd ne nf ng aw nh bi"><span id="b671" class="ni kt ir ne b gz nj nk l nl nm">// intercept request to transform config.<br/>axios.interceptors.request.use(function(config) {<br/>  if (config.method === 'get') {<br/>    config.params = config.data;<br/>    config.data = undefined;<br/>  }<br/>  return config;<br/>})</span><span id="fc9d" class="ni kt ir ne b gz nn nk l nl nm">//intercept response to check the data<br/>axios.interceptors.response.use(function(config) {<br/>  if (!config.data || config.data.code !== 200) {<br/>    toast('there something error');<br/>    throw config;<br/>  }<br/>  return config;<br/>})</span></pre><p id="81a5" class="pw-post-body-paragraph lk ll ir lm b ln my js lp lq mz jv ls lt na lv lw lx nb lz ma mb nc md me mf ik bi translated">在本文中，我们将模拟axios实现，并基于<code class="fe no np nq ne b">fetch</code>逐步实现拦截器。</p><h1 id="a165" class="ks kt ir bd ku kv kw kx ky kz la lb lc jx ld jy le ka lf kb lg kd lh ke li lj bi translated">步骤1:拦截器管理器</h1><p id="77c3" class="pw-post-body-paragraph lk ll ir lm b ln lo js lp lq lr jv ls lt lu lv lw lx ly lz ma mb mc md me mf ik bi translated">我们需要拦截请求和响应，两者的用法是一样的。因此，可以完成拦截器管理器类来生成拦截器实例。拦截器管理器的主要功能是维护拦截器，并提供获取所有注册拦截器的方法。</p><figure class="kh ki kj kk gu kl"><div class="bz fq l di"><div class="nr ns l"/></div></figure><p id="4a0e" class="pw-post-body-paragraph lk ll ir lm b ln my js lp lq mz jv ls lt na lv lw lx nb lz ma mb nc md me mf ik bi translated">是的，拦截器管理器实际上就是这么简单。只是用来注册拦截器，甚至不需要知道拦截器是请求还是响应。</p><h1 id="1d6a" class="ks kt ir bd ku kv kw kx ky kz la lb lc jx ld jy le ka lf kb lg kd lh ke li lj bi translated">第二步:包装提取</h1><p id="71b5" class="pw-post-body-paragraph lk ll ir lm b ln lo js lp lq lr jv ls lt lu lv lw lx ly lz ma mb mc md me mf ik bi translated"><code class="fe no np nq ne b">fetch</code>提供了一种简单、合理的方式来通过网络异步获取资源，但它不支持插件或附加扩展。所以我们需要包装一个基于<code class="fe no np nq ne b">fetch</code>的请求方法，这样我们就可以实现拦截器功能。方法名我没什么好主意，就叫<code class="fe no np nq ne b">fetchPlus</code>吧。给它添加两个属性<code class="fe no np nq ne b">requestInterceptors</code>和<code class="fe no np nq ne b">responseInterceptors</code>，用于注册拦截器。</p><pre class="kh ki kj kk gu nd ne nf ng aw nh bi"><span id="fdd0" class="ni kt ir ne b gz nj nk l nl nm">// create method based on fetch<br/>function fetchPlus(url, init) {<br/>  return fetch(url, init);<br/>} <br/>// use for registering request interceptor<br/>fetchPlus.<!-- -->requestInterceptors = new <!-- -->InterceptorManager();</span><span id="7ce8" class="ni kt ir ne b gz nn nk l nl nm">// use for register response interceptor<br/>fetchPlus.responseInterceptors = new InterceptorManager();</span></pre><p id="f3f5" class="pw-post-body-paragraph lk ll ir lm b ln my js lp lq mz jv ls lt na lv lw lx nb lz ma mb nc md me mf ik bi translated">现在主流程基本完成，接下来需要实现最重要的部分。</p><h1 id="0d8e" class="ks kt ir bd ku kv kw kx ky kz la lb lc jx ld jy le ka lf kb lg kd lh ke li lj bi translated">步骤3:拦截请求</h1><p id="2a02" class="pw-post-body-paragraph lk ll ir lm b ln lo js lp lq lr jv ls lt lu lv lw lx ly lz ma mb mc md me mf ik bi translated">拦截器可能是异步的，我们不能直接迭代拦截器并执行函数。对于异步函数，我们可以通过使用promise来链接调用。</p><figure class="kh ki kj kk gu kl gi gj paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="gi gj nt"><img src="../Images/111dc42ba7e826e7c6880656f790be3e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QQTDvYcoUxGp__VR45TAzQ.png"/></div></div></figure><p id="ed23" class="pw-post-body-paragraph lk ll ir lm b ln my js lp lq mz jv ls lt na lv lw lx nb lz ma mb nc md me mf ik bi translated">当我们有多个请求拦截器时，我们需要设置一个优先级。实用的办法是让后面注册的优先级高一些。我们可以改进fetchPlus函数，增加拦截功能。</p><figure class="kh ki kj kk gu kl"><div class="bz fq l di"><div class="nr ns l"/></div></figure><h1 id="dd5a" class="ks kt ir bd ku kv kw kx ky kz la lb lc jx ld jy le ka lf kb lg kd lh ke li lj bi translated">步骤4:测试拦截器</h1><p id="f5fb" class="pw-post-body-paragraph lk ll ir lm b ln lo js lp lq lr jv ls lt lu lv lw lx ly lz ma mb mc md me mf ik bi translated">为了测试方便，我们来模拟一下<code class="fe no np nq ne b">fetchPlus</code>中的<code class="fe no np nq ne b">dispatchRequest</code>方法。</p><pre class="kh ki kj kk gu nd ne nf ng aw nh bi"><span id="017e" class="ni kt ir ne b gz nj nk l nl nm">const dispatchRequest = init =&gt; {<br/>  console.log('fetch starting');<br/>  return new Promise((resolve) =&gt; {<br/>    setTimeout(() =&gt; {<br/>      console.log('request done');<br/>      resolve({code: 0});<br/>    }, 500);<br/>  })<br/>}</span></pre><p id="e95e" class="pw-post-body-paragraph lk ll ir lm b ln my js lp lq mz jv ls lt na lv lw lx nb lz ma mb nc md me mf ik bi translated">让我们再写几个拦截器:</p><pre class="kh ki kj kk gu nd ne nf ng aw nh bi"><span id="c30d" class="ni kt ir ne b gz nj nk l nl nm">// request interceptors<br/>fetchPlus.requestInterceptors.use(config =&gt; {<br/>  console.log('request interceptor 1');<br/>  console.log(config);<br/>  return config;<br/>})<br/>fetchPlus.requestInterceptors.use(config =&gt; {<br/>  console.log('request interceptor 2');<br/>  if (config.method === 'post') {<br/>    config.body = JSON.stringify(config.data);<br/>    delete config.data;<br/>    config.headers = config.headers || {}<br/>    config.headers['content-type'] = 'application/json';<br/>  }<br/>  return config;<br/>});<br/>fetchPlus.requestInterceptors.use(config =&gt; {<br/>  console.log('request interceptor 3');<br/>  return config;<br/>})</span><span id="b0c0" class="ni kt ir ne b gz nn nk l nl nm">// response interceptors<br/>fetchPlus.responseInterceptors.use(res =&gt; {<br/>  if (!res.data) {<br/>    console.log('error');<br/>    throw res;<br/>  }<br/>  return res;<br/>});</span></pre><p id="b7bc" class="pw-post-body-paragraph lk ll ir lm b ln my js lp lq mz jv ls lt na lv lw lx nb lz ma mb nc md me mf ik bi translated">然后，使用<code class="fe no np nq ne b">fetchPlus</code>发送请求:</p><pre class="kh ki kj kk gu nd ne nf ng aw nh bi"><span id="df21" class="ni kt ir ne b gz nj nk l nl nm">fetchPlus('<a class="ae nu" href="https://example.com'" rel="noopener ugc nofollow" target="_blank">https://example.com'</a>, {method: 'post', data: {foo: 'bar'}}).then(res =&gt; {<br/>  console.log('response-&gt;', res);<br/>}).catch(err =&gt; {<br/>  console.log('response error-&gt;', err);<br/>});</span></pre><figure class="kh ki kj kk gu kl gi gj paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="gi gj nv"><img src="../Images/65462f466ec06d847b6b3c4cd57bed1b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8hLVw_ES1OvyBY_-IJ47Bg.png"/></div></div><figcaption class="nw nx gk gi gj ny nz bd b be z dk">test for interceptors</figcaption></figure><p id="6767" class="pw-post-body-paragraph lk ll ir lm b ln my js lp lq mz jv ls lt na lv lw lx nb lz ma mb nc md me mf ik bi translated">我写一个demo，你可以在<a class="ae nu" href="https://codepen.io/bitbug/pen/mdxrgjG" rel="noopener ugc nofollow" target="_blank"> codepen.io </a>上测试一下。</p><h1 id="cb1b" class="ks kt ir bd ku kv kw kx ky kz la lb lc jx ld jy le ka lf kb lg kd lh ke li lj bi translated">结论</h1><p id="cb6a" class="pw-post-body-paragraph lk ll ir lm b ln lo js lp lq lr jv ls lt lu lv lw lx ly lz ma mb mc md me mf ik bi translated">在本文中，用三个步骤实现一个类似axios的拦截器功能。首先，创建拦截器管理器，然后包装fetch函数进行扩展，最后使用promises来链接拦截器。</p><p id="ba15" class="pw-post-body-paragraph lk ll ir lm b ln my js lp lq mz jv ls lt na lv lw lx nb lz ma mb nc md me mf ik bi translated">希望它能帮助你，我期待你<strong class="lm is">跟随</strong>我学习更多实用技巧，成为一名更好的开发者。</p><p id="d04f" class="pw-post-body-paragraph lk ll ir lm b ln my js lp lq mz jv ls lt na lv lw lx nb lz ma mb nc md me mf ik bi translated"><em class="oa">更多内容看</em> <a class="ae nu" href="https://plainenglish.io/" rel="noopener ugc nofollow" target="_blank"> <strong class="lm is"> <em class="oa">说白了。报名参加我们的</em> <a class="ae nu" href="http://newsletter.plainenglish.io/" rel="noopener ugc nofollow" target="_blank"> <strong class="lm is"> <em class="oa">免费周报</em> </strong> </a> <em class="oa">。关注我们关于</em> <a class="ae nu" href="https://twitter.com/inPlainEngHQ" rel="noopener ugc nofollow" target="_blank"> <strong class="lm is"> <em class="oa">推特</em></strong></a><strong class="lm is"><em class="oa"/></strong><em class="oa">和</em><a class="ae nu" href="https://www.linkedin.com/company/inplainenglish/" rel="noopener ugc nofollow" target="_blank"><strong class="lm is"><em class="oa">LinkedIn</em></strong></a><em class="oa">。查看我们的</em> <a class="ae nu" href="https://discord.gg/GtDtUAvyhW" rel="noopener ugc nofollow" target="_blank"> <strong class="lm is"> <em class="oa">社区不和谐</em> </strong> </a> <em class="oa">加入我们的</em> <a class="ae nu" href="https://inplainenglish.pallet.com/talent/welcome" rel="noopener ugc nofollow" target="_blank"> <strong class="lm is"> <em class="oa">人才集体</em> </strong> </a> <em class="oa">。</em></strong></a></p></div></div>    
</body>
</html>