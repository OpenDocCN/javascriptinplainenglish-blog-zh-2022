<html>
<head>
<title>NATS Streaming for Inter-Services Communication — A Node.js Example</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用于服务间通信的NATS流Node.js示例</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/nats-streaming-for-inter-services-communication-nodejs-example-17a40ea4e45d?source=collection_archive---------6-----------------------#2022-03-05">https://javascript.plainenglish.io/nats-streaming-for-inter-services-communication-nodejs-example-17a40ea4e45d?source=collection_archive---------6-----------------------#2022-03-05</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><div class=""><h2 id="1069" class="pw-subtitle-paragraph jk im in bd b jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb dk translated">微服务范例中服务之间的内部通信。</h2></div><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi kc"><img src="../Images/d883ae6c39624e913722b5c1cb83f464.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*FqpSrhVCDHer-KR2"/></div></div><figcaption class="ko kp gj gh gi kq kr bd b be z dk">Photo by <a class="ae ks" href="https://unsplash.com/@cdr6934?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Chris Ried</a> on <a class="ae ks" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="5a6a" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">微服务设计使您能够构建独立的服务，每个服务负责其数据库、错误处理、部署等。这些组件作为一个系统协同工作。</p><p id="6663" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">尽管本文主要关注的是微服务范例中服务之间的内部通信，但是稍微了解一下微服务最常见的架构模式也很重要。</p><h1 id="57f9" class="lp lq in bd lr ls lt lu lv lw lx ly lz jt ma ju mb jw mc jx md jz me ka mf mg bi translated"><strong class="ak">微服务的模式</strong></h1><ul class=""><li id="5ca6" class="mh mi in kv b kw mj kz mk lc ml lg mm lk mn lo mo mp mq mr bi translated">同步:等待，直到响应可用</li><li id="20c7" class="mh mi in kv b kw ms kz mt lc mu lg mv lk mw lo mo mp mq mr bi translated">异步:不需要等待响应</li></ul><p id="af22" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">由于我的首选模式是异步模式，因此本文将主要关注通过使用消息总线管理服务间通信而编排的异步事件。</p></div><div class="ab cl mx my hr mz" role="separator"><span class="na bw bk nb nc nd"/><span class="na bw bk nb nc nd"/><span class="na bw bk nb nc"/></div><div class="ig ih ii ij ik"><h1 id="b9a9" class="lp lq in bd lr ls ne lu lv lw nf ly lz jt ng ju mb jw nh jx md jz ni ka mf mg bi translated">什么是事件总线？</h1><p id="4861" class="pw-post-body-paragraph kt ku in kv b kw mj jo ky kz mk jr lb lc nj le lf lg nk li lj lk nl lm ln lo ig bi translated">允许不同系统基于特定规则和公共数据模型进行通信的消息传递基础设施。</p><h1 id="e0bd" class="lp lq in bd lr ls lt lu lv lw lx ly lz jt ma ju mb jw mc jx md jz me ka mf mg bi translated">什么是NATS河？</h1><p id="195a" class="pw-post-body-paragraph kt ku in kv b kw mj jo ky kz mk jr lb lc nj le lf lg nk li lj lk nl lm ln lo ig bi translated">NATS是一个数据流系统，用于跨云供应商、内部、web和移动以及设备的任意组合进行安全通信。</p><p id="163a" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">在本文中，我们将讨论NATS在同一网络(K8s集群)下基于Docker的容器化服务之间的内部通信中的使用。</p><p id="084d" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">为了便于理解，必须确保我们可以在本地开发和测试数据流，为此，我们已经准备了关于如何准备NATS流及其不同部分的完整文档。</p><p id="818b" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">请注意，我们的示例应用程序将使用Nodejs和Typescript编写。</p><h1 id="1df9" class="lp lq in bd lr ls lt lu lv lw lx ly lz jt ma ju mb jw mc jx md jz me ka mf mg bi translated">我们走吧</h1><p id="f630" class="pw-post-body-paragraph kt ku in kv b kw mj jo ky kz mk jr lb lc nj le lf lg nk li lj lk nl lm ln lo ig bi translated">让我们从NATS的本地部署YAML文件开始:</p><figure class="kd ke kf kg gt kh"><div class="bz fp l di"><div class="nm nn l"/></div></figure><p id="5ccf" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">现在，准备好NATS流基础设施后，我们需要创建以下主要部分:</p><ul class=""><li id="465a" class="mh mi in kv b kw kx kz la lc no lg np lk nq lo mo mp mq mr bi translated">连接:连接到NATS客户端</li><li id="b618" class="mh mi in kv b kw ms kz mt lc mu lg mv lk mw lo mo mp mq mr bi translated">发布者:能够在NATS流上发布事件</li><li id="403c" class="mh mi in kv b kw ms kz mt lc mu lg mv lk mw lo mo mp mq mr bi translated">侦听器:能够侦听NATS流上的事件</li></ul><h1 id="ec29" class="lp lq in bd lr ls lt lu lv lw lx ly lz jt ma ju mb jw mc jx md jz me ka mf mg bi translated">创建NATS连接</h1><p id="95f5" class="pw-post-body-paragraph kt ku in kv b kw mj jo ky kz mk jr lb lc nj le lf lg nk li lj lk nl lm ln lo ig bi translated">在连接到NATS之前，我们需要创建包装器，以确保我们每次都使用同一个客户端。</p><p id="839e" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">下面是NATS包装器的单例实现的示例:</p><figure class="kd ke kf kg gt kh"><div class="bz fp l di"><div class="nm nn l"/></div></figure><p id="1da4" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">现在，是时候从你的入口连接到NATS了。</p><figure class="kd ke kf kg gt kh"><div class="bz fp l di"><div class="nm nn l"/></div></figure><p id="6658" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">连接到NATS后，我们可以根据需要使用我们的发布者和侦听器，这需要发布者和侦听器使用相同的主题，以便向相关的发送者和接收者发送事件。</p><p id="ed28" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">在使用任何数据流基础架构时，注意两点非常重要:</p><ul class=""><li id="02f1" class="mh mi in kv b kw kx kz la lc no lg np lk nq lo mo mp mq mr bi translated">OCC(乐观并发控制):用异步事件处理并发</li><li id="d7d4" class="mh mi in kv b kw ms kz mt lc mu lg mv lk mw lo mo mp mq mr bi translated">队列组(<a class="ae ks" href="https://docs.nats.io/nats-concepts/queue" rel="noopener ugc nofollow" target="_blank">此处阅读</a>)</li></ul><p id="e052" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">这篇文章的灵感来自斯蒂芬·格里德关于NATS流媒体的精彩演讲。</p><p id="b3ce" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated"><em class="nr">更多内容请看</em><a class="ae ks" href="https://plainenglish.io/" rel="noopener ugc nofollow" target="_blank"><strong class="kv io"><em class="nr">plain English . io</em></strong></a><em class="nr">。报名参加我们的</em> <a class="ae ks" href="http://newsletter.plainenglish.io/" rel="noopener ugc nofollow" target="_blank"> <strong class="kv io"> <em class="nr">免费周报</em> </strong> </a> <em class="nr">。关注我们关于</em><a class="ae ks" href="https://twitter.com/inPlainEngHQ" rel="noopener ugc nofollow" target="_blank"><strong class="kv io"><em class="nr">Twitter</em></strong></a><em class="nr">和</em><strong class="kv io"><em class="nr"/></strong><a class="ae ks" href="https://www.linkedin.com/company/inplainenglish/" rel="noopener ugc nofollow" target="_blank"><strong class="kv io"><em class="nr">LinkedIn</em></strong></a><em class="nr">。加入我们的</em> <a class="ae ks" href="https://discord.gg/GtDtUAvyhW" rel="noopener ugc nofollow" target="_blank"> <strong class="kv io"> <em class="nr">社区</em> </strong> </a> <em class="nr">。</em></p></div></div>    
</body>
</html>