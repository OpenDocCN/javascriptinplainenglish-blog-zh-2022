<html>
<head>
<title>Node.js Logging for Professionals</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">专业人员的Node.js日志记录</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/node-js-logging-for-professionals-6be07c003e7f?source=collection_archive---------0-----------------------#2022-08-04">https://javascript.plainenglish.io/node-js-logging-for-professionals-6be07c003e7f?source=collection_archive---------0-----------------------#2022-08-04</a></blockquote><div><div class="fc if ig ih ii ij"/><div class="ik il im in io"><div class=""/><div class=""><h2 id="6b41" class="pw-subtitle-paragraph jo iq ir bd b jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf dk translated">发挥温斯顿和摩根的全部潜力</h2></div><figure class="kh ki kj kk gu kl gi gj paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="gi gj kg"><img src="../Images/f62f31e03f1632eb4c1d1340546702cc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_TF41GE3B9jE_O9qKeqzdw.jpeg"/></div></div><figcaption class="ks kt gk gi gj ku kv bd b be z dk">Photo by <a class="ae kw" href="https://unsplash.com/@cgower?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">Christopher Gower</a> on <a class="ae kw" href="https://unsplash.com/s/photos/technology?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="2a04" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">日志记录是任何生产级应用程序的重要组成部分。这是最重要的部分之一。</p><p id="18e9" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">今天我们将学习如何在Node.js中有效地使用日志记录，以及如何在生产级应用程序中使用日志记录。</p><h2 id="111d" class="lt lu ir bd lv lw lx dn ly lz ma dp mb lg mc md me lk mf mg mh lo mi mj mk ml bi translated">在我们开始之前…</h2><p id="3c5a" class="pw-post-body-paragraph kx ky ir kz b la mm js lc ld mn jv lf lg mo li lj lk mp lm ln lo mq lq lr ls ik bi translated">我用ExpressJS和Typescript 创建了一个<a class="ae kw" href="https://github.com/Mohammad-Faisal/professional-express-sequelize-docker-boilerplate" rel="noopener ugc nofollow" target="_blank">专业样板。本文是这个系列的一部分。你可以在下面找到所有的文章。</a></p><pre class="kh ki kj kk gu mr ms mt bn mu mv bi"><span id="7fd0" class="mw lu ir ms b be mx my l mz na"><strong class="ms is">* </strong><a class="ae kw" rel="noopener ugc nofollow" target="_blank" href="/create-an-express-boilerplate-with-typescript-810eb6c29196"><strong class="ms is">Creating a ExpressJS + Typescript Boilerplate</strong></a><strong class="ms is"><br/><br/>* </strong><a class="ae kw" rel="noopener ugc nofollow" target="_blank" href="/how-to-set-up-linter-formatter-for-node-js-d6b34c0c8be5"><strong class="ms is">How to setup Linter and Formatter for NodeJS</strong></a><strong class="ms is"><br/><br/>* </strong><a class="ae kw" href="https://blog.devgenius.io/how-to-handle-multiple-environments-in-nodejs-7391d2db2abe" rel="noopener ugc nofollow" target="_blank"><strong class="ms is">How to handle multiple environments in NodeJS</strong></a><strong class="ms is"><br/><br/>* </strong><a class="ae kw" rel="noopener ugc nofollow" target="_blank" href="/error-handling-in-node-js-like-a-pro-ed210baa0600"><strong class="ms is">Error Handling in NodeJS</strong></a><strong class="ms is"><br/><br/>* </strong><a class="ae kw" href="https://medium.com/p/c69f2494cf18" rel="noopener"><strong class="ms is">Request validation in NodeJS</strong></a><strong class="ms is"><br/><br/>* </strong><a class="ae kw" href="https://levelup.gitconnected.com/use-docker-with-nodejs-projects-like-a-pro-a9e7504e1308" rel="noopener ugc nofollow" target="_blank"><strong class="ms is">Using Docker Professionally with NodeJS</strong></a><strong class="ms is"><br/><br/>* </strong><a class="ae kw" rel="noopener ugc nofollow" target="_blank" href="/node-js-database-with-docker-for-local-development-285212c5162f"><strong class="ms is">Using Docker for Local Development in NodeJS</strong></a><strong class="ms is"><br/><br/>* </strong><a class="ae kw" rel="noopener ugc nofollow" target="_blank" href="/node-js-logging-for-professionals-6be07c003e7f"><strong class="ms is">Logging in NodeJS</strong></a><strong class="ms is"><br/><br/>* </strong><a class="ae kw" href="https://levelup.gitconnected.com/kubernetes-deployment-with-nodejs-made-easy-eaeec32b62e3" rel="noopener ugc nofollow" target="_blank"><strong class="ms is">Kubernetes with NodeJS</strong></a></span></pre><p id="1d9f" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">我们开始吧！</p><h1 id="434c" class="nb lu ir bd lv nc nd ne ly nf ng nh mb jx ni jy me ka nj kb mh kd nk ke mk nl bi translated">选择</h1><p id="a921" class="pw-post-body-paragraph kx ky ir kz b la mm js lc ld mn jv lf lg mo li lj lk mp lm ln lo mq lq lr ls ik bi translated">Node.js有很多很好的日志库，其中最流行的当然是<a class="ae kw" href="https://www.npmjs.com/package/winston" rel="noopener ugc nofollow" target="_blank"> winston </a>。这是一个通用日志库，能够满足您所有的日志需求。</p><p id="e015" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">此外，还有一个专门用于HTTP请求的库。那个叫<a class="ae kw" href="https://www.npmjs.com/package/morgan" rel="noopener ugc nofollow" target="_blank">的摩根</a>。</p><p id="62f5" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">今天，我们将在应用程序中使用这两个库。</p><h1 id="d756" class="nb lu ir bd lv nc nd ne ly nf ng nh mb jx ni jy me ka nj kb mh kd nk ke mk nl bi translated">出发点</h1><p id="0501" class="pw-post-body-paragraph kx ky ir kz b la mm js lc ld mn jv lf lg mo li lj lk mp lm ln lo mq lq lr ls ik bi translated">今天，我们将在用TypeScript构建的现有Node.js应用程序上集成日志记录。您可以在下面的文章中了解更多关于我们如何构建它的信息:</p><div class="nm nn gq gs no np"><a href="https://www.mohammadfaisal.dev/blog/create-express-typescript-boilerplate" rel="noopener  ugc nofollow" target="_blank"><div class="nq ab fp"><div class="nr ab ns cl cj nt"><h2 class="bd is gz z fq nu fs ft nv fv fx iq bi translated">创建-快递-打字稿-样板文章|穆罕默德·费萨尔</h2><div class="nw l"><h3 class="bd b gz z fq nu fs ft nv fv fx dk translated">ExpressJS是NodeJS应用程序最流行的框架。它非常通用，没有任何限制。所以你…</h3></div><div class="nx l"><p class="bd b dl z fq nu fs ft nv fv fx dk translated">www.mohammadfaisal.dev</p></div></div><div class="ny l"><div class="nz l oa ob oc ny od kq np"/></div></div></a></div><p id="667c" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">但是你可以自由使用任何你喜欢的应用程序。</p><h1 id="1331" class="nb lu ir bd lv nc nd ne ly nf ng nh mb jx ni jy me ka nj kb mh kd nk ke mk nl bi translated">拿样板文件</h1><p id="71dc" class="pw-post-body-paragraph kx ky ir kz b la mm js lc ld mn jv lf lg mo li lj lk mp lm ln lo mq lq lr ls ik bi translated">让我们首先克隆<a class="ae kw" href="https://github.com/Mohammad-Faisal/express-typescript-skeleton" rel="noopener ugc nofollow" target="_blank">样板存储库</a>，在这里我们有一个工作Node.js应用程序，已经设置了TypeScript、ESLint和Prettier。</p><pre class="kh ki kj kk gu mr ms oe of aw og bi"><span id="e173" class="lt lu ir ms b gz oh oi l mz na">git clone <a class="ae kw" href="https://github.com/Mohammad-Faisal/express-typescript-skeleton.git" rel="noopener ugc nofollow" target="_blank">https://github.com/Mohammad-Faisal/express-typescript-skeleton.git</a></span></pre><h1 id="d7c0" class="nb lu ir bd lv nc nd ne ly nf ng nh mb jx ni jy me ka nj kb mh kd nk ke mk nl bi translated">安装依赖项</h1><p id="8795" class="pw-post-body-paragraph kx ky ir kz b la mm js lc ld mn jv lf lg mo li lj lk mp lm ln lo mq lq lr ls ik bi translated">然后进入项目内部并安装依赖项。</p><pre class="kh ki kj kk gu mr ms oe of aw og bi"><span id="1956" class="lt lu ir ms b gz oh oi l mz na">yarn add winston</span></pre><p id="4718" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">然后创建一个记录器实例。</p><figure class="kh ki kj kk gu kl"><div class="bz fq l di"><div class="oj ok l"/></div><figcaption class="ks kt gk gi gj ku kv bd b be z dk">logger.ts</figcaption></figure><p id="9ae1" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">在这个配置中，<code class="fe ol om on ms b">createLogger</code>函数是从Winston库中导出的。我们已经通过了两个选项。</p><p id="2b73" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated"><code class="fe ol om on ms b"><strong class="kz is">format</strong></code> - &gt;表示我们想要的格式。我们已经指定，我们希望我们的日志是JSON格式，并包括时间戳。</p><p id="02d1" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated"><code class="fe ol om on ms b"><strong class="kz is">transports</strong></code> - &gt;表示我们的日志要放在哪里。我们定义我们希望我们的错误日志到一个名为<code class="fe ol om on ms b">errors.log</code>的文件中。</p><p id="74a8" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">现在让我们在<code class="fe ol om on ms b">index.ts</code>文件中创建它。</p><pre class="kh ki kj kk gu mr ms oe of aw og bi"><span id="9ec5" class="lt lu ir ms b gz oh oi l mz na">import logger from "./logger";</span><span id="588c" class="lt lu ir ms b gz oo oi l mz na">logger.error("Something went wrong");</span></pre><p id="938d" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">如果我们运行这段代码，我们会看到一个名为<code class="fe ol om on ms b">errors.log</code>的新文件被创建，并且会有一个条目。</p><pre class="kh ki kj kk gu mr ms oe of aw og bi"><span id="8ba8" class="lt lu ir ms b gz oh oi l mz na">{ <br/>  "level": "error", <br/>  "message": "Something went wrong", <br/>  "timestamp": "2022-04-16T12:16:13.903Z" <br/>}</span></pre><p id="649c" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">这是登录我们的应用程序的最基本的格式。</p><h1 id="b18f" class="nb lu ir bd lv nc nd ne ly nf ng nh mb jx ni jy me ka nj kb mh kd nk ke mk nl bi translated">将开发日志放入控制台。</h1><p id="f8df" class="pw-post-body-paragraph kx ky ir kz b la mm js lc ld mn jv lf lg mo li lj lk mp lm ln lo mq lq lr ls ik bi translated">在开发我们的应用程序时，我们不希望每当出现错误时就检查我们的错误日志文件。我们希望它们直接进入控制台。</p><p id="358e" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">我们已经讨论过传输，它们是我们给出日志输出的通道。让我们为控制台创建一个新的传输，并在开发模式中添加它。</p><figure class="kh ki kj kk gu kl"><div class="bz fq l di"><div class="oj ok l"/></div><figcaption class="ks kt gk gi gj ku kv bd b be z dk">logger.ts</figcaption></figure><p id="1a4b" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">此配置会将所有日志发送到控制台。</p><p id="eced" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">如果您仔细观察，您会发现我们正在向我们的日志添加一些格式:</p><pre class="kh ki kj kk gu mr ms oe of aw og bi"><span id="6fe2" class="lt lu ir ms b gz oh oi l mz na">format: format.combine(format.colorize(), format.simple()),</span></pre><p id="82f7" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">我们将开发日志着色，并保持简单。你可以在这里看看可能的选择:</p><div class="nm nn gq gs no np"><a href="https://github.com/winstonjs/logform#readme" rel="noopener  ugc nofollow" target="_blank"><div class="nq ab fp"><div class="nr ab ns cl cj nt"><h2 class="bd is gz z fq nu fs ft nv fv fx iq bi translated">GitHub - winstonjs/logform:一种可变的对象格式，设计用于链接&amp; objectMode流</h2><div class="nw l"><h3 class="bd b gz z fq nu fs ft nv fv fx dk translated">一种可变的基于对象的日志格式，设计用于链接&amp; objectMode流。提供给给定的信息参数…</h3></div><div class="nx l"><p class="bd b dl z fq nu fs ft nv fv fx dk translated">github.com</p></div></div><div class="ny l"><div class="op l oa ob oc ny od kq np"/></div></div></a></div><h1 id="f463" class="nb lu ir bd lv nc nd ne ly nf ng nh mb jx ni jy me ka nj kb mh kd nk ke mk nl bi translated">服务特定日志</h1><p id="88f3" class="pw-post-body-paragraph kx ky ir kz b la mm js lc ld mn jv lf lg mo li lj lk mp lm ln lo mq lq lr ls ik bi translated">有时我们希望更好地分隔日志，并希望对日志进行分组。我们可以通过在选项中指定一个服务字段来做到这一点。假设我们有一个计费服务和认证服务。我们可以为每个实例创建一个单独的记录器。</p><pre class="kh ki kj kk gu mr ms oe of aw og bi"><span id="3909" class="lt lu ir ms b gz oh oi l mz na">const logger = createLogger({<br/>  defaultMeta: {<br/>    service: "billing-service",<br/>  },<br/>  //... other configs<br/>});</span></pre><p id="ac4f" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">这一次，我们所有的日志都将采用类似这样的格式。</p><pre class="kh ki kj kk gu mr ms oe of aw og bi"><span id="6bd4" class="lt lu ir ms b gz oh oi l mz na">{<br/>  "level": "error",<br/>  "message": "Something went wrong",<br/>  "service": "billing-service",<br/>  "timestamp": "2022-04-16T15:22:16.944Z"<br/>}</span></pre><p id="3ad9" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">这有助于分析日志信件。</p><h1 id="bb3d" class="nb lu ir bd lv nc nd ne ly nf ng nh mb jx ni jy me ka nj kb mh kd nk ke mk nl bi translated">我们可以做得更好。</h1><p id="d3e6" class="pw-post-body-paragraph kx ky ir kz b la mm js lc ld mn jv lf lg mo li lj lk mp lm ln lo mq lq lr ls ik bi translated">有时我们需要单独的日志级控制。例如，如果我们想要跟踪用户的流量，我们可能需要为每一级信息添加信息。这对于服务级别定制是不可能的。</p><p id="a7ec" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">为此，我们可以使用<code class="fe ol om on ms b"><a class="ae kw" href="https://github.com/winstonjs/winston#creating-child-loggers" rel="noopener ugc nofollow" target="_blank">child-logger</a></code></p><p id="7cf7" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">这个概念允许我们注入关于单个日志条目的上下文信息。</p><pre class="kh ki kj kk gu mr ms oe of aw og bi"><span id="4e0b" class="lt lu ir ms b gz oh oi l mz na">import logger from "./utils/logger";</span><span id="f5fa" class="lt lu ir ms b gz oo oi l mz na">const childLogger = logger.child({ requestId: "451" });</span><span id="372a" class="lt lu ir ms b gz oo oi l mz na">childLogger.error("Something went wrong");</span></pre><p id="fcdf" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">这一次，我们将为每个请求id获取单独的错误日志，以便稍后进行过滤。</p><pre class="kh ki kj kk gu mr ms oe of aw og bi"><span id="d872" class="lt lu ir ms b gz oh oi l mz na">{<br/>  "level": "error",<br/>  "message": "Something went wrong",<br/>  "requestId": "451",<br/>  "service": "billing-service",<br/>  "timestamp": "2022-04-16T15:25:50.446Z"<br/>}</span></pre><p id="0b6b" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">我们还可以记录异常和未处理的承诺拒绝，以防失败。<code class="fe ol om on ms b"><strong class="kz is">winston</strong></code>为我们提供了一个很好的工具。</p><figure class="kh ki kj kk gu kl"><div class="bz fq l di"><div class="oj ok l"/></div><figcaption class="ks kt gk gi gj ku kv bd b be z dk">winston.ts</figcaption></figure><h1 id="6e6b" class="nb lu ir bd lv nc nd ne ly nf ng nh mb jx ni jy me ka nj kb mh kd nk ke mk nl bi translated">衡量绩效。</h1><p id="0a59" class="pw-post-body-paragraph kx ky ir kz b la mm js lc ld mn jv lf lg mo li lj lk mp lm ln lo mq lq lr ls ik bi translated">我们可以通过使用这个记录器来分析我们的请求:</p><figure class="kh ki kj kk gu kl"><div class="bz fq l di"><div class="oj ok l"/></div><figcaption class="ks kt gk gi gj ku kv bd b be z dk">logger.ts</figcaption></figure><p id="15e2" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">这将给出关于性能的附加输出。</p><pre class="kh ki kj kk gu mr ms oe of aw og bi"><span id="540e" class="lt lu ir ms b gz oh oi l mz na">{ <br/>  "durationMs": 5, <br/>  "level": "info", <br/>  "message": "meaningful-name", <br/>  "timestamp": "2022-03-12T17:40:59.093Z" <br/>}</span></pre><p id="f6cd" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">你可以在这里看到更多关于<code class="fe ol om on ms b">winston</code>的例子:</p><div class="nm nn gq gs no np"><a href="https://github.com/winstonjs/winston/tree/master/examples" rel="noopener  ugc nofollow" target="_blank"><div class="nq ab fp"><div class="nr ab ns cl cj nt"><h2 class="bd is gz z fq nu fs ft nv fv fx iq bi translated">winstonjs大师的例子</h2><div class="nw l"><h3 class="bd b gz z fq nu fs ft nv fv fx dk translated">几乎所有事情的记录者。在GitHub上创建一个帐户，为winstonjs/winston开发做贡献。</h3></div><div class="nx l"><p class="bd b dl z fq nu fs ft nv fv fx dk translated">github.com</p></div></div><div class="ny l"><div class="oq l oa ob oc ny od kq np"/></div></div></a></div><h1 id="e97e" class="nb lu ir bd lv nc nd ne ly nf ng nh mb jx ni jy me ka nj kb mh kd nk ke mk nl bi translated">利用摩根</h1><p id="0cf8" class="pw-post-body-paragraph kx ky ir kz b la mm js lc ld mn jv lf lg mo li lj lk mp lm ln lo mq lq lr ls ik bi translated">至此，您应该明白为什么Winston即使不是最好的，也是最好的日志库之一。但是它是用于通用日志记录的。</p><p id="05a1" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">另一个库可以帮助我们进行更复杂的日志记录，特别是对于HTTP请求。那个图书馆叫做<a class="ae kw" href="https://www.npmjs.com/package/morgan" rel="noopener ugc nofollow" target="_blank">摩根</a>。</p><p id="e808" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">首先，创建一个将拦截所有请求的中间件。我正在将它添加到<code class="fe ol om on ms b">middlewares/morgan.ts</code>文件中:</p><figure class="kh ki kj kk gu kl"><div class="bz fq l di"><div class="oj ok l"/></div><figcaption class="ks kt gk gi gj ku kv bd b be z dk">morganMiddleware.ts</figcaption></figure><p id="d462" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">注意我们是如何修改流方法来使用Winston记录器的。morgan有一些预定义的日志格式，如tiny和combined，您可以使用如下格式:</p><pre class="kh ki kj kk gu mr ms oe of aw og bi"><span id="7e5f" class="lt lu ir ms b gz oh oi l mz na">const morganMiddleware = morgan("combined", {<br/>  stream,<br/>  skip,<br/>});</span></pre><p id="570b" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">这将以单独的格式输出。</p><p id="d2d5" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">现在在<code class="fe ol om on ms b">index.ts</code>文件中使用这个中间件:</p><pre class="kh ki kj kk gu mr ms oe of aw og bi"><span id="d683" class="lt lu ir ms b gz oh oi l mz na">import morganMiddleware from "./middlewares/morgan";</span><span id="fb9f" class="lt lu ir ms b gz oo oi l mz na">app.use(morganMiddleware);</span></pre><p id="6e90" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">现在，所有的out请求都将记录在Winston的HTTP层中。</p><pre class="kh ki kj kk gu mr ms oe of aw og bi"><span id="188a" class="lt lu ir ms b gz oh oi l mz na">{ "level": "http", "message": "GET /ping 304 - - 11.140 ms ::1\n", "timestamp": "2022-03-12T19:57:43.166Z" }</span></pre><p id="0251" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">这样，您也可以维护所有HTTP请求引用。</p><h1 id="ace7" class="nb lu ir bd lv nc nd ne ly nf ng nh mb jx ni jy me ka nj kb mh kd nk ke mk nl bi translated">根据类型分离日志</h1><p id="c77e" class="pw-post-body-paragraph kx ky ir kz b la mm js lc ld mn jv lf lg mo li lj lk mp lm ln lo mq lq lr ls ik bi translated">所有的日志都不一样。您可能需要将错误日志和信息日志分开。我们之前讨论了传输以及它如何帮助我们将日志流式传输到不同的目的地。</p><p id="8b5d" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">我们可以利用这个概念，过滤日志，并把它们发送到不同的目的地。</p><p id="2299" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">让我们为我们的日志创建一些过滤器！</p><figure class="kh ki kj kk gu kl"><div class="bz fq l di"><div class="oj ok l"/></div><figcaption class="ks kt gk gi gj ku kv bd b be z dk">filter.ts</figcaption></figure><p id="618e" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">然后修改我们的传输阵列以利用这一点:</p><figure class="kh ki kj kk gu kl"><div class="bz fq l di"><div class="oj ok l"/></div><figcaption class="ks kt gk gi gj ku kv bd b be z dk">logger.ts</figcaption></figure><p id="3559" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">如果仔细观察，您会发现每种类型的日志都有三个单独的日志文件。</p><h1 id="78f4" class="nb lu ir bd lv nc nd ne ly nf ng nh mb jx ni jy me ka nj kb mh kd nk ke mk nl bi translated">日志文件的每日循环</h1><p id="1db0" class="pw-post-body-paragraph kx ky ir kz b la mm js lc ld mn jv lf lg mo li lj lk mp lm ln lo mq lq lr ls ik bi translated">现在，在生产系统中，维护这些日志文件可能会很痛苦。因为如果您的日志文件太大，那么一开始就没有必要保存日志。</p><p id="2761" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">我们必须轮换我们的日志文件，还需要有一种方法来组织它们。</p><p id="a0aa" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">这就是为什么有一个叫做<a class="ae kw" href="https://www.npmjs.com/package/winston-daily-rotate-file" rel="noopener ugc nofollow" target="_blank">的漂亮模块。</a></p><p id="b8ac" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">我们可以用它来进行配置，这样我们的日志文件每天都会轮换，我们还可以传入大量的配置，比如文件的最大大小。</p><p id="229d" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">首先，安装它:</p><pre class="kh ki kj kk gu mr ms oe of aw og bi"><span id="f01b" class="lt lu ir ms b gz oh oi l mz na">yarn add winston-daily-rotate-file</span></pre><p id="e3ac" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">然后在<code class="fe ol om on ms b">winston</code>内更换我们的运输机:</p><pre class="kh ki kj kk gu mr ms oe of aw og bi"><span id="9b5f" class="lt lu ir ms b gz oh oi l mz na">const infoTransport: DailyRotateFile = new DailyRotateFile({<br/>  filename: "logs/info-%DATE%.log",<br/>  datePattern: "HH-DD-MM-YYYY",<br/>  zippedArchive: true,<br/>  maxSize: "20m",<br/>  maxFiles: "14d",<br/>  level: "info",<br/>  format: format.combine(infoFilter(), format.timestamp(), json()),<br/>});</span></pre><p id="974e" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">对所有日志级别都这样做，并在Winston中的传输中传递它:</p><pre class="kh ki kj kk gu mr ms oe of aw og bi"><span id="7d4a" class="lt lu ir ms b gz oh oi l mz na">transports: [new transports.Console(), httpTransport, infoTransport, errorTransport],</span></pre><p id="fc5a" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">现在，您将在以指定格式命名的日志文件夹中看到新的日志文件。</p><p id="07bf" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">这应该可以解决你所有的日志问题。</p><h1 id="d068" class="nb lu ir bd lv nc nd ne ly nf ng nh mb jx ni jy me ka nj kb mh kd nk ke mk nl bi translated">最终版</h1><p id="f991" class="pw-post-body-paragraph kx ky ir kz b la mm js lc ld mn jv lf lg mo li lj lk mp lm ln lo mq lq lr ls ik bi translated">我们已经介绍了登录Node.js应用程序的一些主要概念。让我们把它们派上用场。</p><p id="4920" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">我们可以将所有的逻辑封装到一个单独的类中，如下所示:</p><figure class="kh ki kj kk gu kl"><div class="bz fq l di"><div class="oj ok l"/></div></figure><p id="465b" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">我们可以像下面这样使用它:</p><pre class="kh ki kj kk gu mr ms oe of aw og bi"><span id="3f33" class="lt lu ir ms b gz oh oi l mz na">import { Logger } from "./utils/Logger";</span><span id="a806" class="lt lu ir ms b gz oo oi l mz na">// middleware for morgan<br/>app.use(Logger.getHttpLoggerInstance());</span><span id="b565" class="lt lu ir ms b gz oo oi l mz na">const logger = Logger.getInstance();</span></pre><p id="af69" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">希望你今天学到了新东西！</p><p id="99c5" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">点击这里，你可以获得这篇文章的所有<a class="ae kw" href="https://code.pieces.app/partner-collections/how-to-add-production-grade-nodejs-logging" rel="noopener ugc nofollow" target="_blank">代码片段</a></p><p id="0464" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated"><strong class="kz is"> <em class="or">想要连接？</em>T9】</strong></p><p id="e216" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated"><em class="or">可以通过</em><a class="ae kw" href="https://www.linkedin.com/in/56faisal/" rel="noopener ugc nofollow" target="_blank"><strong class="kz is"><em class="or">LinkedIn</em></strong></a><em class="or">或者我的</em> <a class="ae kw" href="https://www.mohammadfaisal.dev/blog" rel="noopener ugc nofollow" target="_blank"> <strong class="kz is"> <em class="or">个人网站</em> </strong> </a> <strong class="kz is"> <em class="or">联系我。</em>T29】</strong></p><h1 id="9725" class="nb lu ir bd lv nc nd ne ly nf ng nh mb jx ni jy me ka nj kb mh kd nk ke mk nl bi translated">Github资源库:</h1><div class="nm nn gq gs no np"><a href="https://github.com/Mohammad-Faisal/nodejs-logging-for-production" rel="noopener  ugc nofollow" target="_blank"><div class="nq ab fp"><div class="nr ab ns cl cj nt"><h2 class="bd is gz z fq nu fs ft nv fv fx iq bi translated">GitHub-Mohammad-fais al/nodejs-生产日志:如何设置生产级日志…</h2><div class="nw l"><h3 class="bd b gz z fq nu fs ft nv fv fx dk translated">日志记录是任何生产级应用程序的重要组成部分。事实上，这是最重要的部分之一。今天…</h3></div><div class="nx l"><p class="bd b dl z fq nu fs ft nv fv fx dk translated">github.com</p></div></div><div class="ny l"><div class="os l oa ob oc ny od kq np"/></div></div></a></div></div><div class="ab cl ot ou hv ov" role="separator"><span class="ow bw bk ox oy oz"/><span class="ow bw bk ox oy oz"/><span class="ow bw bk ox oy"/></div><div class="ik il im in io"><div class="kh ki kj kk gu np"><a rel="noopener  ugc nofollow" target="_blank" href="/error-handling-in-node-js-like-a-pro-ed210baa0600"><div class="nq ab fp"><div class="nr ab ns cl cj nt"><h2 class="bd is gz z fq nu fs ft nv fv fx iq bi translated">像专家一样处理Node.js中的错误</h2><div class="nw l"><h3 class="bd b gz z fq nu fs ft nv fv fx dk translated">你需要知道的一切。</h3></div><div class="nx l"><p class="bd b dl z fq nu fs ft nv fv fx dk translated">javascript.plainenglish.io</p></div></div><div class="ny l"><div class="pa l oa ob oc ny od kq np"/></div></div></a></div><div class="nm nn gq gs no np"><a href="https://levelup.gitconnected.com/use-docker-with-nodejs-projects-like-a-pro-a9e7504e1308" rel="noopener  ugc nofollow" target="_blank"><div class="nq ab fp"><div class="nr ab ns cl cj nt"><h2 class="bd is gz z fq nu fs ft nv fv fx iq bi translated">像专业人士一样使用Docker和NodeJS项目！</h2><div class="nw l"><h3 class="bd b gz z fq nu fs ft nv fv fx dk translated">在开发和生产中利用Docker的力量</h3></div><div class="nx l"><p class="bd b dl z fq nu fs ft nv fv fx dk translated">levelup.gitconnected.com</p></div></div><div class="ny l"><div class="pb l oa ob oc ny od kq np"/></div></div></a></div><div class="nm nn gq gs no np"><a rel="noopener  ugc nofollow" target="_blank" href="/node-js-database-with-docker-for-local-development-285212c5162f"><div class="nq ab fp"><div class="nr ab ns cl cj nt"><h2 class="bd is gz z fq nu fs ft nv fv fx iq bi translated">Node.js +带有Docker的数据库，用于本地开发</h2><div class="nw l"><h3 class="bd b gz z fq nu fs ft nv fv fx dk translated">各种数据库的一站式解决方案。</h3></div><div class="nx l"><p class="bd b dl z fq nu fs ft nv fv fx dk translated">javascript.plainenglish.io</p></div></div><div class="ny l"><div class="pc l oa ob oc ny od kq np"/></div></div></a></div><p id="c0b2" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated"><em class="or">更多内容请看</em><a class="ae kw" href="https://plainenglish.io/" rel="noopener ugc nofollow" target="_blank"><strong class="kz is"><em class="or">plain English . io</em></strong></a><em class="or">。报名参加我们的</em> <a class="ae kw" href="http://newsletter.plainenglish.io/" rel="noopener ugc nofollow" target="_blank"> <strong class="kz is"> <em class="or">免费周报</em> </strong> </a> <em class="or">。关注我们上</em> <a class="ae kw" href="https://twitter.com/inPlainEngHQ" rel="noopener ugc nofollow" target="_blank"> <strong class="kz is"> <em class="or">推特</em></strong></a><a class="ae kw" href="https://www.linkedin.com/company/inplainenglish/" rel="noopener ugc nofollow" target="_blank"><strong class="kz is"><em class="or">领英</em> </strong> </a> <em class="or">与</em> <a class="ae kw" href="https://discord.gg/GtDtUAvyhW" rel="noopener ugc nofollow" target="_blank"> <strong class="kz is"> <em class="or">不和</em> </strong> </a> <strong class="kz is"> <em class="or">。</em>T41】</strong></p></div></div>    
</body>
</html>