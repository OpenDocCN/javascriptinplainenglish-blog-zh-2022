<html>
<head>
<title>React Crash Course — Making API Calls with Fetch</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">React速成班—使用Fetch进行API调用</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/react-crash-course-making-api-calls-with-fetch-d4d0547527ad?source=collection_archive---------12-----------------------#2022-02-22">https://javascript.plainenglish.io/react-crash-course-making-api-calls-with-fetch-d4d0547527ad?source=collection_archive---------12-----------------------#2022-02-22</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="f94c" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">第8部分:将数据从后端拉入React应用程序</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/9de1218db1a4787620203acc898474fd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*j1kVVgggP5KSqhJR"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk">Photo by <a class="ae kv" href="https://unsplash.com/@lautaroandreani?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Lautaro Andreani</a> on <a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="7247" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><em class="ls"> Live dev笔记贯穿以下教程由</em> <a class="ae kv" href="https://www.youtube.com/channel/UCTZRcDjjkVajGL6wd76UnGg" rel="noopener ugc nofollow" target="_blank"> <em class="ls">丹尼斯·艾维</em></a><em class="ls">——</em><a class="ae kv" href="https://www.youtube.com/watch?v=6fM3ueN9nYM" rel="noopener ugc nofollow" target="_blank"><em class="ls">React JS速成班</em> </a></p><blockquote class="lt"><p id="d6fd" class="lu lv iq bd lw lx ly lz ma mb mc lr dk translated">在第8部分中，我们通过使用<code class="fe md me mf mg b">async</code>和<code class="fe md me mf mg b">await</code>函数的fetch，使用API调用从模拟后端服务器获取数据。然后通过<code class="fe md me mf mg b">useEffect</code>,我们将在呈现笔记时实现最佳实践。</p></blockquote></div><div class="ab cl mh mi hu mj" role="separator"><span class="mk bw bk ml mm mn"/><span class="mk bw bk ml mm mn"/><span class="mk bw bk ml mm"/></div><div class="ij ik il im in"><p id="648d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">你也可以参考我的Github repo:</p><div class="mo mp gp gr mq mr"><a href="https://github.com/emilyyleung/notesapp/tree/Part-8/Fetch-Data" rel="noopener  ugc nofollow" target="_blank"><div class="ms ab fo"><div class="mt ab mu cl cj mv"><h2 class="bd ir gy z fp mw fr fs mx fu fw ip bi translated">GitHub-Emily leung/notes app at Part-8/Fetch-Data</h2><div class="my l"><h3 class="bd b gy z fp mw fr fs mx fu fw dk translated">在GitHub上创建一个帐户，为Emily leung/notes app的开发做出贡献。</h3></div><div class="mz l"><p class="bd b dl z fp mw fr fs mx fu fw dk translated">github.com</p></div></div><div class="na l"><div class="nb l nc nd ne na nf kp mr"/></div></div></a></div></div><div class="ab cl mh mi hu mj" role="separator"><span class="mk bw bk ml mm mn"/><span class="mk bw bk ml mm mn"/><span class="mk bw bk ml mm"/></div><div class="ij ik il im in"><p id="6de8" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">既然我们已经设置了<code class="fe md me mf mg b">NotesListPage</code>和<code class="fe md me mf mg b">NotePage</code>组件的初始状态，我们需要从后端服务器检索数据。为此，我们可以运行<code class="fe md me mf mg b">useEffect</code>来调用一个定制函数，该函数获取这些信息并在初始加载时呈现出来。</p><blockquote class="ng nh ni"><p id="2f6f" class="kw kx ls ky b kz la jr lb lc ld ju le nj lg lh li nk lk ll lm nl lo lp lq lr ij bi translated"><em class="iq">记住在第二个参数中传递一个空数组，这样</em> <code class="fe md me mf mg b"><em class="iq">useEffect</em></code> <em class="iq">只在初始加载时运行。</em></p></blockquote><p id="afa6" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在<code class="fe md me mf mg b">NotesListPage.js</code>中，我们将从react导入<code class="fe md me mf mg b">useEffect</code>并调用函数。</p><pre class="kg kh ki kj gt nm mg nn no aw np bi"><span id="4de1" class="nq nr iq mg b gy ns nt l nu nv">// notesapp &gt; src &gt; pages &gt; NotesListPage.js</span><span id="0e0f" class="nq nr iq mg b gy nw nt l nu nv">import { useEffect, <strong class="mg ir">useState</strong> } from 'react'<br/>import ListItem from '../components/ListItem'<br/>const NotesListPage = () =&gt; {</span><span id="9d4a" class="nq nr iq mg b gy nw nt l nu nv">    let [notes, setNotes] = useState([])</span><span id="b61b" class="nq nr iq mg b gy nw nt l nu nv">    <strong class="mg ir">useEffect(() =&gt; {</strong></span><span id="87b1" class="nq nr iq mg b gy nw nt l nu nv"><strong class="mg ir">    }, [])</strong></span><span id="8fb4" class="nq nr iq mg b gy nw nt l nu nv">    return (<br/>        &lt;div className='notes'&gt;<br/>            &lt;div className='notes-header'&gt;<br/>                &lt;h2 className='notes-title'&gt;&amp;#9782; Notes&lt;/h2&gt;<br/>                &lt;p className='notes-count'&gt;{notes.length}&lt;/p&gt;<br/>            &lt;/div&gt;<br/>            &lt;div className='notes-list'&gt;<br/>                {notes.map((note, index) =&gt; <br/>                    &lt;ListItem key={index} note={note}/&gt;<br/>                )}<br/>            &lt;/div&gt;<br/>        &lt;/div&gt;<br/>    )<br/>}</span><span id="557b" class="nq nr iq mg b gy nw nt l nu nv">export default NotesListPage</span></pre><h1 id="1c46" class="nx nr iq bd ny nz oa ob oc od oe of og jw oh jx oi jz oj ka ok kc ol kd om on bi translated">自定义<code class="fe md me mf mg b">getNotes</code>功能</h1><p id="c460" class="pw-post-body-paragraph kw kx iq ky b kz oo jr lb lc op ju le lf oq lh li lj or ll lm ln os lp lq lr ij bi translated">接下来，我们将创建我们的<code class="fe md me mf mg b">getNotes</code>函数，它将使用<code class="fe md me mf mg b">async</code>和<code class="fe md me mf mg b">await</code>获取数据</p><blockquote class="ng nh ni"><p id="be13" class="kw kx ls ky b kz la jr lb lc ld ju le nj lg lh li nk lk ll lm nl lo lp lq lr ij bi translated"><em class="iq">为了能够在</em> <code class="fe md me mf mg b"><em class="iq">useEffect</em></code> <em class="iq">内部使用</em> <code class="fe md me mf mg b"><em class="iq">async</em></code> <em class="iq">和</em> <code class="fe md me mf mg b"><em class="iq">await</em></code> <em class="iq">，函数必须编写得更深一层——即封装在另一个函数如</em> <code class="fe md me mf mg b"><em class="iq">getNotes</em></code>内部</p></blockquote><p id="2323" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">实现<code class="fe md me mf mg b">async</code>和<code class="fe md me mf mg b">await</code>的目的是确保当<code class="fe md me mf mg b">fetch</code>运行时，函数的下一部分能够使用该数据(在任何其他事情发生之前首先保证一个响应对象)。然后，函数的下一部分能够继续，我们将解析响应对象(JSON数据)并对其进行控制。</p><p id="da52" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在<code class="fe md me mf mg b">useEffect</code>之外编写了函数，我们将看不到任何结果。对于加载时触发的<code class="fe md me mf mg b">getNotes</code>函数，我们必须调用<code class="fe md me mf mg b">useEffect</code>内部的函数</p><pre class="kg kh ki kj gt nm mg nn no aw np bi"><span id="d233" class="nq nr iq mg b gy ns nt l nu nv">// notesapp &gt; src &gt; pages &gt; NotesListPage.js</span><span id="03d3" class="nq nr iq mg b gy nw nt l nu nv">import { useEffect, useState } from 'react'<br/>import ListItem from '../components/ListItem'</span><span id="ac73" class="nq nr iq mg b gy nw nt l nu nv">const NotesListPage = () =&gt; {</span><span id="16b1" class="nq nr iq mg b gy nw nt l nu nv">    let [notes, setNotes] = useState([])</span><span id="d9aa" class="nq nr iq mg b gy nw nt l nu nv">    useEffect(() =&gt; {<br/>        <strong class="mg ir">getNotes()</strong><br/>    }, [])</span><span id="9bba" class="nq nr iq mg b gy nw nt l nu nv">    <strong class="mg ir">let getNotes = async () =&gt; {<br/>        let response = await fetch('http://localhost:8000/notes/')<br/>        let data = await response.json()<br/>        console.log(data)<br/>    }</strong></span><span id="1a00" class="nq nr iq mg b gy nw nt l nu nv">    return (<br/>        &lt;div className='notes'&gt;<br/>            &lt;div className='notes-header'&gt;<br/>                &lt;h2 className='notes-title'&gt;&amp;#9782; Notes&lt;/h2&gt;<br/>                &lt;p className='notes-count'&gt;{notes.length}&lt;/p&gt;<br/>            &lt;/div&gt;<br/>            &lt;div className='notes-list'&gt;<br/>                {notes.map((note, index) =&gt; <br/>                    &lt;ListItem key={index} note={note}/&gt;<br/>                )}<br/>            &lt;/div&gt;<br/>        &lt;/div&gt;<br/>    )<br/>}</span><span id="d688" class="nq nr iq mg b gy nw nt l nu nv">export default NotesListPage</span></pre><p id="a9dd" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们现在可以在控制台中看到我们的响应。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ot"><img src="../Images/fb54247542d445fc2a11c2d002708d46.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*_-yPMndRIZa7aqax"/></div></div></figure><h1 id="9b4a" class="nx nr iq bd ny nz oa ob oc od oe of og jw oh jx oi jz oj ka ok kc ol kd om on bi translated">在组件中呈现提取的数据</h1><p id="71d0" class="pw-post-body-paragraph kw kx iq ky b kz oo jr lb lc op ju le lf oq lh li lj or ll lm ln os lp lq lr ij bi translated">要呈现这些数据，只需在<code class="fe md me mf mg b">getNotes</code>函数中运行<code class="fe md me mf mg b">setNotes</code>即可。除此之外，我们还需要传递我们提取的数据。这将有效地用注释的内容更新初始的空数组。</p><blockquote class="ng nh ni"><p id="2905" class="kw kx ls ky b kz la jr lb lc ld ju le nj lg lh li nk lk ll lm nl lo lp lq lr ij bi translated"><strong class="ky ir"> <em class="iq">注意:</em> </strong> <em class="iq">状态是可变的(因为我们可以更新它)，而道具不是</em></p></blockquote><pre class="kg kh ki kj gt nm mg nn no aw np bi"><span id="95a9" class="nq nr iq mg b gy ns nt l nu nv">// notesapp &gt; src &gt; pages &gt; NotesListPage.js</span><span id="8ee4" class="nq nr iq mg b gy nw nt l nu nv">import { useEffect, useState } from 'react'<br/>import ListItem from '../components/ListItem'</span><span id="2df4" class="nq nr iq mg b gy nw nt l nu nv">const NotesListPage = () =&gt; {</span><span id="ff47" class="nq nr iq mg b gy nw nt l nu nv">    let [notes, setNotes] = useState([])</span><span id="3f1c" class="nq nr iq mg b gy nw nt l nu nv">    useEffect(() =&gt; {<br/>        getNotes()<br/>    }, [])</span><span id="590c" class="nq nr iq mg b gy nw nt l nu nv">    let getNotes = async () =&gt; {<br/>        let response = await fetch('&lt;http://localhost:8000/notes/&gt;')<br/>        let data = await response.json()<br/>        <strong class="mg ir">setNotes(data)</strong><br/>    }</span><span id="5f4e" class="nq nr iq mg b gy nw nt l nu nv">    return (<br/>        &lt;div className='notes'&gt;<br/>            &lt;div className='notes-header'&gt;<br/>                &lt;h2 className='notes-title'&gt;&amp;#9782; Notes&lt;/h2&gt;<br/>                &lt;p className='notes-count'&gt;{notes.length}&lt;/p&gt;<br/>            &lt;/div&gt;<br/>            &lt;div className='notes-list'&gt;<br/>                {notes.map((note, index) =&gt; <br/>                    &lt;ListItem key={index} note={note}/&gt;<br/>                )}<br/>            &lt;/div&gt;<br/>        &lt;/div&gt;<br/>    )<br/>}</span><span id="a9c4" class="nq nr iq mg b gy nw nt l nu nv">export default NotesListPage</span></pre><p id="d5d4" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在，我们可以在主页上看到我们所有的笔记。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ou"><img src="../Images/dcf9bf0cad9c00b04711f42143abe8ab.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*U9KBgT4ToLUPWlA7"/></div></div></figure><h1 id="75c8" class="nx nr iq bd ny nz oa ob oc od oe of og jw oh jx oi jz oj ka ok kc ol kd om on bi translated">一个普通的pittfall与<code class="fe md me mf mg b">useEffect</code></h1><p id="fd17" class="pw-post-body-paragraph kw kx iq ky b kz oo jr lb lc op ju le lf oq lh li lj or ll lm ln os lp lq lr ij bi translated">如果您在调用<code class="fe md me mf mg b">useEffect</code>内部的函数时忘记添加依赖项的空数组，那么运行<code class="fe md me mf mg b">getNotes</code>函数的调用次数将会是无穷无尽的...</p><pre class="kg kh ki kj gt nm mg nn no aw np bi"><span id="3d19" class="nq nr iq mg b gy ns nt l nu nv">// Notice how there's no second argument. <strong class="mg ir">Please avoid this!</strong></span><span id="270c" class="nq nr iq mg b gy nw nt l nu nv">useEffect(() =&gt; {<br/>    getNotes()<br/>})</span></pre><p id="7868" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们可以在“网络”选项卡下看到它的效果，它将继续获取。正在发生的是当通过<code class="fe md me mf mg b">useEffect</code>调用<code class="fe md me mf mg b">getNotes</code>时，它将设置状态。但是因为状态已经更新(并且没有分配依赖关系)，它将再次触发<code class="fe md me mf mg b">useEffect</code>。这将无限期地持续下去。</p><p id="5372" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">最终，出现这种情况是因为我们没有告诉它<code class="fe md me mf mg b">getNotes</code>应该在何时启动(即仅在第一次加载时)。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ov"><img src="../Images/d224eb677a62bd08c8647c9e808d78b0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*U4Yxtzz4afX_m0H6"/></div></div></figure><h1 id="9996" class="nx nr iq bd ny nz oa ob oc od oe of og jw oh jx oi jz oj ka ok kc ol kd om on bi translated">获取单个页面的注释</h1><p id="8a5a" class="pw-post-body-paragraph kw kx iq ky b kz oo jr lb lc op ju le lf oq lh li lj or ll lm ln os lp lq lr ij bi translated">与主页类似，我们将通过API获取每个笔记。</p><blockquote class="ng nh ni"><p id="78f2" class="kw kx ls ky b kz la jr lb lc ld ju le nj lg lh li nk lk ll lm nl lo lp lq lr ij bi translated"><strong class="ky ir"> <em class="iq">注意:</em></strong><em class="iq"/><code class="fe md me mf mg b"><em class="iq">notes</em></code><em class="iq">的初始化应该在组件的顶层完成，永远不要在</em> <code class="fe md me mf mg b"><em class="iq">useEffect</em></code>内部完成</p></blockquote><p id="c8e0" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">就像<code class="fe md me mf mg b">NotesListPage</code>一样，我们将执行以下操作:</p><ul class=""><li id="e0e5" class="ow ox iq ky b kz la lc ld lf oy lj oz ln pa lr pb pc pd pe bi translated">从react导入<code class="fe md me mf mg b">useEffect</code></li><li id="6704" class="ow ox iq ky b kz pf lc pg lf ph lj pi ln pj lr pb pc pd pe bi translated">在我们的注释初始化之后调用<code class="fe md me mf mg b">useEffect</code>,但是这只会在<code class="fe md me mf mg b">noteId</code>改变时触发(即依赖)</li><li id="c359" class="ow ox iq ky b kz pf lc pg lf ph lj pi ln pj lr pb pc pd pe bi translated">创建将使用<code class="fe md me mf mg b">async</code>、<code class="fe md me mf mg b">await</code>和<code class="fe md me mf mg b">fetch</code>的<code class="fe md me mf mg b">getNote</code>功能。这一次，获取数据的URL将需要一个由<code class="fe md me mf mg b">noteId</code>决定的动态路径。我们可以使用模板文字(即反斜线)来做到这一点</li></ul><pre class="kg kh ki kj gt nm mg nn no aw np bi"><span id="34ab" class="nq nr iq mg b gy ns nt l nu nv">// notesapp &gt; src &gt; pages &gt; NotePage.js</span><span id="6be1" class="nq nr iq mg b gy nw nt l nu nv">import { useState, <strong class="mg ir">useEffect</strong> } from 'react'<br/>import { Link } from 'react-router-dom'<br/>import { ReactComponent as ArrowLeft } from '../assets/arrow-left.svg'</span><span id="28c9" class="nq nr iq mg b gy nw nt l nu nv">const NotePage = ({match}) =&gt; {<br/>    let noteId = match.params.id<br/>    let [note, setNote] = useState(null)</span><span id="4e92" class="nq nr iq mg b gy nw nt l nu nv">    <strong class="mg ir">useEffect(() =&gt; {<br/>        getNote()<br/>    }, [noteId])</strong></span><span id="7f3b" class="nq nr iq mg b gy nw nt l nu nv">    <strong class="mg ir">let getNote = async () =&gt; {<br/>        let response = await fetch(`http://localhost:8000/notes/${noteId}`)<br/>        let data = await response.json()<br/>        setNote(data)<br/>    }</strong></span><span id="3077" class="nq nr iq mg b gy nw nt l nu nv">    return (<br/>        &lt;div className='note'&gt;<br/>            &lt;div className='note-header'&gt;<br/>                &lt;h3&gt;<br/>                    &lt;Link to="/"&gt;<br/>                        &lt;ArrowLeft/&gt;<br/>                    &lt;/Link&gt;<br/>                &lt;/h3&gt;<br/>            &lt;/div&gt;<br/>            <br/>            &lt;textarea value={note?.body}&gt;&lt;/textarea&gt;</span><span id="3791" class="nq nr iq mg b gy nw nt l nu nv">        &lt;/div&gt;<br/>    )<br/>}</span><span id="9cf7" class="nq nr iq mg b gy nw nt l nu nv">export default NotePage</span></pre><p id="6671" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">既然我们能够从数据库中检索笔记，下一篇文章将研究更新我们的笔记并将这些更改保存回服务器。</p><p id="a0eb" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><em class="ls">更多内容请看</em><a class="ae kv" href="http://plainenglish.io/" rel="noopener ugc nofollow" target="_blank"><strong class="ky ir"><em class="ls">plain English . io</em></strong></a><em class="ls">。报名参加我们的</em> <a class="ae kv" href="http://newsletter.plainenglish.io/" rel="noopener ugc nofollow" target="_blank"> <strong class="ky ir"> <em class="ls">免费周报</em> </strong> </a> <em class="ls">。在我们的</em> <a class="ae kv" href="https://discord.gg/GtDtUAvyhW" rel="noopener ugc nofollow" target="_blank"> <strong class="ky ir"> <em class="ls">社区</em> </strong> </a> <em class="ls">获得独家获得写作机会和建议。</em></p></div></div>    
</body>
</html>