<html>
<head>
<title>On-demand Incremental Static Regeneration with Next.js &amp; Hygraph</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Next.js &amp; Hygraph按需增量静态再生</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/on-demand-incremental-static-regeneration-with-next-js-hygraph-3ed325fa5b?source=collection_archive---------3-----------------------#2022-07-23">https://javascript.plainenglish.io/on-demand-incremental-static-regeneration-with-next-js-hygraph-3ed325fa5b?source=collection_archive---------3-----------------------#2022-07-23</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jp jq jr js gh gi paragraph-image"><div role="button" tabindex="0" class="jt ju di jv bf jw"><div class="gh gi jo"><img src="../Images/665a148dd72e0ead5344d06e0d5c57a1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*YuW9L0i7QvFh-RNa"/></div></div><figcaption class="jz ka gj gh gi kb kc bd b be z dk">Photo by <a class="ae kd" href="https://unsplash.com/@altumcode?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">AltumCode</a> on <a class="ae kd" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="6729" class="pw-post-body-paragraph ke kf iq kg b kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">对于我的<a class="ae kd" href="https://nextglabs.com" rel="noopener ugc nofollow" target="_blank">个人网站</a>，我使用<a class="ae kd" href="https://hygraph.com" rel="noopener ugc nofollow" target="_blank"> Hygraph </a>(又名GraphCMS)作为一个无头CMS。我使用服务器端呈现(SSR)来获取和生成静态页面路由和内容。</p><p id="af13" class="pw-post-body-paragraph ke kf iq kg b kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">Next.js允许我们在构建应用程序后更新静态页面。多亏了增量静态再生(ISR ),我们可以在每页的基础上使用静态生成<strong class="kg ir">,而不需要重建整个站点！</strong></p><p id="9bf3" class="pw-post-body-paragraph ke kf iq kg b kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">有了ISR，我们可以在扩展到数百万页的同时获得静态的好处。</p><p id="9e64" class="pw-post-body-paragraph ke kf iq kg b kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">为了实现这一点，我使用了<code class="fe lc ld le lf b">revalidate</code>选项，每60分钟重新生成一次静态页面(第22行)。</p><figure class="lh li lj lk gt js gh gi paragraph-image"><div role="button" tabindex="0" class="jt ju di jv bf jw"><div class="gh gi lg"><img src="../Images/d6ee4ea0cad3fca9f299d00899faa15c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4y8OhQ8_JGTQ_N7TR2pJow.png"/></div></div><figcaption class="jz ka gj gh gi kb kc bd b be z dk">ISR — Revalidate option for dynamic routes</figcaption></figure><p id="0851" class="pw-post-body-paragraph ke kf iq kg b kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">最近，我在hygraph上更新了我的网站的一些内容，发现如果信息需要立即更新，我的访问者将不得不等待长达60分钟(最坏的情况)才能看到更新的数据。<strong class="kg ir">太可怕了</strong>！</p><p id="5ef8" class="pw-post-body-paragraph ke kf iq kg b kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">为了缓解这个问题，我使用了<strong class="kg ir">按需静态重新验证。</strong>这意味着<em class="ll">更新的</em>静态页面仅在Hygraph上的内容更新时重新生成。以下是如何做到这一点。</p><h1 id="a3d4" class="lm ln iq bd lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj bi translated">如何设置按需静态重新验证</h1><h2 id="5299" class="mk ln iq bd lo ml mm dn ls mn mo dp lw kp mp mq ma kt mr ms me kx mt mu mi mv bi translated">1.创建ISR重新验证API路线</h2><figure class="lh li lj lk gt js"><div class="bz fp l di"><div class="mw mx l"/></div><figcaption class="jz ka gj gh gi kb kc bd b be z dk">Next.js ISR Revalidate API Route</figcaption></figure><p id="fd0f" class="pw-post-body-paragraph ke kf iq kg b kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">使用您选择的秘密将秘密<code class="fe lc ld le lf b">REVALIDATE_TOKEN</code>添加到<code class="fe lc ld le lf b">.env</code>文件中是非常必要的。</p><blockquote class="my mz na"><p id="1e1d" class="ke kf ll kg b kh ki kj kk kl km kn ko nb kq kr ks nc ku kv kw nd ky kz la lb ij bi translated"><strong class="kg ir"> ⚠️重要提示:</strong>如果你在hygraph中使用的键不是<code class="fe lc ld le lf b">slug</code>，你必须更新第17行的代码。</p></blockquote><h2 id="3f90" class="mk ln iq bd lo ml mm dn ls mn mo dp lw kp mp mq ma kt mr ms me kx mt mu mi mv bi translated">2.创建一个Hygraph网页挂钩</h2><p id="9dfe" class="pw-post-body-paragraph ke kf iq kg b kh ne kj kk kl nf kn ko kp ng kr ks kt nh kv kw kx ni kz la lb ij bi translated">接下来，我需要在Hygraph上创建一个新的webhook，它将在页面重新发布(内容更改)时调用我们刚刚创建的API端点。</p><p id="6587" class="pw-post-body-paragraph ke kf iq kg b kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">登录你的Hygraph帐户，然后从侧边栏(左下方)选择Webhooks标签。现在点击“创建”按钮。</p><p id="0d11" class="pw-post-body-paragraph ke kf iq kg b kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">按照以下方式设置webhook，确保根据您的用例选择正确的内容模型。对于我的个人网站，我使用的是<code class="fe lc ld le lf b">Page</code>模式。当<code class="fe lc ld le lf b">Published</code>页面发布或取消发布时，触发webhook。</p><p id="6701" class="pw-post-body-paragraph ke kf iq kg b kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">必须启用<code class="fe lc ld le lf b">Include payload</code>选项<strong class="kg ir"/>来发送我们想要重新验证的页面<code class="fe lc ld le lf b">slug</code>以及请求。然后，重新验证端点处理请求正文。</p><figure class="lh li lj lk gt js gh gi paragraph-image"><div class="gh gi nj"><img src="../Images/2599fc8144ca7e3d61b86bb51f922a06.png" data-original-src="https://miro.medium.com/v2/resize:fit:1048/format:webp/1*8XcX77ZpFAtaHarA4h1rlg.jpeg"/></div><figcaption class="jz ka gj gh gi kb kc bd b be z dk">Next.js ISR — hygraph Webhook Setup</figcaption></figure><blockquote class="my mz na"><p id="6fb6" class="ke kf ll kg b kh ki kj kk kl km kn ko nb kq kr ks nc ku kv kw nd ky kz la lb ij bi translated"><strong class="kg ir"> ⚠️重要提示:</strong>确保用你的网站基本URL替换<code class="fe lc ld le lf b">YOUR_WEBSITE</code>，用你在<code class="fe lc ld le lf b">.env</code>文件中定义的秘密令牌替换<code class="fe lc ld le lf b">YOUR_SECRET</code>。</p></blockquote><h2 id="e324" class="mk ln iq bd lo ml mm dn ls mn mo dp lw kp mp mq ma kt mr ms me kx mt mu mi mv bi translated">3.从getStaticProps中删除重新验证选项</h2><p id="05fa" class="pw-post-body-paragraph ke kf iq kg b kh ne kj kk kl nf kn ko kp ng kr ks kt nh kv kw kx ni kz la lb ij bi translated">在<code class="fe lc ld le lf b">pages/[slug].tsx</code>中，你需要移除<code class="fe lc ld le lf b">revalidate</code>选项，如果你以前用过的话。其值默认为<code class="fe lc ld le lf b">false</code>。</p><h2 id="6614" class="mk ln iq bd lo ml mm dn ls mn mo dp lw kp mp mq ma kt mr ms me kx mt mu mi mv bi translated">4.部署和测试</h2><p id="88c3" class="pw-post-body-paragraph ke kf iq kg b kh ne kj kk kl nf kn ko kp ng kr ks kt nh kv kw kx ni kz la lb ij bi translated">构建和部署应用程序。您还必须在您的主机上设置<code class="fe lc ld le lf b">REVALIDATE_TOKEN </code>环境变量。如果您使用的是Vercel，请查看<a class="ae kd" href="https://vercel.com/docs/concepts/projects/environment-variables" rel="noopener ugc nofollow" target="_blank">环境变量</a>文档。</p><p id="6d7b" class="pw-post-body-paragraph ke kf iq kg b kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">在你的一个页面上做一个微小的内容改变。重新验证应该开始，静态内容立即重新生成！</p><h2 id="d813" class="mk ln iq bd lo ml mm dn ls mn mo dp lw kp mp mq ma kt mr ms me kx mt mu mi mv bi translated">5.解决纷争</h2><p id="a53b" class="pw-post-body-paragraph ke kf iq kg b kh ne kj kk kl nf kn ko kp ng kr ks kt nh kv kw kx ni kz la lb ij bi translated">如果您遇到任何问题，您可以在Hygraph中检查webhook日志。响应应该是带有<code class="fe lc ld le lf b">{ revalidated: true }</code>的<code class="fe lc ld le lf b">200</code>。</p><p id="7b6d" class="pw-post-body-paragraph ke kf iq kg b kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">如果没有，您可以进一步调查失败的webhook事件的原因。</p><p id="50d5" class="pw-post-body-paragraph ke kf iq kg b kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">一些可能的原因:URL不正确，webhook URL和/或环境变量中的机密丢失或不正确。</p><p id="5872" class="pw-post-body-paragraph ke kf iq kg b kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">如果您仍然不能解决问题，请联系我。我很乐意帮忙😊</p><h1 id="589c" class="lm ln iq bd lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj bi translated">源代码</h1><p id="b1b9" class="pw-post-body-paragraph ke kf iq kg b kh ne kj kk kl nf kn ko kp ng kr ks kt nh kv kw kx ni kz la lb ij bi translated">你可以在这个库里找到我的网站<a class="ae kd" href="https://github.com/nextglabs/nextglabs.com" rel="noopener ugc nofollow" target="_blank">的源代码。如果你想支持我，一定要打碎👏🏼按钮，尽可能多的次数，并启动⭐仓库</a></p></div><div class="ab cl nk nl hu nm" role="separator"><span class="nn bw bk no np nq"/><span class="nn bw bk no np nq"/><span class="nn bw bk no np"/></div><div class="ij ik il im in"><p id="6b02" class="pw-post-body-paragraph ke kf iq kg b kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated"><strong class="kg ir">如果你喜欢阅读媒体上的优质内容，请关注我并订阅，以便在我发布时自动接收我的故事。编码快乐！</strong> 🥳</p></div><div class="ab cl nk nl hu nm" role="separator"><span class="nn bw bk no np nq"/><span class="nn bw bk no np nq"/><span class="nn bw bk no np"/></div><div class="ij ik il im in"><div class="lh li lj lk gt nr"><a rel="noopener  ugc nofollow" target="_blank" href="/become-the-worst-software-engineer-ever-a-humorous-take-c4d9eb3fc492"><div class="ns ab fo"><div class="nt ab nu cl cj nv"><h2 class="bd ir gy z fp nw fr fs nx fu fw ip bi translated">成为有史以来最差的软件工程师:一个幽默的笑话</h2><div class="ny l"><h3 class="bd b gy z fp nw fr fs nx fu fw dk translated">💡这个故事只是为了幽默。我们都需要时不时地开开玩笑，找点乐子。所以不要…</h3></div><div class="nz l"><p class="bd b dl z fp nw fr fs nx fu fw dk translated">javascript.plainenglish.io</p></div></div><div class="oa l"><div class="ob l oc od oe oa of jx nr"/></div></div></a></div><div class="og oh gp gr oi nr"><a href="https://medium.com/next-generation-web/how-to-build-test-react-query-components-in-typescript-9527dc9924da" rel="noopener follow" target="_blank"><div class="ns ab fo"><div class="nt ab nu cl cj nv"><h2 class="bd ir gy z fp nw fr fs nx fu fw ip bi translated">如何在Typescript中构建和测试反应查询组件</h2><div class="ny l"><h3 class="bd b gy z fp nw fr fs nx fu fw dk translated">React-Query太牛了！但是测试使用它的组件可能有点棘手。以下是如何无痛测试…</h3></div><div class="nz l"><p class="bd b dl z fp nw fr fs nx fu fw dk translated">medium.com</p></div></div><div class="oa l"><div class="oj l oc od oe oa of jx nr"/></div></div></a></div><div class="og oh gp gr oi nr"><a rel="noopener  ugc nofollow" target="_blank" href="/how-to-get-fired-as-a-software-engineer-fast-e99e6fe0d908"><div class="ns ab fo"><div class="nt ab nu cl cj nv"><h2 class="bd ir gy z fp nw fr fs nx fu fw ip bi translated">软件工程师如何被炒，快。</h2><div class="ny l"><h3 class="bd b gy z fp nw fr fs nx fu fw dk translated">我以自由职业者的身份为一家中型公司工作，我们必须通过雇佣新的软件工程师来扩大我们的团队。但是…</h3></div><div class="nz l"><p class="bd b dl z fp nw fr fs nx fu fw dk translated">javascript.plainenglish.io</p></div></div><div class="oa l"><div class="ok l oc od oe oa of jx nr"/></div></div></a></div><p id="4479" class="pw-post-body-paragraph ke kf iq kg b kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated"><em class="ll">更多内容请看</em><a class="ae kd" href="https://plainenglish.io/" rel="noopener ugc nofollow" target="_blank"><strong class="kg ir"><em class="ll">plain English . io</em></strong></a><em class="ll">。报名参加我们的</em> <a class="ae kd" href="http://newsletter.plainenglish.io/" rel="noopener ugc nofollow" target="_blank"> <strong class="kg ir"> <em class="ll">免费周报</em> </strong> </a> <em class="ll">。关注我们关于</em><a class="ae kd" href="https://twitter.com/inPlainEngHQ" rel="noopener ugc nofollow" target="_blank"><strong class="kg ir"><em class="ll">Twitter</em></strong></a><em class="ll">和</em><a class="ae kd" href="https://www.linkedin.com/company/inplainenglish/" rel="noopener ugc nofollow" target="_blank"><strong class="kg ir"><em class="ll">LinkedIn</em></strong></a><em class="ll">。查看我们的</em> <a class="ae kd" href="https://discord.gg/GtDtUAvyhW" rel="noopener ugc nofollow" target="_blank"> <strong class="kg ir"> <em class="ll">社区不和谐</em> </strong> </a> <em class="ll">加入我们的</em> <a class="ae kd" href="https://inplainenglish.pallet.com/talent/welcome" rel="noopener ugc nofollow" target="_blank"> <strong class="kg ir"> <em class="ll">人才集体</em> </strong> </a> <em class="ll">。</em></p></div></div>    
</body>
</html>