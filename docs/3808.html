<html>
<head>
<title>Let’s Understand Chrome V8: What Is the Bytecode Dispatch and How Does It Work</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">让我们来理解Chrome V8:什么是字节码分派，它是如何工作的</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/lets-understand-chrome-v8-what-is-the-bytecode-dispatch-and-how-does-it-work-44fdac77c42a?source=collection_archive---------6-----------------------#2022-09-28">https://javascript.plainenglish.io/lets-understand-chrome-v8-what-is-the-bytecode-dispatch-and-how-does-it-work-44fdac77c42a?source=collection_archive---------6-----------------------#2022-09-28</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><div class=""><h2 id="2ded" class="pw-subtitle-paragraph jk im in bd b jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb dk translated">第27章:字节码分派的基础</h2></div><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi kc"><img src="../Images/2229cb027639f57877eb360bf75cd927.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yCFNVeb4ds9hl7WF-NP-kw.png"/></div></div></figure><p id="7748" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated"><em class="lk">欢迎阅读</em> <a class="ae ll" href="https://medium.com/@huidou" rel="noopener"> <em class="lk">其他章节让我们来了解一下Chrome V8 </em> </a></p><h1 id="237a" class="lm ln in bd lo lp lq lr ls lt lu lv lw jt lx ju ly jw lz jx ma jz mb ka mc md bi translated"><strong class="ak"> 1。简介</strong></h1><p id="0273" class="pw-post-body-paragraph ko kp in kq b kr me jo kt ku mf jr kw kx mg kz la lb mh ld le lf mi lh li lj ig bi translated">我们知道一个SharedFunction可能不只有一个字节码，而是有很多很多字节码。如何管理这些字节码？V8使用一个称为字节码数组的数组来管理字节码。解析器生成的字节码顺序存储在字节码数组中，字节码数组是SharedFunction的重要成员。当点火执行时，它将从数组中逐个取出字节码。让我们想一想，我们得到了一个字节码，但是如何得到相应的处理程序呢？你认为它应该有一个数组来匹配字节码和处理程序吗？是的，它就是我们称之为dispatch_table的数组。</p><p id="b095" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">实际上，字节码是一个枚举，dispach_table使用枚举作为索引来存储相应的处理程序。我打赌你已经猜到字节码是如何连续工作的了。当一个字节码退出时，它会从字节码数组中取出目标字节码即下一个字节码，然后用该字节码作为索引得到一个处理程序地址，最后跳转到该地址，所有这些都打包成一个函数DISPATCH()。因此DISPATCH()使字节码一个接一个地正确执行，它充当程序计数器(称为PC ),在其中分派到下一条指令。</p><h1 id="bad7" class="lm ln in bd lo lp lq lr ls lt lu lv lw jt lx ju ly jw lz jx ma jz mb ka mc md bi translated"><strong class="ak"> 2。字节码数组</strong></h1><p id="04ba" class="pw-post-body-paragraph ko kp in kq b kr me jo kt ku mf jr kw kx mg kz la lb mh ld le lf mi lh li lj ig bi translated">下面的代码是BytecodeArray。</p><figure class="kd ke kf kg gt kh"><div class="bz fp l di"><div class="mj mk l"/></div></figure><p id="e933" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">有两个重要的成员:</p><ul class=""><li id="33a1" class="ml mm in kq b kr ks ku kv kx mn lb mo lf mp lj mq mr ms mt bi translated">第3行，SizeFor(int length)计算字节码数组的内存大小，这在构建SharedFunction时经常使用。</li><li id="36ad" class="ml mm in kq b kr mu ku mv kx mw lb mx lf my lj mq mr ms mt bi translated">第8行，GetFirstBytecodeAddress()获取第一个字节码地址，当解析器将字节码放入字节码数组时，通常会用到这个地址。</li></ul><p id="baa9" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">现在，我将演示如何读取一个字节码数组，这就是下面几行中数字的含义。</p><figure class="kd ke kf kg gt kh"><div class="bz fp l di"><div class="mj mk l"/></div></figure><p id="a3b4" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">上面的代码是一个字节码数组。让我们看看第2行，其中数字12是字节码enum代码,[0]是LdaConstant需要的参数。用数字12，可以得到对应的处理程序，dispatch_[0x12]是LdaConstant处理程序，下面的代码是字节码enum类。</p><figure class="kd ke kf kg gt kh"><div class="bz fp l di"><div class="mj mk l"/></div></figure><p id="acf0" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">[0]是常量池索引，因此LdaConstant参数是constant_pool[0]，即<em class="lk">0x 005 EAE 402 f 59&lt;String[# 22]:ignore case我们开始！&gt; </em>在此上下文中。</p><h1 id="e30a" class="lm ln in bd lo lp lq lr ls lt lu lv lw jt lx ju ly jw lz jx ma jz mb ka mc md bi translated"><strong class="ak"> 3。调度</strong></h1><p id="87ef" class="pw-post-body-paragraph ko kp in kq b kr me jo kt ku mf jr kw kx mg kz la lb mh ld le lf mi lh li lj ig bi translated">在上面的代码中，第25行将字节码及其处理程序存储到调度数组中，参见下面的代码。</p><figure class="kd ke kf kg gt kh"><div class="bz fp l di"><div class="mj mk l"/></div></figure><p id="9790" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">在上面的代码中，第25行将字节码及其处理程序存储到调度数组中，参见下面的代码。</p><figure class="kd ke kf kg gt kh"><div class="bz fp l di"><div class="mj mk l"/></div></figure><p id="b4bd" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">见第5行，就是我说的dispatch_table_ array。第5行计算字节码的索引，索引与字节码枚举值相同。图1显示了SetBytecodeHandler的调用栈。</p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi mz"><img src="../Images/429750c073eb64b1afdc3a303686fb24.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Xinm8yEcw5TfspjCm-RCdA.png"/></div></div></figure><p id="f9db" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">参见下面的代码解释器。我想演示一下如何在你调试V8的时候手动获取dispatch_table_的方法。</p><figure class="kd ke kf kg gt kh"><div class="bz fp l di"><div class="mj mk l"/></div></figure><p id="e065" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">在上面的代码中，通过第11行，我们知道dispatch_table是解释器的成员，而解释器是Isolate的成员，参见下面的代码。</p><figure class="kd ke kf kg gt kh"><div class="bz fp l di"><div class="mj mk l"/></div></figure><p id="1f3b" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">因此，您可以使用公式<em class="lk">Isolate-&gt;interpreter _-&gt;dispatch_table_</em>来获得dispatch _ table _。</p><p id="f97b" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">在这里，我展示了dispatch()，您可以通过下面的代码更准确地理解Dispatch是如何工作的。</p><figure class="kd ke kf kg gt kh"><div class="bz fp l di"><div class="mj mk l"/></div></figure><p id="6805" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">简言之，第5行计算目标字节码偏移量；第17行获取相应的处理程序，第27行分派给目标；第34–41行生成一个节点并将其添加到当前基本块的尾部，详见节点的<em class="lk">海。图2显示了调度的调用栈。</em></p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi na"><img src="../Images/b92216de3a155ccc92750c244bc27f2a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*B87PB688KSzZR2FCNaCwvw.png"/></div></div></figure><h1 id="bd3c" class="lm ln in bd lo lp lq lr ls lt lu lv lw jt lx ju ly jw lz jx ma jz mb ka mc md bi translated"><strong class="ak">带走</strong></h1><ul class=""><li id="eb5c" class="ml mm in kq b kr me ku mf kx nb lb nc lf nd lj mq mr ms mt bi translated">字节码枚举值是相应处理程序的索引；</li><li id="3408" class="ml mm in kq b kr mu ku mv kx mw lb mx lf my lj mq mr ms mt bi translated">使用公式<em class="lk">Isolate-&gt;interpreter _-&gt;dispatch _ table _</em>得到dispatch _ table；</li><li id="1f36" class="ml mm in kq b kr mu ku mv kx mw lb mx lf my lj mq mr ms mt bi translated">InV8，解释器使用机器寄存器维护idspatch_table_表。</li></ul><p id="1cfb" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated"><em class="lk">好了，这部分就到此为止了。下次再见，保重！</em></p><p id="68bc" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">如果你有任何问题，请联系我。<strong class="kq io">微信</strong> : qq9123013 <strong class="kq io">邮箱</strong>:<a class="ae ll" href="mailto:v8blink@outlook.com" rel="noopener ugc nofollow" target="_blank">v8blink@outlook.com</a></p></div><div class="ab cl ne nf hr ng" role="separator"><span class="nh bw bk ni nj nk"/><span class="nh bw bk ni nj nk"/><span class="nh bw bk ni nj"/></div><div class="ig ih ii ij ik"><p id="960b" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated"><em class="lk">更多内容请看</em><a class="ae ll" href="https://plainenglish.io/" rel="noopener ugc nofollow" target="_blank"><strong class="kq io"><em class="lk">plain English . io</em></strong></a><em class="lk">。报名参加我们的</em> <a class="ae ll" href="http://newsletter.plainenglish.io/" rel="noopener ugc nofollow" target="_blank"> <strong class="kq io"> <em class="lk">免费周报</em> </strong> </a> <em class="lk">。关注我们关于</em><a class="ae ll" href="https://twitter.com/inPlainEngHQ" rel="noopener ugc nofollow" target="_blank"><strong class="kq io"><em class="lk">Twitter</em></strong></a><a class="ae ll" href="https://www.linkedin.com/company/inplainenglish/" rel="noopener ugc nofollow" target="_blank"><strong class="kq io"><em class="lk">LinkedIn</em></strong></a><em class="lk"/><a class="ae ll" href="https://www.youtube.com/channel/UCtipWUghju290NWcn8jhyAw" rel="noopener ugc nofollow" target="_blank"><strong class="kq io"><em class="lk">YouTube</em></strong></a><em class="lk"/><a class="ae ll" href="https://discord.gg/GtDtUAvyhW" rel="noopener ugc nofollow" target="_blank"><strong class="kq io"><em class="lk">不和</em> </strong> </a> <em class="lk">。对增长黑客感兴趣？检查</em> <a class="ae ll" href="https://circuit.ooo/" rel="noopener ugc nofollow" target="_blank"> <strong class="kq io"> <em class="lk">电路</em> </strong> </a> <em class="lk">。</em></p></div></div>    
</body>
</html>