<html>
<head>
<title>How to Really Implement the sleep() Function in JavaScript</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何在JavaScript中真正实现sleep()函数</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/how-to-really-implement-the-sleep-function-in-javascript-621b4ed1e618?source=collection_archive---------10-----------------------#2022-06-16">https://javascript.plainenglish.io/how-to-really-implement-the-sleep-function-in-javascript-621b4ed1e618?source=collection_archive---------10-----------------------#2022-06-16</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="7d88" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">如何用JavaScript实现<code class="fe kf kg kh ki b">sleep()</code>函数的指南(正确的方法)。</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="ab gu cl ko"><img src="../Images/c5f6dbf324b3352fd7514a9f9715f3a6.png" data-original-src="https://miro.medium.com/v2/format:webp/1*URywPms6UjiaOm8lBCUNTQ.png"/></div></figure><p id="d4ec" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">我刚刚在<a class="ae ln" href="https://javascript.plainenglish.io" rel="noopener ugc nofollow" target="_blank">的JavaScript in Plain English刊物</a>上读到一篇文章。<a class="ae ln" href="https://medium.com/@codewithsnowbit" rel="noopener"> SnowBit </a>写过一篇文章，名为<a class="ae ln" href="https://medium.com/javascript-in-plain-english/how-can-you-implement-the-sleep-function-in-javascript-db5d4d89b13b" rel="noopener">如何在JavaScript中实现sleep()函数？这篇文章有很多问题，我将在后面讨论。</a></p><p id="35e6" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">首先，我会教你如何用JavaScript实现<code class="fe kf kg kh ki b">sleep()</code>函数。然后我来解释一下<a class="ae ln" href="https://medium.com/@codewithsnowbit" rel="noopener"> SnowBit </a>犯的致命错误。(还有，如果你是Medium上的作家，不要把你文章唯一重要的部分完全搞砸了，尤其是文章这么短的时候。他把整篇文章都搞砸了！)</p><h1 id="9d61" class="lo lp iq bd lq lr ls lt lu lv lw lx ly jw lz jx ma jz mb ka mc kc md kd me mf bi translated">异步/等待睡眠功能</h1><p id="45bd" class="pw-post-body-paragraph kr ks iq kt b ku mg jr kw kx mh ju kz la mi lc ld le mj lg lh li mk lk ll lm ij bi translated">睡眠功能的代码很简单:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="mm mn di mo bf mp"><div class="gh gi ml"><img src="../Images/8aba9153c4b06db5fedee5527f7647fc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_gByYPV5dhsnzeKMaHVOCA.png"/></div></div><figcaption class="mq mr gj gh gi ms mt bd b be z dk">JavaScript code for an asynchronous sleep function</figcaption></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="ab gu cl ko"><img src="../Images/653be6592a3179147bc7d3ee820a5954.png" data-original-src="https://miro.medium.com/v2/1*n6-FJL-EQTcYoYaKcD1BaA.gif"/></div><figcaption class="mq mr gj gh gi ms mt bd b be z dk">Demo of the sleep function in NodeJS (also works in the browser)</figcaption></figure><p id="3a02" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">这是一句俏皮话！但是如果你不熟悉<code class="fe kf kg kh ki b">async</code>函数，你可能需要一个解释器。</p><h2 id="f855" class="mu lp iq bd lq mv mw dn lu mx my dp ly la mz na ma le nb nc mc li nd ne me nf bi translated">承诺、异步和等待(适用于新手)</h2><p id="77de" class="pw-post-body-paragraph kr ks iq kt b ku mg jr kw kx mh ju kz la mi lc ld le mj lg lh li mk lk ll lm ij bi translated"><a class="ae ln" href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise" rel="noopener ugc nofollow" target="_blank"> JavaScript Promises </a>是定义要执行的函数的唯一对象。有时，您可能希望接受用户输入，等待事件被触发，或者进行API调用。同时，您仍然需要执行代码的其他部分。</p><p id="5208" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">例如，假设您正在进行一个API调用，该调用需要大约5秒钟才能返回响应。您有一些其他的JavaScript代码，应该不断地改变网页的背景颜色。在单线程应用程序中，您必须等待5秒钟，让API做出响应，然后继续更改站点的背景颜色。在这5秒钟内，站点将<strong class="kt ir">而不是</strong>改变背景颜色。这叫堵。</p><p id="25d1" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">JavaScript承诺允许你避免阻塞代码。一个承诺说:“我保证我会很快给你一个答复，但不要等待；我准备好了就告诉你。”回应可以是决心，也可以是拒绝。解析类似于<code class="fe kf kg kh ki b">return</code>语句，但可以随时调用；同时，JavaScript继续执行剩余的代码。如果函数遇到错误，就会发生拒绝。</p><p id="87e6" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated"><strong class="kt ir">那么，什么是</strong><code class="fe kf kg kh ki b"><strong class="kt ir">async</strong></code><strong class="kt ir"/><code class="fe kf kg kh ki b"><strong class="kt ir">await</strong></code><strong class="kt ir">？</strong></p><p id="7c1a" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">在以前的JavaScript版本中，您必须像这样编写代码:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="mm mn di mo bf mp"><div class="gh gi ml"><img src="../Images/06853453ee4528bdb3c76cee4479473d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xmE8cQIph0Nsk2G4NmmXsw.png"/></div></div><figcaption class="mq mr gj gh gi ms mt bd b be z dk">Using Promise.then() to handle promise resolution</figcaption></figure><p id="c8fc" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated"><code class="fe kf kg kh ki b">sleep()</code>返回的<code class="fe kf kg kh ki b">Promise</code>对象包含两个方法:<code class="fe kf kg kh ki b">then</code>和<code class="fe kf kg kh ki b">catch</code>。如果承诺解决，将调用<code class="fe kf kg kh ki b">then</code>回调。如果错误导致承诺被拒绝，将调用<code class="fe kf kg kh ki b">catch</code>回调。</p><p id="36df" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">ES6引入了两个新的关键词:<code class="fe kf kg kh ki b">async</code>和<code class="fe kf kg kh ki b">await</code>。</p><p id="3e82" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated"><code class="fe kf kg kh ki b">async</code>关键字是一个函数修饰符。它告诉JavaScript这个函数包含异步代码(通过promises ),但没有显式返回一个<code class="fe kf kg kh ki b">Promise</code>对象。相反，JavaScript会自动将函数的return语句转换为Promise resolution。</p><p id="199b" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">关键字<code class="fe kf kg kh ki b">await</code>说，“等我解决了再继续。”这会阻塞当前的“线程”,直到承诺自行解决。<em class="ng">请注意:浏览器中的JavaScript实际上是单线程的，但在使用Promises和</em> <code class="fe kf kg kh ki b"><em class="ng">async</em></code> <em class="ng"> / </em> <code class="fe kf kg kh ki b"><em class="ng">await</em></code> <em class="ng">时，其行为类似于多线程应用。</em></p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="mm mn di mo bf mp"><div class="gh gi ml"><img src="../Images/79ce8a645a8295b4f79de7bc4d15ec88.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_qxKwVtI5_fRUEJnwDplyQ.png"/></div></div><figcaption class="mq mr gj gh gi ms mt bd b be z dk">JavaScript code for an asynchronous sleep function</figcaption></figure><p id="98c8" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">注意，在原始代码中，<code class="fe kf kg kh ki b">sleep()</code>返回一个<code class="fe kf kg kh ki b">Promise</code>对象。由于<code class="fe kf kg kh ki b">printHelloWorld()</code>中没有<code class="fe kf kg kh ki b">return</code>，所以有一个隐含的<code class="fe kf kg kh ki b">return undefined</code>。由于<code class="fe kf kg kh ki b">printHelloWorld</code>是<code class="fe kf kg kh ki b">async</code>，它也返回一个<code class="fe kf kg kh ki b">Promise</code>对象:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="mm mn di mo bf mp"><div class="gh gi ml"><img src="../Images/041d95b66728678054a0d96fba119f2b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JQttJ6bzhX_nTi67aS7yWw.png"/></div></div><figcaption class="mq mr gj gh gi ms mt bd b be z dk">Async/Await versus regular Promise handling</figcaption></figure><p id="5db3" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">如你所见，<code class="fe kf kg kh ki b">async</code>和<code class="fe kf kg kh ki b">await</code>只是使用承诺的语法糖。</p><h1 id="9ebc" class="lo lp iq bd lq lr ls lt lu lv lw lx ly jw lz jx ma jz mb ka mc kc md kd me mf bi translated">那么，雪球到底做错了什么？</h1><p id="e7ed" class="pw-post-body-paragraph kr ks iq kt b ku mg jr kw kx mh ju kz la mi lc ld le mj lg lh li mk lk ll lm ij bi translated">以下是SnowBit提供的混乱代码:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="mm mn di mo bf mp"><div class="gh gi ml"><img src="../Images/9823d47eb9f1c529e05bf11c70bd4db6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*N-fva3IJHgPINURgzHLmbQ.png"/></div></div><figcaption class="mq mr gj gh gi ms mt bd b be z dk">SnowBit’s INCORRECT code for sleeping in JavaScript</figcaption></figure><p id="7ea8" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">注意这里没有承诺解析的处理程序，也没有任何<code class="fe kf kg kh ki b">async</code>或<code class="fe kf kg kh ki b">await</code>。功能<code class="fe kf kg kh ki b">printHelloWorld</code>必须分配给<code class="fe kf kg kh ki b">async () =&gt; { ... }</code>，而不仅仅是<code class="fe kf kg kh ki b">() =&gt; { ...}</code>。</p><p id="cda0" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">另外，<code class="fe kf kg kh ki b">sleep()</code>立即返回一个<code class="fe kf kg kh ki b">Promise</code>，但是<code class="fe kf kg kh ki b">sleep(500)</code>没有对<code class="fe kf kg kh ki b">then</code>的调用，也不是<code class="fe kf kg kh ki b">awaited</code>。这意味着在执行<code class="fe kf kg kh ki b">console.log("World")</code>之前，JavaScript将<strong class="kt ir">而不是</strong>等待<code class="fe kf kg kh ki b">500</code>毫秒。记录完<code class="fe kf kg kh ki b">Hello</code>后会立即记录<code class="fe kf kg kh ki b">World</code>。</p><p id="9552" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">我不得不说，这是一篇写得非常糟糕的文章——如果你读过“同步”睡眠方法部分，那么<strong class="kt ir">不惜一切代价避免它</strong>。它会使您的JavaScript运行时崩溃！</p></div><div class="ab cl nh ni hu nj" role="separator"><span class="nk bw bk nl nm nn"/><span class="nk bw bk nl nm nn"/><span class="nk bw bk nl nm"/></div><div class="ij ik il im in"><p id="ed8a" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">希望你学到了新的东西，明白了雪鸟犯下的致命错误，自己也不会犯同样的错误。</p><p id="73a1" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">编码快乐！😀</p><p id="151b" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated"><em class="ng">更多内容请看</em> <a class="ae ln" href="https://plainenglish.io/" rel="noopener ugc nofollow" target="_blank"> <strong class="kt ir"> <em class="ng">说白了。报名参加我们的</em> <a class="ae ln" href="http://newsletter.plainenglish.io/" rel="noopener ugc nofollow" target="_blank"> <strong class="kt ir"> <em class="ng">免费周报</em> </strong> </a> <em class="ng">。关注我们</em><a class="ae ln" href="https://twitter.com/inPlainEngHQ" rel="noopener ugc nofollow" target="_blank"><strong class="kt ir"><em class="ng">Twitter</em></strong></a><em class="ng">和</em><a class="ae ln" href="https://www.linkedin.com/company/inplainenglish/" rel="noopener ugc nofollow" target="_blank"><strong class="kt ir"><em class="ng">LinkedIn</em></strong></a><em class="ng">。查看我们的</em> <a class="ae ln" href="https://discord.gg/GtDtUAvyhW" rel="noopener ugc nofollow" target="_blank"> <strong class="kt ir"> <em class="ng">社区不和谐</em> </strong> </a> <em class="ng">加入我们的</em> <a class="ae ln" href="https://inplainenglish.pallet.com/talent/welcome" rel="noopener ugc nofollow" target="_blank"> <strong class="kt ir"> <em class="ng">人才集体</em> </strong> </a> <em class="ng">。</em></strong></a></p></div></div>    
</body>
</html>