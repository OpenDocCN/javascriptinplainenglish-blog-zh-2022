<html>
<head>
<title>A Project Crashed Because of an Expansion Operator</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">一个项目因为一个扩展操作符而崩溃</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/a-project-crashed-because-of-an-expansion-operator-f5f8e11eeb69?source=collection_archive---------4-----------------------#2022-11-21">https://javascript.plainenglish.io/a-project-crashed-because-of-an-expansion-operator-f5f8e11eeb69?source=collection_archive---------4-----------------------#2022-11-21</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="6a7e" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">当一个已经在线稳定运行了一年多的项目突然崩溃。</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/0904920f6d6be78e054ed22f4d693634.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*_NHgfW5c6A3vdola"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk">Photo by <a class="ae kv" href="https://unsplash.com/es/@filisantillan?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Fili Santillán</a> on <a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><h1 id="8db1" class="kw kx iq bd ky kz la lb lc ld le lf lg jw lh jx li jz lj ka lk kc ll kd lm ln bi translated">前言</h1><p id="cbdd" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">在一个周末的晚上，我躺在沙发上看电视，享受闲暇时光。</p><p id="c417" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">突然，一条紧急消息说一个bug需要尽快修复。</p><p id="581f" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">● [Boss]着急地说:“Fatfish，你的代码有问题。用户的页面崩溃了。现在反馈给客服。请看一看。”</p><p id="7299" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">●[我]很惊讶:“不应该。这个代码上线一年多了，一直没有问题，最近也没改。”</p><p id="ead2" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">大家好。我在分享一个准确有趣的故事。前几天，一个在线稳定运行了一年多的项目突然崩溃了。查了一下，发现这段代码的提交者是我自己，但是仔细考虑了一下，没有发现问题。</p><h1 id="0d96" class="kw kx iq bd ky kz la lb lc ld le lf lg jw lh jx li jz lj ka lk kc ll kd lm ln bi translated">发现问题</h1><p id="270d" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">代码简化删除后，留下这样一段代码可能会有问题。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mp mq l"/></div></figure><p id="91cc" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated"><code class="fe mr ms mt mu b">getValuesById</code>是根据<code class="fe mr ms mt mu b">id</code>得到一个数组。这里由于业务的特殊性，需要合并两个阵列。其实合并数组的方法有很多种。当时，我选择了使用<code class="fe mr ms mt mu b">push</code>。</p><p id="c7e5" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">乍一看，这段代码没有任何问题，编写方法也很普通。应该不会出现页面崩溃问题。另外，我进行过多次本地验证，都可以正常工作。</p><p id="23d3" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">稳定运行一年多的项目代码可能出现问题的原因是什么？唯一的变化是时间。时间会改变什么？是因为项目运行时间长了，这里的数据量变大了，导致栈爆炸吗？</p><p id="2d78" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">所以我很快模拟了这段代码在有大量数据问题时的操作:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mp mq l"/></div></figure><p id="5ad4" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">栈居然爆炸了，然后页面崩溃了！</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mv"><img src="../Images/b16745f4c1cc9b8fb612e58326fadbb6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*DIVIV6PC9C2CTGn2.png"/></div></div></figure><p id="0ca5" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">为什么这个代码会爆？是因为<code class="fe mr ms mt mu b">push</code>还是分机操作员？为了找出根本原因，我对这个ES6代码进行了一次Babel转换。结果是:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mp mq l"/></div></figure><p id="7b8e" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">你可以看到这段代码最终变成了<code class="fe mr ms mt mu b">push apply(values, newValues)</code>。</p><p id="9e53" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">在查阅了相关资料后，我了解到，如果以上述方式调用<code class="fe mr ms mt mu b">apply</code>，可能会超出JavaScript引擎参数的长度，并且这里传入的多余参数在不同的JavaScript引擎中会有不同的表现。由于这种限制，一些引擎会抛出异常，甚至导致参数丢失。</p><p id="f942" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">我的上帝，是这样的。谁能想到一个小小的延伸操作符和<code class="fe mr ms mt mu b">push</code>会有这样的副作用？这是否意味着，当传入的参数超过限制时，在所有函数中使用扩展运算符也会有这样的副作用？经过测试，我找到了答案。</p><h1 id="2507" class="kw kx iq bd ky kz la lb lc ld le lf lg jw lh jx li jz lj ka lk kc ll kd lm ln bi translated">解决问题</h1><p id="9d03" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">有许多方法可以合并数组。我们可以改变一个合适的方法。</p><ol class=""><li id="81c5" class="mw mx iq lq b lr mk lu ml lx my mb mz mf na mj nb nc nd ne bi translated">使用<code class="fe mr ms mt mu b">concat</code>合并。</li></ol><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mp mq l"/></div></figure><p id="d393" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">2.使用扩展运算符(更常用)进行合并。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mp mq l"/></div></figure><p id="f2e3" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">3.循环推送。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mp mq l"/></div></figure><p id="20e8" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated"><em class="nf">更内容于</em><a class="ae kv" href="https://plainenglish.io/" rel="noopener ugc nofollow" target="_blank"><strong class="lq ir"><em class="nf"/></strong></a><em class="nf">。报名参加我们的</em> <a class="ae kv" href="http://newsletter.plainenglish.io/" rel="noopener ugc nofollow" target="_blank"> <strong class="lq ir"> <em class="nf">免费周报</em> </strong> </a> <em class="nf">。跟随我们登上</em><a class="ae kv" href="https://twitter.com/inPlainEngHQ" rel="noopener ugc nofollow" target="_blank"><strong class="lq ir"><em class="nf"/></strong></a><a class="ae kv" href="https://www.linkedin.com/company/inplainenglish/" rel="noopener ugc nofollow" target="_blank"><strong class="lq ir"><em class="nf">领英</em></strong></a><strong class="lq ir"><em class="nf"/></strong><a class="ae kv" href="https://www.youtube.com/channel/UCtipWUghju290NWcn8jhyAw" rel="noopener ugc nofollow" target="_blank"><strong class="lq ir"><em class="nf">YouTube</em></strong></a><strong class="lq ir"><em class="nf">和</em></strong><em class="nf"/><strong class="lq ir">T50</strong><strong class="lq ir"> </strong> <em class="nf">对成长黑客感兴趣？</em>查看<a class="ae kv" href="https://circuit.ooo/" rel="noopener ugc nofollow" target="_blank"> <strong class="lq ir"> <em class="nf">电路</em> </strong> </a> <strong class="lq ir"> <em class="nf">。</em>T69</strong></p></div></div>    
</body>
</html>