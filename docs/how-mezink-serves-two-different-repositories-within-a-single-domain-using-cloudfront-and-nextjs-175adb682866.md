# Mezink å¦‚ä½•ä½¿ç”¨ Cloudfront å’Œ Next.js åœ¨ä¸€ä¸ªåŸŸä¸­æœåŠ¡ä¸¤ä¸ªä¸åŒçš„å­˜å‚¨åº“

> åŸæ–‡ï¼š<https://javascript.plainenglish.io/how-mezink-serves-two-different-repositories-within-a-single-domain-using-cloudfront-and-nextjs-175adb682866?source=collection_archive---------8----------------------->

> ä½ åˆ›é€ äº†ä½ çš„ Mezink å—ï¼Ÿå¦‚æœæ²¡æœ‰ä¸‹è½½æˆ‘ä»¬çš„ [app](https://mezink.onelink.me/I54r/app) æˆ–[æŠ¥å](http://mez.ink/sign-in)

åœ¨ [Mezink](http://mez.ink) æˆ‘ä»¬çš„ç½‘ç«™æœ‰ä¸¤ä¸ªä¸»è¦çš„å…¥å£ã€‚
ä¸€ä¸ªæ˜¯é™æ€ç½‘ç«™ï¼Œæœ‰[ä¸»é¡µ](http://mez.ink)ã€[å­¦é™¢](http://mez.ink/academy)ã€[å®šä»·](http://mez.ink/pricing)ç­‰å‡ ä¸ªã€‚

å¦ä¸€ä¸ªæ˜¯æˆ‘ä»¬ä¸ºç”¨æˆ·æä¾›å¾®å‹ç½‘ç«™å’Œç½‘ç»œåº”ç”¨ã€‚æˆ‘ä»¬çš„ç”¨æˆ·ä½¿ç”¨æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºæˆ–ç½‘ç»œåˆ›å»ºå¾®å‹ç½‘ç«™ä¾‹å¦‚[mez.ink/aati](http://mez.ink/aatif)f æ˜¯æˆ‘æ‹¥æœ‰çš„å¾®å‹ç½‘ç«™ä¹‹ä¸€ã€‚

æˆ‘ä»¬ç›®å‰æœ‰å¤§çº¦ 100 ä¸‡ä¸ªå¾®å‹ç½‘ç«™ï¼Œè¿„ä»Šä¸ºæ­¢ï¼Œæˆ‘ä»¬æ¯æœˆçš„æµé‡è¶…è¿‡ 2000 ä¸‡ã€‚

æˆ‘ä»¬çš„å¾®å‹ç½‘ç«™æœ‰å¤æ‚çš„é€»è¾‘ï¼Œåç«¯é›†æˆï¼Œåˆ†æç­‰ï¼Œæ‰€ä»¥æˆ‘ä»¬æƒ³æŠŠå®ƒæ”¾åœ¨ä¸€ä¸ªä¸åŒçš„ä»£ç åº“ï¼Œä»é™æ€ç½‘ç«™åˆ†å¼€ã€‚

> æ³¨æ„:æˆ‘ä»¬çš„ä»£ç åº“éƒ½åœ¨ä½¿ç”¨ [NextJs](https://nextjs.org)

æˆ‘ä»¬çš„ä¸¤ä¸ªä»£ç åº“éƒ½ä½¿ç”¨åŒä¸€ä¸ªåŸŸ`mez.ink`
ï¼Œä½†æ˜¯æœ‰ä¸åŒçš„è·¯å¾„ã€‚
åœ¨æˆ‘ç›´æ¥è¿›å…¥é—®é¢˜ä¹‹å‰ï¼Œè®©æˆ‘ä»¬çœ‹çœ‹æˆ‘ä»¬æ˜¯å¦‚ä½•å¤„ç†è¿™ä¸¤ä¸ªå­˜å‚¨åº“çš„æµé‡åˆ†æµçš„ã€‚

# äºšé©¬é€Š Web æœåŠ¡~ CloudFront çš„ä½œç”¨

æˆ‘ä»¬ä½¿ç”¨äºšé©¬é€Šç½‘ç»œæœåŠ¡ä½œä¸ºæˆ‘ä»¬çš„ä¸»æœºæä¾›å•†ã€‚

> æ³¨æ„:æˆ‘ä¸ä¼šè®¨è®ºæˆ‘ä»¬å¦‚ä½•åˆ›å»ºå®ä¾‹ã€æ¡¶ã€ALB ç­‰ã€‚ä½†å°†åˆ†äº«æˆ‘ä»¬ä½¿ç”¨çš„åˆ†å‘æœºåˆ¶çš„ç®€ä»‹ã€‚

å¦‚ä¸Šæ‰€è¿°ï¼Œæˆ‘ä»¬æœ‰ä¸¤ä¸ªä¸åŒçš„å­˜å‚¨åº“ï¼ŒæœåŠ¡äºä¸åŒçš„ç›®çš„ã€‚å¯¹äºä¸€äº›ç‰¹å®šçš„è·¯çº¿ï¼Œæˆ‘ä»¬åœ¨ [Cloudfront](https://www.amazonaws.cn/en/cloudfront/) åˆ†å¸ƒä¸Šåˆ›å»ºäº†ä¸åŒçš„è¡Œä¸ºã€‚å¦‚æœä½ ä¸äº†è§£ Cloudfront çš„åˆ†å¸ƒï¼Œå®ƒåªæ˜¯ä¸€ä¸ªç®€å•çš„äº¤ä»˜ç½‘ç»œï¼Œä¸å¦‚è¯´æ˜¯åŸºäºåŒºåŸŸæœåŠ¡æµé‡çš„ CDNã€‚

åœ¨åˆ†å¸ƒå±‚ï¼Œæˆ‘ä»¬å®šä¹‰äº†ä¸€äº›è·¯ç”±çš„è¡Œä¸ºã€‚
ç„¶åï¼Œè·¯ç”±è¢«æ˜ å°„åˆ°å„è‡ªçš„è´Ÿè½½å¹³è¡¡å™¨ï¼Œè´Ÿè½½å¹³è¡¡å™¨è¢«æ˜ å°„åˆ°å®ƒä»¬è‡ªå·±çš„ ec2ã€‚

æˆ‘å·²ç»ç”¨å›¾è¡¨è§£é‡Šäº†æµç¨‹ã€‚

> æ³¨æ„:EC2 åªæ˜¯ä¸€ä¸ªæœåŠ¡å™¨ï¼Œä½ å¯ä»¥åœ¨è¿™é‡ŒæŸ¥çœ‹æ›´å¤šç»†èŠ‚

![](img/9cd0fd44c36e3e94bc10ed153ffee990.png)

æ­£å¦‚ä½ å¯ä»¥åœ¨ä¸Šé¢çš„å›¾è¡¨ä¸­çœ‹åˆ°çš„ï¼Œåƒå­¦æœ¯å’Œå®šä»·è¿™æ ·çš„è·¯çº¿è¢«é‡å®šå‘åˆ° mezink-websiteï¼Œåšå®¢è¢«é‡å®šå‘åˆ° WordPressï¼Œé™¤äº†è¿™äº›(/*)ä¹‹å¤–çš„ä»»ä½•ä¸œè¥¿éƒ½è¢«é‡å®šå‘åˆ° mezink microappã€‚

è¯·æ±‚é¦–å…ˆåˆ°è¾¾ CloudFrontï¼ŒåŸºäºå®šä¹‰çš„è¡Œä¸ºï¼ŒCloudFront ç„¶åå°†æµé‡é‡å®šå‘åˆ°å®ƒè‡ªå·±çš„è´Ÿè½½å¹³è¡¡å™¨ï¼Œå®ƒåœ¨å†…éƒ¨æŒ‡å‘ç›¸åº”çš„ EC2 æœåŠ¡å™¨

![](img/a38d4e0e2741d571b7b2b15e3e9f6154.png)

è¿™å°±æ˜¯æˆ‘ä»¬å¦‚ä½•ä½¿ç”¨ Cloudfront åˆ†å‘å°†æµé‡åˆ†æµåˆ°ä¸åŒçš„ EC2

# NextJs ~å‰ç¼€çš„ä½œç”¨

AWS éƒ¨åˆ†å·²ç»å®Œæˆï¼Œä½†åœ¨å‰ç«¯ä»æœ‰ä¸€äº›äº‹æƒ…éœ€è¦è§£å†³ã€‚
æˆ‘ä»¬å°† NextJs ç”¨äºä¸¤ç§ä»£ç åº“ã€‚å¦‚æœæ‚¨çŸ¥é“ NextJs æ„å»ºè¿‡ç¨‹ï¼Œå®ƒå°†æ‰€æœ‰èµ„äº§ä¿å­˜åœ¨`host/_next/`æ–‡ä»¶å¤¹ä¸‹ï¼Œå› æ­¤å¯¹äºæ„å»ºæœŸé—´ç”Ÿæˆçš„ä»»ä½•èµ„äº§ï¼Œè·¯å¾„åº”è¯¥æ˜¯è¿™æ ·çš„

ã€https://mez.ink/_next/static/abc.jsã€‘T2
https://mez.ink/_next/static/image.png

# é—®é¢˜é™ˆè¿°

å¦‚å‰æ‰€è¿°ï¼Œæˆ‘ä»¬æœ‰ç±»ä¼¼äº*[*academy*](http://mez.ink/academy)*å’Œ[*aatif*](http://mez.ink/aatif)*çš„é¡µé¢ï¼Œå®ƒä»¬æ‰˜ç®¡åœ¨ä¸åŒçš„ä»£ç åŸºä¸Šã€‚å½“ç”¨æˆ·ç‚¹å‡»ä»»ä½• URL æ—¶ï¼Œå‘é€è¯·æ±‚ä»¥åœ¨æµè§ˆå™¨ä¸Šä¸‹è½½ HTMLï¼Œå¹¶ä¸”ä» HTML å‘æœåŠ¡å™¨å‘å‡ºèµ„äº§æˆ–èµ„æºè¯·æ±‚ä»¥ä¸‹è½½ JSã€CSS ç­‰ã€‚è¿™äº›é¡µé¢æ‰€å¿…éœ€çš„ã€‚
é€šè¿‡ä½¿ç”¨ä¸‹ä¸€ä¸ªæ„å»ºç³»ç»Ÿï¼Œå¯¹èµ„äº§çš„è¯·æ±‚å°†ç±»ä¼¼äº https://mez.ink/_next/static/someRandom.js çš„[](https://mez.ink/_next/static/abc.js)**ã€‚* å’Œ thi *s* ç»™æˆ‘ä»¬é€ æˆäº†ä¸€ä¸ªé—®é¢˜ï¼Œå¦‚ä½•ï¼Ÿ****

**![](img/14a5fd9ba89ab4c95ba15d29f0ebda4e.png)**

**æ‚¨å¯ä»¥åœ¨å›¾åƒä¸­çœ‹åˆ°ï¼Œåœ†åœˆéƒ¨åˆ†è¡¨ç¤ºä»»ä½•è·¯å¾„æœªåœ¨è¡Œä¸ºä¸­æåŠçš„è¯·æ±‚(*)éƒ½å°†è¢«é‡å®šå‘åˆ° mezink-microapp (ALB)ã€‚**

**è¿™æ„å‘³ç€å½“æˆ‘ä»¬è¯•å›¾ä¸º [academy](http://mez.ink/academy) é¡µé¢ä¸‹è½½èµ„æºæ—¶ï¼Œè¯·æ±‚ä¼šè¢«é‡å®šå‘åˆ° mezink-microappï¼Œä¸ºä»€ä¹ˆï¼Ÿå› ä¸ºèµ„äº§è·¯å¾„ä¼šæ˜¯[](https://mez.ink/_next/static/abc.js)***it*ä¼šæŠ›å‡º 404 ä½œä¸ºæ–‡ä»¶ *academy-component.js* åœ¨ *mezink-mircroapp* æœåŠ¡å™¨*ä¸Šä¸å­˜åœ¨ã€‚*å®ƒå­˜åœ¨äºå¦ä¸€ä¸ªæœåŠ¡å™¨ä¸Šï¼Œå³ *mezink-websiteã€‚* æŸ¥å›¾äº†è§£æµç¨‹******

**![](img/c4d1327f592b0518b34ab57e675d136a.png)**

**æ‚¨åœ¨æµè§ˆå™¨ä¸­ç‚¹å‡»`mez.ink/academy`ï¼ŒHTML è¢«ä¸‹è½½ï¼Œå¯¹`academy.js`çš„è¯·æ±‚è¢«åˆ›å»ºä»¥ä¸‹è½½ JSï¼Œè¯·æ±‚æ ¹æ® CloudFront å®šä¹‰çš„è¡Œä¸ºåˆ°è¾¾`mezink-microapp`æœåŠ¡å™¨ï¼Œæœ€ç»ˆæŠ›å‡º 404 é”™è¯¯**

# **å‡ºè·¯**

**[NextJs](http://nextjs.org) å¸¦æœ‰ä¸€ä¸ªå«åš [assetPrefix](https://nextjs.org/docs/api-reference/next.config.js/cdn-support-with-asset-prefix) å’Œ[é‡å†™](https://nextjs.org/docs/api-reference/next.config.js/rewrites)çš„è¶…çº§æ¦‚å¿µï¼Œè¿™æ˜¯æˆ‘ä»¬çš„å‡ºè·¯ã€‚
å¦‚æœä½ é˜…è¯»ä¸‹ä¸€ä¸ª js æ–‡æ¡£ï¼Œå®ƒè¯´`assetPrefix`ä½ å¯ä»¥è®¾ç½®ä¸€ä¸ªå‰ç¼€ï¼Œå¹¶é…ç½®ä½ çš„ CDN çš„æºï¼Œä»¥è§£æåˆ° Next.js æ‰€åœ¨çš„åŸŸã€‚**

**åœ¨ç»§ç»­ä¹‹å‰ï¼Œè®©æˆ‘å‘æ‚¨å±•ç¤ºæˆ‘ä»¬åœ¨ä¸‹ä¸€ä¸ªé…ç½®ä¸­æ‰€åšçš„æ›´æ”¹**

**next.config.js**

**æˆ‘ä»¬æ·»åŠ äº†`assetPrefix`,å°†å…¶å‘½åä¸º`*mez-static*`,ç”¨äºæ„å»ºæœŸé—´ç”Ÿæˆçš„æ‰€æœ‰èµ„äº§ã€‚èµ„äº§å‰ç¼€å°†åœ¨æˆ‘ä»¬çš„æ‰€æœ‰èµ„äº§å‰é™„åŠ `mez-static`ã€‚å½“ HTML åœ¨æ„å»ºæœŸé—´ç”Ÿæˆæ—¶ï¼Œè¦ä¸‹è½½çš„èµ„äº§æˆ–èµ„æºå°†å…·æœ‰ç±»ä¼¼`mez.ink/mez-static/_next/:path*`çš„ç»“æ„**

**æˆ‘ä»¬è¿˜æ·»åŠ äº†ä¸€ä¸ª`rewrite`è§„åˆ™ï¼Œåœ¨è¿™é‡Œæˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ªæºå’Œç›®çš„åœ°ã€‚å¦‚æœæœ‰ä»»ä½•è¯·æ±‚ä¼ åˆ°`mez-static/_next/:path`ä¼šå°†å…¶é‡å†™åˆ°`_next/:path`ã€‚æŸ¥çœ‹å›¾è¡¨ï¼Œæ›´å¥½åœ°ç†è§£æµç¨‹**

**![](img/52dc3adbedc40993a2456f8993d115ec.png)**

**Rewrite å®é™…ä¸Šæ˜¯ä¸€ä¸ª URL ä»£ç†ï¼Œå®ƒä»å‰ç¼€ä¸º`mez-static`çš„`_next/:path*`ä¸­è·å–èµ„äº§ã€‚å®ƒå±è”½äº†ç›®æ ‡è·¯å¾„ï¼Œè®©ç”¨æˆ·çœ‹èµ·æ¥æ²¡æœ‰æ”¹å˜ä»–ä»¬çš„ä½ç½®ã€‚**

**ç»ˆäºï¼Œæ¾äº†ä¸€å£æ°”ï¼Œæˆ‘ä»¬é¢ä¸´çš„ä»ä¸€ä¸ªåŸŸæœåŠ¡ä¸åŒèµ„äº§çš„é—®é¢˜è¢«è¿™äº›å°è€Œæœ‰æ•ˆçš„é»‘å®¢è§£å†³äº†ï¼Œ**ä½†æ˜¯äº‹æƒ…å¹¶æ²¡æœ‰å°±æ­¤åœæ­¢ã€‚****

## **é™æ€ç«™ç‚¹ç”Ÿæˆçš„é¡µé¢ä¸ SSR é¡µé¢**

**å®é™…ä¸Šï¼Œåªæœ‰å½“ä½ æœ‰é™æ€çš„ç«™ç‚¹ç”Ÿæˆ(SSG)é¡µé¢æ—¶ï¼Œæ‰€æœ‰è¿™äº›æ”¹å˜æ‰èƒ½å¾ˆå¥½åœ°å·¥ä½œï¼Œä½†æ˜¯å¦‚æœä½ åˆ›å»ºçš„æ˜¯åŠ¨æ€é¡µé¢ï¼Œè¿™äº›æ”¹å˜å°±ä¼šè¢«æ‰“æ–­ã€‚**

**é™æ€ç«™ç‚¹ç”Ÿæˆçš„é¡µé¢æ„å‘³ç€ä½ çš„é¡µé¢ä¸æ˜¯åŠ¨æ€çš„ï¼Œä¹Ÿä¸ä¾èµ–äºä»»ä½• API æˆ–æ•°æ®ã€‚è¿™ç§é¡µé¢æ˜¯åœ¨æ„å»ºæ—¶ç”Ÿæˆçš„ã€‚**

**å¦ä¸€æ–¹é¢ï¼ŒæœåŠ¡å™¨ç«¯å‘ˆç°çš„é¡µé¢é€šå¸¸æ˜¯åŠ¨æ€çš„ï¼Œå®ƒä»¬å¯èƒ½éœ€è¦ä¸€äº› API é›†æˆï¼Œå¹¶ä¸”ä¸æ˜¯åœ¨æ„å»ºæ—¶ç”Ÿæˆçš„ã€‚**

**ä¸ºäº†æ›´å¥½åœ°ç†è§£è¿™ä¸€ç‚¹ï¼Œä½ éœ€è¦ç†è§£ SSG çš„æ¦‚å¿µ[è¿™é‡Œ](https://nextjs.org/docs/basic-features/pages#static-generation)**

**åœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­ï¼Œä»`mezink-website` (ALB)è·å¾—çš„ä¸€äº›é¡µé¢æ˜¯åŠ¨æ€çš„ï¼Œæˆ‘ä»¬çš„ä¸Šè¿°è§£å†³æ–¹æ¡ˆä¸é€‚ç”¨äºåŠ¨æ€é¡µé¢ã€‚**

> **ä½†æ˜¯ä¸è¦æ‹…å¿ƒï¼Œå­©å­ï¼Œæ¯ä¸ªé—®é¢˜éƒ½ä¼šæœ‰ä¸€ä¸ªè§£å†³æ–¹æ¡ˆ**

## **ä½†æ˜¯ï¼Œç­‰ä¸€ä¼šå„¿**

**è¿™ç¯‡æ–‡ç« å·²ç»æ¶µç›–äº†å¾ˆå¤šä¸œè¥¿ï¼Œ*æˆ‘å°†å‘è¡¨ä¸€ç¯‡å…³äºæˆ‘ä»¬å¦‚ä½•ä¸º SSR* è§£å†³èµ„äº§ä¸‹è½½é—®é¢˜çš„æ–°æ–‡ç« ï¼Œä»¥åŠä¸€äº›å…³äº SSG å’Œ SSR é¡µé¢çš„é¢å¤–ç»†èŠ‚ã€‚**

**åœ¨é‚£ä¹‹å‰ï¼Œä½ å¯ä»¥é¼“æŒğŸ‘ ğŸ‘ï¼Œå¦‚æœä½ å–œæ¬¢å®ƒæˆ–è€…å­¦åˆ°äº†æ–°çš„ä¸œè¥¿ï¼Œä¹Ÿä¸è¦å¿˜è®°ä¸ä½ çš„æœ‹å‹åˆ†äº«ã€‚ğŸ˜€ ğŸ˜„**

> **ä¸€å®šè¦çœ‹çœ‹æˆ‘ä»¬çš„[ç½‘ç«™](http://mez.ink)æˆ‘ä»¬æœ€è¿‘æ¨å‡ºäº†ä¸€äº›å¾ˆé…·çš„å…è´¹ä¸œè¥¿ï¼Œå¦‚[äºŒç»´ç ç”Ÿæˆå™¨](https://mez.ink/qr-code-generator)ã€[å‚ä¸åº¦è®¡ç®—å™¨](https://mez.ink/tools/instagram-engagement-calculator)å¹¶åœ¨ [twitter](https://twitter.com/aatifbandey) ä¸Šå…³æ³¨æˆ‘**

***æ›´å¤šå†…å®¹è¯·çœ‹* [***è¯´ç™½äº†ã€‚æŠ¥åå‚åŠ æˆ‘ä»¬çš„***](https://plainenglish.io/) **[***å…è´¹å‘¨æŠ¥***](http://newsletter.plainenglish.io/) *ã€‚å…³æ³¨æˆ‘ä»¬*[***Twitter***](https://twitter.com/inPlainEngHQ)*å’Œ*[***LinkedIn***](https://www.linkedin.com/company/inplainenglish/)*ã€‚æŸ¥çœ‹æˆ‘ä»¬çš„* [***ç¤¾åŒºä¸å’Œè°***](https://discord.gg/GtDtUAvyhW) *åŠ å…¥æˆ‘ä»¬çš„* [***äººæ‰é›†ä½“***](https://inplainenglish.pallet.com/talent/welcome) *ã€‚*****