<html>
<head>
<title>Use expo-auth-session with Facebook the Easiest Way on iOS/Android</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在iOS/Android上使用脸书的expo-auth-session是最简单的方法</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/use-expo-auth-session-with-facebook-the-most-easy-way-on-ios-android-1fd168deaf58?source=collection_archive---------2-----------------------#2022-04-15">https://javascript.plainenglish.io/use-expo-auth-session-with-facebook-the-most-easy-way-on-ios-android-1fd168deaf58?source=collection_archive---------2-----------------------#2022-04-15</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><h2 id="37ae" class="io ip iq bd b dl ir is it iu iv iw dk ix translated" aria-label="kicker paragraph">Expo.io提示</h2><div class=""/><div class=""><h2 id="67b9" class="pw-subtitle-paragraph jw iz iq bd b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn dk translated">想要实现与脸书和expo.io的OAuth2连接吗？你来对地方了！</h2></div><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi ko"><img src="../Images/f4d46c8d3338880ebdad390cdfdd80e0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rVoGCWp-PxWU3b8bIShEBw.png"/></div></div></figure><p id="c311" class="pw-post-body-paragraph la lb iq lc b ld le ka lf lg lh kd li lj lk ll lm ln lo lp lq lr ls lt lu lv ij bi translated"><a class="ae lw" href="https://www.codingspark.io/blog/utiliser-expo-auth-session-via-facebook-expo-managed-workflow-expo-gostandalone-appexpo-dev-client-eas-build" rel="noopener ugc nofollow" target="_blank"> <strong class="lc ja">此贴有🇫🇷法文版</strong> </a></p><h1 id="2357" class="lx ly iq bd lz ma mb mc md me mf mg mh kf mi kg mj ki mk kj ml kl mm km mn mo bi translated">为什么是这篇文章？</h1><p id="eaa5" class="pw-post-body-paragraph la lb iq lc b ld mp ka lf lg mq kd li lj mr ll lm ln ms lp lq lr mt lt lu lv ij bi translated">由于脸书和谷歌的OAUth2认证API现已过时，世博会邀请我们使用名为<strong class="lc ja"> expo-auth-session </strong>的基于Web浏览器的新实现。</p><p id="1fde" class="pw-post-body-paragraph la lb iq lc b ld le ka lf lg lh kd li lj lk ll lm ln lo lp lq lr ls lt lu lv ij bi translated">然而，我们不得不承认，它仍然不能在所有情况下都很好地工作。</p><p id="f5bf" class="pw-post-body-paragraph la lb iq lc b ld le ka lf lg lh kd li lj lk ll lm ln lo lp lq lr ls lt lu lv ij bi translated">事实上，当你使用Expo GO(Expo的预编译客户端)时，它工作得很好，但当你创建一个独立的应用程序时，它会很快变得复杂，特别是在Android上，你最终会抓狂。</p><p id="5220" class="pw-post-body-paragraph la lb iq lc b ld le ka lf lg lh kd li lj lk ll lm ln lo lp lq lr ls lt lu lv ij bi translated">在撰写本文时，有几个主题报告了与expo-auth-session (SDK44 Expo)相关的各种问题</p><ul class=""><li id="d41e" class="mu mv iq lc b ld le lg lh lj mw ln mx lr my lv mz na nb nc bi translated"><a class="ae lw" href="https://github.com/expo/expo/issues/9917" rel="noopener ugc nofollow" target="_blank">https://github.com/expo/expo/issues/9917</a></li><li id="2fb3" class="mu mv iq lc b ld nd lg ne lj nf ln ng lr nh lv mz na nb nc bi translated"><a class="ae lw" href="https://github.com/expo/expo/issues/13714" rel="noopener ugc nofollow" target="_blank">https://github.com/expo/expo/issues/13714</a></li><li id="f721" class="mu mv iq lc b ld nd lg ne lj nf ln ng lr nh lv mz na nb nc bi translated"><a class="ae lw" href="https://github.com/expo/expo/issues/17011" rel="noopener ugc nofollow" target="_blank">https://github.com/expo/expo/issues/17011</a></li><li id="fcaa" class="mu mv iq lc b ld nd lg ne lj nf ln ng lr nh lv mz na nb nc bi translated"><a class="ae lw" href="https://github.com/expo/expo/issues/13513" rel="noopener ugc nofollow" target="_blank">https://github.com/expo/expo/issues/13513</a></li></ul><p id="8f86" class="pw-post-body-paragraph la lb iq lc b ld le ka lf lg lh kd li lj lk ll lm ln lo lp lq lr ls lt lu lv ij bi translated">经过大量的研究和实验，我发现了一个很好的解决方案，它解决了两个问题，以便在IOS和Android上以托管工作流的方式为在独立或expo-dev-client中使用eas-build创建的应用程序提供功能性的脸书登录。</p><p id="0354" class="pw-post-body-paragraph la lb iq lc b ld le ka lf lg lh kd li lj lk ll lm ln lo lp lq lr ls lt lu lv ij bi translated">但是首先，让我们看看expo-auth-session是如何工作的。</p><h1 id="b88c" class="lx ly iq bd lz ma mb mc md me mf mg mh kf mi kg mj ki mk kj ml kl mm km mn mo bi translated">世博会授权会议是如何工作的？</h1><p id="c90f" class="pw-post-body-paragraph la lb iq lc b ld mp ka lf lg mq kd li lj mr ll lm ln ms lp lq lr mt lt lu lv ij bi translated"><strong class="lc ja"> expo-auth-session </strong>是一个旨在简化我们的OAuth2授权生活的库，支持各种提供商，其中包括谷歌和脸书。</p><p id="1f66" class="pw-post-body-paragraph la lb iq lc b ld le ka lf lg lh kd li lj lk ll lm ln lo lp lq lr ls lt lu lv ij bi translated">它通过一个简单的API提供原语，该API允许在我们的应用程序中打开一个使用系统浏览器cookies的浏览器(以便利用我们可能已经连接到给定服务的事实)。</p><p id="ff22" class="pw-post-body-paragraph la lb iq lc b ld le ka lf lg lh kd li lj lk ll lm ln lo lp lq lr ls lt lu lv ij bi translated">一旦用户验证了权限，库将管理第三方服务的重定向，并处理返回的数据，以便检索身份验证令牌、用户ID和OAuth2连接过程中可能使用的所有其他内容。有了这个身份验证令牌，我们就可以使用第三方API来检索客户端数据。</p><p id="6004" class="pw-post-body-paragraph la lb iq lc b ld le ka lf lg lh kd li lj lk ll lm ln lo lp lq lr ls lt lu lv ij bi translated">正如我们所见，它很实用，在Expo GO上运行良好，但在没有Expo GO中所有微调配置的独立应用程序上，它有时会更复杂，尤其是在Android上。</p><p id="ff26" class="pw-post-body-paragraph la lb iq lc b ld le ka lf lg lh kd li lj lk ll lm ln lo lp lq lr ls lt lu lv ij bi translated">不要慌:下面是一个非常容易实现的功能性工作流程。</p><h1 id="ffeb" class="lx ly iq bd lz ma mb mc md me mf mg mh kf mi kg mj ki mk kj ml kl mm km mn mo bi translated">适用于ExpoGO和Android/IOS单机版(EAS版本)的脸书的完整功能性expo-auth-session工作流</h1><p id="6914" class="pw-post-body-paragraph la lb iq lc b ld mp ka lf lg mq kd li lj mr ll lm ln ms lp lq lr mt lt lu lv ij bi translated">在expo SDK 44上使用给定的软件包版本进行了测试:</p><pre class="kp kq kr ks gt ni nj nk nl aw nm bi"><span id="0665" class="nn ly iq nj b gy no np l nq nr">// Packages versions range<br/>{<br/>  "expo": "~44.0.0",<br/>  "expo-app-loading": "~1.3.0",<br/>  "expo-auth-session": "~3.5.0",<br/>  "expo-constants": "~13.0.1",<br/>  "expo-dev-client": "~0.8.4",<br/>  "expo-random": "~12.1.1",<br/>  "expo-status-bar": "~1.2.0",<br/>  "expo-updates": "~0.11.6"<br/>}</span></pre><h2 id="6c3a" class="nn ly iq bd lz ns nt dn md nu nv dp mh lj nw nx mj ln ny nz ml lr oa ob mn iw bi translated">1-安装者展示-授权-会话和deps</h2><pre class="kp kq kr ks gt ni nj nk nl aw nm bi"><span id="a81e" class="nn ly iq nj b gy no np l nq nr">expo install expo-auth-session expo-random</span></pre><p id="c7e6" class="pw-post-body-paragraph la lb iq lc b ld le ka lf lg lh kd li lj lk ll lm ln lo lp lq lr ls lt lu lv ij bi translated">(<a class="ae lw" href="https://docs.expo.dev/versions/v44.0.0/sdk/auth-session" rel="noopener ugc nofollow" target="_blank">更多详情</a>)</p><h2 id="0adb" class="nn ly iq bd lz ns nt dn md nu nv dp mh lj nw nx mj ln ny nz ml lr oa ob mn iw bi translated">2-为我们的应用程序定义深度链接方案</h2><pre class="kp kq kr ks gt ni nj nk nl aw nm bi"><span id="0e14" class="nn ly iq nj b gy no np l nq nr">// app.json or equivalent<br/>{<br/>  "expo": {<br/>    "scheme": "codingspark" // Allows to deeplink to codingspark://<br/>  }<br/>}</span></pre><h2 id="1795" class="nn ly iq bd lz ns nt dn md nu nv dp mh lj nw nx mj ln ny nz ml lr oa ob mn iw bi translated">3-配置脸书开发者应用程序</h2><p id="2488" class="pw-post-body-paragraph la lb iq lc b ld mp ka lf lg mq kd li lj mr ll lm ln ms lp lq lr mt lt lu lv ij bi translated">转到您的脸书应用程序的配置(如果您没有应用程序，请创建一个)并在<strong class="lc ja">脸书登录</strong>部分输入expo auth链接的URL。</p><p id="7f10" class="pw-post-body-paragraph la lb iq lc b ld le ka lf lg lh kd li lj lk ll lm ln lo lp lq lr ls lt lu lv ij bi translated">这个网址由两部分组成<a class="ae lw" href="https://auth.expo.io/" rel="noopener ugc nofollow" target="_blank">https://auth.expo.io/</a>和你的<code class="fe oc od oe nj b">originalFullName</code>，这是应用程序的<code class="fe oc od oe nj b">username</code>和<code class="fe oc od oe nj b">slug</code>的总和。</p><p id="25f7" class="pw-post-body-paragraph la lb iq lc b ld le ka lf lg lh kd li lj lk ll lm ln lo lp lq lr ls lt lu lv ij bi translated"><strong class="lc ja">举例:</strong>T3】</p><p id="2504" class="pw-post-body-paragraph la lb iq lc b ld le ka lf lg lh kd li lj lk ll lm ln lo lp lq lr ls lt lu lv ij bi translated">要获得您的<code class="fe oc od oe nj b">originalFullName</code>,您可以在项目的根文件夹中使用以下命令:</p><pre class="kp kq kr ks gt ni nj nk nl aw nm bi"><span id="eebd" class="nn ly iq nj b gy no np l nq nr">expo config --type public | grep "originalFullName"</span></pre><p id="5a4d" class="pw-post-body-paragraph la lb iq lc b ld le ka lf lg lh kd li lj lk ll lm ln lo lp lq lr ls lt lu lv ij bi translated">然后，我们检查我们是否处于这种状态，并进行验证！</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi of"><img src="../Images/3b44fa37e412be552b988a9b775128b0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*FTHCc82IO_SgzxfP"/></div></div></figure><p id="0139" class="pw-post-body-paragraph la lb iq lc b ld le ka lf lg lh kd li lj lk ll lm ln lo lp lq lr ls lt lu lv ij bi translated">现在最精彩的部分…</p><h2 id="47e4" class="nn ly iq bd lz ns nt dn md nu nv dp mh lj nw nx mj ln ny nz ml lr oa ob mn iw bi translated">4 —一点黑客代码！</h2><p id="92a2" class="pw-post-body-paragraph la lb iq lc b ld mp ka lf lg mq kd li lj mr ll lm ln ms lp lq lr mt lt lu lv ij bi translated">首先要注意的是，我们目前在EAS build上有一个bug，当你阅读这篇文章时，这个bug可能不再相关了(如果是这种情况，请不要犹豫地给我打电话)。</p><p id="e978" class="pw-post-body-paragraph la lb iq lc b ld le ka lf lg lh kd li lj lk ll lm ln lo lp lq lr ls lt lu lv ij bi translated">为此，你必须重载下面的<code class="fe oc od oe nj b">originalFullName</code>，在应用程序开始的某个地方，否则，你将在使用<code class="fe oc od oe nj b">useProxy: true</code>时得到一个错误。您可以查看本文开头的主题，了解这些bug的进展。</p><pre class="kp kq kr ks gt ni nj nk nl aw nm bi"><span id="4159" class="nn ly iq nj b gy no np l nq nr">// Somewhere at application root like App.tsx<br/>// <a class="ae lw" href="https://github.com/expo/expo/issues/13714" rel="noopener ugc nofollow" target="_blank">https://github.com/expo/expo/issues/13714</a> to counter this issue<br/>import Constants from "expo-constants";<br/>Constants.manifest!.originalFullName = "@&lt;teamname/username&gt;/&lt;slug&gt;";</span></pre><p id="78ff" class="pw-post-body-paragraph la lb iq lc b ld le ka lf lg lh kd li lj lk ll lm ln lo lp lq lr ls lt lu lv ij bi translated">第二个问题是重定向问题，它不起作用，要么使应用程序崩溃，要么做出其他奇怪的行为，就是不起作用。</p><p id="b89e" class="pw-post-body-paragraph la lb iq lc b ld le ka lf lg lh kd li lj lk ll lm ln lo lp lq lr ls lt lu lv ij bi translated"><strong class="lc ja">这里的解决方案是始终使用auth.expo.io链接，这有几个好处</strong></p><p id="34c6" class="pw-post-body-paragraph la lb iq lc b ld le ka lf lg lh kd li lj lk ll lm ln lo lp lq lr ls lt lu lv ij bi translated">为此，您需要将<code class="fe oc od oe nj b">useProxy: true</code>和一个手动定义的<code class="fe oc od oe nj b">redirectURL</code>参数结合起来，该参数将始终在auth.expo.io中生成链接。</p><pre class="kp kq kr ks gt ni nj nk nl aw nm bi"><span id="e841" class="nn ly iq nj b gy no np l nq nr">import Constants from "expo-constants";</span><span id="72a6" class="nn ly iq nj b gy og np l nq nr">export const HomeScreen: React.FC = () =&gt; {<br/>  const [, response, prompt] = Facebook.useAuthRequest(<br/>    {<br/>      clientId: "&lt;facebook_app_id&gt;", // Must be defined in JavaScript, won't use app.json values.<br/>      redirectUri: AuthSession.makeRedirectUri({ useProxy: true }), // useProxy here…<br/>    },<br/>    { useProxy: true } // …and also here<br/>  );</span><span id="1fe2" class="nn ly iq nj b gy og np l nq nr">return &lt;AppButton onPress={() =&gt; prompt()} title="Login with FB" /&gt;<br/>}</span></pre><p id="021c" class="pw-post-body-paragraph la lb iq lc b ld le ka lf lg lh kd li lj lk ll lm ln lo lp lq lr ls lt lu lv ij bi translated">然后我们在<code class="fe oc od oe nj b">response</code>变量中获得认证令牌，这允许我们查询脸书API，如下所示:</p><pre class="kp kq kr ks gt ni nj nk nl aw nm bi"><span id="e69d" class="nn ly iq nj b gy no np l nq nr">https://graph.facebook.com/me?fields=first_name,last_name,email,picture.type(large)&amp;access_token=${response.authentication.accessToken}</span></pre><p id="49da" class="pw-post-body-paragraph la lb iq lc b ld le ka lf lg lh kd li lj lk ll lm ln lo lp lq lr ls lt lu lv ij bi translated">瞧，在等待Expo对该模块的使用进行一点改进时，你应该会没事的。</p><p id="af09" class="pw-post-body-paragraph la lb iq lc b ld le ka lf lg lh kd li lj lk ll lm ln lo lp lq lr ls lt lu lv ij bi translated"><em class="oh">更多内容请看</em><a class="ae lw" href="https://plainenglish.io/" rel="noopener ugc nofollow" target="_blank"><strong class="lc ja"><em class="oh">plain English . io</em></strong></a><em class="oh">。报名参加我们的</em> <a class="ae lw" href="http://newsletter.plainenglish.io/" rel="noopener ugc nofollow" target="_blank"> <strong class="lc ja"> <em class="oh">免费周报</em> </strong> </a> <em class="oh">。关注我们关于</em><a class="ae lw" href="https://twitter.com/inPlainEngHQ" rel="noopener ugc nofollow" target="_blank"><strong class="lc ja"><em class="oh">Twitter</em></strong></a><em class="oh">和</em><a class="ae lw" href="https://www.linkedin.com/company/inplainenglish/" rel="noopener ugc nofollow" target="_blank"><strong class="lc ja"><em class="oh">LinkedIn</em></strong></a><em class="oh">。加入我们的</em> <a class="ae lw" href="https://discord.gg/GtDtUAvyhW" rel="noopener ugc nofollow" target="_blank"> <strong class="lc ja"> <em class="oh">社区不和谐</em> </strong> </a> <em class="oh">。</em></p></div></div>    
</body>
</html>