<html>
<head>
<title>Testing in Node.js with External HTTP Services Dependency</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用外部HTTP服务依赖项在Node.js中进行测试</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/testing-in-node-js-with-external-http-services-dependency-8d9e8be1f0fa?source=collection_archive---------17-----------------------#2022-02-02">https://javascript.plainenglish.io/testing-in-node-js-with-external-http-services-dependency-8d9e8be1f0fa?source=collection_archive---------17-----------------------#2022-02-02</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><div class=""><h2 id="4918" class="pw-subtitle-paragraph jk im in bd b jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb dk translated">使用外部HTTP服务依赖在Node.js中进行测试的教程。</h2></div><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi kc"><img src="../Images/209194b63c7aebe3c9d0d97f606cbf28.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*0Zjl6REJrDnD-pEw"/></div></div><figcaption class="ko kp gj gh gi kq kr bd b be z dk">Photo by <a class="ae ks" href="https://unsplash.com/@cgower?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Christopher Gower</a> on <a class="ae ks" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="107a" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">当我们开发一些产品/特性时，需要调用外部服务是一个非常常见的场景。如果我们想创建测试良好的代码，就必须考虑如何处理这个问题。通常我们有两种选择:<strong class="kv io">为服务提供一个可访问的测试环境</strong>或者<strong class="kv io">模拟调用。</strong></p><p id="643c" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">关于“<strong class="kv io">为服务提供一个可访问的测试环境”</strong>要记住的是，也许我们可以从我们的机器上实现这一点，但是如果不能从我们的配置项访问该环境，或者如果服务出现故障或出现新的bug，那该怎么办呢——所有这些都可能导致我们的测试失败。为此，在这篇文章中，我们将重点讨论“<strong class="kv io">模仿叫声</strong>”。</p><p id="7a93" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">当我们说“<strong class="kv io">嘲讽调用</strong>”时，我们是在讨论发出一个真正的HTTP请求，拦截调用，并以我们想要的任何方式进行响应。我们<strong class="kv io">不是</strong>在讨论一些奇怪的模块嘲讽或者一些自定义代码。对于我们的模拟，我们将使用一个名为<a class="ae ks" href="https://www.npmjs.com/package/nock" rel="noopener ugc nofollow" target="_blank"> <strong class="kv io"> nock </strong> </a> <strong class="kv io">的模块。</strong></p><p id="852e" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated"><strong class="kv io"> Nock </strong>允许我们定义URL、路径、方法、事件头和参数(路径、查询和主体)并设置我们将要得到的响应(HTTP代码、主体、头)。一个非常好的特性是，如果我们设置mock来获取一些具体参数的头，而我们的代码没有发送它们，那么mock就不会工作，我们的测试就会失败。</p><p id="94b8" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">现在，让我们看一个如何在我们的代码中使用这个包的例子。</p><p id="57b4" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">All开始安装软件包:</p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi lp"><img src="../Images/1ad899bc86cf04181150d1bbf810f312.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*SF15a7MrQsO3_8Y7jhvYGw.png"/></div></div></figure><p id="41ee" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">现在，我们将开始我们的测试用例。让我们为一个简单的调用创建一个测试用例:</p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi lq"><img src="../Images/38568547f97901558b1438e8b34b187f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*X6-vMlzyxt9KB_Ie8TAx3A.png"/></div></div></figure><p id="b2d7" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">在设置nock mock之前，我们会遇到一些错误(取决于你如何在代码中处理这些错误)。在这种情况下，我们会得到这样的结果:</p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi lr"><img src="../Images/dddf38691bf5dcfdf17f5892c1dfc1f3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UOtn3xiwqFO_dJ6Z3Py94A.png"/></div></div></figure><p id="380d" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">我们正在处理错误，并返回“”作为结果。</p><p id="aa38" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">当我们完成我们的代码，HTTP就像它应该的那样，所有的工作！</p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi ls"><img src="../Images/61886e6216b335f80c576d3e525bc2db.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gIJgjCUehQ_6TZqUQygLbQ.png"/></div></div></figure><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi lt"><img src="../Images/a4c371cae3bd6c911bcc36a3eeeac554.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kydwCNMa17-6iJDzsfBZcw.png"/></div></div></figure><p id="2b9d" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">我们可以利用这个库做的事情有:</p><ul class=""><li id="c655" class="lu lv in kv b kw kx kz la lc lw lg lx lk ly lo lz ma mb mc bi translated">检查我们是否调用了nock mock(通常如果我们没有调用，测试应该会失败，但是也许我们想确定)</li></ul><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi md"><img src="../Images/2a393c02f50bfd2bed8fd13b9b9c7ea0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WtB4Hgt39cYcXvAa-MQtaA.png"/></div></div></figure><ul class=""><li id="ab3f" class="lu lv in kv b kw kx kz la lc lw lg lx lk ly lo lz ma mb mc bi translated">确保该服务被调用X次。它必须处理同一个请求两次。我们可以使用上面看到的“isDone()”来确定这一点。</li></ul><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi me"><img src="../Images/489ffbd92e0261ec8782b7e3675da5a3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*m4W9ddQ4zJD96oyIszXVNw.png"/></div></div></figure><ul class=""><li id="8585" class="lu lv in kv b kw kx kz la lc lw lg lx lk ly lo lz ma mb mc bi translated">为连续的电话准备不同的回答。第一个调用将得到200，第二个调用将得到500。</li></ul><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi mf"><img src="../Images/e5201566847c458650b38258a639f6b5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JJBT2NrUm4-nnAUh9S0xQg.png"/></div></div></figure><p id="c3ec" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">这个有用的模块有更多的选项，我邀请你在<a class="ae ks" href="https://www.npmjs.com/package/nock" rel="noopener ugc nofollow" target="_blank">项目自述</a>中查看全部特性。</p><p id="da85" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">这里的要点是<strong class="kv io">我们需要</strong>来开始我们的代码并与外部服务<strong class="kv io">进行集成的唯一事情是拥有API规范</strong>:可用的方法、路径、参数和返回的数据。这样，我们可以确保我们的代码能够处理任何API行为(即使当服务不可用或者它响应错误时)。</p><p id="b930" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated"><strong class="kv io">人们应该犯的常见错误</strong>:</p><ul class=""><li id="7eea" class="lu lv in kv b kw kx kz la lc lw lg lx lk ly lo lz ma mb mc bi translated">没有定义正确的调用预期(相同的头、参数等。)</li><li id="d55f" class="lu lv in kv b kw mg kz mh lc mi lg mj lk mk lo lz ma mb mc bi translated">在多次重新定义相同服务的测试后，不要清理nock模拟</li></ul><p id="591b" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">要意识到这些小事会让你陷入困境一段时间。</p><p id="f7de" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">希望这对你有帮助，谢谢你的阅读。</p><p id="5a46" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">完整的代码包含在这个项目的<a class="ae ks" href="https://github.com/amcereijo/mongo-testing-demo" rel="noopener ugc nofollow" target="_blank">中。</a></p><p id="94f3" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated"><em class="ml">更多内容看</em> <a class="ae ks" href="http://plainenglish.io/" rel="noopener ugc nofollow" target="_blank"> <strong class="kv io"> <em class="ml">说白了。报名参加我们的</em> <a class="ae ks" href="http://newsletter.plainenglish.io/" rel="noopener ugc nofollow" target="_blank"> <strong class="kv io"> <em class="ml">免费周报</em> </strong> </a> <em class="ml">。在我们的</em> <a class="ae ks" href="https://discord.gg/GtDtUAvyhW" rel="noopener ugc nofollow" target="_blank"> <strong class="kv io"> <em class="ml">社区不和谐</em> </strong> </a> <em class="ml">获得独家获取写作机会和建议。</em></strong></a></p></div></div>    
</body>
</html>