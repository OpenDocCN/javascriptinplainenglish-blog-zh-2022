<html>
<head>
<title>Share Secret Tokens Across Multiple Tabs Securely In Angular</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在Angular中跨多个标签安全地共享秘密令牌</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/share-secret-tokens-across-multiple-tabs-securely-in-angular-f9014f66dbc4?source=collection_archive---------5-----------------------#2022-03-09">https://javascript.plainenglish.io/share-secret-tokens-across-multiple-tabs-securely-in-angular-f9014f66dbc4?source=collection_archive---------5-----------------------#2022-03-09</a></blockquote><div><div class="fc if ig ih ii ij"/><div class="ik il im in io"><div class=""/><div class=""><h2 id="0156" class="pw-subtitle-paragraph jo iq ir bd b jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf dk translated"><em class="kg">在新标签页打开时，如何在Angular应用程序中共享JWT令牌。</em></h2></div><figure class="ki kj kk kl gu km gi gj paragraph-image"><div role="button" tabindex="0" class="kn ko di kp bf kq"><div class="gi gj kh"><img src="../Images/0045d62e69db477ecd001764b928e5a8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WTRgrzstyIbuZajOpgpLhg.jpeg"/></div></div></figure><p id="7631" class="pw-post-body-paragraph kt ku ir kv b kw kx js ky kz la jv lb lc ld le lf lg lh li lj lk ll lm ln lo ik bi translated">在会话存储(非本地存储)中存储JWT令牌(如访问令牌和刷新令牌)的Angular应用程序通常需要一种在新选项卡中共享它们的方法，以便用户不必再次登录即可访问应用程序。</p><p id="efb0" class="pw-post-body-paragraph kt ku ir kv b kw kx js ky kz la jv lb lc ld le lf lg lh li lj lk ll lm ln lo ik bi translated">但是由于其安全设计的本质，会话存储并不在单独的窗口中共享。那么，如何将令牌传输到新窗口呢？嗯，我们可以利用<code class="fe lp lq lr ls b">BroadcastChannel</code> web API来实现这一点。各大浏览器(IE除外💩)支持这个标准的web API。</p><p id="3eff" class="pw-post-body-paragraph kt ku ir kv b kw kx js ky kz la jv lb lc ld le lf lg lh li lj lk ll lm ln lo ik bi translated">根据MDN网络文档:</p><blockquote class="lt lu lv"><p id="0c10" class="kt ku lw kv b kw kx js ky kz la jv lb lx ld le lf ly lh li lj lz ll lm ln lo ik bi translated">广播通道API允许浏览上下文(即窗口、选项卡、框架或iframes)和相同来源的工作器之间的基本通信。</p></blockquote><p id="aca3" class="pw-post-body-paragraph kt ku ir kv b kw kx js ky kz la jv lb lc ld le lf lg lh li lj lk ll lm ln lo ik bi translated">如果您创建了一个同名的广播频道，无论web应用程序在不同的选项卡或窗口中运行，它们都将始终订阅同一个频道，从而允许双向通信。</p><pre class="ki kj kk kl gu ma ls mb mc aw md bi"><span id="6417" class="me mf ir ls b gz mg mh l mi mj">// Connection to a broadcast channel<br/>const bc = new BroadcastChannel('unreadcounts_channel');</span><span id="7d34" class="me mf ir ls b gz mk mh l mi mj">// sending a message to the channel<br/>bc.postMessage('6 unread messages');</span><span id="c547" class="me mf ir ls b gz mk mh l mi mj">// message handler<br/>bc.onmessage = event =&gt; { doSomething(event.data); }</span></pre><p id="adb7" class="pw-post-body-paragraph kt ku ir kv b kw kx js ky kz la jv lb lc ld le lf lg lh li lj lk ll lm ln lo ik bi translated">既然已经接触了基础知识，让我们看看如何利用它。</p><h1 id="d33b" class="ml mf ir bd mm mn mo mp mq mr ms mt mu jx mv jy mw ka mx kb my kd mz ke na nb bi translated">步骤1 —令牌存储服务</h1><p id="4dd0" class="pw-post-body-paragraph kt ku ir kv b kw nc js ky kz nd jv lb lc ne le lf lg nf li lj lk ng lm ln lo ik bi translated">首先，我们需要与会话存储进行交互。因此，创建一个简单的TokenStorageService。</p><figure class="ki kj kk kl gu km gi gj paragraph-image"><div role="button" tabindex="0" class="kn ko di kp bf kq"><div class="gi gj nh"><img src="../Images/aacd19fbe3e2e2597a288229750bbcc1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zHZmwfH-sefYf8icr7v6ug.jpeg"/></div></div><figcaption class="ni nj gk gi gj nk nl bd b be z dk">Token Storage Service</figcaption></figure><h1 id="cc3a" class="ml mf ir bd mm mn mo mp mq mr ms mt mu jx mv jy mw ka mx kb my kd mz ke na nb bi translated">步骤2-添加事件监听器</h1><p id="0d3d" class="pw-post-body-paragraph kt ku ir kv b kw nc js ky kz nd jv lb lc ne le lf lg nf li lj lk ng lm ln lo ik bi translated">当加载angular应用程序时，实例化根组件是最初始的引导过程之一。因此，这是一个编写代码的完美地方。</p><figure class="ki kj kk kl gu km gi gj paragraph-image"><div role="button" tabindex="0" class="kn ko di kp bf kq"><div class="gi gj nm"><img src="../Images/4a3f539b937fd874cbbd6347406750fe.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LgYwyUAxo9_wmyYJTRQZ6A.jpeg"/></div></div><figcaption class="ni nj gk gi gj nk nl bd b be z dk">App Component</figcaption></figure><h1 id="74e2" class="ml mf ir bd mm mn mo mp mq mr ms mt mu jx mv jy mw ka mx kb my kd mz ke na nb bi translated">发生什么事了？</h1><ul class=""><li id="9836" class="nn no ir kv b kw nc kz nd lc np lg nq lk nr lo ns nt nu nv bi translated"><code class="fe lp lq lr ls b">AppComponent</code>声明了一个名为<code class="fe lp lq lr ls b">TOKEN_SHARING_CHANNEL</code>的<code class="fe lp lq lr ls b">BroadcastChannel</code>的新实例。</li><li id="e1e8" class="nn no ir kv b kw nw kz nx lc ny lg nz lk oa lo ns nt nu nv bi translated">这里我们还添加了一个EventLister来订阅BroadcastChannel消息。这个处理程序只处理两种类型的消息——1。一个字符串值<code class="fe lp lq lr ls b">REQUESTING_TOKENS</code>和2。一个物体<code class="fe lp lq lr ls b">{ accessToken: string, refreshToken: string }.</code></li><li id="4ceb" class="nn no ir kv b kw nw kz nx lc ny lg nz lk oa lo ns nt nu nv bi translated">第一个选项卡包含令牌。假设我们通过Ctrl+click访问一个应用内链接，在一个新标签中打开angular应用。</li><li id="4650" class="nn no ir kv b kw nw kz nx lc ny lg nz lk oa lo ns nt nu nv bi translated">现在第二个选项卡打开了，它还没有令牌。应用程序在引导阶段到达根组件，并再次实例化名为<code class="fe lp lq lr ls b">TOKEN_SHARING_CHANNEL</code>的<code class="fe lp lq lr ls b">BroadcastChannel</code>。但是由于具有相同名称的信道将连接在一起，现在在第一和第二标签之间建立了通信媒介。</li><li id="bf2d" class="nn no ir kv b kw nw kz nx lc ny lg nz lk oa lo ns nt nu nv bi translated">第二个选项卡发布<code class="fe lp lq lr ls b">REQUESTING_TOKENS</code>消息。这被第一个选项卡截获。由于第一个选项卡有标记，现在它触发另一个带有标记的消息。</li><li id="a0f0" class="nn no ir kv b kw nw kz nx lc ny lg nz lk oa lo ns nt nu nv bi translated">第二个选项卡不再接收<code class="fe lp lq lr ls b">REQUESTING_TOKENS</code>消息，因此它进入else块并通过令牌存储服务将令牌存储在第二个选项卡的会话存储中。</li></ul><p id="2b42" class="pw-post-body-paragraph kt ku ir kv b kw kx js ky kz la jv lb lc ld le lf lg lh li lj lk ll lm ln lo ik bi translated"><em class="lw">(注意:这只是正在发生的事情的简化图。)</em></p><h2 id="3d92" class="me mf ir bd mm ob oc dn mq od oe dp mu lc of og mw lg oh oi my lk oj ok na ol bi translated">完整代码</h2><figure class="ki kj kk kl gu km"><div class="bz fq l di"><div class="om on l"/></div></figure><h1 id="18a8" class="ml mf ir bd mm mn mo mp mq mr ms mt mu jx mv jy mw ka mx kb my kd mz ke na nb bi translated">结论</h1><p id="1fd2" class="pw-post-body-paragraph kt ku ir kv b kw nc js ky kz nd jv lb lc ne le lf lg nf li lj lk ng lm ln lo ik bi translated">在MDN阅读有关BroadcastChannel API的更多信息:</p><div class="oo op gq gs oq or"><a href="https://developer.mozilla.org/en-US/docs/Web/API/Broadcast_Channel_API#browser_compatibility" rel="noopener  ugc nofollow" target="_blank"><div class="os ab fp"><div class="ot ab ou cl cj ov"><h2 class="bd is gz z fq ow fs ft ox fv fx iq bi translated">广播频道API-Web API | MDN</h2><div class="oy l"><h3 class="bd b gz z fq ow fs ft ox fv fx dk translated">广播通道API允许浏览上下文(即窗口、标签、框架或…)之间的基本通信</h3></div><div class="oz l"><p class="bd b dl z fq ow fs ft ox fv fx dk translated">developer.mozilla.org</p></div></div><div class="pa l"><div class="pb l pc pd pe pa pf kr or"/></div></div></a></div><p id="30f9" class="pw-post-body-paragraph kt ku ir kv b kw kx js ky kz la jv lb lc ld le lf lg lh li lj lk ll lm ln lo ik bi translated">感谢您的阅读！</p><p id="3427" class="pw-post-body-paragraph kt ku ir kv b kw kx js ky kz la jv lb lc ld le lf lg lh li lj lk ll lm ln lo ik bi translated"><em class="lw">更多内容看</em> <a class="ae pg" href="https://plainenglish.io/" rel="noopener ugc nofollow" target="_blank"> <strong class="kv is"> <em class="lw">说白了。报名参加我们的</em> <a class="ae pg" href="http://newsletter.plainenglish.io/" rel="noopener ugc nofollow" target="_blank"> <strong class="kv is"> <em class="lw">免费周报</em> </strong> </a> <em class="lw">。关注我们关于</em><a class="ae pg" href="https://twitter.com/inPlainEngHQ" rel="noopener ugc nofollow" target="_blank"><strong class="kv is"><em class="lw">Twitter</em></strong></a><em class="lw">和</em><a class="ae pg" href="https://www.linkedin.com/company/inplainenglish/" rel="noopener ugc nofollow" target="_blank"><strong class="kv is"><em class="lw">LinkedIn</em></strong></a><em class="lw">。加入我们的</em> <a class="ae pg" href="https://discord.gg/GtDtUAvyhW" rel="noopener ugc nofollow" target="_blank"> <strong class="kv is"> <em class="lw">社区</em> </strong> </a> <em class="lw">。</em></strong></a></p></div></div>    
</body>
</html>