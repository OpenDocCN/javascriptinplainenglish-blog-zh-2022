# ç”¨ Azure å‡½æ•°å’Œ Node.js åˆ›å»º REST API

> åŸæ–‡ï¼š<https://javascript.plainenglish.io/creating-a-rest-api-with-azure-functions-ee5ad3f61482?source=collection_archive---------0----------------------->

## ç¬¬ 2 éƒ¨åˆ†â€”è·å–ã€ä¸Šä¼ ã€åˆ é™¤

![](img/d09fcb0e724762d7443cd0aeef810a39.png)

Azure Functions with Node.js

åœ¨æœ¬ç³»åˆ—çš„ç¬¬ 1 éƒ¨åˆ†ä¸­ï¼Œæˆ‘ä»¬è®¾ç½®äº† API å¹¶å®ç°äº† POST è¯·æ±‚ã€‚åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬å°†ç ”ç©¶å¦‚ä½•å®ç°è·å–æ‰€æœ‰å¸–å­çš„ GET è¯·æ±‚å’Œå¦ä¸€ä¸ªæŒ‰ id è·å–å¸–å­çš„ GET è¯·æ±‚ã€‚æˆ‘ä»¬è¿˜å°†å®ç°ä¸€ä¸ªæ›´æ–°å¸–å­çš„ PUT è¯·æ±‚å’Œä¸€ä¸ªè®¾ç½®åˆ é™¤å¸–å­çš„ DELETE è¯·æ±‚ã€‚

# è·å–æ‰€æœ‰å¸–å­

è¦åˆ›å»ºè·å–æ‰€æœ‰å¸–å­çš„ GET æ–¹æ³•ï¼Œè¯·åœ¨ VS ä»£ç ä¸­å¯¼èˆªåˆ° Azure é€‰é¡¹å¡ã€‚ç”±äºæˆ‘ä»¬å·²ç»åœ¨ Azure Functions é¡¹ç›®ä¸­ï¼Œæˆ‘ä»¬åªéœ€ç‚¹å‡»é—ªç”µå›¾æ ‡ã€‚å•å‡»å®ƒä¹‹åï¼Œåœ¨å‘½ä»¤é¢æ¿ä¸­é€‰æ‹© HTTP triggerï¼Œå°†æ‚¨çš„å‡½æ•°å‘½åä¸º GetAllPostsï¼Œå¹¶å°† Authorization è®¾ç½®ä¸º Anonymousã€‚

![](img/99a670ceca95f27be2d9124f9eae9c14.png)

Create New Function

## å‡½æ•°. json

åœ¨ GetAllPosts å‡½æ•°æ–‡ä»¶å¤¹ä¸­ï¼Œå¯¼èˆªåˆ° function.json æ–‡ä»¶å¹¶åˆ é™¤æ–¹æ³•æ•°ç»„ä¸­çš„â€œpostâ€ã€‚è¿™å°†åªå…è®¸å¯¹å‡½æ•°çš„ GET è¯·æ±‚ã€‚

å¦‚æœæœ‰æˆåƒä¸Šä¸‡çš„å¸–å­ï¼ŒæŠ“å–è¡¨æ ¼ä¸­çš„æ¯ä¸€ä¸ªå¸–å­å°†ä¸ä¼šæ˜¯é«˜æ•ˆçš„ã€‚å› æ­¤ï¼Œæˆ‘ä»¬å°†æŒ‡å®šä¸€ä¸ªè·¯å¾„ï¼Œåœ¨é‚£é‡Œæˆ‘ä»¬å¯ä»¥ä¼ é€’å¸¦æœ‰åšå®¢åç§°çš„ URL å‚æ•°ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥è·å–ç‰¹å®šåˆ†åŒºé”®ä¸‹çš„æ‰€æœ‰å†…å®¹ã€‚

```
"route": "GetAllPosts/{blog}"
```

æ·»åŠ è¿™ä¸¤ä¸ªå±æ€§åï¼Œfunction.json åº”è¯¥å¦‚ä¸‹æ‰€ç¤º:

```
{
 "bindings": [
  {
   "authLevel": "anonymous",
   "type": "httpTrigger",
   "direction": "in",
   "name": "req",
   "methods": [
    "get"
   ],
   "route": "GetAllPosts/{blog}"
  },
  {
   "type": "http",
   "direction": "out",
   "name": "res"
  }
 ]
}
```

## è¡¨æ ¼å®¢æˆ·ç«¯

ç°åœ¨æˆ‘ä»¬å·²ç»è®¾ç½®äº†ç»‘å®šï¼Œè®©æˆ‘ä»¬ä½¿ç”¨ä¸€ä¸ªè¡¨å®¢æˆ·æœºæ–¹æ³•æ¥è·å–ç‰¹å®šåšå®¢çš„æ‰€æœ‰å¸–å­ã€‚è½¬åˆ° servicesï¼Œtable-service.js å¹¶åˆ›å»ºä¸€ä¸ªåä¸º *queryEntities çš„æ–°æ–¹æ³•ã€‚*æˆ‘ä»¬å°†å‘è¯¥æ–¹æ³•ä¼ é€’ä¸€ä¸ªè¡¨åå’ŒæŸ¥è¯¢ï¼Œä½¿å…¶é€šç”¨åŒ– *c.* å°±åƒæ’å…¥å®ä½“æ–¹æ³•ä¸€æ ·ï¼Œæˆ‘ä»¬å°†æŠŠä¸€åˆ‡éƒ½åŒ…è£…åœ¨æ‰¿è¯ºä¸­ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨ async/awaitã€‚

ç„¶åæˆ‘ä»¬å°†ä½¿ç”¨ SDK æ¥è°ƒç”¨ *queryEntities* æ–¹æ³•ã€‚æˆ‘ä»¬å°†å‘è¡¨æœåŠ¡æ–¹æ³•ä¼ é€’ tableNameã€queryã€null(è¿™æ˜¯å»¶ç»­æ ‡è®°æ‰€åœ¨çš„ä½ç½®)å’Œä»¥ä¸‹é€‰é¡¹ï¼Œä»¥æ›´æ˜“è¯»çš„æ ¼å¼è¿”å›æ•°æ®:

```
{ *payloadFormat*:"application/json;odata=nometadata"}
```

æœ€åï¼Œæ‚¨çš„æ–¹æ³•åº”è¯¥æ˜¯è¿™æ ·çš„:

## ç´¢å¼•. js

ç°åœ¨å›åˆ° GetAllPosts æ–‡ä»¶å¤¹ä¸­çš„ index.js æ–‡ä»¶ã€‚åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬å°†åœ¨æ–‡ä»¶é¡¶éƒ¨å¯¼å…¥ azure å’Œæˆ‘ä»¬çš„ queryEntities æ–¹æ³•:

```
const *azure* = *require*("azure-storage");
const{ *queryEntities* }= *require*("../services/table-service");
```

æ¥ä¸‹æ¥ï¼Œè®©æˆ‘ä»¬å°†æ•´ä¸ªæ–¹æ³•åŒ…è£…åœ¨ä¸€ä¸ª try-catch ä¸­ã€‚åœ¨ try å—ä¸­ï¼Œæˆ‘ä»¬å°†æŠ“å– blog å¹¶æ·»åŠ ä¸€ä¸ªæ£€æŸ¥ä»¥ç¡®ä¿å®ƒé€šè¿‡ã€‚ä¹‹åï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ Azure Table Storage SDK åˆ›å»ºä¸€ä¸ªæ–°çš„æŸ¥è¯¢ï¼Œç„¶åè°ƒç”¨ *queryEntities* æ–¹æ³•ã€‚å¦‚æœæˆ‘ä»¬å¾—åˆ°äº†è‰¯å¥½çš„å“åº”ï¼Œæˆ‘ä»¬å°†åœ¨ *context.res* çš„ body å±æ€§ä¸­è¿”å›å®ƒä»¬ã€‚åœ¨ catch å—ä¸­ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ *context.res* è¿”å›ä¸€ä¸ªçŠ¶æ€ 500 å’Œä¸€ä¸ªé”™è¯¯æ¶ˆæ¯ã€‚

GetAllPosts

# åŒºåˆ«è¯¦è§£

è¦ä¸ºä¸€ç¯‡åšå®¢æ–‡ç« åˆ›å»º GET æ–¹æ³•ï¼Œè¯·åœ¨ VS ä»£ç ä¸­ç‚¹å‡» Azure é€‰é¡¹å¡ï¼Œç„¶åç‚¹å‡» Functions ä¸‹çš„é—ªç”µå›¾æ ‡ã€‚ç„¶åé€‰æ‹© HTTP triggerï¼Œå°†æ‚¨çš„å‡½æ•°å‘½åä¸º GetPostï¼Œå¹¶é€‰æ‹© Anonymous ä½œä¸ºæˆæƒçº§åˆ«ã€‚

## å‡½æ•°. json

åœ¨ GetPost æ–‡ä»¶å¤¹ä¸­ï¼Œæ‰“å¼€ function.json å¹¶åˆ é™¤æ–¹æ³•æ•°ç»„ä¸­çš„â€œPostâ€ã€‚ç„¶åï¼Œåœ¨ bindings æ•°ç»„ä¸­çš„ç¬¬ä¸€ä¸ªå¯¹è±¡ä¸Šæ·»åŠ æ­¤è·¯ç”±:

```
"route": "GetPost/{blog}/{id}"
```

å®Œæˆæ‰€æœ‰è¿™äº›åï¼Œæ‚¨çš„æ–‡ä»¶åº”è¯¥å¦‚ä¸‹æ‰€ç¤º:

```
{
 "bindings": [
  {
   "authLevel": "anonymous",
   "type": "httpTrigger",
   "direction": "in",
   "name": "req",
   "methods": [
    "get"
   ],
   "route": "GetPost/{blog}/{id}"
  },
  {
   "type": "http",
   "direction": "out",
   "name": "res"
  }
 ]
}
```

## ç´¢å¼•. js

æ¥ä¸‹æ¥ï¼Œæ‰“å¼€ index.jsã€‚åœ¨æ–‡ä»¶ä¸­ï¼Œæˆ‘ä»¬å°†ä»è¡¨å®¢æˆ·ç«¯å¯¼å…¥ azure-storage å’Œ queryEntities æ–¹æ³•:

```
const *azure* = *require*("azure-storage");
const{ *queryEntities* }= *require*("../services/table-service");
```

ç„¶åï¼Œæˆ‘ä»¬å°†æŠŠæ‰€æœ‰å†…å®¹åŒ…è£…åœ¨ä¸€ä¸ª try-catch ä¸­ï¼Œå¹¶ä»ç»‘å®šæ•°æ®ä¸­è·å– blog å’Œ id:

```
module*.*exports = *async* function (context, req) { 
 *try* {
  const{ *blog*, *id* }= *context.bindingData*; } *catch* (error) {
  *context.*res = {
   status: 500,
   body: *error.*message,
  };
 }
};
```

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†æ£€æŸ¥ blog å’Œ id æ˜¯å¦è¢«ä¼ é€’:

```
if (!blog || !id) {
 *context.*res = {
  status: 400,
  body: "Blog and Post ID are required",
 }; *return*;
}
```

ç„¶åï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ Azure storage SDK åˆ›å»ºä¸€ä¸ªæŸ¥è¯¢ï¼Œå¹¶è°ƒç”¨æˆ‘ä»¬çš„ queryEntities æ–¹æ³•ã€‚æœ€åï¼Œæˆ‘ä»¬è¿”å›ç»“æœã€‚å°†æ‰€æœ‰è¿™äº›æ”¾åœ¨ä¸€èµ·ï¼Œæ‚¨çš„æ–‡ä»¶å°†å¦‚ä¸‹æ‰€ç¤º:

GetPost â€” index.js

# æ›´æ–°å¸–å­

è®©æˆ‘ä»¬åƒä¸Šä¸€ä¸ªæ–¹æ³•ä¸€æ ·åˆ›å»ºæˆ‘ä»¬çš„æ–¹æ³•ï¼Œæ–¹æ³•æ˜¯è½¬åˆ° Azure é€‰é¡¹å¡å¹¶å•å‡» Functions æ—è¾¹çš„é—ªç”µå›¾æ ‡ã€‚ç„¶åé€‰æ‹© HTTP triggerï¼Œå°†æ‚¨çš„å‡½æ•°å‘½åä¸º UpdatePostï¼Œå¹¶é€‰æ‹© Anonymous ä½œä¸ºæˆæƒçº§åˆ«ã€‚

## å‡½æ•°. json

åœ¨ function.json ä¸­ï¼Œåˆ é™¤æ–¹æ³•æ•°ç»„ä¸­çš„æ‰€æœ‰å†…å®¹ï¼Œå¹¶æ›¿æ¢ä¸ºâ€œputâ€ã€‚æ¥ä¸‹æ¥ï¼Œæ·»åŠ ä»¥ä¸‹è·¯çº¿:

```
"route": "UpdatePost/{blog}/{id}"
```

æ‚¨çš„æ–‡ä»¶åº”è¯¥å¦‚ä¸‹æ‰€ç¤º:

```
{
 "bindings": [
  {
   "authLevel": "anonymous",
   "type": "httpTrigger",
   "direction": "in",
   "name": "req",
   "methods": [
    "put"
   ],
   "route": "UpdatePost/{blog}/{id}"
  },
  {
   "type": "http",
   "direction": "out",
   "name": "res"
  }
 ]
}
```

## è¡¨æ ¼å®¢æˆ·ç«¯

ç°åœ¨å»é¤æ¡Œå®¢æˆ·ç«¯ã€‚åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬å°†æŠŠæ›´æ–°å†™å…¥è¡¨ä¸­ã€‚ä½†æ˜¯ï¼Œé¦–å…ˆï¼Œä½ åº”è¯¥çŸ¥é“ï¼Œæ ¹æ®æ–‡æ¡£ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨å‡ ç§ä¸åŒçš„æ–¹æ³•æ¥åšåˆ°è¿™ä¸€ç‚¹:

> æœ‰å¤šç§æ–¹æ³•å¯ç”¨äºæ›´æ–°ç°æœ‰å®ä½“:
> 
> `replaceEntity` -é€šè¿‡æ›¿æ¢ç°æœ‰å®ä½“æ¥æ›´æ–°å®ƒã€‚
> 
> `mergeEntity` -é€šè¿‡å°†æ–°çš„å±æ€§å€¼åˆå¹¶åˆ°ç°æœ‰å®ä½“ä¸­æ¥æ›´æ–°ç°æœ‰å®ä½“ã€‚
> 
> `insertOrReplaceEntity` -é€šè¿‡æ›¿æ¢ç°æœ‰å®ä½“æ¥æ›´æ–°å®ƒã€‚å¦‚æœå®ä½“ä¸å­˜åœ¨ï¼Œå°†æ’å…¥ä¸€ä¸ªæ–°å®ä½“ã€‚
> 
> `insertOrMergeEntity` -é€šè¿‡å°†æ–°çš„å±æ€§å€¼åˆå¹¶åˆ°ç°æœ‰å®ä½“ä¸­æ¥æ›´æ–°ç°æœ‰å®ä½“ã€‚å¦‚æœå®ä½“ä¸å­˜åœ¨ï¼Œå°†æ’å…¥ä¸€ä¸ªæ–°å®ä½“ã€‚

å‡ºäºæˆ‘ä»¬çš„ç›®çš„ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨`*mergeEntity*` æ–¹æ³•ã€‚

ä¸ºæ­¤ï¼Œæˆ‘ä»¬å°†åˆ›å»ºä¸€ä¸ªåä¸º updateEntity çš„æ–°æ–¹æ³•ï¼Œå°†æ‰€æœ‰å†…å®¹åŒ…è£…åœ¨ä¸€ä¸ªæ‰¿è¯ºä¸­ï¼Œä½¿ç”¨ SDK è°ƒç”¨ mergeEntityï¼Œå¹¶è§£ææˆ–æ‹’ç»è¯¥æ‰¿è¯º:

## ç´¢å¼•. js

åœ¨ index.js æ–‡ä»¶çš„é¡¶éƒ¨ï¼Œè®©æˆ‘ä»¬å¯¼å…¥åˆšåˆšåˆ›å»ºçš„æ–¹æ³•:

```
const{ *updateEntity* }= *require*("../services/table-service");
```

æ¥ä¸‹æ¥ï¼Œè®©æˆ‘ä»¬å°†æ‰€æœ‰å†…å®¹åŒ…è£…åœ¨ä¸€ä¸ª try-catch ä¸­ï¼Œåœ¨è¯·æ±‚ä½“ä¸Šæ·»åŠ ä¸€äº›éªŒè¯ï¼Œåˆ›å»ºæˆ‘ä»¬çš„å®ä½“å¹¶è°ƒç”¨ updateEntity æ–¹æ³•:

UpdatePost â€” index.js

# åˆ é™¤å¸–å­

ç°åœ¨ä½ åº”è¯¥æ˜¯ä¸“å®¶äº†ğŸ˜‰ã€‚å› æ­¤ï¼Œæˆ‘ä»¬å°†è½»æ¾åœ°å¤„ç†è¿™ä¸ªé—®é¢˜:Azure Tab = > Functions = > Lightning Blot = > HTTP Trigger = > Delete Post = > Anonymousã€‚

## å‡½æ•°. json

å°†æ–¹æ³•æ›¿æ¢ä¸ºâ€œåˆ é™¤â€å¹¶æ·»åŠ ä¸€æ¡è·¯çº¿:

```
{
 "bindings": [
 {
  "authLevel": "anonymous",
  "type": "httpTrigger",
  "direction": "in",
  "name": "req",
  "methods": [
   "delete"
  ],
  "route": "DeletePost/{blog}/{id}"
  },
  {
   "type": "http",
   "direction": "out",
   "name": "res"
  }
 ]
}
```

## è¡¨æ ¼å®¢æˆ·ç«¯

æ·»åŠ ä»¥ä¸‹æ–¹æ³•å¹¶å¯¼å‡ºåˆ°è¡¨å®¢æˆ·ç«¯:

deleteEntity

## ç´¢å¼•. js

å°†ä»¥ä¸‹ä»£ç æ·»åŠ åˆ° index.js ä¸­ä»¥åˆ é™¤å®ä½“:

DeletePost â€” index.js

# è§†é¢‘æ•™ç¨‹

Video Tutorial

# ç»“è®º

å¦‚ä½ æ‰€è§ï¼Œç”¨ Azure å‡½æ•°å’Œå­˜å‚¨è¡¨ç¼–å†™ REST API æå…¶å®¹æ˜“ã€‚å¦‚æœä½ è®¡åˆ’åœ¨ä½ çš„ä¸‹ä¸€ä¸ªé¡¹ç›®ä¸­ä½¿ç”¨å®ƒï¼Œè¯·åœ¨ä¸‹é¢çš„è¯„è®ºåŒºå‘Šè¯‰æˆ‘ä»¬ã€‚ä¸‹æ¬¡å†è§ï¼Œç¥ç¼–ç æ„‰å¿«ï¼

*æ›´å¤šå†…å®¹çœ‹* [*è¯´ç™½äº†ã€‚æŠ¥åå‚åŠ æˆ‘ä»¬çš„*](http://plainenglish.io/) [*å…è´¹æ¯å‘¨ç®€è®¯*](http://newsletter.plainenglish.io/) *ã€‚åœ¨æˆ‘ä»¬çš„* [*ç¤¾åŒº*](https://discord.gg/GtDtUAvyhW) *è·å¾—ç‹¬å®¶å†™ä½œæœºä¼šå’Œå»ºè®®ã€‚*